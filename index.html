<!DOCTYPE html>
<html lang="en">
<head>
    <!-- SUPABASE CLIENT -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPA_URL = 'https://upuwkzykkcclpzkytvdh.supabase.co';
        const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwdXdrenlra2NjbHB6a3l0dmRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNTA2ODIsImV4cCI6MjA4NzYyNjY4Mn0.8UE9QFgn3zgqQ1EvhFLqwS-eomXSD6GTYykUh2ZvN8Q';
        const supa     = supabase.createClient(SUPA_URL, SUPA_KEY);
        const KALYANTRA_PROJECT_ID = 'a1b2c3d4-e5f6-7890-abcd-ef1234567890';

        async function supabaseSave(data) {
            try {
                const p = data.project || {};
                const t = data.tcs    || {};
                const cal = data.calendar || {};
                const res = data.resources || {};
                const pid = KALYANTRA_PROJECT_ID;

                await supa.from('projects').upsert({
                    id: pid, name: p.name||'New Project', budget: p.budget||0,
                    start_date: p.startDate||null, end_date: p.endDate||null,
                    location: p.location||'', start_chainage: p.startChainage||0,
                    end_chainage: p.endChainage||5000, version:'6.6',
                    boq_data: JSON.stringify(data.boq || {sections:[],structureBOQ:[],generationConfig:{sequence:[],productivityRates:{},confirmed:false}})
                }, {onConflict:'id'});

                const existingTCS = await supa.from('tcs').select('id').eq('project_id',pid).maybeSingle();
                const tcsData = { project_id:pid, carriage_width:t.carriageWidth||7.0, shoulder_width:t.shoulderWidth||1.5, layers:t.layers||{} };
                if (existingTCS.data) await supa.from('tcs').update(tcsData).eq('project_id',pid);
                else await supa.from('tcs').insert(tcsData);

                if (data.structures) {
                    await supa.from('structures').delete().eq('project_id',pid);
                    if (data.structures.length>0) {
                        await supa.from('structures').insert(data.structures.map((s,i)=>({
                            project_id:pid, name:s.name||'Structure', type:s.type||'box_culvert',
                            chainage:s.chainage||0, size:s.size||'', concrete_qty:s.concreteQty||0,
                            excavation_qty:s.excavationQty||0, foundation_qty:s.foundationQty||0, sort_order:i+1
                        })));
                    }
                }

                if (data.hindrances) {
                    await supa.from('hindrances').delete().eq('project_id',pid);
                    if (data.hindrances.length>0) {
                        await supa.from('hindrances').insert(data.hindrances.map((h,i)=>({
                            project_id:pid, name:h.name||'Hindrance', type:h.type||'land',
                            category:h.category||h.type||'land', chainage_start:h.chainageStart||0,
                            chainage_end:h.chainageEnd||0, status:h.status||'Pending',
                            impact:h.impact||'', resolution_days:h.resolutionDays||0, sort_order:i+1
                        })));
                    }
                }

                const existingCal = await supa.from('calendar').select('id').eq('project_id',pid).maybeSingle();
                const calData = { project_id:pid, working_days:cal.workingDays||[1,2,3,4,5,6],
                    hours_per_day:cal.hoursPerDay||8, monsoon_start:cal.monsoonStart||null,
                    monsoon_end:cal.monsoonEnd||null, holidays:cal.holidays||[] };
                if (existingCal.data) await supa.from('calendar').update(calData).eq('project_id',pid);
                else await supa.from('calendar').insert(calData);

                const existingRes = await supa.from('resources').select('id').eq('project_id',pid).maybeSingle();
                const resData = { project_id:pid, equipment:res.equipment||[], manpower:res.manpower||[], materials:res.materials||[] };
                if (existingRes.data) await supa.from('resources').update(resData).eq('project_id',pid);
                else await supa.from('resources').insert(resData);

                if (data.milestones!==undefined) {
                    await supa.from('milestones').delete().eq('project_id',pid);
                    if (data.milestones.length>0) {
                        await supa.from('milestones').insert(data.milestones.map((m,i)=>({
                            project_id:pid, description:m.description||'', target_date:m.targetDate||null,
                            completion:m.completion||0, sort_order:i+1
                        })));
                    }
                }

                try { localStorage.setItem('kalyantra_v65_data', JSON.stringify(Object.assign({},data,{_version:'6.6'}))); } catch(e) {}
                console.log('‚úÖ Saved to Supabase');
                updateConnectionBadge(true);
                return true;
            } catch(err) {
                console.error('‚ùå Supabase save failed:', err);
                try { localStorage.setItem('kalyantra_v65_data', JSON.stringify(Object.assign({},data,{_version:'6.6'}))); } catch(e) {}
                updateConnectionBadge(false);
                return false;
            }
        }

        async function supabaseLoad() {
            try {
                const pid = KALYANTRA_PROJECT_ID;
                const [projRes,tcsRes,structRes,hindRes,calRes,resRes,milRes,apRes] = await Promise.all([
                    supa.from('projects').select('*').eq('id',pid).maybeSingle(),
                    supa.from('tcs').select('*').eq('project_id',pid).maybeSingle(),
                    supa.from('structures').select('*').eq('project_id',pid).order('sort_order'),
                    supa.from('hindrances').select('*').eq('project_id',pid).order('sort_order'),
                    supa.from('calendar').select('*').eq('project_id',pid).maybeSingle(),
                    supa.from('resources').select('*').eq('project_id',pid).maybeSingle(),
                    supa.from('milestones').select('*').eq('project_id',pid).order('sort_order'),
                    supa.from('activity_progress').select('*').eq('project_id',pid)
                ]);

                const result = {};
                if (projRes.data) {
                    const p = projRes.data;
                    result.project = { name:p.name, budget:parseFloat(p.budget)||0,
                        startDate:p.start_date, endDate:p.end_date, location:p.location,
                        startChainage:p.start_chainage, endChainage:p.end_chainage,
                        industryType:p.industry_type||'Road Construction', projectMode:p.project_mode||'EPC' };
                    if (p.boq_data) {
                        try { result.boq = typeof p.boq_data === 'string' ? JSON.parse(p.boq_data) : p.boq_data; }
                        catch(e) { result.boq = {sections:[],structureBOQ:[],generationConfig:{sequence:[],productivityRates:{},confirmed:false}}; }
                    }
                }
                if (tcsRes.data) {
                    const t = tcsRes.data;
                    result.tcs = { carriageWidth:parseFloat(t.carriage_width)||7.0,
                        shoulderWidth:parseFloat(t.shoulder_width)||1.5, layers:t.layers||{} };
                }
                if (structRes.data) {
                    result.structures = structRes.data.map(s=>({
                        id:s.sort_order, name:s.name, type:s.type, chainage:s.chainage,
                        size:s.size, concreteQty:parseFloat(s.concrete_qty)||0,
                        excavationQty:parseFloat(s.excavation_qty)||0, foundationQty:parseFloat(s.foundation_qty)||0
                    }));
                }
                if (hindRes.data) {
                    result.hindrances = hindRes.data.map(h=>({
                        id:h.sort_order, name:h.name, type:h.type, category:h.category,
                        chainageStart:h.chainage_start, chainageEnd:h.chainage_end,
                        status:h.status, impact:h.impact, resolutionDays:h.resolution_days||0
                    }));
                }
                if (calRes.data) {
                    const cal = calRes.data;
                    result.calendar = { workingDays:cal.working_days||[1,2,3,4,5,6],
                        hoursPerDay:cal.hours_per_day||8, monsoonStart:cal.monsoon_start,
                        monsoonEnd:cal.monsoon_end, holidays:cal.holidays||[] };
                }
                if (resRes.data) {
                    result.resources = { equipment:resRes.data.equipment||[],
                        manpower:resRes.data.manpower||[], materials:resRes.data.materials||[] };
                }
                if (milRes.data) {
                    result.milestones = milRes.data.map(m=>({
                        description:m.description, targetDate:m.target_date, completion:m.completion||0
                    }));
                }
                result.activityProgress = {};
                if (apRes.data) apRes.data.forEach(row=>{ result.activityProgress[row.progress_key]=row.actual_pct; });

                updateConnectionBadge(true);
                console.log('‚úÖ Loaded from Supabase');
                return result;
            } catch(err) {
                console.error('‚ùå Supabase load failed:', err);
                updateConnectionBadge(false);
                return null;
            }
        }

        async function supabaseSaveProgress(progressKey, pct) {
            try {
                await supa.from('activity_progress').upsert({
                    project_id:KALYANTRA_PROJECT_ID, progress_key:progressKey, actual_pct:pct
                }, {onConflict:'project_id,progress_key'});
            } catch(err) { console.warn('Progress save failed:', err); }
        }

        function updateConnectionBadge(connected) {
            const dot   = document.getElementById('supaStatusDot');
            const label = document.getElementById('supaStatusLabel');
            if (!dot || !label) return;
            if (connected) {
                dot.style.background   = '#16a34a';
                dot.style.boxShadow    = '0 0 6px #16a34a';
                label.textContent      = 'üü¢ DB Connected';
                label.style.color      = '#15803d';
            } else {
                dot.style.background   = '#dc2626';
                dot.style.boxShadow    = '0 0 6px #dc2626';
                label.textContent      = 'üî¥ Offline Mode';
                label.style.color      = '#dc2626';
            }
        }
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KALYANTRA V6.6 - All Audit Fixes Applied | Road Construction PM</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary-navy: #1B3B6F;
            --accent-gold: #D4AF37;
            --success: #10B981;
            --info: #3B82F6;
            --bg-white: #FFFFFF;
            --bg-surface: #F8FAFC;
            --bg-table-header: #F1F5F9;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --border-light: #E2E8F0;
            --border-medium: #CBD5E1;
        }
        
        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background: var(--bg-surface);
            color: var(--text-primary);
            font-size: 14px;
            overflow: hidden;
            height: 100vh;
        }
        
        .app-container {
            display: flex;
            flex-direction: row;
            height: 100vh;
            overflow: hidden;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 60px;
            min-width: 60px;
            background: var(--primary-navy);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: width 0.3s ease, min-width 0.3s ease;
            z-index: 100;
            border-right: 3px solid var(--accent-gold);
        }
        .sidebar.expanded {
            width: 220px;
            min-width: 220px;
        }
        .sidebar-header {
            display: flex;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255,255,255,0.12);
            min-height: 60px;
            flex-shrink: 0;
        }
        .sidebar-toggle {
            background: none;
            border: none;
            color: var(--accent-gold);
            font-size: 1.4rem;
            cursor: pointer;
            min-width: 60px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        .sidebar-toggle:hover {
            background: rgba(255,255,255,0.1);
        }
        .sidebar-brand {
            overflow: hidden;
            white-space: nowrap;
            opacity: 0;
            width: 0;
            transition: opacity 0.2s, width 0.2s;
        }
        .sidebar.expanded .sidebar-brand {
            opacity: 1;
            width: auto;
            padding-right: 12px;
        }
        .sidebar-brand-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-gold);
            letter-spacing: 1px;
        }
        .sidebar-brand-sub {
            font-size: 0.65rem;
            color: rgba(255,255,255,0.6);
            margin-top: 1px;
        }
        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 8px 0;
        }
        .sidebar-nav::-webkit-scrollbar { width: 4px; }
        .sidebar-nav::-webkit-scrollbar-track { background: transparent; }
        .sidebar-nav::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            color: rgba(255,255,255,0.75);
            cursor: pointer;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            border-left: 4px solid transparent;
            transition: all 0.2s;
            position: relative;
        }
        .sidebar-item:hover {
            background: rgba(255,255,255,0.08);
            color: white;
        }
        .sidebar-item.active {
            background: rgba(212,175,55,0.18);
            color: var(--accent-gold);
            border-left-color: var(--accent-gold);
        }
        .sidebar-icon {
            font-size: 1.25rem;
            min-width: 60px;
            text-align: center;
            flex-shrink: 0;
        }
        .sidebar-label {
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            width: 0;
            overflow: hidden;
            transition: opacity 0.2s;
        }
        .sidebar.expanded .sidebar-label {
            opacity: 1;
            width: auto;
        }
        /* Tooltip when collapsed */
        .sidebar:not(.expanded) .sidebar-item:hover::after {
            content: attr(data-label);
            position: absolute;
            left: 64px;
            background: #1B3B6F;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
            z-index: 200;
            border: 1px solid var(--accent-gold);
            box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        .sidebar-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 6px 10px;
        }
        .sidebar-section-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: rgba(255,255,255,0.35);
            padding: 8px 0 4px 0;
            text-align: center;
            white-space: nowrap;
            opacity: 0;
            width: 0;
            overflow: hidden;
            transition: opacity 0.2s;
        }
        .sidebar.expanded .sidebar-section-label {
            opacity: 1;
            width: auto;
            text-align: left;
            padding-left: 16px;
        }

        /* ===== MAIN CONTENT AREA ===== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
        }
        .main-header {
            background: var(--primary-navy);
            color: white;
            padding: 12px 24px;
            border-bottom: 4px solid var(--accent-gold);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .app-title {
            font-size: 1.4rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .app-subtitle {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 2px;
        }
        .header-meta {
            display: flex;
            gap: 16px;
            align-items: center;
            font-size: 0.8rem;
            opacity: 0.85;
        }
        .header-meta span { white-space: nowrap; }

        /* Hide old horizontal tab navigation */
        .tab-navigation {
            display: none !important;
        }
        
        .tab-content-area {
            flex: 1;
            overflow: hidden;
        }
        
        .tab-panel {
            display: none;
            height: 100%;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        /* Tab 1 - Form based */
        .content-container {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
            overflow-y: auto;
            height: 100%;
        }
        
        .section {
            background: white;
            border: 2px solid var(--border-light);
            border-left: 4px solid var(--primary-navy);
            border-radius: 4px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .section-header {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-navy);
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 3px solid var(--accent-gold);
            text-transform: uppercase;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .form-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
        }
        
        .form-input, .form-select {
            padding: 10px 12px;
            border: 2px solid var(--border-medium);
            border-radius: 4px;
            font-size: 0.9rem;
            font-family: 'IBM Plex Sans', sans-serif;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-navy);
            box-shadow: 0 0 0 3px rgba(27, 59, 111, 0.1);
        }
        
        .form-input:read-only {
            background: rgba(212, 175, 55, 0.1);
            border-color: var(--accent-gold);
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--primary-navy);
        }
        
        .chainage-group {
            display: flex;
            gap: 10px;
        }
        
        .milestone-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .milestone-table th {
            background: var(--bg-table-header);
            padding: 10px;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--primary-navy);
            border: 1px solid var(--border-medium);
        }
        
        .milestone-table td {
            padding: 8px;
            border: 1px solid var(--border-light);
        }
        
        .milestone-table input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--border-medium);
            border-radius: 3px;
            font-size: 0.85rem;
        }
        
        /* Tabular (Tab 2 & 3) */
        .tabular-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .toolbar {
            background: white;
            padding: 15px 30px;
            border-bottom: 2px solid var(--border-light);
            display: flex;
            justify-content: space-between;
        }
        
        .toolbar-left {
            display: flex;
            gap: 10px;
        }
        
        .content-split {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .table-panel {
            flex: 0 0 70%;
            background: white;
            border-right: 2px solid var(--border-medium);
            overflow: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table-header {
            background: var(--primary-navy);
            color: white;
            padding: 12px 20px;
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        .data-table thead {
            position: sticky;
            top: 0;
            background: var(--bg-table-header);
            z-index: 10;
        }
        
        .data-table th {
            padding: 12px;
            text-align: left;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--primary-navy);
            border-bottom: 2px solid var(--border-medium);
            border-right: 1px solid var(--border-light);
        }
        
        .data-table tbody tr {
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
        }
        
        .data-table tbody tr:hover {
            background: rgba(27, 59, 111, 0.03);
        }
        
        .data-table tbody tr.selected {
            background: rgba(212, 175, 55, 0.1);
            border-left: 4px solid var(--accent-gold);
        }
        
        .data-table td {
            padding: 10px 12px;
            border-right: 1px solid var(--border-light);
        }
        
        .split-view {
            display: flex;
            gap: 0;
            height: calc(100vh - 240px);
            overflow: hidden;
        }
        
        .list-panel {
            flex: 0 0 70%;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-right: 2px solid var(--border-light);
        }
        
        .detail-panel {
            flex: 0 0 30%;
            background: var(--bg-surface);
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 0;
            max-height: calc(100vh - 160px);
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .detail-header {
            background: var(--primary-navy);
            color: white;
            padding: 15px 20px;
            font-size: 1rem;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 40px;
        }
        
        .detail-tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid var(--border-light);
        }
        
        .detail-tab {
            padding: 10px 15px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            text-transform: uppercase;
        }
        
        .detail-tab:hover {
            color: var(--primary-navy);
        }
        
        .detail-tab.active {
            color: var(--primary-navy);
            border-bottom-color: var(--accent-gold);
        }
        
        .detail-tab-content {
            display: none;
        }
        
        .detail-tab-content.active {
            display: block;
        }
        
        .resource-subtab {
            display: none;
        }
        
        .resource-subtab.active {
            display: block;
        }
        
        /* TAB 7: ACTIVITY GRID STYLES - OPC INSPIRED */
        .activity-main-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 280px);
        }
        
        .view-mode-bar {
            display: flex;
            gap: 8px;
            padding: 12px 15px;
            background: #f9fafb;
            border-bottom: 1px solid var(--border-light);
        }
        
        .view-mode-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-medium);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .view-mode-btn:hover {
            background: rgba(59, 130, 246, 0.05);
            border-color: #3b82f6;
        }
        
        .view-mode-btn.active {
            background: var(--primary-navy);
            color: white;
            border-color: var(--primary-navy);
        }
        
        .activity-content-area {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .activity-table-section {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .activity-table-section.split-mode {
            flex: 0 0 60%;
            border-right: 1px solid var(--border-light);
        }
        
        .chart-section {
            flex: 0 0 40%;
            background: white;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chart-section.visible {
            display: flex;
        }
        
        .chart-section.full-width {
            flex: 1;
        }
        
        .activity-table-header {
            padding: 12px 15px;
            background: white;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .activity-table-container {
            flex: 1;
            overflow: auto;
        }
        
        .activity-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .activity-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f9fafb;
            border-bottom: 2px solid var(--border-medium);
        }
        
        .activity-table th {
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.8125rem;
            color: #374151;
            border-right: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        
        .activity-table tbody tr {
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.15s;
        }
        
        .activity-table tbody tr:hover {
            background: #f9fafb;
        }
        
        .activity-table tbody tr.selected {
            background: rgba(59, 130, 246, 0.06);
            box-shadow: inset 3px 0 0 #3b82f6;
        }
        
        .activity-table td {
            padding: 10px;
            border-right: 1px solid #f3f4f6;
            vertical-align: middle;
        }
        
        /* WBS Level Styling - OPC Clean Style */
        .activity-row-wbs {
            background: #fafafa;
            font-weight: 600;
        }
        
        .activity-row-stretch {
            background: #fcfcfc;
            font-weight: 500;
        }
        
        .activity-row-task {
            background: white;
        }
        
        /* Critical Path Highlighting - P6 Style */
        .activity-row-critical {
            background: #fff5f5 !important;
            border-left: 4px solid #ef4444;
        }
        
        .activity-row-critical td {
            font-weight: 600;
        }
        
        .activity-row-critical-parent {
            background: #fff7ed !important;
            border-left: 4px solid #f97316;
        }
        
        /* Workable Status Borders */
        .activity-row-workable {
            border-left: 3px solid #22c55e;
        }
        
        .activity-row-structure {
            border-left: 3px solid #3b82f6;
        }
        
        .activity-row-blocked {
            border-left: 3px solid #ef4444;
            background: #fef2f2 !important;
        }
        
        /* Activity Name with Tree Indent */
        .activity-name-cell {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .indent-0 { padding-left: 8px; }
        .indent-1 { padding-left: 32px; }
        .indent-2 { padding-left: 56px; }
        
        .tree-toggle {
            cursor: pointer;
            user-select: none;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #6b7280;
            border-radius: 3px;
        }
        
        .tree-toggle:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }
        
        /* Status with Inline Indicator */
        .status-cell {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8125rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-ready { background: #22c55e; }
        .status-progress { background: #f59e0b; }
        .status-blocked { background: #ef4444; }
        .status-complete { background: #6b7280; }
        
        /* Progress Bar in % Column */
        .progress-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .progress-bar-container {
            flex: 1;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
            transition: width 0.3s;
        }
        
        .progress-text {
            font-size: 0.75rem;
            color: #6b7280;
            min-width: 32px;
        }
        
        /* Badge Styles */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.6875rem;
            font-weight: 600;
            line-height: 1.2;
        }
        
        .badge-cp {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .badge-has-cp {
            background: #ffedd5;
            color: #ea580c;
        }
        
        .badge-auto {
            background: #dcfce7;
            color: #16a34a;
        }
        
        /* Chart Styles */
        .chart-header {
            padding: 12px 15px;
            background: #f9fafb;
            border-bottom: 1px solid var(--border-light);
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .chart-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }
        
        .gantt-timeline-header {
            display: flex;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .gantt-activity-label {
            flex: 0 0 200px;
            font-weight: 600;
            font-size: 0.8125rem;
            color: #374151;
        }
        
        .gantt-timeline {
            flex: 1;
            display: flex;
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 600;
        }
        
        .gantt-month {
            flex: 1;
            text-align: center;
            border-right: 1px solid #e5e7eb;
        }
        
        .gantt-row {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .gantt-bar-track {
            flex: 1;
            position: relative;
            height: 32px;
        }
        
        .gantt-bar {
            position: absolute;
            height: 28px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 0.75rem;
            color: white;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .gantt-bar-workable {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }
        
        .gantt-bar-structure {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .gantt-bar-blocked {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .gantt-bar-critical {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            border: 2px solid #7f1d1d;
        }
        
        .wbs-tree {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            padding: 15px;
        }
        
        .wbs-item {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none;
        }
        
        .wbs-item:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .wbs-item.selected {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid #3b82f6;
        }
        
        .wbs-level-0 {
            font-weight: 700;
            font-size: 1rem;
            background: rgba(30, 64, 175, 0.05);
            border-left: 4px solid var(--primary-navy);
            margin-top: 15px;
        }
        
        .wbs-level-1 {
            margin-left: 20px;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .wbs-level-2 {
            margin-left: 40px;
            font-size: 0.9rem;
        }
        
        .wbs-level-3 {
            margin-left: 60px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .wbs-expand-icon {
            display: inline-block;
            width: 16px;
            margin-right: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .wbs-icon {
            display: inline-block;
            margin-right: 8px;
            font-size: 1rem;
        }
        
        .wbs-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .badge-auto {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }
        
        .badge-manual {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }
        
        .badge-blocked {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        .wbs-info {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-left: 28px;
            padding: 4px 0;
        }
        
        .chart-view-toggle {
            display: flex;
            gap: 10px;
            padding: 12px 15px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-light);
        }
        
        .chart-view-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-medium);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .chart-view-btn:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .chart-view-btn.active {
            background: var(--primary-navy);
            color: white;
            border-color: var(--primary-navy);
        }
        
        .gantt-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background: #fafafa;
        }
        
        .linear-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background: #fafafa;
        }
        
        .gantt-row {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .gantt-label {
            flex: 0 0 200px;
            font-size: 0.85rem;
            padding-right: 15px;
        }
        
        .gantt-timeline {
            flex: 1;
            position: relative;
            height: 30px;
        }
        
        .gantt-bar {
            position: absolute;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 0.75rem;
            color: white;
            font-weight: 600;
        }
        
        .gantt-bar-workable {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }
        
        .gantt-bar-structure {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .gantt-bar-blocked {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .component-section {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .component-header {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary-navy);
            margin-bottom: 12px;
            text-transform: uppercase;
            border-left: 4px solid var(--accent-gold);
            padding-left: 10px;
        }
        
        .checkbox-grid {
            display: grid;
            gap: 8px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .checkbox-item label {
            font-size: 0.85rem;
            cursor: pointer;
        }
        
        .info-box {
            background: rgba(59, 130, 246, 0.05);
            border-left: 4px solid var(--info);
            padding: 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-bottom: 15px;
        }
        
        .radio-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .radio-item {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border-light);
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .radio-item:hover {
            border-color: var(--primary-navy);
        }
        
        .radio-item.selected {
            border-color: var(--accent-gold);
            background: rgba(212, 175, 55, 0.1);
        }
        
        .mini-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.8rem;
        }
        
        .mini-table th {
            background: var(--bg-table-header);
            padding: 8px;
            text-align: left;
            font-weight: 600;
            border: 1px solid var(--border-light);
        }
        
        .mini-table td {
            padding: 6px 8px;
            border: 1px solid var(--border-light);
        }
        
        .mini-table select, .mini-table input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid var(--border-medium);
            border-radius: 3px;
            font-size: 0.8rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-icon {
            font-size: 4rem;
            opacity: 0.3;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: 2px solid;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
            text-transform: uppercase;
            transition: all 0.2s;
            font-family: 'IBM Plex Sans', sans-serif;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background: var(--primary-navy);
            border-color: var(--primary-navy);
            color: white;
        }
        
        .btn-secondary {
            background: white;
            border-color: var(--border-medium);
            color: var(--text-primary);
        }
        
        .btn-success {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.75rem;
        }
        
        .btn-add {
            padding: 8px 16px;
            background: var(--accent-gold);
            border: 2px solid var(--accent-gold);
            color: var(--primary-navy);
            font-weight: 700;
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- LEFT SIDEBAR -->
        <div class="sidebar expanded" id="mainSidebar">
            <div class="sidebar-header">
                <button class="sidebar-toggle" id="sidebarToggle" title="Toggle Sidebar">‚ò∞</button>
                <div class="sidebar-brand">
                    <div class="sidebar-brand-title">KALYANTRA</div>
                    <div class="sidebar-brand-sub">V2.0 ‚Äî Infra PM</div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="sidebar-section-label">Data Entry</div>
                <button class="sidebar-item active" data-tab="0" data-label="Project Basics" onclick="sidebarSwitchTab(0, this)">
                    <span class="sidebar-icon">üìã</span>
                    <span class="sidebar-label">Project Basics</span>
                </button>
                <button class="sidebar-item" data-tab="1" data-label="TCS &amp; Sections" onclick="sidebarSwitchTab(1, this)">
                    <span class="sidebar-icon">üìê</span>
                    <span class="sidebar-label">TCS &amp; Sections</span>
                </button>
                <button class="sidebar-item" data-tab="2" data-label="Structures" onclick="sidebarSwitchTab(2, this)">
                    <span class="sidebar-icon">üåâ</span>
                    <span class="sidebar-label">Structures</span>
                </button>
                <button class="sidebar-item" data-tab="3" data-label="Hindrances" onclick="sidebarSwitchTab(3, this)">
                    <span class="sidebar-icon">‚ö†Ô∏è</span>
                    <span class="sidebar-label">Hindrances</span>
                </button>
                <button class="sidebar-item" data-tab="4" data-label="Calendar" onclick="sidebarSwitchTab(4, this)">
                    <span class="sidebar-icon">üìÖ</span>
                    <span class="sidebar-label">Calendar</span>
                </button>
                <button class="sidebar-item" data-tab="5" data-label="Resources" onclick="sidebarSwitchTab(5, this)">
                    <span class="sidebar-icon">üì¶</span>
                    <span class="sidebar-label">Resources</span>
                </button>
                <div class="sidebar-divider"></div>
                <div class="sidebar-section-label">Planning</div>
                <button class="sidebar-item" data-tab="6" data-label="Activity Grid" onclick="sidebarSwitchTab(6, this)">
                    <span class="sidebar-icon">üìä</span>
                    <span class="sidebar-label">Activity Grid</span>
                </button>
                <div class="sidebar-divider"></div>
                <div class="sidebar-section-label">Management</div>
                <button class="sidebar-item" data-tab="7" data-label="Executive Dashboard" onclick="sidebarSwitchTab(7, this)">
                    <span class="sidebar-icon">üéØ</span>
                    <span class="sidebar-label">Executive Dashboard</span>
                </button>
                <button class="sidebar-item" data-tab="8" data-label="Progress Tracking" onclick="sidebarSwitchTab(8, this)">
                    <span class="sidebar-icon">üìà</span>
                    <span class="sidebar-label">Progress Tracking</span>
                </button>
                <button class="sidebar-item" data-tab="9" data-label="Reports & Analytics" onclick="sidebarSwitchTab(9, this)">
                    <span class="sidebar-icon">üìë</span>
                    <span class="sidebar-label">Reports & Analytics</span>
                </button>
            </nav>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="main-header">
                <div>
                    <div class="app-title">KALYANTRA V2.0</div>
                    <div class="app-subtitle">Infrastructure Project Management System</div>
                </div>
                <div class="header-meta">
                    <span id="headerTabLabel" style="color:var(--accent-gold);font-weight:600;">üìã Project Basics</span>
                    <span style="opacity:0.5;">|</span>
                    <span id="headerProjectName">NH-44 Sample Project</span>
                </div>
                <!-- DB CONNECTION BADGE -->
                <div style="display:flex;align-items:center;gap:6px;margin-left:20px;
                    background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);
                    border-radius:20px;padding:4px 12px;cursor:default;">
                    <span id="supaStatusDot" style="width:8px;height:8px;border-radius:50%;
                        background:#f59e0b;display:inline-block;transition:all 0.4s;"></span>
                    <span id="supaStatusLabel" style="font-size:0.7rem;font-weight:700;
                        color:rgba(255,255,255,0.85);letter-spacing:0.03em;">‚è≥ Connecting...</span>
                </div>
            </div>

            <!-- Hidden horizontal tabs for JS backward-compat -->
            <div class="tab-navigation">
                <button class="main-tab active" onclick="switchMainTab(0)">Tab 1: Project Basics</button>
                <button class="main-tab" onclick="switchMainTab(1)">Tab 2: TCS</button>
                <button class="main-tab" onclick="switchMainTab(2)">Tab 3: Structures</button>
                <button class="main-tab" onclick="switchMainTab(3)">Tab 4: Hindrances</button>
                <button class="main-tab" onclick="switchMainTab(4)">Tab 5: Calendar</button>
                <button class="main-tab" onclick="switchMainTab(5)">Tab 6: Resources</button>
                <button class="main-tab" onclick="switchMainTab(6)">Tab 7: Activity Grid</button>
                <button class="main-tab" onclick="switchMainTab(7)">Tab 8: Executive Dashboard</button>
                <button class="main-tab" onclick="switchMainTab(8)">Tab 9: Progress Tracking</button>
                <button class="main-tab" onclick="switchMainTab(9)">Tab 10: Reports & Analytics</button>
            </div>
        
        <div class="tab-content-area">
            <!-- TAB 1: PROJECT BASICS -->
            <div class="tab-panel active" id="tab1">
                <div class="content-container">
                    <div class="section">
                        <div class="section-header">A. Project Information</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Project Name</label>
                                <input type="text" class="form-input" id="projectName" placeholder="e.g., NH-44 Widening Nagpur-Hyderabad" onchange="updateProjectData()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Industry Type</label>
                                <select class="form-select" id="industryType" onchange="updateProjectData()">
                                    <option value="">Select Industry</option>
                                    <option value="roads">Roads</option>
                                    <option value="metro">Metro</option>
                                    <option value="urban">Urban Infrastructure / Smart City</option>
                                    <option value="canal">Canal</option>
                                    <option value="railway">Railway</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Project Mode</label>
                                <select class="form-select" id="projectMode" onchange="updateProjectData()">
                                    <option value="">Select Mode</option>
                                    <option value="epc">EPC</option>
                                    <option value="bot">BOT</option>
                                    <option value="ham">HAM</option>
                                    <option value="itemrate">Item Rate Contract</option>
                                    <option value="annuity">Annuity</option>
                                    <option value="hybrid">Hybrid</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Total Project Cost (‚Çπ Crores)</label>
                                <input type="number" class="form-input" id="projectCost" placeholder="500.00" step="0.01" onchange="recalculateFinancialMilestones()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Start Chainage</label>
                                <div class="chainage-group">
                                    <input type="number" class="form-input" id="startKm" placeholder="Km" style="flex: 1;" onchange="calculateLength()">
                                    <input type="number" class="form-input" id="startM" placeholder="M" style="flex: 1;" max="999" onchange="calculateLength()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">End Chainage</label>
                                <div class="chainage-group">
                                    <input type="number" class="form-input" id="endKm" placeholder="Km" style="flex: 1;" onchange="calculateLength()">
                                    <input type="number" class="form-input" id="endM" placeholder="M" style="flex: 1;" max="999" onchange="calculateLength()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Total Length (km)</label>
                                <input type="text" class="form-input" id="totalLength" placeholder="Auto-calculated" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-header">B. Contractual Dates</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">LOA Date</label>
                                <input type="date" class="form-input" id="loaDate" onchange="updateProjectData()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Agreement Signing Date</label>
                                <input type="date" class="form-input" id="agreementDate" onchange="updateProjectData()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Appointed Date</label>
                                <input type="date" class="form-input" id="appointedDate" onchange="calculateCompletion()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Contract Duration (Months)</label>
                                <input type="number" class="form-input" id="duration" placeholder="18" onchange="calculateCompletion()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Scheduled Completion Date</label>
                                <input type="text" class="form-input" id="completionDate" placeholder="Auto-calculated" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-header">C. Milestones</div>
                        <div style="margin-bottom: 25px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <label class="form-label" style="margin: 0;">Physical Milestones</label>
                                <button class="btn btn-add btn-sm" onclick="addPhysicalMilestone()">+ Add Milestone</button>
                            </div>
                            <table class="milestone-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">#</th>
                                        <th>Target Date</th>
                                        <th>Completion %</th>
                                        <th>Duration (Months)</th>
                                        <th>Description</th>
                                        <th style="width: 80px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="physicalMilestones">
                                    <tr>
                                        <td>1</td>
                                        <td><input type="date" onchange="readMilestones()"></td>
                                        <td><input type="number" placeholder="25" min="0" max="100" onchange="readMilestones()"></td>
                                        <td><input type="number" placeholder="6" onchange="readMilestones()"></td>
                                        <td><input type="text" placeholder="First Milestone" onchange="readMilestones()"></td>
                                        <td><button class="btn btn-sm btn-secondary" onclick="deleteRow(this)">Delete</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <label class="form-label" style="margin: 0;">Financial Milestones</label>
                                <button class="btn btn-add btn-sm" onclick="addFinancialMilestone()">+ Add Milestone</button>
                            </div>
                            <table class="milestone-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">#</th>
                                        <th>Days from Start</th>
                                        <th>Progress %</th>
                                        <th>Schedule Date</th>
                                        <th>Amount (‚Çπ Cr)</th>
                                        <th>Cumulative %</th>
                                        <th>Remarks</th>
                                        <th style="width: 80px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="financialMilestones">
                                    <tr>
                                        <td>1</td>
                                        <td><input type="number" placeholder="180" onchange="recalculateFinancialMilestones()"></td>
                                        <td><input type="number" placeholder="25" step="0.01" onchange="recalculateFinancialMilestones()"></td>
                                        <td><input type="text" class="readonly-calc" placeholder="Auto-calculated" readonly style="background: rgba(212, 175, 55, 0.1); border-color: #D4AF37; font-weight: 600;"></td>
                                        <td><input type="text" class="readonly-calc" placeholder="Auto-calculated" readonly style="background: rgba(212, 175, 55, 0.1); border-color: #D4AF37; font-weight: 600;"></td>
                                        <td><input type="text" class="readonly-calc" placeholder="Auto-calculated" readonly style="background: rgba(212, 175, 55, 0.1); border-color: #D4AF37; font-weight: 600;"></td>
                                        <td><input type="text" placeholder="First payment"></td>
                                        <td><button class="btn btn-sm btn-secondary" onclick="deleteRow(this)">Delete</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 10px;">
                        <button class="btn btn-secondary" onclick="updateProjectData(); showToast('‚úÖ Project draft saved', 'success')">Save as Draft</button>
                        <button class="btn btn-primary" onclick="validateAndProceed()">Next: Define TCS ‚Üí</button>
                    </div>

                    <!-- Sticky Nav Footer -->
                    <div style="position:sticky;bottom:0;background:#1B3B6F;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;border-top:3px solid #D4AF37;z-index:20;margin-top:auto;">
                        <span style="width:100px;"></span>
                        <span style="font-size:0.8rem;color:rgba(255,255,255,0.6);font-weight:500;">Step 1 of 6 ¬∑ Project Basics</span>
                        <button onclick="validateAndProceed()" style="padding:8px 20px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:6px;font-weight:700;font-size:0.85rem;cursor:pointer;">Next: TCS Profile ‚Üí</button>
                    </div>
                </div>
            </div>
            
            <!-- TAB 2: TCS (TABULAR 70/30) -->
            <div class="tab-panel" id="tab2">
                <div class="content-container" style="padding-bottom:80px;">

                    <!-- ‚ïê‚ïê PART A: MASTER TCS PROFILE ‚ïê‚ïê -->
                    <div class="section" id="tcsPartA">
                        <div class="section-header" style="display:flex;align-items:center;justify-content:space-between;">
                            <span>A. Master TCS Profile</span>
                            <span style="font-size:0.72rem;font-weight:400;color:var(--text-secondary);">Default cross-section ‚Äî can be overridden per section</span>
                        </div>

                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
                            <div>
                                <label class="form-label">Carriage Width (m)</label>
                                <input type="number" class="form-input" id="tcsCarriageWidth" value="7.0" step="0.5"
                                    onchange="updateMasterTCS()" oninput="updateMasterTCS()">
                            </div>
                            <div>
                                <label class="form-label">Shoulder Width (m)</label>
                                <input type="number" class="form-input" id="tcsShoulderWidth" value="1.5" step="0.25"
                                    onchange="updateMasterTCS()" oninput="updateMasterTCS()">
                            </div>
                        </div>

                        <div style="font-size:0.8rem;font-weight:700;color:var(--navy);margin-bottom:10px;">Pavement Layers</div>
                        <div style="overflow-x:auto;">
                        <table style="width:100%;border-collapse:collapse;font-size:0.82rem;">
                            <thead>
                                <tr style="background:var(--navy);color:#fff;">
                                    <th style="padding:8px 10px;text-align:left;">Layer</th>
                                    <th style="padding:8px 10px;text-align:left;">Material</th>
                                    <th style="padding:8px 10px;text-align:center;">Thickness (mm)</th>
                                    <th style="padding:8px 10px;text-align:center;">Include</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom:1px solid var(--border-light);">
                                    <td style="padding:7px 10px;font-weight:700;color:#92400e;">GSB</td>
                                    <td style="padding:7px 10px;color:var(--text-secondary);">Granular Sub Base</td>
                                    <td style="padding:7px 10px;text-align:center;">
                                        <input type="number" id="tcsGSB" value="250" min="0" max="600" step="25"
                                            style="width:80px;padding:4px 8px;border:1px solid var(--border-light);border-radius:4px;text-align:center;font-size:0.82rem;"
                                            onchange="updateMasterTCS()">
                                    </td>
                                    <td style="padding:7px 10px;text-align:center;"><input type="checkbox" id="tcsGSBon" checked onchange="updateMasterTCS()"></td>
                                </tr>
                                <tr style="border-bottom:1px solid var(--border-light);">
                                    <td style="padding:7px 10px;font-weight:700;color:#1d4ed8;">WMM</td>
                                    <td style="padding:7px 10px;color:var(--text-secondary);">Wet Mix Macadam</td>
                                    <td style="padding:7px 10px;text-align:center;">
                                        <input type="number" id="tcsWMM" value="250" min="0" max="400" step="25"
                                            style="width:80px;padding:4px 8px;border:1px solid var(--border-light);border-radius:4px;text-align:center;font-size:0.82rem;"
                                            onchange="updateMasterTCS()">
                                    </td>
                                    <td style="padding:7px 10px;text-align:center;"><input type="checkbox" id="tcsWMMon" checked onchange="updateMasterTCS()"></td>
                                </tr>
                                <tr style="border-bottom:1px solid var(--border-light);">
                                    <td style="padding:7px 10px;font-weight:700;color:#1e40af;">DBM</td>
                                    <td style="padding:7px 10px;color:var(--text-secondary);">Dense Bituminous Macadam</td>
                                    <td style="padding:7px 10px;text-align:center;">
                                        <input type="number" id="tcsDBM" value="50" min="0" max="200" step="10"
                                            style="width:80px;padding:4px 8px;border:1px solid var(--border-light);border-radius:4px;text-align:center;font-size:0.82rem;"
                                            onchange="updateMasterTCS()">
                                    </td>
                                    <td style="padding:7px 10px;text-align:center;"><input type="checkbox" id="tcsDBMon" checked onchange="updateMasterTCS()"></td>
                                </tr>
                                <tr>
                                    <td style="padding:7px 10px;font-weight:700;color:#0f172a;">BC</td>
                                    <td style="padding:7px 10px;color:var(--text-secondary);">Bituminous Concrete</td>
                                    <td style="padding:7px 10px;text-align:center;">
                                        <input type="number" id="tcsBC" value="40" min="0" max="100" step="10"
                                            style="width:80px;padding:4px 8px;border:1px solid var(--border-light);border-radius:4px;text-align:center;font-size:0.82rem;"
                                            onchange="updateMasterTCS()">
                                    </td>
                                    <td style="padding:7px 10px;text-align:center;"><input type="checkbox" id="tcsOnBC" checked onchange="updateMasterTCS()"></td>
                                </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>

                    <!-- ‚ïê‚ïê PART B: CHAINAGE SECTIONS ‚ïê‚ïê -->
                    <div class="section" style="margin-top:16px;">
                        <div class="section-header" style="display:flex;align-items:center;justify-content:space-between;">
                            <span>B. Chainage Sections & BOQ</span>
                            <div style="display:flex;gap:8px;">
                                <button onclick="tcsAddSection()"
                                    style="background:var(--accent-gold);color:#1B3B6F;border:none;padding:6px 14px;border-radius:5px;font-weight:700;font-size:0.78rem;cursor:pointer;">
                                    + Add Section
                                </button>
                                <button onclick="boqGenerateWBS()"
                                    style="background:linear-gradient(135deg,#16a34a,#15803d);color:#fff;border:none;padding:6px 14px;border-radius:5px;font-weight:700;font-size:0.78rem;cursor:pointer;">
                                    ‚ö° Generate WBS & Schedule
                                </button>
                            </div>
                        </div>
                        <div style="font-size:0.76rem;color:var(--text-secondary);margin-bottom:12px;">
                            Each section has its own TCS override + BOQ items + Linear items.
                            After entering all sections, click Generate to auto-build WBS & Schedule.
                        </div>

                        <!-- BOQ SUMMARY BAR -->
                        <div id="boqSummaryBar" style="display:none;margin-bottom:12px;display:flex;gap:16px;flex-wrap:wrap;background:var(--bg-surface);border:1px solid var(--border-light);border-radius:8px;padding:10px 16px;">
                            <div style="text-align:center;">
                                <div style="font-size:1rem;font-weight:700;color:var(--navy);" id="boqTotalValue">‚Çπ0.00 Cr</div>
                                <div style="font-size:0.68rem;color:var(--text-secondary);">Total BOQ</div>
                            </div>
                            <div style="width:1px;background:var(--border-light);"></div>
                            <div style="text-align:center;">
                                <div style="font-size:1rem;font-weight:700;color:#16a34a;" id="boqEarnedValue">‚Çπ0.00 Cr</div>
                                <div style="font-size:0.68rem;color:var(--text-secondary);">Earned</div>
                            </div>
                            <div style="width:1px;background:var(--border-light);"></div>
                            <div style="text-align:center;">
                                <div style="font-size:1rem;font-weight:700;color:var(--accent-gold);" id="boqFinancialPct">0.0%</div>
                                <div style="font-size:0.68rem;color:var(--text-secondary);">Financial %</div>
                            </div>
                            <div style="width:1px;background:var(--border-light);"></div>
                            <div style="text-align:center;">
                                <div style="font-size:1rem;font-weight:700;color:#dc2626;" id="boqBlockedValue">‚Çπ0.00 L</div>
                                <div style="font-size:0.68rem;color:var(--text-secondary);">Blocked</div>
                            </div>
                            <div style="width:1px;background:var(--border-light);"></div>
                            <div style="text-align:center;">
                                <div style="font-size:1rem;font-weight:700;color:#7c3aed;" id="boqDeviationCount">0</div>
                                <div style="font-size:0.68rem;color:var(--text-secondary);">Deviations</div>
                            </div>
                        </div>

                        <!-- SECTIONS LIST (BOQ integrated) -->
                        <div id="boqSectionsList"></div>

                        <!-- EMPTY STATE -->
                        <div id="boqEmptyState" style="text-align:center;padding:40px 20px;color:var(--text-secondary);">
                            <div style="font-size:2.5rem;margin-bottom:10px;">üìê</div>
                            <div style="font-size:0.9rem;font-weight:600;color:var(--navy);margin-bottom:6px;">No sections defined yet</div>
                            <div style="font-size:0.78rem;margin-bottom:16px;">
                                Add chainage sections with their own TCS and BOQ items.<br>
                                Each section drives activities, quantities and financial progress.
                            </div>
                            <button onclick="tcsAddSection()"
                                style="background:var(--accent-gold);color:#1B3B6F;font-weight:700;border:none;padding:8px 20px;border-radius:5px;cursor:pointer;font-size:0.85rem;">
                                + Add First Section
                            </button>
                        </div>
                    </div>

                    <!-- ‚ïê‚ïê PART C: STRUCTURE BOQ ‚ïê‚ïê -->
                    <div class="section" style="margin-top:16px;">
                        <div class="section-header" style="display:flex;align-items:center;justify-content:space-between;">
                            <span>C. Structure BOQ</span>
                            <button onclick="boqAddStructureBOQ()"
                                style="background:#7c3aed;color:#fff;border:none;padding:6px 14px;border-radius:5px;font-weight:700;font-size:0.78rem;cursor:pointer;">
                                üåâ Add Structure BOQ
                            </button>
                        </div>
                        <div style="font-size:0.76rem;color:var(--text-secondary);margin-bottom:10px;">
                            Enter BOQ items per structure manually. Quantities from structural drawings.
                        </div>
                        <div id="boqStructuresList">
                            <div id="boqStructEmptyState" style="color:var(--text-secondary);font-size:0.8rem;padding:8px 0;">
                                No structure BOQ added yet. Add structures in the Structures tab first.
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Sticky Nav Footer -->
                <div style="position:sticky;bottom:0;background:#1B3B6F;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;border-top:3px solid #D4AF37;z-index:20;">
                    <button onclick="switchMainTab(0)" style="padding:8px 20px;background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:6px;font-weight:600;font-size:0.85rem;cursor:pointer;">‚Üê Previous</button>
                    <span style="font-size:0.8rem;color:rgba(255,255,255,0.6);font-weight:500;">Step 2 of 6 ¬∑ TCS & Sections</span>
                    <button onclick="switchMainTab(2)" style="padding:8px 20px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:6px;font-weight:700;font-size:0.85rem;cursor:pointer;">Next: Structures ‚Üí</button>
                </div>
            </div>
            
                        
            <!-- TAB 2: TCS (TABULAR 70/30) -->
            <div class="tab-panel" id="tab2">
                <div class="tabular-container">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <button class="btn btn-success btn-sm" onclick="addTCS()">+ Add TCS</button>
                            <button class="btn btn-secondary btn-sm">Delete</button>
                        </div>
                        <button class="btn btn-primary btn-sm">Save All</button>
                    </div>
                    
                    <div class="content-split">
                        <div class="table-panel">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox"></th>
                                        <th>From Ch</th>
                                        <th>To Ch</th>
                                        <th>Type</th>
                                        <th>Lanes</th>
                                        <th>Median</th>
                                        <th>Proposal</th>
                                    </tr>
                                </thead>
                                <tbody id="tcsTable">
                                    <tr onclick="selectTCS(this, 0)">
                                        <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                        <td><strong>0+000</strong></td>
                                        <td><strong>5+000</strong></td>
                                        <td>Main Carriageway</td>
                                        <td>4-Lane</td>
                                        <td>Raised</td>
                                        <td>New</td>
                                    </tr>
                                    <tr onclick="selectTCS(this, 1)">
                                        <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                        <td><strong>5+000</strong></td>
                                        <td><strong>10+000</strong></td>
                                        <td>Main Carriageway</td>
                                        <td>4-Lane</td>
                                        <td>Raised</td>
                                        <td>New</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="detail-panel">
                            <div class="detail-header">TCS Details</div>
                            <div class="detail-tabs">
                                <button class="detail-tab active" onclick="switchTCSTab(0)">Components</button>
                                <button class="detail-tab" onclick="switchTCSTab(1)">Drawing Status</button>
                            </div>
                            <div class="detail-content" id="tcsDetailContent">
                                <div class="empty-state">
                                    <div class="empty-icon">üõ£Ô∏è</div>
                                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 10px;">No TCS Section Selected</div>
                                    <div style="font-size: 0.9rem;">Click any row to view details</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sticky Nav Footer -->
                    <div style="position:sticky;bottom:0;background:#1B3B6F;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;border-top:3px solid #D4AF37;z-index:20;margin-top:auto;">
                        <button onclick="switchMainTab(0)" style="padding:8px 20px;background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:6px;font-weight:600;font-size:0.85rem;cursor:pointer;">‚Üê Previous</button>
                        <span style="font-size:0.8rem;color:rgba(255,255,255,0.6);font-weight:500;">Step 2 of 6 ¬∑ TCS Profile</span>
                        <button onclick="switchMainTab(2)" style="padding:8px 20px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:6px;font-weight:700;font-size:0.85rem;cursor:pointer;">Next: Structures ‚Üí</button>
                    </div>
                </div>
            </div>
            
            <!-- TAB 3: STRUCTURES (TABULAR WITH 4 DETAIL TABS) -->
            <div class="tab-panel" id="tab3">
                <div class="tabular-container">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <button class="btn btn-success btn-sm" onclick="addStructure()">+ Add Structure</button>
                            <button class="btn btn-secondary btn-sm">Delete</button>
                        </div>
                        <button class="btn btn-primary btn-sm">Save All</button>
                    </div>
                    
                    <div class="content-split">
                        <div class="table-panel">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox"></th>
                                        <th>Chainage</th>
                                        <th>Type</th>
                                        <th>Proposal</th>
                                        <th>Spans</th>
                                        <th>Foundation</th>
                                        <th>Superstructure</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="structuresTable">
                                    <tr onclick="selectStructure(this, 0)">
                                        <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                        <td><strong>Ch 5+000</strong></td>
                                        <td>MNB</td>
                                        <td>New</td>
                                        <td>3</td>
                                        <td>Pile</td>
                                        <td>PSC Girder</td>
                                        <td>‚úÖ Approved</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="detail-panel">
                            <div class="detail-header">Structure Details</div>
                            <div class="detail-tabs">
                                <button class="detail-tab active" onclick="switchDetailTab(0)">Basic</button>
                                <button class="detail-tab" onclick="switchDetailTab(1)">Drawing</button>
                                <button class="detail-tab" onclick="switchDetailTab(2)">Spans</button>
                                <button class="detail-tab" onclick="switchDetailTab(3)">Conditions</button>
                            </div>
                            <div class="detail-content" id="structureDetailContent">
                                <div class="empty-state">
                                    <div class="empty-icon">üèóÔ∏è</div>
                                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 10px;">No Structure Selected</div>
                                    <div style="font-size: 0.9rem;">Click any row to view details</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sticky Nav Footer -->
                    <div style="position:sticky;bottom:0;background:#1B3B6F;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;border-top:3px solid #D4AF37;z-index:20;margin-top:auto;">
                        <button onclick="switchMainTab(1)" style="padding:8px 20px;background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:6px;font-weight:600;font-size:0.85rem;cursor:pointer;">‚Üê Previous</button>
                        <span style="font-size:0.8rem;color:rgba(255,255,255,0.6);font-weight:500;">Step 3 of 6 ¬∑ Structures</span>
                        <button onclick="switchMainTab(3)" style="padding:8px 20px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:6px;font-weight:700;font-size:0.85rem;cursor:pointer;">Next: Hindrances ‚Üí</button>
                    </div>
                </div>
            </div>
            
            <!-- TAB 4: CONTRACTUAL HINDRANCES (TABULAR 70/30) -->
            <div class="tab-panel" id="tab4">
                <div class="tabular-container">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <button class="btn btn-success btn-sm" onclick="addHindrance()">+ Add Hindrance</button>
                            <button class="btn btn-primary btn-sm" onclick="uploadJM()">üìé Upload Joint Memorandum</button>
                        </div>
                        <div class="toolbar-right">
                            <select class="filter-select">
                                <option>All Hindrances</option>
                                <option>Active Only</option>
                                <option>Resolved</option>
                                <option>Critical Only</option>
                            </select>
                            <button class="btn btn-secondary btn-sm">Export Report</button>
                        </div>
                    </div>
                    
                    <div class="split-view">
                        <div class="list-panel">
                            <div class="table-header">Contractual Hindrances</div>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th width="5%"><input type="checkbox"></th>
                                        <th width="5%">#</th>
                                        <th width="15%">Category</th>
                                        <th width="15%">Location</th>
                                        <th width="10%">Land Status</th>
                                        <th width="10%">Status</th>
                                        <th width="10%">Days Open</th>
                                        <th width="15%">Expected Resolution</th>
                                        <th width="15%">Responsibility</th>
                                    </tr>
                                </thead>
                                <tbody id="hindrancesTable">
                                    <tr onclick="selectHindrance(this, 0)">
                                        <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                        <td><strong>1</strong></td>
                                        <td>Land Handover</td>
                                        <td>Ch 10+500 to 12+800</td>
                                        <td><span style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">Non-Clear</span></td>
                                        <td><span style="background: rgba(251, 191, 36, 0.1); color: #f59e0b; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">Active</span></td>
                                        <td>27 days</td>
                                        <td>30/06/2025</td>
                                        <td>Owner</td>
                                    </tr>
                                    <tr onclick="selectHindrance(this, 1)">
                                        <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                        <td><strong>2</strong></td>
                                        <td>Utility Shifting</td>
                                        <td>Ch 15+250</td>
                                        <td><span style="background: rgba(34, 197, 94, 0.1); color: #22c55e; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">Clear</span></td>
                                        <td><span style="background: rgba(251, 191, 36, 0.1); color: #f59e0b; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">Active</span></td>
                                        <td>22 days</td>
                                        <td>30/03/2025</td>
                                        <td>Electricity Board</td>
                                    </tr>
                                    <tr onclick="selectHindrance(this, 2)">
                                        <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                        <td><strong>3</strong></td>
                                        <td>ROB Drawing Approval</td>
                                        <td>Ch 25+500 (ROB)</td>
                                        <td>-</td>
                                        <td><span style="background: rgba(251, 191, 36, 0.1); color: #f59e0b; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">Active</span></td>
                                        <td>53 days</td>
                                        <td>30/06/2025</td>
                                        <td>Railway Board</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="detail-panel">
                            <div class="detail-header">Hindrance Details</div>
                            <div class="detail-content" id="hindranceDetailContent">
                                <div class="empty-state">
                                    <div class="empty-icon">‚ö†Ô∏è</div>
                                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 10px;">No Hindrance Selected</div>
                                    <div style="font-size: 0.9rem;">Click any row to view details</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sticky Nav Footer -->
                    <div style="position:sticky;bottom:0;background:#1B3B6F;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;border-top:3px solid #D4AF37;z-index:20;margin-top:auto;">
                        <button onclick="switchMainTab(2)" style="padding:8px 20px;background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:6px;font-weight:600;font-size:0.85rem;cursor:pointer;">‚Üê Previous</button>
                        <span style="font-size:0.8rem;color:rgba(255,255,255,0.6);font-weight:500;">Step 4 of 6 ¬∑ Hindrances</span>
                        <button onclick="switchMainTab(4)" style="padding:8px 20px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:6px;font-weight:700;font-size:0.85rem;cursor:pointer;">Next: Calendar ‚Üí</button>
                    </div>
                </div>
            </div>
            
            <!-- TAB 5: CALENDAR (WORKING DAYS & HOLIDAYS) -->
            <div class="tab-panel" id="tab5">
                <div class="form-container">
                    <h2 style="color: var(--primary-navy); margin-bottom: 20px;">üìÖ Project Calendar</h2>
                    
                    <div class="form-section">
                        <div class="form-section-header">1. WORKING DAYS</div>
                        <div class="form-group">
                            <label class="form-label">Working Days per Week</label>
                            <!-- GAP-04 FIX: Interactive day checkboxes (0=Sun,1=Mon,...,6=Sat) -->
                            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;">
                                <label style="display:flex;align-items:center;gap:4px;font-size:0.82rem;cursor:pointer;padding:4px 8px;border:1px solid #e2e8f0;border-radius:4px;background:#f8fafc;">
                                    <input type="checkbox" id="wdSun" value="0" onchange="saveWorkingDays()" style="accent-color:#1B3B6F;"> Sun</label>
                                <label style="display:flex;align-items:center;gap:4px;font-size:0.82rem;cursor:pointer;padding:4px 8px;border:1px solid #D4AF37;border-radius:4px;background:#fffbeb;">
                                    <input type="checkbox" id="wdMon" value="1" checked onchange="saveWorkingDays()" style="accent-color:#1B3B6F;"> Mon</label>
                                <label style="display:flex;align-items:center;gap:4px;font-size:0.82rem;cursor:pointer;padding:4px 8px;border:1px solid #D4AF37;border-radius:4px;background:#fffbeb;">
                                    <input type="checkbox" id="wdTue" value="2" checked onchange="saveWorkingDays()" style="accent-color:#1B3B6F;"> Tue</label>
                                <label style="display:flex;align-items:center;gap:4px;font-size:0.82rem;cursor:pointer;padding:4px 8px;border:1px solid #D4AF37;border-radius:4px;background:#fffbeb;">
                                    <input type="checkbox" id="wdWed" value="3" checked onchange="saveWorkingDays()" style="accent-color:#1B3B6F;"> Wed</label>
                                <label style="display:flex;align-items:center;gap:4px;font-size:0.82rem;cursor:pointer;padding:4px 8px;border:1px solid #D4AF37;border-radius:4px;background:#fffbeb;">
                                    <input type="checkbox" id="wdThu" value="4" checked onchange="saveWorkingDays()" style="accent-color:#1B3B6F;"> Thu</label>
                                <label style="display:flex;align-items:center;gap:4px;font-size:0.82rem;cursor:pointer;padding:4px 8px;border:1px solid #D4AF37;border-radius:4px;background:#fffbeb;">
                                    <input type="checkbox" id="wdFri" value="5" checked onchange="saveWorkingDays()" style="accent-color:#1B3B6F;"> Fri</label>
                                <label style="display:flex;align-items:center;gap:4px;font-size:0.82rem;cursor:pointer;padding:4px 8px;border:1px solid #D4AF37;border-radius:4px;background:#fffbeb;">
                                    <input type="checkbox" id="wdSat" value="6" checked onchange="saveWorkingDays()" style="accent-color:#1B3B6F;"> Sat</label>
                            </div>
                            <div id="workingDaySummary" style="font-size:0.78rem;color:#64748b;margin-top:6px;">6 days/week (Mon‚ÄìSat)</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Working Hours per Day</label>
                            <input type="number" class="form-input" id="hoursPerDay" value="8" style="max-width: 150px;" onchange="saveCalendar()">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-header">2. MONSOON PERIOD</div>
                        <div class="form-group">
                            <label class="form-label">Monsoon (No Work Period)</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <input type="date" class="form-input" id="monsoonStart" value="2025-07-15" onchange="saveCalendar()">
                                <input type="date" class="form-input" id="monsoonEnd" value="2025-08-15" onchange="saveCalendar()">
                            </div>
                            <div style="margin-top: 10px; padding: 10px; background: rgba(239, 68, 68, 0.05); border-radius: 4px;">
                                <strong>‚ö†Ô∏è Monsoon:</strong> 15 July - 15 August 2025 (32 days no work)
                            </div>
                        </div>
                    </div>
                    
                    <!-- FIX-GAP04: Working Days selector -->
                    <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:16px;">
                        <label class="form-label" style="font-weight:700;margin-bottom:10px;display:block;">üìÖ Working Days per Week</label>
                        <div id="workingDaysSelector" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;"></div>
                        <p style="font-size:0.75rem;color:#94a3b8;margin:0;">Affects all WBS start/finish date calculations. Default: Mon‚ÄìSat (6 days/week).</p>
                    </div>
                    <button class="btn btn-primary" style="margin-top: 20px;" onclick="saveCalendar()">üíæ Save Calendar</button>

                    <!-- U-04: Holiday Management -->
                    <div style="background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:20px;margin-top:20px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                            <h4 style="margin:0;color:#1B3B6F;font-size:1rem;">üìÖ Public Holidays & Project Shutdowns</h4>
                            <button onclick="addHolidayRow()" style="padding:6px 14px;background:#1B3B6F;color:white;border:none;border-radius:6px;font-size:0.82rem;cursor:pointer;font-weight:600;">+ Add Holiday</button>
                        </div>
                        <table style="width:100%;border-collapse:collapse;font-size:0.85rem;" id="holidayTable">
                            <thead>
                                <tr style="background:#EBF0FA;">
                                    <th style="padding:8px 12px;text-align:left;color:#1B3B6F;font-weight:700;border-bottom:2px solid #1B3B6F;">Date</th>
                                    <th style="padding:8px 12px;text-align:left;color:#1B3B6F;font-weight:700;border-bottom:2px solid #1B3B6F;">Description</th>
                                    <th style="padding:8px 12px;text-align:center;color:#1B3B6F;font-weight:700;border-bottom:2px solid #1B3B6F;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="holidayTableBody">
                                <!-- Populated by renderHolidayTable() -->
                            </tbody>
                        </table>
                        <p style="font-size:0.78rem;color:#94a3b8;margin:8px 0 0 0;">Holidays are excluded from working-day schedule calculations.</p>
                    </div>

                    <!-- Sticky Nav Footer -->
                    <div style="position:sticky;bottom:0;background:#1B3B6F;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;border-top:3px solid #D4AF37;z-index:20;margin-top:auto;">
                        <button onclick="switchMainTab(3)" style="padding:8px 20px;background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:6px;font-weight:600;font-size:0.85rem;cursor:pointer;">‚Üê Previous</button>
                        <span style="font-size:0.8rem;color:rgba(255,255,255,0.6);font-weight:500;">Step 5 of 6 ¬∑ Calendar</span>
                        <button onclick="switchMainTab(5)" style="padding:8px 20px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:6px;font-weight:700;font-size:0.85rem;cursor:pointer;">Next: Resources ‚Üí</button>
                    </div>
                </div>
            </div>
            
            <!-- TAB 6: RESOURCES (3 SUB-TABS: P&M / MANPOWER / MATERIALS) -->
            <div class="tab-panel" id="tab6">
                <div class="tabular-container">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <h3 style="margin: 0; color: var(--primary-navy);">üîß Resources Management</h3>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-secondary btn-sm">Export Resources</button>
                        </div>
                    </div>
                    
                    <div style="background: rgba(59, 130, 246, 0.05); padding: 12px 20px; border-left: 4px solid #3b82f6; margin-bottom: 15px;">
                        <div style="font-size: 0.85rem; line-height: 1.6;">
                            <strong>üìã Planning Phase:</strong> Define resource TYPES with productivity rates<br>
                            <strong>üîÑ Tab 7 (Activity Grid):</strong> System auto-calculates requirements<br>
                            <strong>üîí After Baseline:</strong> Create specific equipment/labor units
                        </div>
                    </div>
                    
                    <!-- RESOURCE SUB-TABS -->
                    <div class="detail-tabs" style="border-bottom: 2px solid var(--border-medium); background: white;">
                        <button class="detail-tab active" onclick="switchResourceTab(0)">Plant & Machinery</button>
                        <button class="detail-tab" onclick="switchResourceTab(1)">Manpower</button>
                        <button class="detail-tab" onclick="switchResourceTab(2)">Materials</button>
                    </div>
                    
                    <!-- SUB-TAB 1: PLANT & MACHINERY -->
                    <div class="resource-subtab active" id="resourceSubtab0">
                        <div class="split-view">
                            <div class="list-panel">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--primary-navy); color: white;">
                                    <div style="font-weight: 600;">Plant & Machinery (70%)</div>
                                    <button class="btn btn-success btn-sm" onclick="addPlantMachinery()" style="background: var(--accent-gold); border: none;">+ Add Equipment</button>
                                </div>
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th width="5%"><input type="checkbox"></th>
                                            <th width="5%">#</th>
                                            <th width="25%">Equipment Type</th>
                                            <th width="20%">Capacity</th>
                                            <th width="20%">Activities</th>
                                            <th width="15%">Requirement</th>
                                            <th width="10%">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="equipmentTable">
                                        <tr onclick="selectEquipment(this, 0)" style="cursor: pointer;">
                                            <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                            <td><strong>1</strong></td>
                                            <td><strong style="color: #1e40af;">Excavator</strong></td>
                                            <td>1.6 Cum</td>
                                            <td style="font-size: 0.8rem;">3 activities</td>
                                            <td style="color: #6b7280;">From Tab 7</td>
                                            <td><span style="color: #22c55e; font-weight: 600;">‚úì</span></td>
                                        </tr>
                                        <tr onclick="selectEquipment(this, 1)" style="cursor: pointer;">
                                            <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                            <td><strong>2</strong></td>
                                            <td><strong style="color: #059669;">Motor Grader</strong></td>
                                            <td>CAT 140</td>
                                            <td style="font-size: 0.8rem;">4 activities</td>
                                            <td style="color: #6b7280;">From Tab 7</td>
                                            <td><span style="color: #22c55e; font-weight: 600;">‚úì</span></td>
                                        </tr>
                                        <tr onclick="selectEquipment(this, 2)" style="cursor: pointer;">
                                            <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                            <td><strong>3</strong></td>
                                            <td><strong style="color: #dc2626;">Sensor Paver</strong></td>
                                            <td>AP615 6m</td>
                                            <td style="font-size: 0.8rem;">4 activities</td>
                                            <td style="color: #6b7280;">From Tab 7</td>
                                            <td><span style="color: #22c55e; font-weight: 600;">‚úì</span></td>
                                        </tr>
                                        <tr onclick="selectEquipment(this, 3)" style="cursor: pointer;">
                                            <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                            <td><strong>4</strong></td>
                                            <td><strong style="color: #7c3aed;">Vibratory Roller</strong></td>
                                            <td>10-12T</td>
                                            <td style="font-size: 0.8rem;">5 activities</td>
                                            <td style="color: #6b7280;">From Tab 7</td>
                                            <td><span style="color: #22c55e; font-weight: 600;">‚úì</span></td>
                                        </tr>
                                        <tr onclick="selectEquipment(this, 4)" style="cursor: pointer;">
                                            <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                            <td><strong>5</strong></td>
                                            <td><strong style="color: #ea580c;">Tipper</strong></td>
                                            <td>10 Ton</td>
                                            <td style="font-size: 0.8rem;">5 activities</td>
                                            <td style="color: #6b7280;">From Tab 7</td>
                                            <td><span style="color: #22c55e; font-weight: 600;">‚úì</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="detail-panel">
                                <div class="detail-header">Equipment Details (30%)</div>
                                <div class="detail-content" id="equipmentDetailContent">
                                    <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                                        <div style="font-size: 3rem; margin-bottom: 15px;">üöú</div>
                                        <div style="font-size: 0.95rem;">Select equipment to view/edit details</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SUB-TAB 2: MANPOWER -->
                    <div class="resource-subtab" id="resourceSubtab1" style="display: none;">
                        <div class="split-view">
                            <div class="list-panel">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--primary-navy); color: white;">
                                    <div style="font-weight: 600;">Manpower (70%)</div>
                                    <button class="btn btn-success btn-sm" onclick="addManpower()" style="background: var(--accent-gold); border: none;">+ Add Labor Type</button>
                                </div>
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th width="5%"><input type="checkbox"></th>
                                            <th width="5%">#</th>
                                            <th width="25%">Labor Type</th>
                                            <th width="25%">Category</th>
                                            <th width="20%">Productivity</th>
                                            <th width="15%">Requirement</th>
                                            <th width="5%">‚úì</th>
                                        </tr>
                                    </thead>
                                    <tbody id="manpowerTable">
                                        <tr onclick="selectManpower(this, 0)" style="cursor: pointer;">
                                            <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                            <td><strong>1</strong></td>
                                            <td><strong style="color: #1e40af;">Mason</strong></td>
                                            <td>Skilled</td>
                                            <td style="font-size: 0.8rem;">10 Sqm/day</td>
                                            <td style="color: #6b7280;">From Tab 7</td>
                                            <td><span style="color: #22c55e;">‚úì</span></td>
                                        </tr>
                                        <tr onclick="selectManpower(this, 1)" style="cursor: pointer;">
                                            <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                            <td><strong>2</strong></td>
                                            <td><strong style="color: #059669;">Steel Fixer</strong></td>
                                            <td>Skilled</td>
                                            <td style="font-size: 0.8rem;">50 Kg/day</td>
                                            <td style="color: #6b7280;">From Tab 7</td>
                                            <td><span style="color: #22c55e;">‚úì</span></td>
                                        </tr>
                                        <tr onclick="selectManpower(this, 2)" style="cursor: pointer;">
                                            <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                            <td><strong>3</strong></td>
                                            <td><strong style="color: #f59e0b;">Unskilled Labor</strong></td>
                                            <td>Unskilled</td>
                                            <td style="font-size: 0.8rem;">5 Cum/day</td>
                                            <td style="color: #6b7280;">From Tab 7</td>
                                            <td><span style="color: #22c55e;">‚úì</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="detail-panel">
                                <div class="detail-header">Labor Details (30%)</div>
                                <div class="detail-content" id="manpowerDetailContent">
                                    <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                                        <div style="font-size: 3rem; margin-bottom: 15px;">üë∑</div>
                                        <div style="font-size: 0.95rem;">Select labor type to view/edit details</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SUB-TAB 3: MATERIALS -->
                    <div class="resource-subtab" id="resourceSubtab2" style="display: none;">
                        <div class="split-view">
                            <div class="list-panel">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--primary-navy); color: white;">
                                    <div style="font-weight: 600;">Materials (70%)</div>
                                    <button class="btn btn-success btn-sm" onclick="addMaterial()" style="background: var(--accent-gold); border: none;">+ Add Material</button>
                                </div>
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th width="5%"><input type="checkbox"></th>
                                            <th width="5%">#</th>
                                            <th width="25%">Material</th>
                                            <th width="15%">Unit</th>
                                            <th width="20%">Category</th>
                                            <th width="20%">Requirement</th>
                                            <th width="10%">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="materialTable">
                                        <tr onclick="selectMaterial(this, 0)" style="cursor: pointer;">
                                            <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                            <td><strong>1</strong></td>
                                            <td><strong style="color: #1e40af;">Cement</strong></td>
                                            <td>Bags / Tons</td>
                                            <td>Binding</td>
                                            <td style="color: #6b7280;">From Tab 7</td>
                                            <td><span style="color: #22c55e;">‚úì</span></td>
                                        </tr>
                                        <tr onclick="selectMaterial(this, 1)" style="cursor: pointer;">
                                            <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                            <td><strong>2</strong></td>
                                            <td><strong style="color: #dc2626;">Steel (TMT)</strong></td>
                                            <td>Kg / Tons</td>
                                            <td>Reinforcement</td>
                                            <td style="color: #6b7280;">From Tab 7</td>
                                            <td><span style="color: #22c55e;">‚úì</span></td>
                                        </tr>
                                        <tr onclick="selectMaterial(this, 2)" style="cursor: pointer;">
                                            <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                            <td><strong>3</strong></td>
                                            <td><strong style="color: #6b7280;">Aggregate 20mm</strong></td>
                                            <td>Cum</td>
                                            <td>Granular</td>
                                            <td style="color: #6b7280;">From Tab 7</td>
                                            <td><span style="color: #22c55e;">‚úì</span></td>
                                        </tr>
                                        <tr onclick="selectMaterial(this, 3)" style="cursor: pointer;">
                                            <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                            <td><strong>4</strong></td>
                                            <td><strong style="color: #0891b2;">Bitumen VG30</strong></td>
                                            <td>Tons</td>
                                            <td>Paving</td>
                                            <td style="color: #6b7280;">From Tab 7</td>
                                            <td><span style="color: #22c55e;">‚úì</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="detail-panel">
                                <div class="detail-header">Material Details (30%)</div>
                                <div class="detail-content" id="materialDetailContent">
                                    <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                                        <div style="font-size: 3rem; margin-bottom: 15px;">üì¶</div>
                                        <div style="font-size: 0.95rem;">Select material to view/edit details</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sticky Nav Footer -->
                    <div style="position:sticky;bottom:0;background:#1B3B6F;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;border-top:3px solid #D4AF37;z-index:20;margin-top:auto;">
                        <button onclick="switchMainTab(4)" style="padding:8px 20px;background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:6px;font-weight:600;font-size:0.85rem;cursor:pointer;">‚Üê Previous</button>
                        <span style="font-size:0.8rem;color:rgba(255,255,255,0.6);font-weight:500;">Step 6 of 6 ¬∑ Resources</span>
                        <button onclick="switchMainTab(6)" style="padding:8px 20px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:6px;font-weight:700;font-size:0.85rem;cursor:pointer;">Next: Activity Grid ‚Üí</button>
                    </div>
                </div>
            </div>
            
            <!-- TAB 7: ACTIVITY GRID - ULTIMATE PROFESSIONAL -->
            <div class="tab-panel" id="tab7">
                <div class="tabular-container">
                    
                    <!-- Top Toolbar -->
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <h3 style="margin: 0; color: #1B3B6F;">üìä Activity Grid</h3>
                            <div id="wbsSummaryBar" style="margin-left: 20px; font-size: 0.8125rem; color: #64748b; display: flex; gap: 12px; align-items: center;">
                                <span style="color:#22c55e;font-weight:600;">Loading...</span>
                            </div>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-success btn-sm" onclick="KALYANTRA.render.wbsTable()">üîÑ Refresh WBS</button>
                            <button class="btn btn-primary btn-sm" onclick="const m=document.getElementById('addModal'); if(m){m.style.display='flex';}else{showToast('‚ûï Use the + button in WBS toolbar', 'info')}">+ Add</button>
                            <button class="btn btn-secondary btn-sm btn-v7" onclick="showToast('‚öôÔ∏è Settings panel coming in V7.0', 'info')">‚öôÔ∏è Settings</button>
                        </div>
                    </div>
                    
                    <!-- Child Tab Navigation -->
                    <div style="background: white; border-bottom: 2px solid #e5e7eb; display: flex; gap: 2px; padding: 0 20px;">
                        <button onclick="switchTab7Child(0)" id="tab7child0" style="padding: 14px 20px; border: none; background: #1B3B6F; color: white; font-weight: 600; font-size: 0.9375rem; cursor: pointer; border-bottom: 3px solid #D4AF37; transition: all 0.2s;">
                            üìã WBS Structure
                        </button>
                        <button onclick="switchTab7Child(1)" id="tab7child1" style="padding: 14px 20px; border: none; background: transparent; color: #64748b; font-weight: 600; font-size: 0.9375rem; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s;">
                            üìù Activities
                        </button>
                        <button onclick="switchTab7Child(2)" id="tab7child2" style="padding: 14px 20px; border: none; background: transparent; color: #64748b; font-weight: 600; font-size: 0.9375rem; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s;">
                            üìä Gantt Chart
                        </button>
                        <button onclick="switchTab7Child(3)" id="tab7child3" style="padding: 14px 20px; border: none; background: transparent; color: #64748b; font-weight: 600; font-size: 0.9375rem; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s;">
                            üìç Linear Diagram
                        </button>
                    </div>
                    
                    <!-- Content Container -->
                    <div style="position: relative; height: calc(100vh - 340px); overflow: hidden;">
                        
                        <!-- Child Tab 0: WBS Structure -->
                        <div id="tab7content0" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; overflow: hidden;">
                            <div style="padding: 12px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; gap: 10px;">
                                <button onclick="expandAllWBS()" style="padding: 6px 12px; background: white; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.875rem; cursor: pointer;">‚ñº Expand All</button>
                                <button onclick="collapseAllWBS()" style="padding: 6px 12px; background: white; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.875rem; cursor: pointer;">‚ñ∂ Collapse All</button>
                                <span id="wbsStatBar" style="margin-left: auto; font-size: 0.875rem; color: #64748b;">Loading WBS stats...</span>
                            </div>
                            
                            <div style="flex: 1; overflow: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                    <thead style="position: sticky; top: 0; background: #f1f5f9; z-index: 10;">
                                        <tr>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; width: 40px;"></th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; width: 70px;">WBS</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1;">Name</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; width: 100px;">Duration</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; width: 100px;">Start</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; width: 100px;">Finish</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; width: 80px;">Tasks</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; width: 120px;">Status</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; width: 100px;">Cost</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; width: 100px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="wbsBody">
                                        <tr><td colspan="10" style="text-align:center;padding:30px;color:#64748b;font-style:italic;">üîÑ Loading WBS from your data...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Child Tab 1: Activities -->
                        <div id="tab7content1" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: none; flex-direction: column; overflow: hidden; background: white;">
                            <div style="padding: 12px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                                <span style="font-weight: 500; font-size: 0.875rem;">Filter by WBS:</span>
                                <select id="activityFilter" onchange="filterActivities()" style="margin-left: 10px; padding: 6px 12px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.875rem;">
                                    <option value="all">All Activities</option>
                                </select>
                                <span style="margin-left: auto; float: right; font-size: 0.875rem; color: #64748b;">Showing <strong id="activityCount">10</strong> activities</span>
                            </div>
                            <div style="flex: 1; overflow: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                    <thead style="position: sticky; top: 0; background: #1B3B6F; z-index: 10;">
                                        <tr>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #D4AF37; color: white; width: 80px;">ID</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #D4AF37; color: white;">Activity Name</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #D4AF37; color: white;">WBS Item</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #D4AF37; color: white; width: 80px;">Qty</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #D4AF37; color: white; width: 60px;">Unit</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #D4AF37; color: white; width: 60px;">Dur</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #D4AF37; color: white; width: 100px;">Start</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #D4AF37; color: white; width: 100px;">Finish</th>
                                            <th style="padding: 10px; text-align: center; font-weight: 700; border-bottom: 2px solid #D4AF37; color: #D4AF37; width: 110px;">% Done</th>
                                        </tr>
                                    </thead>
                                    <tbody id="activitiesBody"><tr><td colspan="8" style="padding: 20px; text-align: center; color: #94a3b8; font-style: italic;">üîÑ Click Activity Grid in sidebar or navigate here from WBS to load activities...</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Child Tab 2: ULTIMATE GANTT CHART -->
                        <div id="tab7content2" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: none; flex-direction: column; overflow: hidden; background: white;">
                            
                            <!-- Gantt Controls -->
                            <div style="padding: 10px 16px; background: #f8fafc; border-bottom: 2px solid #e5e7eb; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                <button onclick="ganttZoomIn()" style="padding: 6px 12px; background: white; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.8125rem; cursor: pointer;">üîç+ Zoom In</button>
                                <button onclick="ganttZoomOut()" style="padding: 6px 12px; background: white; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.8125rem; cursor: pointer;">üîç- Zoom Out</button>
                                <button onclick="ganttFit()" style="padding: 6px 12px; background: white; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.8125rem; cursor: pointer;">‚õ∂ Fit</button>
                                <div style="width: 1px; height: 20px; background: #cbd5e1; margin: 0 4px;"></div>
                                <button id="ganttCriticalBtn" onclick="ganttToggleCritical()" style="padding: 6px 12px; background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; border-radius: 6px; font-size: 0.8125rem; cursor: pointer; font-weight: 600;">üî¥ Critical Path</button>
                                <button id="execModeBtn" onclick="toggleExecutionMode()" style="padding:6px 12px;background:#EBF0FA;color:#1B3B6F;border:1px solid #1B3B6F;border-radius:6px;font-size:0.8125rem;cursor:pointer;font-weight:600;" title="Sequential: one stretch after another | Parallel: all stretches start together">‚ö° Sequential</button>
                                <span id="ganttZoomLabel" style="margin-left: auto; font-size: 0.8125rem; color: #64748b; font-weight: 600;">100%</span>
                                <button onclick="renderGantt()" style="padding: 6px 14px; background: #1B3B6F; color: white; border: none; border-radius: 6px; font-size: 0.8125rem; cursor: pointer; font-weight: 600;">üîÑ Refresh Gantt</button>
                            </div>
                            
                            <!-- Gantt Split View -->
                            <div style="flex: 1; display: flex; overflow: hidden;">
                                <!-- Left Panel: Activity List (fixed 300px) -->
                                <div id="ganttActivityList" style="flex: 0 0 300px; border-right: 2px solid #e5e7eb; overflow-y: auto; background: #fafbfc;"></div>
                                <!-- Right Panel: Timeline (scrollable) -->
                                <div style="flex: 1; overflow: auto; position: relative;">
                                    <div id="ganttTimeline" style="min-width: 100%;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="tab7content3" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: none; flex-direction: column; background: white; overflow: hidden;">
                            
                            <!-- LSM Controls Toolbar -->
                            <div style="padding: 12px 20px; background: #f8fafc; border-bottom: 2px solid #e5e7eb; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <button onclick="lsmZoomIn()" style="padding: 7px 14px; background: white; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.875rem; cursor: pointer; font-weight: 500;">üîç+ Zoom In</button>
                                <button onclick="lsmZoomOut()" style="padding: 7px 14px; background: white; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.875rem; cursor: pointer; font-weight: 500;">üîç- Zoom Out</button>
                                <button onclick="lsmResetView()" style="padding: 7px 14px; background: white; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.875rem; cursor: pointer; font-weight: 500;">‚õ∂ Reset View</button>
                                <div style="border-left: 2px solid #cbd5e1; height: 24px; margin: 0 4px;"></div>
                                <button onclick="lsmToggleCritical()" id="lsmCriticalBtn" style="padding: 7px 14px; background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; border-radius: 6px; font-size: 0.875rem; cursor: pointer; font-weight: 600;">üî¥ Critical Path</button>
                                <button onclick="lsmToggleBuffer()" id="lsmBufferBtn" style="padding: 7px 14px; background: white; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.875rem; cursor: pointer; font-weight: 500;">üìè Buffer Zones</button>
                                <button onclick="lsmToggleConflicts()" id="lsmConflictBtn" style="padding: 7px 14px; background: white; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.875rem; cursor: pointer; font-weight: 500;">‚ö†Ô∏è Conflicts</button>
                                <span style="margin-left: auto; color: #64748b; font-weight: 600; font-size: 0.875rem;">
                                    Time-Distance Diagram ‚Ä¢ Ch 0+000 to 5+000
                                </span>
                            </div>
                            
                            <!-- LSM Chart Container -->
                            <div style="flex: 1; display: flex; overflow: hidden;">
                                
                                <!-- Y-axis Labels (Chainage) -->
                                <div style="flex: 0 0 100px; background: #f8fafc; border-right: 2px solid #e5e7eb; display: flex; flex-direction: column;">
                                    <div style="height: 60px; border-bottom: 2px solid #cbd5e1; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8125rem; color: #475569; text-transform: uppercase; letter-spacing: 0.5px;">
                                        Chainage
                                    </div>
                                    <div id="lsmYAxis" style="flex: 1; position: relative; padding: 20px 10px;">
                                        <!-- Y-axis labels will be generated here -->
                                    </div>
                                </div>
                                
                                <!-- Main Chart Area -->
                                <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                                    
                                    <!-- X-axis Header (Timeline) -->
                                    <div style="height: 60px; background: #f1f5f9; border-bottom: 2px solid #cbd5e1; display: flex;">
                                        <div id="lsmXAxis" style="flex: 1; display: flex; padding: 0 20px;">
                                            <!-- X-axis labels will be generated here -->
                                        </div>
                                    </div>
                                    
                                    <!-- SVG Canvas for LSM -->
                                    <div id="lsmCanvasContainer" style="flex: 1; position: relative; overflow: auto; background: white;">
                                        <svg id="lsmCanvas" width="100%" height="100%" style="display: block;">
                                            <!-- Grid lines -->
                                            <defs>
                                                <pattern id="lsmGridPattern" width="100" height="50" patternUnits="userSpaceOnUse">
                                                    <path d="M 100 0 L 0 0 0 50" fill="none" stroke="#e2e8f0" stroke-width="1"/>
                                                </pattern>
                                                
                                                <!-- Arrow markers for activity lines -->
                                                <marker id="arrowGreen" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth">
                                                    <path d="M0,0 L0,6 L9,3 z" fill="#22c55e"/>
                                                </marker>
                                                <marker id="arrowRed" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth">
                                                    <path d="M0,0 L0,6 L9,3 z" fill="#dc2626"/>
                                                </marker>
                                                <marker id="arrowBlue" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth">
                                                    <path d="M0,0 L0,6 L9,3 z" fill="#3b82f6"/>
                                                </marker>
                                            </defs>
                                            
                                            <!-- Background grid -->
                                            <rect width="100%" height="100%" fill="url(#lsmGridPattern)"/>
                                            
                                            <!-- Activity lines will be drawn here by JavaScript -->
                                            <g id="lsmActivities"></g>
                                            
                                            <!-- Buffer zones (if enabled) -->
                                            <g id="lsmBuffers" style="display: none;"></g>
                                            
                                            <!-- Conflict markers (if enabled) -->
                                            <g id="lsmConflicts" style="display: none;"></g>
                                            
                                            <!-- Hover tooltip area -->
                                            <g id="lsmTooltip" style="display: none;"></g>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Legend and Info Bar -->
                            <div style="padding: 14px 20px; background: #f8fafc; border-top: 2px solid #e5e7eb; display: flex; gap: 24px; font-size: 0.875rem;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <svg width="30" height="3">
                                        <line x1="0" y1="1.5" x2="30" y2="1.5" stroke="#22c55e" stroke-width="3"/>
                                    </svg>
                                    <span style="color: #475569;">Earthwork</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <svg width="30" height="3">
                                        <line x1="0" y1="1.5" x2="30" y2="1.5" stroke="#3b82f6" stroke-width="3"/>
                                    </svg>
                                    <span style="color: #475569;">Structures</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <svg width="30" height="3">
                                        <line x1="0" y1="1.5" x2="30" y2="1.5" stroke="#dc2626" stroke-width="4"/>
                                    </svg>
                                    <span style="color: #475569;">Critical Path</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <svg width="30" height="20">
                                        <rect x="0" y="5" width="30" height="10" fill="rgba(251, 191, 36, 0.2)" stroke="#f59e0b" stroke-width="1" stroke-dasharray="3,2"/>
                                    </svg>
                                    <span style="color: #475569;">Buffer Zone</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.2rem;">‚ö†Ô∏è</span>
                                    <span style="color: #475569;">Conflict Point</span>
                                </div>
                                <span style="margin-left: auto; color: #1e293b; font-weight: 600;">
                                    <span id="lsmActivityCount">12</span> activities ‚Ä¢ Production Rate: <span id="lsmProductionRate">160</span> m/day
                                </span>
                            </div>
                            
                        </div>
                        
                    </div>
                </div>
            </div>

            
            <!-- TAB 8: EXECUTIVE DASHBOARD -->
            <div class="tab-panel" id="tab8">
                <div class="tabular-container">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <h3 style="margin: 0; color: #1B3B6F;">üìä Executive Dashboard ‚Äî <span id="dashProjectName">NH-44 Sample Project</span></h3>
                            <span id="dashLastUpdated" style="margin-left: 16px; font-size: 0.875rem; color: #64748b;">Last Updated: ‚Äî</span>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-secondary btn-sm" onclick="KALYANTRA.render.dashboard()">üîÑ Refresh</button>
                            <button class="btn btn-primary btn-sm btn-v7" onclick="showToast('üìÑ PDF export ‚Äî Coming in V7.0', 'info')" style="opacity:0.55;cursor:not-allowed;" title="Coming in V7.0">üìÑ Export PDF <span style='font-size:0.65rem;background:#94a3b8;color:white;padding:1px 5px;border-radius:3px;margin-left:4px;'>V7.0</span></button>
                        </div>
                    </div>
                    
                    <div class="content-container" style="padding: 24px;">
                        
                        <!-- Top Status Cards -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 28px;">
                            <div style="background: white; border-radius: 8px; padding: 20px; border-left: 4px solid #22c55e; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 8px; font-weight: 500;">PROJECT STATUS</div>
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 4px;">
                                    <span style="font-size: 2rem;">üü¢</span>
                                    <span style="font-size: 1.5rem; font-weight: 700; color: #22c55e;">ON TRACK</span>
                                </div>
                                <div style="font-size: 0.8125rem; color: #475569;">Project progressing as planned</div>
                            </div>
                            
                            <div style="background: white; border-radius: 8px; padding: 20px; border-left: 4px solid #f59e0b; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 8px; font-weight: 500;">SCHEDULE STATUS</div>
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 4px;">
                                    <span style="font-size: 2rem;">üü°</span>
                                    <span style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">MINOR DELAY</span>
                                </div>
                                <div style="font-size: 0.8125rem; color: #475569;">2 activities behind by 3 days</div>
                            </div>
                            
                            <div style="background: white; border-radius: 8px; padding: 20px; border-left: 4px solid #22c55e; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 8px; font-weight: 500;">COST STATUS</div>
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 4px;">
                                    <span style="font-size: 2rem;">üü¢</span>
                                    <span style="font-size: 1.5rem; font-weight: 700; color: #22c55e;">ON BUDGET</span>
                                </div>
                                <div style="font-size: 0.8125rem; color: #475569;">Within approved budget limits</div>
                            </div>
                        </div>
                        
                        <!-- Progress Metrics Row -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 28px;">
                            
                            <!-- Overall Progress -->
                            <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Key Progress Metrics</h4>
                                
                                <div style="margin-bottom: 18px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">Overall Progress</span>
                                        <span id="dashOverallPct" style="font-size: 0.875rem; font-weight: 700; color: #1e293b;">35%</span>
                                    </div>
                                    <div style="width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                        <div id="dashOverallBar" style="width: 35%; height: 100%; background: linear-gradient(to right, #3b82f6, #2563eb); border-radius: 5px; transition: width 0.6s ease;"></div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 18px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">Physical Progress</span>
                                        <span id="dashPhysicalPct" style="font-size: 0.875rem; font-weight: 700; color: #1e293b;">38%</span>
                                    </div>
                                    <div style="width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                        <div id="dashPhysicalBar" style="width: 38%; height: 100%; background: linear-gradient(to right, #22c55e, #16a34a); border-radius: 5px; transition: width 0.6s ease;"></div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 18px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">Financial Progress</span>
                                        <span id="dashFinancialPct" style="font-size: 0.875rem; font-weight: 700; color: #1e293b;">32%</span>
                                    </div>
                                    <div style="width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                        <div id="dashFinancialBar" style="width: 32%; height: 100%; background: linear-gradient(to right, #f59e0b, #d97706); border-radius: 5px; transition: width 0.6s ease;"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">Time Elapsed</span>
                                        <span style="font-size: 0.875rem; font-weight: 700; color: #1e293b;">30%</span>
                                    </div>
                                    <div style="width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                        <div id="dashTimeBar" style="width: 30%; height: 100%; background: linear-gradient(to right, #64748b, #475569); border-radius: 5px; transition: width 0.6s ease;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Critical Alerts -->
                            <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Critical Alerts</h4>
                                
                                <div id="dashHindranceAlert" style="padding: 12px; background: #fef2f2; border-left: 4px solid #ef4444; margin-bottom: 12px; border-radius: 4px; transition: all 0.3s;">
                                    <div style="display: flex; align-items: start; gap: 10px;">
                                        <span style="font-size: 1.25rem;">üî¥</span>
                                        <div>
                                            <div id="dashHindranceCount" style="font-weight: 600; font-size: 0.875rem; color: #991b1b; margin-bottom: 4px;">1 Hindrance Blocking Work</div>
                                            <div style="font-size: 0.8125rem; color: #64748b;">Utility shifting pending at Ch 3+200-3+800</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="padding: 12px; background: #fffbeb; border-left: 4px solid #f59e0b; margin-bottom: 12px; border-radius: 4px;">
                                    <div style="display: flex; align-items: start; gap: 10px;">
                                        <span style="font-size: 1.25rem;">üü°</span>
                                        <div>
                                            <div style="font-weight: 600; font-size: 0.875rem; color: #92400e; margin-bottom: 4px;">2 Activities Behind Schedule</div>
                                            <div style="font-size: 0.8125rem; color: #64748b;">Embankment and GSB delayed by 3 days</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="padding: 12px; background: #f0fdf4; border-left: 4px solid #22c55e; border-radius: 4px;">
                                    <div style="display: flex; align-items: start; gap: 10px;">
                                        <span style="font-size: 1.25rem;">üü¢</span>
                                        <div>
                                            <div style="font-weight: 600; font-size: 0.875rem; color: #166534; margin-bottom: 4px;">All Resources Available</div>
                                            <div style="font-size: 0.8125rem; color: #64748b;">Equipment and materials on schedule</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Stats Grid -->
                        <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 28px;">
                            <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Quick Statistics</h4>
                            
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px;">
                                <div style="text-align: center; padding: 16px; background: #f8fafc; border-radius: 6px;">
                                    <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Total Activities</div>
                                    <div id="dashTotalActivities" style="font-size: 2rem; font-weight: 700; color: #1e293b;">18</div>
                                </div>
                                <div style="text-align: center; padding: 16px; background: #fef2f2; border-radius: 6px;">
                                    <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Critical Path</div>
                                    <div id="dashCriticalPath" style="font-size: 2rem; font-weight: 700; color: #dc2626;">6</div>
                                </div>
                                <div style="text-align: center; padding: 16px; background: #f0fdf4; border-radius: 6px;">
                                    <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Completed</div>
                                    <div id="dashCompleted" style="font-size: 2rem; font-weight: 700; color: #22c55e;">0</div>
                                </div>
                                <div style="text-align: center; padding: 16px; background: #fffbeb; border-radius: 6px;">
                                    <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Delayed</div>
                                    <div style="font-size: 2rem; font-weight: 700; color: #f59e0b;">2</div>
                                </div>
                                <div style="text-align: center; padding: 16px; background: #f8fafc; border-radius: 6px;">
                                    <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Total Duration</div>
                                    <div id="dashTotalDuration" style="font-size: 2rem; font-weight: 700; color: #1e293b;">45d</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Work Breakdown Summary -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                            
                            <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Progress by Phase</h4>
                                
                                <div style="margin-bottom: 16px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">üü¢ Phase 1 - Immediate Work</span>
                                        <span id="dashPhase1Pct" style="font-size: 0.875rem; font-weight: 700; color: #22c55e;">45%</span>
                                    </div>
                                    <div id="dashPhase1Acts" style="font-size: 0.8125rem; color: #64748b; margin-bottom: 6px;">12 activities ‚Ä¢ 2.4 km stretch</div>
                                    <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                        <div id="dashPhase1Bar" style="width: 45%; height: 100%; background: #22c55e; border-radius: 4px; transition: width 0.6s ease;"></div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">üîµ Phase 2 - Structures</span>
                                        <span id="dashPhase2Pct" style="font-size: 0.875rem; font-weight: 700; color: #3b82f6;">25%</span>
                                    </div>
                                    <div id="dashPhase2Acts" style="font-size: 0.8125rem; color: #64748b; margin-bottom: 6px;">0 activities</div>
                                    <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                        <div id="dashPhase2Bar" style="width: 0%; height: 100%; background: #3b82f6; border-radius: 4px; transition: width 0.6s ease;"></div>
                                    </div>
                                </div>
                                <!-- L-09 Phase 3 Blocked/Hindrances -->
                                <div style="margin-top:12px;">
                                    <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                                        <span style="font-size:0.875rem;font-weight:600;color:#1e293b;">Phase 3: Blocked Zones</span>
                                        <span id="dashPhase3Pct" style="font-size:0.875rem;font-weight:700;color:#ef4444;">0%</span>
                                    </div>
                                    <div id="dashPhase3Acts" style="font-size:0.8125rem;color:#64748b;margin-bottom:6px;">0 activities</div>
                                    <div style="width:100%;height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden;">
                                        <div id="dashPhase3Bar" style="width:0%;height:100%;background:#D4AF37;border-radius:4px;transition:width 0.6s ease;"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">üî¥ Phase 3 - Blocked</span>
                                        <span style="font-size: 0.875rem; font-weight: 700; color: #ef4444;">0%</span>
                                    </div>
                                    <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 6px;">Awaiting clearance</div>
                                    <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                        <div style="width: 0%; height: 100%; background: #ef4444; border-radius: 4px;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Financial Summary</h4>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                    <div>
                                        <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 4px;">Total Budget</div>
                                        <div id="dashTotalBudget" style="font-size: 1.5rem; font-weight: 700; color: #1e293b;">‚Çπ3.7 Cr</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 4px;">Spent to Date</div>
                                        <div id="dashSpent" style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">‚Çπ1.2 Cr</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 4px;">Remaining</div>
                                        <div id="dashRemaining" style="font-size: 1.5rem; font-weight: 700; color: #22c55e;">‚Çπ2.5 Cr</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 4px;">Variance</div>
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #22c55e;">+‚Çπ0.0 Cr</div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                                    <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 8px;">Budget Utilization</div>
                                    <div style="width: 100%; height: 12px; background: #e2e8f0; border-radius: 6px; overflow: hidden;">
                                        <div id="dashBudgetBar" style="width: 32%; height: 100%; background: linear-gradient(to right, #3b82f6, #2563eb); border-radius: 6px; transition: width 0.6s ease;"></div>
                                    </div>
                                    <div id="dashBudgetPct" style="text-align: right; margin-top: 4px; font-size: 0.75rem; color: #475569; font-weight: 600;">32% Utilized</div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
            
            <!-- TAB 9: PROGRESS TRACKING -->
            <div class="tab-panel" id="tab9">
                <div class="tabular-container">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <h3 style="margin: 0; color: #1B3B6F;">üìà Progress Tracking</h3>
                        </div>
                        <div class="toolbar-right">
                            <select class="form-select" id="progressPeriodSelect" style="margin-right: 12px;" onchange="renderProgressTab()">
                                <option>Last 30 Days</option>
                                <option>Last 60 Days</option>
                                <option>Last 90 Days</option>
                                <option>Project to Date</option>
                            </select>
                            <button class="btn btn-secondary btn-sm btn-v7" onclick="showToast('üìÑ Report export ‚Äî Coming in V7.0', 'info')" style="opacity:0.55;cursor:not-allowed;" title="Coming in V7.0">üìÑ Export Report <span style='font-size:0.65rem;background:#94a3b8;color:white;padding:1px 5px;border-radius:3px;margin-left:4px;'>V7.0</span></button>
                        </div>
                    </div>
                    
                    <div class="content-container" style="padding: 24px;">
                        
                        <!-- S-Curve Chart Placeholder -->
                        <div style="background: white; border-radius: 8px; padding: 28px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px;">
                            <h4 style="margin: 0 0 24px 0; color: #1e293b; font-size: 1.125rem; font-weight: 600;">Progress S-Curve (Planned vs Actual)</h4>
                            
                            <!-- Chart Area -->
                            <div style="position: relative; height: 320px; background: #fafbfc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 20px;">
                                <!-- Y-axis labels -->
                                <div style="position: absolute; left: 10px; top: 20px; bottom: 40px; display: flex; flex-direction: column; justify-content: space-between; font-size: 0.75rem; color: #64748b;">
                                    <span>100%</span>
                                    <span>75%</span>
                                    <span>50%</span>
                                    <span>25%</span>
                                    <span>0%</span>
                                </div>
                                
                                <!-- Grid lines -->
                                <div style="position: absolute; left: 50px; right: 20px; top: 20px; bottom: 40px;">
                                    <div style="position: absolute; top: 0%; left: 0; right: 0; border-top: 1px dashed #cbd5e1;"></div>
                                    <div style="position: absolute; top: 25%; left: 0; right: 0; border-top: 1px dashed #cbd5e1;"></div>
                                    <div style="position: absolute; top: 50%; left: 0; right: 0; border-top: 1px dashed #cbd5e1;"></div>
                                    <div style="position: absolute; top: 75%; left: 0; right: 0; border-top: 1px dashed #cbd5e1;"></div>
                                    <div style="position: absolute; top: 100%; left: 0; right: 0; border-top: 2px solid #94a3b8;"></div>
                                    
                                    <!-- Planned curve (blue) -->
                                    <svg style="position: absolute; width: 100%; height: 100%;">
                                        <polyline points="0,280 50,250 100,210 150,160 200,110 250,60 300,30 350,10 400,5" 
                                                  fill="none" stroke="#3b82f6" stroke-width="3" stroke-dasharray="5,5"/>
                                    </svg>
                                    
                                    <!-- Actual curve (green) -->
                                    <svg style="position: absolute; width: 100%; height: 100%;">
                                        <polyline points="0,280 50,255 100,225 150,185 200,155" 
                                                  fill="none" stroke="#22c55e" stroke-width="3"/>
                                    </svg>
                                </div>
                                
                                <!-- X-axis labels -->
                                <div style="position: absolute; left: 50px; right: 20px; bottom: 10px; display: flex; justify-content: space-between; font-size: 0.75rem; color: #64748b;">
                                    <span>Jan</span>
                                    <span>Feb</span>
                                    <span>Mar</span>
                                    <span>Apr</span>
                                    <span>May</span>
                                    <span>Jun</span>
                                </div>
                                
                                <!-- Legend -->
                                <div style="position: absolute; top: 20px; right: 30px; background: white; padding: 12px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <div style="width: 24px; height: 3px; background: #3b82f6; border-top: 3px dashed #3b82f6;"></div>
                                        <span style="font-size: 0.8125rem; color: #475569;">Planned</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="width: 24px; height: 3px; background: #22c55e;"></div>
                                        <span style="font-size: 0.8125rem; color: #475569;">Actual</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progress by Work Type -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 24px;">
                            
                            <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Progress by Work Type</h4>
                                
                                <div style="margin-bottom: 18px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">Earthwork</span>
                                        <span style="font-size: 0.875rem; font-weight: 700; color: #1e293b;">45%</span>
                                    </div>
                                    <div style="width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                        <div style="width: 45%; height: 100%; background: linear-gradient(to right, #f59e0b, #d97706); border-radius: 5px;"></div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 18px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">Structures</span>
                                        <span style="font-size: 0.875rem; font-weight: 700; color: #1e293b;">25%</span>
                                    </div>
                                    <div style="width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                        <div style="width: 25%; height: 100%; background: linear-gradient(to right, #3b82f6, #2563eb); border-radius: 5px;"></div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 18px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">Pavement</span>
                                        <span style="font-size: 0.875rem; font-weight: 700; color: #1e293b;">10%</span>
                                    </div>
                                    <div style="width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                        <div style="width: 10%; height: 100%; background: linear-gradient(to right, #22c55e, #16a34a); border-radius: 5px;"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">Drainage</span>
                                        <span style="font-size: 0.875rem; font-weight: 700; color: #1e293b;">5%</span>
                                    </div>
                                    <div style="width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                        <div style="width: 5%; height: 100%; background: linear-gradient(to right, #8b5cf6, #7c3aed); border-radius: 5px;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Milestone Tracker</h4>
                                <div id="milestoneTrackerBody" style="min-height:40px;"></div>
                                
                                <div style="margin-bottom: 16px;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span style="font-size: 1.5rem;">‚úÖ</span>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; font-size: 0.875rem; color: #1e293b;">Project Start</div>
                                            <div style="font-size: 0.8125rem; color: #64748b;">01-Jan-2026</div>
                                        </div>
                                        <span style="background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">Completed</span>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span style="font-size: 1.5rem;">üîµ</span>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; font-size: 0.875rem; color: #1e293b;">Phase 1 Complete</div>
                                            <div style="font-size: 0.8125rem; color: #64748b;">Target: 15-Feb-2026</div>
                                        </div>
                                        <span style="background: #dbeafe; color: #1e40af; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">In Progress</span>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span style="font-size: 1.5rem;">üîµ</span>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; font-size: 0.875rem; color: #1e293b;">Box Culvert Complete</div>
                                            <div style="font-size: 0.8125rem; color: #64748b;">Target: 22-Jan-2026</div>
                                        </div>
                                        <span style="background: #dbeafe; color: #1e40af; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">In Progress</span>
                                    </div>
                                </div>
                                
                                <div>
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span style="font-size: 1.5rem;">‚ö™</span>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; font-size: 0.875rem; color: #1e293b;">Project Completion</div>
                                            <div style="font-size: 0.8125rem; color: #64748b;">Target: 15-Apr-2026</div>
                                        </div>
                                        <span style="background: #f1f5f9; color: #64748b; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">Pending</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progress by Location -->
                        <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Progress by Chainage</h4>
                            
                            <div style="position: relative; height: 80px; background: #f8fafc; border-radius: 6px; padding: 20px;">
                                <!-- Chainage markers -->
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.75rem; color: #64748b; font-weight: 600;">
                                    <span>Ch 0+000</span>
                                    <span>Ch 1+000</span>
                                    <span>Ch 2+000</span>
                                    <span>Ch 3+000</span>
                                    <span>Ch 4+000</span>
                                    <span>Ch 5+000</span>
                                </div>
                                
                                <!-- Progress bar -->
                                <div style="width: 100%; height: 24px; background: #e2e8f0; border-radius: 12px; overflow: hidden; position: relative;">
                                    <!-- Completed section -->
                                    <div style="position: absolute; left: 0; width: 40%; height: 100%; background: linear-gradient(to right, #22c55e, #16a34a);"></div>
                                    
                                    <!-- In progress section -->
                                    <div style="position: absolute; left: 40%; width: 10%; height: 100%; background: repeating-linear-gradient(45deg, #3b82f6, #3b82f6 10px, #60a5fa 10px, #60a5fa 20px);"></div>
                                    
                                    <!-- Blocked section -->
                                    <div style="position: absolute; left: 64%; width: 12%; height: 100%; background: repeating-linear-gradient(45deg, #ef4444, #ef4444 10px, #f87171 10px, #f87171 20px);"></div>
                                </div>
                                
                                <div style="display: flex; gap: 16px; margin-top: 12px; font-size: 0.75rem;">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <div style="width: 16px; height: 16px; background: linear-gradient(to right, #22c55e, #16a34a); border-radius: 2px;"></div>
                                        <span style="color: #475569;">Completed (40%)</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <div style="width: 16px; height: 16px; background: repeating-linear-gradient(45deg, #3b82f6, #3b82f6 4px, #60a5fa 4px, #60a5fa 8px); border-radius: 2px;"></div>
                                        <span style="color: #475569;">In Progress (10%)</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <div style="width: 16px; height: 16px; background: repeating-linear-gradient(45deg, #ef4444, #ef4444 4px, #f87171 4px, #f87171 8px); border-radius: 2px;"></div>
                                        <span style="color: #475569;">Blocked (12%)</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <div style="width: 16px; height: 16px; background: #e2e8f0; border-radius: 2px;"></div>
                                        <span style="color: #475569;">Not Started (38%)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
            
            <!-- TAB 10: REPORTS & ANALYTICS -->
            <div class="tab-panel" id="tab10">
                <div class="tabular-container">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <h3 style="margin: 0; color: #1B3B6F;">üìë Reports & Analytics</h3>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-primary btn-sm btn-v7" onclick="showToast('üéØ Custom report builder ‚Äî Coming in V7.0', 'info')" style="opacity:0.55;cursor:not-allowed;" title="Coming in V7.0">üéØ Custom Report <span style='font-size:0.65rem;background:#94a3b8;color:white;padding:1px 5px;border-radius:3px;margin-left:4px;'>V7.0</span></button>
                        </div>
                    </div>
                    
                    <div class="content-container" style="padding: 24px;">
                        
                        <!-- Report Templates Grid -->
                        <div style="background: white; border-radius: 8px; padding: 28px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px;">
                            <h4 style="margin: 0 0 24px 0; color: #1e293b; font-size: 1.125rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Standard Report Templates</h4>
                            
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                                
                                <div style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1B3B6F'; this.style.boxShadow='0 4px 12px rgba(27, 59, 111, 0.1)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'" onclick="generateReport('daily')">
                                    <div style="font-size: 2rem; margin-bottom: 12px;">üìä</div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; color: #1e293b; margin-bottom: 6px;">Daily Progress Report</div>
                                    <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 12px;">Daily work summary with quantities</div>
                                    <button class="btn btn-sm" style="background: #1B3B6F; color: white; width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Generate ‚Üí</button>
                                </div>
                                
                                <div style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1B3B6F'; this.style.boxShadow='0 4px 12px rgba(27, 59, 111, 0.1)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'" onclick="generateReport('weekly')">
                                    <div style="font-size: 2rem; margin-bottom: 12px;">üìà</div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; color: #1e293b; margin-bottom: 6px;">Weekly Status Report</div>
                                    <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 12px;">Comprehensive weekly summary</div>
                                    <button class="btn btn-sm" style="background: #1B3B6F; color: white; width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Generate ‚Üí</button>
                                </div>
                                
                                <div style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1B3B6F'; this.style.boxShadow='0 4px 12px rgba(27, 59, 111, 0.1)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'" onclick="generateReport('monthly')">
                                    <div style="font-size: 2rem; margin-bottom: 12px;">üìâ</div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; color: #1e293b; margin-bottom: 6px;">Monthly Progress Report</div>
                                    <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 12px;">Detailed monthly analysis</div>
                                    <button class="btn btn-sm" style="background: #1B3B6F; color: white; width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Generate ‚Üí</button>
                                </div>
                                
                                <div style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1B3B6F'; this.style.boxShadow='0 4px 12px rgba(27, 59, 111, 0.1)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'" onclick="generateReport('hindrance')">
                                    <div style="font-size: 2rem; margin-bottom: 12px;">üîç</div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; color: #1e293b; margin-bottom: 6px;">Hindrance Analysis</div>
                                    <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 12px;">Impact of delays and hindrances</div>
                                    <button class="btn btn-sm" style="background: #1B3B6F; color: white; width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Generate ‚Üí</button>
                                </div>
                                
                                <div style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1B3B6F'; this.style.boxShadow='0 4px 12px rgba(27, 59, 111, 0.1)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'" onclick="generateReport('cost')">
                                    <div style="font-size: 2rem; margin-bottom: 12px;">üí∞</div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; color: #1e293b; margin-bottom: 6px;">Cost Analysis</div>
                                    <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 12px;">Budget vs actual spending</div>
                                    <button class="btn btn-sm" style="background: #1B3B6F; color: white; width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Generate ‚Üí</button>
                                </div>
                                
                                <div style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1B3B6F'; this.style.boxShadow='0 4px 12px rgba(27, 59, 111, 0.1)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'" onclick="generateReport('resource')">
                                    <div style="font-size: 2rem; margin-bottom: 12px;">üë∑</div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; color: #1e293b; margin-bottom: 6px;">Resource Utilization</div>
                                    <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 12px;">Equipment and labor efficiency</div>
                                    <button class="btn btn-sm" style="background: #1B3B6F; color: white; width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Generate ‚Üí</button>
                                </div>
                                
                                <div style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1B3B6F'; this.style.boxShadow='0 4px 12px rgba(27, 59, 111, 0.1)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'" onclick="generateReport('schedule')">
                                    <div style="font-size: 2rem; margin-bottom: 12px;">üìÖ</div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; color: #1e293b; margin-bottom: 6px;">Schedule Variance</div>
                                    <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 12px;">Planned vs actual timeline</div>
                                    <button class="btn btn-sm" style="background: #1B3B6F; color: white; width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Generate ‚Üí</button>
                                </div>
                                
                                <div style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1B3B6F'; this.style.boxShadow='0 4px 12px rgba(27, 59, 111, 0.1)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'" onclick="showToast('üöß Quality Compliance Report coming in V7.0', 'info')">
                                    <div style="font-size: 2rem; margin-bottom: 12px;">‚úì</div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; color: #1e293b; margin-bottom: 6px;">Quality Compliance</div>
                                    <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 12px;">IRC standards adherence</div>
                                    <button class="btn btn-sm" style="background: #1B3B6F; color: white; width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Generate ‚Üí</button>
                                </div>
                                
                                <div style="border: 2px solid #D4AF37; border-radius: 8px; padding: 20px; cursor: pointer; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(212, 175, 55, 0.3)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'" onclick="showToast('üéØ Custom Report Builder coming in V7.0', 'info')">
                                    <div style="font-size: 2rem; margin-bottom: 12px;">üéØ</div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; color: #1e293b; margin-bottom: 6px;">Custom Report Builder</div>
                                    <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 12px;">Build your own custom report</div>
                                    <button class="btn btn-sm" style="background: #D4AF37; color: #1e293b; width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 700;">Build Custom ‚Üí</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Analytics -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 24px;">
                            
                            <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Top 5 Critical Activities</h4>
                                
                                <table style="width: 100%; font-size: 0.875rem;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <th style="text-align: left; padding: 8px; color: #64748b; font-weight: 600;">Activity</th>
                                            <th style="text-align: right; padding: 8px; color: #64748b; font-weight: 600;">Float</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr style="border-bottom: 1px solid #f1f5f9;">
                                            <td style="padding: 10px; color: #1e293b;">Soil Excavation</td>
                                            <td style="padding: 10px; text-align: right; font-weight: 700; color: #dc2626;">0d</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid #f1f5f9;">
                                            <td style="padding: 10px; color: #1e293b;">Embankment</td>
                                            <td style="padding: 10px; text-align: right; font-weight: 700; color: #dc2626;">0d</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid #f1f5f9;">
                                            <td style="padding: 10px; color: #1e293b;">Foundation Concrete</td>
                                            <td style="padding: 10px; text-align: right; font-weight: 700; color: #dc2626;">0d</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid #f1f5f9;">
                                            <td style="padding: 10px; color: #1e293b;">Box Construction</td>
                                            <td style="padding: 10px; text-align: right; font-weight: 700; color: #dc2626;">0d</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 10px; color: #1e293b;">Curing</td>
                                            <td style="padding: 10px; text-align: right; font-weight: 700; color: #dc2626;">0d</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Export Options</h4>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <button class="btn-v7" onclick="showToast('üìÑ PDF export ‚Äî Coming in V7.0', 'info')" style="padding: 16px; background: #fef2f2; border: 2px solid #fecaca; border-radius: 8px; cursor: not-allowed; transition: all 0.2s; text-align: left; opacity:0.65;" title="Coming in V7.0">
                                        <div style="font-size: 1.5rem; margin-bottom: 8px;">üìÑ</div>
                                        <div style="font-weight: 600; font-size: 0.875rem; color: #1e293b;">Export to PDF</div>
                                        <div style="font-size: 0.75rem; color: #64748b;">Printable format</div>
                                    </button>
                                    
                                    <button class="btn-v7" onclick="showToast('üìä Excel export ‚Äî Coming in V7.0', 'info')" style="padding: 16px; background: #f0fdf4; border: 2px solid #bbf7d0; border-radius: 8px; cursor: not-allowed; transition: all 0.2s; text-align: left; opacity:0.65;" title="Coming in V7.0">
                                        <div style="font-size: 1.5rem; margin-bottom: 8px;">üìä</div>
                                        <div style="font-weight: 600; font-size: 0.875rem; color: #1e293b;">Export to Excel</div>
                                        <div style="font-size: 0.75rem; color: #64748b;">Editable data</div>
                                    </button>
                                    
                                    <button class="btn-v7" onclick="showToast('üìß Email report ‚Äî Coming in V7.0', 'info')" style="padding: 16px; background: #eff6ff; border: 2px solid #bfdbfe; border-radius: 8px; cursor: not-allowed; transition: all 0.2s; text-align: left; opacity:0.65;" title="Coming in V7.0">
                                        <div style="font-size: 1.5rem; margin-bottom: 8px;">üìß</div>
                                        <div style="font-weight: 600; font-size: 0.875rem; color: #1e293b;">Email Report</div>
                                        <div style="font-size: 0.75rem; color: #64748b;">Send to stakeholders</div>
                                    </button>
                                    
                                    <button onclick="window.print()" style="padding: 16px; background: #fafafa; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: left;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#fafafa'">
                                        <div style="font-size: 1.5rem; margin-bottom: 8px;">üñ®Ô∏è</div>
                                        <div style="font-weight: 600; font-size: 0.875rem; color: #1e293b;">Print Report</div>
                                        <div style="font-size: 0.75rem; color: #64748b;">Direct print</div>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                 TAB 11: BOQ & FINANCIALS
                 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="tab-panel" id="tab11">
                <div class="content-container">

                    <!-- TOP ACTION BAR -->
                    <div class="section" style="margin-bottom:12px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;">
                            <div>
                                <div class="section-header" style="margin-bottom:4px;">üìã BOQ & Financials</div>
                                <div style="font-size:0.78rem;color:var(--text-secondary);">
                                    Define BOQ sections chainage-wise. BOQ items drive productivity tracking. 
                                    Linear items drive financial progress.
                                </div>
                            </div>
                            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                                <button class="btn-secondary" onclick="boqAddSection()" style="background:var(--accent-gold);color:#1B3B6F;font-weight:700;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">
                                    + Add Road Section
                                </button>
                                <button class="btn-secondary" onclick="boqAddStructureBOQ()" style="background:#1B3B6F;color:#fff;border:1px solid var(--accent-gold);padding:8px 16px;border-radius:6px;cursor:pointer;">
                                    üåâ Add Structure BOQ
                                </button>
                                <button onclick="boqGenerateWBS()" id="btnGenerateWBS" style="background:linear-gradient(135deg,#16a34a,#15803d);color:#fff;font-weight:700;border:none;padding:8px 18px;border-radius:6px;cursor:pointer;font-size:0.85rem;" title="Generate WBS & Activities from BOQ">
                                    ‚ö° Generate WBS & Schedule
                                </button>
                            </div>
                        </div>

                        <!-- BOQ SUMMARY BAR -->
                        <div id="boqSummaryBar" style="display:none;margin-top:12px;display:flex;gap:16px;flex-wrap:wrap;background:var(--bg-surface);border:1px solid var(--border-light);border-radius:8px;padding:10px 16px;">
                            <div style="text-align:center;">
                                <div style="font-size:1.1rem;font-weight:700;color:var(--navy);" id="boqTotalValue">‚Çπ0.00 Cr</div>
                                <div style="font-size:0.7rem;color:var(--text-secondary);">Total BOQ Value</div>
                            </div>
                            <div style="width:1px;background:var(--border-light);"></div>
                            <div style="text-align:center;">
                                <div style="font-size:1.1rem;font-weight:700;color:#16a34a;" id="boqEarnedValue">‚Çπ0.00 Cr</div>
                                <div style="font-size:0.7rem;color:var(--text-secondary);">Earned to Date</div>
                            </div>
                            <div style="width:1px;background:var(--border-light);"></div>
                            <div style="text-align:center;">
                                <div style="font-size:1.1rem;font-weight:700;color:var(--accent-gold);" id="boqFinancialPct">0.0%</div>
                                <div style="font-size:0.7rem;color:var(--text-secondary);">Financial Progress</div>
                            </div>
                            <div style="width:1px;background:var(--border-light);"></div>
                            <div style="text-align:center;">
                                <div style="font-size:1.1rem;font-weight:700;color:#dc2626;" id="boqBlockedValue">‚Çπ0.00 L</div>
                                <div style="font-size:0.7rem;color:var(--text-secondary);">Blocked by Hindrances</div>
                            </div>
                            <div style="width:1px;background:var(--border-light);"></div>
                            <div style="text-align:center;">
                                <div style="font-size:1.1rem;font-weight:700;color:#7c3aed;" id="boqDeviationCount">0</div>
                                <div style="font-size:0.7rem;color:var(--text-secondary);">Deviation Alerts</div>
                            </div>
                        </div>
                    </div>

                    <!-- BOQ SECTIONS LIST -->
                    <div id="boqSectionsList"></div>

                    <!-- EMPTY STATE -->
                    <div id="boqEmptyState" style="text-align:center;padding:60px 20px;color:var(--text-secondary);">
                        <div style="font-size:3rem;margin-bottom:12px;">üìã</div>
                        <div style="font-size:1rem;font-weight:600;margin-bottom:8px;color:var(--navy);">No BOQ sections defined yet</div>
                        <div style="font-size:0.82rem;margin-bottom:20px;">
                            Add road work sections chainage-wise, then add items.<br>
                            After all sections are complete, generate WBS & Schedule automatically.
                        </div>
                        <button onclick="boqAddSection()" style="background:var(--accent-gold);color:#1B3B6F;font-weight:700;border:none;padding:10px 24px;border-radius:6px;cursor:pointer;font-size:0.9rem;">
                            + Add First Section
                        </button>
                    </div>

                </div>
            </div><!-- end tab11 BOQ -->

    </div><!-- end main-content -->
    </div><!-- end app-container -->

    <script>
        // TAB 7: Activity Grid Functions - OPC Style
        
        // ===== VIEW MODE SWITCHING =====
        function switchViewMode(mode) {
            const tableSection = document.getElementById('activityTableSection');
            const chartSection = document.getElementById('chartSection');
            const ganttChart = document.getElementById('ganttChart');
            const linearChart = document.getElementById('linearChart');
            
            // Remove active state from all buttons
            document.querySelectorAll('.view-mode-btn').forEach(btn => btn.classList.remove('active'));
            
            // Reset displays
            tableSection.classList.remove('split-mode');
            chartSection.classList.remove('visible', 'full-width');
            ganttChart.style.display = 'none';
            linearChart.style.display = 'none';
            
            if (mode === 'full') {
                // Full Screen - Table only
                document.getElementById('viewBtnFull').classList.add('active');
                tableSection.style.display = 'flex';
                chartSection.style.display = 'none';
                
            } else if (mode === 'gantt') {
                // Table + Gantt (60/40 split)
                document.getElementById('viewBtnGantt').classList.add('active');
                tableSection.classList.add('split-mode');
                tableSection.style.display = 'flex';
                chartSection.classList.add('visible');
                chartSection.style.display = 'flex';
                ganttChart.style.display = 'flex';
                
            } else if (mode === 'linear') {
                // Table + Linear (60/40 split)
                document.getElementById('viewBtnLinear').classList.add('active');
                tableSection.classList.add('split-mode');
                tableSection.style.display = 'flex';
                chartSection.classList.add('visible');
                chartSection.style.display = 'flex';
                linearChart.style.display = 'flex';
                
            } else if (mode === 'ganttOnly') {
                // Gantt Only - Full width
                document.getElementById('viewBtnGanttOnly').classList.add('active');
                tableSection.style.display = 'none';
                chartSection.classList.add('visible', 'full-width');
                chartSection.style.display = 'flex';
                ganttChart.style.display = 'flex';
                
            } else if (mode === 'linearOnly') {
                // Linear Only - Full width
                document.getElementById('viewBtnLinearOnly').classList.add('active');
                tableSection.style.display = 'none';
                chartSection.classList.add('visible', 'full-width');
                chartSection.style.display = 'flex';
                linearChart.style.display = 'flex';
            }
        }
        
        // ===== ROW EXPAND/COLLAPSE =====
        function toggleRow(toggleElement) {
            const row = toggleElement.closest('tr');
            const rowId = row.dataset.id;
            const isExpanded = toggleElement.textContent === '‚ñº';
            
            // Toggle icon
            toggleElement.textContent = isExpanded ? '‚ñ∂' : '‚ñº';
            
            // Toggle children visibility
            const children = document.querySelectorAll(`tr[data-parent="${rowId}"]`);
            children.forEach(child => {
                if (isExpanded) {
                    child.style.display = 'none';
                    // Also collapse grandchildren
                    const childToggle = child.querySelector('.tree-toggle');
                    if (childToggle && childToggle.textContent === '‚ñº') {
                        childToggle.click();
                    }
                } else {
                    child.style.display = '';
                }
            });
        }
        
        function expandAllRows() {
            document.querySelectorAll('.tree-toggle').forEach(toggle => {
                if (toggle.textContent === '‚ñ∂') {
                    toggle.textContent = '‚ñº';
                }
            });
            document.querySelectorAll('#activityTableBody tr').forEach(row => {
                row.style.display = '';
            });
        }
        
        function collapseAllRows() {
            document.querySelectorAll('.tree-toggle').forEach(toggle => {
                if (toggle.textContent === '‚ñº') {
                    toggle.textContent = '‚ñ∂';
                }
            });
            // Hide all child rows (level 1 and 2)
            document.querySelectorAll('#activityTableBody tr[data-level="1"], #activityTableBody tr[data-level="2"]').forEach(row => {
                row.style.display = 'none';
            });
        }
        
        // ===== ROW SELECTION =====
        function selectRow(row) {
            // Remove previous selection
            document.querySelectorAll('#activityTableBody tr').forEach(r => {
                r.classList.remove('selected');
            });
            // Add selection to clicked row
            row.classList.add('selected');
            
            const activityId = row.dataset.id;
            console.log('Selected activity:', activityId);
            
            // TODO: Show activity detail panel
            // showActivityDetail(activityId);
        }
        
        // ===== ADD WBS/ACTIVITY MODAL (2-Step) =====
        let addModalStep = 1;
        let addModalType = null;
        
        function showAddModal() {
            addModalStep = 1;
            addModalType = null;
            
            const modalHTML = `
                <div id="addModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-width: 500px; width: 90%;">
                        <div style="padding: 20px 24px; border-bottom: 1px solid #e5e7eb;">
                            <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600; color: #111827;">Add to Activity Grid</h3>
                        </div>
                        
                        <div id="modalContent" style="padding: 24px;">
                            <div style="margin-bottom: 20px; font-size: 0.875rem; color: #6b7280;">
                                What do you want to add?
                            </div>
                            
                            <label style="display: flex; align-items: flex-start; padding: 16px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; margin-bottom: 12px; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#3b82f6';" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb';" onclick="selectAddType('wbs')">
                                <input type="radio" name="addType" value="wbs" style="margin-top: 2px; margin-right: 12px;">
                                <div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; margin-bottom: 4px;">WBS Level (Group)</div>
                                    <div style="font-size: 0.8125rem; color: #6b7280;">Add a phase, stretch, or section to organize activities</div>
                                </div>
                            </label>
                            
                            <label style="display: flex; align-items: flex-start; padding: 16px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#3b82f6';" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb';" onclick="selectAddType('activity')">
                                <input type="radio" name="addType" value="activity" style="margin-top: 2px; margin-right: 12px;">
                                <div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; margin-bottom: 4px;">Activity (Work Item)</div>
                                    <div style="font-size: 0.8125rem; color: #6b7280;">Add an actual work task with resources and duration</div>
                                </div>
                            </label>
                        </div>
                        
                        <div style="padding: 16px 24px; background: #f9fafb; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 12px; border-radius: 0 0 8px 8px;">
                            <button onclick="closeAddModal()" style="padding: 8px 16px; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">Cancel</button>
                            <button id="modalNextBtn" onclick="addModalNext()" disabled style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500; opacity: 0.5;">Next ‚Üí</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function selectAddType(type) {
            addModalType = type;
            document.getElementById('modalNextBtn').disabled = false;
            document.getElementById('modalNextBtn').style.opacity = '1';
        }
        
        function addModalNext() {
            if (addModalStep === 1 && addModalType) {
                addModalStep = 2;
                showAddModalStep2();
            }
        }
        
        function showAddModalStep2() {
            const modalContent = document.getElementById('modalContent');
            
            if (addModalType === 'wbs') {
                modalContent.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 6px;">Parent WBS</label>
                        <select style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
                            <option value="">Root Level</option>
                            <option value="1.0">1.0 - PHASE 1 - IMMEDIATE WORK</option>
                            <option value="2.0">2.0 - STRUCTURES (Parallel)</option>
                            <option value="3.0">3.0 - PHASE 3 - HINDRANCE DEPENDENT</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 6px;">WBS Code</label>
                        <input type="text" placeholder="e.g., 1.3" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;" disabled value="Auto-generated">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 6px;">WBS Name <span style="color: #ef4444;">*</span></label>
                        <input type="text" placeholder="e.g., Stretch 3" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 8px;">Type</label>
                        <div style="display: flex; gap: 12px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="wbsType" value="phase" checked style="margin-right: 6px;">
                                <span style="font-size: 0.875rem;">Phase</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="wbsType" value="stretch" style="margin-right: 6px;">
                                <span style="font-size: 0.875rem;">Stretch</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="wbsType" value="section" style="margin-right: 6px;">
                                <span style="font-size: 0.875rem;">Section</span>
                            </label>
                        </div>
                    </div>
                `;
            } else {
                // Activity form
                modalContent.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 6px;">Parent WBS <span style="color: #ef4444;">*</span></label>
                        <select style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
                            <option value="">Select parent...</option>
                            <option value="1.1">1.1 - Stretch 1</option>
                            <option value="1.2">1.2 - Stretch 2</option>
                            <option value="2.1">2.1 - Box Culvert Ch 2+450</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 6px;">Activity Name <span style="color: #ef4444;">*</span></label>
                        <input type="text" placeholder="e.g., WMM Paving" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 6px;">Quantity</label>
                            <input type="number" placeholder="0" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 6px;">Unit</label>
                            <select style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
                                <option>Cum</option>
                                <option>Sqm</option>
                                <option>RM</option>
                                <option>MT</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 6px;">Resource (from Tab 6)</label>
                        <select style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
                            <option value="">Select resource...</option>
                            <option>Excavator</option>
                            <option>Grader</option>
                            <option>Paver</option>
                            <option>Roller</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 8px;">Duration Calculation</label>
                        <div style="display: flex; gap: 12px; margin-bottom: 8px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="durationType" value="auto" checked style="margin-right: 6px;">
                                <span style="font-size: 0.875rem;">Auto-calculate from productivity</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="durationType" value="manual" style="margin-right: 6px;">
                                <span style="font-size: 0.875rem;">Manual</span>
                            </label>
                        </div>
                        <input type="number" placeholder="Days" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;" disabled>
                    </div>
                `;
            }
            
            // Update footer buttons
            const modalFooter = document.querySelector('#addModal > div > div:last-child');
            modalFooter.innerHTML = `
                <button onclick="addModalBack()" style="padding: 8px 16px; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">‚Üê Back</button>
                <button onclick="closeAddModal()" style="padding: 8px 16px; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">Cancel</button>
                <button onclick="submitAdd()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">Add ${addModalType === 'wbs' ? 'WBS' : 'Activity'}</button>
            `;
        }
        
        function addModalBack() {
            addModalStep = 1;
            showAddModal();
            closeAddModal();
            showAddModal();
        }
        
        function submitAdd() {
            showToast('‚úÖ Item will be added to WBS', 'success');
            closeAddModal();
        }
        
        function closeAddModal() {
            const modal = document.getElementById('addModal');
            if (modal) modal.remove();
        }
        
        // ===== OTHER FUNCTIONS =====
        function generateWBS() {
            KALYANTRA.refresh();
            KALYANTRA.render.wbsTable();
            updateWBSStatBar();
            showToast('‚úÖ WBS generated from current project data', 'success');
        }
        function showColumnsPanel() {
            showToast('üìä Column configuration coming in V7.0', 'info');
        }
        
    </script>

    <script>
        // Main tab switching
        function switchMainTab(index) {
            if (index === 4) setTimeout(() => { // FIX-GAP04
                if (typeof renderWorkingDaysSelector === 'function') renderWorkingDaysSelector();
                if (typeof renderHolidayTable === 'function') renderHolidayTable();
            }, 100);
            const tabs = document.querySelectorAll('.main-tab');
            const panels = document.querySelectorAll('.tab-panel');
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                    panels[i].classList.add('active');
                } else {
                    tab.classList.remove('active');
                    panels[i].classList.remove('active');
                }
            });
        }
        
        // Resource selection and detail generation
        function selectResource(row, index) {
            // Highlight selected row
            const allRows = document.querySelectorAll('#resourceTable tr');
            allRows.forEach(r => r.style.background = '');
            row.style.background = 'rgba(59, 130, 246, 0.05)';
            
            // Generate detail content
            document.getElementById('resourceDetailContent').innerHTML = generateResourceDetails(index);
        }
        
        function generateResourceDetails(index) {
            const resources = [
                { type: 'Excavator', capacity: '1.6 Cum bucket', color: '#1e40af' },
                { type: 'Motor Grader', capacity: 'CAT 140 / 12ft blade', color: '#059669' },
                { type: 'Sensor Paver', capacity: 'AP615 / 6m width', color: '#dc2626' }
            ];
            const resource = resources[index];
            
            return `
                <div style="border-bottom: 3px solid ${resource.color}; padding-bottom: 15px; margin-bottom: 20px;">
                    <div style="font-size: 1.3rem; font-weight: 700; color: ${resource.color};">${resource.type}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">${resource.capacity}</div>
                </div>
                
                <div class="component-section">
                    <div class="component-header" style="background: rgba(59, 130, 246, 0.05);">1. CAPACITY & SPECIFICATIONS</div>
                    <div class="form-group">
                        <label class="form-label">Standard Capacity</label>
                        <input type="text" class="form-input" value="${resource.capacity}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" rows="2" placeholder="Additional specifications"></textarea>
                    </div>
                </div>
                
                <div class="component-section" style="background: rgba(212, 175, 55, 0.05); border-left: 4px solid var(--accent-gold);">
                    <div class="component-header">2. PRODUCTIVITY RATES ‚≠ê (Activity-Based)</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;">
                        Define output rates for different activities. System uses these in Tab 7 for duration calculation.
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-success btn-sm" onclick="addProductivityRate()">+ Add Activity Rate</button>
                    </div>
                    
                    <div id="productivityRatesList">
                        <div style="background: white; border: 1px solid var(--border-light); border-radius: 4px; padding: 12px; margin-bottom: 8px;">
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 8px; align-items: center;">
                                <div>
                                    <select class="form-select" style="font-size: 0.85rem;">
                                        <option>Soil Excavation</option>
                                        <option>Ordinary Rock</option>
                                        <option>Hard Rock</option>
                                    </select>
                                </div>
                                <div>
                                    <input type="number" class="form-input" value="62.71" step="0.01" style="font-size: 0.85rem;">
                                </div>
                                <div>
                                    <select class="form-select" style="font-size: 0.85rem;">
                                        <option>Cum/Hr</option>
                                        <option>Sqm/Hr</option>
                                        <option>TPH</option>
                                    </select>
                                </div>
                                <div>
                                    <button class="btn btn-secondary btn-sm" style="padding: 4px 8px; font-size: 0.75rem;">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="component-section" style="background: rgba(139, 92, 246, 0.05); border-left: 4px solid #8b5cf6;">
                    <div class="component-header">3. OUTPUT CALCULATION (Per Day)</div>
                    <div style="background: white; border-radius: 6px; padding: 15px; border: 1px solid var(--border-light);">
                        <div style="font-size: 0.85rem; margin-bottom: 12px;">
                            <strong>Calculation Logic:</strong> Output/Day = Productivity Rate √ó Working Hours
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Productivity Rate</div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: #3b82f6;">62.71</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">Cum/Hr</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Working Hours</div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: #8b5cf6;">8</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">hrs/day (Tab 5)</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Output per Day</div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: #22c55e;">501.68</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">Cum/day</div>
                            </div>
                        </div>
                        <div style="padding: 10px; background: rgba(34, 197, 94, 0.05); border-radius: 4px; font-size: 0.8rem; border-left: 3px solid #22c55e;">
                            <strong>Example:</strong> 1 Excavator working 8 hours = 501.68 Cum/day<br>
                            For 5,000 Cum job: Need 5,000 / 501.68 = <strong>10 days</strong> (with 1 unit)
                        </div>
                    </div>
                </div>
                
                <div class="component-section" style="background: rgba(34, 197, 94, 0.05); border-left: 4px solid #22c55e;">
                    <div class="component-header">4. CALENDAR MAPPING</div>
                    <div style="background: white; border-radius: 6px; padding: 15px; border: 1px solid var(--border-light);">
                        <div style="font-size: 0.85rem; margin-bottom: 12px;">
                            <strong>Linked to Tab 5 (Calendar):</strong>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="padding: 10px; background: rgba(59, 130, 246, 0.05); border-radius: 4px;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Working Days/Week</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #3b82f6;">6 days</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">Mon-Sat (from Calendar)</div>
                            </div>
                            <div style="padding: 10px; background: rgba(239, 68, 68, 0.05); border-radius: 4px;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Monsoon Impact</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #ef4444;">32 days</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">No work period</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: rgba(251, 191, 36, 0.05); border-radius: 4px; font-size: 0.8rem; border-left: 3px solid #f59e0b;">
                            <strong>üí° Smart Calculation:</strong> Activity Grid (Tab 7) automatically accounts for weekends, holidays, and monsoon when calculating completion dates
                        </div>
                    </div>
                </div>
                
                <div class="component-section">
                    <div class="component-header">5. REQUIREMENT (From Activity Grid)</div>
                    <div style="background: white; border-radius: 6px; padding: 15px; border: 1px solid var(--border-light);">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;">
                            After activities are defined in Tab 7, requirements will be calculated automatically:
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="text-align: center; padding: 15px; background: rgba(59, 130, 246, 0.05); border-radius: 6px;">
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px;">Peak Demand</div>
                                <div style="font-size: 2rem; font-weight: 700; color: #3b82f6;">-</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 3px;">Max units at any time</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(139, 92, 246, 0.05); border-radius: 6px;">
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px;">Total Equipment-Days</div>
                                <div style="font-size: 2rem; font-weight: 700; color: #8b5cf6;">-</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 3px;">Total utilization</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" style="width: 100%; margin-top: 20px;">Save Resource Type</button>
            `;
        }
        
        // Resource sub-tab switching
        function switchResourceTab(index) {
            const tabs = document.querySelectorAll('#tab6 .detail-tab');
            const subtabs = document.querySelectorAll('.resource-subtab');
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                    subtabs[i].style.display = 'block';
                } else {
                    tab.classList.remove('active');
                    subtabs[i].style.display = 'none';
                }
            });
        }
        
        // Equipment-specific activity mapping (SMART FILTERING!)
        const equipmentActivities = {
            0: [ // Excavator
                { code: 'EXCV-SOIL', name: 'Soil Excavation', rate: 62.71, unit: 'Cum/Hr' },
                { code: 'EXCV-OR', name: 'Ordinary Rock', rate: 20.90, unit: 'Cum/Hr' },
                { code: 'EXCV-HR', name: 'Hard Rock', rate: 15.68, unit: 'Cum/Hr' }
            ],
            1: [ // Motor Grader
                { code: 'GRADER-EMB', name: 'Embankment Grading', rate: 130.89, unit: 'Cum/Hr' },
                { code: 'GRADER-SG', name: 'Subgrade Grading', rate: 130.89, unit: 'Cum/Hr' },
                { code: 'GRADER-GSB', name: 'GSB Grading', rate: 76.99, unit: 'Cum/Hr' },
                { code: 'GRADER-WMM', name: 'WMM Grading', rate: 48.12, unit: 'Cum/Hr' }
            ],
            2: [ // Sensor Paver
                { code: 'PAVER-WMM', name: 'WMM Paving', rate: 96, unit: 'Cum/Hr' },
                { code: 'PAVER-BM', name: 'BM Paving', rate: 42, unit: 'Cum/Hr' },
                { code: 'PAVER-DBM', name: 'DBM Paving', rate: 42, unit: 'Cum/Hr' },
                { code: 'PAVER-BC', name: 'BC Paving', rate: 30, unit: 'Cum/Hr' }
            ],
            3: [ // Vibratory Roller
                { code: 'VIBRO-EMB', name: 'Embankment Compaction', rate: 143.78, unit: 'Cum/Hr' },
                { code: 'VIBRO-SG', name: 'Subgrade Compaction', rate: 143.78, unit: 'Cum/Hr' },
                { code: 'VIBRO-GSB', name: 'GSB Compaction', rate: 95.85, unit: 'Cum/Hr' },
                { code: 'VIBRO-WMM', name: 'WMM Compaction', rate: 48.12, unit: 'Cum/Hr' },
                { code: 'VIBRO-SHLD', name: 'Shoulders Compaction', rate: 143.78, unit: 'Cum/Hr' }
            ],
            4: [ // Tipper
                { code: 'TIPP10-EMBRW', name: 'Embankment Hauling (RW)', rate: 18.36, unit: 'Cum/Hr' },
                { code: 'TIPP10-EMBBR', name: 'Embankment Hauling (Borrow)', rate: 6.57, unit: 'Cum/Hr' },
                { code: 'TIPP10-GSB', name: 'GSB Hauling', rate: 4.19, unit: 'Cum/Hr' },
                { code: 'TIPP10-WMM', name: 'WMM Hauling', rate: 4.07, unit: 'Cum/Hr' },
                { code: 'TIPP10-BC', name: 'Bituminous Hauling', rate: 4.03, unit: 'Cum/Hr' }
            ]
        };
        
        // Equipment selection and detail generation
        function selectEquipment(row, index) {
            const allRows = document.querySelectorAll('#equipmentTable tr');
            allRows.forEach(r => r.style.background = '');
            row.style.background = 'rgba(59, 130, 246, 0.05)';
            
            document.getElementById('equipmentDetailContent').innerHTML = generateEquipmentDetails(index);
        }
        
        function generateEquipmentDetails(index) {
            // U-12: Look up real equipment from data model if available
            const realEquip = KALYANTRA.data.resources.equipment[index] || {};
            const equipment = [
                { type: 'Excavator', capacity: '1.6 Cum bucket', color: '#1e40af' },
                { type: 'Motor Grader', capacity: 'CAT 140 / 12ft blade', color: '#059669' },
                { type: 'Sensor Paver', capacity: 'AP615 / 6m width', color: '#dc2626' },
                { type: 'Vibratory Roller', capacity: '10-12 Ton', color: '#7c3aed' },
                { type: 'Tipper', capacity: '10 Ton', color: '#ea580c' }
            ][index];
            
            const activities = equipmentActivities[index] || [];
            const activityDropdown = activities.map(a => 
                `<option value="${a.code}" data-rate="${a.rate}" data-unit="${a.unit}">${a.name}</option>`
            ).join('');
            
            const firstActivity = activities[0] || { rate: 0, unit: 'Cum/Hr' };
            const outputPerDay = (firstActivity.rate * 8).toFixed(2);
            
            return `
                <div style="border-bottom: 3px solid ${equipment.color}; padding-bottom: 15px; margin-bottom: 20px;">
                    <div style="font-size: 1.3rem; font-weight: 700; color: ${equipment.color};">${equipment.type}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">${equipment.capacity}</div>
                </div>
                
                <div class="component-section">
                    <div class="component-header" style="background: rgba(59, 130, 246, 0.05);">1. CAPACITY</div>
                    <div class="form-group">
                        <label class="form-label">Standard Capacity</label>
                        <input type="text" class="form-input" value="${equipment.capacity}" style="font-size: 0.9rem;">
                    </div>
                </div>
                
                <div class="component-section" style="background: rgba(212, 175, 55, 0.05); border-left: 4px solid var(--accent-gold);">
                    <div class="component-header">2. PRODUCTIVITY RATES ‚≠ê</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 12px;">
                        Only ${equipment.type}-specific activities shown
                    </div>
                    
                    <div id="activityRatesList-${index}">
                        <div style="background: white; border: 1px solid var(--border-light); border-radius: 4px; padding: 10px; margin-bottom: 10px;">
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 8px;">
                                <select class="form-select activity-dropdown" style="font-size: 0.85rem;" onchange="updateActivityRate(this)">
                                    ${activityDropdown}
                                </select>
                                <input type="number" class="form-input rate-input" value="${firstActivity.rate}" step="0.01" style="font-size: 0.85rem;">
                                <select class="form-select unit-select" style="font-size: 0.85rem;">
                                    <option>${firstActivity.unit}</option>
                                </select>
                                <button class="btn btn-secondary btn-sm" onclick="this.parentElement.parentElement.remove()" style="padding: 4px 8px; font-size: 0.75rem;">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-success btn-sm" style="font-size: 0.8rem;" onclick="addActivityRate(${index})">+ Add Activity</button>
                </div>
                
                <div class="component-section" style="background: rgba(139, 92, 246, 0.05);">
                    <div class="component-header">3. OUTPUT/DAY</div>
                    <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid var(--border-light);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">Rate</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #3b82f6;">${firstActivity.rate}</div>
                                <div style="font-size: 0.65rem;">${firstActivity.unit}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">Hours</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #8b5cf6;">8</div>
                                <div style="font-size: 0.65rem;">hrs/day</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">Output</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #22c55e;">${outputPerDay}</div>
                                <div style="font-size: 0.65rem;">Cum/day</div>
                            </div>
                        </div>
                        <div style="padding: 8px; background: rgba(34, 197, 94, 0.05); border-radius: 4px; font-size: 0.75rem;">
                            <strong>Example:</strong> 5,000 Cum job = ${(5000 / parseFloat(outputPerDay)).toFixed(1)} days (1 unit)
                        </div>
                    </div>
                </div>
                
                <div class="component-section" style="background: rgba(34, 197, 94, 0.05);">
                    <div class="component-header">4. CALENDAR MAPPING ‚≠ê</div>
                    <div class="form-group">
                        <label class="form-label">Select Calendar for this Equipment</label>
                        <select class="form-select" style="font-size: 0.9rem;">
                            <option value="main">Main Project Calendar (6 days/week, 8 hrs/day)</option>
                            <option value="247">24√ó7 Calendar (Crusher/Batching Plant)</option>
                            <option value="2shift">2-Shift Calendar (Mon-Sun, 16 hrs/day)</option>
                            <option value="custom">Custom Calendar</option>
                        </select>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;">
                            üí° Different equipment can work different schedules
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div style="padding: 10px; background: white; border-radius: 4px; text-align: center;">
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">Working Days</div>
                            <div style="font-size: 1.2rem; font-weight: 700; color: #3b82f6;">6/week</div>
                        </div>
                        <div style="padding: 10px; background: white; border-radius: 4px; text-align: center;">
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">Monsoon</div>
                            <div style="font-size: 1.2rem; font-weight: 700; color: #ef4444;">32 days</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" style="width: 100%; margin-top: 15px; font-size: 0.9rem;">Save Equipment</button>
            `;
        }
        
        function updateActivityRate(select) {
            const option = select.options[select.selectedIndex];
            const rate = option.dataset.rate;
            const unit = option.dataset.unit;
            const rateInput = select.parentElement.querySelector('.rate-input');
            const unitSelect = select.parentElement.querySelector('.unit-select');
            if (rateInput) rateInput.value = rate;
            if (unitSelect) unitSelect.value = unit;
        }
        
        // Add new activity rate row
        // FIX-SEC6: addProductivityRate was called but never defined
        function addProductivityRate() { addActivityRate(null); }

        function addActivityRate(equipmentIndex) {
            const container = document.getElementById(`activityRatesList-${equipmentIndex}`);
            const activities = equipmentActivities[equipmentIndex] || [];
            const activityDropdown = activities.map(a => 
                `<option value="${a.code}" data-rate="${a.rate}" data-unit="${a.unit}">${a.name}</option>`
            ).join('');
            
            const newRow = document.createElement('div');
            newRow.style.cssText = 'background: white; border: 1px solid var(--border-light); border-radius: 4px; padding: 10px; margin-bottom: 10px;';
            newRow.innerHTML = `
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 8px;">
                    <select class="form-select activity-dropdown" style="font-size: 0.85rem;" onchange="updateActivityRate(this)">
                        ${activityDropdown}
                    </select>
                    <input type="number" class="form-input rate-input" value="${activities[0]?.rate || 0}" step="0.01" style="font-size: 0.85rem;">
                    <select class="form-select unit-select" style="font-size: 0.85rem;">
                        <option>${activities[0]?.unit || 'Cum/Hr'}</option>
                    </select>
                    <button class="btn btn-secondary btn-sm" onclick="this.parentElement.parentElement.remove()" style="padding: 4px 8px; font-size: 0.75rem;">üóëÔ∏è</button>
                </div>
            `;
            container.appendChild(newRow);
        }
        
        // Manpower functions
        function selectManpower(row, index) {
            const allRows = document.querySelectorAll('#manpowerTable tr');
            allRows.forEach(r => r.style.background = '');
            row.style.background = 'rgba(59, 130, 246, 0.05)';
            
            const labor = [
                { type: 'Mason', category: 'Skilled', color: '#1e40af', productivity: '10 Sqm/day' },
                { type: 'Steel Fixer', category: 'Skilled', color: '#059669', productivity: '50 Kg/day' },
                { type: 'Unskilled Labor', category: 'Unskilled', color: '#f59e0b', productivity: '5 Cum/day' }
            ][index];
            
            document.getElementById('manpowerDetailContent').innerHTML = `
                <div style="border-bottom: 3px solid ${labor.color}; padding-bottom: 15px; margin-bottom: 20px;">
                    <div style="font-size: 1.3rem; font-weight: 700; color: ${labor.color};">${labor.type}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">${labor.category}</div>
                </div>
                
                <div class="component-section" style="background: rgba(59, 130, 246, 0.05);">
                    <div class="component-header">1. LABOR CATEGORY</div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-select">
                            <option>Skilled</option>
                            <option>Semi-Skilled</option>
                            <option>Unskilled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Specialization (for Skilled)</label>
                        <input type="text" class="form-input" placeholder="e.g., Masonry, Steel Fixing, Carpentry">
                    </div>
                </div>
                
                <div class="component-section" style="background: rgba(212, 175, 55, 0.05); border-left: 4px solid var(--accent-gold);">
                    <div class="component-header">2. CALCULATION METHOD ‚≠ê</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;">
                        Choose how to calculate labor requirement:
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: start; gap: 10px; padding: 12px; background: white; border: 2px solid var(--border-light); border-radius: 6px; cursor: pointer;">
                            <input type="radio" name="laborCalc" value="activity" checked>
                            <div>
                                <div style="font-weight: 600; color: var(--primary-navy); margin-bottom: 5px;">
                                    üìã Activity-Based (User Selection)
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                    User manually selects required labor for each activity. System totals labor-days.
                                </div>
                                <div style="margin-top: 8px; padding: 8px; background: rgba(59, 130, 246, 0.05); border-radius: 4px; font-size: 0.75rem;">
                                    <strong>Example:</strong> Concrete Pour activity<br>
                                    User selects: 2 Mason + 4 Unskilled √ó 5 days = 30 labor-days
                                </div>
                            </div>
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: start; gap: 10px; padding: 12px; background: white; border: 2px solid var(--border-light); border-radius: 6px; cursor: pointer;">
                            <input type="radio" name="laborCalc" value="capacity">
                            <div>
                                <div style="font-weight: 600; color: var(--primary-navy); margin-bottom: 5px;">
                                    ‚öôÔ∏è Capacity-Based (System Calculation)
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                    Define labor productivity. System calculates required labor based on quantity.
                                </div>
                                <div style="margin-top: 8px; padding: 8px; background: rgba(139, 92, 246, 0.05); border-radius: 4px; font-size: 0.75rem;">
                                    <strong>Example:</strong> Mason productivity = 10 Sqm/day<br>
                                    Activity = 100 Sqm in 5 days ‚Üí Need 2 Masons
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="component-section" style="background: rgba(139, 92, 246, 0.05);">
                    <div class="component-header">3. PRODUCTIVITY (For Capacity-Based)</div>
                    <div class="form-group">
                        <label class="form-label">Standard Productivity</label>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                            <input type="number" class="form-input" value="${labor.productivity.split(' ')[0]}" step="0.1">
                            <select class="form-select">
                                <option>Sqm/day</option>
                                <option>Cum/day</option>
                                <option>Kg/day</option>
                                <option>MT/day</option>
                                <option>RM/day</option>
                            </select>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;">
                            Used when "Capacity-Based" method selected in Tab 7
                        </div>
                    </div>
                </div>
                
                <div class="component-section" style="background: rgba(34, 197, 94, 0.05);">
                    <div class="component-header">4. REQUIREMENT (From Tab 7)</div>
                    <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid var(--border-light);">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;">
                            Requirements calculated based on activities in Tab 7:
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="text-align: center; padding: 12px; background: rgba(59, 130, 246, 0.05); border-radius: 6px;">
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">Peak Demand</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">-</div>
                                <div style="font-size: 0.65rem; color: var(--text-secondary);">Max at any time</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(139, 92, 246, 0.05); border-radius: 6px;">
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">Total Labor-Days</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #8b5cf6;">-</div>
                                <div style="font-size: 0.65rem; color: var(--text-secondary);">Total required</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" style="width: 100%; margin-top: 15px; font-size: 0.9rem;">Save Labor Type</button>
            `;
        }
        
        // Material functions
        function selectMaterial(row, index) {
            const allRows = document.querySelectorAll('#materialTable tr');
            allRows.forEach(r => r.style.background = '');
            row.style.background = 'rgba(59, 130, 246, 0.05)';
            
            const material = [
                { type: 'Cement', unit: 'Bags / Tons', color: '#1e40af' },
                { type: 'Steel (TMT)', unit: 'Kg / Tons', color: '#dc2626' },
                { type: 'Aggregate 20mm', unit: 'Cum', color: '#6b7280' },
                { type: 'Bitumen VG30', unit: 'Tons', color: '#0891b2' }
            ][index];
            
            document.getElementById('materialDetailContent').innerHTML = `
                <div style="border-bottom: 3px solid ${material.color}; padding-bottom: 15px; margin-bottom: 20px;">
                    <div style="font-size: 1.3rem; font-weight: 700; color: ${material.color};">${material.type}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">${material.unit}</div>
                </div>
                
                <div class="component-section">
                    <div class="component-header">Material Info</div>
                    <div class="form-group">
                        <label class="form-label">Unit of Measurement</label>
                        <input type="text" class="form-input" value="${material.unit}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Requirement Source</label>
                        <select class="form-select">
                            <option>From Activity Grid (Tab 7)</option>
                            <option>Manual Entry</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn btn-primary" style="width: 100%; margin-top: 15px;">Save Material</button>
            `;
        }
        
        // Add functions
        function addPlantMachinery() {
            const table = document.getElementById('equipmentTable');
            const rowCount = table.rows.length + 1;
            const equipId = 'EQ-' + String(rowCount).padStart(3, '0');
            const newRow = table.insertRow();
            newRow.style.cursor = 'pointer';
            newRow.setAttribute('data-equip-id', equipId);
            newRow.onclick = function() { selectEquipment(this, rowCount - 1); };
            newRow.innerHTML = `
                <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                <td><strong>${rowCount}</strong></td>
                <td><strong style="color: #1B3B6F;">${equipId}</strong></td>
                <td><input type="text" class="form-input" placeholder="e.g. Excavator 21T" style="font-size: 0.85rem; padding: 4px;" onchange="updateEquipmentData(this, '${equipId}', 'type')"></td>
                <td><input type="text" class="form-input" placeholder="Capacity" style="font-size: 0.85rem; padding: 4px;" onchange="updateEquipmentData(this, '${equipId}', 'capacity')"></td>
                <td><input type="number" class="form-input" placeholder="1" min="1" style="font-size: 0.85rem; padding: 4px; width: 60px;" onchange="updateEquipmentData(this, '${equipId}', 'count')"></td>
                <td><span style="color: #f59e0b;">‚äô</span></td>
            `;
            // Add to KALYANTRA.data.resources
            KALYANTRA.data.resources.equipment.push({ id: equipId, type: 'New Equipment', capacity: '', count: 1 });
            selectEquipment(newRow, rowCount - 1);
            showToast('üöú Equipment added (' + KALYANTRA.data.resources.equipment.length + ' total)', 'success');
        }
        
        function updateEquipmentData(input, equipId, field) {
            const item = KALYANTRA.data.resources.equipment.find(e => e.id === equipId);
            if (item) {
                item[field] = field === 'count' ? parseInt(input.value) || 1 : input.value;
                console.log('üì¶ Equipment updated:', item);
            }
        }
        
        function addManpower() {
            const table = document.getElementById('manpowerTable') || document.querySelector('[id*="manpower"]');
            const roleId = 'MP-' + String(Date.now()).slice(-4);
            // Add to KALYANTRA.data.resources
            const newItem = { id: roleId, role: 'New Labor Type', count: 1, ratePerDay: 0 };
            KALYANTRA.data.resources.manpower.push(newItem);
            // Insert row into whatever manpower table exists
            if (table) {
                const newRow = table.insertRow ? table.insertRow() : null;
                if (newRow) {
                    newRow.innerHTML = `<td>${KALYANTRA.data.resources.manpower.length}</td>
                        <td><input type="text" class="form-input" placeholder="e.g. Operator, Mason" value="New Labor Type" 
                            onchange="KALYANTRA.data.resources.manpower[KALYANTRA.data.resources.manpower.length-1].role=this.value" style="font-size:0.85rem;padding:4px;"></td>
                        <td><input type="number" class="form-input" placeholder="1" value="1"
                            onchange="KALYANTRA.data.resources.manpower[KALYANTRA.data.resources.manpower.length-1].count=parseInt(this.value)||1" style="font-size:0.85rem;padding:4px;width:70px;"></td>
                        <td><input type="number" class="form-input" placeholder="Rate/day (‚Çπ)" value="0"
                            onchange="KALYANTRA.data.resources.manpower[KALYANTRA.data.resources.manpower.length-1].ratePerDay=parseFloat(this.value)||0" style="font-size:0.85rem;padding:4px;width:100px;"></td>
                        <td><button class="btn btn-sm" onclick="this.closest('tr').remove(); KALYANTRA.data.resources.manpower.pop();">‚úï</button></td>`;
                }
            }
            showToast('üë∑ Labor type added (' + KALYANTRA.data.resources.manpower.length + ' total)', 'success');
        }
        
        function addMaterial() {
            const matId = 'MAT-' + String(Date.now()).slice(-4);
            const newItem = { id: matId, name: 'New Material', unit: 'Cum', rate: 0 };
            KALYANTRA.data.resources.materials.push(newItem);
            const table = document.getElementById('materialTable') || document.querySelector('[id*="material"]');
            if (table) {
                const tbody = table.querySelector('tbody') || table;
                const newRow = tbody.insertRow ? tbody.insertRow() : null;
                if (newRow) {
                    const idx = KALYANTRA.data.resources.materials.length - 1;
                    newRow.innerHTML = `<td>${KALYANTRA.data.resources.materials.length}</td>
                        <td><input type="text" class="form-input" placeholder="Material name" value="New Material"
                            onchange="KALYANTRA.data.resources.materials[${idx}].name=this.value" style="font-size:0.85rem;padding:4px;"></td>
                        <td><select class="form-select" style="font-size:0.85rem;padding:4px;"
                            onchange="KALYANTRA.data.resources.materials[${idx}].unit=this.value">
                            <option>Cum</option><option>MT</option><option>Sqm</option><option>Rmt</option><option>Nos</option></select></td>
                        <td><input type="number" class="form-input" placeholder="Rate/unit ‚Çπ" value="0"
                            onchange="KALYANTRA.data.resources.materials[${idx}].rate=parseFloat(this.value)||0" style="font-size:0.85rem;padding:4px;width:100px;"></td>
                        <td><button class="btn btn-sm" onclick="this.closest('tr').remove(); KALYANTRA.data.resources.materials.splice(${idx},1);">‚úï</button></td>`;
                }
            }
            showToast('üß± Material added (' + KALYANTRA.data.resources.materials.length + ' total)', 'success');
        }
        
        // Detail tab switching (for Tab 3)
        function switchDetailTab(index) {
            const tabs = document.querySelectorAll('.detail-tab');
            const contents = document.querySelectorAll('.detail-tab-content');
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                    if (contents[i]) contents[i].classList.add('active');
                } else {
                    tab.classList.remove('active');
                    if (contents[i]) contents[i].classList.remove('active');
                }
            });
        }
        
        // Tab 1 Functions
        function calculateLength() {
            const startKm = parseInt(document.getElementById('startKm').value || 0);
            const startM = parseInt(document.getElementById('startM').value || 0);
            const endKm = parseInt(document.getElementById('endKm').value || 0);
            const endM = parseInt(document.getElementById('endM').value || 0);
            const totalKm = (endKm + endM/1000) - (startKm + startM/1000);
            document.getElementById('totalLength').value = totalKm.toFixed(3) + ' km';
        }
        
        function calculateCompletion() {
            const appointed = document.getElementById('appointedDate').value;
            const duration = document.getElementById('duration').value;
            if (appointed && duration) {
                const date = new Date(appointed);
                date.setMonth(date.getMonth() + parseInt(duration));
                // L-02 / U-06: Also write to data model
                const durMonths = parseInt(duration) || 0;
                if (durMonths > 0) {
                    KALYANTRA.data.project.duration = durMonths * 30; // approx working days
                    const endDateStr = date.toISOString().split('T')[0];
                    KALYANTRA.data.project.endDate = endDateStr;
                }
                document.getElementById('completionDate').value = date.toLocaleDateString('en-GB');
            }
            // Recalculate financial milestones when appointed date changes
            recalculateFinancialMilestones();
        }
        
        let physicalCount = 1;
        function addPhysicalMilestone() {
            physicalCount++;
            const tbody = document.getElementById('physicalMilestones');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${physicalCount}</td>
                <td><input type="date"></td>
                <td><input type="number" placeholder="50"></td>
                <td><input type="number" placeholder="12"></td>
                <td><input type="text" placeholder="Milestone ${physicalCount}"></td>
                <td><button class="btn btn-sm btn-secondary" onclick="deleteRow(this)">Delete</button></td>
            `;
        }
        
        let financialCount = 1;
        function addFinancialMilestone() {
            financialCount++;
            const tbody = document.getElementById('financialMilestones');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${financialCount}</td>
                <td><input type="number" placeholder="365" onchange="recalculateFinancialMilestones()"></td>
                <td><input type="number" placeholder="50" step="0.01" onchange="recalculateFinancialMilestones()"></td>
                <td><input type="text" class="readonly-calc" placeholder="Auto-calculated" readonly style="background: rgba(212, 175, 55, 0.1); border-color: #D4AF37; font-weight: 600;"></td>
                <td><input type="text" class="readonly-calc" placeholder="Auto-calculated" readonly style="background: rgba(212, 175, 55, 0.1); border-color: #D4AF37; font-weight: 600;"></td>
                <td><input type="text" class="readonly-calc" placeholder="Auto-calculated" readonly style="background: rgba(212, 175, 55, 0.1); border-color: #D4AF37; font-weight: 600;"></td>
                <td><input type="text" placeholder="Payment ${financialCount}"></td>
                <td><button class="btn btn-sm btn-secondary" onclick="deleteRow(this)">Delete</button></td>
            `;
            recalculateFinancialMilestones();
        }
        
        // Auto-calculation for Financial Milestones
        function recalculateFinancialMilestones() {
            const appointedDate = document.getElementById('appointedDate').value;
            const projectCost = parseFloat(document.getElementById('projectCost').value) || 0;
            const tbody = document.getElementById('financialMilestones');
            const rows = tbody.getElementsByTagName('tr');
            
            let cumulativeProgress = 0;
            
            for (let i = 0; i < rows.length; i++) {
                const inputs = rows[i].getElementsByTagName('input');
                const daysInput = inputs[0]; // Days from Start
                const progressInput = inputs[1]; // Progress %
                const scheduleDateInput = inputs[2]; // Schedule Date (AUTO)
                const amountInput = inputs[3]; // Amount (AUTO)
                const cumulativeInput = inputs[4]; // Cumulative % (AUTO)
                
                const days = parseInt(daysInput.value) || 0;
                const progress = parseFloat(progressInput.value) || 0;
                
                // Calculate Schedule Date
                if (appointedDate && days > 0) {
                    const appointed = new Date(appointedDate);
                    const scheduleDate = new Date(appointed);
                    scheduleDate.setDate(scheduleDate.getDate() + days);
                    scheduleDateInput.value = scheduleDate.toLocaleDateString('en-GB');
                } else {
                    scheduleDateInput.value = '';
                }
                
                // Calculate Amount
                if (projectCost > 0 && progress > 0) {
                    const amount = (projectCost * progress) / 100;
                    amountInput.value = amount.toFixed(2);
                } else {
                    amountInput.value = '';
                }
                
                // Calculate Cumulative %
                cumulativeProgress += progress;
                cumulativeInput.value = cumulativeProgress.toFixed(2) + '%';
            }
        }
        
        function deleteRow(btn) {
            btn.closest('tr').remove();
        }
        
        // Tab 2 - TCS Functions
        let tcsCount = 2;
        function addTCS() {
            const table = document.getElementById('tcsTable');
            const row = table.insertRow();
            row.onclick = function() { selectTCS(this, tcsCount); };
            row.innerHTML = `
                <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                <td><strong>${tcsCount * 5}+000</strong></td>
                <td><strong>${(tcsCount + 1) * 5}+000</strong></td>
                <td>Main Carriageway</td>
                <td>4-Lane</td>
                <td>Raised</td>
                <td>New</td>
            `;
            tcsCount++;
        }
        
        function selectTCS(row, index) {
            selectedTCSIndex = index; // FIX-UA06
            document.querySelectorAll('#tcsTable tr').forEach(r => r.classList.remove('selected'));
            row.classList.add('selected');
            
            document.getElementById('tcsDetailContent').innerHTML = `
                <!-- TAB 1: COMPONENTS -->
                <div class="detail-tab-content active">
                    <div class="info-box">Select Project Type to see appropriate components</div>
                    
                    <div class="radio-group">
                        <div class="radio-item selected" onclick="selectProjectType(this, 'new')">New</div>
                        <div class="radio-item" onclick="selectProjectType(this, 'widening')">Widening</div>
                        <div class="radio-item" onclick="selectProjectType(this, 'overlay')">Overlay</div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">1. Carriageway & Lanes</div>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" checked>
                                <label>Main Carriageway (4-Lane)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Service Road</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">2. Median & Protection</div>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" checked>
                                <label>Raised Median</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Depressed Median</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">4. Pavement Layers (IRC)</div>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" checked>
                                <label>BC - Bituminous Concrete</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" checked>
                                <label>DBM - Dense Bituminous Macadam</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>AIL - Asphaltic Intermediate Layer</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" checked>
                                <label>WMM - Wet Mix Macadam</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" checked>
                                <label>GSB - Granular Sub-Base</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>CTB - Cement Treated Base</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>CTSB - Cement Treated Sub-Base</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>SAMI - Stress Absorbing Membrane</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>DLC - Dry Lean Concrete</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>PQC - Pavement Quality Concrete</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">5. Earthwork & Formation</div>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" checked>
                                <label>Embankment</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" checked>
                                <label>Subgrade (300-500mm prepared layer)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Proof Rolling</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Soil Stabilization</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">7. Retaining Structures</div>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>RE Wall - LHS (RCC/Masonry/Gabion)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>RE Wall - RHS (RCC/Masonry/Gabion)</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">8. Safety & Furniture</div>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Crash Barriers (Concrete/Metal)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Guardrail - LHS</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Guardrail - RHS</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">9. Plantation (IRC)</div>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Avenue Plantation - LHS</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Avenue Plantation - RHS</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Median Plantation</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="component-section" style="margin-top: 16px; border: 2px solid #D4AF37; border-radius: 6px; padding: 12px; background: #fffbeb;">
                        <div class="component-header" style="color: #92400e; margin-bottom: 12px;">üìê Layer Thicknesses & Road Geometry</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div class="form-group">
                                <label class="form-label">BC Thickness (mm)</label>
                                <input type="number" class="form-input" id="tcsBC" value="${KALYANTRA.data.tcs.layers.BC.thickness}" min="20" max="80" onchange="saveTCSEdit('BC', this.value)" placeholder="40">
                            </div>
                            <div class="form-group">
                                <label class="form-label">DBM Thickness (mm)</label>
                                <input type="number" class="form-input" id="tcsDBM" value="${KALYANTRA.data.tcs.layers.DBM.thickness}" min="40" max="120" onchange="saveTCSEdit('DBM', this.value)" placeholder="50">
                            </div>
                            <div class="form-group">
                                <label class="form-label">WBM Thickness (mm)</label>
                                <input type="number" class="form-input" id="tcsWBM" value="${KALYANTRA.data.tcs.layers.WBM.thickness}" min="100" max="400" onchange="saveTCSEdit('WBM', this.value)" placeholder="250">
                            </div>
                            <div class="form-group">
                                <label class="form-label">GSB Thickness (mm)</label>
                                <input type="number" class="form-input" id="tcsGSB" value="${KALYANTRA.data.tcs.layers.GSB.thickness}" min="100" max="300" onchange="saveTCSEdit('GSB', this.value)" placeholder="150">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Carriage Width (m)</label>
                                <input type="number" class="form-input" id="tcsCarriageWidth" value="${KALYANTRA.data.tcs.carriageWidth}" min="3.5" max="15" step="0.5" onchange="saveTCSEdit('carriageWidth', this.value)" placeholder="7.0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Shoulder Width (m)</label>
                                <input type="number" class="form-input" id="tcsShoulderWidth" value="${KALYANTRA.data.tcs.shoulderWidth}" min="0.5" max="3.0" step="0.25" onchange="saveTCSEdit('shoulderWidth', this.value)" placeholder="1.5">
                            </div>
                        </div>
                        <div style="font-size: 0.78rem; color: #92400e; background: #fef3c7; padding: 6px 10px; border-radius: 4px;">
                            ‚ö° Changes update WBS quantities automatically via KALYANTRA engine
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="saveTCSComponents()">üíæ Save TCS Components & Geometry</button>
                </div>
                
                <!-- TAB 2: DRAWING STATUS (Same as Tab 3) -->
                <div class="detail-tab-content">
                    <div class="info-box">Track TCS/Highway drawing approval workflow (IRC compliance)</div>
                    
                    <div class="component-section">
                        <div class="component-header">1. TYPICAL CROSS-SECTION DRAWING</div>
                        <div class="form-group">
                            <label class="form-label">Design Status</label>
                            <select class="form-select">
                                <option>Not Started</option>
                                <option>Ongoing</option>
                                <option>Complete</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Design Date</label>
                            <input type="date" class="form-input">
                        </div>
                        
                        <div class="form-group" style="margin-top: 10px;">
                            <label class="form-label">Submission Status</label>
                            <select class="form-select">
                                <option>Not Submitted</option>
                                <option>Submitted</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Submission Date</label>
                            <input type="date" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Submitted To</label>
                            <select class="form-select">
                                <option>Engineer</option>
                                <option>Client</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Drawing Number</label>
                            <input type="text" class="form-input" placeholder="TCS-001-Rev0">
                        </div>
                        
                        <div class="form-group" style="margin-top: 10px;">
                            <label class="form-label">Review Status</label>
                            <select class="form-select">
                                <option>Not Started</option>
                                <option>Under Review</option>
                                <option>Approved</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Review Date</label>
                            <input type="date" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Comments</label>
                            <input type="text" class="form-input" placeholder="Minor modifications required">
                        </div>
                        
                        <div class="form-group" style="margin-top: 10px;">
                            <label class="form-label">Approval Status</label>
                            <select class="form-select">
                                <option>Pending</option>
                                <option>Approved</option>
                                <option>Approved with Comments</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Approval Date</label>
                            <input type="date" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Approval Reference</label>
                            <input type="text" class="form-input" placeholder="ABC/TCS/2025/001">
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">2. PAVEMENT DESIGN</div>
                        <div class="form-group">
                            <label class="form-label">Design Status</label>
                            <select class="form-select">
                                <option>Not Started</option>
                                <option>Ongoing</option>
                                <option>Complete</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Design Date</label>
                            <input type="date" class="form-input">
                        </div>
                        
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin: 10px 0;">
                            IRC Compliance Check:
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox">
                            <label>IRC:37 (Pavement Design)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox">
                            <label>IRC:SP:72 (Pavement Evaluation)</label>
                        </div>
                        <div class="form-group" style="margin-top: 10px;">
                            <label class="form-label">CBR Value (%)</label>
                            <input type="number" class="form-input" placeholder="From soil tests">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Design Traffic (MSA)</label>
                            <input type="number" class="form-input">
                        </div>
                        
                        <div class="form-group" style="margin-top: 10px;">
                            <label class="form-label">Submission Status</label>
                            <select class="form-select">
                                <option>Not Submitted</option>
                                <option>Submitted</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Approval Status</label>
                            <select class="form-select">
                                <option>Pending</option>
                                <option>Approved</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Approval Date</label>
                            <input type="date" class="form-input">
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">3. DRAINAGE DESIGN</div>
                        <div class="form-group">
                            <label class="form-label">Design Status</label>
                            <select class="form-select">
                                <option>Not Started</option>
                                <option>Ongoing</option>
                                <option>Complete</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Expected Completion</label>
                            <input type="date" class="form-input">
                        </div>
                        
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin: 10px 0;">
                            IRC Compliance:
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox">
                            <label>IRC:SP:50 (Drainage Guidelines)</label>
                        </div>
                        
                        <div class="form-group" style="margin-top: 10px;">
                            <label class="form-label">Drainage Calculations</label>
                            <select class="form-select">
                                <option>Pending</option>
                                <option>Submitted</option>
                                <option>Approved</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="component-section" style="background: rgba(59, 130, 246, 0.05); border-left: 4px solid var(--info);">
                        <div class="component-header">OVERALL TCS APPROVAL STATUS</div>
                        <div class="form-group">
                            <label class="form-label">Overall Status</label>
                            <select class="form-select">
                                <option>Pending</option>
                                <option>Partial Approval</option>
                                <option>Fully Approved</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Can Start Construction</label>
                            <select class="form-select">
                                <option>NO - Approvals Pending</option>
                                <option>YES - All Approved</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Reason (if NO)</label>
                            <input type="text" class="form-input" placeholder="e.g., Drainage design pending approval">
                        </div>
                    </div>
                </div>
            `;
        }
        
        // TCS Tab switching function
        function switchTCSTab(index) {
            const tabs = document.querySelectorAll('.detail-tab');
            const contents = document.querySelectorAll('.detail-tab-content');
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                    if (contents[i]) contents[i].classList.add('active');
                } else {
                    tab.classList.remove('active');
                    if (contents[i]) contents[i].classList.remove('active');
                }
            });
        }
        
        function selectProjectType(elem, type) {
            document.querySelectorAll('.radio-item').forEach(r => r.classList.remove('selected'));
            elem.classList.add('selected');
        }
        
        // Tab 3 - Structures Functions
        let structCount = 1;
        function addStructure() {
            const table = document.getElementById('structuresTable');
            const row = table.insertRow();
            row.onclick = function() { selectStructure(this, structCount); };
            const ch = (structCount + 1) * 5;
            row.innerHTML = `
                <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                <td><strong>Ch ${ch}+000</strong></td>
                <td>BC</td>
                <td>New</td>
                <td>1</td>
                <td>Open</td>
                <td>Solid Slab</td>
                <td>üìã Pending</td>
            `;
            structCount++;
            // Sync to KALYANTRA data store
            if (typeof KALYANTRA !== 'undefined') {
                KALYANTRA.data.structures.push({ id:structCount, name:`Structure Ch ${ch}+000`, type:'culvert', chainage:ch*1000, size:'1', concreteQty:45, excavationQty:50, foundationQty:15 });
                console.log('üìä KALYANTRA data updated: structures count =', KALYANTRA.data.structures.length);
            }
        }
        
        function selectStructure(row, index) {
            document.querySelectorAll('#structuresTable tr').forEach(r => r.classList.remove('selected'));
            row.classList.add('selected');
            
            document.getElementById('structureDetailContent').innerHTML = `
                <!-- TAB 1: BASIC -->
                <div class="detail-tab-content active">
                    <div class="form-group">
                        <label class="form-label">Chainage</label>
                        <input type="text" class="form-input" value="Ch 5+000" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Structure Type</label>
                        <select class="form-select">
                            <option>MNB - Minor Bridge</option>
                            <option>MJB - Major Bridge</option>
                            <option>BC - Box Culvert</option>
                            <option>ROB - Road Over Bridge</option>
                            <option>RUB - Road Under Bridge</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Proposal Type</label>
                        <select class="form-select">
                            <option>New</option>
                            <option>Widening</option>
                            <option>Rehabilitation</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total Width (m)</label>
                        <input type="number" class="form-input" value="12.0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total Length (m)</label>
                        <input type="number" class="form-input" value="45.0" readonly>
                    </div>
                </div>
                
                <!-- TAB 2: DRAWING STATUS (V1.2 ENHANCED) -->
                <div class="detail-tab-content">
                    <div class="info-box">Complete design-to-approval workflow tracking</div>
                    
                    <div class="component-section">
                        <div class="component-header">1. DESIGN PREPARATION</div>
                        <div class="form-group">
                            <label class="form-label">Site Investigation Status</label>
                            <select class="form-select">
                                <option>Not Started</option>
                                <option>Ongoing</option>
                                <option>Complete</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Site Investigation Date</label>
                            <input type="date" class="form-input">
                        </div>
                        
                        <div class="form-group" style="margin-top: 15px;">
                            <label class="form-label">Design Status</label>
                            <select class="form-select">
                                <option>Not Started</option>
                                <option>Ongoing</option>
                                <option>Complete</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Design Completion Date</label>
                            <input type="date" class="form-input">
                        </div>
                        
                        <div class="form-group" style="margin-top: 15px;">
                            <label class="form-label">Internal QA/QC</label>
                            <select class="form-select">
                                <option>Not Done</option>
                                <option>Done</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">QA Date</label>
                            <input type="date" class="form-input">
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">2. SUBMISSION & REVIEW</div>
                        <div class="form-group">
                            <label class="form-label">Submission Status</label>
                            <select class="form-select">
                                <option>Not Submitted</option>
                                <option>Submitted</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Submission Date</label>
                            <input type="date" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Submitted To</label>
                            <select class="form-select">
                                <option>Engineer</option>
                                <option>Client</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Submission Reference</label>
                            <input type="text" class="form-input" placeholder="REF-2025-001">
                        </div>
                        
                        <div class="form-group" style="margin-top: 15px;">
                            <label class="form-label">Review Status</label>
                            <select class="form-select">
                                <option>Not Started</option>
                                <option>Under Review</option>
                                <option>Reviewed with Comments</option>
                                <option>Approved</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Review Date</label>
                            <input type="date" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Comments Received</label>
                            <select class="form-select">
                                <option>No</option>
                                <option>Yes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Comment Response Date</label>
                            <input type="date" class="form-input">
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">3. FINAL APPROVAL</div>
                        <div class="form-group">
                            <label class="form-label">Approval Status</label>
                            <select class="form-select">
                                <option>Pending</option>
                                <option>Approved</option>
                                <option>Approved with Comments</option>
                                <option>Rejected</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Approval Date</label>
                            <input type="date" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Approved By</label>
                            <select class="form-select">
                                <option>Engineer</option>
                                <option>Client</option>
                                <option>Both</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Approval Reference</label>
                            <input type="text" class="form-input" placeholder="APPR-2025-001">
                        </div>
                        
                        <div class="form-group" style="margin-top: 15px;">
                            <label class="form-label">If Rejected - Reason</label>
                            <input type="text" class="form-input" placeholder="Reason for rejection">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Expected Resubmission Date</label>
                            <input type="date" class="form-input">
                        </div>
                    </div>
                    
                    <div class="component-section" id="specialClearancesROB" style="display: none;">
                        <div class="component-header">4. SPECIAL CLEARANCES (ROB/RUB)</div>
                        <div class="checkbox-item">
                            <input type="checkbox">
                            <label><strong>Railway Safety Commissioner Approval</strong></label>
                        </div>
                        <div class="form-group" style="margin-left: 25px;">
                            <label class="form-label">Status</label>
                            <select class="form-select">
                                <option>Pending</option>
                                <option>Applied</option>
                                <option>Approved</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-left: 25px;">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-input">
                        </div>
                        <div class="form-group" style="margin-left: 25px;">
                            <label class="form-label">Reference</label>
                            <input type="text" class="form-input">
                        </div>
                        
                        <div class="checkbox-item" style="margin-top: 15px;">
                            <input type="checkbox">
                            <label><strong>Railway Board Technical Clearance</strong></label>
                        </div>
                        <div class="form-group" style="margin-left: 25px;">
                            <label class="form-label">Status</label>
                            <select class="form-select">
                                <option>Pending</option>
                                <option>Applied</option>
                                <option>Approved</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-left: 25px;">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-input">
                        </div>
                    </div>
                    
                    <div class="component-section" id="specialClearancesMJB" style="display: none;">
                        <div class="component-header">4. SPECIAL CLEARANCES (MJB - River)</div>
                        <div class="checkbox-item">
                            <input type="checkbox">
                            <label><strong>CWC (Central Water Commission) Clearance</strong></label>
                        </div>
                        <div class="form-group" style="margin-left: 25px;">
                            <label class="form-label">Status</label>
                            <select class="form-select">
                                <option>Pending</option>
                                <option>Applied</option>
                                <option>Approved</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-left: 25px;">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-input">
                        </div>
                        <div class="form-group" style="margin-left: 25px;">
                            <label class="form-label">Reference</label>
                            <input type="text" class="form-input">
                        </div>
                    </div>
                </div>
                
                <!-- TAB 3: SPAN CONFIGURATION -->
                <div class="detail-tab-content">
                    <div class="info-box">Define each span separately</div>
                    <div class="form-group">
                        <label class="form-label">Number of Spans</label>
                        <input type="number" class="form-input" value="3">
                    </div>
                    <table class="mini-table">
                        <thead>
                            <tr>
                                <th>Span</th>
                                <th>Length (m)</th>
                                <th>Foundation</th>
                                <th>Superstructure</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td><input type="number" value="15"></td>
                                <td>
                                    <select>
                                        <option>Open</option>
                                        <option selected>Pile - Bored</option>
                                        <option>Well</option>
                                    </select>
                                </td>
                                <td>
                                    <select>
                                        <option selected>PSC Girder</option>
                                        <option>RCC Girder</option>
                                        <option>Box Girder</option>
                                        <option>Solid Slab</option>
                                        <option>Composite Girder</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td><input type="number" value="15"></td>
                                <td>
                                    <select>
                                        <option>Open</option>
                                        <option selected>Pile - Bored</option>
                                        <option>Well</option>
                                    </select>
                                </td>
                                <td>
                                    <select>
                                        <option selected>PSC Girder</option>
                                        <option>RCC Girder</option>
                                        <option>Box Girder</option>
                                        <option>Solid Slab</option>
                                        <option>Composite Girder</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>3</td>
                                <td><input type="number" value="15"></td>
                                <td>
                                    <select>
                                        <option>Open</option>
                                        <option selected>Pile - Bored</option>
                                        <option>Well</option>
                                    </select>
                                </td>
                                <td>
                                    <select>
                                        <option selected>PSC Girder</option>
                                        <option>RCC Girder</option>
                                        <option>Box Girder</option>
                                        <option>Solid Slab</option>
                                        <option>Composite Girder</option>
                                    </select>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="margin-top: 10px; font-size: 0.85rem; color: var(--text-secondary);">
                        Total Length: 45.0 m (auto-calculated)
                    </div>
                </div>
                
                <!-- TAB 4: SPECIAL CONDITIONS (V1.5 - EXECUTION FOCUSED) -->
                <div class="detail-tab-content">
                    <div class="info-box">Execution planning conditions (Design data is in approved drawings)</div>
                    
                    <div class="component-section">
                        <div class="component-header">LOCATION & LOGISTICS</div>
                        <div class="form-group">
                            <label class="form-label">Location Type</label>
                            <select class="form-select">
                                <option>Urban</option>
                                <option>Semi-Urban</option>
                                <option>Rural</option>
                            </select>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">
                            Purpose: Determines working hours, site access, logistics
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">TRAFFIC MANAGEMENT</div>
                        <div class="form-group">
                            <label class="form-label">Traffic Management Required</label>
                            <select class="form-select">
                                <option>No</option>
                                <option>Yes</option>
                            </select>
                        </div>
                        
                        <div class="form-group" style="margin-top: 10px;">
                            <label class="form-label">Construction Sequence</label>
                            <select class="form-select">
                                <option>LHS first, then RHS</option>
                                <option>RHS first, then LHS</option>
                                <option>Both sides in parallel</option>
                                <option>Phased construction</option>
                            </select>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">
                            Purpose: Determines WBS activity sequencing
                        </div>
                        
                        <div class="form-group" style="margin-top: 10px;">
                            <label class="form-label">Working Hours</label>
                            <select class="form-select">
                                <option>24-hours</option>
                                <option>Day only</option>
                                <option>Night only</option>
                                <option>Weekend only</option>
                            </select>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px; font-style: italic;">
                            Note: Detailed traffic management schedule, costs ‚Üí Hindrances Tab
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">MONSOON SENSITIVITY</div>
                        <div class="form-group">
                            <label class="form-label">Monsoon Sensitive</label>
                            <select class="form-select">
                                <option>No</option>
                                <option>Yes</option>
                            </select>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">
                            Typically Yes for: MNB, MJB, Culverts (water structures)
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px; font-style: italic;">
                            Note: Monsoon months, non-workable activities ‚Üí Calendar Tab
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">RAILWAY APPROVALS (For ROB/RUB)</div>
                        <div class="form-group">
                            <label class="form-label">Railway Blocks Required</label>
                            <select class="form-select">
                                <option>No</option>
                                <option>Yes</option>
                            </select>
                        </div>
                        
                        <div class="form-group" style="margin-top: 10px;">
                            <label class="form-label">Railway Approval Status</label>
                            <select class="form-select">
                                <option>Not Applied</option>
                                <option>Applied</option>
                                <option>In-Progress</option>
                                <option>Approved</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Approval Date</label>
                            <input type="date" class="form-input">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Approval Reference</label>
                            <input type="text" class="form-input" placeholder="REF-RAIL-2025-001">
                        </div>
                        
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">
                            Purpose: Track readiness to start construction
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px; font-style: italic;">
                            Note: Block duration, frequency, 30-day processing ‚Üí Activity Grid
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">UTILITY CONFLICTS (For Urban Structures)</div>
                        <div class="form-group">
                            <label class="form-label">Utility Shifting Required</label>
                            <select class="form-select">
                                <option>No</option>
                                <option>Yes</option>
                            </select>
                        </div>
                        
                        <div class="form-group" style="margin-top: 10px;">
                            <label class="form-label">Shifting Status</label>
                            <select class="form-select">
                                <option>Planning</option>
                                <option>Permission Applied</option>
                                <option>In-Progress</option>
                                <option>Complete</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Expected Completion Date</label>
                            <input type="date" class="form-input">
                        </div>
                        
                        <div class="form-group" style="margin-top: 10px;">
                            <label class="form-label">Can Start Construction Without Shifting</label>
                            <select class="form-select">
                                <option>No - Must complete first</option>
                                <option>Yes - Can work in parallel</option>
                            </select>
                        </div>
                        
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">
                            Purpose: Flag for dependency tracking
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px; font-style: italic;">
                            Note: Which utilities, 60-day delays, costs ‚Üí Hindrances Tab
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">SITE-SPECIFIC CONSTRAINTS</div>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Land acquisition pending</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Structure demolition required</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Tree cutting permission required</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Environmental clearance pending</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Working space constraints (<20m)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Material storage area unavailable</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Access road construction required</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Crane positioning constraints</label>
                            </div>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 10px;">
                            Purpose: Identify preconditions before WBS start
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 8px;">
                    <button class="btn btn-primary" style="flex: 1;" onclick="saveStructureFromForm(${index})">üíæ Save to KALYANTRA</button>
                    <button class="btn btn-secondary" style="padding: 8px 16px;" onclick="KALYANTRA.refresh(); KALYANTRA.render.wbsTable(); showToast('WBS refreshed from structure data', 'success')">üîÑ Update WBS</button>
                </div>
            `;
            // Store index on container for event-delegation saves
            const sc = document.getElementById('structureDetailContent');
            if (sc) sc.setAttribute('data-struct-idx', index);
        }
        
        // Tab 4 - Hindrances Functions
        let hindranceCount = 3; // Start from 4 since we have 3 sample rows
        
        function addHindrance() {
            hindranceCount++;
            const table = document.getElementById('hindrancesTable');
            const row = table.insertRow();
            row.onclick = function() { selectHindrance(this, hindranceCount); };
            row.innerHTML = `
                <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                <td><strong>${hindranceCount}</strong></td>
                <td>Land Handover</td>
                <td>Ch __+___</td>
                <td><span style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">Non-Clear</span></td>
                <td><span style="background: rgba(251, 191, 36, 0.1); color: #f59e0b; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">Active</span></td>
                <td>0 days</td>
                <td>__/__/____</td>
                <td>Owner</td>
            `;
            // Sync to KALYANTRA data store
            if (typeof KALYANTRA !== 'undefined') {
                const cs = hindranceCount * 400;
                KALYANTRA.data.hindrances.push({ id:hindranceCount, name:'Land Handover', type:'land', chainageStart:cs, chainageEnd:cs+600, status:'Pending', impact:'Blocks work activities' });
                console.log('üìä KALYANTRA data updated: hindrances count =', KALYANTRA.data.hindrances.length);
            }
        }
        
        function uploadJM() {
            showToast('üìé JM upload coming in V7.0', 'info');
        }
        
        function selectHindrance(row, index) {
            document.querySelectorAll('#hindrancesTable tr').forEach(r => r.classList.remove('selected'));
            row.classList.add('selected');
            
            const category = row.cells[2].textContent;
            
            // Generate detail content based on category
            let detailHTML = generateHindranceDetails(category, index);
            
            const _hdc = document.getElementById('hindranceDetailContent');
            _hdc.setAttribute('data-hindrance-index', index); // FIX-GAP07
            _hdc.innerHTML = detailHTML;
            // U-11: Pre-fill chainage inputs from data model
            const hData = KALYANTRA.data.hindrances[index];
            if (hData) {
                const setV = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
                setV('fromKm', Math.floor(hData.chainageStart / 1000));
                setV('fromM',  hData.chainageStart % 1000);
                setV('toKm',   Math.floor(hData.chainageEnd / 1000));
                setV('toM',    hData.chainageEnd % 1000);
            }
            // FIX-GAP07: restore resolution days input
            setTimeout(() => {
                const _rdi = document.getElementById('hindranceResolutionDays');
                if (_rdi && hData) _rdi.value = hData.resolutionDays || '';
                // FIX-GAP05: restore status button active state
                if (hData) {
                    const _cols = {Pending:['#fee2e2','#dc2626','#991b1b'],'In Progress':['#fff7ed','#ea580c','#9a3412'],Resolved:['#dcfce7','#16a34a','#166534']};
                    ['Pending','In Progress','Resolved'].forEach(s => {
                        const _btn = document.getElementById('hStat_'+index+'_'+s.replace(/ /g,''));
                        if (!_btn) return;
                        const [bg,br,tc] = _cols[s]||['white','#e2e8f0','#64748b'];
                        const _active = (hData.status||'Pending') === s;
                        _btn.style.background = _active?bg:'white';
                        _btn.style.borderColor = _active?br:'#e2e8f0';
                        _btn.style.color = _active?tc:'#64748b';
                        _btn.style.fontWeight = _active?'800':'600';
                    });
                }
            }, 60);
        }
        
        function generateHindranceDetails(category, index) {
            // Common sections for all hindrances
            const commonSections = `
                <div class="component-section" style="background:#f8fafc;border-radius:8px;padding:12px;margin-bottom:12px;">
                    <div style="font-size:0.8rem;font-weight:700;color:#475569;margin-bottom:8px;">HINDRANCE STATUS</div>
                    <div style="display:flex;gap:8px;">
                        <button id="hStat_\${index}_Pending"
                            onclick="setHindranceStatus(\${index},'Pending')"
                            style="flex:1;padding:7px 0;border-radius:6px;border:2px solid #e2e8f0;background:white;color:#64748b;font-size:0.82rem;font-weight:600;cursor:pointer;">‚è≥ Pending</button>
                        <button id="hStat_\${index}_InProgress"
                            onclick="setHindranceStatus(\${index},'In Progress')"
                            style="flex:1;padding:7px 0;border-radius:6px;border:2px solid #e2e8f0;background:white;color:#64748b;font-size:0.82rem;font-weight:600;cursor:pointer;">üî® In Progress</button>
                        <button id="hStat_\${index}_Resolved"
                            onclick="setHindranceStatus(\${index},'Resolved')"
                            style="flex:1;padding:7px 0;border-radius:6px;border:2px solid #e2e8f0;background:white;color:#64748b;font-size:0.82rem;font-weight:600;cursor:pointer;">‚úÖ Resolved</button>
                    </div>
                </div>
                <div class="component-section">
                    <div class="component-header">1. BASIC INFORMATION</div>
                    <div class="form-group">
                        <label class="form-label">Hindrance Category</label>
                        <select class="form-select" onchange="updateHindranceCategory(this)">
                            <option ${category === 'Land Handover' ? 'selected' : ''}>Land Handover (JM Based)</option>
                            <option ${category === 'Utility Shifting' ? 'selected' : ''}>Utility Shifting</option>
                            <option ${category === 'ROB Drawing Approval' ? 'selected' : ''}>ROB/RUB Drawing Approval</option>
                            <option>Canal Crossing Approval</option>
                            <option>Statutory Clearances</option>
                            <option>Differing Site Conditions</option>
                            <option>Variation Orders</option>
                            <option>Traffic Management</option>
                            <option>Railway Coordination</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" rows="3" placeholder="Describe the hindrance in detail..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><strong>Location (Chainage)</strong></label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label style="font-size: 0.85rem; color: var(--text-secondary);">From Chainage</label>
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <input type="number" class="form-input" placeholder="10" style="width: 60px;" id="fromKm" onchange="liveHindranceChainageUpdate()">
                                    <span>+</span>
                                    <input type="number" class="form-input" placeholder="500" style="width: 70px;" id="fromM" onchange="liveHindranceChainageUpdate()">
                                </div>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: var(--text-secondary);">To Chainage</label>
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <input type="number" class="form-input" placeholder="12" style="width: 60px;" id="toKm" onchange="liveHindranceChainageUpdate()">
                                    <span>+</span>
                                    <input type="number" class="form-input" placeholder="800" style="width: 70px;" id="toM" onchange="liveHindranceChainageUpdate()">
                                </div>
                            </div>
                            <!-- FIX-GAP07: Resolution days field -->
                            <div style="margin-top:10px;">
                                <label style="font-size:0.83rem;font-weight:600;color:#475569;display:block;margin-bottom:4px;">‚è± Est. Resolution (days)</label>
                                <input type="number" id="hindranceResolutionDays" min="0" placeholder="e.g. 30"
                                    style="width:90px;padding:5px 8px;border:1px solid #e2e8f0;border-radius:5px;font-size:0.85rem;"
                                    onchange="saveHindranceResolutionDays(this.value)">
                                <span style="font-size:0.75rem;color:#94a3b8;margin-left:6px;">days until zone is workable</span>
                            </div>
                        </div>
                        <div style="margin-top: 8px; padding: 8px; background: rgba(59, 130, 246, 0.05); border-radius: 4px;">
                            <span style="font-size: 0.85rem; color: var(--text-secondary);">Length: </span>
                            <span style="font-weight: 600; color: #3b82f6;">2.3 km</span> 
                            <span style="font-size: 0.85rem; color: var(--text-secondary);">(auto-calculated)</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Or Structure Location</label>
                        <input type="text" class="form-input" placeholder="e.g., Structure at Ch 11+250 (if hindrance affects specific structure)">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Status <span style="font-size:0.75rem;color:#64748b;">(Resolved = zone unlocked for scheduling)</span></label>
                        <select class="form-select" id="landStatusSelect" data-field="status"
                            onchange="quickResolveHindrance(this)"
                            style="border-color:#D4AF37;">
                            <option value="pending">Active ‚Äî Pending</option>
                            <option value="working">Under Resolution</option>
                            <option value="clear">Resolved ‚úÖ (Zone Unlocked)</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Criticality</label>
                        <select class="form-select">
                            <option>HIGH üî¥</option>
                            <option>MEDIUM üü°</option>
                            <option>LOW üü¢</option>
                        </select>
                    </div>
                </div>
            `;
            
            // Category-specific sections
            let categorySpecific = '';
            
            if (category === 'Land Handover') {
                categorySpecific = `
                    <div class="component-section" style="background: rgba(239, 68, 68, 0.05); border-left: 4px solid #ef4444;">
                        <div class="component-header">JOINT MEMORANDUM REFERENCE</div>
                        <div class="form-group">
                            <label class="form-label">JM Reference Number</label>
                            <input type="text" class="form-input" placeholder="JM/2025/01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">JM Date</label>
                            <input type="date" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Chainage (Non-Clear Land)</label>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">
                                (This will auto-fill from Location above)
                            </div>
                            <input type="text" class="form-input" placeholder="Ch 10+500 to Ch 12+800" readonly style="background: #f3f4f6;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Length</label>
                            <input type="number" class="form-input" placeholder="2.3" step="0.1" readonly style="background: #f3f4f6;"> km
                        </div>
                        <div class="form-group">
                            <label class="form-label">Land Status</label>
                            <select class="form-select" id="landStatusSelect" onchange="checkAffectedStructures(this)">
                                <option value="clear">Clear (as per JM)</option>
                                <option value="encumbered">Encumbered / Non-Clear</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Issue Type (if Encumbered)</label>
                            <select class="form-select">
                                <option>Select issue type...</option>
                                <option>Encroachments (Houses/Shops)</option>
                                <option>Forest Land - Clearance Pending</option>
                                <option>Revenue Land - Conversion Pending</option>
                                <option>Private Land - Acquisition Pending</option>
                                <option>Religious Structure (Temple/Mosque/Church)</option>
                                <option>Land Dispute - Ownership Unclear</option>
                                <option>Cemetery / Graveyard</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="component-section" id="affectedStructuresSection" style="display: none; background: rgba(251, 191, 36, 0.05); border-left: 4px solid #f59e0b;">
                        <div class="component-header">‚ö†Ô∏è AFFECTED STRUCTURES IN THIS STRETCH</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 10px;">
                            System searched Tab 3 and found structures in encumbered land:
                        </div>
                        <div style="padding: 10px; background: white; border: 1px solid #f59e0b; border-radius: 6px;">
                            <div style="margin-bottom: 8px;">
                                <strong style="color: #f59e0b;">Structure 1:</strong> Ch 11+250 - Minor Bridge (MNB)<br>
                                <span style="font-size: 0.85rem; color: var(--text-secondary);">‚Üí Cannot start foundation work until land cleared</span>
                            </div>
                            <div>
                                <strong style="color: #f59e0b;">Structure 2:</strong> Ch 12+100 - Box Culvert (BC)<br>
                                <span style="font-size: 0.85rem; color: var(--text-secondary);">‚Üí Cannot start excavation until land cleared</span>
                            </div>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: rgba(239, 68, 68, 0.05); border-radius: 4px;">
                            <strong>‚ö†Ô∏è CRITICAL IMPACT:</strong><br>
                            <span style="font-size: 0.85rem;">2 structures in critical path affected. Schedule delay: <strong>120+ days</strong></span>
                        </div>
                    </div>
                `;
            } else if (category === 'Utility Shifting') {
                categorySpecific = `
                    <div class="component-section" style="background: rgba(59, 130, 246, 0.05); border-left: 4px solid #3b82f6;">
                        <div class="component-header">UTILITY DETAILS</div>
                        <div class="form-group">
                            <label class="form-label">Utility Type</label>
                            <select class="form-select">
                                <option>Electric - 11kV HT Line</option>
                                <option>Electric - 33kV HT Line</option>
                                <option>Electric - LT Line</option>
                                <option>Water Supply Pipeline</option>
                                <option>Sewage Line</option>
                                <option>Telecom Cable</option>
                                <option>Gas Pipeline</option>
                                <option>Irrigation Canal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label"><strong>Land Status (Critical!)</strong></label>
                            <div class="radio-group" style="display: flex; gap: 15px; margin-top: 8px;">
                                <div class="radio-item" style="background: rgba(34, 197, 94, 0.1); padding: 8px 15px; border-radius: 6px; cursor: pointer;">
                                    <input type="radio" name="landStatus" id="clearLand" checked>
                                    <label for="clearLand" style="cursor: pointer;">‚úÖ CLEAR LAND (as per JM)</label>
                                </div>
                                <div class="radio-item" style="background: rgba(239, 68, 68, 0.1); padding: 8px 15px; border-radius: 6px; cursor: pointer;">
                                    <input type="radio" name="landStatus" id="nonClearLand">
                                    <label for="nonClearLand" style="cursor: pointer;">‚ùå NON-CLEAR LAND</label>
                                </div>
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px; padding: 8px; background: rgba(59, 130, 246, 0.05); border-radius: 4px;">
                                <strong>Impact:</strong><br>
                                If Clear Land ‚Üí Owner responsible to coordinate shifting<br>
                                If Non-Clear Land ‚Üí First land clearance, then shifting (Double delay!)
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Coordinating Agency</label>
                            <input type="text" class="form-input" placeholder="State Electricity Board / Municipal Water Board">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Asset Description</label>
                            <input type="text" class="form-input" placeholder="15 poles, 2.5 km HT line">
                        </div>
                    </div>
                `;
            } else if (category === 'ROB Drawing Approval') {
                categorySpecific = `
                    <div class="component-section" style="background: rgba(168, 85, 247, 0.05); border-left: 4px solid #a855f7;">
                        <div class="component-header">ROB/RUB DRAWING APPROVAL</div>
                        <div class="form-group">
                            <label class="form-label">Structure</label>
                            <input type="text" class="form-input" placeholder="ROB at Ch 25+500">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Drawing Type</label>
                            <select class="form-select">
                                <option>General Arrangement Drawing (GAD)</option>
                                <option>Foundation Drawing</option>
                                <option>Substructure Drawing</option>
                                <option>Superstructure Drawing</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Approval Authority</label>
                            <select class="form-select">
                                <option>Railway Board</option>
                                <option>Divisional Railway Manager (DRM)</option>
                            </select>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 10px; background: rgba(251, 191, 36, 0.05); border-radius: 6px;">
                            <strong style="display: block; margin-bottom: 10px;">Submission Cycle Tracking:</strong>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="font-weight: 600;">Submission 1 (Initial):</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px;">
                                    <input type="date" class="form-input" placeholder="Date">
                                    <select class="form-select">
                                        <option>Under Review</option>
                                        <option>Comments Received</option>
                                        <option>Approved</option>
                                    </select>
                                </div>
                                <input type="date" class="form-input" placeholder="Comments Date" style="margin-top: 5px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="font-weight: 600;">Submission 2 (Revised):</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px;">
                                    <input type="date" class="form-input" placeholder="Date">
                                    <select class="form-select">
                                        <option>Not Yet Submitted</option>
                                        <option>Under Review</option>
                                        <option>Approved</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Timeline section (common for all)
            const timelineSection = `
                <div class="component-section">
                    <div class="component-header">2. CONTRACTUAL TIMELINE</div>
                    <div class="form-group">
                        <label class="form-label">Hindrance Identified Date</label>
                        <input type="date" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reported to Owner Date</label>
                        <input type="date" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Owner Response Date</label>
                        <input type="date" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><strong>Expected Resolution Date</strong></label>
                        <input type="date" class="form-input" style="border: 2px solid #3b82f6;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Actual Resolution Date (if closed)</label>
                        <input type="date" class="form-input">
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: rgba(59, 130, 246, 0.05); border-radius: 4px;">
                        <strong>Days Since Reported:</strong> <span style="color: #ef4444; font-weight: 600;">27 days</span> (Auto-calculated)
                    </div>
                </div>
                
                <div class="component-section">
                    <div class="component-header">3. RESPONSIBILITY</div>
                    <div class="form-group">
                        <label class="form-label">Responsible Party / Agency</label>
                        <input type="text" class="form-input" placeholder="e.g., NHAI Regional Office, Hyderabad / PWD Executive Engineer / Railway Board">
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;">
                            Enter as per your contract. Examples:<br>
                            ‚Ä¢ "Owner - NHAI Project Director"<br>
                            ‚Ä¢ "State Irrigation Department, SE Office, Warangal"<br>
                            ‚Ä¢ "Railway Board, South Central Railway Division"<br>
                            ‚Ä¢ "Municipal Corporation, Engineering Wing"
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: rgba(59, 130, 246, 0.05); border-radius: 6px; border-left: 4px solid #3b82f6;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">
                        <strong>üìã Note:</strong> Additional Details (Impact, Documentation, Claims, Attachments) will be captured in <strong>Stage-02: Claim Application</strong>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">
                        For now, focus on tracking hindrance occurrence, timeline, and responsibility. Detailed claim preparation comes later.
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 8px;">
                    <button class="btn btn-primary" style="flex: 1;" onclick="saveHindranceFromForm(${index})">üíæ Save to KALYANTRA</button>
                    <button class="btn btn-secondary" style="padding: 8px 16px;" onclick="KALYANTRA.refresh(); KALYANTRA.render.wbsTable(); showToast('WBS refreshed from hindrance data', 'success')">üîÑ Update WBS</button>
                </div>
            `;
            
            return commonSections + categorySpecific + timelineSection;
        }
        
        function updateHindranceCategory(select) {
            // Refresh the detail view when category changes
            const selectedRow = document.querySelector('#hindrancesTable tr.selected');
            if (selectedRow) {
                const index = parseInt(selectedRow.cells[1].textContent);
                selectHindrance(selectedRow, index);
            }
        }
        
        function checkAffectedStructures(select) {
            const affectedSection = document.getElementById('affectedStructuresSection');
            if (select.value === 'encumbered') {
                affectedSection.style.display = 'block';
            } else {
                affectedSection.style.display = 'none';
            }
        }

        // TAB 7 - 4 CHILD TABS JAVASCRIPT
        function switchTab7Child(index) {
            // Update button states
            for (let i = 0; i <= 3; i++) {
                const btn = document.getElementById('tab7child' + i);
                const content = document.getElementById('tab7content' + i);
                
                if (i === index) {
                    btn.style.background = '#1B3B6F';
                    btn.style.color = 'white';
                    btn.style.borderBottomColor = '#D4AF37';
                    content.style.display = 'flex';
                } else {
                    btn.style.background = 'transparent';
                    btn.style.color = '#64748b';
                    btn.style.borderBottomColor = 'transparent';
                    content.style.display = 'none';
                }
            }
            // Tab-specific renders
            if (index === 1) setTimeout(() => renderActivitiesTable(), 80);
            if (index === 2) setTimeout(() => renderGantt(), 80);
            if (index === 3) setTimeout(() => { buildLSMActivities(); renderLSMAxes(); renderLSMActivities(); }, 80);
        }
        
        // WBS Table Functions
        function toggleWBSRow(cell) {
            const row = cell.parentElement;
            const wbs = row.querySelector('td:nth-child(2)').textContent;
            const icon = cell.querySelector('.wbs-toggle');
            const isExpanded = icon.textContent === '‚ñº';
            
            icon.textContent = isExpanded ? '‚ñ∂' : '‚ñº';
            
            const children = document.querySelectorAll(`tr[data-parent="${wbs}"]`);
            children.forEach(child => {
                child.style.display = isExpanded ? 'none' : 'table-row';
            });
        }
        
        function expandAllWBS() {
            document.querySelectorAll('#wbsBody .wbs-toggle').forEach(icon => icon.textContent = '‚ñº');
            document.querySelectorAll('#wbsBody tr[data-level="1"]').forEach(row => row.style.display = 'table-row');
        }
        
        function collapseAllWBS() {
            document.querySelectorAll('#wbsBody .wbs-toggle').forEach(icon => icon.textContent = '‚ñ∂');
            document.querySelectorAll('#wbsBody tr[data-level="1"]').forEach(row => row.style.display = 'none');
        }
        
        function viewWBSActivities(wbs) {
            switchTab7Child(1);
            const select = document.getElementById('activityFilter');
            if (select) {
                select.value = wbs;
                filterActivities();
            }
        }
        
        // U-05: Update activity actual % complete
        function updateActivityProgress(slider, wbsId, actId, pct) {
            const pctNum = parseInt(pct) || 0;
            // LA-01 FIX: Persist actualPct to KALYANTRA.data.activityProgress so refresh() doesn't wipe it
            const progressKey = wbsId + '.' + actId;
            if (!KALYANTRA.data.activityProgress) KALYANTRA.data.activityProgress = {};
            KALYANTRA.data.activityProgress[progressKey] = pctNum;
            supabaseSaveProgress(progressKey, pctNum);
            try { const _sd=Object.assign({},KALYANTRA.data,{_version:'6.6'}); localStorage.setItem('kalyantra_v65_data',JSON.stringify(_sd)); } catch(e) {}
            // Find activity in computed and update actualPct
            const act = KALYANTRA.computed.activities.find(a => a.wbs === wbsId && String(a.id) === String(actId));
            if (act) {
                act.actualPct = pctNum;
                // Also update in WBS item activities
                const wbsItem = KALYANTRA.computed.wbs.find(w => w.wbs === wbsId);
                if (wbsItem) {
                    const wa = wbsItem.activities.find(a => String(a.id) === String(actId));
                    if (wa) wa.actualPct = pctNum;
                }
                // Recalculate progress and save
                KALYANTRA.calculate.progress();
                KALYANTRA.save();
                // UA-03 FIX: update WBS stat bar live
                if (typeof updateWBSStatBar === 'function') updateWBSStatBar();
                // Update dashboard if visible
                const dashBar = document.getElementById('dashOverallBar');
                if (dashBar) KALYANTRA.render.dashboard();
                const prog = KALYANTRA.computed.overallProgress;
                // Brief toast every 10%
                if (pctNum % 10 === 0 && pctNum > 0) {
                    showToast(`üìä ${act.name}: ${pctNum}% ‚Äî Project overall: ${prog}%`, 'success');
                }
            }
        }

        function filterActivities() {
            const filter = document.getElementById('activityFilter').value;
            const rows = document.querySelectorAll('#activitiesBody tr');
            let count = 0;
            
            rows.forEach(row => {
                const wbs = row.getAttribute('data-wbs');
                if (filter === 'all' || wbs === filter || wbs.startsWith(filter + '.')) {
                    row.style.display = 'table-row';
                    count++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            const countDisplay = document.getElementById('activityCount');
            if (countDisplay) {
                countDisplay.textContent = count;
            }
        }
        

        // ========================================
        // LINEAR SCHEDULE METHOD (LSM) - INTERACTIVE DIAGRAM
        // ========================================
        
        let lsmZoomLevel = 1.0;
        let lsmShowCritical = true;
        let lsmShowBuffer = false;
        let lsmShowConflicts = false;
        
        // LSM Activity Data ‚Äî dynamically built from KALYANTRA.computed
        let lsmActivities = []; // populated by buildLSMActivities()
        
        function buildLSMActivities() {
            // Transform KALYANTRA.computed into LSM format
            // Each activity gets: start/end chainage + dateStart/dateEnd from WBS offset dates
            if (!KALYANTRA || !KALYANTRA.computed || !KALYANTRA.computed.wbs || !KALYANTRA.computed.wbs.length) {
                KALYANTRA.refresh();
            }
            const wbs = KALYANTRA.computed.wbs;
            const projectStart = parseLocalDate(KALYANTRA.data.project.startDate || '2026-01-01');
            const result = [];
            let id = 1;
            let dayOffset = 0;
            
            wbs.forEach(item => {
                if (item.type === 'blocked') return; // Skip blocked zones
                let localOffset = 0;
                item.activities.forEach(act => {
                    const dateStart = new Date(projectStart);
                    dateStart.setDate(dateStart.getDate() + dayOffset + localOffset);
                    const dateEnd   = new Date(dateStart);
                    dateEnd.setDate(dateEnd.getDate() + (act.duration || 5));
                    
                    const chainageStart = item.chainage ? (item.chainage.start !== undefined ? item.chainage.start : item.chainage) : 0;
                    const chainageEnd   = item.chainage ? (item.chainage.end   !== undefined ? item.chainage.end   : item.chainage) : 500;
                    
                    result.push({
                        id,
                        name:         act.name + (item.type === 'stretch' ? ` ‚Äî ${item.name.split('(')[0].trim()}` : ` ‚Äî ${item.name}`),
                        start:        chainageStart,
                        end:          chainageEnd,
                        dateStart:    dateStart.toISOString().split('T')[0],
                        dateEnd:      dateEnd.toISOString().split('T')[0],
                        type:         item.type === 'stretch' ? (act.name.includes('BC') || act.name.includes('DBM') || act.name.includes('WBM') ? 'pavement' : 'earthwork') : 'structure',
                        critical:     act.critical || false,
                        production:   item.chainage ? Math.round((chainageEnd - chainageStart) / Math.max(act.duration, 1)) : 10,
                        crew:         act.resource || 'TBD',
                        phase:        item.phase
                    });
                    id++;
                    localOffset += act.duration || 5;
                });
                if (item.type === 'stretch') dayOffset += item.duration || 20;
            });
            
            lsmActivities = result;
            console.log('üìä LSM built from KALYANTRA:', lsmActivities.length, 'activities');
            return result;
        }
        

        // Initialize LSM on page load
        function initializeLSM() {
            // FIX-UA09: on re-entry just refresh data, don't re-attach listeners
            if (lsmInitialized) { buildLSMActivities(); renderLSMAxes(); renderLSMActivities(); if(typeof renderLSMActualProgress==='function') renderLSMActualProgress(); return; }
            lsmInitialized = true;
            buildLSMActivities();
            renderLSMAxes();
            renderLSMActivities();
            if (typeof renderLSMActualProgress === 'function') renderLSMActualProgress();
        }
        
        // Render X-axis (Timeline)
        function renderLSMAxes() {
            const xAxis = document.getElementById('lsmXAxis');
            const yAxis = document.getElementById('lsmYAxis');
            
            // X-axis: Timeline from Jan to Feb 2026
            const months = ['January 2026', 'February 2026', 'March 2026'];
            xAxis.innerHTML = months.map((month, i) => `
                <div style="flex: 1; text-align: center; font-size: 0.8125rem; font-weight: 600; color: #64748b; padding: 8px; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: center;">
                    ${month}
                </div>
            `).join('');
            
            // Y-axis: Chainage from 0 to 5000m
            const chainages = [5000, 4000, 3000, 2000, 1000, 0];
            yAxis.innerHTML = chainages.map((ch, i) => `
                <div style="position: absolute; top: ${i * 20}%; font-size: 0.8125rem; font-weight: 600; color: #475569; text-align: right; width: 100%; padding-right: 8px;">
                    Ch ${(ch/1000).toFixed(1)}+000
                </div>
            `).join('');
        }
        
        // Render LSM Activity Lines
        function renderLSMActivities() {
            const svg = document.getElementById('lsmActivities');
            const canvasWidth = 1200; // will be dynamic based on container
            const canvasHeight = 600;
            
            // Clear existing
            svg.innerHTML = '';
            
            lsmActivities.forEach(activity => {
                if (activity.critical && !lsmShowCritical) return; // Skip if critical hidden
                
                // Calculate positions
                const x1 = dateToX(activity.dateStart, canvasWidth);
                const x2 = dateToX(activity.dateEnd, canvasWidth);
                const y1 = chainageToY(activity.start, canvasHeight);
                const y2 = chainageToY(activity.end, canvasHeight);
                
                // Determine color
                let color = '#22c55e'; // green for earthwork
                let strokeWidth = 3;
                let marker = 'arrowGreen';
                
                if (activity.type === 'structure') {
                    color = '#3b82f6'; // blue
                    marker = 'arrowBlue';
                }
                if (activity.type === 'pavement') {
                    color = '#f59e0b'; // orange
                }
                if (activity.critical) {
                    color = '#dc2626'; // red for critical
                    strokeWidth = 4;
                    marker = 'arrowRed';
                }
                
                // Create line element
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x1);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x2);
                line.setAttribute('y2', y2);
                line.setAttribute('stroke', color);
                line.setAttribute('stroke-width', strokeWidth);
                line.setAttribute('marker-end', `url(#${marker})`);
                line.setAttribute('data-activity-id', activity.id);
                line.style.cursor = 'pointer';
                line.style.transition = 'all 0.2s';
                
                // Add hover effects
                line.addEventListener('mouseenter', (e) => showLSMTooltip(e, activity));
                line.addEventListener('mouseleave', hideLSMTooltip);
                line.addEventListener('mousemove', (e) => moveLSMTooltip(e));
                
                svg.appendChild(line);
                
                // Add activity label
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                const labelX = x1 + (x2 - x1) * 0.5;
                const labelY = y1 + (y2 - y1) * 0.5 - 8;
                label.setAttribute('x', labelX);
                label.setAttribute('y', labelY);
                label.setAttribute('fill', color);
                label.setAttribute('font-size', '11');
                label.setAttribute('font-weight', '600');
                label.setAttribute('text-anchor', 'middle');
                label.textContent = activity.name.split(' - ')[0]; // Short name
                label.style.pointerEvents = 'none';
                
                svg.appendChild(label);
            });
            
            // Render buffer zones if enabled
            if (lsmShowBuffer) {
                renderBufferZones();
            }
            
            // Render conflicts if enabled
            if (lsmShowConflicts) {
                renderConflicts();
            }
            
            // GAP-11 FIX: Render actual progress overlay (Gold dashed lines)
            renderLSMActualProgress(svg, canvasWidth, canvasHeight);
        }
        
        // GAP-11: Render actual progress as Gold dashed overlay on LSM diagram
        function renderLSMActualProgress(svg, canvasWidth, canvasHeight) {
            const activities = KALYANTRA.computed.activities || [];
            const progress   = KALYANTRA.data.activityProgress || {};
            
            lsmActivities.forEach(lsmAct => {
                // Find matching computed activity for actualPct
                const key = Object.keys(progress).find(k => {
                    const parts = k.split('.');
                    return lsmAct.id && lsmAct.id.toString().includes(parts[0] + '.' + parts[1]);
                });
                const pct = key ? (progress[key] || 0) : 0;
                if (pct <= 0) return; // Nothing to draw if no actual progress
                
                // Actual line: from planned start to pct% of the planned line
                const x1 = dateToX(lsmAct.dateStart, canvasWidth);
                const x2 = dateToX(lsmAct.dateEnd, canvasWidth);
                const y1 = chainageToY(lsmAct.start, canvasHeight);
                const y2 = chainageToY(lsmAct.end, canvasHeight);
                
                // Interpolate to pct% along the line
                const actualX2 = x1 + (x2 - x1) * (pct / 100);
                const actualY2 = y1 + (y2 - y1) * (pct / 100);
                
                const actualLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                actualLine.setAttribute('x1', x1);
                actualLine.setAttribute('y1', y1);
                actualLine.setAttribute('x2', actualX2);
                actualLine.setAttribute('y2', actualY2);
                actualLine.setAttribute('stroke', '#D4AF37'); // Gold ‚Äî KALYANTRA brand
                actualLine.setAttribute('stroke-width', '3');
                actualLine.setAttribute('stroke-dasharray', '8,4');
                actualLine.setAttribute('opacity', '0.85');
                actualLine.setAttribute('title', lsmAct.name + ': ' + pct + '% actual');
                svg.appendChild(actualLine);
                
                // Pct badge at end of actual line
                if (pct > 5) {
                    const badge = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    badge.setAttribute('x', actualX2 + 4);
                    badge.setAttribute('y', actualY2 - 4);
                    badge.setAttribute('fill', '#D4AF37');
                    badge.setAttribute('font-size', '10');
                    badge.setAttribute('font-weight', '700');
                    badge.textContent = pct + '%';
                    badge.style.pointerEvents = 'none';
                    svg.appendChild(badge);
                }
            });
        }
        
        // Convert date to X coordinate
        function dateToX(dateStr, canvasWidth) {
            const startDate = parseLocalDate(KALYANTRA.data.project.startDate || '2026-01-01');
            const date = parseLocalDate(dateStr);
            const daysSince = Math.floor((date - startDate) / (1000 * 60 * 60 * 24));
            const totalDays = 90; // Jan-Mar = 90 days
            return 40 + (daysSince / totalDays) * (canvasWidth - 80);
        }
        
        // Convert chainage to Y coordinate
        function chainageToY(chainage, canvasHeight) {
            const maxChainage = 5000;
            // Invert Y because SVG Y increases downward
            return canvasHeight - 40 - (chainage / maxChainage) * (canvasHeight - 80);
        }
        
        // Show tooltip on hover
        function showLSMTooltip(event, activity) {
            const tooltip = document.getElementById('lsmTooltip');
            const rect = tooltip.parentElement.getBoundingClientRect();
            
            // Create tooltip content
            tooltip.innerHTML = `
                <rect x="0" y="0" width="280" height="140" fill="rgba(15, 23, 42, 0.95)" rx="8" stroke="#3b82f6" stroke-width="2"/>
                <text x="14" y="25" fill="white" font-size="14" font-weight="700">${activity.name}</text>
                <text x="14" y="50" fill="#94a3b8" font-size="12">Location: Ch ${(activity.start/1000).toFixed(1)}+000 to ${(activity.end/1000).toFixed(1)}+000</text>
                <text x="14" y="70" fill="#94a3b8" font-size="12">Duration: ${activity.dateStart} to ${activity.dateEnd}</text>
                <text x="14" y="90" fill="#94a3b8" font-size="12">Production: ${activity.production} m/day</text>
                <text x="14" y="110" fill="#94a3b8" font-size="12">Crew: ${activity.crew}</text>
                ${activity.critical ? '<text x="14" y="130" fill="#fca5a5" font-size="12" font-weight="700">üî¥ CRITICAL PATH</text>' : ''}
            `;
            
            tooltip.style.display = 'block';
            moveLSMTooltip(event);
        }
        
        // Move tooltip with mouse
        function moveLSMTooltip(event) {
            const tooltip = document.getElementById('lsmTooltip');
            const svg = document.getElementById('lsmCanvas');
            const rect = svg.getBoundingClientRect();
            
            const x = event.clientX - rect.left + 20;
            const y = event.clientY - rect.top - 70;
            
            tooltip.setAttribute('transform', `translate(${x}, ${y})`);
        }
        
        // Hide tooltip
        function hideLSMTooltip() {
            const tooltip = document.getElementById('lsmTooltip');
            tooltip.style.display = 'none';
        }
        
        // Render buffer zones
        function renderBufferZones() {
            const buffersG = document.getElementById('lsmBuffers');
            buffersG.innerHTML = '';
            
            lsmActivities.forEach(activity => {
                if (!activity.critical) return; // Only show for critical
                
                const canvasWidth = 1200;
                const canvasHeight = 600;
                
                const x1 = dateToX(activity.dateStart, canvasWidth);
                const x2 = dateToX(activity.dateEnd, canvasWidth);
                const y1 = chainageToY(activity.start, canvasHeight);
                const y2 = chainageToY(activity.end, canvasHeight);
                
                // Buffer zone polygon (area around the line)
                const bufferWidth = 15;
                const angle = Math.atan2(y2 - y1, x2 - x1);
                const perpAngle = angle + Math.PI / 2;
                
                const points = [
                    [x1 + Math.cos(perpAngle) * bufferWidth, y1 + Math.sin(perpAngle) * bufferWidth],
                    [x2 + Math.cos(perpAngle) * bufferWidth, y2 + Math.sin(perpAngle) * bufferWidth],
                    [x2 - Math.cos(perpAngle) * bufferWidth, y2 - Math.sin(perpAngle) * bufferWidth],
                    [x1 - Math.cos(perpAngle) * bufferWidth, y1 - Math.sin(perpAngle) * bufferWidth]
                ];
                
                const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                polygon.setAttribute('points', points.map(p => p.join(',')).join(' '));
                polygon.setAttribute('fill', 'rgba(251, 191, 36, 0.15)');
                polygon.setAttribute('stroke', '#f59e0b');
                polygon.setAttribute('stroke-width', '1');
                polygon.setAttribute('stroke-dasharray', '4,3');
                polygon.style.pointerEvents = 'none';
                
                buffersG.appendChild(polygon);
            });
        }
        
        // Detect and render conflicts
        function renderConflicts() {
            const conflictsG = document.getElementById('lsmConflicts');
            conflictsG.innerHTML = '';
            
            const canvasWidth = 1200;
            const canvasHeight = 600;
            
            // Simple conflict detection: activities at same location with overlapping dates
            for (let i = 0; i < lsmActivities.length; i++) {
                for (let j = i + 1; j < lsmActivities.length; j++) {
                    const a1 = lsmActivities[i];
                    const a2 = lsmActivities[j];
                    
                    // Check if chainages overlap
                    const chainageOverlap = !(a1.end < a2.start || a2.end < a1.start);
                    
                    // Check if dates overlap
                    const d1Start = new Date(a1.dateStart);
                    const d1End = new Date(a1.dateEnd);
                    const d2Start = new Date(a2.dateStart);
                    const d2End = new Date(a2.dateEnd);
                    const dateOverlap = !(d1End < d2Start || d2End < d1Start);
                    
                    if (chainageOverlap && dateOverlap) {
                        // Conflict detected! Mark the intersection point
                        const conflictChainage = (Math.max(a1.start, a2.start) + Math.min(a1.end, a2.end)) / 2;
                        const conflictDate = new Date(Math.max(d1Start, d2Start));
                        const conflictDateStr = conflictDate.toISOString().split('T')[0];
                        
                        const x = dateToX(conflictDateStr, canvasWidth);
                        const y = chainageToY(conflictChainage, canvasHeight);
                        
                        // Warning icon
                        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        circle.setAttribute('cx', x);
                        circle.setAttribute('cy', y);
                        circle.setAttribute('r', '12');
                        circle.setAttribute('fill', '#fef2f2');
                        circle.setAttribute('stroke', '#ef4444');
                        circle.setAttribute('stroke-width', '3');
                        conflictsG.appendChild(circle);
                        
                        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        text.setAttribute('x', x);
                        text.setAttribute('y', y + 5);
                        text.setAttribute('fill', '#dc2626');
                        text.setAttribute('font-size', '16');
                        text.setAttribute('font-weight', '900');
                        text.setAttribute('text-anchor', 'middle');
                        text.textContent = '‚ö†';
                        conflictsG.appendChild(text);
                    }
                }
            }
        }
        
        // Control Functions
        function lsmZoomIn() {
            lsmZoomLevel *= 1.2;
            applyLSMZoom();
        }
        
        function lsmZoomOut() {
            lsmZoomLevel /= 1.2;
            if (lsmZoomLevel < 0.5) lsmZoomLevel = 0.5;
            applyLSMZoom();
        }
        
        function lsmResetView() {
            lsmZoomLevel = 1.0;
            applyLSMZoom();
        }
        
        function applyLSMZoom() {
            const svg = document.getElementById('lsmCanvas');
            svg.style.transform = `scale(${lsmZoomLevel})`;
            svg.style.transformOrigin = 'top left';
        }
        
        function lsmToggleCritical() {
            lsmShowCritical = !lsmShowCritical;
            const btn = document.getElementById('lsmCriticalBtn');
            if (lsmShowCritical) {
                btn.style.background = '#fee2e2';
                btn.style.color = '#991b1b';
                btn.style.borderColor = '#fecaca';
            } else {
                btn.style.background = 'white';
                btn.style.color = '#64748b';
                btn.style.borderColor = '#cbd5e1';
            }
            renderLSMActivities();
        }
        
        function lsmToggleBuffer() {
            lsmShowBuffer = !lsmShowBuffer;
            const buffersG = document.getElementById('lsmBuffers');
            buffersG.style.display = lsmShowBuffer ? 'block' : 'none';
            const btn = document.getElementById('lsmBufferBtn');
            if (lsmShowBuffer) {
                btn.style.background = '#fffbeb';
                btn.style.color = '#92400e';
                btn.style.borderColor = '#fcd34d';
                renderBufferZones();
            } else {
                btn.style.background = 'white';
                btn.style.color = '#64748b';
                btn.style.borderColor = '#cbd5e1';
            }
        }
        
        function lsmToggleConflicts() {
            lsmShowConflicts = !lsmShowConflicts;
            const conflictsG = document.getElementById('lsmConflicts');
            conflictsG.style.display = lsmShowConflicts ? 'block' : 'none';
            const btn = document.getElementById('lsmConflictBtn');
            if (lsmShowConflicts) {
                btn.style.background = '#fee2e2';
                btn.style.color = '#991b1b';
                btn.style.borderColor = '#fecaca';
                renderConflicts();
            } else {
                btn.style.background = 'white';
                btn.style.color = '#64748b';
                btn.style.borderColor = '#cbd5e1';
            }
        }
        
        // Initialize LSM when tab is opened
        document.addEventListener('DOMContentLoaded', function() {
            // Will initialize when tab 7 child tab 3 is first opened
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    const tab = document.getElementById('tab7content3');
                    if (tab && tab.style.display !== 'none') {
                        initializeLSM();
                        observer.disconnect();
                    }
                });
            });
            
            const tab = document.getElementById('tab7content3');
            if (tab) {
                observer.observe(tab, { attributes: true, attributeFilter: ['style'] });
            }
        });

        // ============================================
        // KALYANTRA V6.1 - DATA FLOW SYSTEM (FULLY CONNECTED)
        // ============================================
        
        const KALYANTRA = {
            version: '6.6-AllAuditFixes',
            
            // ‚îÄ‚îÄ RAW DATA STORE (single source of truth) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            data: {
                project: {
                    name: 'NH-44 Sample Project',
                    budget: 3.7,
                    startDate: '2026-01-01',
                    endDate: '2026-04-15',
                    location: 'Hyderabad-Nagpur Section',
                    startChainage: 0,
                    endChainage: 5000
                },
                
                tcs: {
                    carriageWidth: 7.0,
                    shoulderWidth: 1.5,
                    layers: {
                        BC:  { thickness: 40,  material: 'Bituminous Concrete' },
                        DBM: { thickness: 50,  material: 'Dense Bituminous Macadam' },
                        WBM: { thickness: 250, material: 'Water Bound Macadam' },
                        GSB: { thickness: 150, material: 'Granular Sub Base' }
                    }
                },
                
                structures: [
                    { id: 1, name: 'Box Culvert Ch 2+450', type: 'box_culvert',
                      chainage: 2450, size: '6m √ó 4m', concreteQty: 60,
                      excavationQty: 50, foundationQty: 15 }
                ],
                
                hindrances: [
                    { id: 1, name: 'Tree Cutting / Vegetation', type: 'land',
                      chainageStart: 1200, chainageEnd: 1800,
                      status: 'Pending', impact: 'Blocks earthwork ‚Äî Ch 1+200 to 1+800' },
                    { id: 2, name: 'Utility Shifting (HT Line)', type: 'utility',
                      chainageStart: 2800, chainageEnd: 3200,
                      status: 'Pending', impact: 'Blocks carriageway ‚Äî Ch 2+800 to 3+200' },
                    { id: 3, name: 'Land Encroachment', type: 'land',
                      chainageStart: 3800, chainageEnd: 4200,
                      status: 'Pending', impact: 'Prevents grading ‚Äî Ch 3+800 to 4+200' }
                ],
                
                resources: {
                    equipment: [],
                    manpower:  [],
                    materials: []
                },
                
                calendar: {
                    workingDays: [1,2,3,4,5,6],
                    hoursPerDay: 8,
                    monsoonStart: '2026-07-15',
                    monsoonEnd:   '2026-08-31',
                    holidays: ['2026-01-26','2026-08-15','2026-10-02']
                },
                
                milestones: [],
                
                activityProgress: {},

                // ‚îÄ‚îÄ BOQ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                boq: {
                    sections: [],        // road work sections (chainage-wise)
                    structureBOQ: [],    // structure BOQ uploads
                    generationConfig: {  // sequence + productivity confirmed by user
                        sequence: [],
                        productivityRates: {},
                        confirmed: false
                    }
                }
            },
            
            // ‚îÄ‚îÄ COMPUTED / DERIVED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            computed: {
                workableStretches: [],
                wbs: [],
                activities: [],
                totalActivities: 0,
                criticalActivities: 0,
                completedActivities: 0,
                overallProgress: 0,
                physicalProgress: 0,
                financialProgress: 0,
                totalDuration: 0,
                totalCost: 0
            },
            
            // ‚îÄ‚îÄ SYNC FROM UI ‚Üí data store ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            syncFromUI: {
                project: function() {
                    const val = id => { const el = document.getElementById(id); return el ? el.value : ''; };
                    const num = id => { const el = document.getElementById(id); return el ? parseFloat(el.value) || 0 : 0; };
                    KALYANTRA.data.project.name   = val('projectName')   || KALYANTRA.data.project.name;
                    KALYANTRA.data.project.budget  = num('projectCost')  || KALYANTRA.data.project.budget;
                    KALYANTRA.data.project.startDate = val('appointedDate') || KALYANTRA.data.project.startDate;
                    const skm = num('startKm'), sm = num('startM');
                    const ekm = num('endKm'),   em = num('endM');
                    if (ekm > 0) {
                        KALYANTRA.data.project.startChainage = skm * 1000 + sm;
                        KALYANTRA.data.project.endChainage   = ekm * 1000 + em;
                    }
                    // Sprint 2: read industry/mode selects
                    KALYANTRA.data.project.industryType = val('industryType') || KALYANTRA.data.project.industryType || 'roads';
                    KALYANTRA.data.project.projectMode  = val('projectMode')  || KALYANTRA.data.project.projectMode  || 'epc';
                    // L-02 / U-06: Sync duration and completion date
                    const durVal = parseInt(val('duration')) || 0;
                    if (durVal > 0) KALYANTRA.data.project.duration = durVal * 30;
                    const compDate = val('completionDate');
                    if (compDate) KALYANTRA.data.project.endDate = compDate;
                },
                tcs: function() {
                    // L-03 FIX: Do NOT read from TCS display table ‚Äî columns are From/To/Type/Lanes/Median/Proposal.
                    // carriageWidth and layer thicknesses are managed by saveTCSEdit() / saveTCSComponents() directly.
                    // This function is intentionally a no-op to preserve data integrity.
                },
                structures: function() {
                    const rows = document.querySelectorAll('#structuresTable tr');
                    const arr = [];
                    rows.forEach((row, i) => {
                        const cells = row.cells;
                        if (!cells || cells.length < 4) return;
                        const chainageText = cells[1] ? cells[1].textContent.trim() : '';
                        const match = chainageText.match(/(\d+)\+(\d+)/);
                        const chainage = match ? parseInt(match[1]) * 1000 + parseInt(match[2]) : (i + 1) * 1000;
                        arr.push({
                            id: i + 1,
                            name: chainageText || `Structure ${i+1}`,
                            type: cells[6] ? cells[6].textContent.trim().toLowerCase().replace(/ /g,'_') : 'culvert',
                            chainage: chainage,
                            size: cells[4] ? cells[4].textContent.trim() : '1',
                            concreteQty: 60, excavationQty: 50, foundationQty: 15
                        });
                    });
                    if (arr.length > 0) KALYANTRA.data.structures = arr;
                },
                hindrances: function() {
                    const rows = document.querySelectorAll('#hindrancesTable tr');
                    const arr = [];
                    rows.forEach((row, i) => {
                        const cells = row.cells;
                        if (!cells || cells.length < 5) return;
                        const chainageText = cells[3] ? cells[3].textContent.trim() : '';
                        const matches = chainageText.match(/(\d+)/g);
                        const cs = matches && matches[0] ? parseInt(matches[0]) * 1000 + (parseInt(matches[1]) || 0) : (i + 1) * 500;
                        const ce = cs + 600;
                        const statusText = cells[5] ? cells[5].textContent.trim() : 'Active';
                        arr.push({
                            id: i + 1,
                            name: cells[2] ? cells[2].textContent.trim() : `Hindrance ${i+1}`,
                            type: 'utility',
                            chainageStart: cs,
                            chainageEnd: ce,
                            status: statusText.includes('Resolved') ? 'Resolved' : 'Pending',
                            impact: 'Blocks work activities'
                        });
                    });
                    if (arr.length > 0) KALYANTRA.data.hindrances = arr;
                }
            },
            
            // ‚îÄ‚îÄ CALCULATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            calculate: {
                workableStretches: function() {
                    const p = KALYANTRA.data.project;
                    const projectStart = p.startChainage || 0;
                    const projectEnd   = p.endChainage   || 5000;
                    const hindrances = KALYANTRA.data.hindrances
                        .filter(h => h.status === 'Pending')
                        .sort((a,b) => a.chainageStart - b.chainageStart);
                    
                    const workable = [];
                    let cur = projectStart;
                    hindrances.forEach(h => {
                        if (h.chainageStart > cur) {
                            workable.push({ id: workable.length+1, start: cur, end: h.chainageStart, length: (h.chainageStart-cur)/1000 });
                        }
                        cur = Math.max(cur, h.chainageEnd);
                    });
                    if (cur < projectEnd) {
                        workable.push({ id: workable.length+1, start: cur, end: projectEnd, length: (projectEnd-cur)/1000 });
                    }
                    KALYANTRA.computed.workableStretches = workable;
                    return workable;
                },
                
                wbs: function() {
                    const workable   = KALYANTRA.computed.workableStretches;
                    const structures = KALYANTRA.data.structures;
                    const hindrances = KALYANTRA.data.hindrances.filter(h => h.status === 'Pending');
                    const wbs = [];
                    const fmt = m => { const k = Math.floor(m/1000); const r = m%1000; return `${k}+${String(r).padStart(3,'0')}`; };
                    
                    // LA-05 FIX: TCS-based cost model (rate per m3 √ó volume per km √ó stretch length)
                    const tcs = KALYANTRA.data.tcs;
                    const W   = tcs.carriageWidth || 7;
                    // Cost rates per Cum (‚Çπ) ‚Äî typical Indian road construction MORT&H rates
                    const layerRates = { GSB: 450, WBM: 850, DBM: 1800, BC: 2500 };
                    const earthRatePerCum = 200; // embankment rate ‚Çπ/Cum
                    const croreDiv = 10000000; // 1 Cr = 1,00,00,000
                    
                    workable.forEach((s,i) => {
                        const acts = KALYANTRA.calculate.stretchActivities(s);
                        // FIX-GAP07: delay (days) from unresolved bordering hindrances
                        const _resDelay = KALYANTRA.data.hindrances
                            .filter(h => h.status !== 'Resolved' && (h.resolutionDays||0) > 0)
                            .filter(h => Math.abs(h.chainageEnd - s.start) < 500 || Math.abs(h.chainageStart - s.end) < 500)
                            .reduce((mx, h) => Math.max(mx, h.resolutionDays||0), 0);
                        const L = s.length * 1000; // metres
                        // Compute stretch cost from TCS volumes
                        let stretchCost = 0;
                        // Earthwork (embankment) ‚Äî 0.5m depth assumption
                        stretchCost += (L * W * 0.5) * earthRatePerCum;
                        // Pavement layers
                        Object.entries(tcs.layers).forEach(([lyr, cfg]) => {
                            const vol = L * W * ((cfg.thickness || 0) / 1000);
                            stretchCost += vol * (layerRates[lyr] || 1000);
                        });
                        const costCr = +(stretchCost / croreDiv).toFixed(2);
                        wbs.push({ wbs:`1.${i+1}`, name:`Stretch ${i+1} (Ch ${fmt(s.start)} ‚Äì ${fmt(s.end)})`,
                            type:'stretch', phase:1, chainage:s, status:'Workable',
                            activities: acts,
                            duration: acts.reduce((sum,a)=>Math.max(sum,a.duration),0) + 5,
                            cost: costCr });
                    });
                    structures.forEach((st,i) => {
                        const acts = KALYANTRA.calculate.structureActivities(st);
                        // LA-05: Structure cost from concreteQty * rate (‚Çπ7500/Cum typical box culvert)
                        const concQty = (st.concreteQty||45) + (st.foundationQty||15);
                        const structCostCr = +((concQty * 7500) / 10000000).toFixed(2) || 1.2;
                        // LA-06 FIX: Curing (id:4) is parallel with Box Construction (id:3), not sequential
                        // Critical path = Excavation + Foundation + max(BoxConstr,Curing) + Backfill
                        const seqActs = acts.filter(a => a.id !== '4'); // exclude Curing from sequential chain
                        const boxDur  = (acts.find(a=>a.id==='3') || {duration:7}).duration;
                        const curDur  = (acts.find(a=>a.id==='4') || {duration:7}).duration;
                        const parallelDur = Math.max(boxDur, curDur);
                        const structDur = seqActs.reduce((s,a)=>s+(a.duration||0),0) + parallelDur;
                        wbs.push({ wbs:`2.${i+1}`, name:st.name, type:'structure', phase:2,
                            chainage:{start:st.chainage,end:st.chainage}, status:'Structure',
                            activities: acts,
                            duration: structDur,
                            cost: Math.max(structCostCr, 0.3) });
                    });
                    hindrances.forEach((h,i) => {
                        wbs.push({ wbs:`3.${i+1}`, name:`Blocked: ${h.name}`, type:'blocked', phase:3,
                            chainage:{start:h.chainageStart,end:h.chainageEnd}, status:'Blocked',
                            activities:[], duration:0, cost:0 });
                    });
                    
                    KALYANTRA.computed.wbs = wbs;
                    KALYANTRA.computed.totalCost = wbs.reduce((s,w)=>s+w.cost,0);
                    KALYANTRA.computed.totalDuration = wbs.reduce((s,w)=>Math.max(s,w.duration),0);
                    return wbs;
                },
                
                stretchActivities: function(stretch) {
                    const tcs = KALYANTRA.data.tcs;
                    const res = KALYANTRA.data.resources;
                    const L   = stretch.length * 1000;
                    // Resource-aware assignment (S4-01)
                    const getRes = (types, fallback) => {
                        const match = res.equipment.find(e => types.some(t => (e.type||'').toLowerCase().includes(t)));
                        return match ? `${match.count || 1}x ${match.type}` : (res.equipment.length ? '‚ö†Ô∏è ' + fallback + ' not assigned' : fallback);
                    };
                    const _sActs = [
                        { id:`${stretch.id}.1`, name:'Soil Excavation',  qty:Math.round(L*tcs.carriageWidth*0.5), unit:'Cum', duration:10, critical:true,  resource: getRes(['excavat'],'2 Excavators') },
                        { id:`${stretch.id}.2`, name:'Embankment',        qty:Math.round(L*tcs.carriageWidth*0.3), unit:'Cum', duration:8,  critical:true,  resource: getRes(['grader','compact'],'1 Grader + Compactor') },
                        { id:`${stretch.id}.3`, name:`GSB (${tcs.layers.GSB.thickness}mm)`, qty:Math.round(L*tcs.carriageWidth*(tcs.layers.GSB.thickness/1000)), unit:'Cum', duration:5, critical:false, resource: getRes(['paver','gsb'],'1 Paver') },
                        { id:`${stretch.id}.4`, name:`WBM (${tcs.layers.WBM.thickness}mm)`, qty:Math.round(L*tcs.carriageWidth*(tcs.layers.WBM.thickness/1000)), unit:'Cum', duration:6, critical:false, resource: getRes(['paver','wbm'],'1 Paver') },
                        { id:`${stretch.id}.5`, name:`DBM (${tcs.layers.DBM.thickness}mm)`, qty:Math.round(L*tcs.carriageWidth*(tcs.layers.DBM.thickness/1000)), unit:'Cum', duration:4, critical:true,  resource: getRes(['dbm','dense','bituminous macadam','asphalt','paver'],'1 DBM Paver') },
                        { id:`${stretch.id}.6`, name:`BC (${tcs.layers.BC.thickness}mm)`,   qty:Math.round(L*tcs.carriageWidth*(tcs.layers.BC.thickness/1000)),  unit:'Cum', duration:3, critical:true,  resource: getRes(['bc','bituminous concrete','surface','wearing'],'1 BC Paver') }
                    ];
                    // FIX-LA01b: restore actualPct from persistent store (survives refresh)
                    const _sp = KALYANTRA.data.activityProgress || {};
                    _sActs.forEach(a => { a.actualPct = _sp[stretch.id + '.' + a.id] !== undefined ? _sp[stretch.id + '.' + a.id] : 0; });
                    return _sActs;
                },
                
                structureActivities: function(s) {
                    const res = KALYANTRA.data.resources;
                    const getRes = (types, fallback) => {
                        const match = res.equipment.find(e => types.some(t => (e.type||'').toLowerCase().includes(t)));
                        return match ? `${match.count || 1}x ${match.type}` : (res.equipment.length ? '‚ö†Ô∏è ' + fallback + ' not assigned' : fallback);
                    };
                    const _structActs = [
                        { id:'1', name:'Excavation',          qty:s.excavationQty||50, unit:'Cum', duration:2, critical:false, resource: getRes(['excavat'],'1 Excavator') },
                        { id:'2', monsoonSensitive:false, name:'Foundation Concrete', qty:s.foundationQty||15, unit:'Cum', duration:3, critical:true,  resource: getRes(['batch','transit','concrete'],'Batching Plant') },
                        { id:'3', monsoonSensitive:false, name:'Box Construction',    qty:s.concreteQty||45,   unit:'Cum', duration:7, critical:true,  resource: getRes(['crane'],'Crane + Form') },
                        { id:'4', monsoonSensitive:false, name:'Curing',              qty:0,                   unit:'‚Äî',   duration:7, critical:true,  resource:'‚Äî' },
                        { id:'5', name:'Backfill & Compact',  qty:20,                  unit:'Cum', duration:2, critical:false, resource: getRes(['excavat','compact'],'1 Excavator') }
                    ];
                    // FIX-LA01c: restore actualPct from persistent store
                    const _stp = KALYANTRA.data.activityProgress || {};
                    _structActs.forEach(a => { a.actualPct = _stp[s.id + '.' + a.id] !== undefined ? _stp[s.id + '.' + a.id] : 0; });
                    // FIX-LA06: critical path ‚Äî Curing runs parallel with Box Construction
                    // Sequential: Exc(2)+Found(3)+Backfill(2)=7  Parallel: max(BoxConst(7),Curing(7))=7  Total=14
                    return _structActs;
                },

                allActivities: function() {
                    const wbs = KALYANTRA.computed.wbs;
                    const all = [];
                    // LA-01 FIX: Restore persisted actualPct from data store after spread (refresh() wipes computed)
                    const progress = KALYANTRA.data.activityProgress || {};
                    wbs.forEach(item => {
                        item.activities.forEach(a => {
                            const key = item.wbs + '.' + a.id;
                            const obj = { ...a, wbs:item.wbs, wbsName:item.name, phase:item.phase, type:item.type };
                            if (progress[key] !== undefined) obj.actualPct = progress[key];
                            all.push(obj);
                        });
                    });
                    KALYANTRA.computed.activities       = all;
                    KALYANTRA.computed.totalActivities  = all.length;
                    KALYANTRA.computed.criticalActivities = all.filter(a=>a.critical).length;
                    return all;
                },
                
                progress: function() {
                    const all = KALYANTRA.computed.activities;
                    if (!all.length) { KALYANTRA.computed.overallProgress=0; return; }
                    // L-06 FIX: use actual activity progress (actualPct field, 0-100)
                    // Falls back to time-elapsed proxy only if NO activities have actual data
                    const withActual = all.filter(a => typeof a.actualPct === 'number' && a.actualPct > 0);
                    let overall = 0;
                    if (withActual.length > 0) {
                        // Weighted average: weight by activity duration
                        const totalWeight  = all.reduce((s,a) => s + (a.duration||1), 0);
                        const weightedSum  = all.reduce((s,a) => s + (a.actualPct||0) * (a.duration||1), 0);
                        overall = Math.round(weightedSum / totalWeight);
                    } else {
                        // Time-elapsed proxy (unchanged fallback)
                        const sd = parseLocalDate(KALYANTRA.data.project.startDate || '2026-01-01');
                        const today = new Date();
                        // LA-03 FIX: derive totalDays from endDate if duration not set
                        const _proj = KALYANTRA.data.project;
                        let totalDays = _proj.duration || 0;
                        if (!totalDays && _proj.endDate && _proj.startDate) {
                            const _s = parseLocalDate(_proj.startDate);
                            const _e = parseLocalDate(_proj.endDate);
                            totalDays = Math.max(1, Math.round((_e - _s) / 86400000));
                        }
                        totalDays = totalDays || 540;
                        const elapsed   = Math.max(0, Math.floor((today - sd) / 86400000));
                        overall = Math.min(99, Math.round((elapsed / totalDays) * 100));
                    }
                    const completed = all.filter(a => (a.actualPct||0) >= 100).length;
                    KALYANTRA.computed.completedActivities = completed;
                    KALYANTRA.computed.overallProgress   = Math.min(overall, 100);
                    KALYANTRA.computed.physicalProgress  = Math.min(overall + 2, 100);
                    KALYANTRA.computed.financialProgress = Math.max(overall - 4, 0);
                }
            },
            
            // ‚îÄ‚îÄ REFRESH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            refresh: function() {
                console.log('üîÑ KALYANTRA V6.6 ‚Äî refreshing...');
                this.syncFromUI.project();
                this.syncFromUI.structures();
                this.syncFromUI.hindrances();
                this.calculate.workableStretches();
                this.calculate.wbs();
                this.calculate.allActivities();
                this.calculate.progress();
                console.log('‚úÖ Refresh complete!', {
                    stretches: this.computed.workableStretches.length,
                    wbsItems:  this.computed.wbs.length,
                    activities: this.computed.totalActivities,
                    critical:  this.computed.criticalActivities,
                    progress:  this.computed.overallProgress + '%'
                });
                // Update wbsStatBar after every refresh
                if (typeof updateWBSStatBar === 'function') updateWBSStatBar();
            },
            
            // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            render: {
                wbsTable: function() {
                    const tbody = document.getElementById('wbsBody');
                    if (!tbody) return;
                    KALYANTRA.refresh();
                    const wbs  = KALYANTRA.computed.wbs;
                    const fmt  = m => { const k=Math.floor(m/1000); const r=m%1000; return `${k}+${String(r).padStart(3,'0')}`; };
                    const _sd = KALYANTRA.data.project.startDate || '2026-01-01'; const startDateObj = parseLocalDate(_sd); // FIX-LA11b
                    let offset = 0;
                    let html   = '';
                    
                    wbs.forEach(item => {
                        const bg     = item.phase===1 ? '#dcfce7' : item.phase===2 ? '#dbeafe' : '#fee2e2';
                        const scol   = item.phase===1 ? '#22c55e' : item.phase===2 ? '#3b82f6' : '#ef4444';
                        // FIX-LA04: parallel mode ‚Äî all stretches start at day 0
                        const _exMode2 = (typeof executionMode !== 'undefined') ? executionMode : 'sequential';
                        const _off2    = (_exMode2 === 'parallel' && item.type === 'stretch') ? 0 : offset;
                        const sd = addWorkingDays(startDateObj, _off2);
                        const ed = addWorkingDays(sd, item.duration||0);
                        const fDate  = d => d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'2-digit'});
                        const cpCount = item.activities.filter(a=>a.critical).length;
                        html += `<tr data-wbs="${item.wbs}" style="background:${bg};border-bottom:1px solid #e2e8f0;font-weight:600;cursor:pointer;" onclick="toggleWBSRow(this)">
                            <td style="padding:10px;width:28px;"><span class="wbs-toggle">‚ñ∂</span></td>
                            <td style="padding:10px;">${item.wbs}</td>
                            <td style="padding:10px;"><strong>${item.name}</strong>${cpCount?` <span style="background:#fee2e2;color:#991b1b;padding:2px 6px;border-radius:4px;font-size:0.7rem;font-weight:600;">${cpCount} CP</span>`:''}
                            </td>
                            <td style="padding:10px;">${item.duration||'‚Äî'}d</td>
                            <td style="padding:10px;font-size:0.85rem;">${fDate(sd)}</td>
                            <td style="padding:10px;font-size:0.85rem;">${fDate(ed)}</td>
                            <td style="padding:10px;">${item.activities.length}</td>
                            <td style="padding:10px;color:${scol};font-weight:600;">${item.status}</td>
                            <td style="padding:10px;font-weight:700;">${item.cost>0?'‚Çπ'+item.cost.toFixed(1)+'Cr':'‚Äî'}</td>
                            <td style="padding:10px;"><button style="padding:4px 10px;background:#1B3B6F;color:white;border:none;border-radius:4px;font-size:0.75rem;cursor:pointer;font-weight:600;" onclick="event.stopPropagation();viewWBSActivities('${item.wbs}')">View ‚Üí</button></td>
                        </tr>`;
                        // Child rows (hidden by default)
                        item.activities.forEach(a => {
                            html += `<tr data-parent-wbs="${item.wbs}" style="display:none;background:${item.phase===1?'#f0fdf4':item.phase===2?'#eff6ff':'#fef2f2'};">
                                <td style="padding:8px 10px;"></td>
                                <td style="padding:8px 10px;color:#64748b;font-size:0.85rem;">${a.id}</td>
                                <td style="padding:8px 10px;padding-left:28px;font-size:0.9rem;">${a.critical?'üî¥':''} ${a.name}</td>
                                <td style="padding:8px 10px;font-size:0.85rem;">${a.duration}d</td>
                                <td style="padding:8px 10px;font-size:0.85rem;">‚Äî</td>
                                <td style="padding:8px 10px;font-size:0.85rem;">‚Äî</td>
                                <td style="padding:8px 10px;font-size:0.85rem;">${a.qty?a.qty+' '+a.unit:'‚Äî'}</td>
                                <td style="padding:8px 10px;font-size:0.85rem;">${a.critical?'<span style="color:#dc2626;font-weight:600;">Critical</span>':'Normal'}</td>
                                <td style="padding:8px 10px;font-size:0.85rem;">‚Äî</td>
                                <td style="padding:8px 10px;font-size:0.85rem;color:#64748b;">${a.resource}</td>
                            </tr>`;
                        });
                        offset += item.duration || 0;
                    });
                    
                    tbody.innerHTML = html || '<tr><td colspan="10" style="text-align:center;padding:30px;color:#64748b;">No WBS items ‚Äî add structures or hindrances in Tabs 3 & 4</td></tr>';
                    
                    // Update summary bar
                    const sumEl = document.getElementById('wbsSummaryBar');
                    if (sumEl) {
                        const c = KALYANTRA.computed;
                        sumEl.innerHTML = `
                            <span style="color:#22c55e;font-weight:600;">‚úÖ ${c.workableStretches.length} Workable Stretch${c.workableStretches.length!==1?'es':''}</span>
                            <span style="margin-left:16px;color:#3b82f6;font-weight:600;">üåâ ${KALYANTRA.data.structures.length} Structure${KALYANTRA.data.structures.length!==1?'s':''}</span>
                            <span style="margin-left:16px;color:#ef4444;font-weight:600;">‚õî ${KALYANTRA.data.hindrances.filter(h=>h.status==='Pending').length} Blocked Zone${KALYANTRA.data.hindrances.filter(h=>h.status==='Pending').length!==1?'s':''}</span>
                            <span style="margin-left:16px;color:#1e293b;font-weight:600;">üìã ${c.totalActivities} Activities  |  üî¥ ${c.criticalActivities} Critical  |  ‚Çπ${c.totalCost.toFixed(1)} Cr total</span>
                        `;
                    }
                    console.log('‚úÖ WBS table rendered');
                },
                
                dashboard: function() {
                    KALYANTRA.refresh();
                    const c = KALYANTRA.computed;
                    const d = KALYANTRA.data;
                    
                    // Progress bars
                    const setBar = (id, pct) => {
                        const el = document.getElementById(id);
                        if (el) el.style.width = pct + '%';
                    };
                    const setText = (id, val) => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = val;
                    };
                    setBar('dashOverallBar',   c.overallProgress);
                    setBar('dashPhysicalBar',  c.physicalProgress);
                    setBar('dashFinancialBar', c.financialProgress);
                    setBar('dashTimeBar',      30);
                    setText('dashOverallPct',   c.overallProgress  + '%');
                    setText('dashPhysicalPct',  c.physicalProgress + '%');
                    setText('dashFinancialPct', c.financialProgress + '%');
                    
                    // Quick stats
                    setText('dashTotalActivities',  c.totalActivities);
                    setText('dashCriticalPath',      c.criticalActivities);
                    setText('dashCompleted',         c.completedActivities);
                    setText('dashTotalDuration',     c.totalDuration + 'd');
                    
                    // Phase bars
                    const p1Acts = c.activities.filter(a=>a.phase===1).length;
                    const p2Acts = c.activities.filter(a=>a.phase===2).length;
                    const p3Acts = c.activities.filter(a=>a.phase===3).length;
                    // L-09 FIX: compute each phase progress from actualPct (or time proxy)
                    const phasePct = (phaseN) => {
                        const acts = c.activities.filter(a => a.phase === phaseN);
                        if (!acts.length) return 0;
                        const hasActual = acts.some(a => typeof a.actualPct === 'number' && a.actualPct > 0);
                        if (hasActual) {
                            const w = acts.reduce((s,a) => s+(a.duration||1), 0);
                            return Math.round(acts.reduce((s,a) => s+(a.actualPct||0)*(a.duration||1), 0) / w);
                        }
                        return c.overallProgress; // same proxy for all phases if no actual data
                    };
                    const p1Pct = phasePct(1), p2Pct = phasePct(2), p3Pct = phasePct(3);
                    setBar('dashPhase1Bar', Math.min(p1Pct,100));
                    setText('dashPhase1Pct', Math.min(p1Pct,100)+'%');
                    setText('dashPhase1Acts', p1Acts + ' activities');
                    setBar('dashPhase2Bar', Math.min(p2Pct,100));
                    setText('dashPhase2Pct', Math.min(p2Pct,100)+'%');
                    setText('dashPhase2Acts', p2Acts + ' activities');
                    setBar('dashPhase3Bar', Math.min(p3Pct,100));
                    setText('dashPhase3Pct', Math.min(p3Pct,100)+'%');
                    setText('dashPhase3Acts', p3Acts + ' activities');
                    
                    // Hindrances alert
                    const activeH = d.hindrances.filter(h=>h.status==='Pending').length;
                    setText('dashHindranceCount', activeH + ' Hindrance' + (activeH!==1?'s':'') + ' Blocking Work');
                    const hAlert = document.getElementById('dashHindranceAlert');
                    if (hAlert) {
                        hAlert.style.borderLeftColor = activeH > 0 ? '#ef4444' : '#22c55e';
                        hAlert.style.background      = activeH > 0 ? '#fef2f2' : '#f0fdf4';
                    }
                    
                    // Financial
                    setText('dashTotalBudget',  '‚Çπ'+d.project.budget.toFixed(1)+' Cr');
                    const spent = +(d.project.budget * (c.financialProgress/100)).toFixed(2);
                    setText('dashSpent',     '‚Çπ'+spent+' Cr');
                    setText('dashRemaining', '‚Çπ'+(d.project.budget-spent).toFixed(2)+' Cr');
                    setBar('dashBudgetBar',  c.financialProgress);
                    setText('dashBudgetPct', c.financialProgress+'% Utilized');
                    
                    // Project name in dashboard header
                    setText('dashProjectName', d.project.name);
                    
                    // Last updated
                    setText('dashLastUpdated', 'Last Updated: ' + new Date().toLocaleString('en-IN',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}));
                    
                    console.log('‚úÖ Dashboard rendered');
                }
            },
            
            init: function() {
                console.log('');
                console.log('==========================================');
                console.log('üöÄ KALYANTRA V6.5 ‚Äî ALL AUDIT FIXES APPLIED');
                console.log('==========================================');
                // Restore from localStorage if available (S4-02)
                if (typeof this.load === 'function') this.load();
                // Sync Tab 3/4 HTML pre-loaded rows into data store first
                this.syncFromUI.structures();
                this.syncFromUI.hindrances();
                this.refresh();
                // Pre-populate Tab 1 inputs with seed values
                const seedFill = (id, val) => { const el = document.getElementById(id); if (el && !el.value) el.value = val; };
                seedFill('projectName', this.data.project.name);
                seedFill('projectCost', this.data.project.budget);
                seedFill('appointedDate', this.data.project.startDate);
                seedFill('startKm', Math.floor(this.data.project.startChainage / 1000));
                seedFill('startM',  this.data.project.startChainage % 1000);
                seedFill('endKm',   Math.floor(this.data.project.endChainage / 1000));
                seedFill('endM',    this.data.project.endChainage % 1000);
                // Seed selects (Sprint 2)
                const industryEl = document.getElementById('industryType');
                const modeEl = document.getElementById('projectMode');
                if (industryEl && !industryEl.value) industryEl.value = 'roads';
                if (modeEl     && !modeEl.value)     modeEl.value     = 'epc';
                // Seed calendar inputs (Sprint 2)
                const calHours = document.getElementById('hoursPerDay');
                const calMS    = document.getElementById('monsoonStart');
                const calME    = document.getElementById('monsoonEnd');
                if (calHours && !calHours.value) calHours.value = this.data.calendar.hoursPerDay || 8;
                if (calMS    && !calMS.value)    calMS.value    = this.data.calendar.monsoonStart || '2026-07-15';
                if (calME    && !calME.value)    calME.value    = this.data.calendar.monsoonEnd   || '2026-08-31';
                // Trigger calculated fields
                if (typeof calculateLength === 'function') calculateLength();
                if (typeof calculateCompletion === 'function') calculateCompletion();
                // Auto-render output tabs on init (U-03)
                setTimeout(() => {
                    if (typeof KALYANTRA.render !== 'undefined' && KALYANTRA.render.dashboard) KALYANTRA.render.dashboard();
                    if (typeof renderHolidayTable === 'function') renderHolidayTable();
                    if (typeof renderWorkingDaysSelector === 'function') renderWorkingDaysSelector(); // FIX-GAP04 // U-04
                    // GAP-04: Sync working day checkboxes from data
                    const _wd = KALYANTRA.data.calendar.workingDays || [1,2,3,4,5,6];
                    ['wdSun','wdMon','wdTue','wdWed','wdThu','wdFri','wdSat'].forEach((id,idx) => {
                        const el = document.getElementById(id);
                        if (el) el.checked = _wd.includes(idx);
                    });
                    if (typeof saveWorkingDays === 'function') {
                        // Update summary label only
                        const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
                        const s = document.getElementById('workingDaySummary');
                        if (s) s.textContent = _wd.length + ' days/week (' + _wd.map(d=>dayNames[d]).join(', ') + ')';
                    }
                }, 300);
                console.log('');
                console.log('üí° KALYANTRA.data     ‚Äî input data store');
                console.log('üí° KALYANTRA.computed ‚Äî derived values');
                console.log('üí° KALYANTRA.refresh()‚Äî recalculate all');
                console.log('');
            }
        };
        
        // ‚îÄ‚îÄ Live data capture from Tab 1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ================================================================
        // SPRINT 1: DATA SAVE FUNCTIONS (S1-01, S1-02)
        // ================================================================
        
        function showToast(message, type) {
            const existing = document.getElementById('kToast');
            if (existing) existing.remove();
            const colors = { success:'#16a34a', error:'#dc2626', info:'#1B3B6F', warning:'#d97706' };
            const toast = document.createElement('div');
            toast.id = 'kToast';
            toast.style.cssText = `position:fixed;bottom:24px;right:24px;background:${colors[type]||colors.info};color:white;padding:12px 20px;border-radius:8px;font-size:0.875rem;font-weight:600;font-family:Arial,sans-serif;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.3);max-width:320px;border-left:4px solid rgba(255,255,255,0.4);`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2800);
        }
        
        // S1-01: Save structure data from detail form back to KALYANTRA.data
        // FIX-GAP08: Check structure chainage against active hindrance zones
        function checkStructureHindranceOverlap(chainage) {
            return KALYANTRA.data.hindrances.filter(h => h.status !== 'Resolved')
                .find(h => chainage >= h.chainageStart && chainage <= h.chainageEnd);
        }

        function saveStructureFromForm(index) {
            if (index === undefined || index === null || !KALYANTRA.data.structures) {
                showToast('‚ö†Ô∏è No structure selected', 'warning'); return;
            }
            const idx = parseInt(index);
            if (idx < 0 || idx >= KALYANTRA.data.structures.length) {
                // New structure added dynamically - use last
                showToast('‚ö†Ô∏è Structure index out of range', 'warning'); return;
            }
            const s = KALYANTRA.data.structures[idx];
            
            // Read all editable fields from the detail form
            const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : null; };
            const getNum = (id) => { const el = document.getElementById(id); return el ? parseFloat(el.value) || 0 : 0; };
            
            // Read from any inputs with data-field attributes we set
            const detailEl = document.getElementById('structureDetailContent');
            if (detailEl) {
                const inputs = detailEl.querySelectorAll('input[data-field], select[data-field]');
                inputs.forEach(inp => {
                    const field = inp.getAttribute('data-field');
                    if (field && s.hasOwnProperty(field)) {
                        s[field] = isNaN(parseFloat(inp.value)) ? inp.value : parseFloat(inp.value);
                    }
                });
            }
            
            // L-12: Validate chainage within project range
            const pStart = KALYANTRA.data.project.startChainage;
            const pEnd   = KALYANTRA.data.project.endChainage;
            if (s.chainage && (s.chainage < pStart || s.chainage > pEnd)) {
                showToast(`‚ö†Ô∏è Structure at Ch ${(s.chainage/1000).toFixed(3)} is outside project range (${(pStart/1000).toFixed(0)}‚Äì${(pEnd/1000).toFixed(0)} km)`, 'warning');
            }
            KALYANTRA.data.structures[idx] = s;
            // FIX-GAP08: warn if structure falls inside blocked zone
            if (s.chainage !== undefined) {
                const _ov = checkStructureHindranceOverlap(s.chainage);
                if (_ov) showToast('‚ö†Ô∏è Structure at Ch ' + Math.floor(s.chainage/1000) + '+' + String(s.chainage%1000).padStart(3,'0') + ' overlaps hindrance: ' + (_ov.name||'') + '. Schedule may be affected.', 'warning');
            }
            KALYANTRA.save();    // FIX: persist structure edits
            KALYANTRA.refresh(); // FIX: recalculate WBS with updated structure
            KALYANTRA.render.wbsTable();
            console.log('üìä Structure saved:', s);
            showToast('‚úÖ Structure data saved ‚Äî WBS dates updated', 'success');
        }
        
        // S1-02: Save hindrance data from detail form
        // GAP-05 FIX: Quick hindrance status change triggers scheduling recalc
        function quickResolveHindrance(select) {
            const detailEl = document.getElementById('hindranceDetailContent');
            if (!detailEl) return;
            const idx = parseInt(detailEl.getAttribute('data-hindrance-index') || -1);
            if (idx < 0 || !KALYANTRA.data.hindrances[idx]) return;
            const h = KALYANTRA.data.hindrances[idx];
            const val = select.value;
            h.status = val === 'clear' ? 'Resolved' : (val === 'closed' ? 'Closed' : 'Pending');
            KALYANTRA.data.hindrances[idx] = h;
            KALYANTRA.save();
            KALYANTRA.refresh();
            // Update the hindrance row badge in the list
            const rows = document.querySelectorAll('#hindrancesTable tr');
            if (rows[idx]) {
                const cells = rows[idx].cells;
                if (cells[4]) {
                    const resolved = h.status === 'Resolved' || h.status === 'Closed';
                    cells[4].innerHTML = resolved
                        ? '<span style="background:rgba(34,197,94,0.1);color:#16a34a;padding:2px 8px;border-radius:4px;font-size:0.85rem;">Clear ‚úÖ</span>'
                        : '<span style="background:rgba(239,68,68,0.1);color:#ef4444;padding:2px 8px;border-radius:4px;font-size:0.85rem;">Non-Clear</span>';
                    cells[5].innerHTML = resolved
                        ? '<span style="background:rgba(34,197,94,0.1);color:#16a34a;padding:2px 8px;border-radius:4px;font-size:0.85rem;">Resolved</span>'
                        : '<span style="background:rgba(251,191,36,0.1);color:#f59e0b;padding:2px 8px;border-radius:4px;font-size:0.85rem;">Active</span>';
                }
            }
            showToast(h.status === 'Resolved' ? '‚úÖ Hindrance resolved ‚Äî zone unlocked for scheduling!' : '‚ö†Ô∏è Hindrance marked ' + h.status, h.status === 'Resolved' ? 'success' : 'warning');
        }

        // FIX-GAP05: Hindrance status management
        // FIX-GAP07: Save resolution days
        function saveHindranceResolutionDays(val) {
            const pane = document.getElementById('hindranceDetailContent');
            if (!pane) return;
            const idx = parseInt(pane.getAttribute('data-hindrance-index') || '-1');
            if (idx < 0 || !KALYANTRA.data.hindrances[idx]) return;
            KALYANTRA.data.hindrances[idx].resolutionDays = parseInt(val) || 0;
            KALYANTRA.save(); KALYANTRA.refresh();
            showToast('‚è± Resolution: ' + (val||0) + ' days saved ‚Äî WBS dates updated', 'info');
        }

        function setHindranceStatus(index, status) {
            if (!KALYANTRA.data.hindrances[index]) return;
            KALYANTRA.data.hindrances[index].status = status;
            KALYANTRA.save(); KALYANTRA.refresh(); KALYANTRA.render.wbsTable();
            const cols = { 'Pending':['#fee2e2','#dc2626','#991b1b'], 'In Progress':['#fff7ed','#ea580c','#9a3412'], 'Resolved':['#dcfce7','#16a34a','#166534'] };
            ['Pending','In Progress','Resolved'].forEach(s => {
                const btn = document.getElementById('hStat_' + index + '_' + s.replace(/ /g,''));
                if (!btn) return;
                const [bg, br, tc] = cols[s] || ['#f1f5f9','#94a3b8','#475569'];
                btn.style.background  = s === status ? bg  : 'white';
                btn.style.borderColor = s === status ? br  : '#e2e8f0';
                btn.style.color       = s === status ? tc  : '#64748b';
                btn.style.fontWeight  = s === status ? '800' : '600';
            });
            showToast('üìã Status: ' + status + (status==='Resolved' ? ' ‚Äî zone now workable!' : ''), 'success');
        }

        function saveHindranceFromForm(index) {
            const idx = parseInt(index);
            if (isNaN(idx) || !KALYANTRA.data.hindrances || idx >= KALYANTRA.data.hindrances.length) {
                showToast('‚ö†Ô∏è No hindrance selected', 'warning'); return;
            }
            const h = KALYANTRA.data.hindrances[idx];
            
            // Read chainage from the IDs we already have
            const fromKm = parseFloat(document.getElementById('fromKm') && document.getElementById('fromKm').value) || 0;
            const fromM  = parseFloat(document.getElementById('fromM')  && document.getElementById('fromM').value)  || 0;
            const toKm   = parseFloat(document.getElementById('toKm')   && document.getElementById('toKm').value)   || 0;
            const toM    = parseFloat(document.getElementById('toM')    && document.getElementById('toM').value)    || 0;
            
            if (fromKm > 0 || toKm > 0) {
                h.chainageStart = fromKm * 1000 + fromM;
                h.chainageEnd   = toKm   * 1000 + toM;
            }
            
            // Read status from landStatusSelect if present
            const landSel = document.getElementById('landStatusSelect');
            if (landSel) {
                h.status = landSel.value === 'clear' ? 'Resolved' : 'Pending';
            }
            
            // Read any data-field attributes
            const detailEl = document.getElementById('hindranceDetailContent');
            if (detailEl) {
                const inputs = detailEl.querySelectorAll('input[data-field], select[data-field]');
                inputs.forEach(inp => {
                    const field = inp.getAttribute('data-field');
                    if (field && h.hasOwnProperty(field)) {
                        h[field] = inp.value;
                    }
                });
            }
            
            KALYANTRA.data.hindrances[idx] = h;
            KALYANTRA.save();    // FIX: persist hindrance edits
            KALYANTRA.refresh(); // FIX: recalculate WBS with updated hindrance
            KALYANTRA.render.wbsTable();
            console.log('üìä Hindrance saved:', h);
            showToast('‚úÖ Hindrance data saved ‚Äî WBS dates updated', 'success');
        }
        
        // S1-02: Live chainage update on input change
        function liveHindranceChainageUpdate() {
            const detailEl = document.getElementById('hindranceDetailContent');
            if (!detailEl) return;
            const idx = parseInt(detailEl.getAttribute('data-hindrance-index') || -1);
            if (idx < 0) return;
            const fromKm = parseFloat(document.getElementById('fromKm').value) || 0;
            const fromM  = parseFloat(document.getElementById('fromM').value)  || 0;
            const toKm   = parseFloat(document.getElementById('toKm').value)   || 0;
            const toM    = parseFloat(document.getElementById('toM').value)    || 0;
            if (idx < KALYANTRA.data.hindrances.length) {
                KALYANTRA.data.hindrances[idx].chainageStart = fromKm * 1000 + fromM;
                KALYANTRA.data.hindrances[idx].chainageEnd   = toKm   * 1000 + toM;
                console.log('üìä Hindrance chainage live-updated:', KALYANTRA.data.hindrances[idx]);
            }
        }
        
        // ================================================================
        // SPRINT 1: RENDER ACTIVITIES TABLE (S1-03)
        // ================================================================
        
        function renderActivitiesTable() {
            KALYANTRA.refresh();
            const tbody = document.getElementById('activitiesBody');
            if (!tbody) return;
            
            const activities = KALYANTRA.computed.activities;
            const wbs        = KALYANTRA.computed.wbs;
            
            // Rebuild filter dropdown
            const filterSel = document.getElementById('activityFilter');
            if (filterSel) {
                const currentVal = filterSel.value;
                filterSel.innerHTML = '<option value="all">All Activities (' + activities.length + ')</option>';
                wbs.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.wbs;
                    const phaseIcon = item.phase === 1 ? 'üü¢' : item.phase === 2 ? 'üîµ' : 'üî¥';
                    opt.textContent = phaseIcon + ' ' + item.wbs + ' ' + item.name;
                    filterSel.appendChild(opt);
                });
                filterSel.value = currentVal || 'all';
            }
            
            if (!activities.length) {
                tbody.innerHTML = '<tr><td colspan="9" style="padding: 20px; text-align: center; color: #94a3b8; font-style: italic;">No activities generated yet. Add structures/hindrances and refresh.</td></tr>';
                return;
            }
            
            // Render activity rows
            const projectStart = parseLocalDate(KALYANTRA.data.project.startDate || '2026-01-01');
            let dayOffset = 0;
            // FIX-LA04b: parallel mode ‚Äî stretch activities start at day 0
            const _raExecMode = (typeof executionMode !== 'undefined') ? executionMode : 'sequential';
            let prevWbs = null;
            let parallelBaseOffset = 0; // LA-04: for parallel mode, track per-WBS start offset
            let html = '';
            
            activities.forEach((act, i) => {
                // LA-04: When WBS changes in parallel mode, advance base offset by max duration of prior WBS
                if (executionMode === 'parallel' && act.wbs !== prevWbs) {
                    const priorMaxDur = activities.filter(a => a.wbs === prevWbs).reduce((m,a)=>Math.max(m,a.duration||0),0);
                    if (prevWbs !== null) parallelBaseOffset += priorMaxDur;
                }
                const phaseColors = { 1: '#dcfce7', 2: '#dbeafe', 3: '#fee2e2' };
                const phaseBorder = { 1: '#22c55e', 2: '#3b82f6', 3: '#ef4444' };
                const bg = act.critical ? 'rgba(220,38,38,0.04)' : (i % 2 === 0 ? '#fff' : '#f8fafc');
                const crFlag = act.critical ? '<span style="color:#dc2626;font-weight:700;" title="Critical Path">üî¥</span>' : '<span style="color:#94a3b8;">‚ö™</span>';
                
                // LA-04 FIX: respect executionMode in activity dates
                // parallel = same-phase activities start at phase start; sequential = accumulate
                let actStart;
                if (executionMode === 'parallel') {
                    // All activities within same WBS group start at the group's start offset
                    actStart = new Date(projectStart); actStart.setDate(actStart.getDate() + (parallelBaseOffset || 0));
                } else {
                    actStart = new Date(projectStart); actStart.setDate(actStart.getDate() + dayOffset);
                }
                const startD = actStart;
                const endD   = new Date(startD); endD.setDate(endD.getDate() + (act.duration || 5));
                const fmt = d => d.toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'2-digit'});
                dayOffset += act.duration || 5;
                
                // Phase group header if new WBS item
                // FIX-LA04c: parallel mode ‚Äî don't accumulate offset for stretches
                if (_raExecMode === 'parallel' && act.type === 'stretch' && act.wbs !== prevWbs) dayOffset = 0;
                if (act.wbs !== prevWbs) {
                    const wbsItem = wbs.find(w => w.wbs === act.wbs);
                    if (wbsItem) {
                        const phBg = phaseColors[act.phase] || '#f8fafc';
                        const phBd = phaseBorder[act.phase] || '#cbd5e1';
                        html += `<tr data-wbs="${act.wbs}" style="background:${phBg};border-left:4px solid ${phBd};">
                            <td colspan="9" style="padding:8px 12px;font-weight:700;font-size:0.8rem;color:#475569;">
                                ${act.phase === 1 ? 'üü¢' : act.phase === 2 ? 'üîµ' : 'üî¥'} ${act.wbs} ‚Äî ${wbsItem.name}
                                <span style="float:right;font-weight:400;color:#64748b;">${wbsItem.activities.length} activities ¬∑ ${wbsItem.duration}d ¬∑ ‚Çπ${wbsItem.cost.toFixed(1)} Cr</span>
                            </td>
                        </tr>`;
                        prevWbs = act.wbs;
                    }
                }
                
                html += `<tr data-wbs="${act.wbs}" style="background:${bg};border-bottom:1px solid #f1f5f9;transition:background 0.15s;" onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='${bg}'">
                    <td style="padding:8px 10px;font-size:0.85rem;font-weight:600;color:#475569;">${act.wbs}.${act.id ? act.id.split('.').pop() || (i+1) : (i+1)}</td>
                    <td style="padding:8px 10px;font-size:0.85rem;">${crFlag} ${act.name}</td>
                    <td style="padding:8px 10px;font-size:0.85rem;color:#64748b;">${act.wbsName || '‚Äî'}</td>
                    <td style="padding:8px 10px;font-size:0.85rem;">${act.qty > 0 ? act.qty.toLocaleString() : '‚Äî'}</td>
                    <td style="padding:8px 10px;font-size:0.85rem;color:#64748b;">${act.unit || '‚Äî'}</td>
                    <td style="padding:8px 10px;font-size:0.85rem;">${act.duration || '‚Äî'}d</td>
                    <td style="padding:8px 10px;font-size:0.85rem;color:#475569;">${fmt(startD)}</td>
                    <td style="padding:8px 10px;font-size:0.85rem;color:#475569;">${fmt(endD)}</td>
                    <td style="padding:6px 8px;text-align:center;">
                        <div style="display:flex;flex-direction:column;align-items:center;gap:3px;">
                            <div style="display:flex;align-items:center;gap:6px;">
                                <input type="range" min="0" max="100" step="5"
                                    value="${(KALYANTRA.data.activityProgress&&KALYANTRA.data.activityProgress[act.wbs+'.'+act.id])||act.actualPct||0}"
                                    style="width:70px;accent-color:#1B3B6F;cursor:pointer;"
                                    oninput="updateActivityProgress(this,'${act.wbs}','${act.id}',this.value); this.nextElementSibling.textContent=this.value+'%'; this.parentElement.nextElementSibling.style.width=this.value+'%'; this.parentElement.nextElementSibling.style.background=this.value>=100?'#16a34a':this.value>=50?'#D4AF37':'#1B3B6F';"
                                />
                                <span style="font-size:0.78rem;font-weight:700;color:#1B3B6F;min-width:32px;">${(KALYANTRA.data.activityProgress&&KALYANTRA.data.activityProgress[act.wbs+'.'+act.id])||act.actualPct||0}%</span>
                            </div>
                            <!-- UA-02 FIX: Mini progress bar for visual scan -->
                            <div style="width:100%;height:4px;background:#e2e8f0;border-radius:2px;overflow:hidden;">
                                <div style="height:100%;border-radius:2px;transition:width 0.2s;background:${((KALYANTRA.data.activityProgress&&KALYANTRA.data.activityProgress[act.wbs+'.'+act.id])||act.actualPct||0)>=100?'#16a34a':'#1B3B6F'};width:${(KALYANTRA.data.activityProgress&&KALYANTRA.data.activityProgress[act.wbs+'.'+act.id])||act.actualPct||0}%;" ></div></div>
                                <div style="display:none;width:${act.actualPct||0}%;height:100%;border-radius:2px;background:${(act.actualPct||0)>=100?'#16a34a':(act.actualPct||0)>=50?'#D4AF37':'#1B3B6F'};transition:width 0.3s ease;"></div>
                            </div>
                        </div>
                    </td>
                </tr>`;
            });
            
            tbody.innerHTML = html;
            
            // Update count display
            const countEl = document.getElementById('activityCount');
            if (countEl) countEl.textContent = activities.length;
            
            // Apply current filter
            filterActivities();
            console.log('‚úÖ Activities table rendered:', activities.length, 'rows');
        }
        
        // ================================================================
        // SPRINT 1: DYNAMIC GANTT RENDERER (S1-05)
        // ================================================================
        
        let ganttZoomLevel    = 1.0;
        let ganttShowCritical = true;
        
        function renderGantt() {
            KALYANTRA.refresh();
            const wbs        = KALYANTRA.computed.wbs;
            const activities = KALYANTRA.computed.activities;
            const listEl     = document.getElementById('ganttActivityList');
            const timelineEl = document.getElementById('ganttTimeline');
            if (!listEl || !timelineEl) return;
            
            if (!wbs.length) {
                listEl.innerHTML = '<div style="padding:20px;color:#94a3b8;font-style:italic;">No WBS data. Configure project and refresh.</div>';
                timelineEl.innerHTML = '';
                return;
            }
            
            // Calculate project date range
            const projectStart = parseLocalDate(KALYANTRA.data.project.startDate || '2026-01-01');
            const totalDays    = Math.max(KALYANTRA.computed.totalDuration, 90);
            const projectEnd   = new Date(projectStart);
            projectEnd.setDate(projectEnd.getDate() + totalDays);
            
            // Build rows: WBS header + activity rows
            const rows = [];
            let globalDayOffset = 0;
            
            wbs.forEach(item => {
                // L-10: parallel mode = all stretches start at day 0
                const itemStart = (executionMode === 'parallel' && item.type === 'stretch')
                    ? 0 : globalDayOffset;
                rows.push({ type: 'header', item, startDay: itemStart, endDay: itemStart + item.duration });
                let localOffset = 0;
                item.activities.forEach(act => {
                    rows.push({ type: 'activity', act, item, startDay: itemStart + localOffset, endDay: itemStart + localOffset + act.duration });
                    localOffset += act.duration;
                });
                if (item.type === 'stretch') globalDayOffset += item.duration;
            });
            
            // Timeline column widths
            const dayWidth = Math.max(14 * ganttZoomLevel, 6);
            const timelineWidth = totalDays * dayWidth + 40;
            const rowH = 32;
            
            // Build month headers
            let monthHeaders = '<div style="display:flex;background:#f1f5f9;border-bottom:2px solid #cbd5e1;position:sticky;top:0;z-index:10;">';
            const today = new Date();
            let curDate = new Date(projectStart);
            let prevMonth = -1;
            const monthSpans = {};
            
            for (let d = 0; d < totalDays; d++) {
                const m = curDate.getMonth();
                if (!monthSpans[m]) monthSpans[m] = { label: curDate.toLocaleDateString('en-GB',{month:'short',year:'numeric'}), days: 0, start: d };
                monthSpans[m].days++;
                curDate.setDate(curDate.getDate() + 1);
            }
            Object.values(monthSpans).forEach(ms => {
                monthHeaders += `<div style="width:${ms.days * dayWidth}px;min-width:${ms.days * dayWidth}px;padding:6px 8px;font-size:0.75rem;font-weight:700;color:#475569;border-right:1px solid #cbd5e1;white-space:nowrap;overflow:hidden;text-transform:uppercase;">${ms.label}</div>`;
            });
            monthHeaders += '</div>';
            
            // Today line position
            const todayDay = Math.floor((today - projectStart) / 86400000);
            const todayX   = todayDay * dayWidth + 20;
            
            // Build rows HTML
            let listHTML     = '<div style="padding:8px 12px;background:#f1f5f9;border-bottom:2px solid #cbd5e1;font-size:0.75rem;font-weight:700;color:#475569;text-transform:uppercase;position:sticky;top:0;z-index:10;">Activity Hierarchy</div>';
            let timelineHTML = monthHeaders + `<div style="position:relative;min-width:${timelineWidth}px;">`;
            
            // Today line
            if (todayDay >= 0 && todayDay <= totalDays) {
                timelineHTML += `<div style="position:absolute;left:${todayX}px;top:0;bottom:0;width:2px;background:rgba(220,38,38,0.6);z-index:5;pointer-events:none;">
                    <div style="position:absolute;top:0;left:-18px;background:#dc2626;color:white;font-size:10px;padding:1px 4px;border-radius:3px;white-space:nowrap;">TODAY</div>
                </div>`;
            }
            
            rows.forEach((row, ri) => {
                const top = ri * rowH;
                
                if (row.type === 'header') {
                    const phColors = { 1:['#ecfdf5','#166534','#22c55e'], 2:['#eff6ff','#1e40af','#3b82f6'], 3:['#fef2f2','#991b1b','#ef4444'] };
                    const [bg,tc,bc] = phColors[row.item.phase] || ['#f8fafc','#475569','#94a3b8'];
                    listHTML += `<div style="padding:6px 12px;background:${bg};border-bottom:2px solid ${bc};border-left:4px solid ${bc};font-weight:700;font-size:0.75rem;color:${tc};">${row.item.phase===1?'üü¢':row.item.phase===2?'üîµ':'üî¥'} ${row.item.wbs} ${row.item.name.length > 28 ? row.item.name.substring(0,28)+'‚Ä¶' : row.item.name}</div>`;
                    const barW = Math.max((row.endDay - row.startDay) * dayWidth, 8);
                    const barX = row.startDay * dayWidth + 20;
                    timelineHTML += `<div style="position:absolute;top:${top+4}px;left:${barX}px;width:${barW}px;height:24px;background:${bc};opacity:0.25;border-radius:4px;" title="${row.item.name}"></div>`;
                } else {
                    const act    = row.act;
                    const isCrit = act.critical && ganttShowCritical;
                    const barColor = isCrit ? '#dc2626' : (row.item.phase === 2 ? '#3b82f6' : '#1B3B6F');
                    const barW   = Math.max((row.endDay - row.startDay) * dayWidth - 2, 6);
                    const barX   = row.startDay * dayWidth + 20;
                    const rowBg  = ri % 2 === 0 ? '#ffffff' : '#f8fafc';
                    
                    listHTML += `<div style="padding:5px 12px 5px 28px;border-bottom:1px solid #f1f5f9;background:${rowBg};font-size:0.78rem;color:${isCrit?'#dc2626':'#334155'};font-weight:${isCrit?'600':'400'};white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${act.name}">${isCrit?'üî¥ ':''}${act.name} (${act.duration}d)</div>`;
                    timelineHTML += `<div style="position:absolute;top:${top+6}px;left:${barX}px;width:${barW}px;height:20px;background:${barColor};border-radius:3px;cursor:pointer;display:flex;align-items:center;padding:0 4px;overflow:hidden;" title="${act.name} | ${act.duration}d | ${act.resource||'‚Äî'}">
                        <span style="color:white;font-size:10px;font-weight:600;white-space:nowrap;overflow:hidden;">${act.name.split(' ')[0]}</span>
                    </div>`;
                    // Row background stripe
                    timelineHTML += `<div style="position:absolute;top:${top}px;left:0;right:0;height:${rowH}px;background:${rowBg};z-index:-1;"></div>`;
                }
            });
            
            timelineHTML += '</div>';
            
            listEl.innerHTML     = listHTML;
            timelineEl.innerHTML = timelineHTML;
            timelineEl.style.minWidth = timelineWidth + 'px';
            
            console.log('‚úÖ Gantt rendered:', rows.length, 'rows,', Math.round(ganttZoomLevel*100) + '% zoom');
        }
        
        function ganttZoomIn()  { ganttZoomLevel = Math.min(ganttZoomLevel * 1.3, 4); document.getElementById('ganttZoomLabel').textContent = Math.round(ganttZoomLevel*100)+'%'; renderGantt(); }
        function ganttZoomOut() { ganttZoomLevel = Math.max(ganttZoomLevel / 1.3, 0.3); document.getElementById('ganttZoomLabel').textContent = Math.round(ganttZoomLevel*100)+'%'; renderGantt(); }
        function ganttFit()     { ganttZoomLevel = 1.0; document.getElementById('ganttZoomLabel').textContent = '100%'; renderGantt(); }
        function ganttToggleCritical() {
            ganttShowCritical = !ganttShowCritical;
            const btn = document.getElementById('ganttCriticalBtn');
            if (btn) { btn.style.background = ganttShowCritical ? '#fee2e2' : 'white'; btn.style.color = ganttShowCritical ? '#991b1b' : '#64748b'; }
            renderGantt();
        }

        // L-10: Sequential vs Parallel execution model toggle
        let lsmInitialized  = false;  // FIX-UA09: prevent listener accumulation
        let selectedTCSIndex = 0;     // FIX-UA06: remember last TCS row
        let executionMode = 'sequential'; // 'sequential' | 'parallel'
        function toggleExecutionMode() {
            executionMode = executionMode === 'sequential' ? 'parallel' : 'sequential';
            const btn = document.getElementById('execModeBtn');
            if (btn) {
                btn.textContent = executionMode === 'parallel' ? '‚ö° Parallel' : '‚ö° Sequential';
                btn.style.background = executionMode === 'parallel' ? '#FBF6E3' : '#EBF0FA';
                btn.style.borderColor = executionMode === 'parallel' ? '#D4AF37' : '#1B3B6F';
                btn.style.color       = executionMode === 'parallel' ? '#92700A' : '#1B3B6F';
            }
            renderGantt();
            showToast(executionMode === 'parallel'
                ? '‚ö° Parallel mode: all stretches start on day 1'
                : '‚ö° Sequential mode: stretches execute one after another', 'info');
        }
        
        // ================================================================
        // SPRINT 1: RENDER FUNCTIONS WIRED TO KALYANTRA + WBS STAT BAR
        // ================================================================
        
        // Update wbsStatBar after wbsTable render
        function updateWBSStatBar() {
            const c = KALYANTRA.computed;
            const el = document.getElementById('wbsStatBar');
            if (!el) return;
            const phases  = [...new Set(c.wbs.map(w => w.phase))].length;
            el.innerHTML  = `<strong>${phases}</strong> Phases &nbsp;‚Ä¢&nbsp; <strong>${c.totalActivities}</strong> Activities &nbsp;‚Ä¢&nbsp; <strong style="color:#dc2626;">${c.criticalActivities}</strong> Critical`;
        }
        
        // ================================================================
        // SPRINT 3 S3-04: addWorkingDays() ‚Äî calendar-aware scheduling
        // ================================================================
        // FIX: parseLocalDate prevents UTC‚ÜíIST 1-day shift on all date math
        function parseLocalDate(str) {
            if (!str) return new Date();
            const p = str.split('-');
            if (p.length === 3) return new Date(+p[0], +p[1]-1, +p[2]);
            return new Date(str);
        }

        function addWorkingDays(startDate, days, monsoonSensitive) {
            const d = parseLocalDate(startDate);
            if (!days || days <= 0) return d;
            const cal = KALYANTRA.data.calendar;
            const mStart = cal.monsoonStart ? new Date(cal.monsoonStart) : null;
            const mEnd   = cal.monsoonEnd   ? new Date(cal.monsoonEnd)   : null;
            const holidays = (cal.holidays || []).map(h => new Date(h).toDateString());
            const workDays = (cal.workingDays && cal.workingDays.length) ? cal.workingDays : [1,2,3,4,5,6];
            let added = 0;
            while (added < days) {
                d.setDate(d.getDate() + 1);
                const day = d.getDay(); // 0=Sun
                if (!workDays.includes(day)) continue; // L-08: use workingDays array
                // Skip monsoon
                // FIX-LA07: monsoonSensitive:false = structure activities skip monsoon check
                if ((monsoonSensitive !== false) && mStart && mEnd && d >= mStart && d <= mEnd) continue;
                // Skip holidays
                if (holidays.includes(d.toDateString())) continue;
                added++;
            }
            return d;
        }

        // ================================================================
        // SPRINT 3 S3-01: renderProgressTab() ‚Äî dynamic Tab 9
        // ================================================================
        // FIX-GAP06: Dynamic milestone tracker from KALYANTRA.data.milestones
        function renderMilestoneTracker() {
            const el = document.getElementById('milestoneTrackerBody');
            if (!el) return;
            const mils = KALYANTRA.data.milestones || [];
            const today = new Date();
            const overall = KALYANTRA.computed.overallProgress || 0;
            const rows = [{ icon:'‚úÖ', label:'Project Start', date: KALYANTRA.data.project.startDate || '2026-01-01', pct:0, bg:'#dcfce7', col:'#166534', badge:'Achieved' }];
            mils.forEach((m, i) => {
                const td = m.targetDate ? new Date(m.targetDate) : null;
                const isPast = td && td < today;
                const isDue  = td && !isPast && (td - today) < 30 * 86400000;
                const isAch  = overall >= (m.completion || 0);
                const badge  = isAch ? 'Achieved' : (isPast ? 'Delayed' : isDue ? 'Due Soon' : 'Upcoming');
                const st = { Achieved:['#dcfce7','#166534'], Delayed:['#fee2e2','#991b1b'], 'Due Soon':['#fff7ed','#9a3412'], Upcoming:['#dbeafe','#1e40af'] }[badge] || ['#f1f5f9','#475569'];
                rows.push({ icon: isAch?'‚úÖ':isPast?'üî¥':isDue?'üü°':'üîµ', label: m.description || ('Milestone '+(i+1)), date: m.targetDate || '‚Äî', pct: m.completion||0, bg:st[0], col:st[1], badge });
            });
            el.innerHTML = rows.map(r => `<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;padding:8px;border-radius:6px;background:${r.bg}22;">
                <span style="font-size:1.2rem;">${r.icon}</span>
                <div style="flex:1;"><div style="font-weight:600;font-size:0.85rem;color:#1e293b;">${r.label}</div>
                <div style="font-size:0.78rem;color:#64748b;">Target: ${r.date}${r.pct?' ¬∑ '+r.pct+'% complete':''}</div></div>
                <span style="background:${r.bg};color:${r.col};padding:2px 8px;border-radius:10px;font-size:0.73rem;font-weight:700;">${r.badge}</span></div>`).join('');
        }

        function renderProgressTab() {
            try {
                KALYANTRA.refresh();
                // FIX-UA10: show empty state if no activities generated yet
                if (!KALYANTRA.computed.activities || KALYANTRA.computed.activities.length === 0) {
                    const _c9 = document.querySelector('#tab9 .content-container') || document.getElementById('tab9');
                    if (_c9 && !_c9.querySelector('.ua10-empty')) {
                        const _e = document.createElement('div'); _e.className = 'ua10-empty';
                        _e.style.cssText = 'padding:40px;text-align:center;color:#64748b;background:#f8fafc;border-radius:10px;margin:20px;';
                        _e.innerHTML = '<div style="font-size:2rem;margin-bottom:12px;">üìä</div><strong>No schedule yet.</strong><br><br>Open <strong>Tab 7 ‚Äî Activity Grid</strong> to generate the schedule first, then return here.';
                        _c9.prepend(_e);
                    }
                    return;
                }
                document.querySelectorAll('.ua10-empty').forEach(el => el.remove());
                if (typeof renderMilestoneTracker === 'function') renderMilestoneTracker(); // FIX-GAP06
                const c = KALYANTRA.computed;
                const d = KALYANTRA.data;
                const proj = d.project;

                // U-09: Read period selector
                const periodEl = document.getElementById('progressPeriodSelect');
                const period   = periodEl ? periodEl.value : 'project';

                // Compute overall progress from WBS phases
                const totalActs = c.activities.length || 1;
                const phases = [...new Set(c.wbs.map(w => w.phase))];
                const phaseCount = phases.length || 1;

                // Use real progress if available, otherwise time-elapsed proxy
                // FIX: parseLocalDate prevents UTC‚ÜíIST 1-day shift; endDate drives totalDays
                const startDate = parseLocalDate(proj.startDate || '2026-01-01');
                const today     = new Date();
                let totalDays   = proj.duration || 0;
                if (!totalDays && proj.endDate && proj.startDate) {
                    const _e2rpt = parseLocalDate(proj.endDate);
                    totalDays = Math.max(1, Math.floor((_e2rpt - startDate) / 86400000));
                }
                totalDays = totalDays || 540;
                const elapsedDays = Math.max(0, Math.floor((today - startDate) / 86400000));
                let periodDays = elapsedDays;
                if (period === '30')  periodDays = Math.min(elapsedDays, 30);
                else if (period === '60') periodDays = Math.min(elapsedDays, 60);
                else if (period === '90') periodDays = Math.min(elapsedDays, 90);
                const overallPct = c.overallProgress > 0
                    ? c.overallProgress
                    : Math.min(99, Math.round((periodDays / totalDays) * 100));

                // FIX-GAP10: SPI = actual progress / planned progress
                const plannedPct    = Math.min(100, Math.round((elapsedDays / Math.max(1, totalDays)) * 100));
                const SPI           = plannedPct > 0 ? +(overallPct / plannedPct).toFixed(2) : 1.0;
                const SPIColor      = SPI >= 1 ? '#16a34a' : SPI >= 0.9 ? '#d97706' : '#dc2626';
                const SPILabel      = SPI >= 1 ? 'On Track' : SPI >= 0.9 ? 'Slight Delay' : 'Behind Schedule';

                // Phase-wise breakdown (simple proportional)
                const phase1Pct = Math.min(100, Math.round(overallPct * 1.4));
                const phase2Pct = Math.min(100, Math.round(overallPct * 0.9));
                const phase3Pct = Math.min(100, Math.round(overallPct * 0.5));

                // Work-type breakdown
                const earthPct  = Math.min(100, Math.round(phase1Pct * 0.9));
                const structPct = Math.min(100, Math.round(overallPct * 0.6));
                const pavePct   = Math.min(100, Math.round(phase2Pct * 0.7));
                const drainPct  = Math.min(100, Math.round(phase3Pct * 0.8));

                // Hindrance impact
                const pendingH  = d.hindrances.filter(h => h.status !== 'Resolved').length;
                const blockedPct = Math.min(30, pendingH * 8);

                // Update progress-by-work-type bars
                const bars = {
                    'Earthwork':   { pct: earthPct,  color: 'linear-gradient(to right,#f59e0b,#d97706)' },
                    'Structures':  { pct: structPct, color: 'linear-gradient(to right,#3b82f6,#2563eb)' },
                    'Pavement':    { pct: pavePct,   color: 'linear-gradient(to right,#22c55e,#16a34a)' },
                    'Drainage':    { pct: drainPct,  color: 'linear-gradient(to right,#8b5cf6,#7c3aed)' },
                };

                // Build progress-by-work-type HTML
                let workTypeHTML = Object.entries(bars).map(([name, info]) => `
                    <div style="margin-bottom:18px;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                            <span style="font-size:0.875rem;font-weight:500;color:#475569;">${name}</span>
                            <span style="font-size:0.875rem;font-weight:700;color:#1e293b;">${info.pct}%</span>
                        </div>
                        <div style="width:100%;height:10px;background:#e2e8f0;border-radius:5px;overflow:hidden;">
                            <div style="width:${info.pct}%;height:100%;background:${info.color};border-radius:5px;transition:width 0.6s ease;"></div>
                        </div>
                    </div>`).join('');

                // Build milestone tracker from KALYANTRA.data.milestones
                let milestoneHTML = '';
                if (d.milestones && d.milestones.length > 0) {
                    milestoneHTML = d.milestones.map(m => {
                        const mDate = new Date(m.targetDate || '');
                        const isPast = mDate < today;
                        const icon  = isPast ? '‚úÖ' : (m.completion > 0 ? 'üîµ' : '‚ö™');
                        const badge = isPast ? 'background:#dcfce7;color:#166534' : (m.completion > 0 ? 'background:#dbeafe;color:#1e40af' : 'background:#f1f5f9;color:#64748b');
                        const label = isPast ? 'Completed' : (m.completion > 0 ? 'In Progress' : 'Pending');
                        const dStr  = mDate.toLocaleDateString ? mDate.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}) : m.targetDate;
                        return `<div style="margin-bottom:16px;">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <span style="font-size:1.5rem;">${icon}</span>
                                <div style="flex:1;">
                                    <div style="font-weight:600;font-size:0.875rem;color:#1e293b;">${m.description}</div>
                                    <div style="font-size:0.8125rem;color:#64748b;">Target: ${dStr} ¬∑ ${m.completion}%</div>
                                </div>
                                <span style="padding:4px 10px;border-radius:12px;font-size:0.75rem;font-weight:600;${badge}">${label}</span>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    // Default milestones from project data
                    const pStart = parseLocalDate(proj.startDate || '2026-01-01');
                    const _pDur = proj.duration || (proj.endDate && proj.startDate ? Math.max(1, Math.round((parseLocalDate(proj.endDate) - parseLocalDate(proj.startDate)) / 86400000)) : 540);
                    const pEnd   = addWorkingDays(pStart, _pDur);
                    milestoneHTML = `
                        <div style="margin-bottom:16px;">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <span style="font-size:1.5rem;">${parseLocalDate(proj.startDate) < today ? '‚úÖ' : '‚ö™'}</span>
                                <div style="flex:1;"><div style="font-weight:600;font-size:0.875rem;color:#1e293b;">Project Start</div>
                                <div style="font-size:0.8125rem;color:#64748b;">${pStart.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})}</div></div>
                                <span style="background:#dcfce7;color:#166534;padding:4px 10px;border-radius:12px;font-size:0.75rem;font-weight:600;">Completed</span>
                            </div>
                        </div>
                        <div style="margin-bottom:16px;">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <span style="font-size:1.5rem;">üîµ</span>
                                <div style="flex:1;"><div style="font-weight:600;font-size:0.875rem;color:#1e293b;">Phase 1 Completion</div>
                                <div style="font-size:0.8125rem;color:#64748b;">Target: ${addWorkingDays(pStart,180).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})}</div></div>
                                <span style="background:#dbeafe;color:#1e40af;padding:4px 10px;border-radius:12px;font-size:0.75rem;font-weight:600;">In Progress</span>
                            </div>
                        </div>
                        <div>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <span style="font-size:1.5rem;">‚ö™</span>
                                <div style="flex:1;"><div style="font-weight:600;font-size:0.875rem;color:#1e293b;">Project Completion</div>
                                <div style="font-size:0.8125rem;color:#64748b;">Target: ${pEnd.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})}</div></div>
                                <span style="background:#f1f5f9;color:#64748b;padding:4px 10px;border-radius:12px;font-size:0.75rem;font-weight:600;">Pending</span>
                            </div>
                        </div>`;
                }

                // Chainage progress bar
                const totalLen = (proj.endChainage - proj.startChainage) / 1000;
                const wsLen    = c.workableStretches.reduce((s,w) => s + w.length, 0);
                const blkLen   = totalLen - wsLen;
                const compPct  = Math.round((wsLen * overallPct/100) / (totalLen || 1) * 100);
                const blkPctBar= Math.round((blkLen / (totalLen || 1)) * 100);
                const ch = km => `Ch ${Math.floor(km)}+${String(Math.round((km%1)*1000)).padStart(3,'0')}`;

                // Build chain labels
                const chainLabels = [];
                const step = Math.round(totalLen / 5) || 1;
                for (let k = 0; k <= 5; k++) {
                    chainLabels.push(ch((proj.startChainage/1000) + k * step));
                }

                // Build full Tab 9 HTML
                const tab9Content = document.querySelector('#tab9 .content-container');
                if (!tab9Content) return;
                // UA-10 FIX: Guard for empty activities array - show placeholder instead of broken zeros
                if (!d.activities || (KALYANTRA.computed.activities.length === 0 && !KALYANTRA.data.tcs)) {
                    tab9Content.innerHTML = '<div style="padding:40px;text-align:center;color:#94a3b8;"><p style="font-size:1.1rem;">üìä No project data yet.</p><p style="margin-top:8px;">Complete Tabs 1‚Äì7 first to generate progress data.</p></div>';
                    return;
                }

                tab9Content.innerHTML = `
                    <!-- S-Curve + overall progress -->
                    <div style="background:white;border-radius:8px;padding:28px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:24px;">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;">
                            <h4 style="margin:0;color:#1e293b;font-size:1.125rem;font-weight:600;">Progress S-Curve (Planned vs Actual)</h4>
                            <div style="text-align:right;">
                                <div style="font-size:2rem;font-weight:700;color:#1B3B6F;">${overallPct}%</div>
                                <div style="font-size:0.8rem;color:#64748b;">Overall Progress ¬∑ Day ${elapsedDays}/${totalDays}</div>
                                <div style="margin-top:6px;display:flex;gap:8px;align-items:center;justify-content:flex-end;">
                                    <span style="font-size:0.8rem;color:#64748b;">SPI:</span>
                                    <span style="font-size:1.1rem;font-weight:800;color:${SPIColor};">${SPI}</span>
                                    <span style="font-size:0.72rem;padding:2px 7px;border-radius:10px;background:${SPIColor}22;color:${SPIColor};font-weight:700;">${SPILabel}</span>
                                </div>
                                <div style="font-size:0.72rem;color:#94a3b8;margin-top:2px;">Planned: ${plannedPct}% ¬∑ Actual: ${overallPct}%</div>
                            </div>
                        </div>
                        <div id="prog9ScurveContainer" style="position:relative;height:280px;background:#fafbfc;border:1px solid #e2e8f0;border-radius:6px;overflow:hidden;">
                            <!-- SVG injected by renderSCurve() -->
                        </div>
                    </div>

                    <!-- Progress by Work Type + Milestone Tracker -->
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:24px;">
                        <div style="background:white;border-radius:8px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                            <h4 style="margin:0 0 20px 0;color:#1e293b;font-size:1rem;font-weight:600;border-bottom:2px solid #e5e7eb;padding-bottom:12px;">
                                Progress by Work Type
                                <span style="font-size:0.75rem;font-weight:500;color:#64748b;margin-left:8px;">${pendingH} active hindrance${pendingH!==1?'s':''}</span>
                            </h4>
                            ${workTypeHTML}
                        </div>
                        <div style="background:white;border-radius:8px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                            <h4 style="margin:0 0 20px 0;color:#1e293b;font-size:1rem;font-weight:600;border-bottom:2px solid #e5e7eb;padding-bottom:12px;">Milestone Tracker</h4>
                            ${milestoneHTML}
                        </div>
                    </div>

                    <!-- Phase breakdown bars -->
                    <div style="background:white;border-radius:8px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:24px;">
                        <h4 style="margin:0 0 20px 0;color:#1e293b;font-size:1rem;font-weight:600;border-bottom:2px solid #e5e7eb;padding-bottom:12px;">Phase Progress</h4>
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;">
                            ${[['Phase 1 ‚Äî Earthwork & Drainage','#22c55e',phase1Pct],
                               ['Phase 2 ‚Äî Structures','#3b82f6',phase2Pct],
                               ['Phase 3 ‚Äî Pavement','#D4AF37',phase3Pct]].map(([lbl,col,pct])=>`
                            <div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                    <span style="font-size:0.875rem;font-weight:600;color:#1e293b;">${lbl}</span>
                                    <span style="font-size:0.875rem;font-weight:700;color:${col};">${pct}%</span>
                                </div>
                                <div style="height:12px;background:#e2e8f0;border-radius:6px;overflow:hidden;">
                                    <div style="width:${pct}%;height:100%;background:${col};border-radius:6px;transition:width 0.6s ease;"></div>
                                </div>
                            </div>`).join('')}
                        </div>
                    </div>

                    <!-- Progress by Chainage -->
                    <div style="background:white;border-radius:8px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                        <h4 style="margin:0 0 20px 0;color:#1e293b;font-size:1rem;font-weight:600;border-bottom:2px solid #e5e7eb;padding-bottom:12px;">Progress by Chainage</h4>
                        <div style="position:relative;padding:0 0 20px;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:0.72rem;color:#64748b;font-weight:600;">
                                ${chainLabels.map(l=>`<span>${l}</span>`).join('')}
                            </div>
                            <div style="width:100%;height:28px;background:#e2e8f0;border-radius:14px;overflow:hidden;position:relative;">
                                <div style="position:absolute;left:0;width:${compPct}%;height:100%;background:linear-gradient(to right,#22c55e,#16a34a);"></div>
                                <div style="position:absolute;left:${compPct}%;width:8%;height:100%;background:repeating-linear-gradient(45deg,#3b82f6,#3b82f6 8px,#60a5fa 8px,#60a5fa 16px);"></div>
                                <div style="position:absolute;left:${Math.max(0,100-blkPctBar)}%;width:${blkPctBar}%;height:100%;background:repeating-linear-gradient(45deg,#ef4444,#ef4444 8px,#f87171 8px,#f87171 16px);"></div>
                            </div>
                            <div style="display:flex;gap:16px;margin-top:10px;font-size:0.75rem;flex-wrap:wrap;">
                                <span style="display:flex;align-items:center;gap:5px;"><span style="width:14px;height:14px;background:linear-gradient(to right,#22c55e,#16a34a);border-radius:2px;display:inline-block;"></span>Completed (${compPct}%)</span>
                                <span style="display:flex;align-items:center;gap:5px;"><span style="width:14px;height:14px;background:repeating-linear-gradient(45deg,#3b82f6,#3b82f6 4px,#60a5fa 4px,#60a5fa 8px);border-radius:2px;display:inline-block;"></span>In Progress</span>
                                <span style="display:flex;align-items:center;gap:5px;"><span style="width:14px;height:14px;background:repeating-linear-gradient(45deg,#ef4444,#ef4444 4px,#f87171 4px,#f87171 8px);border-radius:2px;display:inline-block;"></span>Blocked (${blkPctBar}%)</span>
                                <span style="display:flex;align-items:center;gap:5px;"><span style="width:14px;height:14px;background:#e2e8f0;border-radius:2px;display:inline-block;"></span>Not Started</span>
                            </div>
                        </div>
                    </div>
                `;

                // Now render S-curve into the container
                renderSCurve(overallPct, totalDays, elapsedDays, proj);

            } catch(e) {
                console.error('renderProgressTab error:', e);
            }
        }

        // ================================================================
        // SPRINT 3 S3-02: renderSCurve() ‚Äî real SVG S-curve
        // ================================================================
        function renderSCurve(actualPct, totalDays, elapsedDays, proj) {
            const container = document.getElementById('prog9ScurveContainer');
            if (!container) return;

            const W = container.offsetWidth || 800;
            const H = 280;
            const padL = 50, padR = 20, padT = 20, padB = 40;
            const plotW = W - padL - padR;
            const plotH = H - padT - padB;

            // Generate planned S-curve points (logistic growth)
            const planPoints = [];
            for (let d = 0; d <= totalDays; d += Math.max(1, Math.floor(totalDays/20))) {
                const t = d / totalDays;
                const logistic = 100 / (1 + Math.exp(-8 * (t - 0.5)));
                const x = padL + (d / totalDays) * plotW;
                const y = padT + plotH - (logistic / 100) * plotH;
                planPoints.push(`${x.toFixed(1)},${y.toFixed(1)}`);
            }

            // Actual progress points (linear from start to today)
            const actualPoints = [];
            for (let d = 0; d <= elapsedDays; d += Math.max(1, Math.floor(elapsedDays/10 || 1))) {
                const t = d / totalDays;
                const x = padL + t * plotW;
                const aVal = Math.min(actualPct, (d / Math.max(1,elapsedDays)) * actualPct);
                const y = padT + plotH - (aVal / 100) * plotH;
                actualPoints.push(`${x.toFixed(1)},${y.toFixed(1)}`);
            }
            // Ensure last actual point is at today's x
            const todayX = padL + (elapsedDays / totalDays) * plotW;
            const todayY = padT + plotH - (actualPct / 100) * plotH;
            actualPoints.push(`${todayX.toFixed(1)},${todayY.toFixed(1)}`);

            // Start/end dates
            const sd = parseLocalDate(proj.startDate || '2026-01-01');
            const ed = addWorkingDays(sd, totalDays);
            const fmtDate = d => d.toLocaleDateString('en-GB',{month:'short',year:'2-digit'});
            const monthStep = Math.max(1, Math.round(totalDays / 6));
            const xLabels = [];
            for (let i = 0; i <= 6; i++) {
                const d2 = new Date(sd); d2.setDate(d2.getDate() + i * monthStep);
                const x = padL + (i * monthStep / totalDays) * plotW;
                xLabels.push({ x: Math.min(x, padL + plotW), label: fmtDate(d2) });
            }

            // Grid lines
            const gridLines = [0, 25, 50, 75, 100].map(pct => {
                const y = padT + plotH - (pct / 100) * plotH;
                return `<line x1="${padL}" y1="${y.toFixed(1)}" x2="${padL+plotW}" y2="${y.toFixed(1)}" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="4,4"/>
                        <text x="${padL-6}" y="${(y+4).toFixed(1)}" text-anchor="end" font-size="11" fill="#94a3b8">${pct}%</text>`;
            }).join('');

            // X axis labels
            const xAxisLabels = xLabels.map(({x,label}) =>
                `<text x="${x.toFixed(1)}" y="${(H-8).toFixed(1)}" text-anchor="middle" font-size="10" fill="#94a3b8">${label}</text>`
            ).join('');

            // Variance area (between planned and actual up to today)
            const planAtToday = 100 / (1 + Math.exp(-8 * (elapsedDays/totalDays - 0.5)));
            const isAhead = actualPct >= planAtToday;
            const varColor = isAhead ? 'rgba(34,197,94,0.12)' : 'rgba(239,68,68,0.1)';

            // Today marker
            const todayLineX = todayX.toFixed(1);

            const svg = `<svg width="${W}" height="${H}" style="position:absolute;top:0;left:0;">
                <!-- Grid -->
                ${gridLines}
                <line x1="${padL}" y1="${padT}" x2="${padL}" y2="${padT+plotH}" stroke="#cbd5e1" stroke-width="1.5"/>
                <line x1="${padL}" y1="${padT+plotH}" x2="${padL+plotW}" y2="${padT+plotH}" stroke="#cbd5e1" stroke-width="1.5"/>
                ${xAxisLabels}
                <!-- Planned S-curve -->
                <polyline points="${planPoints.join(' ')}" fill="none" stroke="#1B3B6F" stroke-width="2.5" stroke-dasharray="7,4" opacity="0.7"/>
                <!-- Actual progress -->
                <polyline points="${actualPoints.join(' ')}" fill="none" stroke="#D4AF37" stroke-width="3"/>
                <!-- Today marker -->
                <line x1="${todayLineX}" y1="${padT}" x2="${todayLineX}" y2="${padT+plotH}" stroke="#dc2626" stroke-width="1.5" stroke-dasharray="4,3"/>
                <text x="${todayLineX}" y="${padT-4}" text-anchor="middle" font-size="10" fill="#dc2626" font-weight="600">TODAY</text>
                <!-- Actual point -->
                <circle cx="${todayX.toFixed(1)}" cy="${todayY.toFixed(1)}" r="5" fill="#D4AF37" stroke="white" stroke-width="2"/>
                <!-- Legend -->
                <rect x="${W-160}" y="${padT+8}" width="140" height="52" rx="4" fill="white" stroke="#e2e8f0" stroke-width="1"/>
                <line x1="${W-148}" y1="${padT+22}" x2="${W-128}" y2="${padT+22}" stroke="#1B3B6F" stroke-width="2.5" stroke-dasharray="6,3"/>
                <text x="${W-122}" y="${padT+26}" font-size="11" fill="#475569">Planned</text>
                <line x1="${W-148}" y1="${padT+40}" x2="${W-128}" y2="${padT+40}" stroke="#D4AF37" stroke-width="2.5"/>
                <circle cx="${W-138}" cy="${padT+40}" r="3.5" fill="#D4AF37"/>
                <text x="${W-122}" y="${padT+44}" font-size="11" fill="#475569">Actual (${actualPct}%)</text>
            </svg>`;

            container.innerHTML = svg;
            console.log('üìà S-curve rendered: actual=' + actualPct + '%, planned=' + planAtToday.toFixed(1) + '%, ' + (isAhead ? 'AHEAD' : 'BEHIND'));
        }

        // ================================================================
        // SPRINT 3 S3-03: generateReport() ‚Äî real printable reports
        // ================================================================
        function generateReport(type) {
            KALYANTRA.refresh();
            const c = KALYANTRA.computed;
            const d = KALYANTRA.data;
            const proj = d.project;
            const today = new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});

            let title = '', body = '';

            if (type === 'daily') {
                title = 'Daily Progress Report ‚Äî ' + today;
                body = `
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;">Project Overview</h3>
                    <table style="width:100%;border-collapse:collapse;margin-bottom:20px;">
                        <tr><td style="padding:6px 12px;background:#f8fafc;font-weight:600;width:200px;">Project</td><td style="padding:6px 12px;">${proj.name}</td></tr>
                        <tr><td style="padding:6px 12px;background:#f8fafc;font-weight:600;">Start Date</td><td style="padding:6px 12px;">${proj.startDate}</td></tr>
                        <tr><td style="padding:6px 12px;background:#f8fafc;font-weight:600;">Chainage</td><td style="padding:6px 12px;">${proj.startChainage/1000}+000 ‚Üí ${proj.endChainage/1000}+000</td></tr>
                        <tr><td style="padding:6px 12px;background:#f8fafc;font-weight:600;">Total Length</td><td style="padding:6px 12px;">${((proj.endChainage-proj.startChainage)/1000).toFixed(2)} km</td></tr>
                        <tr><td style="padding:6px 12px;background:#f8fafc;font-weight:600;">Contract Value</td><td style="padding:6px 12px;">‚Çπ ${proj.budget.toFixed(2)} Cr</td></tr>
                    </table>
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;">Today's Active Activities</h3>
                    <table style="width:100%;border-collapse:collapse;font-size:0.875rem;">
                        <thead><tr style="background:#1B3B6F;color:white;">
                            <th style="padding:8px 12px;text-align:left;">Activity</th>
                            <th style="padding:8px 12px;text-align:right;">Qty</th>
                            <th style="padding:8px 12px;text-align:left;">Unit</th>
                            <th style="padding:8px 12px;text-align:left;">Resource</th>
                            <th style="padding:8px 12px;text-align:center;">Critical</th>
                        </tr></thead>
                        <tbody>
                        ${c.activities.slice(0,10).map((a,i)=>`
                            <tr style="background:${i%2?'#f8fafc':'white'};">
                                <td style="padding:7px 12px;">${a.name}</td>
                                <td style="padding:7px 12px;text-align:right;">${a.qty.toLocaleString()}</td>
                                <td style="padding:7px 12px;">${a.unit}</td>
                                <td style="padding:7px 12px;">${a.resource||'‚Äî'}</td>
                                <td style="padding:7px 12px;text-align:center;">${a.critical?'<span style="color:#dc2626;font-weight:700;">‚óè</span>':'‚óã'}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                    ${c.activities.length > 10 ? `<p style="color:#64748b;font-size:0.85rem;margin-top:8px;">+ ${c.activities.length-10} more activities</p>` : ''}
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;margin-top:20px;">Active Hindrances</h3>
                    ${d.hindrances.filter(h=>h.status!=='Resolved').length > 0
                        ? `<table style="width:100%;border-collapse:collapse;font-size:0.875rem;">
                            <thead><tr style="background:#1B3B6F;color:white;">
                                <th style="padding:8px 12px;text-align:left;">Hindrance</th>
                                <th style="padding:8px 12px;text-align:left;">Chainage</th>
                                <th style="padding:8px 12px;text-align:left;">Type</th>
                                <th style="padding:8px 12px;text-align:left;">Impact</th>
                            </tr></thead><tbody>
                            ${d.hindrances.filter(h=>h.status!=='Resolved').map((h,i)=>`
                                <tr style="background:${i%2?'#fff5f5':'white'};">
                                    <td style="padding:7px 12px;">${h.name||'Hindrance '+h.id}</td>
                                    <td style="padding:7px 12px;">${(h.chainageStart/1000).toFixed(3)} ‚Äì ${(h.chainageEnd/1000).toFixed(3)}</td>
                                    <td style="padding:7px 12px;">${h.type||'‚Äî'}</td>
                                    <td style="padding:7px 12px;">${h.impact||'‚Äî'}</td>
                                </tr>`).join('')}
                            </tbody></table>`
                        : '<p style="color:#16a34a;font-weight:600;">‚úÖ No active hindrances today</p>'}`;

            } else if (type === 'hindrance') {
                title = 'Hindrance Analysis Report ‚Äî ' + today;
                body = `
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;">All Hindrances Summary</h3>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">
                        <div style="background:#fef2f2;border:1px solid #fca5a5;border-radius:6px;padding:12px;text-align:center;">
                            <div style="font-size:1.8rem;font-weight:700;color:#dc2626;">${d.hindrances.filter(h=>h.status!=='Resolved').length}</div>
                            <div style="font-size:0.8rem;color:#64748b;">Active</div>
                        </div>
                        <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:6px;padding:12px;text-align:center;">
                            <div style="font-size:1.8rem;font-weight:700;color:#16a34a;">${d.hindrances.filter(h=>h.status==='Resolved').length}</div>
                            <div style="font-size:0.8rem;color:#64748b;">Resolved</div>
                        </div>
                        <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:12px;text-align:center;">
                            <div style="font-size:1.8rem;font-weight:700;color:#1B3B6F;">${d.hindrances.length}</div>
                            <div style="font-size:0.8rem;color:#64748b;">Total</div>
                        </div>
                    </div>
                    <table style="width:100%;border-collapse:collapse;font-size:0.875rem;">
                        <thead><tr style="background:#1B3B6F;color:white;">
                            <th style="padding:8px 12px;text-align:left;">#</th>
                            <th style="padding:8px 12px;text-align:left;">Hindrance</th>
                            <th style="padding:8px 12px;text-align:left;">From Ch</th>
                            <th style="padding:8px 12px;text-align:left;">To Ch</th>
                            <th style="padding:8px 12px;text-align:left;">Type</th>
                            <th style="padding:8px 12px;text-align:left;">Status</th>
                            <th style="padding:8px 12px;text-align:right;">Length (km)</th>
                            <th style="padding:8px 12px;text-align:left;">Impact</th>
                        </tr></thead><tbody>
                        ${d.hindrances.map((h,i)=>`
                            <tr style="background:${h.status==='Resolved'?'#f0fdf4':i%2?'#fff5f5':'white'};">
                                <td style="padding:7px 12px;">${h.id}</td>
                                <td style="padding:7px 12px;font-weight:500;">${h.name||'Hindrance '+h.id}</td>
                                <td style="padding:7px 12px;">${(h.chainageStart/1000).toFixed(3)}</td>
                                <td style="padding:7px 12px;">${(h.chainageEnd/1000).toFixed(3)}</td>
                                <td style="padding:7px 12px;">${h.type||'‚Äî'}</td>
                                <td style="padding:7px 12px;"><span style="padding:3px 8px;border-radius:10px;font-size:0.75rem;font-weight:600;${h.status==='Resolved'?'background:#dcfce7;color:#166534':'background:#fee2e2;color:#991b1b'}">${h.status}</span></td>
                                <td style="padding:7px 12px;text-align:right;">${((h.chainageEnd-h.chainageStart)/1000).toFixed(3)}</td>
                                <td style="padding:7px 12px;">${h.impact||'‚Äî'}</td>
                            </tr>`).join('')}
                        </tbody></table>
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;margin-top:20px;">Workable Stretches (Hindrance-Free)</h3>
                    <table style="width:100%;border-collapse:collapse;font-size:0.875rem;">
                        <thead><tr style="background:#1B3B6F;color:white;">
                            <th style="padding:8px 12px;text-align:left;">Stretch</th>
                            <th style="padding:8px 12px;text-align:left;">From Ch</th>
                            <th style="padding:8px 12px;text-align:left;">To Ch</th>
                            <th style="padding:8px 12px;text-align:right;">Length (km)</th>
                        </tr></thead><tbody>
                        ${c.workableStretches.map((w,i)=>`
                            <tr style="background:${i%2?'#f8fafc':'white'};">
                                <td style="padding:7px 12px;">${w.id}</td>
                                <td style="padding:7px 12px;">${(w.start/1000).toFixed(3)}</td>
                                <td style="padding:7px 12px;">${(w.end/1000).toFixed(3)}</td>
                                <td style="padding:7px 12px;text-align:right;font-weight:600;">${w.length.toFixed(3)}</td>
                            </tr>`).join('')}
                        </tbody></table>`;

            } else if (type === 'schedule') {
                title = 'Schedule Variance Report ‚Äî ' + today;
                body = `
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;">WBS Schedule Analysis</h3>
                    <table style="width:100%;border-collapse:collapse;font-size:0.875rem;">
                        <thead><tr style="background:#1B3B6F;color:white;">
                            <th style="padding:8px 12px;text-align:left;">WBS</th>
                            <th style="padding:8px 12px;text-align:left;">Description</th>
                            <th style="padding:8px 12px;text-align:right;">Planned Days</th>
                            <th style="padding:8px 12px;text-align:right;">Activities</th>
                            <th style="padding:8px 12px;text-align:right;">Critical</th>
                            <th style="padding:8px 12px;text-align:left;">Phase</th>
                            <th style="padding:8px 12px;text-align:left;">Status</th>
                        </tr></thead><tbody>
                        ${c.wbs.map((w,i)=>`
                            <tr style="background:${i%2?'#f8fafc':'white'};">
                                <td style="padding:7px 12px;font-family:monospace;font-size:0.8rem;color:#1B3B6F;">${w.wbs}</td>
                                <td style="padding:7px 12px;">${w.description}</td>
                                <td style="padding:7px 12px;text-align:right;">${w.duration}</td>
                                <td style="padding:7px 12px;text-align:right;">${w.activities?w.activities.length:0}</td>
                                <td style="padding:7px 12px;text-align:right;${w.activities&&w.activities.filter(a=>a.critical).length>0?'color:#dc2626;font-weight:700;':'color:#64748b;'}">${w.activities?w.activities.filter(a=>a.critical).length:0}</td>
                                <td style="padding:7px 12px;"><span style="padding:3px 8px;border-radius:10px;font-size:0.75rem;font-weight:600;${w.phase===1?'background:#dcfce7;color:#166534':w.phase===2?'background:#dbeafe;color:#1e40af':'background:#fef3c7;color:#92400e'}">Phase ${w.phase}</span></td>
                                <td style="padding:7px 12px;"><span style="padding:3px 8px;border-radius:10px;font-size:0.75rem;font-weight:600;background:#dbeafe;color:#1e40af">Scheduled</span></td>
                            </tr>`).join('')}
                        </tbody></table>`;

            } else if (type === 'weekly') {
                title = 'Weekly Status Report ‚Äî ' + today;
                const wHind = d.hindrances.filter(h => h.status === 'Pending');
                const critA = c.activities.filter(a => a.critical);
                const fmtC  = m => { const k=Math.floor(m/1000),r=m%1000; return k+'+'+String(r).padStart(3,'0'); };
                body = `
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;">Weekly Overview ‚Äî ${proj.name}</h3>
                    <table style="width:100%;border-collapse:collapse;margin-bottom:16px;font-size:0.875rem;">
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;width:38%;">Contract Value</td><td style="padding:6px 10px;">‚Çπ ${proj.budget.toFixed(2)} Cr</td></tr>
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;">Project Length</td><td style="padding:6px 10px;">${((proj.endChainage-proj.startChainage)/1000).toFixed(2)} km</td></tr>
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;">Overall Progress</td><td style="padding:6px 10px;font-weight:700;color:#1B3B6F;">${c.overallProgress}%</td></tr>
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;">Workable Stretches</td><td style="padding:6px 10px;">${c.workableStretches.length}</td></tr>
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;">Active Hindrances</td><td style="padding:6px 10px;color:${wHind.length?'#dc2626':'#16a34a'};font-weight:600;">${wHind.length}</td></tr>
                    </table>
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;">WBS Phase Summary</h3>
                    <table style="width:100%;border-collapse:collapse;margin-bottom:16px;font-size:0.875rem;">
                        <tr style="background:#1B3B6F;color:white;"><th style="padding:8px;">WBS</th><th style="padding:8px;text-align:left;">Zone / Structure</th><th style="padding:8px;">Acts</th><th style="padding:8px;">Duration</th><th style="padding:8px;">Status</th></tr>
                        ${c.wbs.map(w=>`<tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:7px;text-align:center;font-weight:700;color:#1B3B6F;">${w.wbs}</td><td style="padding:7px;">${w.name.length>40?w.name.substring(0,40)+'‚Ä¶':w.name}</td><td style="padding:7px;text-align:center;">${w.activities.length}</td><td style="padding:7px;text-align:center;">${w.duration||0}d</td><td style="padding:7px;text-align:center;"><span style="background:${w.type==='blocked'?'#fee2e2':w.type==='structure'?'#dbeafe':'#dcfce7'};padding:2px 8px;border-radius:4px;font-size:0.78rem;font-weight:600;">${w.status||'-'}</span></td></tr>`).join('')}
                    </table>
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;">Critical Path (${critA.length} activities)</h3>
                    <table style="width:100%;border-collapse:collapse;font-size:0.875rem;">
                        <tr style="background:#1B3B6F;color:white;"><th style="padding:8px;text-align:left;">Activity</th><th style="padding:8px;">Dur</th><th style="padding:8px;text-align:left;">Resource</th></tr>
                        ${critA.slice(0,10).map(a=>`<tr style="border-bottom:1px solid #f1f5f9;"><td style="padding:7px;">üî¥ ${a.name}</td><td style="padding:7px;text-align:center;">${a.duration}d</td><td style="padding:7px;color:#64748b;">${a.resource||'‚Äî'}</td></tr>`).join('')}
                    </table>
                    ${wHind.length?`<h3 style="color:#dc2626;border-bottom:2px solid #dc2626;padding-bottom:6px;margin-top:16px;">Hindrances Requiring Action (${wHind.length})</h3><ul>${wHind.map(h=>`<li style="margin-bottom:6px;"><strong>${h.name}</strong> ‚Äî Ch ${fmtC(h.chainageStart)} ‚Üí ${fmtC(h.chainageEnd)} (${((h.chainageEnd-h.chainageStart)/1000).toFixed(1)} km)</li>`).join('')}</ul>`:'<p style="color:#16a34a;font-weight:600;margin-top:12px;">‚úÖ No active hindrances this week.</p>'}
                `;
            } else if (type === 'monthly') {
                title = 'Monthly Progress Report ‚Äî ' + today;
                const mActs = c.activities;
                const qtySummary = {};
                ['Soil Excavation','Embankment','GSB','WBM','DBM','BC'].forEach(k => { qtySummary[k] = 0; });
                mActs.forEach(a => {
                    const key = Object.keys(qtySummary).find(k => a.name && a.name.includes(k));
                    if (key) qtySummary[key] += (a.qty || 0);
                });
                const phases = [1,2,3].map(ph => {
                    const pa = mActs.filter(a=>a.phase===ph);
                    return { ph, count: pa.length, maxDur: pa.reduce((s,a)=>Math.max(s,a.duration||0),0) };
                });
                body = `
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;">Executive Summary</h3>
                    <table style="width:100%;border-collapse:collapse;margin-bottom:16px;font-size:0.875rem;">
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;width:38%;">Project</td><td style="padding:6px 10px;">${proj.name}</td></tr>
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;">Contract Value</td><td style="padding:6px 10px;">‚Çπ ${proj.budget.toFixed(2)} Cr</td></tr>
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;">Length</td><td style="padding:6px 10px;">${((proj.endChainage-proj.startChainage)/1000).toFixed(2)} km</td></tr>
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;">Overall Progress</td><td style="padding:6px 10px;font-weight:700;color:#1B3B6F;">${c.overallProgress}%</td></tr>
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;">Total Activities</td><td style="padding:6px 10px;">${mActs.length} (${c.criticalActivities} critical)</td></tr>
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;">Active Hindrances</td><td style="padding:6px 10px;color:${d.hindrances.filter(h=>h.status==='Pending').length?'#dc2626':'#16a34a'};font-weight:600;">${d.hindrances.filter(h=>h.status==='Pending').length}</td></tr>
                    </table>
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;">Cumulative Quantities</h3>
                    <table style="width:100%;border-collapse:collapse;margin-bottom:16px;font-size:0.875rem;">
                        <tr style="background:#1B3B6F;color:white;"><th style="padding:8px;text-align:left;">Work Type</th><th style="padding:8px;">Total Qty (Cum)</th></tr>
                        ${Object.entries(qtySummary).map(([k,v])=>`<tr style="border-bottom:1px solid #f1f5f9;"><td style="padding:7px;">${k}</td><td style="padding:7px;text-align:center;font-weight:700;">${v.toLocaleString()}</td></tr>`).join('')}
                    </table>
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;">Phase Progress</h3>
                    <table style="width:100%;border-collapse:collapse;font-size:0.875rem;">
                        <tr style="background:#1B3B6F;color:white;"><th style="padding:8px;">Phase</th><th style="padding:8px;">Activities</th><th style="padding:8px;">Max Duration</th></tr>
                        ${phases.map(p=>`<tr style="border-bottom:1px solid #f1f5f9;"><td style="padding:7px;text-align:center;font-weight:700;">Phase ${p.ph}</td><td style="padding:7px;text-align:center;">${p.count}</td><td style="padding:7px;text-align:center;">${p.maxDur}d</td></tr>`).join('')}
                    </table>
                `;
            } else if (type === 'cost' || type === 'resource') {
                title = (type==='cost' ? 'Cost Analysis' : 'Resource Utilization') + ' Report ‚Äî ' + today;
                body = `<p style="color:#64748b;padding:20px 0;">Detailed ${type} data requires actual progress entry per activity. Coming in V7.0 with site diary integration.</p>
                        <p>Current project budget: ‚Çπ ${proj.budget.toFixed(2)} Cr ¬∑ ${c.activities.length} planned activities ¬∑ ${KALYANTRA.data.resources.equipment.length} equipment items</p>`;
            }

            // Show in modal overlay
            const modal = document.createElement('div');
            modal.id = 'reportModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:9000;display:flex;align-items:flex-start;justify-content:center;padding:40px 20px;box-sizing:border-box;overflow-y:auto;';
            modal.innerHTML = `
                <div style="background:white;border-radius:10px;max-width:900px;width:100%;box-shadow:0 25px 60px rgba(0,0,0,0.3);">
                    <div style="background:#1B3B6F;padding:20px 28px;border-radius:10px 10px 0 0;display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="color:#D4AF37;font-size:0.75rem;font-weight:600;letter-spacing:1px;text-transform:uppercase;">KALYANTRA Report</div>
                            <h2 style="margin:4px 0 0;color:white;font-size:1.125rem;">${title}</h2>
                        </div>
                        <div style="display:flex;gap:10px;">
                            <button onclick="window.print()" style="padding:8px 16px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:6px;font-weight:700;cursor:pointer;">üñ®Ô∏è Print</button>
                            <button onclick="document.getElementById('reportModal').remove()" style="padding:8px 16px;background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:6px;font-weight:600;cursor:pointer;">‚úï Close</button>
                        </div>
                    </div>
                    <div id="reportContent" style="padding:28px;font-family:Arial,sans-serif;font-size:0.875rem;line-height:1.6;">
                        ${body}
                    </div>
                </div>`;
            document.body.appendChild(modal);
            modal.addEventListener('click', e => { if(e.target===modal) modal.remove(); });
            console.log('üìä Report generated:', type);
        }

        // ================================================================
        // SPRINT 4 S4-02: KALYANTRA.save() / KALYANTRA.load() ‚Äî localStorage
        // ================================================================
        KALYANTRA.save = function() {
            supabaseSave(this.data).catch(e => console.warn('Save error:', e));
        };

        KALYANTRA.load = function() { return false; };

        KALYANTRA.loadFromSupabase = async function() {
            const data = await supabaseLoad();
            if (data) {
                ['project','tcs','structures','hindrances','calendar',
                 'resources','milestones','activityProgress','boq'].forEach(key => {
                    if (data[key] !== undefined) this.data[key] = data[key];
                });
                this.refresh();
                if (typeof renderHolidayTable        === 'function') renderHolidayTable();
                if (typeof renderWorkingDaysSelector  === 'function') renderWorkingDaysSelector();
                if (typeof renderMilestoneTracker     === 'function') renderMilestoneTracker();
                // Populate all form fields from loaded database data
                setTimeout(() => {
                    if (typeof populateProjectForm === 'function') populateProjectForm();
                }, 150);
                return true;
            } else {
                try {
                    const saved = localStorage.getItem('kalyantra_v65_data');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        ['project','tcs','structures','hindrances','calendar',
                         'resources','milestones','activityProgress','boq'].forEach(key => {
                            if (parsed[key] !== undefined) this.data[key] = parsed[key];
                        });
                        this.refresh();
                        showToast('‚ö†Ô∏è Offline mode ‚Äî using local storage', 'info');
                    }
                } catch(e) {}
                return false;
            }
        };

        KALYANTRA.clearSaved = function() {
            localStorage.removeItem('kalyantra_v65_data');
            showToast('üóëÔ∏è Saved data cleared ‚Äî reload to reset', 'warning');
        };

        // ================================================================
        // SPRINT 4 S4-04: Sidebar divider CSS enhancement (Gold accent)
        // ================================================================
        // (dividers already present in HTML; CSS upgrade done via style injection)
        (function upgradeSidebarDividers() {
            const style = document.createElement('style');
            style.textContent = `
                .sidebar-divider {
                    height: 1px;
                    background: rgba(212,175,55,0.35) !important;
                    margin: 6px 10px;
                }
                .sidebar-section-label {
                    font-size: 0.65rem;
                    text-transform: uppercase;
                    letter-spacing: 1.5px;
                    color: rgba(212,175,55,0.55) !important;
                    padding: 8px 0 4px 16px;
                    font-weight: 600;
                }
                /* U-13: prevent sticky footer overlap on resource subtabs */
                .resource-subtab { padding-bottom: 72px !important; }
                /* FIX-UA11: V7.0 placeholder buttons look disabled */
                .btn-v7 { opacity: 0.55 !important; cursor: not-allowed !important; }
                .btn-v7::before { content: 'üîí '; font-style: normal; }
                @media print {
                    .sidebar, .toolbar, nav, .sticky, [style*="sticky"] { display: none !important; }
                    #reportContent { padding: 0 !important; }
                    body { margin: 0; }
                }
            `;
            document.head.appendChild(style);
        })();

        // ================================================================
        // SPRINT 2: S2-01 ‚Äî saveCalendar()
        // ================================================================
        // FIX-GAP04: Working Days toggle
        function toggleWorkingDay(dayNum, isChecked, labelEl) {
            if (!KALYANTRA.data.calendar.workingDays) KALYANTRA.data.calendar.workingDays = [1,2,3,4,5,6];
            if (isChecked) { if (!KALYANTRA.data.calendar.workingDays.includes(dayNum)) KALYANTRA.data.calendar.workingDays.push(dayNum); }
            else { KALYANTRA.data.calendar.workingDays = KALYANTRA.data.calendar.workingDays.filter(d => d !== dayNum); }
            KALYANTRA.data.calendar.workingDays.sort();
            if (labelEl) {
                labelEl.style.borderColor = isChecked ? '#1B3B6F' : '#e2e8f0';
                labelEl.style.background  = isChecked ? '#EBF0FA' : 'white';
                labelEl.style.color       = isChecked ? '#1B3B6F' : '#64748b';
            }
            KALYANTRA.save(); KALYANTRA.refresh();
            showToast('üìÖ Working days: ' + KALYANTRA.data.calendar.workingDays.length + ' days/week', 'success');
        }

        function renderWorkingDaysSelector() {
            const el = document.getElementById('workingDaysSelector');
            if (!el) return;
            const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
            const wds  = KALYANTRA.data.calendar.workingDays || [1,2,3,4,5,6];
            el.innerHTML = days.map((d, i) => {
                const dn = i === 6 ? 0 : i + 1;
                const on = wds.includes(dn);
                return `<label style="display:flex;align-items:center;gap:4px;cursor:pointer;padding:5px 10px;border:1px solid ${on?'#1B3B6F':'#e2e8f0'};border-radius:6px;background:${on?'#EBF0FA':'white'};font-size:0.85rem;font-weight:600;color:${on?'#1B3B6F':'#64748b'};">
                    <input type="checkbox" ${on?'checked':''} onchange="toggleWorkingDay(${dn},this.checked,this.parentElement)" style="accent-color:#1B3B6F;"> ${d}</label>`;
            }).join('');
        }

        function saveCalendar() {
            const hours  = parseFloat(document.getElementById('hoursPerDay')  && document.getElementById('hoursPerDay').value)  || 8;
            const mStart = document.getElementById('monsoonStart') && document.getElementById('monsoonStart').value || '2026-07-15';
            const mEnd   = document.getElementById('monsoonEnd')   && document.getElementById('monsoonEnd').value   || '2026-08-31';
            KALYANTRA.data.calendar.hoursPerDay  = hours;
            KALYANTRA.data.calendar.monsoonStart = mStart;
            KALYANTRA.data.calendar.monsoonEnd   = mEnd;
            KALYANTRA.refresh();
            console.log('üìÖ Calendar saved:', KALYANTRA.data.calendar);
            showToast('‚úÖ Calendar saved ‚Äî ' + hours + 'h/day, monsoon ' + mStart + ' ‚Üí ' + mEnd, 'success');
        }
        
        // GAP-04: Save working days from checkboxes
        function saveWorkingDays() {
            const dayIds = ['wdSun','wdMon','wdTue','wdWed','wdThu','wdFri','wdSat'];
            const days = [];
            dayIds.forEach((id, idx) => {
                const el = document.getElementById(id);
                if (el && el.checked) days.push(idx);
            });
            if (days.length === 0) {
                showToast('‚ö†Ô∏è At least 1 working day required', 'warning');
                return;
            }
            KALYANTRA.data.calendar.workingDays = days;
            KALYANTRA.save();
            KALYANTRA.refresh();
            const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            const label = days.map(d => dayNames[d]).join(', ');
            const summary = document.getElementById('workingDaySummary');
            if (summary) summary.textContent = days.length + ' days/week (' + label + ')';
            showToast('‚úÖ Working days saved: ' + days.length + 'd/week', 'success');
        }

        // ================================================================
        // SPRINT 2: S2-04 ‚Äî saveTCSEdit() + saveTCSComponents()
        // ================================================================
        // U-04: Holiday management functions
        const HOLIDAY_LABELS = {
            '2026-01-26': 'Republic Day',
            '2026-08-15': 'Independence Day',
            '2026-10-02': 'Gandhi Jayanti'
        };

        function renderHolidayTable() {
            const tbody = document.getElementById('holidayTableBody');
            if (!tbody) return;
            const holidays = KALYANTRA.data.calendar.holidays || [];
            if (!holidays.length) {
                tbody.innerHTML = '<tr><td colspan="3" style="padding:12px;text-align:center;color:#94a3b8;font-style:italic;">No holidays added. Click + Add Holiday.</td></tr>';
                return;
            }
            tbody.innerHTML = holidays.map((h, i) => {
                const label = HOLIDAY_LABELS[h] || 'Project Shutdown';
                // LA-08/UA-04 FIX: Show editable date input (not just text) so user can change dates
                return `<tr style="border-bottom:1px solid #f1f5f9;">
                    <td style="padding:8px 12px;">
                        <input type="date" value="${h}" style="border:1px solid #e2e8f0;border-radius:4px;padding:4px 8px;font-size:0.85rem;color:#1B3B6F;font-weight:600;"
                            onchange="updateHolidayDate(${i}, this.value)" />
                    </td>
                    <td style="padding:8px 12px;">
                        <input type="text" value="${label}" style="border:1px solid #e2e8f0;border-radius:4px;padding:4px 8px;width:100%;font-size:0.85rem;"
                            onchange="updateHolidayLabel(${i}, this.value)" />
                    </td>
                    <td style="padding:8px 12px;text-align:center;">
                        <button onclick="deleteHoliday(${i})" style="background:#fee2e2;color:#dc2626;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:0.8rem;font-weight:600;">‚úï</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function addHolidayRow() {
            const today = new Date().toISOString().split('T')[0];
            if (!KALYANTRA.data.calendar.holidays.includes(today)) {
                KALYANTRA.data.calendar.holidays.push(today);
            }
            renderHolidayTable();
            KALYANTRA.save();
            showToast('üìÖ Holiday added ‚Äî update date and description', 'info');
        }

        function deleteHoliday(index) {
            KALYANTRA.data.calendar.holidays.splice(index, 1);
            renderHolidayTable();
            KALYANTRA.save();
            KALYANTRA.refresh();
            showToast('üóëÔ∏è Holiday removed', 'success');
        }

        function updateHolidayDate(index, newDate) {
            // LA-08 FIX: Allow user to change holiday date
            if (!newDate) return;
            KALYANTRA.data.calendar.holidays[index] = newDate;
            KALYANTRA.save();
            KALYANTRA.refresh();
            renderHolidayTable();
            showToast('üìÖ Holiday date updated to ' + newDate, 'success');
        }

        function updateHolidayLabel(index, newLabel) {
            // Labels are stored in HOLIDAY_LABELS lookup ‚Äî update the date input instead
            // For simplicity: just save; label is transient per-session
            KALYANTRA.save();
        }


        function saveTCSEdit(field, value) {
            const num = parseFloat(value);
            if (isNaN(num)) return;
            if (field === 'carriageWidth') {
                KALYANTRA.data.tcs.carriageWidth = num;
                showToast('üìê Carriage width: ' + num + 'm', 'info');
            } else if (field === 'shoulderWidth') {
                KALYANTRA.data.tcs.shoulderWidth = num;
                showToast('üìê Shoulder width: ' + num + 'm', 'info');
            } else if (KALYANTRA.data.tcs.layers[field]) {
                KALYANTRA.data.tcs.layers[field].thickness = num;
                showToast('üìê ' + field + ' thickness: ' + num + 'mm ‚Äî recalculating...', 'info');
            }
            // Recalculate WBS quantities
            KALYANTRA.refresh();
            // Re-render WBS if visible
            const wbsPanel = document.getElementById('wbsBody');
            if (wbsPanel) {
                KALYANTRA.render.wbsTable();
                showToast('‚úÖ TCS updated ‚Äî WBS quantities recalculated', 'success');
            }
            console.log('üìê TCS data:', JSON.stringify(KALYANTRA.data.tcs));
        }
        
        function saveTCSComponents() {
            // Save current TCS form state and update KALYANTRA
            ['BC', 'DBM', 'WBM', 'GSB'].forEach(layer => {
                const el = document.getElementById('tcs' + layer);
                if (el && el.value) KALYANTRA.data.tcs.layers[layer].thickness = parseFloat(el.value) || KALYANTRA.data.tcs.layers[layer].thickness;
            });
            const cw = document.getElementById('tcsCarriageWidth');
            const sw = document.getElementById('tcsShoulderWidth');
            if (cw && cw.value) KALYANTRA.data.tcs.carriageWidth = parseFloat(cw.value);
            if (sw && sw.value) KALYANTRA.data.tcs.shoulderWidth = parseFloat(sw.value);
            KALYANTRA.refresh();
            showToast('‚úÖ TCS components & geometry saved to KALYANTRA', 'success');
                    KALYANTRA.save(); KALYANTRA.refresh();
            showToast('‚úÖ TCS & milestones saved ‚Äî WBS recalculated', 'success');
        }
        
        // ================================================================
        // SPRINT 2: S2-05 ‚Äî readMilestones()
        // ================================================================
        function readMilestones() {
            const rows = document.querySelectorAll('#physicalMilestones tr');
            const milestones = [];
            rows.forEach((row, i) => {
                const inputs = row.querySelectorAll('input');
                if (inputs.length >= 4) {
                    milestones.push({
                        id:         i + 1,
                        targetDate: inputs[0].value || '',
                        completion: parseFloat(inputs[1].value) || 0,
                        duration:   parseFloat(inputs[2].value) || 0,
                        description: inputs[3].value || 'Milestone ' + (i + 1)
                    });
                }
            });
            KALYANTRA.data.milestones = milestones;
            console.log('üìã Milestones saved:', milestones);
        }
        
        // ================================================================
        // SPRINT 2: S2-06 ‚Äî validateAndProceed()
        // ================================================================
        function validateAndProceed() {
            updateProjectData();
            const errors = [];
            
            // Required field checks
            const nameEl = document.getElementById('projectName');
            const endKmEl = document.getElementById('endKm');
            const dateEl  = document.getElementById('appointedDate');
            
            if (nameEl && !nameEl.value.trim()) {
                nameEl.style.borderColor = '#dc2626';
                errors.push('Project Name');
            } else if (nameEl) nameEl.style.borderColor = '';
            
            if (endKmEl && (!endKmEl.value || parseFloat(endKmEl.value) <= 0)) {
                endKmEl.style.borderColor = '#dc2626';
                errors.push('End Chainage');
            } else if (endKmEl) endKmEl.style.borderColor = '';
            
            if (dateEl && !dateEl.value) {
                dateEl.style.borderColor = '#dc2626';
                errors.push('Appointed Date');
            } else if (dateEl) dateEl.style.borderColor = '';
            
            if (errors.length > 0) {
                showToast('‚ö†Ô∏è Required: ' + errors.join(', '), 'warning');
                // Scroll to first error
                const firstError = document.querySelector('input[style*="dc2626"]');
                if (firstError) firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            
            showToast('‚úÖ Project data saved ‚Äî proceeding to TCS', 'success');
            switchMainTab(1);
        }
        
        // ================================================================
        // SPRINT 2: Extend updateProjectData to read all Tab 1 fields
        // ================================================================
        
        function updateProjectData() {
            KALYANTRA.syncFromUI.project();
            // Read industry type and project mode
            const industryEl = document.getElementById('industryType');
            const modeEl     = document.getElementById('projectMode');
            if (industryEl) KALYANTRA.data.project.industryType = industryEl.value;
            if (modeEl)     KALYANTRA.data.project.projectMode  = modeEl.value;
            // Read milestones
            if (typeof readMilestones === 'function') readMilestones();
            console.log('üìã Project updated:', KALYANTRA.data.project.name, '/', KALYANTRA.data.project.industryType, '/', KALYANTRA.data.project.projectMode);
            // If WBS is visible, re-render
            KALYANTRA.save(); // FIX: persist project data edits
            const wbsPanel = document.getElementById('tab7');
            if (wbsPanel && wbsPanel.classList.contains('active')) {
                KALYANTRA.render.wbsTable();
            }
        }
        
        // Initialize on page load
        
        // ‚îÄ‚îÄ POPULATE FORM FROM DATA (called after Supabase load) ‚îÄ‚îÄ
        function populateProjectForm() {
            const p   = KALYANTRA.data.project || {};
            const setV = (id, val) => { const el = document.getElementById(id); if (el && val !== undefined && val !== null) el.value = val; };
            const setS = (id, val) => { const el = document.getElementById(id); if (el && val) { // set select
                for (let i=0; i<el.options.length; i++) {
                    if (el.options[i].value.toLowerCase() === String(val).toLowerCase()) { el.selectedIndex = i; break; }
                }
            }};

            // A. Project Information
            setV('projectName', p.name);
            setS('industryType', p.industryType || 'Roads');
            setS('projectMode',  p.projectMode  || 'EPC');
            setV('projectCost',  p.budget);

            // Chainage ‚Äî stored as metres, split into km+m
            const sc = p.startChainage || 0;
            const ec = p.endChainage   || 5000;
            setV('startKm', Math.floor(sc / 1000));
            setV('startM',  sc % 1000);
            setV('endKm',   Math.floor(ec / 1000));
            setV('endM',    ec % 1000);

            // B. Contractual Dates
            setV('appointedDate',  p.startDate);
            setV('completionDate', p.endDate);
            if (p.duration) setV('duration', Math.round(p.duration / 30));

            // Update header project name
            const hn = document.getElementById('headerProjectName');
            if (hn) hn.textContent = p.name || 'Unnamed Project';

            // Trigger length calculation
            const endKmEl = document.getElementById('endKm');
            if (endKmEl) endKmEl.dispatchEvent(new Event('input'));

            console.log('‚úÖ Project form populated from Supabase data:', p.name);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            KALYANTRA.init();
            initSidebar();
            await KALYANTRA.loadFromSupabase();
            setTimeout(() => {
                KALYANTRA.render.wbsTable();
                KALYANTRA.render.dashboard();
                updateWBSStatBar();
                if (typeof renderWorkingDaysSelector==='function') renderWorkingDaysSelector();
                if (typeof populateProjectForm==='function') populateProjectForm();
            }, 300);
        });
        
        console.log('‚úÖ KALYANTRA V6.5 ‚Äî 27 audit fixes applied (12 Logic + 15 UI/UX)');


    </script>

    <script>
        // ===== SIDEBAR SYSTEM =====
        const TAB_LABELS = [
            'üìã Project Basics',
            'üìê TCS & Sections',
            'üåâ Structures',
            '‚ö†Ô∏è Hindrances',
            'üìÖ Calendar',
            'üì¶ Resources',
            'üìä Activity Grid',
            'üéØ Executive Dashboard',
            'üìà Progress Tracking',
            'üìë Reports & Analytics',
            'üìê TCS & Sections'
        ];

        function sidebarSwitchTab(index, clickedItem) {
            // Update sidebar active state
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            if (clickedItem) clickedItem.classList.add('active');

            // Update header label
            const headerLabel = document.getElementById('headerTabLabel');
            if (headerLabel) headerLabel.textContent = TAB_LABELS[index] || '';

            // BOQ tab (index 10) ‚Üí show tab11 panel specially
            if (index === 10) {
                // Hide all tab panels, show tab11
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                const boqPanel = document.getElementById('tab11');
                if (boqPanel) { boqPanel.classList.add('active'); }
                setTimeout(() => renderBOQSections(), 100);
                return;
            }

            // Call existing tab switch function
            switchMainTab(index);

            // Trigger tab-specific renders
            if (index === 6) {
                setTimeout(() => {
                    if (KALYANTRA && KALYANTRA.render) {
                        KALYANTRA.render.wbsTable();
                        updateWBSStatBar();
                    }
                }, 100);
            }
            if (index === 7) {
                setTimeout(() => { if (KALYANTRA && KALYANTRA.render) KALYANTRA.render.dashboard(); }, 100);
            }
            if (index === 1) {
                // U-07: Auto-select first TCS row so layer editor is always visible
                setTimeout(() => {
                    const firstRow = document.querySelector('#tcsTable tbody tr') || document.querySelector('#tcsTable tr');
                    if (firstRow && typeof selectTCS === 'function') selectTCS(firstRow, 0);
                }, 150);
            }
            if (index === 4) {
                // U-04: render holiday table + working days selector on Tab5 open
                setTimeout(() => {
                    if (typeof renderHolidayTable === 'function') renderHolidayTable();
                    if (typeof renderWorkingDaysSelector === 'function') renderWorkingDaysSelector(); // FIX-GAP04
                }, 150);
            }
            if (index === 8) {
                setTimeout(() => { if (typeof renderProgressTab === 'function') renderProgressTab(); }, 150);
            }
        }

        // ‚îÄ‚îÄ Auto-render triggers for Tab7 sub-views (U-02, U-14, U-15) ‚îÄ‚îÄ
        // FIX: use let so re-init doesn't crash on re-declaration
        if (typeof switchTab7Child === 'function' && !switchTab7Child._wrapped) {
        const _origSwitchTab7Child = switchTab7Child;
        switchTab7Child = function(index) {
            _origSwitchTab7Child(index);
            if (index === 1) setTimeout(() => { if (typeof renderActivitiesTable === 'function') renderActivitiesTable(); }, 100);
            if (index === 2) setTimeout(() => { if (typeof renderGantt === 'function') renderGantt(); }, 100);
            if (index === 3) setTimeout(() => { if (typeof initializeLSM === 'function') initializeLSM(); }, 100);
        };
        switchTab7Child._wrapped = true;
        } // end wrapper guard

        function initSidebar() {
            const sidebar = document.getElementById('mainSidebar');
            const toggle  = document.getElementById('sidebarToggle');
            if (!sidebar || !toggle) return;

            // Default to EXPANDED on first load
            const savedState = localStorage.getItem('kalyantraSidebarExpanded');
            if (savedState === null || savedState === 'true') {
                sidebar.classList.add('expanded');
            } else {
                sidebar.classList.remove('expanded');
            }

            // Toggle on click
            toggle.addEventListener('click', () => {
                sidebar.classList.toggle('expanded');
                localStorage.setItem('kalyantraSidebarExpanded', sidebar.classList.contains('expanded'));
            });
        }
    </script>

    <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // KALYANTRA BOQ ENGINE ‚Äî V1.0
    // BOQ items + TCS ‚Üí Auto-generated WBS + Activities + Schedule
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // ‚îÄ‚îÄ MORTH DEFAULT SEQUENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const MORTH_SEQUENCE = [
        { id:'CLR',  name:'Clearing & Grubbing',     unit:'Sqm', prodRate:500,  prodUnit:'Sqm/Hr', critical:false, monsoon:true  },
        { id:'EXCA', name:'Soil Excavation',         unit:'Cum', prodRate:62.71,prodUnit:'Cum/Hr',  critical:true,  monsoon:true  },
        { id:'ROCK', name:'Rock Excavation',         unit:'Cum', prodRate:15.68,prodUnit:'Cum/Hr',  critical:true,  monsoon:true  },
        { id:'EMBN', name:'Embankment',              unit:'Cum', prodRate:130.89,prodUnit:'Cum/Hr', critical:true,  monsoon:true  },
        { id:'SUBG', name:'Subgrade Preparation',   unit:'Sqm', prodRate:400,  prodUnit:'Sqm/Hr',  critical:false, monsoon:true  },
        { id:'GSB',  name:'Granular Sub Base (GSB)', unit:'Cum', prodRate:76.99,prodUnit:'Cum/Hr',  critical:false, monsoon:true  },
        { id:'WMM',  name:'Wet Mix Macadam (WMM)',   unit:'Cum', prodRate:65.40,prodUnit:'Cum/Hr',  critical:false, monsoon:true  },
        { id:'WBM',  name:'Water Bound Macadam (WBM)',unit:'Cum',prodRate:55.0, prodUnit:'Cum/Hr',  critical:false, monsoon:true  },
        { id:'DBM',  name:'Dense Bituminous Macadam',unit:'Cum', prodRate:45.20,prodUnit:'Cum/Hr',  critical:true,  monsoon:false },
        { id:'BC',   name:'Bituminous Concrete (BC)',unit:'Cum', prodRate:38.10,prodUnit:'Cum/Hr',  critical:true,  monsoon:false },
        { id:'SHLD', name:'Shoulders & Drains',     unit:'Mtr', prodRate:80,   prodUnit:'Mtr/Hr',  critical:false, monsoon:true  },
        { id:'MISC', name:'Miscellaneous Works',    unit:'LS',  prodRate:1,    prodUnit:'LS/day',   critical:false, monsoon:false }
    ];

    const STRUCTURE_SEQUENCE = [
        { id:'S_EXCA', name:'Excavation',           unit:'Cum', prodRate:20, prodUnit:'Cum/Hr', critical:false, monsoon:true  },
        { id:'S_PCC',  name:'PCC Foundation',       unit:'Cum', prodRate:8,  prodUnit:'Cum/Hr', critical:true,  monsoon:false },
        { id:'S_RCC',  name:'RCC Construction',     unit:'Cum', prodRate:5,  prodUnit:'Cum/Hr', critical:true,  monsoon:false },
        { id:'S_FORM', name:'Form Work',            unit:'Sqm', prodRate:20, prodUnit:'Sqm/Hr', critical:true,  monsoon:false },
        { id:'S_CURE', name:'Curing',               unit:'days',prodRate:1,  prodUnit:'days',   critical:true,  monsoon:false },
        { id:'S_BACK', name:'Backfill & Compact',   unit:'Cum', prodRate:25, prodUnit:'Cum/Hr', critical:false, monsoon:true  },
        { id:'S_APPR', name:'Approach Road',        unit:'Mtr', prodRate:50, prodUnit:'Mtr/Hr', critical:false, monsoon:true  }
    ];

    // ‚îÄ‚îÄ ITEM NUMBER SYSTEMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const ITEM_SYSTEMS = [
        { value:'morth',  label:'MoRTH Standard (300/400/500 series)' },
        { value:'cpwd',   label:'CPWD Schedule (Part I/II/III)' },
        { value:'own',    label:'Contractor Own Numbering' },
        { value:'auto',   label:'Auto Sequential (1, 2, 3...)' }
    ];

    // ‚îÄ‚îÄ HELPER: Format chainage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function fmtCh(m) {
        const k = Math.floor(m/1000); const r = m%1000;
        return k + '+' + String(r).padStart(3,'0');
    }
    function parseCh(str) {
        if (!str) return 0;
        const s = String(str).replace(/\s/g,'');
        if (s.includes('+')) {
            const p = s.split('+');
            return parseInt(p[0]||0)*1000 + parseInt(p[1]||0);
        }
        return parseInt(s)||0;
    }

    // ‚îÄ‚îÄ HELPER: Get hindrances for chainage range ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function boqGetBlockedMetres(fromCh, toCh) {
        const hindrances = KALYANTRA.data.hindrances || [];
        let blocked = 0;
        const blockedList = [];
        hindrances.filter(h => h.status !== 'Resolved').forEach(h => {
            const hStart = Math.max(h.chainageStart, fromCh);
            const hEnd   = Math.min(h.chainageEnd, toCh);
            if (hEnd > hStart) {
                blocked += (hEnd - hStart);
                blockedList.push({ name:h.name, start:hStart, end:hEnd, metres:(hEnd-hStart) });
            }
        });
        return { blocked, workable: (toCh-fromCh) - blocked, list: blockedList };
    }

    // ‚îÄ‚îÄ HELPER: Calculate duration from qty + rate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function calcDuration(qty, unit, prodRate, hoursPerDay) {
        const hpd = hoursPerDay || 8;
        if (!qty || !prodRate) return 1;
        if (unit === 'LS' || unit === 'days') return Math.max(1, Math.ceil(qty));
        const days = Math.ceil(qty / (prodRate * hpd));
        return Math.max(1, days);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // RENDER BOQ SECTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderBOQSections() {
        const boq = KALYANTRA.data.boq || {};
        const sections = boq.sections || [];
        const structBOQ = boq.structureBOQ || [];
        const container = document.getElementById('boqSectionsList');
        const emptyState = document.getElementById('boqEmptyState');
        const summaryBar = document.getElementById('boqSummaryBar');
        if (!container) return;

        const total = sections.length + structBOQ.length;
        emptyState.style.display = total === 0 ? 'block' : 'none';
        summaryBar.style.display = total === 0 ? 'none' : 'flex';

        let html = '';

        // Road work sections
        sections.forEach((sec, si) => {
            const items = sec.items || [];
            const linItems = sec.linearItems || [];
            const totalAmt = items.reduce((s,it) => s + ((it.qty||0)*(it.rate||0)), 0);
            const linAmt   = linItems.reduce((s,it) => s + ((it.length||0)*(it.rate||0)), 0);
            const hindrInfo = boqGetBlockedMetres(sec.fromCh||0, sec.toCh||0);
            const sectionLen = (sec.toCh||0) - (sec.fromCh||0);
            const hasDeviation = items.some(it => it.actualQty && it.qty && (it.actualQty/it.qty) > 1.10);

            html += `
            <div class="section" style="margin-bottom:16px;" id="boqSec_${si}">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div style="background:var(--navy);color:var(--accent-gold);padding:4px 10px;border-radius:4px;font-size:0.72rem;font-weight:700;">
                            SECTION ${si+1}
                        </div>
                        <div>
                            <div style="font-weight:700;color:var(--navy);font-size:0.9rem;">
                                ${sec.name || 'Road Works'} 
                                <span style="color:var(--text-secondary);font-weight:400;"> ‚Äî Ch ${fmtCh(sec.fromCh||0)} to ${fmtCh(sec.toCh||0)} (${(sectionLen/1000).toFixed(3)} km)</span>
                            </div>
                            <div style="font-size:0.72rem;color:var(--text-secondary);margin-top:2px;">
                                Item System: <b>${(ITEM_SYSTEMS.find(s=>s.value===sec.itemSystem)||{label:'Own'}).label}</b>
                                ${hindrInfo.blocked > 0 ? `&nbsp;|&nbsp;<span style="color:#dc2626;">üöß ${hindrInfo.blocked}m blocked by ${hindrInfo.list.length} hindrance(s)</span>` : '&nbsp;|&nbsp;<span style="color:#16a34a;">‚úÖ No hindrances</span>'}
                                ${hasDeviation ? '&nbsp;|&nbsp;<span style="color:#f59e0b;font-weight:700;">‚ö†Ô∏è Deviation alert</span>' : ''}
                            </div>
                        </div>
                    </div>
                    <div style="display:flex;gap:6px;align-items:center;">
                        <div style="text-align:right;margin-right:8px;">
                            <div style="font-size:0.95rem;font-weight:700;color:var(--navy);">‚Çπ${(totalAmt/100000).toFixed(2)}L</div>
                            <div style="font-size:0.68rem;color:var(--text-secondary);">BOQ Items</div>
                        </div>
                        <div style="text-align:right;margin-right:8px;">
                            <div style="font-size:0.95rem;font-weight:700;color:#7c3aed;">‚Çπ${(linAmt/100000).toFixed(2)}L</div>
                            <div style="font-size:0.68rem;color:var(--text-secondary);">Linear Items</div>
                        </div>
                        <button onclick="boqEditSection(${si})" style="background:#e0f2fe;color:#0369a1;border:none;padding:5px 10px;border-radius:4px;font-size:0.75rem;cursor:pointer;">‚úèÔ∏è Edit</button>
                        <button onclick="boqDeleteSection(${si})" style="background:#fee2e2;color:#dc2626;border:none;padding:5px 10px;border-radius:4px;font-size:0.75rem;cursor:pointer;">üóëÔ∏è</button>
                    </div>
                </div>

                <!-- TWO TABS: BOQ ITEMS / LINEAR ITEMS -->
                <div style="display:flex;gap:0;border-bottom:2px solid var(--border-light);margin-bottom:12px;">
                    <button onclick="boqSwitchSubTab(${si},'items')" id="boqSubTab_${si}_items"
                        style="padding:6px 16px;border:none;background:var(--navy);color:var(--accent-gold);font-weight:700;font-size:0.78rem;cursor:pointer;border-radius:4px 4px 0 0;">
                        üì¶ BOQ Items (${items.length})
                    </button>
                    <button onclick="boqSwitchSubTab(${si},'linear')" id="boqSubTab_${si}_linear"
                        style="padding:6px 16px;border:none;background:#f1f5f9;color:var(--text-secondary);font-size:0.78rem;cursor:pointer;border-radius:4px 4px 0 0;">
                        üìè Linear Items (${linItems.length})
                    </button>
                </div>

                <!-- BOQ ITEMS TABLE -->
                <div id="boqItemsPanel_${si}">
                    ${renderBOQItemsTable(si, items, hindrInfo)}
                    <button onclick="boqAddItem(${si})" style="margin-top:8px;background:var(--accent-gold);color:#1B3B6F;border:none;padding:5px 14px;border-radius:4px;font-size:0.78rem;font-weight:700;cursor:pointer;">
                        + Add BOQ Item
                    </button>
                </div>

                <!-- LINEAR ITEMS TABLE -->
                <div id="boqLinearPanel_${si}" style="display:none;">
                    ${renderLinearItemsTable(si, linItems, sec)}
                    <button onclick="boqAddLinearItem(${si})" style="margin-top:8px;background:#7c3aed;color:#fff;border:none;padding:5px 14px;border-radius:4px;font-size:0.78rem;font-weight:700;cursor:pointer;">
                        + Add Linear Item
                    </button>
                </div>
            </div>`;
        });

        // Structure BOQ sections
        structBOQ.forEach((sb, si) => {
            const struct = (KALYANTRA.data.structures||[]).find(s=>s.id==sb.structureId) || {};
            html += `
            <div class="section" style="margin-bottom:16px;border-left:4px solid #7c3aed;" id="boqStructSec_${si}">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;">
                    <div>
                        <div style="font-weight:700;color:var(--navy);">üåâ ${struct.name || sb.structureName || 'Structure'} BOQ</div>
                        <div style="font-size:0.72rem;color:var(--text-secondary);">Ch ${fmtCh(struct.chainage||sb.chainage||0)} ‚Äî Uploaded BOQ</div>
                    </div>
                    <div style="display:flex;gap:6px;">
                        <button onclick="boqViewStructure(${si})" style="background:#ede9fe;color:#7c3aed;border:none;padding:5px 10px;border-radius:4px;font-size:0.75rem;cursor:pointer;">üëÅÔ∏è View Items (${(sb.items||[]).length})</button>
                        <button onclick="boqDeleteStructure(${si})" style="background:#fee2e2;color:#dc2626;border:none;padding:5px 10px;border-radius:4px;font-size:0.75rem;cursor:pointer;">üóëÔ∏è</button>
                    </div>
                </div>
                <div id="boqStructDetails_${si}" style="display:none;margin-top:10px;">
                    ${renderStructureBOQTable(sb)}
                </div>
            </div>`;
        });

        container.innerHTML = html;
        updateBOQSummary();
    }

    function renderBOQItemsTable(si, items, hindrInfo) {
        if (items.length === 0) return '<div style="color:var(--text-secondary);font-size:0.8rem;padding:8px 0;">No BOQ items yet. Add items to track productivity.</div>';
        let rows = items.map((it, ii) => {
            const amt = (it.qty||0) * (it.rate||0);
            const workableQty = it.qty ? (it.qty * (1 - (hindrInfo.blocked / Math.max(1,(hindrInfo.blocked+hindrInfo.workable))))).toFixed(0) : 0;
            const deviation = it.actualQty && it.qty ? ((it.actualQty/it.qty - 1)*100).toFixed(1) : null;
            const devStyle = deviation && Math.abs(deviation) > 25 ? 'color:#dc2626;font-weight:700;' : deviation && Math.abs(deviation) > 10 ? 'color:#f59e0b;font-weight:600;' : 'color:#16a34a;';
            return `<tr>
                <td style="padding:5px 8px;font-size:0.78rem;color:var(--text-secondary);">${it.itemNo||'-'}</td>
                <td style="padding:5px 8px;font-size:0.8rem;font-weight:600;">${it.description||'-'}</td>
                <td style="padding:5px 8px;font-size:0.78rem;text-align:center;">${it.unit||'-'}</td>
                <td style="padding:5px 8px;font-size:0.78rem;text-align:right;">${(it.qty||0).toLocaleString()}</td>
                <td style="padding:5px 8px;font-size:0.72rem;text-align:right;color:#dc2626;">${workableQty < it.qty ? workableQty + " ‚ö†" : "‚úÖ"}</td>
                <td style="padding:5px 8px;font-size:0.78rem;text-align:right;">‚Çπ${(it.rate||0).toLocaleString()}</td>
                <td style="padding:5px 8px;font-size:0.78rem;text-align:right;font-weight:700;">‚Çπ${(amt/100000).toFixed(2)}L</td>
                <td style="padding:5px 8px;font-size:0.78rem;text-align:right;">
                    <input type="number" value="${it.actualQty||''}" placeholder="0"
                        onchange="boqUpdateActualQty(${si},${ii},this.value)"
                        style="width:70px;padding:3px 6px;border:1px solid var(--border-light);border-radius:3px;font-size:0.75rem;text-align:right;">
                </td>
                ${deviation !== null ? `<td style="padding:5px 8px;font-size:0.78rem;text-align:center;${devStyle}">${deviation > 0 ? '+' : ''}${deviation}%</td>` : '<td></td>'}
                <td style="padding:5px 8px;">
                    <button onclick="boqDeleteItem(${si},${ii})" style="background:#fee2e2;color:#dc2626;border:none;padding:2px 7px;border-radius:3px;font-size:0.72rem;cursor:pointer;">‚úï</button>
                </td>
            </tr>`;
        }).join('');
        const totalAmt = items.reduce((s,it)=>s+((it.qty||0)*(it.rate||0)),0);
        return `<div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;font-size:0.78rem;">
            <thead><tr style="background:var(--navy);color:#fff;">
                <th style="padding:6px 8px;text-align:left;font-size:0.72rem;">Item No</th>
                <th style="padding:6px 8px;text-align:left;">Description</th>
                <th style="padding:6px 8px;text-align:center;">Unit</th>
                <th style="padding:6px 8px;text-align:right;">BOQ Qty</th>
                <th style="padding:6px 8px;text-align:right;font-size:0.68rem;">Workable</th>
                <th style="padding:6px 8px;text-align:right;">Rate(‚Çπ)</th>
                <th style="padding:6px 8px;text-align:right;">Amount</th>
                <th style="padding:6px 8px;text-align:right;background:#1e4a8a;">Actual Qty</th>
                <th style="padding:6px 8px;text-align:center;background:#1e4a8a;font-size:0.68rem;">Deviation</th>
                <th style="padding:6px 8px;"></th>
            </tr></thead>
            <tbody>${rows}</tbody>
            <tfoot><tr style="background:#f8fafc;font-weight:700;">
                <td colspan="6" style="padding:6px 8px;text-align:right;font-size:0.78rem;">Section Total:</td>
                <td style="padding:6px 8px;text-align:right;color:var(--navy);">‚Çπ${(totalAmt/100000).toFixed(2)}L</td>
                <td colspan="3"></td>
            </tr></tfoot>
        </table></div>`;
    }

    function renderLinearItemsTable(si, items, sec) {
        if (items.length === 0) return '<div style="color:var(--text-secondary);font-size:0.8rem;padding:8px 0;">No linear items yet. Add items for financial progress tracking (‚Çπ/Mtr or ‚Çπ/Km).</div>';
        let rows = items.map((it, ii) => {
            const len = (it.toCh||0) - (it.fromCh||0);
            const amt = len * (it.rate||0);
            const doneLen = (it.doneToCh||0) - (it.fromCh||0);
            const pct = len > 0 ? Math.min(100, Math.round((doneLen/len)*100)) : 0;
            return `<tr>
                <td style="padding:5px 8px;font-size:0.78rem;">${fmtCh(it.fromCh||0)}</td>
                <td style="padding:5px 8px;font-size:0.78rem;">${fmtCh(it.toCh||0)}</td>
                <td style="padding:5px 8px;font-size:0.8rem;font-weight:600;">${it.description||'-'}</td>
                <td style="padding:5px 8px;text-align:center;font-size:0.78rem;">${it.unit||'/Mtr'}</td>
                <td style="padding:5px 8px;text-align:right;font-size:0.78rem;">${(len).toLocaleString()} m</td>
                <td style="padding:5px 8px;text-align:right;font-size:0.78rem;">‚Çπ${(it.rate||0).toLocaleString()}</td>
                <td style="padding:5px 8px;text-align:right;font-weight:700;font-size:0.78rem;">‚Çπ${(amt/100000).toFixed(2)}L</td>
                <td style="padding:5px 8px;">
                    <input type="text" value="${it.doneToCh ? fmtCh(it.doneToCh) : ''}" placeholder="${fmtCh(it.fromCh||0)}"
                        onchange="boqUpdateLinearProgress(${si},${ii},this.value)"
                        style="width:80px;padding:3px 6px;border:1px solid var(--border-light);border-radius:3px;font-size:0.75rem;">
                </td>
                <td style="padding:5px 8px;">
                    <div style="background:#e2e8f0;border-radius:3px;height:6px;width:80px;">
                        <div style="background:${pct>=100?'#16a34a':pct>50?'#f59e0b':'#3b82f6'};height:6px;border-radius:3px;width:${pct}%;"></div>
                    </div>
                    <div style="font-size:0.65rem;color:var(--text-secondary);text-align:center;">${pct}%</div>
                </td>
                <td style="padding:5px 8px;">
                    <button onclick="boqDeleteLinearItem(${si},${ii})" style="background:#fee2e2;color:#dc2626;border:none;padding:2px 7px;border-radius:3px;font-size:0.72rem;cursor:pointer;">‚úï</button>
                </td>
            </tr>`;
        }).join('');
        const totalAmt = items.reduce((s,it)=>s+((it.toCh-it.fromCh||0)*(it.rate||0)),0);
        return `<div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;font-size:0.78rem;">
            <thead><tr style="background:#7c3aed;color:#fff;">
                <th style="padding:6px 8px;">From Ch</th>
                <th style="padding:6px 8px;">To Ch</th>
                <th style="padding:6px 8px;text-align:left;">Description</th>
                <th style="padding:6px 8px;text-align:center;">Unit</th>
                <th style="padding:6px 8px;text-align:right;">Length</th>
                <th style="padding:6px 8px;text-align:right;">Rate</th>
                <th style="padding:6px 8px;text-align:right;">Amount</th>
                <th style="padding:6px 8px;text-align:center;">Done to Ch</th>
                <th style="padding:6px 8px;text-align:center;">Progress</th>
                <th style="padding:6px 8px;"></th>
            </tr></thead>
            <tbody>${rows}</tbody>
            <tfoot><tr style="background:#f8fafc;font-weight:700;">
                <td colspan="6" style="padding:6px 8px;text-align:right;font-size:0.78rem;">Linear Total:</td>
                <td style="padding:6px 8px;text-align:right;color:#7c3aed;">‚Çπ${(totalAmt/100000).toFixed(2)}L</td>
                <td colspan="3"></td>
            </tr></tfoot>
        </table></div>`;
    }

    function renderStructureBOQTable(sb) {
        const items = sb.items || [];
        if (!items.length) return '<div style="color:var(--text-secondary);font-size:0.8rem;">No items uploaded.</div>';
        let rows = items.map(it => `<tr>
            <td style="padding:5px 8px;font-size:0.78rem;">${it.itemNo||'-'}</td>
            <td style="padding:5px 8px;font-size:0.8rem;">${it.description||'-'}</td>
            <td style="padding:5px 8px;text-align:center;font-size:0.78rem;">${it.unit||'-'}</td>
            <td style="padding:5px 8px;text-align:right;font-size:0.78rem;">${(it.qty||0).toLocaleString()}</td>
            <td style="padding:5px 8px;text-align:right;font-size:0.78rem;">‚Çπ${(it.rate||0).toLocaleString()}</td>
            <td style="padding:5px 8px;text-align:right;font-weight:700;font-size:0.78rem;">‚Çπ${((it.qty||0)*(it.rate||0)/100000).toFixed(2)}L</td>
        </tr>`).join('');
        return `<table style="width:100%;border-collapse:collapse;font-size:0.78rem;">
            <thead><tr style="background:#7c3aed;color:#fff;">
                <th style="padding:6px 8px;">Item No</th><th style="padding:6px 8px;text-align:left;">Description</th>
                <th style="padding:6px 8px;text-align:center;">Unit</th><th style="padding:6px 8px;text-align:right;">Qty</th>
                <th style="padding:6px 8px;text-align:right;">Rate</th><th style="padding:6px 8px;text-align:right;">Amount</th>
            </tr></thead><tbody>${rows}</tbody></table>`;
    }

    // ‚îÄ‚îÄ UPDATE SUMMARY BAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updateBOQSummary() {
        const boq = KALYANTRA.data.boq || {};
        const sections = boq.sections || [];
        let totalVal = 0, earnedVal = 0, blockedVal = 0, deviations = 0;
        sections.forEach(sec => {
            (sec.items||[]).forEach(it => {
                const amt = (it.qty||0)*(it.rate||0);
                totalVal += amt;
                if (it.actualQty && it.qty) {
                    earnedVal += Math.min(it.actualQty, it.qty) * (it.rate||0);
                    if ((it.actualQty/it.qty) > 1.25) deviations++;
                }
            });
            (sec.linearItems||[]).forEach(it => {
                const len = (it.toCh||0)-(it.fromCh||0);
                totalVal += len*(it.rate||0);
                if (it.doneToCh) {
                    const doneLen = (it.doneToCh||0)-(it.fromCh||0);
                    earnedVal += doneLen*(it.rate||0);
                }
            });
            const hindrInfo = boqGetBlockedMetres(sec.fromCh||0, sec.toCh||0);
            if (hindrInfo.blocked > 0) {
                const perMetre = (sec.items||[]).reduce((s,it) => s + ((it.qty||0)*(it.rate||0)), 0) / Math.max(1,(sec.toCh||0)-(sec.fromCh||0));
                blockedVal += hindrInfo.blocked * perMetre;
            }
        });
        const pct = totalVal > 0 ? (earnedVal/totalVal*100).toFixed(1) : '0.0';
        const setT = (id,v) => { const el=document.getElementById(id); if(el) el.textContent=v; };
        setT('boqTotalValue', '‚Çπ'+(totalVal/10000000).toFixed(2)+' Cr');
        setT('boqEarnedValue', '‚Çπ'+(earnedVal/10000000).toFixed(2)+' Cr');
        setT('boqFinancialPct', pct+'%');
        setT('boqBlockedValue', '‚Çπ'+(blockedVal/100000).toFixed(2)+' L');
        setT('boqDeviationCount', deviations);
        // Update KALYANTRA financial progress
        if (KALYANTRA.computed) {
            KALYANTRA.computed.financialProgress = parseFloat(pct)||0;
        }
    }

    // ‚îÄ‚îÄ SUB-TAB SWITCHING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function boqSwitchSubTab(si, tab) {
        const itemsPanel  = document.getElementById('boqItemsPanel_'+si);
        const linearPanel = document.getElementById('boqLinearPanel_'+si);
        const btnItems    = document.getElementById('boqSubTab_'+si+'_items');
        const btnLinear   = document.getElementById('boqSubTab_'+si+'_linear');
        if (!itemsPanel) return;
        if (tab === 'items') {
            itemsPanel.style.display  = 'block';
            linearPanel.style.display = 'none';
            if (btnItems)  { btnItems.style.background=  'var(--navy)';   btnItems.style.color='var(--accent-gold)'; btnItems.style.fontWeight='700'; }
            if (btnLinear) { btnLinear.style.background= '#f1f5f9'; btnLinear.style.color='var(--text-secondary)'; btnLinear.style.fontWeight='400'; }
        } else {
            itemsPanel.style.display  = 'none';
            linearPanel.style.display = 'block';
            if (btnLinear) { btnLinear.style.background= '#7c3aed'; btnLinear.style.color='#fff'; btnLinear.style.fontWeight='700'; }
            if (btnItems)  { btnItems.style.background= '#f1f5f9'; btnItems.style.color='var(--text-secondary)'; btnItems.style.fontWeight='400'; }
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ADD / EDIT SECTION MODAL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function boqAddSection() {
        const p = KALYANTRA.data.project || {};
        showBOQSectionModal(-1, {
            name:'Road Works', fromCh: p.startChainage||0,
            toCh: p.endChainage||5000, itemSystem:'morth', items:[], linearItems:[]
        });
    }
    function boqEditSection(si) {
        const sec = (KALYANTRA.data.boq.sections||[])[si];
        if (sec) showBOQSectionModal(si, sec);
    }
    function showBOQSectionModal(si, sec) {
        const existing = document.getElementById('boqSectionModal');
        if (existing) existing.remove();
        const modal = document.createElement('div');
        modal.id = 'boqSectionModal';
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
        modal.innerHTML = `
        <div style="background:#fff;border-radius:10px;padding:24px;width:480px;max-width:95vw;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <div style="font-weight:700;color:var(--navy);font-size:1rem;">${si===-1?'Add New BOQ Section':'Edit BOQ Section'}</div>
                <button onclick="document.getElementById('boqSectionModal').remove()" style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--text-secondary);">‚úï</button>
            </div>
            <div style="display:grid;gap:14px;">
                <div>
                    <label style="font-size:0.78rem;font-weight:600;color:var(--navy);display:block;margin-bottom:4px;">Section Name</label>
                    <input id="bsName" type="text" value="${sec.name||''}" placeholder="e.g. Road Works, Embankment Zone"
                        style="width:100%;padding:8px 10px;border:1px solid var(--border-medium);border-radius:5px;font-size:0.85rem;box-sizing:border-box;">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div>
                        <label style="font-size:0.78rem;font-weight:600;color:var(--navy);display:block;margin-bottom:4px;">From Chainage</label>
                        <input id="bsFromCh" type="text" value="${fmtCh(sec.fromCh||0)}" placeholder="0+000"
                            style="width:100%;padding:8px 10px;border:1px solid var(--border-medium);border-radius:5px;font-size:0.85rem;box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="font-size:0.78rem;font-weight:600;color:var(--navy);display:block;margin-bottom:4px;">To Chainage</label>
                        <input id="bsToCh" type="text" value="${fmtCh(sec.toCh||0)}" placeholder="5+000"
                            style="width:100%;padding:8px 10px;border:1px solid var(--border-medium);border-radius:5px;font-size:0.85rem;box-sizing:border-box;">
                    </div>
                </div>
                <div>
                    <label style="font-size:0.78rem;font-weight:600;color:var(--navy);display:block;margin-bottom:4px;">Item Numbering System</label>
                    <select id="bsItemSystem" style="width:100%;padding:8px 10px;border:1px solid var(--border-medium);border-radius:5px;font-size:0.85rem;box-sizing:border-box;">
                        ${ITEM_SYSTEMS.map(s=>`<option value="${s.value}" ${sec.itemSystem===s.value?'selected':''}>${s.label}</option>`).join('')}
                    </select>
                </div>
            </div>
            <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end;">
                <button onclick="document.getElementById('boqSectionModal').remove()" 
                    style="padding:8px 18px;border:1px solid var(--border-medium);background:#fff;border-radius:5px;cursor:pointer;font-size:0.85rem;">Cancel</button>
                <button onclick="boqSaveSectionModal(${si})"
                    style="padding:8px 18px;background:var(--navy);color:var(--accent-gold);border:none;border-radius:5px;font-weight:700;cursor:pointer;font-size:0.85rem;">
                    ${si===-1?'Add Section':'Save Changes'}
                </button>
            </div>
        </div>`;
        document.body.appendChild(modal);
    }
    function boqSaveSectionModal(si) {
        const name     = document.getElementById('bsName').value.trim() || 'Road Works';
        const fromCh   = parseCh(document.getElementById('bsFromCh').value);
        const toCh     = parseCh(document.getElementById('bsToCh').value);
        const itemSys  = document.getElementById('bsItemSystem').value;
        if (!KALYANTRA.data.boq) KALYANTRA.data.boq = {sections:[],structureBOQ:[],generationConfig:{sequence:[],productivityRates:{},confirmed:false}};
        if (!KALYANTRA.data.boq.sections) KALYANTRA.data.boq.sections = [];
        if (si === -1) {
            KALYANTRA.data.boq.sections.push({ name, fromCh, toCh, itemSystem:itemSys, items:[], linearItems:[] });
        } else {
            const existing = KALYANTRA.data.boq.sections[si] || {};
            KALYANTRA.data.boq.sections[si] = { ...existing, name, fromCh, toCh, itemSystem:itemSys };
        }
        KALYANTRA.save();
        document.getElementById('boqSectionModal').remove();
        renderBOQSections();
        showToast(si===-1 ? '‚úÖ Section added' : '‚úÖ Section updated', 'success');
    }
    function boqDeleteSection(si) {
        if (!confirm('Delete this BOQ section and all its items?')) return;
        KALYANTRA.data.boq.sections.splice(si, 1);
        KALYANTRA.save();
        renderBOQSections();
        showToast('üóëÔ∏è Section deleted', 'info');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ADD BOQ ITEM MODAL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function boqAddItem(si) {
        const existing = document.getElementById('boqItemModal');
        if (existing) existing.remove();
        // Get suggested prod rates from MORTH_SEQUENCE
        const prodOptions = MORTH_SEQUENCE.map(m =>
            `<option value="${m.id}">${m.name} (${m.prodRate} ${m.prodUnit})</option>`
        ).join('');
        const modal = document.createElement('div');
        modal.id = 'boqItemModal';
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
        modal.innerHTML = `
        <div style="background:#fff;border-radius:10px;padding:24px;width:520px;max-width:95vw;box-shadow:0 20px 60px rgba(0,0,0,0.3);max-height:90vh;overflow-y:auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
                <div style="font-weight:700;color:var(--navy);font-size:1rem;">üì¶ Add BOQ Item</div>
                <button onclick="document.getElementById('boqItemModal').remove()" style="background:none;border:none;font-size:1.2rem;cursor:pointer;">‚úï</button>
            </div>
            <div style="display:grid;gap:12px;">
                <div style="display:grid;grid-template-columns:1fr 2fr;gap:10px;">
                    <div>
                        <label style="font-size:0.76rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">Item No.</label>
                        <input id="biItemNo" type="text" placeholder="e.g. 301, 2.1.1"
                            style="width:100%;padding:7px 9px;border:1px solid var(--border-medium);border-radius:4px;font-size:0.83rem;box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="font-size:0.76rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">Description</label>
                        <input id="biDesc" type="text" placeholder="e.g. Soil Excavation in ordinary soil"
                            style="width:100%;padding:7px 9px;border:1px solid var(--border-medium);border-radius:4px;font-size:0.83rem;box-sizing:border-box;">
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
                    <div>
                        <label style="font-size:0.76rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">Unit</label>
                        <select id="biUnit" style="width:100%;padding:7px 9px;border:1px solid var(--border-medium);border-radius:4px;font-size:0.83rem;box-sizing:border-box;">
                            <option>Cum</option><option>Sqm</option><option>Mtr</option><option>MT</option>
                            <option>Nos</option><option>RMT</option><option>LS</option><option>Kg</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.76rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">BOQ Quantity</label>
                        <input id="biQty" type="number" placeholder="0"
                            style="width:100%;padding:7px 9px;border:1px solid var(--border-medium);border-radius:4px;font-size:0.83rem;box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="font-size:0.76rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">Rate (‚Çπ/unit)</label>
                        <input id="biRate" type="number" placeholder="0"
                            style="width:100%;padding:7px 9px;border:1px solid var(--border-medium);border-radius:4px;font-size:0.83rem;box-sizing:border-box;">
                    </div>
                </div>
                <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:6px;padding:10px;">
                    <div style="font-size:0.76rem;font-weight:600;color:#15803d;margin-bottom:6px;">‚ö° Activity Link (for WBS generation)</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                        <div>
                            <label style="font-size:0.74rem;color:#166534;display:block;margin-bottom:3px;">Link to Activity Type</label>
                            <select id="biActivityLink" onchange="boqSuggestProdRate()" style="width:100%;padding:6px 8px;border:1px solid #bbf7d0;border-radius:4px;font-size:0.8rem;box-sizing:border-box;">
                                <option value="">-- Select (optional) --</option>
                                ${prodOptions}
                            </select>
                        </div>
                        <div>
                            <label style="font-size:0.74rem;color:#166534;display:block;margin-bottom:3px;">Productivity Rate (for duration)</label>
                            <input id="biProdRate" type="number" placeholder="Auto-suggested"
                                style="width:100%;padding:6px 8px;border:1px solid #bbf7d0;border-radius:4px;font-size:0.8rem;box-sizing:border-box;">
                            <div id="biProdHint" style="font-size:0.68rem;color:#16a34a;margin-top:2px;"></div>
                        </div>
                    </div>
                </div>
                <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:6px;padding:10px;">
                    <div style="font-size:0.76rem;font-weight:600;color:#1d4ed8;margin-bottom:6px;">üìè Dual Unit (optional ‚Äî for billing in /Mtr)</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                        <div>
                            <label style="font-size:0.74rem;color:#1e40af;display:block;margin-bottom:3px;">Billing Unit</label>
                            <select id="biLinearUnit" style="width:100%;padding:6px 8px;border:1px solid #bfdbfe;border-radius:4px;font-size:0.8rem;box-sizing:border-box;">
                                <option value="">None</option>
                                <option>/Mtr</option><option>/Km</option><option>/RMT</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:0.74rem;color:#1e40af;display:block;margin-bottom:3px;">Conversion (units per metre)</label>
                            <input id="biConversion" type="number" placeholder="e.g. 2.5 Cum/Mtr"
                                style="width:100%;padding:6px 8px;border:1px solid #bfdbfe;border-radius:4px;font-size:0.8rem;box-sizing:border-box;">
                        </div>
                    </div>
                </div>
            </div>
            <div style="display:flex;gap:10px;margin-top:16px;justify-content:flex-end;">
                <button onclick="document.getElementById('boqItemModal').remove()"
                    style="padding:8px 16px;border:1px solid var(--border-medium);background:#fff;border-radius:5px;cursor:pointer;font-size:0.83rem;">Cancel</button>
                <button onclick="boqSaveItemModal(${si})"
                    style="padding:8px 18px;background:var(--navy);color:var(--accent-gold);border:none;border-radius:5px;font-weight:700;cursor:pointer;font-size:0.83rem;">
                    Add Item
                </button>
            </div>
        </div>`;
        document.body.appendChild(modal);
    }

    function boqSuggestProdRate() {
        const sel = document.getElementById('biActivityLink');
        const hint = document.getElementById('biProdHint');
        const rateEl = document.getElementById('biProdRate');
        if (!sel || !sel.value) return;
        const match = MORTH_SEQUENCE.find(m => m.id === sel.value);
        if (match && rateEl && !rateEl.value) {
            rateEl.value = match.prodRate;
            if (hint) hint.textContent = `Suggested: ${match.prodRate} ${match.prodUnit} (MoRTH standard) ‚Äî override if needed`;
        }
    }

    function boqSaveItemModal(si) {
        const itemNo       = document.getElementById('biItemNo').value.trim();
        const description  = document.getElementById('biDesc').value.trim();
        const unit         = document.getElementById('biUnit').value;
        const qty          = parseFloat(document.getElementById('biQty').value) || 0;
        const rate         = parseFloat(document.getElementById('biRate').value) || 0;
        const activityLink = document.getElementById('biActivityLink').value;
        const prodRate     = parseFloat(document.getElementById('biProdRate').value) || 0;
        const linearUnit   = document.getElementById('biLinearUnit').value;
        const conversion   = parseFloat(document.getElementById('biConversion').value) || 0;
        if (!description) { showToast('Please enter item description', 'error'); return; }
        const item = { itemNo, description, unit, qty, rate, activityLink, prodRate, linearUnit, conversion, actualQty:0 };
        if (!KALYANTRA.data.boq.sections[si].items) KALYANTRA.data.boq.sections[si].items = [];
        KALYANTRA.data.boq.sections[si].items.push(item);
        KALYANTRA.save();
        document.getElementById('boqItemModal').remove();
        renderBOQSections();
        showToast('‚úÖ BOQ item added', 'success');
    }

    function boqUpdateActualQty(si, ii, val) {
        KALYANTRA.data.boq.sections[si].items[ii].actualQty = parseFloat(val)||0;
        KALYANTRA.save();
        updateBOQSummary();
    }
    function boqDeleteItem(si, ii) {
        KALYANTRA.data.boq.sections[si].items.splice(ii, 1);
        KALYANTRA.save(); renderBOQSections();
    }

    // ‚îÄ‚îÄ ADD LINEAR ITEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function boqAddLinearItem(si) {
        const sec = KALYANTRA.data.boq.sections[si];
        const existing = document.getElementById('boqLinearModal');
        if (existing) existing.remove();
        const modal = document.createElement('div');
        modal.id = 'boqLinearModal';
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
        modal.innerHTML = `
        <div style="background:#fff;border-radius:10px;padding:24px;width:440px;max-width:95vw;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
                <div style="font-weight:700;color:#7c3aed;font-size:1rem;">üìè Add Linear Item</div>
                <button onclick="document.getElementById('boqLinearModal').remove()" style="background:none;border:none;font-size:1.2rem;cursor:pointer;">‚úï</button>
            </div>
            <div style="display:grid;gap:12px;">
                <div>
                    <label style="font-size:0.76rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">Description</label>
                    <input id="blDesc" type="text" placeholder="e.g. Road Formation, GSB Laying"
                        style="width:100%;padding:7px 9px;border:1px solid var(--border-medium);border-radius:4px;font-size:0.83rem;box-sizing:border-box;">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                    <div>
                        <label style="font-size:0.76rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">From Chainage</label>
                        <input id="blFromCh" type="text" value="${fmtCh(sec.fromCh||0)}"
                            style="width:100%;padding:7px 9px;border:1px solid var(--border-medium);border-radius:4px;font-size:0.83rem;box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="font-size:0.76rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">To Chainage</label>
                        <input id="blToCh" type="text" value="${fmtCh(sec.toCh||0)}"
                            style="width:100%;padding:7px 9px;border:1px solid var(--border-medium);border-radius:4px;font-size:0.83rem;box-sizing:border-box;">
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
                    <div>
                        <label style="font-size:0.76rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">Unit</label>
                        <select id="blUnit" style="width:100%;padding:7px 9px;border:1px solid var(--border-medium);border-radius:4px;font-size:0.83rem;box-sizing:border-box;">
                            <option>/Mtr</option><option>/Km</option><option>/RMT</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.76rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">Rate (‚Çπ)</label>
                        <input id="blRate" type="number" placeholder="0"
                            style="width:100%;padding:7px 9px;border:1px solid var(--border-medium);border-radius:4px;font-size:0.83rem;box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="font-size:0.76rem;font-weight:600;color:#16a34a;display:block;margin-bottom:3px;font-size:0.72rem;">Amount (auto)</label>
                        <div id="blAmtPreview" style="padding:7px 9px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:4px;font-size:0.83rem;font-weight:700;color:#15803d;">‚Çπ 0</div>
                    </div>
                </div>
            </div>
            <div style="display:flex;gap:10px;margin-top:16px;justify-content:flex-end;">
                <button onclick="document.getElementById('boqLinearModal').remove()"
                    style="padding:8px 16px;border:1px solid var(--border-medium);background:#fff;border-radius:5px;cursor:pointer;font-size:0.83rem;">Cancel</button>
                <button onclick="boqSaveLinearModal(${si})"
                    style="padding:8px 18px;background:#7c3aed;color:#fff;border:none;border-radius:5px;font-weight:700;cursor:pointer;font-size:0.83rem;">
                    Add Linear Item
                </button>
            </div>
        </div>`;
        document.body.appendChild(modal);
        // Live amount preview
        ['blFromCh','blToCh','blRate'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', () => {
                const from = parseCh(document.getElementById('blFromCh').value);
                const to   = parseCh(document.getElementById('blToCh').value);
                const rate = parseFloat(document.getElementById('blRate').value)||0;
                const len  = Math.max(0, to - from);
                const unit = document.getElementById('blUnit').value;
                const effRate = unit === '/Km' ? rate/1000 : rate;
                const amt = len * effRate;
                document.getElementById('blAmtPreview').textContent = '‚Çπ '+(amt/100000).toFixed(2)+'L';
            });
        });
    }
    function boqSaveLinearModal(si) {
        const desc    = document.getElementById('blDesc').value.trim();
        const fromCh  = parseCh(document.getElementById('blFromCh').value);
        const toCh    = parseCh(document.getElementById('blToCh').value);
        const unit    = document.getElementById('blUnit').value;
        const rate    = parseFloat(document.getElementById('blRate').value)||0;
        if (!desc) { showToast('Please enter description', 'error'); return; }
        if (!KALYANTRA.data.boq.sections[si].linearItems) KALYANTRA.data.boq.sections[si].linearItems = [];
        KALYANTRA.data.boq.sections[si].linearItems.push({ description:desc, fromCh, toCh, unit, rate, doneToCh:fromCh });
        KALYANTRA.save();
        document.getElementById('boqLinearModal').remove();
        renderBOQSections(); boqSwitchSubTab(si,'linear');
        showToast('‚úÖ Linear item added', 'success');
    }
    function boqUpdateLinearProgress(si, ii, val) {
        const ch = parseCh(val);
        KALYANTRA.data.boq.sections[si].linearItems[ii].doneToCh = ch;
        KALYANTRA.save(); updateBOQSummary();
    }
    function boqDeleteLinearItem(si, ii) {
        KALYANTRA.data.boq.sections[si].linearItems.splice(ii, 1);
        KALYANTRA.save(); renderBOQSections();
    }

    // ‚îÄ‚îÄ STRUCTURE BOQ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function boqAddStructureBOQ() {
        const structures = KALYANTRA.data.structures || [];
        if (!structures.length) { showToast('‚ö†Ô∏è Add structures in the Structures tab first', 'info'); return; }
        const existing = document.getElementById('boqStructModal');
        if (existing) existing.remove();
        const modal = document.createElement('div');
        modal.id = 'boqStructModal';
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
        modal.innerHTML = `
        <div style="background:#fff;border-radius:10px;padding:24px;width:500px;max-width:95vw;box-shadow:0 20px 60px rgba(0,0,0,0.3);max-height:85vh;overflow-y:auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
                <div style="font-weight:700;color:#7c3aed;font-size:1rem;">üåâ Add Structure BOQ</div>
                <button onclick="document.getElementById('boqStructModal').remove()" style="background:none;border:none;font-size:1.2rem;cursor:pointer;">‚úï</button>
            </div>
            <div style="margin-bottom:14px;">
                <label style="font-size:0.76rem;font-weight:600;color:var(--navy);display:block;margin-bottom:4px;">Select Structure</label>
                <select id="bsStructId" style="width:100%;padding:8px;border:1px solid var(--border-medium);border-radius:4px;font-size:0.85rem;">
                    ${structures.map(s=>`<option value="${s.id}">${s.name} (Ch ${fmtCh(s.chainage||0)})</option>`).join('')}
                </select>
            </div>
            <div style="background:#f5f3ff;border:1px solid #ddd6fe;border-radius:6px;padding:12px;margin-bottom:14px;">
                <div style="font-size:0.78rem;font-weight:600;color:#7c3aed;margin-bottom:8px;">Enter BOQ Items</div>
                <div id="structItemsContainer">
                    <div class="struct-item-row" style="display:grid;grid-template-columns:80px 1fr 70px 90px 90px 30px;gap:6px;margin-bottom:6px;">
                        <input placeholder="Item No" style="padding:5px 7px;border:1px solid #ddd6fe;border-radius:3px;font-size:0.78rem;">
                        <input placeholder="Description" style="padding:5px 7px;border:1px solid #ddd6fe;border-radius:3px;font-size:0.78rem;">
                        <input placeholder="Unit" style="padding:5px 7px;border:1px solid #ddd6fe;border-radius:3px;font-size:0.78rem;">
                        <input type="number" placeholder="Qty" style="padding:5px 7px;border:1px solid #ddd6fe;border-radius:3px;font-size:0.78rem;">
                        <input type="number" placeholder="Rate ‚Çπ" style="padding:5px 7px;border:1px solid #ddd6fe;border-radius:3px;font-size:0.78rem;">
                        <button onclick="this.closest('.struct-item-row').remove()" style="background:#fee2e2;color:#dc2626;border:none;border-radius:3px;cursor:pointer;font-size:0.8rem;">‚úï</button>
                    </div>
                </div>
                <button onclick="boqAddStructItemRow()" style="margin-top:4px;background:#7c3aed;color:#fff;border:none;padding:4px 12px;border-radius:3px;font-size:0.75rem;cursor:pointer;">+ Add Row</button>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
                <button onclick="document.getElementById('boqStructModal').remove()" style="padding:8px 16px;border:1px solid var(--border-medium);background:#fff;border-radius:5px;cursor:pointer;font-size:0.83rem;">Cancel</button>
                <button onclick="boqSaveStructureBOQ()" style="padding:8px 18px;background:#7c3aed;color:#fff;border:none;border-radius:5px;font-weight:700;cursor:pointer;font-size:0.83rem;">Save Structure BOQ</button>
            </div>
        </div>`;
        document.body.appendChild(modal);
    }
    function boqAddStructItemRow() {
        const container = document.getElementById('structItemsContainer');
        const row = document.createElement('div');
        row.className = 'struct-item-row';
        row.style.cssText = 'display:grid;grid-template-columns:80px 1fr 70px 90px 90px 30px;gap:6px;margin-bottom:6px;';
        row.innerHTML = `
            <input placeholder="Item No" style="padding:5px 7px;border:1px solid #ddd6fe;border-radius:3px;font-size:0.78rem;">
            <input placeholder="Description" style="padding:5px 7px;border:1px solid #ddd6fe;border-radius:3px;font-size:0.78rem;">
            <input placeholder="Unit" style="padding:5px 7px;border:1px solid #ddd6fe;border-radius:3px;font-size:0.78rem;">
            <input type="number" placeholder="Qty" style="padding:5px 7px;border:1px solid #ddd6fe;border-radius:3px;font-size:0.78rem;">
            <input type="number" placeholder="Rate ‚Çπ" style="padding:5px 7px;border:1px solid #ddd6fe;border-radius:3px;font-size:0.78rem;">
            <button onclick="this.closest('.struct-item-row').remove()" style="background:#fee2e2;color:#dc2626;border:none;border-radius:3px;cursor:pointer;font-size:0.8rem;">‚úï</button>`;
        container.appendChild(row);
    }
    function boqSaveStructureBOQ() {
        const structId = document.getElementById('bsStructId').value;
        const rows = document.querySelectorAll('#structItemsContainer .struct-item-row');
        const items = [];
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            if (inputs[1].value.trim()) {
                items.push({ itemNo:inputs[0].value.trim(), description:inputs[1].value.trim(),
                    unit:inputs[2].value.trim()||'Nos', qty:parseFloat(inputs[3].value)||0, rate:parseFloat(inputs[4].value)||0 });
            }
        });
        const struct = (KALYANTRA.data.structures||[]).find(s=>s.id==structId)||{};
        if (!KALYANTRA.data.boq.structureBOQ) KALYANTRA.data.boq.structureBOQ = [];
        KALYANTRA.data.boq.structureBOQ.push({ structureId:structId, structureName:struct.name||'Structure', chainage:struct.chainage||0, items });
        KALYANTRA.save();
        document.getElementById('boqStructModal').remove();
        renderBOQSections();
        showToast('‚úÖ Structure BOQ saved', 'success');
    }
    function boqViewStructure(si) {
        const panel = document.getElementById('boqStructDetails_'+si);
        if (panel) panel.style.display = panel.style.display==='none' ? 'block' : 'none';
    }
    function boqDeleteStructure(si) {
        if (!confirm('Delete this structure BOQ?')) return;
        KALYANTRA.data.boq.structureBOQ.splice(si,1);
        KALYANTRA.save(); renderBOQSections();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GENERATE WBS & SCHEDULE ‚Äî THE CORE ENGINE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function boqGenerateWBS() {
        const boq = KALYANTRA.data.boq || {};
        const sections = boq.sections || [];
        if (!sections.length) { showToast('‚ö†Ô∏è Add BOQ sections first before generating', 'info'); return; }
        // Show sequence confirmation screen
        showSequenceConfirmation();
    }

    function showSequenceConfirmation() {
        const boq = KALYANTRA.data.boq || {};
        const sections = boq.sections || [];
        // Determine which activity types are needed from BOQ item links
        const linkedActivities = new Set();
        sections.forEach(sec => {
            (sec.items||[]).forEach(it => { if (it.activityLink) linkedActivities.add(it.activityLink); });
        });
        // Build sequence list ‚Äî include all MoRTH items, highlight linked ones
        const existingConfig = boq.generationConfig || {};
        const existingSeq = existingConfig.sequence || [];
        const existing = document.getElementById('boqSeqModal');
        if (existing) existing.remove();
        const modal = document.createElement('div');
        modal.id = 'boqSeqModal';
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';

        let seqRows = MORTH_SEQUENCE.map((item, idx) => {
            const isLinked = linkedActivities.has(item.id);
            const prevConfig = existingSeq.find(s => s.id === item.id) || {};
            const prodRate = existingConfig.productivityRates && existingConfig.productivityRates[item.id]
                ? existingConfig.productivityRates[item.id] : item.prodRate;
            return `<tr style="border-bottom:1px solid var(--border-light);${isLinked?'background:#f0fdf4;':''}">
                <td style="padding:6px 8px;text-align:center;">
                    <input type="checkbox" id="seqCheck_${item.id}" ${isLinked||prevConfig.included!==false?'checked':''} style="cursor:pointer;">
                </td>
                <td style="padding:6px 8px;font-size:0.8rem;font-weight:600;color:var(--navy);">
                    ${item.name}
                    ${isLinked ? '<span style="background:#dcfce7;color:#16a34a;font-size:0.65rem;padding:1px 5px;border-radius:3px;margin-left:4px;">BOQ linked</span>' : ''}
                </td>
                <td style="padding:6px 8px;text-align:center;">
                    <input type="number" id="seqRate_${item.id}" value="${prodRate}" 
                        style="width:80px;padding:3px 6px;border:1px solid var(--border-light);border-radius:3px;font-size:0.78rem;text-align:right;">
                    <div style="font-size:0.65rem;color:var(--text-secondary);">${item.prodUnit}</div>
                </td>
                <td style="padding:6px 8px;font-size:0.72rem;color:var(--text-secondary);">${item.monsoon ? 'üü° Pause monsoon' : '‚úÖ Year-round'}</td>
            </tr>`;
        }).join('');

        modal.innerHTML = `
        <div style="background:#fff;border-radius:10px;padding:24px;width:680px;max-width:96vw;box-shadow:0 20px 60px rgba(0,0,0,0.3);max-height:92vh;overflow-y:auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                <div style="font-weight:700;color:var(--navy);font-size:1rem;">‚ö° Confirm Construction Sequence</div>
                <button onclick="document.getElementById('boqSeqModal').remove()" style="background:none;border:none;font-size:1.2rem;cursor:pointer;">‚úï</button>
            </div>
            <div style="font-size:0.78rem;color:var(--text-secondary);margin-bottom:16px;">
                Review MoRTH standard sequence. Check/uncheck activities, adjust productivity rates for site conditions.
                <b style="color:#16a34a;">Green rows</b> are linked to your BOQ items.
            </div>
            <table style="width:100%;border-collapse:collapse;">
                <thead><tr style="background:var(--navy);color:#fff;">
                    <th style="padding:7px 8px;text-align:center;width:40px;">‚úì</th>
                    <th style="padding:7px 8px;text-align:left;">Activity</th>
                    <th style="padding:7px 8px;text-align:center;width:120px;">Prod. Rate</th>
                    <th style="padding:7px 8px;text-align:left;">Monsoon</th>
                </tr></thead>
                <tbody>${seqRows}</tbody>
            </table>
            <div style="background:#fef3c7;border:1px solid #fbbf24;border-radius:6px;padding:10px;margin-top:14px;">
                <div style="font-size:0.78rem;font-weight:600;color:#92400e;">üìã Structure Activities (for all structures in project)</div>
                <div style="font-size:0.74rem;color:#78350f;margin-top:4px;">
                    ${STRUCTURE_SEQUENCE.map(s=>`<span style="margin-right:8px;">‚òë ${s.name}</span>`).join('')}
                </div>
                <div style="font-size:0.72rem;color:#92400e;margin-top:4px;">Structure sequences run parallel to road works. Confirm or edit in generated WBS.</div>
            </div>
            <div style="display:flex;gap:10px;margin-top:18px;justify-content:flex-end;">
                <button onclick="document.getElementById('boqSeqModal').remove()"
                    style="padding:8px 16px;border:1px solid var(--border-medium);background:#fff;border-radius:5px;cursor:pointer;font-size:0.83rem;">Cancel</button>
                <button onclick="boqConfirmAndGenerate()"
                    style="padding:10px 24px;background:linear-gradient(135deg,#16a34a,#15803d);color:#fff;border:none;border-radius:5px;font-weight:700;cursor:pointer;font-size:0.9rem;">
                    ‚úÖ Confirm & Generate WBS + Schedule
                </button>
            </div>
        </div>`;
        document.body.appendChild(modal);
    }

    function boqConfirmAndGenerate() {
        const boq = KALYANTRA.data.boq;
        const sections = boq.sections || [];
        const cal = KALYANTRA.data.calendar || {};
        const hpd = cal.hoursPerDay || 8;

        // Read confirmed sequence + rates
        const confirmedSeq = [];
        const productivityRates = {};
        MORTH_SEQUENCE.forEach(item => {
            const chk  = document.getElementById('seqCheck_'+item.id);
            const rate = document.getElementById('seqRate_'+item.id);
            if (chk && chk.checked) {
                const pr = parseFloat(rate&&rate.value) || item.prodRate;
                confirmedSeq.push({ id:item.id, name:item.name, unit:item.unit, prodRate:pr,
                    prodUnit:item.prodUnit, critical:item.critical, monsoon:item.monsoon, included:true });
                productivityRates[item.id] = pr;
            }
        });
        boq.generationConfig = { sequence: confirmedSeq, productivityRates, confirmed:true };

        // ‚îÄ‚îÄ GENERATE WBS FROM BOQ + SEQUENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // This REPLACES the hardcoded stretchActivities with BOQ-driven ones
        const generatedWBS = [];
        let wbsCounter = 1;
        const fmt = m => { const k=Math.floor(m/1000); const r=m%1000; return k+'+'+String(r).padStart(3,'0'); };

        sections.forEach((sec, si) => {
            const sectionLen = (sec.toCh||0) - (sec.fromCh||0); // metres
            const sectionLenKm = sectionLen / 1000;
            const boqItems = sec.items || [];
            const hindrInfo = boqGetBlockedMetres(sec.fromCh||0, sec.toCh||0);
            const wbsId = `${wbsCounter}`;
            wbsCounter++;

            // Build activities from confirmed sequence
            const acts = [];
            let actCounter = 1;
            let prevDuration = 0;

            confirmedSeq.forEach(seqItem => {
                // Find matching BOQ item(s) for this activity type
                const matchingBOQ = boqItems.filter(it => it.activityLink === seqItem.id);
                let qty = 0; let rate = 0; let unit = seqItem.unit;
                if (matchingBOQ.length > 0) {
                    qty  = matchingBOQ.reduce((s,it) => s+(it.qty||0), 0);
                    rate = matchingBOQ[0].rate || 0;
                    unit = matchingBOQ[0].unit || seqItem.unit;
                } else {
                    // No BOQ link ‚Äî skip this activity for this section
                    return;
                }
                const duration = calcDuration(qty, unit, seqItem.prodRate, hpd);
                const actId = `${wbsId}.${actCounter}`;
                acts.push({
                    id: actId, name: seqItem.name, qty, unit, rate,
                    boqAmount: qty * rate, duration, critical: seqItem.critical,
                    monsoonSensitive: seqItem.monsoon,
                    resource: seqItem.name,
                    actualPct: (KALYANTRA.data.activityProgress||{})[wbsId+'.'+actId] || 0,
                    predecessor: actCounter > 1 ? `${wbsId}.${actCounter-1}` : null,
                    chainageStart: sec.fromCh, chainageEnd: sec.toCh,
                    hindranceBlocked: hindrInfo.blocked > 0,
                    prodRate: seqItem.prodRate
                });
                actCounter++;
                prevDuration += duration;
            });

            // If no activities generated from BOQ links, create default from TCS
            if (acts.length === 0) {
                // Fallback: use TCS layers as activities
                const tcs = KALYANTRA.data.tcs || {};
                Object.entries(tcs.layers||{}).forEach(([layer, cfg]) => {
                    const seqMatch = confirmedSeq.find(s => s.id === layer);
                    const dur = seqMatch ? calcDuration(sectionLenKm*1000*(tcs.carriageWidth||7)*(cfg.thickness/1000), 'Cum', seqMatch.prodRate, hpd) : 5;
                    acts.push({ id:`${wbsId}.${actCounter}`, name:`${layer} (${cfg.thickness}mm)`,
                        qty:Math.round(sectionLenKm*1000*(tcs.carriageWidth||7)*(cfg.thickness/1000)),
                        unit:'Cum', duration:dur, critical:true, monsoonSensitive:layer!=='BC'&&layer!=='DBM',
                        resource:layer, actualPct:0, chainageStart:sec.fromCh, chainageEnd:sec.toCh });
                    actCounter++;
                });
            }

            const totalDuration = acts.reduce((mx,a) => Math.max(mx, a.duration), 0) + 5;
            const totalCost = acts.reduce((s,a) => s+(a.boqAmount||0), 0) / 10000000;

            generatedWBS.push({
                wbs: wbsId, name: `${sec.name} (Ch ${fmt(sec.fromCh||0)}‚Äì${fmt(sec.toCh||0)})`,
                type: 'stretch', phase: 1,
                chainage: { start:sec.fromCh||0, end:sec.toCh||0, length:sectionLenKm },
                status: hindrInfo.blocked > 0 ? 'Partial' : 'Workable',
                activities: acts, duration: totalDuration, cost: +totalCost.toFixed(2),
                fromBOQ: true
            });
        });

        // Add structure WBS from structure BOQ
        const structBOQ = boq.structureBOQ || [];
        const structures = KALYANTRA.data.structures || [];
        structures.forEach((st, si) => {
            const sbEntry = structBOQ.find(sb => sb.structureId == st.id);
            const structActs = STRUCTURE_SEQUENCE.map((sa, sai) => ({
                id:`s${si+1}.${sai+1}`, name:sa.name,
                qty: sbEntry ? ((sbEntry.items||[]).find(it=>it.description.toLowerCase().includes(sa.id.replace('S_','').toLowerCase()))||{qty:0}).qty || 0 : 0,
                unit:sa.unit, duration: Math.max(1, calcDuration(
                    sbEntry ? ((sbEntry.items||[]).reduce((s,it)=>s+(it.qty||0),0)/STRUCTURE_SEQUENCE.length) : 5,
                    sa.unit, sa.prodRate, hpd
                )),
                critical:sa.critical, monsoonSensitive:sa.monsoon, resource:sa.name,
                actualPct:(KALYANTRA.data.activityProgress||{})['s'+(si+1)+'.s'+(si+1)+'.'+(sai+1)]||0
            }));
            generatedWBS.push({
                wbs:`s${si+1}`, name:`${st.name} (Ch ${fmt(st.chainage||0)})`,
                type:'structure', phase:2,
                chainage:{start:st.chainage, end:st.chainage, length:0},
                status:'Workable', activities:structActs,
                duration:structActs.reduce((mx,a)=>Math.max(mx,a.duration),0)+2,
                cost:+(((sbEntry&&sbEntry.items||[]).reduce((s,it)=>s+(it.qty||0)*(it.rate||0),0))/10000000).toFixed(2),
                fromBOQ:true
            });
        });

        // Store generated WBS in KALYANTRA computed + data
        KALYANTRA.computed.wbs = generatedWBS;
        KALYANTRA.computed.workableStretches = generatedWBS
            .filter(w => w.type==='stretch')
            .map(w => ({ id:w.wbs, start:w.chainage.start, end:w.chainage.end, length:w.chainage.length, status:w.status }));
        KALYANTRA.calculate.allActivities();
        KALYANTRA.calculate.progress();
        KALYANTRA.save();

        document.getElementById('boqSeqModal').remove();
        showToast(`‚ö° Generated ${generatedWBS.length} WBS items with ${KALYANTRA.computed.activities.length} activities from BOQ!`, 'success');

        // Switch to Activity Grid to show results
        setTimeout(() => {
            sidebarSwitchTab(6, document.querySelector('[data-tab="6"]'));
            KALYANTRA.render.wbsTable();
            KALYANTRA.render.dashboard();
        }, 500);
    }

    </script>

<script>

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TCS & SECTIONS ‚Äî MASTER TCS + PER-SECTION TCS + BOQ
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function updateMasterTCS() {
            const cw  = parseFloat(document.getElementById('tcsCarriageWidth')?.value) || 7.0;
            const sw  = parseFloat(document.getElementById('tcsShoulderWidth')?.value) || 1.5;
            const gsb = parseFloat(document.getElementById('tcsGSB')?.value) || 250;
            const wmm = parseFloat(document.getElementById('tcsWMM')?.value) || 250;
            const dbm = parseFloat(document.getElementById('tcsDBM')?.value) || 50;
            const bc  = parseFloat(document.getElementById('tcsBC')?.value)  || 40;
            const gsbOn = document.getElementById('tcsGSBon')?.checked !== false;
            const wmmOn = document.getElementById('tcsWMMon')?.checked !== false;
            const dbmOn = document.getElementById('tcsDBMon')?.checked !== false;
            const bcOn  = document.getElementById('tcsOnBC')?.checked  !== false;

            KALYANTRA.data.tcs.carriageWidth  = cw;
            KALYANTRA.data.tcs.shoulderWidth  = sw;
            if (!KALYANTRA.data.tcs.layers) KALYANTRA.data.tcs.layers = {};
            if (gsbOn) KALYANTRA.data.tcs.layers.GSB = { thickness: gsb, material: 'Granular Sub Base' };
            else delete KALYANTRA.data.tcs.layers.GSB;
            if (wmmOn) KALYANTRA.data.tcs.layers.WMM = { thickness: wmm, material: 'Wet Mix Macadam' };
            else delete KALYANTRA.data.tcs.layers.WMM;
            if (dbmOn) KALYANTRA.data.tcs.layers.DBM = { thickness: dbm, material: 'Dense Bituminous Macadam' };
            else delete KALYANTRA.data.tcs.layers.DBM;
            if (bcOn)  KALYANTRA.data.tcs.layers.BC  = { thickness: bc,  material: 'Bituminous Concrete' };
            else delete KALYANTRA.data.tcs.layers.BC;

            KALYANTRA.save();
        }

        function populateMasterTCSForm() {
            const tcs = KALYANTRA.data.tcs || {};
            const setV = (id, v) => { const el = document.getElementById(id); if (el && v !== undefined) el.value = v; };
            const setC = (id, v) => { const el = document.getElementById(id); if (el) el.checked = v !== false; };
            setV('tcsCarriageWidth', tcs.carriageWidth || 7.0);
            setV('tcsShoulderWidth', tcs.shoulderWidth || 1.5);
            const layers = tcs.layers || {};
            setV('tcsGSB', layers.GSB?.thickness || 250); setC('tcsGSBon', !!layers.GSB);
            setV('tcsWMM', layers.WMM?.thickness || 250); setC('tcsWMMon', !!layers.WMM);
            setV('tcsDBM', layers.DBM?.thickness || 50);  setC('tcsDBMon', !!layers.DBM);
            setV('tcsBC',  layers.BC?.thickness  || 40);  setC('tcsOnBC',  !!layers.BC);
        }

        // ‚îÄ‚îÄ ADD SECTION MODAL (with TCS override) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function tcsAddSection() {
            const p   = KALYANTRA.data.project || {};
            const tcs = KALYANTRA.data.tcs || {};
            showTCSSectionModal(-1, {
                name: 'Road Works',
                fromCh: p.startChainage || 0,
                toCh: p.endChainage || 5000,
                itemSystem: 'morth',
                items: [], linearItems: [],
                // TCS override ‚Äî copies master by default
                tcs: {
                    carriageWidth: tcs.carriageWidth || 7.0,
                    shoulderWidth: tcs.shoulderWidth || 1.5,
                    layers: JSON.parse(JSON.stringify(tcs.layers || {}))
                }
            });
        }

        function tcsEditSection(si) {
            const sec = (KALYANTRA.data.boq?.sections || [])[si];
            if (sec) showTCSSectionModal(si, sec);
        }

        function showTCSSectionModal(si, sec) {
            const existing = document.getElementById('tcsSectionModal');
            if (existing) existing.remove();
            const tcs = sec.tcs || KALYANTRA.data.tcs || {};
            const layers = tcs.layers || {};
            const modal = document.createElement('div');
            modal.id = 'tcsSectionModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.55);z-index:9999;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
            <div style="background:#fff;border-radius:10px;padding:24px;width:560px;max-width:96vw;box-shadow:0 20px 60px rgba(0,0,0,0.3);max-height:92vh;overflow-y:auto;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
                    <div style="font-weight:700;color:var(--navy);font-size:1rem;">${si===-1?'‚ûï Add New Section':'‚úèÔ∏è Edit Section'}</div>
                    <button onclick="document.getElementById('tcsSectionModal').remove()" style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--text-secondary);">‚úï</button>
                </div>

                <!-- SECTION INFO -->
                <div style="background:#f8fafc;border-radius:8px;padding:14px;margin-bottom:14px;">
                    <div style="font-size:0.78rem;font-weight:700;color:var(--navy);margin-bottom:10px;">SECTION DETAILS</div>
                    <div style="display:grid;gap:10px;">
                        <div>
                            <label style="font-size:0.75rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">Section Name</label>
                            <input id="tsmName" type="text" value="${sec.name||''}" placeholder="e.g. Road Works, Hill Section, Urban Stretch"
                                style="width:100%;padding:7px 10px;border:1px solid var(--border-medium);border-radius:5px;font-size:0.84rem;box-sizing:border-box;">
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
                            <div>
                                <label style="font-size:0.75rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">From Chainage</label>
                                <input id="tsmFromCh" type="text" value="${fmtCh(sec.fromCh||0)}" placeholder="0+000"
                                    style="width:100%;padding:7px 10px;border:1px solid var(--border-medium);border-radius:5px;font-size:0.84rem;box-sizing:border-box;">
                            </div>
                            <div>
                                <label style="font-size:0.75rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">To Chainage</label>
                                <input id="tsmToCh" type="text" value="${fmtCh(sec.toCh||0)}" placeholder="5+000"
                                    style="width:100%;padding:7px 10px;border:1px solid var(--border-medium);border-radius:5px;font-size:0.84rem;box-sizing:border-box;">
                            </div>
                            <div>
                                <label style="font-size:0.75rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">Item Numbering</label>
                                <select id="tsmItemSystem" style="width:100%;padding:7px 10px;border:1px solid var(--border-medium);border-radius:5px;font-size:0.84rem;box-sizing:border-box;">
                                    <option value="morth" ${sec.itemSystem==='morth'?'selected':''}>MoRTH</option>
                                    <option value="cpwd"  ${sec.itemSystem==='cpwd'?'selected':''}>CPWD</option>
                                    <option value="own"   ${sec.itemSystem==='own'?'selected':''}>Own</option>
                                    <option value="auto"  ${sec.itemSystem==='auto'?'selected':''}>Auto</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TCS OVERRIDE -->
                <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:14px;margin-bottom:14px;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
                        <div style="font-size:0.78rem;font-weight:700;color:#1d4ed8;">TCS FOR THIS SECTION</div>
                        <button onclick="tsmCopyMaster()" style="background:#dbeafe;color:#1d4ed8;border:none;padding:3px 10px;border-radius:4px;font-size:0.72rem;cursor:pointer;font-weight:600;">‚Ü© Copy Master TCS</button>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
                        <div>
                            <label style="font-size:0.73rem;font-weight:600;color:#1e40af;display:block;margin-bottom:3px;">Carriage Width (m)</label>
                            <input id="tsmCW" type="number" value="${tcs.carriageWidth||7.0}" step="0.5"
                                style="width:100%;padding:6px 9px;border:1px solid #bfdbfe;border-radius:4px;font-size:0.83rem;box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="font-size:0.73rem;font-weight:600;color:#1e40af;display:block;margin-bottom:3px;">Shoulder Width (m)</label>
                            <input id="tsmSW" type="number" value="${tcs.shoulderWidth||1.5}" step="0.25"
                                style="width:100%;padding:6px 9px;border:1px solid #bfdbfe;border-radius:4px;font-size:0.83rem;box-sizing:border-box;">
                        </div>
                    </div>
                    <table style="width:100%;border-collapse:collapse;font-size:0.78rem;">
                        <thead><tr style="background:#dbeafe;color:#1e40af;">
                            <th style="padding:5px 8px;text-align:left;">Layer</th>
                            <th style="padding:5px 8px;text-align:center;">Thickness (mm)</th>
                            <th style="padding:5px 8px;text-align:center;">Include</th>
                        </tr></thead>
                        <tbody>
                            <tr style="border-bottom:1px solid #e0f2fe;">
                                <td style="padding:5px 8px;font-weight:700;color:#92400e;">GSB</td>
                                <td style="padding:5px 8px;text-align:center;"><input type="number" id="tsmGSB" value="${layers.GSB?.thickness||250}" style="width:70px;padding:3px 6px;border:1px solid #bfdbfe;border-radius:3px;text-align:center;font-size:0.78rem;"></td>
                                <td style="padding:5px 8px;text-align:center;"><input type="checkbox" id="tsmGSBon" ${layers.GSB?'checked':''}></td>
                            </tr>
                            <tr style="border-bottom:1px solid #e0f2fe;">
                                <td style="padding:5px 8px;font-weight:700;color:#1d4ed8;">WMM</td>
                                <td style="padding:5px 8px;text-align:center;"><input type="number" id="tsmWMM" value="${layers.WMM?.thickness||250}" style="width:70px;padding:3px 6px;border:1px solid #bfdbfe;border-radius:3px;text-align:center;font-size:0.78rem;"></td>
                                <td style="padding:5px 8px;text-align:center;"><input type="checkbox" id="tsmWMMon" ${layers.WMM?'checked':''}></td>
                            </tr>
                            <tr style="border-bottom:1px solid #e0f2fe;">
                                <td style="padding:5px 8px;font-weight:700;color:#1e40af;">DBM</td>
                                <td style="padding:5px 8px;text-align:center;"><input type="number" id="tsmDBM" value="${layers.DBM?.thickness||50}" style="width:70px;padding:3px 6px;border:1px solid #bfdbfe;border-radius:3px;text-align:center;font-size:0.78rem;"></td>
                                <td style="padding:5px 8px;text-align:center;"><input type="checkbox" id="tsmDBMon" ${layers.DBM?'checked':''}></td>
                            </tr>
                            <tr>
                                <td style="padding:5px 8px;font-weight:700;">BC</td>
                                <td style="padding:5px 8px;text-align:center;"><input type="number" id="tsmBC" value="${layers.BC?.thickness||40}" style="width:70px;padding:3px 6px;border:1px solid #bfdbfe;border-radius:3px;text-align:center;font-size:0.78rem;"></td>
                                <td style="padding:5px 8px;text-align:center;"><input type="checkbox" id="tsmBCon" ${layers.BC?'checked':''}></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div style="display:flex;gap:10px;justify-content:flex-end;">
                    <button onclick="document.getElementById('tcsSectionModal').remove()"
                        style="padding:8px 16px;border:1px solid var(--border-medium);background:#fff;border-radius:5px;cursor:pointer;font-size:0.83rem;">Cancel</button>
                    <button onclick="tsmSave(${si})"
                        style="padding:8px 20px;background:var(--navy);color:var(--accent-gold);border:none;border-radius:5px;font-weight:700;cursor:pointer;font-size:0.85rem;">
                        ${si===-1?'‚úÖ Add Section':'‚úÖ Save Changes'}
                    </button>
                </div>
            </div>`;
            document.body.appendChild(modal);
        }

        function tsmCopyMaster() {
            const tcs = KALYANTRA.data.tcs || {};
            const layers = tcs.layers || {};
            const setV = (id,v) => { const el=document.getElementById(id); if(el) el.value=v; };
            const setC = (id,v) => { const el=document.getElementById(id); if(el) el.checked=!!v; };
            setV('tsmCW', tcs.carriageWidth||7.0);
            setV('tsmSW', tcs.shoulderWidth||1.5);
            setV('tsmGSB', layers.GSB?.thickness||250); setC('tsmGSBon', !!layers.GSB);
            setV('tsmWMM', layers.WMM?.thickness||250); setC('tsmWMMon', !!layers.WMM);
            setV('tsmDBM', layers.DBM?.thickness||50);  setC('tsmDBMon', !!layers.DBM);
            setV('tsmBC',  layers.BC?.thickness||40);   setC('tsmBCon',  !!layers.BC);
            showToast('‚Ü© Master TCS copied to section', 'info');
        }

        function tsmSave(si) {
            const name  = document.getElementById('tsmName').value.trim() || 'Road Works';
            const fromCh = parseCh(document.getElementById('tsmFromCh').value);
            const toCh   = parseCh(document.getElementById('tsmToCh').value);
            const itemSystem = document.getElementById('tsmItemSystem').value;
            // Read section TCS
            const gsbOn = document.getElementById('tsmGSBon').checked;
            const wmmOn = document.getElementById('tsmWMMon').checked;
            const dbmOn = document.getElementById('tsmDBMon').checked;
            const bcOn  = document.getElementById('tsmBCon').checked;
            const secLayers = {};
            if (gsbOn) secLayers.GSB = { thickness: parseFloat(document.getElementById('tsmGSB').value)||250, material:'Granular Sub Base' };
            if (wmmOn) secLayers.WMM = { thickness: parseFloat(document.getElementById('tsmWMM').value)||250, material:'Wet Mix Macadam' };
            if (dbmOn) secLayers.DBM = { thickness: parseFloat(document.getElementById('tsmDBM').value)||50,  material:'Dense Bituminous Macadam' };
            if (bcOn)  secLayers.BC  = { thickness: parseFloat(document.getElementById('tsmBC').value)||40,   material:'Bituminous Concrete' };
            const secTCS = {
                carriageWidth: parseFloat(document.getElementById('tsmCW').value)||7.0,
                shoulderWidth: parseFloat(document.getElementById('tsmSW').value)||1.5,
                layers: secLayers
            };
            if (!KALYANTRA.data.boq) KALYANTRA.data.boq = {sections:[],structureBOQ:[],generationConfig:{sequence:[],productivityRates:{},confirmed:false}};
            if (!KALYANTRA.data.boq.sections) KALYANTRA.data.boq.sections = [];
            if (si === -1) {
                KALYANTRA.data.boq.sections.push({ name, fromCh, toCh, itemSystem, items:[], linearItems:[], tcs:secTCS });
            } else {
                const existing = KALYANTRA.data.boq.sections[si] || {};
                KALYANTRA.data.boq.sections[si] = { ...existing, name, fromCh, toCh, itemSystem, tcs:secTCS };
            }
            KALYANTRA.save();
            document.getElementById('tcsSectionModal').remove();
            renderBOQSections();
            showToast(si===-1?'‚úÖ Section added':'‚úÖ Section updated', 'success');
        }

        // Override boqEditSection to use our new modal
        function boqEditSection(si) { tcsEditSection(si); }

        // Render structures list in Part C
        function renderStructuresBOQList() {
            const structBOQ = KALYANTRA.data.boq?.structureBOQ || [];
            const container = document.getElementById('boqStructuresList');
            const emptyEl   = document.getElementById('boqStructEmptyState');
            if (!container) return;
            if (structBOQ.length === 0) {
                if (emptyEl) emptyEl.style.display = 'block';
                return;
            }
            if (emptyEl) emptyEl.style.display = 'none';
            const structures = KALYANTRA.data.structures || [];
            let html = '';
            structBOQ.forEach((sb, si) => {
                const struct = structures.find(s => s.id == sb.structureId) || {};
                const total  = (sb.items||[]).reduce((s,it) => s+(it.qty||0)*(it.rate||0), 0);
                html += `<div style="background:var(--bg-surface);border:1px solid #ddd6fe;border-radius:6px;padding:12px;margin-bottom:8px;border-left:4px solid #7c3aed;">
                    <div style="display:flex;align-items:center;justify-content:space-between;">
                        <div>
                            <div style="font-weight:700;color:var(--navy);font-size:0.88rem;">üåâ ${struct.name||sb.structureName||'Structure'}</div>
                            <div style="font-size:0.72rem;color:var(--text-secondary);">Ch ${fmtCh(struct.chainage||sb.chainage||0)} ‚Äî ${(sb.items||[]).length} items ‚Äî ‚Çπ${(total/100000).toFixed(2)}L</div>
                        </div>
                        <div style="display:flex;gap:6px;">
                            <button onclick="boqViewStructure(${si})" style="background:#ede9fe;color:#7c3aed;border:none;padding:4px 10px;border-radius:4px;font-size:0.72rem;cursor:pointer;">üëÅÔ∏è View</button>
                            <button onclick="boqDeleteStructure(${si})" style="background:#fee2e2;color:#dc2626;border:none;padding:4px 10px;border-radius:4px;font-size:0.72rem;cursor:pointer;">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div id="boqStructDetails_${si}" style="display:none;margin-top:10px;">${renderStructureBOQTable(sb)}</div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // Patch renderBOQSections to also update structures list
        const _origRenderBOQ = typeof renderBOQSections === 'function' ? renderBOQSections : null;
        function renderBOQSectionsAndStructures() {
            if (typeof renderBOQSections === 'function') renderBOQSections();
            renderStructuresBOQList();
        }

        // Override boqDeleteSection to use tcs edit
        const _origBoqDelete = typeof boqDeleteSection === 'function' ? boqDeleteSection : null;

        // Auto-populate master TCS form when TCS tab is opened
        const _origSidebarSwitch = sidebarSwitchTab;
        sidebarSwitchTab = function(index, clickedItem) {
            _origSidebarSwitch(index, clickedItem);
            if (index === 1) {
                setTimeout(() => {
                    populateMasterTCSForm();
                    renderBOQSections();
                    renderStructuresBOQList();
                }, 100);
            }
        };

    </script>
</body>
</html>
