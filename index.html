<!DOCTYPE html>
<html lang="en">
<head>
    <!-- SUPABASE CLIENT -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPA_URL = 'https://upuwkzykkcclpzkytvdh.supabase.co';
        const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwdXdrenlra2NjbHB6a3l0dmRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNTA2ODIsImV4cCI6MjA4NzYyNjY4Mn0.8UE9QFgn3zgqQ1EvhFLqwS-eomXSD6GTYykUh2ZvN8Q';
        const supa     = supabase.createClient(SUPA_URL, SUPA_KEY);
        const KALYANTRA_PROJECT_ID = 'a1b2c3d4-e5f6-7890-abcd-ef1234567890';

        async function supabaseSave(data) {
            try {
                const p = data.project || {};
                const t = data.tcs    || {};
                const cal = data.calendar || {};
                const res = data.resources || {};
                const pid = KALYANTRA_PROJECT_ID;

                await supa.from('projects').upsert({
                    id: pid, name: p.name||'New Project', budget: p.budget||0,
                    start_date: p.startDate||null, end_date: p.endDate||null,
                    loa_date: p.loaDate||null, agreement_date: p.agreementDate||null,
                    appointed_date: p.appointedDate||p.startDate||null,
                    location: p.location||'', start_chainage: p.startChainage||0,
                    end_chainage: p.endChainage||5000,
                    industry_type: p.industryType||'roads',
                    project_mode: p.projectMode||'HAM',
                    physical_progress: p.physicalProgress||0,
                    financial_progress: p.financialProgress||0,
                    version:'2.0',
                    constraints: JSON.stringify(data.constraints || {}),
                    boq_data: JSON.stringify(data.boq || {sections:[],structureBOQ:[],generationConfig:{sequence:[],productivityRates:{},confirmed:false}}),
                    baseline_data: JSON.stringify(data.baseline || null),
                    progress_data: JSON.stringify(data.progress || {entries:[],productivityHistory:{}}),
                    scenarios_data: JSON.stringify(data.scenarios || []),
                    boq_tab_data: JSON.stringify(data.boqTab || {frozen:false,roadItems:[],structItems:[],miscItems:[]})
                }, {onConflict:'id'});

                const existingTCS = await supa.from('tcs').select('id').eq('project_id',pid).maybeSingle();
                const tcsData = { project_id:pid, carriage_width:t.carriageWidth||7.0, shoulder_width:t.shoulderWidth||1.5, layers:t.layers||{} };
                if (existingTCS.data) await supa.from('tcs').update(tcsData).eq('project_id',pid);
                else await supa.from('tcs').insert(tcsData);

                if (data.structures) {
                    await supa.from('structures').delete().eq('project_id',pid);
                    if (data.structures.length>0) {
                        await supa.from('structures').insert(data.structures.map((s,i)=>({
                            project_id:pid, name:s.name||'Structure', type:s.type||'box_culvert',
                            chainage:s.chainage||0, size:s.size||'', concrete_qty:s.concreteQty||0,
                            excavation_qty:s.excavationQty||0, foundation_qty:s.foundationQty||0,
                            progress_pct:s.progressPct||0, frozen:s.frozen||false,
                            spans_data:JSON.stringify(s.spans||[]), sort_order:i+1
                        })));
                    }
                }

                if (data.hindrances) {
                    await supa.from('hindrances').delete().eq('project_id',pid);
                    if (data.hindrances.length>0) {
                        await supa.from('hindrances').insert(data.hindrances.map((h,i)=>({
                            project_id:pid, name:h.name||'Hindrance', type:h.type||'land',
                            category:h.category||h.type||'land', chainage_start:h.chainageStart||0,
                            chainage_end:h.chainageEnd||0, status:h.status||'Pending',
                            impact:h.impact||'', resolution_days:h.resolutionDays||0, sort_order:i+1
                        })));
                    }
                }

                const existingCal = await supa.from('calendar').select('id').eq('project_id',pid).maybeSingle();
                const calData = { project_id:pid, working_days:cal.workingDays||[1,2,3,4,5,6],
                    hours_per_day:cal.hoursPerDay||8, monsoon_start:cal.monsoonStart||null,
                    monsoon_end:cal.monsoonEnd||null, holidays:cal.holidays||[] };
                if (existingCal.data) await supa.from('calendar').update(calData).eq('project_id',pid);
                else await supa.from('calendar').insert(calData);

                const existingRes = await supa.from('resources').select('id').eq('project_id',pid).maybeSingle();
                const resData = { project_id:pid, equipment:res.equipment||[], manpower:res.manpower||[], materials:res.materials||[] };
                if (existingRes.data) await supa.from('resources').update(resData).eq('project_id',pid);
                else await supa.from('resources').insert(resData);

                if (data.milestones!==undefined) {
                    await supa.from('milestones').delete().eq('project_id',pid);
                    if (data.milestones.length>0) {
                        await supa.from('milestones').insert(data.milestones.map((m,i)=>({
                            project_id:pid, description:m.description||'', target_date:m.targetDate||null,
                            completion:m.completion||0, sort_order:i+1
                        })));
                    }
                }

                try { localStorage.setItem('kalyantra_v67_data', JSON.stringify(Object.assign({},data,{_version:'2.0'}))); } catch(e) {}
                console.log('‚úÖ Saved to Supabase');
                updateConnectionBadge(true);
                return true;
            } catch(err) {
                console.error('‚ùå Supabase save failed:', err);
                try { localStorage.setItem('kalyantra_v67_data', JSON.stringify(Object.assign({},data,{_version:'2.0'}))); } catch(e) {}
                updateConnectionBadge(false);
                return false;
            }
        }

        async function supabaseLoad() {
            try {
                const pid = KALYANTRA_PROJECT_ID;
                // Fetch each table independently so one bad column doesn't crash everything
                const safeQuery = async (fn) => { try { return await fn(); } catch(e) { console.warn('Table query warn:', e.message); return {data:null,error:e}; } };
                // 6-second timeout on entire DB fetch
                const _dbTimeout = new Promise(resolve => setTimeout(() => resolve('TIMEOUT'), 6000));
                const _dbFetch = Promise.all([
                    safeQuery(()=>supa.from('projects').select('*').eq('id',pid).maybeSingle()),
                    safeQuery(()=>supa.from('tcs').select('*').eq('project_id',pid).maybeSingle()),
                    safeQuery(()=>supa.from('structures').select('*').eq('project_id',pid).order('sort_order')),
                    safeQuery(()=>supa.from('hindrances').select('*').eq('project_id',pid).order('sort_order')),
                    safeQuery(()=>supa.from('calendar').select('*').eq('project_id',pid).maybeSingle()),
                    safeQuery(()=>supa.from('resources').select('*').eq('project_id',pid).maybeSingle()),
                    safeQuery(()=>supa.from('milestones').select('*').eq('project_id',pid).order('sort_order')),
                    safeQuery(()=>supa.from('activity_progress').select('*').eq('project_id',pid))
                ]);
                const _raceResult = await Promise.race([_dbFetch, _dbTimeout]);
                if (_raceResult === 'TIMEOUT') {
                    console.warn('‚è±Ô∏è Supabase timeout after 6s - using local data');
                    updateConnectionBadge(false);
                    return null;
                }
                const [projRes,tcsRes,structRes,hindRes,calRes,resRes,milRes,apRes] = _raceResult;

                const result = {};
                if (projRes.data) {
                    const p = projRes.data;
                    // Normalize values
                    const _it = (p.industry_type||'roads').toLowerCase();
                    const _itN = _it.includes('road')?'roads':_it.includes('metro')?'metro':
                                 _it.includes('urban')?'urban':_it.includes('water')?'water':'roads';
                    result.project = { name:p.name||'Package-I | 4-Lane | 42 km | HAM',
                        budget:parseFloat(p.budget)||1356.90,
                        startDate:p.start_date||'2025-02-01', endDate:p.end_date||'2027-02-01',
                        location:p.location||'Telangana ‚Äî Ch 0+000 to Ch 42+000',
                        startChainage:p.start_chainage||0, endChainage:p.end_chainage||42000,
                        industryType:_itN,
                        projectMode:(p.project_mode||'ham').toLowerCase(),
                        loaDate:p.loa_date||'2024-12-18',
                        agreementDate:p.agreement_date||'2025-01-02',
                        appointedDate:p.appointed_date||p.start_date||'2025-02-01',
                        duration:730,
                        physicalProgress:parseFloat(p.physical_progress)||40,
                        financialProgress:parseFloat(p.financial_progress)||35,
                        bidProjectCost:parseFloat(p.budget)||1356.90,
                        contractorName:p.contractor_name||'HAM Concessionaire' };
                    if (p.boq_data) {
                        try { result.boq = typeof p.boq_data === 'string' ? JSON.parse(p.boq_data) : p.boq_data; }
                        catch(e) { result.boq = {sections:[],structureBOQ:[],generationConfig:{sequence:[],productivityRates:{},confirmed:false}}; }
                    }
                    if (p.baseline_data) { try { result.baseline = typeof p.baseline_data === 'string' ? JSON.parse(p.baseline_data) : p.baseline_data; } catch(e){} }
                    if (p.progress_data)  { try { result.progress  = typeof p.progress_data  === 'string' ? JSON.parse(p.progress_data)  : p.progress_data;  } catch(e){} }
                    if (p.scenarios_data) { try { result.scenarios = typeof p.scenarios_data === 'string' ? JSON.parse(p.scenarios_data) : p.scenarios_data; } catch(e){} }
                    if (p.boq_tab_data) {
                        try { result.boqTab = typeof p.boq_tab_data === 'string' ? JSON.parse(p.boq_tab_data) : p.boq_tab_data; }
                        catch(e) { result.boqTab = {frozen:false,roadItems:[],structItems:[],miscItems:[]}; }
                    }
                }
                if (tcsRes.data) {
                    const t = tcsRes.data;
                    result.tcs = { carriageWidth:parseFloat(t.carriage_width)||7.0,
                        shoulderWidth:parseFloat(t.shoulder_width)||1.5, layers:t.layers||{} };
                }
                if (structRes.data) {
                    result.structures = structRes.data.map(s=>({
                        id:s.sort_order, name:s.name, type:s.type, chainage:s.chainage,
                        size:s.size, concreteQty:parseFloat(s.concrete_qty)||0,
                        excavationQty:parseFloat(s.excavation_qty)||0, foundationQty:parseFloat(s.foundation_qty)||0,
                        progressPct:parseFloat(s.progress_pct)||0, frozen:s.frozen||false,
                        spans:s.spans_data ? JSON.parse(s.spans_data) : []
                    }));
                }
                if (hindRes.data) {
                    result.hindrances = hindRes.data.map(h=>({
                        id:h.sort_order, name:h.name, type:h.type, category:h.category,
                        chainageStart:h.chainage_start, chainageEnd:h.chainage_end,
                        status:h.status, impact:h.impact, resolutionDays:h.resolution_days||0
                    }));
                }
                if (calRes.data) {
                    const cal = calRes.data;
                    result.calendar = { workingDays:cal.working_days||[1,2,3,4,5,6],
                        hoursPerDay:cal.hours_per_day||8, monsoonStart:cal.monsoon_start,
                        monsoonEnd:cal.monsoon_end, holidays:cal.holidays||[] };
                }
                if (resRes.data) {
                    result.resources = { equipment:resRes.data.equipment||[],
                        manpower:resRes.data.manpower||[], materials:resRes.data.materials||[] };
                }
                if (milRes.data) {
                    result.milestones = milRes.data.map(m=>({
                        description:m.description, targetDate:m.target_date, completion:m.completion||0
                    }));
                }
                result.activityProgress = {};
                if (apRes.data) apRes.data.forEach(row=>{ result.activityProgress[row.progress_key]=row.actual_pct; });

                // Connected if at least project data loaded
                const isConnected = !!(projRes && projRes.data);
                updateConnectionBadge(isConnected);
                if (isConnected) {
                    console.log('‚úÖ Loaded from Supabase');
                    return result;
                } else {
                    console.warn('‚ö†Ô∏è Supabase connected but no project data found ‚Äî creating project row...');
                    updateConnectionBadge(true);
                    // Auto-seed defaults to Supabase so next load finds the project
                    try { await supabaseSave(KALYANTRA.data); console.log('‚úÖ Project created in Supabase'); } catch(e) { console.warn('Seed save failed:', e.message); }
                    // Try localStorage as data source
                    try {
                        const _ls = localStorage.getItem('kalyantra_v67_data');
                        if (_ls) {
                            const _lp = JSON.parse(_ls);
                            if (_lp && _lp.project && _lp.project.name) return _lp;
                        }
                    } catch(e) {}
                    return Object.keys(result).length > 0 ? result : null;
                }
            } catch(err) {
                console.error('‚ùå Supabase load failed:', err);
                updateConnectionBadge(false);
                return null;
            }
        }

        async function supabaseSaveProgress(progressKey, pct) {
            try {
                await supa.from('activity_progress').upsert({
                    project_id:KALYANTRA_PROJECT_ID, progress_key:progressKey, actual_pct:pct
                }, {onConflict:'project_id,progress_key'});
            } catch(err) { console.warn('Progress save failed:', err); }
        }

        function updateConnectionBadge(connected) {
            const dot   = document.getElementById('supaStatusDot');
            const label = document.getElementById('supaStatusLabel');
            if (!dot || !label) return;
            if (connected) {
                dot.style.background   = '#16a34a';
                dot.style.boxShadow    = '0 0 6px #16a34a';
                label.textContent      = 'üü¢ DB Connected';
                label.style.color      = '#15803d';
            } else {
                dot.style.background   = '#dc2626';
                dot.style.boxShadow    = '0 0 6px #dc2626';
                label.textContent      = 'üî¥ Offline Mode';
                label.style.color      = '#dc2626';
            }
        }
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KALYANTRA | Infrastructure Project Management</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary-navy: #1B3B6F;
            --navy: #1B3B6F;           /* alias for var(--primary-navy) */
            --accent-gold: #D4AF37;
            --success: #10B981;
            --info: #3B82F6;
            --bg-white: #FFFFFF;
            --bg-surface: #F8FAFC;
            --bg-table-header: #F1F5F9;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --border-light: #E2E8F0;
            --border-medium: #CBD5E1;
        }
        
        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background: var(--bg-surface);
            color: var(--text-primary);
            font-size: 14px;
            overflow: hidden;
            height: 100vh;
        }
        
        .app-container {
            display: flex;
            flex-direction: row;
            height: 100vh;
            overflow: hidden;
            position: relative;  /* anchor for absolute tab panels */
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 60px;
            min-width: 60px;
            background: var(--primary-navy);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: width 0.3s ease, min-width 0.3s ease;
            z-index: 100;
            border-right: 3px solid var(--accent-gold);
        }
        .sidebar.expanded {
            width: 220px;
            min-width: 220px;
        }
        .sidebar-header {
            display: flex;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255,255,255,0.12);
            min-height: 60px;
            flex-shrink: 0;
        }
        .sidebar-toggle {
            background: none;
            border: none;
            color: var(--accent-gold);
            font-size: 1.4rem;
            cursor: pointer;
            min-width: 60px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        .sidebar-toggle:hover {
            background: rgba(255,255,255,0.1);
        }
        .sidebar-brand {
            overflow: hidden;
            white-space: nowrap;
            opacity: 0;
            width: 0;
            transition: opacity 0.2s, width 0.2s;
        }
        .sidebar.expanded .sidebar-brand {
            opacity: 1;
            width: auto;
            padding-right: 12px;
        }
        .sidebar-brand-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-gold);
            letter-spacing: 1px;
        }
        .sidebar-brand-sub {
            font-size: 0.65rem;
            color: rgba(255,255,255,0.6);
            margin-top: 1px;
        }
        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 8px 0;
        }
        .sidebar-nav::-webkit-scrollbar { width: 4px; }
        .sidebar-nav::-webkit-scrollbar-track { background: transparent; }
        .sidebar-nav::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            color: rgba(255,255,255,0.75);
            cursor: pointer;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            border-left: 4px solid transparent;
            transition: all 0.2s;
            position: relative;
        }
        .sidebar-item:hover {
            background: rgba(255,255,255,0.08);
            color: white;
        }
        .sidebar-item.active {
            background: rgba(212,175,55,0.18);
            color: var(--accent-gold);
            border-left-color: var(--accent-gold);
        }
        .sidebar-icon {
            font-size: 1.25rem;
            min-width: 60px;
            text-align: center;
            flex-shrink: 0;
        }
        .sidebar-label {
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            width: 0;
            overflow: hidden;
            transition: opacity 0.2s;
        }
        .sidebar.expanded .sidebar-label {
            opacity: 1;
            width: auto;
        }
        /* Tooltip when collapsed */
        .sidebar:not(.expanded) .sidebar-item:hover::after {
            content: attr(data-label);
            position: absolute;
            left: 64px;
            background: #1B3B6F;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
            z-index: 200;
            border: 1px solid var(--accent-gold);
            box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        .sidebar-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 6px 10px;
        }
        .sidebar-section-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: rgba(255,255,255,0.35);
            padding: 8px 0 4px 0;
            text-align: center;
            white-space: nowrap;
            opacity: 0;
            width: 0;
            overflow: hidden;
            transition: opacity 0.2s;
        }
        .sidebar.expanded .sidebar-section-label {
            opacity: 1;
            width: auto;
            text-align: left;
            padding-left: 16px;
        }

        /* ===== MAIN CONTENT AREA ===== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
        }
        .main-header {
            background: var(--primary-navy);
            color: white;
            padding: 12px 24px;
            border-bottom: 4px solid var(--accent-gold);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .app-title {
            font-size: 1.4rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .app-subtitle {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 2px;
        }
        .header-meta {
            display: flex;
            gap: 16px;
            align-items: center;
            font-size: 0.8rem;
            opacity: 0.85;
        }
        .header-meta span { white-space: nowrap; }

        /* Hide old horizontal tab navigation */
        .tab-navigation {
            display: none !important;
        }
        
        .tab-content-area {
            flex: 1;
            overflow: hidden;
        }
        
        .tab-panel {
            display: none;
        }
        
        /* Active tab fills the content area to the right of the sidebar */
        .tab-panel.active {
            display: block;
            position: absolute;
            top: var(--header-h, 72px);
            left: var(--sidebar-w, 220px);
            right: 0;
            bottom: 0;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        /* Tab 1 - Form based */
        .content-container {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .section {
            background: white;
            border: 2px solid var(--border-light);
            border-left: 4px solid var(--primary-navy);
            border-radius: 4px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .section-header {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-navy);
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 3px solid var(--accent-gold);
            text-transform: uppercase;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .form-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
        }
        
        .form-input, .form-select {
            padding: 10px 12px;
            border: 2px solid var(--border-medium);
            border-radius: 4px;
            font-size: 0.9rem;
            font-family: 'IBM Plex Sans', sans-serif;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-navy);
            box-shadow: 0 0 0 3px rgba(27, 59, 111, 0.1);
        }
        
        .form-input:read-only {
            background: rgba(212, 175, 55, 0.1);
            border-color: var(--accent-gold);
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--primary-navy);
        }
        
        .chainage-group {
            display: flex;
            gap: 10px;
        }
        
        .milestone-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .milestone-table th {
            background: var(--bg-table-header);
            padding: 10px;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--primary-navy);
            border: 1px solid var(--border-medium);
        }
        
        .milestone-table td {
            padding: 8px;
            border: 1px solid var(--border-light);
        }
        
        .milestone-table input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--border-medium);
            border-radius: 3px;
            font-size: 0.85rem;
        }
        
        /* Tabular (Tab 2 & 3) */
        .tabular-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
            position: relative;
        }
        
        .toolbar {
            background: white;
            padding: 15px 30px;
            border-bottom: 2px solid var(--border-light);
            display: flex;
            justify-content: space-between;
        }
        
        .toolbar-left {
            display: flex;
            gap: 10px;
        }
        
        .content-split {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .table-panel {
            flex: 0 0 70%;
            background: white;
            border-right: 2px solid var(--border-medium);
            overflow: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table-header {
            background: var(--primary-navy);
            color: white;
            padding: 12px 20px;
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        .data-table thead {
            position: sticky;
            top: 0;
            background: var(--bg-table-header);
            z-index: 10;
        }
        
        .data-table th {
            padding: 12px;
            text-align: left;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--primary-navy);
            border-bottom: 2px solid var(--border-medium);
            border-right: 1px solid var(--border-light);
        }
        
        .data-table tbody tr {
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
        }
        
        .data-table tbody tr:hover {
            background: rgba(27, 59, 111, 0.03);
        }
        
        .data-table tbody tr.selected {
            background: rgba(212, 175, 55, 0.1);
            border-left: 4px solid var(--accent-gold);
        }
        
        .data-table td {
            padding: 10px 12px;
            border-right: 1px solid var(--border-light);
        }
        
        .split-view {
            display: flex;
            gap: 0;
            height: calc(100vh - 240px);
            overflow: hidden;
        }
        
        .list-panel {
            flex: 0 0 70%;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-right: 2px solid var(--border-light);
        }
        
        .detail-panel {
            flex: 0 0 30%;
            background: var(--bg-surface);
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 0;
            max-height: calc(100vh - 160px);
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .detail-header {
            background: var(--primary-navy);
            color: white;
            padding: 15px 20px;
            font-size: 1rem;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 40px;
        }
        
        .detail-tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid var(--border-light);
        }
        
        .detail-tab {
            padding: 10px 15px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            text-transform: uppercase;
        }
        
        .detail-tab:hover {
            color: var(--primary-navy);
        }
        
        .detail-tab.active {
            color: var(--primary-navy);
            border-bottom-color: var(--accent-gold);
        }
        
        .detail-tab-content {
            display: none;
        }
        
        .detail-tab-content.active {
            display: block;
        }
        
        .resource-subtab {
            display: none;
        }
        
        .resource-subtab.active {
            display: block;
        }
        
        /* TAB 7: ACTIVITY GRID STYLES - OPC INSPIRED */
        .activity-main-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 280px);
        }
        
        .view-mode-bar {
            display: flex;
            gap: 8px;
            padding: 12px 15px;
            background: #f9fafb;
            border-bottom: 1px solid var(--border-light);
        }
        
        .view-mode-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-medium);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .view-mode-btn:hover {
            background: rgba(59, 130, 246, 0.05);
            border-color: #3b82f6;
        }
        
        .view-mode-btn.active {
            background: var(--primary-navy);
            color: white;
            border-color: var(--primary-navy);
        }
        
        .activity-content-area {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .activity-table-section {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .activity-table-section.split-mode {
            flex: 0 0 60%;
            border-right: 1px solid var(--border-light);
        }
        
        .chart-section {
            flex: 0 0 40%;
            background: white;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chart-section.visible {
            display: flex;
        }
        
        .chart-section.full-width {
            flex: 1;
        }
        
        .activity-table-header {
            padding: 12px 15px;
            background: white;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .activity-table-container {
            flex: 1;
            overflow: auto;
        }
        
        .activity-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .activity-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f9fafb;
            border-bottom: 2px solid var(--border-medium);
        }
        
        .activity-table th {
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.8125rem;
            color: #374151;
            border-right: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        
        .activity-table tbody tr {
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.15s;
        }
        
        .activity-table tbody tr:hover {
            background: #f9fafb;
        }
        
        .activity-table tbody tr.selected {
            background: rgba(59, 130, 246, 0.06);
            box-shadow: inset 3px 0 0 #3b82f6;
        }
        
        .activity-table td {
            padding: 10px;
            border-right: 1px solid #f3f4f6;
            vertical-align: middle;
        }
        
        /* WBS Level Styling - OPC Clean Style */
        .activity-row-wbs {
            background: #fafafa;
            font-weight: 600;
        }
        
        .activity-row-stretch {
            background: #fcfcfc;
            font-weight: 500;
        }
        
        .activity-row-task {
            background: white;
        }
        
        /* Critical Path Highlighting - P6 Style */
        .activity-row-critical {
            background: #fff5f5 !important;
            border-left: 4px solid #ef4444;
        }
        
        .activity-row-critical td {
            font-weight: 600;
        }
        
        .activity-row-critical-parent {
            background: #fff7ed !important;
            border-left: 4px solid #f97316;
        }
        
        /* Workable Status Borders */
        .activity-row-workable {
            border-left: 3px solid #22c55e;
        }
        
        .activity-row-structure {
            border-left: 3px solid #3b82f6;
        }
        
        .activity-row-blocked {
            border-left: 3px solid #ef4444;
            background: #fef2f2 !important;
        }
        
        /* Activity Name with Tree Indent */
        .activity-name-cell {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .indent-0 { padding-left: 8px; }
        .indent-1 { padding-left: 32px; }
        .indent-2 { padding-left: 56px; }
        
        .tree-toggle {
            cursor: pointer;
            user-select: none;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #6b7280;
            border-radius: 3px;
        }
        
        .tree-toggle:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }
        
        /* Status with Inline Indicator */
        .status-cell {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8125rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-ready { background: #22c55e; }
        .status-progress { background: #f59e0b; }
        .status-blocked { background: #ef4444; }
        .status-complete { background: #6b7280; }
        
        /* Progress Bar in % Column */
        .progress-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .progress-bar-container {
            flex: 1;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
            transition: width 0.3s;
        }
        
        .progress-text {
            font-size: 0.75rem;
            color: #6b7280;
            min-width: 32px;
        }
        
        /* Badge Styles */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.6875rem;
            font-weight: 600;
            line-height: 1.2;
        }
        
        .badge-cp {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .badge-has-cp {
            background: #ffedd5;
            color: #ea580c;
        }
        
        .badge-auto {
            background: #dcfce7;
            color: #16a34a;
        }
        
        /* Chart Styles */
        .chart-header {
            padding: 12px 15px;
            background: #f9fafb;
            border-bottom: 1px solid var(--border-light);
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .chart-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }
        
        .gantt-timeline-header {
            display: flex;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .gantt-activity-label {
            flex: 0 0 200px;
            font-weight: 600;
            font-size: 0.8125rem;
            color: #374151;
        }
        
        .gantt-timeline {
            flex: 1;
            display: flex;
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 600;
        }
        
        .gantt-month {
            flex: 1;
            text-align: center;
            border-right: 1px solid #e5e7eb;
        }
        
        .gantt-row {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .gantt-bar-track {
            flex: 1;
            position: relative;
            height: 32px;
        }
        
        .gantt-bar {
            position: absolute;
            height: 28px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 0.75rem;
            color: white;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .gantt-bar-workable {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }
        
        .gantt-bar-structure {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .gantt-bar-blocked {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .gantt-bar-critical {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            border: 2px solid #7f1d1d;
        }
        
        .wbs-tree {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            padding: 15px;
        }
        
        .wbs-item {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none;
        }
        
        .wbs-item:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .wbs-item.selected {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid #3b82f6;
        }
        
        .wbs-level-0 {
            font-weight: 700;
            font-size: 1rem;
            background: rgba(30, 64, 175, 0.05);
            border-left: 4px solid var(--primary-navy);
            margin-top: 15px;
        }
        
        .wbs-level-1 {
            margin-left: 20px;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .wbs-level-2 {
            margin-left: 40px;
            font-size: 0.9rem;
        }
        
        .wbs-level-3 {
            margin-left: 60px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .wbs-expand-icon {
            display: inline-block;
            width: 16px;
            margin-right: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .wbs-icon {
            display: inline-block;
            margin-right: 8px;
            font-size: 1rem;
        }
        
        .wbs-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .badge-auto {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }
        
        .badge-manual {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }
        
        .badge-blocked {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        .wbs-info {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-left: 28px;
            padding: 4px 0;
        }
        
        .chart-view-toggle {
            display: flex;
            gap: 10px;
            padding: 12px 15px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-light);
        }
        
        .chart-view-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-medium);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .chart-view-btn:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .chart-view-btn.active {
            background: var(--primary-navy);
            color: white;
            border-color: var(--primary-navy);
        }
        
        .gantt-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background: #fafafa;
        }
        
        .linear-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background: #fafafa;
        }
        
        .gantt-row {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .gantt-label {
            flex: 0 0 200px;
            font-size: 0.85rem;
            padding-right: 15px;
        }
        
        .gantt-timeline {
            flex: 1;
            position: relative;
            height: 30px;
        }
        
        .gantt-bar {
            position: absolute;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 0.75rem;
            color: white;
            font-weight: 600;
        }
        
        .gantt-bar-workable {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }
        
        .gantt-bar-structure {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .gantt-bar-blocked {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .component-section {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .component-header {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary-navy);
            margin-bottom: 12px;
            text-transform: uppercase;
            border-left: 4px solid var(--accent-gold);
            padding-left: 10px;
        }
        
        .checkbox-grid {
            display: grid;
            gap: 8px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .checkbox-item label {
            font-size: 0.85rem;
            cursor: pointer;
        }
        
        .info-box {
            background: rgba(59, 130, 246, 0.05);
            border-left: 4px solid var(--info);
            padding: 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-bottom: 15px;
        }
        
        .radio-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .radio-item {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border-light);
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .radio-item:hover {
            border-color: var(--primary-navy);
        }
        
        .radio-item.selected {
            border-color: var(--accent-gold);
            background: rgba(212, 175, 55, 0.1);
        }
        
        .mini-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.8rem;
        }
        
        .mini-table th {
            background: var(--bg-table-header);
            padding: 8px;
            text-align: left;
            font-weight: 600;
            border: 1px solid var(--border-light);
        }
        
        .mini-table td {
            padding: 6px 8px;
            border: 1px solid var(--border-light);
        }
        
        .mini-table select, .mini-table input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid var(--border-medium);
            border-radius: 3px;
            font-size: 0.8rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-icon {
            font-size: 4rem;
            opacity: 0.3;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: 2px solid;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
            text-transform: uppercase;
            transition: all 0.2s;
            font-family: 'IBM Plex Sans', sans-serif;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background: var(--primary-navy);
            border-color: var(--primary-navy);
            color: white;
        }
        
        .btn-secondary {
            background: white;
            border-color: var(--border-medium);
            color: var(--text-primary);
        }
        
        .btn-success {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.75rem;
        }
        
        .btn-add {
            padding: 8px 16px;
            background: var(--accent-gold);
            border: 2px solid var(--accent-gold);
            color: var(--primary-navy);
            font-weight: 700;
        }
        
        .hidden { display: none !important; }
    
        /* ‚îÄ‚îÄ TCS CHIP BUTTONS ‚îÄ‚îÄ */
        .tcs-chip {
            padding: 5px 12px;
            border: 1.5px solid var(--border-medium);
            background: #fff;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }
        .tcs-chip.active {
            background: var(--navy);
            color: var(--accent-gold);
            border-color: var(--navy);
        }
        .tcs-chip:hover:not(.active) {
            border-color: var(--navy);
            color: var(--navy);
        }

        /* ‚îÄ‚îÄ TCS ELEMENT ROW ‚îÄ‚îÄ */
        .tcs-element-group { margin-bottom: 14px; }
        .tcs-group-label {
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--navy);
            padding: 4px 10px;
            background: #f0f4ff;
            border-left: 3px solid var(--navy);
            margin-bottom: 6px;
        }
        .tcs-element-row {
            display: grid;
            grid-template-columns: 24px 200px 120px 80px 1fr;
            align-items: center;
            gap: 10px;
            padding: 6px 10px;
            border-radius: 5px;
            border: 1px solid transparent;
            transition: background 0.1s;
            font-size: 0.8rem;
        }
        .tcs-element-row:hover { background: #f8fafc; }
        .tcs-element-row.checked { background: #f0fdf4; border-color: #bbf7d0; }
        .tcs-element-row input[type=checkbox] { cursor: pointer; width: 15px; height: 15px; }
        .tcs-elem-name { font-weight: 600; color: var(--navy); }
        .tcs-elem-name.disabled { color: var(--text-secondary); font-weight: 400; }
        .tcs-elem-size input {
            width: 100%;
            padding: 3px 7px;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 0.78rem;
            background: #fff;
        }
        .tcs-elem-unit { font-size: 0.72rem; color: var(--text-secondary); }
        .tcs-elem-boq { font-size: 0.7rem; color: #16a34a; }

        /* ‚îÄ‚îÄ STRUCTURE BOQ PANEL ‚îÄ‚îÄ */
        .struct-boq-panel {
            margin-top: 12px;
            border-top: 2px dashed #7c3aed;
            padding-top: 12px;
        }

        /* ‚îÄ‚îÄ UNIFORM CONSISTENCY ‚îÄ‚îÄ */
        .section-header {
            font-size: 0.82rem;
            font-weight: 700;
            color: var(--navy);
            padding: 8px 0 8px 0;
            border-bottom: 2px solid var(--accent-gold);
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        /* Status badge colors consistent across all tabs */
        .badge-green  { background:#dcfce7;color:#15803d;padding:2px 8px;border-radius:10px;font-size:0.68rem;font-weight:700; }
        .badge-yellow { background:#fef9c3;color:#92400e;padding:2px 8px;border-radius:10px;font-size:0.68rem;font-weight:700; }
        .badge-red    { background:#fee2e2;color:#dc2626;padding:2px 8px;border-radius:10px;font-size:0.68rem;font-weight:700; }
        .badge-gray   { background:#f1f5f9;color:#475569;padding:2px 8px;border-radius:10px;font-size:0.68rem;font-weight:700; }
        /* Form label consistency */
        .form-label-sm { font-size:0.72rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px; }
        /* Card wrapper */
        .k-card {
            background:#fff;border:1px solid var(--border-light);border-radius:8px;
            padding:14px;margin-bottom:10px;border-left:4px solid var(--navy);
        }
        .k-card:hover { box-shadow: 0 2px 8px rgba(27,59,111,0.1); }

        /* ‚îÄ‚îÄ form-container (Calendar tab) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .form-container {
            padding: 24px 24px 80px 24px;
            overflow-y: auto;
            height: 100%;
        }
        .form-container h2 {
            color: var(--primary-navy);
            margin-bottom: 20px;
            font-size: 1.25rem;
            font-weight: 600;
        }
</style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         KALYANTRA DATA SEED ‚Äî Package-I | 4-Lane | 42 km | HAM
         Runs on page load, pushes correct data to Supabase
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <script>
    async function KALYANTRA_SEED_DATA() {
        const SEED_VERSION = 'v3_pkg1_42km_ham';
        // Skip if already seeded this version
        if (localStorage.getItem('kalyantra_seeded') === SEED_VERSION) {
            console.log('‚úÖ Data already seeded:', SEED_VERSION);
            return;
        }
        // Mark as seeded immediately to prevent repeat runs
        localStorage.setItem('kalyantra_seeded', SEED_VERSION);
        console.log('üå± Seeding project data to Supabase (one-time)...');

        const PID = KALYANTRA_PROJECT_ID;
        const H = {
            'apikey': SUPA_KEY,
            'Authorization': 'Bearer ' + SUPA_KEY,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
        };
        const BASE = SUPA_URL + '/rest/v1';

        // Helper
        const upsert = async (table, data, conflict='id') => {
            const r = await fetch(`${BASE}/${table}?on_conflict=${conflict}`, {
                method:'POST', headers:{...H,'Prefer':'resolution=merge-duplicates,return=minimal'},
                body: JSON.stringify(data)
            });
            if (!r.ok) {
                const t = await r.text();
                console.error(`‚ùå ${table} upsert failed:`, r.status, t.slice(0,200));
            }
            return r.ok;
        };
        const del = async (table, col, val) => {
            await fetch(`${BASE}/${table}?${col}=eq.${val}`, {
                method:'DELETE', headers:H
            });
        };

        // ‚îÄ‚îÄ 1. PROJECT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        await upsert('projects', {
            id: PID,
            name: 'Package-I | 4-Lane | 42 km | HAM',
            budget: 1356.90,
            start_date: '2025-02-01',
            end_date: '2027-02-01',
            location: 'Telangana ‚Äî Ch 0+000 to Ch 42+000',
            start_chainage: 0,
            end_chainage: 42000,
            industry_type: 'Road Construction',
            project_mode: 'HAM',
            version: '3.0'
        });
        console.log('‚úÖ Project upserted');

        // ‚îÄ‚îÄ 2. TCS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Delete old TCS, insert new
        await del('tcs', 'project_id', PID);
        const boqData = {
            tcsList: [
                {
                    id: 'tcs_bypass1',
                    name: 'TCS-1 | Bypass-1 (Ch 0+000 ‚Äì 12+660)',
                    roadCategory: 'NH/SH', constType: 'New', frozen: false,
                    elements: {},
                    locations: [
                        {fromCh:0,     toCh:700,   label:'Ch 0+000‚Äì0+700 (Interchange+Median)'},
                        {fromCh:700,   toCh:2820,  label:'Ch 0+700‚Äì2+820 (Bypass SR)'},
                        {fromCh:2820,  toCh:4710,  label:'Ch 2+820‚Äì4+710 (Bypass SR)'},
                        {fromCh:4710,  toCh:7400,  label:'Ch 4+710‚Äì7+400 (Bypass SR)'},
                        {fromCh:7400,  toCh:9230,  label:'Ch 7+400‚Äì9+230 (Bypass SR)'},
                        {fromCh:9230,  toCh:12660, label:'Ch 9+230‚Äì12+660 (Bypass SR end)'}
                    ],
                    boqItems: [],
                    note: 'Fig 2.5A/2.5D | 60m PROW | 2√ó7m CW + 4m raised median + 7m SR both sides | Pavement: 500mm SG + 200mm GSB + 250mm WMM + 115mm DBM + 50mm BC'
                },
                {
                    id: 'tcs_rob_approach',
                    name: 'TCS-2 | ROB Approach Sections',
                    roadCategory: 'NH/SH', constType: 'New', frozen: false,
                    elements: {},
                    locations: [
                        {fromCh:3680,  toCh:4188,  label:'ROB-1 approach Ch 3+680‚Äì4+188'},
                        {fromCh:5432,  toCh:6560,  label:'ROB-2 approach Ch 5+432‚Äì6+560'},
                        {fromCh:9782,  toCh:11132, label:'ROB-3 approach Ch 9+782‚Äì11+132'},
                        {fromCh:18420, toCh:19200, label:'ROB-4 approach Ch 18+420‚Äì19+200'}
                    ],
                    boqItems: [],
                    note: 'Fig 2.4E/2.4F | ROB approach sections | Wider embankment for railway clearance'
                },
                {
                    id: 'tcs_main_concentric',
                    name: 'TCS-3 | Main Alignment ‚Äî Concentric Widening',
                    roadCategory: 'NH/SH', constType: 'Widening', frozen: false,
                    elements: {},
                    locations: [
                        {fromCh:12660, toCh:13800, label:'Ch 12+660‚Äì13+800'},
                        {fromCh:14800, toCh:16680, label:'Ch 14+800‚Äì16+680'},
                        {fromCh:17500, toCh:18420, label:'Ch 17+500‚Äì18+420'},
                        {fromCh:21000, toCh:22070, label:'Ch 21+000‚Äì22+070 (incl. Toll Plaza Ch 21+547)'},
                        {fromCh:23940, toCh:24582, label:'Ch 23+940‚Äì24+582'},
                        {fromCh:29230, toCh:33700, label:'Ch 29+230‚Äì33+700 (4.47 km plain)'},
                        {fromCh:34530, toCh:36996, label:'Ch 34+530‚Äì36+996'},
                        {fromCh:36996, toCh:37680, label:'Ch 36+996‚Äì37+680'},
                        {fromCh:39900, toCh:42000, label:'Ch 39+900‚Äì42+000 (end)'}
                    ],
                    boqItems: [],
                    note: 'Fig 2.4A | 45m PROW | 2√ó7m CW + 4m raised median + 2.5m paved shoulder | No service road | Pavement: 115 MSA, 15 yr design life'
                },
                {
                    id: 'tcs_buildup',
                    name: 'TCS-4 | Built-Up & Service Road Sections',
                    roadCategory: 'NH/SH', constType: 'Widening', frozen: false,
                    elements: {},
                    locations: [
                        {fromCh:13800, toCh:14800, label:'Ch 13+800‚Äì14+800 (LVUP-3 zone)'},
                        {fromCh:16680, toCh:17500, label:'Ch 16+680‚Äì17+500 (LVUP-4 zone)'},
                        {fromCh:19200, toCh:21000, label:'Ch 19+200‚Äì21+000 (Mandamarri built-up)'},
                        {fromCh:22070, toCh:23940, label:'Ch 22+070‚Äì23+940 (Somagudem built-up)'},
                        {fromCh:33700, toCh:34530, label:'Ch 33+700‚Äì34+530 (Boyapalle built-up)'},
                        {fromCh:37680, toCh:39900, label:'Ch 37+680‚Äì39+900 (Tandur built-up)'}
                    ],
                    boqItems: [],
                    note: 'Fig 2.6A/2.6C | 45‚Äì60m PROW | Service road 7m both sides through towns | 9.2 km total built-up'
                },
                {
                    id: 'tcs_bypass2',
                    name: 'TCS-5 | Bypass-2 (Ch 24+582 ‚Äì 28+982)',
                    roadCategory: 'NH/SH', constType: 'New', frozen: false,
                    elements: {},
                    locations: [
                        {fromCh:24582, toCh:25530, label:'Ch 24+582‚Äì25+530 (plain section)'},
                        {fromCh:25530, toCh:29230, label:'Ch 25+530‚Äì29+230 (with service road)'}
                    ],
                    boqItems: [],
                    note: 'Fig 2.5B/2.4 | 60m PROW | 2√ó7m CW + 4m raised median + 7m SR both sides | 4.400 km'
                }
            ],
            structureBOQ: [],
            generationConfig: {sequence:[], productivityRates:{}, confirmed:false}
        };
        await fetch(`${BASE}/tcs`, {
            method:'POST',
            headers:{...H,'Prefer':'return=minimal'},
            body: JSON.stringify({
                project_id: PID,
                carriage_width: 7.0,
                shoulder_width: 2.5,
                layers: {
                    main:        {subgrade:500, gsb:200, wmm:250, dbm:115, bc:50, total:1115, msa:115, designLife:15},
                    serviceRoad: {subgrade:500, gsb:200, wmm:250, dbm:50,  bc:40, total:1040, msa:10},
                    tollPlaza:   {subgrade:500, gsb:150, dlc:150, pqc:280, type:'Rigid'}
                },
                boq_data: JSON.stringify(boqData)
            })
        }).then(r=>console.log('‚úÖ TCS inserted:', r.ok));

        // Also update boq_data on projects table
        await fetch(`${BASE}/projects?id=eq.${PID}`, {
            method:'PATCH',
            headers:{...H,'Prefer':'return=minimal'},
            body: JSON.stringify({
                boq_data: JSON.stringify(boqData)
            })
        });
        console.log('‚úÖ BOQ data updated on project');

        // ‚îÄ‚îÄ 3. HINDRANCES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        await del('hindrances', 'project_id', PID);
        const hindrances = [
            {
                project_id: PID, sort_order: 1,
                name: 'Forest Land Diversion ‚Äî Bypass-1',
                type: 'forest', category: 'Forest Clearance',
                chainage_start: 7500, chainage_end: 9200,
                status: 'Pending', impact: 'MoEF Stage-2 approval pending. Affects ROB-2 and ROB-3 approach stretch. ~1.7 km land not handed over.',
                resolution_days: 90
            },
            {
                project_id: PID, sort_order: 2,
                name: 'ROB-3 Railway GAD Approval',
                type: 'permit', category: 'Railway Coordination',
                chainage_start: 10100, chainage_end: 10500,
                status: 'Pending', impact: 'ROB-3 (104m span) GAD pending from Railway Division. P&E charges deposited. Largest ROB on project ‚Äî critical path item.',
                resolution_days: 120
            },
            {
                project_id: PID, sort_order: 3,
                name: 'OHE Line Shifting ‚Äî Ch 15+000',
                type: 'utility', category: 'Utility Shifting',
                chainage_start: 15000, chainage_end: 15500,
                status: 'Pending', impact: 'OHE line shifting at Ch 15+000 to 15+500. Coordination with TSECPDCL initiated. Affects 500m of main carriageway widening.',
                resolution_days: 45
            }
        ];
        await fetch(`${BASE}/hindrances`, {
            method:'POST',
            headers:{...H,'Prefer':'return=minimal'},
            body: JSON.stringify(hindrances)
        }).then(r=>console.log('‚úÖ Hindrances inserted:', r.ok));

        // ‚îÄ‚îÄ 4. MILESTONES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        await del('milestones', 'project_id', PID);
        const milestones = [
            {project_id:PID, sort_order:1, description:'M1 ‚Äî 20% Physical Progress', target_date:'2025-09-19', completion:20, milestone_type:'physical'},
            {project_id:PID, sort_order:2, description:'M2 ‚Äî 35% Physical Progress', target_date:'2026-01-07', completion:35, milestone_type:'physical'},
            {project_id:PID, sort_order:3, description:'M3 ‚Äî 75% Physical Progress', target_date:'2026-06-26', completion:75, milestone_type:'physical'},
            {project_id:PID, sort_order:4, description:'Scheduled Completion Date',  target_date:'2027-02-01', completion:100, milestone_type:'physical'},
            {project_id:PID, sort_order:5, description:'M1 Financial ‚Äî 20% Cost Expended', target_date:'2025-09-19', completion:20, milestone_type:'financial'},
            {project_id:PID, sort_order:6, description:'M2 Financial ‚Äî 35% Cost + 70% Equity', target_date:'2026-01-07', completion:35, milestone_type:'financial'}
        ];
        await fetch(`${BASE}/milestones`, {
            method:'POST',
            headers:{...H,'Prefer':'return=minimal'},
            body: JSON.stringify(milestones)
        }).then(r=>console.log('‚úÖ Milestones inserted:', r.ok));

        // ‚îÄ‚îÄ 5. CALENDAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        await del('calendar', 'project_id', PID);
        await fetch(`${BASE}/calendar`, {
            method:'POST',
            headers:{...H,'Prefer':'return=minimal'},
            body: JSON.stringify({
                project_id: PID,
                working_days: [1,2,3,4,5,6],
                hours_per_day: 10,
                monsoon_start: '2025-06-15',
                monsoon_end: '2025-09-30',
                holidays: ['2025-08-15','2025-10-02','2026-01-26','2026-08-15']
            })
        }).then(r=>console.log('‚úÖ Calendar inserted:', r.ok));

        // Mark seeded
        localStorage.setItem('kalyantra_seeded', SEED_VERSION);
        console.log('üéâ SEED COMPLETE ‚Äî reloading in 2s...');
        setTimeout(()=>location.reload(), 2000);
    }

    // Run after Supabase client is ready
    window.addEventListener('load', () => {
        setTimeout(KALYANTRA_SEED_DATA, 1500);
    });
    </script>

</head>
<body>
    <div class="app-container">
        <!-- LEFT SIDEBAR -->
        <div class="sidebar expanded" id="mainSidebar">
            <div class="sidebar-header">
                <button class="sidebar-toggle" id="sidebarToggle" title="Toggle Sidebar">‚ò∞</button>
                <div class="sidebar-brand">
                    <div class="sidebar-brand-title">KALYANTRA</div>
                    <div class="sidebar-brand-sub" style="font-size:0.6rem;opacity:0.5;">Infra PM</div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="sidebar-section-label">Data Entry</div>
                <button class="sidebar-item active" data-tab="0" data-label="Project Basics" onclick="sidebarSwitchTab(0, this)">
                    <span class="sidebar-icon">üìã</span>
                    <span class="sidebar-label">Project Basics</span>
                </button>
                <button class="sidebar-item" data-tab="1" data-label="TCS &amp; Sections" onclick="sidebarSwitchTab(1, this)">
                    <span class="sidebar-icon">üìê</span>
                    <span class="sidebar-label">TCS &amp; Sections</span>
                </button>
                <button class="sidebar-item" data-tab="2" data-label="Structures" onclick="sidebarSwitchTab(2, this)">
                    <span class="sidebar-icon">üåâ</span>
                    <span class="sidebar-label">Structures</span>
                </button>
                <button class="sidebar-item" data-tab="3" data-label="Hindrances" onclick="sidebarSwitchTab(3, this)">
                    <span class="sidebar-icon">‚ö†Ô∏è</span>
                    <span class="sidebar-label">Hindrances</span>
                </button>
                <button class="sidebar-item" data-tab="4" data-label="Calendar" onclick="sidebarSwitchTab(4, this)">
                    <span class="sidebar-icon">üìÖ</span>
                    <span class="sidebar-label">Calendar</span>
                </button>
                <button class="sidebar-item" data-tab="5" data-label="Resources" onclick="sidebarSwitchTab(5, this)">
                    <span class="sidebar-icon">üì¶</span>
                    <span class="sidebar-label">Resources</span>
                </button>
                <div class="sidebar-divider"></div>
                <div class="sidebar-section-label">Planning</div>
                <button class="sidebar-item" data-tab="6" data-label="BOQ" onclick="sidebarSwitchTab(6, this)">
                    <span class="sidebar-icon">üí∞</span>
                    <span class="sidebar-label">BOQ</span>
                </button>
                <button class="sidebar-item" data-tab="7" data-label="Activity Grid" onclick="sidebarSwitchTab(7, this)">
                    <span class="sidebar-icon">üìä</span>
                    <span class="sidebar-label">Activity Grid</span>
                </button>
                <button class="sidebar-item" data-tab="11" data-label="Constraints" onclick="sidebarSwitchTab(11, this)">
                    <span class="sidebar-icon">üîó</span>
                    <span class="sidebar-label">Constraints</span>
                </button>
                <button class="sidebar-item" data-tab="12" data-label="Baseline" onclick="sidebarSwitchTab(12, this)">
                    <span class="sidebar-icon">üì∏</span>
                    <span class="sidebar-label">Baseline</span>
                </button>
                <div class="sidebar-divider"></div>
                <div class="sidebar-section-label">Monitoring</div>
                <button class="sidebar-item" data-tab="9" data-label="Progress Tracking" onclick="sidebarSwitchTab(9, this)">
                    <span class="sidebar-icon">üìç</span>
                    <span class="sidebar-label">Progress Tracking</span>
                </button>
                <div class="sidebar-divider"></div>
                <div class="sidebar-section-label">Decision Support</div>
                <button class="sidebar-item" data-tab="13" data-label="Scenarios" onclick="sidebarSwitchTab(13, this)">
                    <span class="sidebar-icon">üéØ</span>
                    <span class="sidebar-label">Scenarios</span>
                </button>
                <button class="sidebar-item" data-tab="14" data-label="Alerts" onclick="sidebarSwitchTab(14, this)">
                    <span class="sidebar-icon">üîî</span>
                    <span class="sidebar-label">Alerts</span>
                    <span id="alertBadge" style="display:none;background:#dc2626;color:white;border-radius:10px;padding:0 6px;font-size:0.65rem;font-weight:700;margin-left:auto;"></span>
                </button>
                <button class="sidebar-item" data-tab="15" data-label="Earned Value" onclick="sidebarSwitchTab(15, this)">
                    <span class="sidebar-icon">üìà</span>
                    <span class="sidebar-label">Earned Value</span>
                </button>
                <div class="sidebar-divider"></div>
                <div class="sidebar-section-label">Management</div>
                <button class="sidebar-item" data-tab="8" data-label="Executive Dashboard" onclick="sidebarSwitchTab(8, this)">
                    <span class="sidebar-icon">üè†</span>
                    <span class="sidebar-label">Executive Dashboard</span>
                </button>
                <button class="sidebar-item" data-tab="10" data-label="Reports & Analytics" onclick="sidebarSwitchTab(10, this)">
                    <span class="sidebar-icon">üìÑ</span>
                    <span class="sidebar-label">Reports & Analytics</span>
                </button>

            </nav>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="main-header">
                <div>
                    <div class="app-title">KALYANTRA</div>
                    <div class="app-subtitle" id="headerProjectName" style="color:var(--accent-gold);font-weight:600;opacity:1;">‚Äî Package-I | 4-Lane | 42 km | HAM ‚Äî</div>
                </div>
                <div class="header-meta">
                    <span id="headerTabLabel" style="color:var(--accent-gold);font-weight:600;">üìã Project Basics</span>
                    <span style="opacity:0.5;">|</span>
                    <span id="headerProjectName2">Package-I | 4-Lane | 42 km | HAM</span>
                </div>
                <!-- DB CONNECTION BADGE -->
                <div style="display:flex;align-items:center;gap:6px;margin-left:20px;
                    background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);
                    border-radius:20px;padding:4px 12px;cursor:default;">
                    <span id="supaStatusDot" style="width:8px;height:8px;border-radius:50%;
                        background:#f59e0b;display:inline-block;transition:all 0.4s;"></span>
                    <span id="supaStatusLabel" style="font-size:0.7rem;font-weight:700;
                        color:rgba(255,255,255,0.85);letter-spacing:0.03em;">‚è≥ Connecting...</span>
                </div>
            </div>

            <!-- Hidden horizontal tabs for JS backward-compat -->
            <div class="tab-navigation">
                <button class="main-tab active" onclick="switchMainTab(0)">Tab 1: Project Basics</button>
                <button class="main-tab" onclick="switchMainTab(1)">Tab 2: TCS</button>
                <button class="main-tab" onclick="switchMainTab(2)">Tab 3: Structures</button>
                <button class="main-tab" onclick="switchMainTab(3)">Tab 4: Hindrances</button>
                <button class="main-tab" onclick="switchMainTab(4)">Tab 5: Calendar</button>
                <button class="main-tab" onclick="switchMainTab(5)">Tab 6: Resources</button>
                <button class="main-tab" onclick="switchMainTab(6)">Tab 7: Activity Grid</button>
                <button class="main-tab" onclick="switchMainTab(7)">Tab 8: Executive Dashboard</button>
                <button class="main-tab" onclick="switchMainTab(8)">Tab 9: Progress Tracking</button>
                <button class="main-tab" onclick="switchMainTab(9)">Tab 10: Reports & Analytics</button>
            </div>
        
        <div class="tab-content-area">
            <!-- TAB 1: PROJECT BASICS -->
            <div class="tab-panel active" id="tab1">
                <div class="content-container">
                    <div class="section">
                        <div class="section-header">A. Project Information</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Project Name</label>
                                <input type="text" class="form-input" id="projectName" placeholder="e.g., Package-I | 4-Lane | 42 km | HAM" value="Package-I | 4-Lane | 42 km | HAM" onchange="updateProjectData()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Industry Type</label>
                                <select class="form-select" id="industryType" onchange="updateProjectData()">
                                    <option value="">Select Industry</option>
                                    <option value="roads" selected>Roads</option>
                                    <option value="metro">Metro</option>
                                    <option value="urban">Urban Infrastructure / Smart City</option>
                                    <option value="canal">Canal</option>
                                    <option value="railway">Railway</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Project Mode</label>
                                <select class="form-select" id="projectMode" onchange="updateProjectData()">
                                    <option value="">Select Mode</option>
                                    <option value="epc">EPC</option>
                                    <option value="bot">BOT</option>
                                    <option value="ham" selected>HAM</option>
                                    <option value="itemrate">Item Rate Contract</option>
                                    <option value="annuity">Annuity</option>
                                    <option value="hybrid">Hybrid</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Total Project Cost (‚Çπ Crores)</label>
                                <input type="number" class="form-input" id="projectCost" placeholder="500.00" value="1356.90" step="0.01" onchange="recalculateFinancialMilestones()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Start Chainage</label>
                                <div class="chainage-group">
                                    <input type="number" class="form-input" id="startKm" placeholder="Km" value="0" style="flex: 1;" onchange="calculateLength()">
                                    <input type="number" class="form-input" id="startM" placeholder="M" value="0" style="flex: 1;" max="999" onchange="calculateLength()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">End Chainage</label>
                                <div class="chainage-group">
                                    <input type="number" class="form-input" id="endKm" placeholder="Km" value="42" style="flex: 1;" onchange="calculateLength()">
                                    <input type="number" class="form-input" id="endM" placeholder="M" value="0" style="flex: 1;" max="999" onchange="calculateLength()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Total Length (km)</label>
                                <input type="text" class="form-input" id="totalLength" placeholder="Auto-calculated" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-header">B. Contractual Dates</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">LOA Date</label>
                                <input type="date" class="form-input" id="loaDate" value="2024-12-18" onchange="updateProjectData()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Agreement Signing Date</label>
                                <input type="date" class="form-input" id="agreementDate" value="2025-01-02" onchange="updateProjectData()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Appointed Date</label>
                                <input type="date" class="form-input" id="appointedDate" value="2025-02-01" onchange="calculateCompletion()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Contract Duration (Months)</label>
                                <input type="number" class="form-input" id="duration" placeholder="18" value="24" onchange="calculateCompletion()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Scheduled Completion Date</label>
                                <input type="text" class="form-input" id="completionDate" placeholder="Auto-calculated" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-header">C. Milestones</div>
                        <div style="margin-bottom: 25px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <label class="form-label" style="margin: 0;">Physical Milestones</label>
                                <button class="btn btn-add btn-sm" onclick="addPhysicalMilestone()">+ Add Milestone</button>
                            </div>
                            <table class="milestone-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">#</th>
                                        <th>Target Date</th>
                                        <th>Completion %</th>
                                        <th>Duration (Months)</th>
                                        <th>Description</th>
                                        <th style="width: 80px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="physicalMilestones">
                                    <tr>
                                        <td>1</td>
                                        <td><input type="date" onchange="readMilestones()"></td>
                                        <td><input type="number" placeholder="25" min="0" max="100" onchange="readMilestones()"></td>
                                        <td><input type="number" placeholder="6" onchange="readMilestones()"></td>
                                        <td><input type="text" placeholder="First Milestone" onchange="readMilestones()"></td>
                                        <td><button class="btn btn-sm btn-secondary" onclick="deleteRow(this)">Delete</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <label class="form-label" style="margin: 0;">Financial Milestones</label>
                                <button class="btn btn-add btn-sm" onclick="addFinancialMilestone()">+ Add Milestone</button>
                            </div>
                            <table class="milestone-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">#</th>
                                        <th>Days from Start</th>
                                        <th>Progress %</th>
                                        <th>Schedule Date</th>
                                        <th>Amount (‚Çπ Cr)</th>
                                        <th>Cumulative %</th>
                                        <th>Remarks</th>
                                        <th style="width: 80px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="financialMilestones">
                                    <tr>
                                        <td>1</td>
                                        <td><input type="number" placeholder="180" onchange="recalculateFinancialMilestones()"></td>
                                        <td><input type="number" placeholder="25" step="0.01" onchange="recalculateFinancialMilestones()"></td>
                                        <td><input type="text" class="readonly-calc" placeholder="Auto-calculated" readonly style="background: rgba(212, 175, 55, 0.1); border-color: #D4AF37; font-weight: 600;"></td>
                                        <td><input type="text" class="readonly-calc" placeholder="Auto-calculated" readonly style="background: rgba(212, 175, 55, 0.1); border-color: #D4AF37; font-weight: 600;"></td>
                                        <td><input type="text" class="readonly-calc" placeholder="Auto-calculated" readonly style="background: rgba(212, 175, 55, 0.1); border-color: #D4AF37; font-weight: 600;"></td>
                                        <td><input type="text" placeholder="First payment"></td>
                                        <td><button class="btn btn-sm btn-secondary" onclick="deleteRow(this)">Delete</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 10px;">
                        <button class="btn btn-secondary" onclick="updateProjectData(); showToast('‚úÖ Project draft saved', 'success')">Save as Draft</button>
                        <button class="btn btn-primary" onclick="validateAndProceed()">Next: Define TCS ‚Üí</button>
                    </div>

                    <div style="height:70px;"></div><!-- Sticky Nav Footer -->
                    <div style="position:sticky;bottom:0;background:#1B3B6F;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;border-top:3px solid #D4AF37;z-index:20;margin-top:auto;">
                        <span style="width:100px;"></span>
                        <span style="font-size:0.8rem;color:rgba(255,255,255,0.6);font-weight:500;">Step 1 of 6 ¬∑ Project Basics</span>
                        <button onclick="validateAndProceed()" style="padding:8px 20px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:6px;font-weight:700;font-size:0.85rem;cursor:pointer;">Next: TCS Profile ‚Üí</button>
                    </div>
                </div>
            </div>
            
            <!-- TAB 2: TCS (TABULAR 70/30) -->
            <div class="tab-panel" id="tab2">
    <div class="content-container" style="padding-bottom:80px;">

        <!-- TOP ACTION BAR -->
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
            <div>
                <div style="font-size:1rem;font-weight:700;color:var(--navy);">Typical Cross Sections (TCS)</div>
                <div style="font-size:0.75rem;color:var(--text-secondary);">Define each unique TCS type ‚Üí assign locations ‚Üí attach BOQ. One TCS can apply to multiple chainage ranges.</div>
            </div>
            <div style="display:flex;gap:8px;">
                <button onclick="tcsAddNew()" style="background:var(--accent-gold);color:#1B3B6F;border:none;padding:8px 18px;border-radius:6px;font-weight:700;font-size:0.82rem;cursor:pointer;">+ Add TCS</button>
                <button onclick="generateWBS()" style="background:linear-gradient(135deg,#16a34a,#15803d);color:#fff;border:none;padding:8px 16px;border-radius:6px;font-weight:700;font-size:0.82rem;cursor:pointer;">‚ö° Generate WBS & Schedule</button>
            </div>
        </div>

        <!-- BOQ SUMMARY BAR -->
        <div id="boqSummaryBar" style="display:none;margin-bottom:14px;display:flex;gap:16px;flex-wrap:wrap;background:var(--bg-surface);border:1px solid var(--border-light);border-radius:8px;padding:10px 16px;">
            <div style="text-align:center;"><div style="font-size:1rem;font-weight:700;color:var(--navy);" id="boqTotalValue">‚Çπ0 Cr</div><div style="font-size:0.68rem;color:var(--text-secondary);">Total BOQ</div></div>
            <div style="width:1px;background:var(--border-light);"></div>
            <div style="text-align:center;"><div style="font-size:1rem;font-weight:700;color:#16a34a;" id="boqEarnedValue">‚Çπ0 Cr</div><div style="font-size:0.68rem;color:var(--text-secondary);">Earned</div></div>
            <div style="width:1px;background:var(--border-light);"></div>
            <div style="text-align:center;"><div style="font-size:1rem;font-weight:700;color:var(--accent-gold);" id="boqFinancialPct">0%</div><div style="font-size:0.68rem;color:var(--text-secondary);">Financial %</div></div>
            <div style="width:1px;background:var(--border-light);"></div>
            <div style="text-align:center;"><div style="font-size:1rem;font-weight:700;color:#dc2626;" id="boqBlockedValue">‚Çπ0 L</div><div style="font-size:0.68rem;color:var(--text-secondary);">Blocked</div></div>
            <div style="width:1px;background:var(--border-light);"></div>
            <div style="text-align:center;"><div style="font-size:1rem;font-weight:700;color:#7c3aed;" id="boqDeviationCount">0</div><div style="font-size:0.68rem;color:var(--text-secondary);">Deviations</div></div>
        </div>

        <!-- TCS CARDS LIST -->
        <div id="tcsCardsList"></div>

        <!-- EMPTY STATE -->
        <div id="tcsEmptyState" style="text-align:center;padding:60px 20px;color:var(--text-secondary);">
            <div style="font-size:3rem;margin-bottom:12px;">üìê</div>
            <div style="font-size:1rem;font-weight:700;color:var(--navy);margin-bottom:8px;">No TCS defined yet</div>
            <div style="font-size:0.8rem;margin-bottom:20px;line-height:1.7;">
                A Typical Cross Section defines the road geometry and elements for a stretch.<br>
                One TCS type can apply to multiple chainage locations across the project.<br>
                <b>Example:</b> TCS-1 (4-Lane Plain) applies at Ch 0+000‚Äì3+500 and Ch 7+200‚Äì8+000.
            </div>
            <button onclick="tcsAddNew()" style="background:var(--accent-gold);color:#1B3B6F;font-weight:700;border:none;padding:10px 24px;border-radius:6px;cursor:pointer;font-size:0.9rem;">+ Add First TCS</button>
        </div>

        <!-- WHOLE PROJECT BOQ TABLE (shown after sections frozen) -->
        <div id="wholeProjectBOQ" style="display:none;margin-top:20px;">
            <div class="section">
                <div class="section-header" style="display:flex;align-items:center;justify-content:space-between;">
                    <span>üìä Complete Project BOQ</span>
                    <span style="font-size:0.72rem;font-weight:400;color:var(--text-secondary);">Consolidated ‚Äî all TCS sections + locations</span>
                </div>
                <div id="projectBOQTable"></div>
            </div>
        </div>

    </div>

    <div style="height:70px;"></div><!-- Sticky Nav Footer -->
    <div style="position:sticky;bottom:0;background:#1B3B6F;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;border-top:3px solid #D4AF37;z-index:20;">
        <button onclick="switchMainTab(0)" style="padding:8px 20px;background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:6px;font-weight:600;font-size:0.85rem;cursor:pointer;">‚Üê Previous</button>
        <span style="font-size:0.8rem;color:rgba(255,255,255,0.6);">Step 2 of 6 ¬∑ TCS & Sections</span>
        <button onclick="switchMainTab(2)" style="padding:8px 20px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:6px;font-weight:700;font-size:0.85rem;cursor:pointer;">Next: Structures ‚Üí</button>
    </div>
</div>
            
            <!-- TAB 3: STRUCTURES (TABULAR WITH 4 DETAIL TABS) -->
            <div class="tab-panel" id="tab3">
    <div class="content-container" style="padding-bottom:80px;">

        <!-- TOP ACTION BAR -->
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
            <div>
                <div style="font-size:1rem;font-weight:700;color:var(--navy);">Structures</div>
                <div style="font-size:0.75rem;color:var(--text-secondary);">Bridges, culverts, ROBs, RUBs and other structures. Each structure has its own details, drawing status and BOQ.</div>
            </div>
            <button onclick="structAddNew()" style="background:var(--accent-gold);color:#1B3B6F;border:none;padding:8px 18px;border-radius:6px;font-weight:700;font-size:0.82rem;cursor:pointer;">+ Add Structure</button>
        </div>

        <!-- STRUCTURES LIST -->
        <div id="structuresList"></div>

        <!-- EMPTY STATE -->
        <div id="structuresEmptyState" style="text-align:center;padding:60px 20px;color:var(--text-secondary);">
            <div style="font-size:3rem;margin-bottom:12px;">üåâ</div>
            <div style="font-size:1rem;font-weight:700;color:var(--navy);margin-bottom:8px;">No structures defined yet</div>
            <div style="font-size:0.8rem;margin-bottom:20px;">Add bridges, culverts, ROBs, RUBs, retaining walls and other structures.</div>
            <button onclick="structAddNew()" style="background:var(--accent-gold);color:#1B3B6F;font-weight:700;border:none;padding:10px 24px;border-radius:6px;cursor:pointer;font-size:0.9rem;">+ Add First Structure</button>
        </div>

    </div>

    <div style="height:70px;"></div><!-- Sticky Nav Footer -->
    <div style="position:sticky;bottom:0;background:#1B3B6F;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;border-top:3px solid #D4AF37;z-index:20;">
        <button onclick="switchMainTab(1)" style="padding:8px 20px;background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:6px;font-weight:600;font-size:0.85rem;cursor:pointer;">‚Üê Previous</button>
        <span style="font-size:0.8rem;color:rgba(255,255,255,0.6);">Step 3 of 6 ¬∑ Structures</span>
        <button onclick="switchMainTab(3)" style="padding:8px 20px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:6px;font-weight:700;font-size:0.85rem;cursor:pointer;">Next: Hindrances ‚Üí</button>
    </div>
</div>
            
            <!-- TAB 4: CONTRACTUAL HINDRANCES (TABULAR 70/30) -->
            <div class="tab-panel" id="tab4" style="overflow-y:auto;overflow-x:hidden;">
                <div class="tabular-container">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <button class="btn btn-success btn-sm" onclick="addHindrance()">+ Add Hindrance</button>
                            <button class="btn btn-primary btn-sm" onclick="uploadJM()">üìé Upload Joint Memorandum</button>
                        </div>
                        <div class="toolbar-right">
                            <select class="filter-select">
                                <option>All Hindrances</option>
                                <option>Active Only</option>
                                <option>Resolved</option>
                                <option>Critical Only</option>
                            </select>
                            <button class="btn btn-secondary btn-sm">Export Report</button>
                        </div>
                    </div>
                    
                    <div class="split-view">
                        <div class="list-panel">
                            <div class="table-header">Contractual Hindrances</div>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th width="5%"><input type="checkbox"></th>
                                        <th width="5%">#</th>
                                        <th width="15%">Category</th>
                                        <th width="15%">Location</th>
                                        <th width="10%">Land Status</th>
                                        <th width="10%">Status</th>
                                        <th width="10%">Days Open</th>
                                        <th width="15%">Expected Resolution</th>
                                        <th width="15%">Responsibility</th>
                                    </tr>
                                </thead>
                                <tbody id="hindrancesTable">
                                    <tr onclick="selectHindrance(this, 0)">
                                        <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                        <td><strong>1</strong></td>
                                        <td>Land Handover</td>
                                        <td>Ch 10+500 to 12+800</td>
                                        <td><span style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">Non-Clear</span></td>
                                        <td><span style="background: rgba(251, 191, 36, 0.1); color: #f59e0b; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">Active</span></td>
                                        <td>27 days</td>
                                        <td>30/06/2025</td>
                                        <td>Owner</td>
                                    </tr>
                                    <tr onclick="selectHindrance(this, 1)">
                                        <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                        <td><strong>2</strong></td>
                                        <td>Utility Shifting</td>
                                        <td>Ch 15+250</td>
                                        <td><span style="background: rgba(34, 197, 94, 0.1); color: #22c55e; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">Clear</span></td>
                                        <td><span style="background: rgba(251, 191, 36, 0.1); color: #f59e0b; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">Active</span></td>
                                        <td>22 days</td>
                                        <td>30/03/2025</td>
                                        <td>Electricity Board</td>
                                    </tr>
                                    <tr onclick="selectHindrance(this, 2)">
                                        <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                        <td><strong>3</strong></td>
                                        <td>ROB Drawing Approval</td>
                                        <td>Ch 25+500 (ROB)</td>
                                        <td>-</td>
                                        <td><span style="background: rgba(251, 191, 36, 0.1); color: #f59e0b; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">Active</span></td>
                                        <td>53 days</td>
                                        <td>30/06/2025</td>
                                        <td>Railway Board</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="detail-panel">
                            <div class="detail-header">Hindrance Details</div>
                            <div class="detail-content" id="hindranceDetailContent">
                                <div class="empty-state">
                                    <div class="empty-icon">‚ö†Ô∏è</div>
                                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 10px;">No Hindrance Selected</div>
                                    <div style="font-size: 0.9rem;">Click any row to view details</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="height:70px;"></div><!-- Sticky Nav Footer -->
                    <div style="position:sticky;bottom:0;background:#1B3B6F;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;border-top:3px solid #D4AF37;z-index:20;margin-top:auto;">
                        <button onclick="switchMainTab(2)" style="padding:8px 20px;background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:6px;font-weight:600;font-size:0.85rem;cursor:pointer;">‚Üê Previous</button>
                        <span style="font-size:0.8rem;color:rgba(255,255,255,0.6);font-weight:500;">Step 4 of 6 ¬∑ Hindrances</span>
                        <button onclick="switchMainTab(4)" style="padding:8px 20px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:6px;font-weight:700;font-size:0.85rem;cursor:pointer;">Next: Calendar ‚Üí</button>
                    </div>
                </div>
            </div>
            
            <!-- TAB 5: CALENDAR (WORKING DAYS & HOLIDAYS) -->
            <div class="tab-panel" id="tab5">
                <div class="form-container">
                    <h2 style="color: var(--primary-navy); margin-bottom: 20px;">üìÖ Project Calendar</h2>
                    
                    <div class="form-section">
                        <div class="form-section-header">1. WORKING DAYS</div>
                        <div class="form-group">
                            <label class="form-label">Working Days per Week</label>
                            <!-- GAP-04 FIX: Interactive day checkboxes (0=Sun,1=Mon,...,6=Sat) -->
                            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;">
                                <label style="display:flex;align-items:center;gap:4px;font-size:0.82rem;cursor:pointer;padding:4px 8px;border:1px solid #e2e8f0;border-radius:4px;background:#f8fafc;">
                                    <input type="checkbox" id="wdSun" value="0" onchange="saveWorkingDays()" style="accent-color:#1B3B6F;"> Sun</label>
                                <label style="display:flex;align-items:center;gap:4px;font-size:0.82rem;cursor:pointer;padding:4px 8px;border:1px solid #D4AF37;border-radius:4px;background:#fffbeb;">
                                    <input type="checkbox" id="wdMon" value="1" checked onchange="saveWorkingDays()" style="accent-color:#1B3B6F;"> Mon</label>
                                <label style="display:flex;align-items:center;gap:4px;font-size:0.82rem;cursor:pointer;padding:4px 8px;border:1px solid #D4AF37;border-radius:4px;background:#fffbeb;">
                                    <input type="checkbox" id="wdTue" value="2" checked onchange="saveWorkingDays()" style="accent-color:#1B3B6F;"> Tue</label>
                                <label style="display:flex;align-items:center;gap:4px;font-size:0.82rem;cursor:pointer;padding:4px 8px;border:1px solid #D4AF37;border-radius:4px;background:#fffbeb;">
                                    <input type="checkbox" id="wdWed" value="3" checked onchange="saveWorkingDays()" style="accent-color:#1B3B6F;"> Wed</label>
                                <label style="display:flex;align-items:center;gap:4px;font-size:0.82rem;cursor:pointer;padding:4px 8px;border:1px solid #D4AF37;border-radius:4px;background:#fffbeb;">
                                    <input type="checkbox" id="wdThu" value="4" checked onchange="saveWorkingDays()" style="accent-color:#1B3B6F;"> Thu</label>
                                <label style="display:flex;align-items:center;gap:4px;font-size:0.82rem;cursor:pointer;padding:4px 8px;border:1px solid #D4AF37;border-radius:4px;background:#fffbeb;">
                                    <input type="checkbox" id="wdFri" value="5" checked onchange="saveWorkingDays()" style="accent-color:#1B3B6F;"> Fri</label>
                                <label style="display:flex;align-items:center;gap:4px;font-size:0.82rem;cursor:pointer;padding:4px 8px;border:1px solid #D4AF37;border-radius:4px;background:#fffbeb;">
                                    <input type="checkbox" id="wdSat" value="6" checked onchange="saveWorkingDays()" style="accent-color:#1B3B6F;"> Sat</label>
                            </div>
                            <div id="workingDaySummary" style="font-size:0.78rem;color:#64748b;margin-top:6px;">6 days/week (Mon‚ÄìSat)</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Working Hours per Day</label>
                            <input type="number" class="form-input" id="hoursPerDay" value="8" style="max-width: 150px;" onchange="saveCalendar()">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-header">2. MONSOON PERIOD</div>
                        <div class="form-group">
                            <label class="form-label">Monsoon (No Work Period)</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <input type="date" class="form-input" id="monsoonStart" value="2025-07-15" onchange="saveCalendar()">
                                <input type="date" class="form-input" id="monsoonEnd" value="2025-08-15" onchange="saveCalendar()">
                            </div>
                            <div style="margin-top: 10px; padding: 10px; background: rgba(239, 68, 68, 0.05); border-radius: 4px;">
                                <strong>‚ö†Ô∏è Monsoon:</strong> 15 July - 15 August 2025 (32 days no work)
                            </div>
                        </div>
                    </div>
                    
                    <!-- FIX-GAP04: Working Days selector -->
                    <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:16px;">
                        <label class="form-label" style="font-weight:700;margin-bottom:10px;display:block;">üìÖ Working Days per Week</label>
                        <div id="workingDaysSelector" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;"></div>
                        <p style="font-size:0.75rem;color:#94a3b8;margin:0;">Affects all WBS start/finish date calculations. Default: Mon‚ÄìSat (6 days/week).</p>
                    </div>
                    <button class="btn btn-primary" style="margin-top: 20px;" onclick="saveCalendar()">üíæ Save Calendar</button>

                    <!-- U-04: Holiday Management -->
                    <div style="background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:20px;margin-top:20px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                            <h4 style="margin:0;color:#1B3B6F;font-size:1rem;">üìÖ Public Holidays & Project Shutdowns</h4>
                            <button onclick="addHolidayRow()" style="padding:6px 14px;background:#1B3B6F;color:white;border:none;border-radius:6px;font-size:0.82rem;cursor:pointer;font-weight:600;">+ Add Holiday</button>
                        </div>
                        <table style="width:100%;border-collapse:collapse;font-size:0.85rem;" id="holidayTable">
                            <thead>
                                <tr style="background:#EBF0FA;">
                                    <th style="padding:8px 12px;text-align:left;color:#1B3B6F;font-weight:700;border-bottom:2px solid #1B3B6F;">Date</th>
                                    <th style="padding:8px 12px;text-align:left;color:#1B3B6F;font-weight:700;border-bottom:2px solid #1B3B6F;">Description</th>
                                    <th style="padding:8px 12px;text-align:center;color:#1B3B6F;font-weight:700;border-bottom:2px solid #1B3B6F;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="holidayTableBody">
                                <!-- Populated by renderHolidayTable() -->
                            </tbody>
                        </table>
                        <p style="font-size:0.78rem;color:#94a3b8;margin:8px 0 0 0;">Holidays are excluded from working-day schedule calculations.</p>
                    </div>

                    
                    <!-- SECTION 3: SHIFT CONFIGURATION -->
                    <div style="background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:20px;margin-top:20px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                            <h4 style="margin:0;color:#1B3B6F;font-size:1rem;">‚è±Ô∏è Shift Configuration</h4>
                            <span style="font-size:0.75rem;color:#64748b;">Default applies to all activities ‚Äî override per activity below</span>
                        </div>

                        <!-- Default shift selector -->
                        <div style="margin-bottom:18px;">
                            <label style="display:block;font-size:0.78rem;font-weight:700;color:#374151;margin-bottom:10px;text-transform:uppercase;letter-spacing:0.05em;">PROJECT DEFAULT SHIFT</label>
                            <div style="display:flex;gap:10px;flex-wrap:wrap;">
                                <label id="shiftLbl_single" style="display:flex;align-items:center;gap:8px;padding:10px 16px;border:2px solid #D4AF37;border-radius:8px;cursor:pointer;background:#fffbeb;font-size:0.84rem;font-weight:600;">
                                    <input type="radio" name="defaultShift" value="single" onchange="saveShiftConfig()" style="accent-color:#1B3B6F;"> üåÖ Single Shift &nbsp;<span style="color:#64748b;font-weight:400;">(8 hrs/day)</span>
                                </label>
                                <label id="shiftLbl_double" style="display:flex;align-items:center;gap:8px;padding:10px 16px;border:2px solid #e2e8f0;border-radius:8px;cursor:pointer;background:#f8fafc;font-size:0.84rem;font-weight:600;">
                                    <input type="radio" name="defaultShift" value="double" onchange="saveShiftConfig()" style="accent-color:#1B3B6F;"> üåô Double Shift &nbsp;<span style="color:#64748b;font-weight:400;">(16 hrs/day)</span>
                                </label>
                                <label id="shiftLbl_triple" style="display:flex;align-items:center;gap:8px;padding:10px 16px;border:2px solid #e2e8f0;border-radius:8px;cursor:pointer;background:#f8fafc;font-size:0.84rem;font-weight:600;">
                                    <input type="radio" name="defaultShift" value="triple" onchange="saveShiftConfig()" style="accent-color:#1B3B6F;"> üîÑ Round the Clock &nbsp;<span style="color:#64748b;font-weight:400;">(24 hrs/day)</span>
                                </label>
                            </div>
                            <div id="shiftHoursDisplay" style="margin-top:10px;padding:8px 14px;background:#eff6ff;border-radius:6px;font-size:0.82rem;color:#1e40af;font-weight:600;display:inline-block;">
                                ‚è±Ô∏è Effective working hours: <span id="shiftHrsValue">8</span> hrs/day
                            </div>
                        </div>

                        <!-- Activity-level overrides -->
                        <div>
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                                <label style="font-size:0.78rem;font-weight:700;color:#374151;text-transform:uppercase;letter-spacing:0.05em;">ACTIVITY-LEVEL OVERRIDES <span style="color:#64748b;font-weight:400;font-size:0.72rem;text-transform:none;">(EOT Audit Trail)</span></label>
                                <button onclick="addShiftOverride()" style="padding:5px 12px;background:#1B3B6F;color:white;border:none;border-radius:5px;font-size:0.76rem;cursor:pointer;font-weight:600;">+ Add Override</button>
                            </div>
                            <div id="shiftOverrideList" style="display:flex;flex-direction:column;gap:8px;">
                                <div style="padding:10px 14px;background:#f8fafc;border:1px dashed #cbd5e1;border-radius:6px;text-align:center;color:#94a3b8;font-size:0.8rem;" id="shiftOverrideEmpty">
                                    No activity overrides. All activities use the project default shift.
                                </div>
                            </div>
                            <div style="margin-top:10px;padding:8px 12px;background:#fef9c3;border-radius:6px;font-size:0.76rem;color:#92400e;">
                                ‚öñÔ∏è Override reasons are automatically included in Extension of Time (EOT) claim documentation.
                            </div>
                        </div>
                    </div>

<div style="height:70px;"></div><!-- Sticky Nav Footer -->
                    <div style="position:sticky;bottom:0;background:#1B3B6F;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;border-top:3px solid #D4AF37;z-index:20;margin-top:auto;">
                        <button onclick="switchMainTab(3)" style="padding:8px 20px;background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:6px;font-weight:600;font-size:0.85rem;cursor:pointer;">‚Üê Previous</button>
                        <span style="font-size:0.8rem;color:rgba(255,255,255,0.6);font-weight:500;">Step 5 of 6 ¬∑ Calendar</span>
                        <button onclick="switchMainTab(5)" style="padding:8px 20px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:6px;font-weight:700;font-size:0.85rem;cursor:pointer;">Next: Resources ‚Üí</button>
                    </div>
                </div>
            </div>
            
            <!-- TAB 6: RESOURCES (3 SUB-TABS: P&M / MANPOWER / MATERIALS) -->
            <div class="tab-panel" id="tab6" style="overflow-y:auto;overflow-x:hidden;">
                <div class="tabular-container">

                    <!-- HEADER -->
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <h3 style="margin:0;color:var(--primary-navy);">üë∑ Resources Management</h3>
                            <span id="resCoverageLabel" style="margin-left:14px;font-size:0.78rem;padding:3px 10px;border-radius:12px;background:#dcfce7;color:#15803d;font-weight:600;display:none;"></span>
                        </div>
                        <div class="toolbar-right">
                            <button onclick="toggleProductivityGap()" style="padding:6px 14px;background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe;border-radius:5px;font-size:0.78rem;cursor:pointer;font-weight:600;">üìä Productivity Gap</button>
                            <button onclick="saveResources()" style="padding:6px 14px;background:#1B3B6F;color:white;border:none;border-radius:5px;font-size:0.78rem;cursor:pointer;font-weight:600;margin-left:6px;">üíæ Save Resources</button>
                        </div>
                    </div>

                    <!-- PRODUCTIVITY GAP PANEL (collapsible) -->
                    <div id="productivityGapPanel" style="display:none;margin:0 0 4px;padding:14px 20px;background:#fff7ed;border-bottom:2px solid #fed7aa;">
                        <div style="font-size:0.8rem;font-weight:700;color:#9a3412;margin-bottom:10px;">üìä PRODUCTIVITY GAP ANALYSIS ‚Äî Rated vs Available vs Actual</div>
                        <div style="overflow-x:auto;">
                            <table style="width:100%;border-collapse:collapse;font-size:0.78rem;">
                                <thead>
                                    <tr style="background:#1B3B6F;color:white;">
                                        <th style="padding:7px 10px;text-align:left;">Equipment</th>
                                        <th style="padding:7px 10px;text-align:center;">Rated /hr</th>
                                        <th style="padding:7px 10px;text-align:center;">Available /hr</th>
                                        <th style="padding:7px 10px;text-align:center;">Actual /hr</th>
                                        <th style="padding:7px 10px;text-align:center;">Gap</th>
                                        <th style="padding:7px 10px;text-align:center;">Schedule Impact</th>
                                    </tr>
                                </thead>
                                <tbody id="gapTableBody">
                                    <tr><td colspan="6" style="padding:12px;text-align:center;color:#94a3b8;">No productivity data recorded yet. Record progress to see gap analysis.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- SUB-TAB BAR -->
                    <div style="display:flex;border-bottom:2px solid #e2e8f0;background:white;padding:0 16px;">
                        <button class="res-tab-btn active" onclick="switchResTab(0)" id="resTabBtn0" style="padding:10px 18px;border:none;background:none;cursor:pointer;font-size:0.82rem;font-weight:700;color:#1B3B6F;border-bottom:3px solid #1B3B6F;margin-bottom:-2px;">üöú Plant &amp; Machinery</button>
                        <button class="res-tab-btn" onclick="switchResTab(1)" id="resTabBtn1" style="padding:10px 18px;border:none;background:none;cursor:pointer;font-size:0.82rem;font-weight:600;color:#64748b;border-bottom:3px solid transparent;margin-bottom:-2px;">üë∑ Manpower</button>
                        <button class="res-tab-btn" onclick="switchResTab(2)" id="resTabBtn2" style="padding:10px 18px;border:none;background:none;cursor:pointer;font-size:0.82rem;font-weight:600;color:#64748b;border-bottom:3px solid transparent;margin-bottom:-2px;">ü™® Materials</button>
                    </div>

                    <!-- SCROLLABLE CONTENT -->
                    <div style="flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:0;">

                        <!-- ‚ïê‚ïê PLANT & MACHINERY ‚ïê‚ïê -->
                        <div id="resPanel0" style="display:block;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                <div style="font-size:0.82rem;color:#64748b;">Productivity per hour ‚Äî system calculates daily output from shift hours √ó units deployed</div>
                                <button onclick="addEquipmentNew()" style="padding:6px 16px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:5px;font-size:0.8rem;font-weight:700;cursor:pointer;">+ Add Equipment</button>
                            </div>

                            <!-- Coverage warnings -->
                            <div id="resCoverageWarnings" style="display:none;margin-bottom:12px;padding:10px 14px;background:#fef2f2;border:1px solid #fecaca;border-radius:6px;">
                                <div style="font-size:0.78rem;font-weight:700;color:#dc2626;margin-bottom:6px;">‚ö†Ô∏è Resource Coverage Gaps:</div>
                                <div id="resCoverageWarningsBody" style="font-size:0.76rem;color:#b91c1c;line-height:1.8;"></div>
                            </div>

                            <!-- Equipment table -->
                            <div style="overflow-x:auto;border:1px solid #e2e8f0;border-radius:8px;">
                                <table style="width:100%;border-collapse:collapse;font-size:0.8rem;">
                                    <thead>
                                        <tr style="background:#1B3B6F;color:white;">
                                            <th style="padding:9px 12px;text-align:left;min-width:140px;">Equipment</th>
                                            <th style="padding:9px 10px;text-align:center;min-width:110px;">Rated /hr<br><span style="font-size:0.68rem;opacity:0.7;">(spec sheet)</span></th>
                                            <th style="padding:9px 10px;text-align:center;min-width:120px;">Available /hr<br><span style="font-size:0.68rem;opacity:0.7;">(site-derated)</span></th>
                                            <th style="padding:9px 10px;text-align:center;min-width:90px;">Unit</th>
                                            <th style="padding:9px 10px;text-align:center;min-width:80px;">Shift</th>
                                            <th style="padding:9px 10px;text-align:center;min-width:70px;">Units<br>Deployed</th>
                                            <th style="padding:9px 10px;text-align:center;min-width:110px;">Daily Output<br><span style="font-size:0.68rem;opacity:0.7;">(auto-calc)</span></th>
                                            <th style="padding:9px 10px;text-align:left;min-width:160px;">Activity Keywords</th>
                                            <th style="padding:9px 10px;text-align:center;min-width:60px;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="equipmentTableNew">
                                        <tr id="equipEmptyRow"><td colspan="9" style="padding:20px;text-align:center;color:#94a3b8;font-size:0.82rem;">No equipment defined. Click + Add Equipment to start.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div style="margin-top:8px;font-size:0.73rem;color:#64748b;">
                                Daily Output = Available /hr √ó Shift Hours √ó Units Deployed &nbsp;|&nbsp; Actual productivity recorded in Progress Tracking
                            </div>
                        </div>

                        <!-- ‚ïê‚ïê MANPOWER ‚ïê‚ïê -->
                        <div id="resPanel1" style="display:none;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                <div style="font-size:0.82rem;color:#64748b;">Productivity per day ‚Äî direct daily output per gang (no hour conversion needed)</div>
                                <button onclick="addManpowerNew()" style="padding:6px 16px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:5px;font-size:0.8rem;font-weight:700;cursor:pointer;">+ Add Labour Type</button>
                            </div>
                            <div style="overflow-x:auto;border:1px solid #e2e8f0;border-radius:8px;">
                                <table style="width:100%;border-collapse:collapse;font-size:0.8rem;">
                                    <thead>
                                        <tr style="background:#1B3B6F;color:white;">
                                            <th style="padding:9px 12px;text-align:left;min-width:150px;">Labour Type / Gang</th>
                                            <th style="padding:9px 10px;text-align:center;min-width:120px;">Rated Output/day<br><span style="font-size:0.68rem;opacity:0.7;">(norms)</span></th>
                                            <th style="padding:9px 10px;text-align:center;min-width:130px;">Available Output/day<br><span style="font-size:0.68rem;opacity:0.7;">(site condition)</span></th>
                                            <th style="padding:9px 10px;text-align:center;min-width:90px;">Unit</th>
                                            <th style="padding:9px 10px;text-align:center;min-width:70px;">Gangs<br>Deployed</th>
                                            <th style="padding:9px 10px;text-align:center;min-width:110px;">Daily Output<br><span style="font-size:0.68rem;opacity:0.7;">(auto-calc)</span></th>
                                            <th style="padding:9px 10px;text-align:left;min-width:160px;">Activity Keywords</th>
                                            <th style="padding:9px 10px;text-align:center;min-width:60px;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="manpowerTableNew">
                                        <tr id="mpEmptyRow"><td colspan="8" style="padding:20px;text-align:center;color:#94a3b8;font-size:0.82rem;">No labour types defined. Click + Add Labour Type to start.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div style="margin-top:8px;font-size:0.73rem;color:#64748b;">
                                Daily Output = Available Output/day √ó Gangs Deployed &nbsp;|&nbsp; Enter gang sizes and norms from MoRTH schedule of rates
                            </div>
                        </div>

                        <!-- ‚ïê‚ïê MATERIALS ‚ïê‚ïê -->
                        <div id="resPanel2" style="display:none;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                <div style="font-size:0.82rem;color:#64748b;">Materials are demand-driven ‚Äî quantities calculated from WBS. Define density for volume-to-weight conversion.</div>
                                <button onclick="addMaterialNew()" style="padding:6px 16px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:5px;font-size:0.8rem;font-weight:700;cursor:pointer;">+ Add Material</button>
                            </div>
                            <div style="overflow-x:auto;border:1px solid #e2e8f0;border-radius:8px;">
                                <table style="width:100%;border-collapse:collapse;font-size:0.8rem;">
                                    <thead>
                                        <tr style="background:#1B3B6F;color:white;">
                                            <th style="padding:9px 12px;text-align:left;min-width:150px;">Material</th>
                                            <th style="padding:9px 10px;text-align:center;min-width:100px;">Unit</th>
                                            <th style="padding:9px 10px;text-align:center;min-width:120px;">Density (MT/m¬≥)<br><span style="font-size:0.68rem;opacity:0.7;">(for vol‚Üíweight)</span></th>
                                            <th style="padding:9px 10px;text-align:center;min-width:120px;">Supply Rate<br><span style="font-size:0.68rem;opacity:0.7;">(m¬≥ or MT/day max)</span></th>
                                            <th style="padding:9px 10px;text-align:left;min-width:150px;">Source / Quarry</th>
                                            <th style="padding:9px 10px;text-align:left;min-width:160px;">Linked Layers</th>
                                            <th style="padding:9px 10px;text-align:center;min-width:60px;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="materialTableNew">
                                        <tr id="matEmptyRow"><td colspan="7" style="padding:20px;text-align:center;color:#94a3b8;font-size:0.82rem;">No materials defined. Click + Add Material to start.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div style="margin-top:8px;font-size:0.73rem;color:#64748b;">
                                Monthly demand calculated automatically from baseline freeze. Supply plan compared monthly for procurement alerts.
                            </div>
                        </div>

                    </div><!-- end scrollable -->

                    <!-- STEP BAR -->
                    <div style="height:70px;"></div><!-- Sticky Nav Footer -->
                    <div style="position:sticky;bottom:0;background:#1B3B6F;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;border-top:3px solid #D4AF37;z-index:20;">
                        <button onclick="switchMainTab(5)" style="padding:8px 20px;background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:6px;font-weight:700;font-size:0.85rem;cursor:pointer;">‚Üê Previous</button>
                        <span style="font-size:0.8rem;color:rgba(255,255,255,0.6);font-weight:500;">Step 6 of 6 ¬∑ Resources</span>
                        <button onclick="switchMainTab(7)" style="padding:8px 20px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:6px;font-weight:700;font-size:0.85rem;cursor:pointer;">Next: Activity Grid ‚Üí</button>
                    </div>

                </div>
            </div>
            
            <!-- TAB 7 (NEW): BOQ -->
            <div id="tab7boq" style="display:none;height:100%;flex-direction:column;overflow:hidden;">

                <!-- TOP BAR -->
                <div style="background:var(--navy);padding:10px 18px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;gap:12px;flex-wrap:wrap;">
                    <div style="display:flex;align-items:center;gap:14px;">
                        <div style="color:var(--accent-gold);font-weight:700;font-size:1rem;">üí∞ Bill of Quantities</div>
                        <div id="boqContractBadge" style="background:rgba(212,175,55,0.2);border:1px solid var(--accent-gold);border-radius:4px;padding:3px 10px;font-size:0.75rem;color:var(--accent-gold);font-weight:600;">Contract: ‚Äî</div>
                        <div id="boqItemsBadge" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:4px;padding:3px 10px;font-size:0.75rem;color:#fff;">0 items</div>
                        <div id="boqStatusBadge" style="border:1px solid rgba(255,255,255,0.2);border-radius:4px;padding:3px 10px;font-size:0.75rem;color:#fff;">DRAFT</div>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <button onclick="boqUploadExcel()" style="background:rgba(255,255,255,0.12);color:#fff;border:1px solid rgba(255,255,255,0.25);padding:6px 14px;border-radius:5px;font-size:0.78rem;cursor:pointer;font-weight:600;">üì• Upload Excel</button>
                        <button onclick="boqAddMiscItem()" style="background:rgba(255,255,255,0.12);color:#fff;border:1px solid rgba(255,255,255,0.25);padding:6px 14px;border-radius:5px;font-size:0.78rem;cursor:pointer;font-weight:600;">+ Add Item</button>
                        <button id="boqFreezeBtn" onclick="boqFreezeAll()" style="background:var(--accent-gold);color:#1B3B6F;border:none;padding:6px 16px;border-radius:5px;font-size:0.78rem;cursor:pointer;font-weight:700;">üîí Freeze BOQ & Generate WBS</button>
                    </div>
                </div>

                <!-- FROZEN NOTICE -->
                <div id="boqFrozenNotice" style="display:none;background:#f0fdf4;border-bottom:2px solid #16a34a;padding:8px 18px;font-size:0.78rem;color:#15803d;font-weight:600;flex-shrink:0;">
                    üîí BOQ is frozen ‚Äî WBS activities generated in Activity Grid.
                    <button onclick="boqUnfreeze()" style="margin-left:12px;background:none;border:1px solid #15803d;color:#15803d;padding:3px 10px;border-radius:4px;font-size:0.74rem;cursor:pointer;font-weight:600;">üîì Unfreeze</button>
                </div>

                <!-- CONTENT -->
                <div style="flex:1;overflow-y:auto;padding:16px 18px;" id="boqContent">
                    <div id="boqEmptyNotice" style="display:none;text-align:center;padding:60px 20px;">
                        <div style="font-size:2.5rem;margin-bottom:12px;">üìã</div>
                        <div style="font-size:1rem;font-weight:700;color:var(--navy);margin-bottom:6px;">No frozen TCS or Structures yet</div>
                        <div style="font-size:0.82rem;color:var(--text-secondary);max-width:420px;margin:0 auto;">
                            Freeze your TCS and Structures first ‚Äî they will appear here as BOQ sections ready for quantity entry.
                        </div>
                    </div>
                    <div id="boqSections"></div>
                    <div id="boqGrandTotal" style="display:none;margin-top:20px;background:var(--navy);border-radius:8px;padding:14px 18px;">
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:16px;text-align:center;">
                            <div><div style="font-size:0.67rem;font-weight:700;text-transform:uppercase;color:rgba(255,255,255,0.6);margin-bottom:4px;">Contract Total</div><div id="gtContractValue" style="font-size:1.1rem;font-weight:700;color:var(--accent-gold);">‚Çπ0</div></div>
                            <div><div style="font-size:0.67rem;font-weight:700;text-transform:uppercase;color:rgba(255,255,255,0.6);margin-bottom:4px;">Road Works</div><div id="gtRoadValue" style="font-size:1.1rem;font-weight:700;color:#60a5fa;">‚Çπ0</div></div>
                            <div><div style="font-size:0.67rem;font-weight:700;text-transform:uppercase;color:rgba(255,255,255,0.6);margin-bottom:4px;">Structures</div><div id="gtStructValue" style="font-size:1.1rem;font-weight:700;color:#a78bfa;">‚Çπ0</div></div>
                            <div><div style="font-size:0.67rem;font-weight:700;text-transform:uppercase;color:rgba(255,255,255,0.6);margin-bottom:4px;">Miscellaneous</div><div id="gtMiscValue" style="font-size:1.1rem;font-weight:700;color:#34d399;">‚Çπ0</div></div>
                        </div>
                    </div>
                </div>
                <input type="file" id="boqExcelInput" accept=".xlsx,.xls,.csv" style="display:none;" onchange="boqProcessExcelFile(this)">
            </div>

<!-- TAB 8: ACTIVITY GRID -->
            <div class="tab-panel" id="tab8" style="overflow-y:auto;overflow-x:hidden;">
                <div class="tabular-container">
                    
                    <!-- Top Toolbar -->
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <h3 style="margin: 0; color: #1B3B6F;">üìä Activity Grid</h3>
                            <div id="wbsSummaryBar" style="margin-left: 14px; font-size: 0.78rem; display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                                <span id="statWorkable"  style="background:#dcfce7;color:#166534;padding:3px 10px;border-radius:20px;font-weight:600;border:1px solid #bbf7d0;">‚è≥ Loading‚Ä¶</span>
                                <span id="statStructures" style="background:#dbeafe;color:#1e40af;padding:3px 10px;border-radius:20px;font-weight:600;border:1px solid #bfdbfe;"></span>
                                <span id="statBlocked"    style="background:#fee2e2;color:#991b1b;padding:3px 10px;border-radius:20px;font-weight:600;border:1px solid #fecaca;"></span>
                                <span style="color:#cbd5e1;">|</span>
                                <span id="statActivities" style="background:#f1f5f9;color:#334155;padding:3px 10px;border-radius:20px;font-weight:600;border:1px solid #e2e8f0;"></span>
                                <span id="statCritical"   style="background:#fef2f2;color:#dc2626;padding:3px 10px;border-radius:20px;font-weight:600;border:1px solid #fecaca;"></span>
                                <span id="statCost"       style="background:#fffbeb;color:#92400e;padding:3px 10px;border-radius:20px;font-weight:600;border:1px solid #fde68a;"></span>
                            </div>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-success btn-sm" onclick="KALYANTRA.render.wbsTable()">üîÑ Refresh WBS</button>
                            <button class="btn btn-primary btn-sm" onclick="const m=document.getElementById('addModal'); if(m){m.style.display='flex';}else{showToast('‚ûï Use the + button in WBS toolbar', 'info')}">+ Add</button>
                            <button class="btn btn-secondary btn-sm btn-v7" onclick="showToast('‚öôÔ∏è Settings panel coming in V7.0', 'info')">‚öôÔ∏è Settings</button>
                        </div>
                    </div>
                    
                    <!-- Child Tab Navigation -->
                    <div style="background: white; border-bottom: 2px solid #e5e7eb; display: flex; gap: 2px; padding: 0 20px;">
                        <button onclick="switchTab7Child(0)" id="tab7child0" style="padding: 14px 20px; border: none; background: #1B3B6F; color: white; font-weight: 600; font-size: 0.9375rem; cursor: pointer; border-bottom: 3px solid #D4AF37; transition: all 0.2s;">
                            üìã WBS Structure
                        </button>
                        <button onclick="switchTab7Child(1)" id="tab7child1" style="padding: 14px 20px; border: none; background: transparent; color: #64748b; font-weight: 600; font-size: 0.9375rem; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s;">
                            üìù Activities
                        </button>
                        <button onclick="switchTab7Child(2)" id="tab7child2" style="padding: 14px 20px; border: none; background: transparent; color: #64748b; font-weight: 600; font-size: 0.9375rem; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s;">
                            üìä Gantt Chart
                        </button>
                        <button onclick="switchTab7Child(3)" id="tab7child3" style="padding: 14px 20px; border: none; background: transparent; color: #64748b; font-weight: 600; font-size: 0.9375rem; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s;">
                            üìç Linear Diagram
                        </button>
                    </div>
                    
                    <!-- Content Container -->
                    <div style="position: relative; height: calc(100vh - 340px); overflow: hidden;">
                        
                        <!-- Child Tab 0: WBS Structure -->
                        <div id="tab7content0" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; overflow: hidden;">
                            <div style="padding: 12px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; gap: 10px;">
                                <button onclick="expandAllWBS()" style="padding: 6px 12px; background: white; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.875rem; cursor: pointer;">‚ñº Expand All</button>
                                <button onclick="collapseAllWBS()" style="padding: 6px 12px; background: white; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.875rem; cursor: pointer;">‚ñ∂ Collapse All</button>
                                <span id="wbsStatBar" style="margin-left: auto; font-size: 0.875rem; color: #64748b;"></span>
                            </div>
                            
                            <div style="flex: 1; overflow: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                    <thead style="position: sticky; top: 0; background: #f1f5f9; z-index: 10;">
                                        <tr>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; width: 40px;"></th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; width: 70px;">WBS</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1;">Name</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; width: 100px;">Duration</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; width: 100px;">Start</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; width: 100px;">Finish</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; width: 80px;">Tasks</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; width: 120px;">Status</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; width: 100px;">Cost</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; width: 100px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="wbsBody">
                                        <tr><td colspan="10" style="text-align:center;padding:30px;color:#64748b;font-style:italic;">üîÑ Loading WBS from your data...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Child Tab 1: Activities -->
                        <div id="tab7content1" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: none; flex-direction: column; overflow: hidden; background: white;">
                            <div style="padding: 12px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                                <span style="font-weight: 500; font-size: 0.875rem;">Filter by WBS:</span>
                                <select id="activityFilter" onchange="filterActivities()" style="margin-left: 10px; padding: 6px 12px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.875rem;">
                                    <option value="all">All Activities</option>
                                </select>
                                <span style="margin-left: auto; float: right; font-size: 0.875rem; color: #64748b;">Showing <strong id="activityCount">10</strong> activities</span>
                            </div>
                            <div style="flex: 1; overflow: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                    <thead style="position: sticky; top: 0; background: #1B3B6F; z-index: 10;">
                                        <tr>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #D4AF37; color: white; width: 80px;">ID</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #D4AF37; color: white;">Activity Name</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #D4AF37; color: white;">WBS Item</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #D4AF37; color: white; width: 80px;">Qty</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #D4AF37; color: white; width: 60px;">Unit</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #D4AF37; color: white; width: 60px;">Dur</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #D4AF37; color: white; width: 100px;">Start</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #D4AF37; color: white; width: 100px;">Finish</th>
                                            <th style="padding: 10px; text-align: center; font-weight: 700; border-bottom: 2px solid #D4AF37; color: #D4AF37; width: 110px;">% Done</th>
                                        </tr>
                                    </thead>
                                    <tbody id="activitiesBody"><tr><td colspan="8" style="padding: 20px; text-align: center; color: #94a3b8; font-style: italic;">üîÑ Click Activity Grid in sidebar or navigate here from WBS to load activities...</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Child Tab 2: ULTIMATE GANTT CHART -->
                        <div id="tab7content2" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: none; flex-direction: column; overflow: hidden; background: white;">
                            
                            <!-- Gantt Controls -->
                            <div style="padding: 10px 16px; background: #f8fafc; border-bottom: 2px solid #e5e7eb; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                <button onclick="ganttZoomIn()" style="padding: 6px 12px; background: white; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.8125rem; cursor: pointer;">üîç+ Zoom In</button>
                                <button onclick="ganttZoomOut()" style="padding: 6px 12px; background: white; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.8125rem; cursor: pointer;">üîç- Zoom Out</button>
                                <button onclick="ganttFit()" style="padding: 6px 12px; background: white; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.8125rem; cursor: pointer;">‚õ∂ Fit</button>
                                <div style="width: 1px; height: 20px; background: #cbd5e1; margin: 0 4px;"></div>
                                <button id="ganttCriticalBtn" onclick="ganttToggleCritical()" style="padding: 6px 12px; background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; border-radius: 6px; font-size: 0.8125rem; cursor: pointer; font-weight: 600;">üî¥ Critical Path</button>
                                <button id="execModeBtn" onclick="toggleExecutionMode()" style="padding:6px 12px;background:#EBF0FA;color:#1B3B6F;border:1px solid #1B3B6F;border-radius:6px;font-size:0.8125rem;cursor:pointer;font-weight:600;" title="Sequential: one stretch after another | Parallel: all stretches start together">‚ö° Sequential</button>
                                <span id="ganttZoomLabel" style="margin-left: auto; font-size: 0.8125rem; color: #64748b; font-weight: 600;">100%</span>
                                <button onclick="renderGantt()" style="padding: 6px 14px; background: #1B3B6F; color: white; border: none; border-radius: 6px; font-size: 0.8125rem; cursor: pointer; font-weight: 600;">üîÑ Refresh Gantt</button>
                            </div>
                            
                            <!-- Gantt Split View -->
                            <div style="flex: 1; display: flex; overflow: hidden;">
                                <!-- Left Panel: Activity List (fixed 300px) -->
                                <div id="ganttActivityList" style="flex: 0 0 300px; border-right: 2px solid #e5e7eb; overflow-y: auto; background: #fafbfc;"></div>
                                <!-- Right Panel: Timeline (scrollable) -->
                                <div style="flex: 1; overflow: auto; position: relative;">
                                    <div id="ganttTimeline" style="min-width: 100%;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="tab7content3" style="position:absolute;top:0;left:0;right:0;bottom:0;display:none;flex-direction:column;background:#0f172a;overflow:hidden;font-family:'Segoe UI',system-ui,sans-serif;">

                            <!-- ‚îÄ‚îÄ LSM Toolbar ‚îÄ‚îÄ -->
                            <div style="flex:0 0 auto;background:#1e293b;border-bottom:1px solid #334155;padding:10px 16px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                                <div style="display:flex;gap:4px;background:#0f172a;border-radius:6px;padding:3px;">
                                    <button onclick="lsmZoomIn()" style="padding:5px 10px;background:transparent;border:none;color:#94a3b8;border-radius:4px;font-size:0.8rem;cursor:pointer;transition:all 0.15s;" onmouseenter="this.style.background='#334155';this.style.color='#f1f5f9'" onmouseleave="this.style.background='transparent';this.style.color='#94a3b8'">üîç+ Zoom In</button>
                                    <button onclick="lsmZoomOut()" style="padding:5px 10px;background:transparent;border:none;color:#94a3b8;border-radius:4px;font-size:0.8rem;cursor:pointer;transition:all 0.15s;" onmouseenter="this.style.background='#334155';this.style.color='#f1f5f9'" onmouseleave="this.style.background='transparent';this.style.color='#94a3b8'">üîç‚àí Zoom Out</button>
                                    <button onclick="lsmResetView()" style="padding:5px 10px;background:transparent;border:none;color:#94a3b8;border-radius:4px;font-size:0.8rem;cursor:pointer;transition:all 0.15s;" onmouseenter="this.style.background='#334155';this.style.color='#f1f5f9'" onmouseleave="this.style.background='transparent';this.style.color='#94a3b8'">‚õ∂ Reset</button>
                                </div>
                                <div style="width:1px;height:24px;background:#334155;"></div>
                                <button id="lsmBtnCritical" onclick="lsmToggleCritical()" style="padding:5px 12px;background:#7f1d1d;border:1px solid #dc2626;color:#fca5a5;border-radius:5px;font-size:0.78rem;cursor:pointer;font-weight:600;">‚óè Critical Path</button>
                                <button id="lsmBtnStructures" onclick="lsmToggleStructures()" style="padding:5px 12px;background:#1e3a5f;border:1px solid #3b82f6;color:#93c5fd;border-radius:5px;font-size:0.78rem;cursor:pointer;font-weight:600;">‚¨° Structures</button>
                                <button id="lsmBtnHindrances" onclick="lsmToggleHindrances()" style="padding:5px 12px;background:#3b1111;border:1px solid #f97316;color:#fdba74;border-radius:5px;font-size:0.78rem;cursor:pointer;font-weight:600;">‚ö† Hindrances</button>
                                <div style="flex:1;"></div>
                                <div style="display:flex;align-items:center;gap:12px;font-size:0.72rem;color:#64748b;">
                                    <span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:20px;height:3px;background:#22c55e;border-radius:2px;"></span>Earthwork</span>
                                    <span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:20px;height:3px;background:#a78bfa;border-radius:2px;"></span>Sub-grade</span>
                                    <span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:20px;height:3px;background:#fbbf24;border-radius:2px;"></span>GSB</span>
                                    <span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:20px;height:3px;background:#38bdf8;border-radius:2px;"></span>WMM</span>
                                    <span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:20px;height:3px;background:#f87171;border-radius:2px;"></span>DBM</span>
                                    <span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:20px;height:3px;background:#e879f9;border-radius:2px;"></span>BC</span>
                                    <span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:10px;height:10px;border:2px solid #60a5fa;transform:rotate(45deg);background:#1e3a5f;display:inline-block;"></span>Structure</span>
                                    <span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:20px;height:10px;background:rgba(249,115,22,0.2);border:1px solid #f97316;border-radius:2px;"></span>Hindrance</span>
                                </div>
                                <span id="lsmZoomLabel" style="font-size:0.75rem;color:#64748b;font-weight:600;min-width:44px;text-align:right;">100%</span>
                            </div>

                            <!-- ‚îÄ‚îÄ Chart Area ‚îÄ‚îÄ -->
                            <div style="flex:1;display:flex;overflow:hidden;">
                                <!-- Y-axis panel (fixed left) -->
                                <div id="lsmYPanel" style="flex:0 0 90px;background:#1e293b;border-right:1px solid #334155;display:flex;flex-direction:column;overflow:hidden;">
                                    <div style="flex:0 0 44px;min-height:44px;background:#0f172a;border-bottom:1px solid #334155;display:flex;align-items:center;justify-content:center;font-size:0.65rem;font-weight:700;color:#475569;letter-spacing:0.08em;text-transform:uppercase;">CHAINAGE</div>
                                    <div id="lsmYScrollBox" style="flex:1;overflow:hidden;position:relative;">
                                        <canvas id="lsmYCanvas" style="display:block;width:90px;position:absolute;top:0;left:0;"></canvas>
                                    </div>
                                </div>
                                <!-- Main area -->
                                <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;">
                                    <!-- X-axis header -->
                                    <div id="lsmXWrapper" style="flex:0 0 44px;min-height:44px;overflow:hidden;background:#0f172a;border-bottom:1px solid #334155;">
                                        <canvas id="lsmXCanvas" style="display:block;height:44px;"></canvas>
                                    </div>
                                    <!-- Scrollable canvas area -->
                                    <div id="lsmScrollBox" style="flex:1;overflow:auto;position:relative;cursor:crosshair;">
                                        <canvas id="lsmMainCanvas" style="display:block;"></canvas>
                                        <div id="lsmTooltip" style="display:none;position:fixed;background:#1e293b;border:1px solid #475569;border-radius:8px;padding:10px 14px;font-size:0.78rem;color:#e2e8f0;pointer-events:none;z-index:9999;max-width:280px;box-shadow:0 8px 24px rgba(0,0,0,0.5);line-height:1.6;"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- ‚îÄ‚îÄ Status bar ‚îÄ‚îÄ -->
                            <div style="flex:0 0 30px;background:#0f172a;border-top:1px solid #1e293b;display:flex;align-items:center;padding:0 16px;gap:20px;">
                                <span style="font-size:0.72rem;color:#475569;">Time-Distance Diagram  ‚Ä¢  Ch 0+000 to <span id="lsmEndChLabel">42+000</span></span>
                                <span style="font-size:0.72rem;color:#475569;"><span id="lsmActivityCount">‚Äî</span> bands  ‚Ä¢  <span id="lsmStructCount">‚Äî</span> structures  ‚Ä¢  Avg <span id="lsmProductionRate">‚Äî</span> m/day</span>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>

            
            <!-- TAB 9: EXECUTIVE DASHBOARD -->
            <div class="tab-panel" id="tab9" style="overflow-y:auto;overflow-x:hidden;">
                <div class="tabular-container">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <h3 style="margin: 0; color: #1B3B6F;">üìä Executive Dashboard ‚Äî <span id="dashProjectName">Package-I | 4-Lane | 42 km | HAM</span></h3>
                            <span id="dashLastUpdated" style="margin-left: 16px; font-size: 0.875rem; color: #64748b;">Last Updated: ‚Äî</span>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-secondary btn-sm" onclick="KALYANTRA.render.dashboard()">üîÑ Refresh</button>
                            <button class="btn btn-primary btn-sm btn-v7" onclick="showToast('üìÑ PDF export ‚Äî Coming in V7.0', 'info')" style="opacity:0.55;cursor:not-allowed;" title="Coming in V7.0">üìÑ Export PDF <span style='font-size:0.65rem;background:#94a3b8;color:white;padding:1px 5px;border-radius:3px;margin-left:4px;'>V7.0</span></button>
                        </div>
                    </div>
                    
                    <div class="content-container" style="padding: 24px;">
                        
                        <!-- PLANNING HEALTH SCORE ‚Äî inserted before Top Status Cards -->
                        <div style="background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:20px;margin-bottom:20px;display:grid;grid-template-columns:200px 1fr;gap:24px;align-items:start;">
                            <!-- Score gauge -->
                            <div style="text-align:center;">
                                <div style="font-size:0.7rem;font-weight:800;text-transform:uppercase;letter-spacing:0.08em;color:#64748b;margin-bottom:8px;">Planning Health Score</div>
                                <div style="display:inline-block;width:160px;height:160px;">
                                    <canvas id="healthGauge" width="160" height="160"></canvas>
                                    <span id="healthScoreValue" style="display:none;">‚Äî</span>
                                </div>
                                <div id="healthScoreLabel" style="font-size:0.82rem;font-weight:700;margin-top:6px;color:#64748b;">Not computed</div>
                                <button onclick="computeAndDisplayHealth()" style="margin-top:8px;padding:4px 12px;background:#1B3B6F;color:white;border:none;border-radius:4px;font-size:0.74rem;cursor:pointer;">‚Üª Compute</button>
                            </div>
                            <!-- Score breakdown -->
                            <div>
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                                    <div style="font-size:0.84rem;font-weight:700;color:#1B3B6F;">Score Breakdown</div>
                                    <div id="healthLastComputed" style="font-size:0.72rem;color:#94a3b8;"></div>
                                </div>
                                <div id="healthBreakdown" style="display:flex;flex-direction:column;gap:7px;">
                                    <div style="color:#94a3b8;font-size:0.8rem;font-style:italic;">Click Compute to calculate health score</div>
                                </div>
                                <div id="healthRecommendations" style="margin-top:14px;display:none;">
                                    <div style="font-size:0.74rem;font-weight:700;color:#374151;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px;">Recommended Actions</div>
                                    <div id="healthRecoList" style="display:flex;flex-direction:column;gap:6px;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Top Status Cards -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 28px;">
                            <div style="background: white; border-radius: 8px; padding: 20px; border-left: 4px solid #22c55e; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 8px; font-weight: 500;">PROJECT STATUS</div>
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 4px;">
                                    <span id="dashStatusIcon" style="font-size: 2rem;">üü°</span>
                                    <span id="dashStatusText" style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">BEHIND SCHEDULE</span>
                                </div>
                                <div id="dashStatusSub" style="font-size: 0.8125rem; color: #475569;">Physical 40% vs expected 53.6% ‚Äî M3 at risk</div>
                            </div>
                            
                            <div style="background: white; border-radius: 8px; padding: 20px; border-left: 4px solid #f59e0b; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 8px; font-weight: 500;">SCHEDULE STATUS</div>
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 4px;">
                                    <span style="font-size: 2rem;">üü°</span>
                                    <span style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">MINOR DELAY</span>
                                </div>
                                <div style="font-size: 0.8125rem; color: #475569;">2 activities behind by 3 days</div>
                            </div>
                            
                            <div style="background: white; border-radius: 8px; padding: 20px; border-left: 4px solid #22c55e; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 8px; font-weight: 500;">COST STATUS</div>
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 4px;">
                                    <span style="font-size: 2rem;">üü¢</span>
                                    <span style="font-size: 1.5rem; font-weight: 700; color: #22c55e;">ON BUDGET</span>
                                </div>
                                <div style="font-size: 0.8125rem; color: #475569;">Within approved budget limits</div>
                            </div>
                        </div>
                        
                        <!-- Progress Metrics Row -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 28px;">
                            
                            <!-- Overall Progress -->
                            <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Key Progress Metrics</h4>
                                
                                <div style="margin-bottom: 18px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">Overall Progress</span>
                                        <span id="dashOverallPct" style="font-size: 0.875rem; font-weight: 700; color: #1e293b;">35%</span>
                                    </div>
                                    <div style="width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                        <div id="dashOverallBar" style="width: 35%; height: 100%; background: linear-gradient(to right, #3b82f6, #2563eb); border-radius: 5px; transition: width 0.6s ease;"></div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 18px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">Physical Progress</span>
                                        <span id="dashPhysicalPct" style="font-size: 0.875rem; font-weight: 700; color: #1e293b;">38%</span>
                                    </div>
                                    <div style="width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                        <div id="dashPhysicalBar" style="width: 38%; height: 100%; background: linear-gradient(to right, #22c55e, #16a34a); border-radius: 5px; transition: width 0.6s ease;"></div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 18px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">Financial Progress</span>
                                        <span id="dashFinancialPct" style="font-size: 0.875rem; font-weight: 700; color: #1e293b;">32%</span>
                                    </div>
                                    <div style="width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                        <div id="dashFinancialBar" style="width: 32%; height: 100%; background: linear-gradient(to right, #f59e0b, #d97706); border-radius: 5px; transition: width 0.6s ease;"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">Time Elapsed</span>
                                        <span id="dashTimePct" style="font-size: 0.875rem; font-weight: 700; color: #1e293b;">30%</span>
                                    </div>
                                    <div style="width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                        <div id="dashTimeBar" style="width: 54%; height: 100%; background: linear-gradient(to right, #64748b, #475569); border-radius: 5px; transition: width 0.6s ease;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Critical Alerts -->
                            <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Critical Alerts</h4>
                                
                                <div id="dashHindranceAlert" style="padding: 12px; background: #fef2f2; border-left: 4px solid #ef4444; margin-bottom: 12px; border-radius: 4px; transition: all 0.3s;">
                                    <div style="display: flex; align-items: start; gap: 10px;">
                                        <span style="font-size: 1.25rem;">üî¥</span>
                                        <div>
                                            <div id="dashHindranceCount" style="font-weight: 600; font-size: 0.875rem; color: #991b1b; margin-bottom: 4px;">1 Hindrance Blocking Work</div>
                                            <div style="font-size: 0.8125rem; color: #64748b;">Forest clearance & Railway GAD pending</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="padding: 12px; background: #fffbeb; border-left: 4px solid #f59e0b; margin-bottom: 12px; border-radius: 4px;">
                                    <div style="display: flex; align-items: start; gap: 10px;">
                                        <span style="font-size: 1.25rem;">üü°</span>
                                        <div>
                                            <div style="font-weight: 600; font-size: 0.875rem; color: #92400e; margin-bottom: 4px;">M3 Milestone At Risk (119 days)</div>
                                            <div style="font-size: 0.8125rem; color: #64748b;">75% physical required by 26-Jun-2026 ‚Äî currently 40%</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="padding: 12px; background: #f0fdf4; border-left: 4px solid #22c55e; border-radius: 4px;">
                                    <div style="display: flex; align-items: start; gap: 10px;">
                                        <span style="font-size: 1.25rem;">üü¢</span>
                                        <div>
                                            <div style="font-weight: 600; font-size: 0.875rem; color: #166534; margin-bottom: 4px;">3 Active Hindrances</div>
                                            <div style="font-size: 0.8125rem; color: #64748b;">Forest, Railway GAD, OHE shifting ‚Äî all pending</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Stats Grid -->
                        <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 28px;">
                            <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Quick Statistics</h4>
                            
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px;">
                                <div style="text-align: center; padding: 16px; background: #f8fafc; border-radius: 6px;">
                                    <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Total Activities</div>
                                    <div id="dashTotalActivities" style="font-size: 2rem; font-weight: 700; color: #1e293b;">18</div>
                                </div>
                                <div style="text-align: center; padding: 16px; background: #fef2f2; border-radius: 6px;">
                                    <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Critical Path</div>
                                    <div id="dashCriticalPath" style="font-size: 2rem; font-weight: 700; color: #dc2626;">6</div>
                                </div>
                                <div style="text-align: center; padding: 16px; background: #f0fdf4; border-radius: 6px;">
                                    <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Completed</div>
                                    <div id="dashCompleted" style="font-size: 2rem; font-weight: 700; color: #22c55e;">0</div>
                                </div>
                                <div style="text-align: center; padding: 16px; background: #fffbeb; border-radius: 6px;">
                                    <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Delayed</div>
                                    <div style="font-size: 2rem; font-weight: 700; color: #f59e0b;">2</div>
                                </div>
                                <div style="text-align: center; padding: 16px; background: #f8fafc; border-radius: 6px;">
                                    <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Total Duration</div>
                                    <div id="dashTotalDuration" style="font-size: 2rem; font-weight: 700; color: #1e293b;">730d</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Work Breakdown Summary -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                            
                            <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Progress by Phase</h4>
                                
                                <div style="margin-bottom: 16px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">üü¢ Phase 1 - Immediate Work</span>
                                        <span id="dashPhase1Pct" style="font-size: 0.875rem; font-weight: 700; color: #22c55e;">45%</span>
                                    </div>
                                    <div id="dashPhase1Acts" style="font-size: 0.8125rem; color: #64748b; margin-bottom: 6px;">12 activities ‚Ä¢ 2.4 km stretch</div>
                                    <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                        <div id="dashPhase1Bar" style="width: 45%; height: 100%; background: #22c55e; border-radius: 4px; transition: width 0.6s ease;"></div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">üîµ Phase 2 - Structures</span>
                                        <span id="dashPhase2Pct" style="font-size: 0.875rem; font-weight: 700; color: #3b82f6;">25%</span>
                                    </div>
                                    <div id="dashPhase2Acts" style="font-size: 0.8125rem; color: #64748b; margin-bottom: 6px;">0 activities</div>
                                    <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                        <div id="dashPhase2Bar" style="width: 0%; height: 100%; background: #3b82f6; border-radius: 4px; transition: width 0.6s ease;"></div>
                                    </div>
                                </div>
                                <!-- L-09 Phase 3 Blocked/Hindrances -->
                                <div style="margin-top:12px;">
                                    <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                                        <span style="font-size:0.875rem;font-weight:600;color:#1e293b;">Phase 3: Blocked Zones</span>
                                        <span id="dashPhase3Pct" style="font-size:0.875rem;font-weight:700;color:#ef4444;">0%</span>
                                    </div>
                                    <div id="dashPhase3Acts" style="font-size:0.8125rem;color:#64748b;margin-bottom:6px;">0 activities</div>
                                    <div style="width:100%;height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden;">
                                        <div id="dashPhase3Bar" style="width:0%;height:100%;background:#D4AF37;border-radius:4px;transition:width 0.6s ease;"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">üî¥ Phase 3 - Blocked</span>
                                        <span style="font-size: 0.875rem; font-weight: 700; color: #ef4444;">0%</span>
                                    </div>
                                    <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 6px;">Awaiting clearance</div>
                                    <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                        <div style="width: 0%; height: 100%; background: #ef4444; border-radius: 4px;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Financial Summary</h4>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                    <div>
                                        <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 4px;">Total Budget</div>
                                        <div id="dashTotalBudget" style="font-size: 1.5rem; font-weight: 700; color: #1e293b;">‚Çπ3.7 Cr</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 4px;">Spent to Date</div>
                                        <div id="dashSpent" style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">‚Çπ1.2 Cr</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 4px;">Remaining</div>
                                        <div id="dashBalanceAmt" style="font-size: 1.5rem; font-weight: 700; color: #22c55e;">‚Çπ881.99 Cr</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 4px;">Variance</div>
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #22c55e;">+‚Çπ0.0 Cr</div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                                    <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 8px;">Budget Utilization</div>
                                    <div style="width: 100%; height: 12px; background: #e2e8f0; border-radius: 6px; overflow: hidden;">
                                        <div id="dashBudgetBar" style="width: 32%; height: 100%; background: linear-gradient(to right, #3b82f6, #2563eb); border-radius: 6px; transition: width 0.6s ease;"></div>
                                    </div>
                                    <div id="dashBudgetPct" style="text-align: right; margin-top: 4px; font-size: 0.75rem; color: #475569; font-weight: 600;">32% Utilized</div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
            
            <!-- TAB 10: PROGRESS TRACKING -->
            <div class="tab-panel" id="tab10" style="overflow-y:auto;overflow-x:hidden;">
                <div class="tabular-container">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <h3 style="margin: 0; color: #1B3B6F;">üìà Progress Tracking</h3>
                        </div>
                        <div class="toolbar-right">
                            <select class="form-select" id="progressPeriodSelect" style="margin-right: 12px;" onchange="renderProgressTab()">
                                <option>Last 30 Days</option>
                                <option>Last 60 Days</option>
                                <option>Last 90 Days</option>
                                <option>Project to Date</option>
                            </select>
                            <button class="btn btn-secondary btn-sm btn-v7" onclick="showToast('üìÑ Report export ‚Äî Coming in V7.0', 'info')" style="opacity:0.55;cursor:not-allowed;" title="Coming in V7.0">üìÑ Export Report <span style='font-size:0.65rem;background:#94a3b8;color:white;padding:1px 5px;border-radius:3px;margin-left:4px;'>V7.0</span></button>
                        </div>
                    </div>
                    
                    <div class="content-container" style="padding: 24px;">
                        
                        <!-- S-Curve Chart Placeholder -->
                        <!-- CHAINAGE-BASED PROGRESS RECORDING -->
                        <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:0;margin-bottom:20px;overflow:hidden;">
                            <div style="background:#1B3B6F;color:white;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;">
                                <div>
                                    <span style="font-weight:700;font-size:0.9rem;">üìç Record Today's Progress</span>
                                    <span style="font-size:0.73rem;opacity:0.7;margin-left:10px;" id="progressRecordDate"></span>
                                </div>
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <span style="font-size:0.76rem;opacity:0.8;">Mode:</span>
                                    <label style="display:flex;align-items:center;gap:4px;font-size:0.76rem;cursor:pointer;">
                                        <input type="radio" name="progressMode" value="chainage" checked onchange="setProgressMode('chainage')" style="accent-color:#D4AF37;"> Chainage
                                    </label>
                                    <label style="display:flex;align-items:center;gap:4px;font-size:0.76rem;cursor:pointer;">
                                        <input type="radio" name="progressMode" value="percent" onchange="setProgressMode('percent')" style="accent-color:#D4AF37;"> Percentage
                                    </label>
                                </div>
                            </div>

                            <div style="padding:16px 20px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;align-items:start;">
                                <!-- Activity selector -->
                                <div>
                                    <label style="font-size:0.74rem;font-weight:700;color:#374151;display:block;margin-bottom:5px;">STRETCH & ACTIVITY</label>
                                    <select id="progActivitySel" onchange="onProgressActivityChange()" style="width:100%;padding:7px 10px;border:1px solid #e2e8f0;border-radius:5px;font-size:0.8rem;">
                                        <option value="">Select activity‚Ä¶</option>
                                    </select>
                                </div>

                                <!-- Chainage input -->
                                <div id="chainageInputWrap">
                                    <label style="font-size:0.74rem;font-weight:700;color:#374151;display:block;margin-bottom:5px;">COMPLETED UP TO CHAINAGE (m)</label>
                                    <input type="number" id="progChainage" min="0" step="1" placeholder="e.g. 5400"
                                        onchange="computeProgressMetrics()"
                                        style="width:100%;padding:7px 10px;border:1px solid #e2e8f0;border-radius:5px;font-size:0.8rem;" />
                                    <div id="chainagePrevious" style="font-size:0.72rem;color:#64748b;margin-top:4px;"></div>
                                </div>

                                <!-- Percent input (hidden by default) -->
                                <div id="percentInputWrap" style="display:none;">
                                    <label style="font-size:0.74rem;font-weight:700;color:#374151;display:block;margin-bottom:5px;">COMPLETION %</label>
                                    <input type="number" id="progPercent" min="0" max="100" step="1" placeholder="0‚Äì100"
                                        onchange="computeProgressMetrics()"
                                        style="width:100%;padding:7px 10px;border:1px solid #e2e8f0;border-radius:5px;font-size:0.8rem;" />
                                </div>

                                <!-- Record button -->
                                <div style="display:flex;flex-direction:column;justify-content:flex-end;">
                                    <button onclick="recordProgress()" style="padding:9px 20px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:5px;font-size:0.84rem;font-weight:700;cursor:pointer;width:100%;">üíæ Record Progress</button>
                                </div>
                            </div>

                            <!-- Auto-computed metrics row -->
                            <div id="progressMetricsRow" style="display:none;padding:12px 20px;background:#f8fafc;border-top:1px solid #e2e8f0;display:grid;grid-template-columns:repeat(5,1fr);gap:12px;">
                                <div style="text-align:center;">
                                    <div style="font-size:0.68rem;color:#64748b;font-weight:700;text-transform:uppercase;">Completion %</div>
                                    <div id="pmPct" style="font-size:1.1rem;font-weight:700;color:#1B3B6F;margin-top:2px;">‚Äî</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:0.68rem;color:#64748b;font-weight:700;text-transform:uppercase;">Daily Advance</div>
                                    <div id="pmAdvance" style="font-size:1.1rem;font-weight:700;color:#1B3B6F;margin-top:2px;">‚Äî</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:0.68rem;color:#64748b;font-weight:700;text-transform:uppercase;">Planned Rate</div>
                                    <div id="pmPlannedRate" style="font-size:1.1rem;font-weight:700;color:#1B3B6F;margin-top:2px;">‚Äî</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:0.68rem;color:#64748b;font-weight:700;text-transform:uppercase;">Gap</div>
                                    <div id="pmGap" style="font-size:1.1rem;font-weight:700;margin-top:2px;">‚Äî</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:0.68rem;color:#64748b;font-weight:700;text-transform:uppercase;">Forecast Complete</div>
                                    <div id="pmForecast" style="font-size:0.85rem;font-weight:700;color:#1B3B6F;margin-top:2px;">‚Äî</div>
                                </div>
                            </div>
                        </div>

                        <!-- RECENT ENTRIES TABLE -->
                        <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:16px 20px;margin-bottom:20px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                <h4 style="margin:0;color:#1B3B6F;font-size:0.9rem;">üìã Recent Progress Entries</h4>
                                <span style="font-size:0.76rem;color:#64748b;">Last 10 entries</span>
                            </div>
                            <div style="overflow-x:auto;">
                                <table style="width:100%;border-collapse:collapse;font-size:0.78rem;">
                                    <thead>
                                        <tr style="background:#f8fafc;">
                                            <th style="padding:8px 10px;text-align:left;border-bottom:2px solid #e2e8f0;">Date</th>
                                            <th style="padding:8px 10px;text-align:left;border-bottom:2px solid #e2e8f0;">Activity</th>
                                            <th style="padding:8px 10px;text-align:center;border-bottom:2px solid #e2e8f0;">Chainage / %</th>
                                            <th style="padding:8px 10px;text-align:center;border-bottom:2px solid #e2e8f0;">Advance</th>
                                            <th style="padding:8px 10px;text-align:center;border-bottom:2px solid #e2e8f0;">vs Plan</th>
                                            <th style="padding:8px 10px;text-align:center;border-bottom:2px solid #e2e8f0;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="progressEntriesBody">
                                        <tr><td colspan="6" style="padding:16px;text-align:center;color:#94a3b8;">No entries yet.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div style="background: white; border-radius: 8px; padding: 28px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px;">
                            <h4 style="margin: 0 0 24px 0; color: #1e293b; font-size: 1.125rem; font-weight: 600;">Progress S-Curve (Planned vs Actual)</h4>
                            
                            <!-- Chart Area -->
                            <div style="position: relative; height: 320px; background: #fafbfc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 20px;">
                                <!-- Y-axis labels -->
                                <div style="position: absolute; left: 10px; top: 20px; bottom: 40px; display: flex; flex-direction: column; justify-content: space-between; font-size: 0.75rem; color: #64748b;">
                                    <span>100%</span>
                                    <span>75%</span>
                                    <span>50%</span>
                                    <span>25%</span>
                                    <span>0%</span>
                                </div>
                                
                                <!-- Grid lines -->
                                <div style="position: absolute; left: 50px; right: 20px; top: 20px; bottom: 40px;">
                                    <div style="position: absolute; top: 0%; left: 0; right: 0; border-top: 1px dashed #cbd5e1;"></div>
                                    <div style="position: absolute; top: 25%; left: 0; right: 0; border-top: 1px dashed #cbd5e1;"></div>
                                    <div style="position: absolute; top: 50%; left: 0; right: 0; border-top: 1px dashed #cbd5e1;"></div>
                                    <div style="position: absolute; top: 75%; left: 0; right: 0; border-top: 1px dashed #cbd5e1;"></div>
                                    <div style="position: absolute; top: 100%; left: 0; right: 0; border-top: 2px solid #94a3b8;"></div>
                                    
                                    <!-- Planned curve (blue) -->
                                    <svg style="position: absolute; width: 100%; height: 100%;">
                                        <polyline points="0,280 50,250 100,210 150,160 200,110 250,60 300,30 350,10 400,5" 
                                                  fill="none" stroke="#3b82f6" stroke-width="3" stroke-dasharray="5,5"/>
                                    </svg>
                                    
                                    <!-- Actual curve (green) -->
                                    <svg style="position: absolute; width: 100%; height: 100%;">
                                        <polyline points="0,280 50,255 100,225 150,185 200,155" 
                                                  fill="none" stroke="#22c55e" stroke-width="3"/>
                                    </svg>
                                </div>
                                
                                <!-- X-axis labels -->
                                <div style="position: absolute; left: 50px; right: 20px; bottom: 10px; display: flex; justify-content: space-between; font-size: 0.75rem; color: #64748b;">
                                    <span>Jan</span>
                                    <span>Feb</span>
                                    <span>Mar</span>
                                    <span>Apr</span>
                                    <span>May</span>
                                    <span>Jun</span>
                                </div>
                                
                                <!-- Legend -->
                                <div style="position: absolute; top: 20px; right: 30px; background: white; padding: 12px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <div style="width: 24px; height: 3px; background: #3b82f6; border-top: 3px dashed #3b82f6;"></div>
                                        <span style="font-size: 0.8125rem; color: #475569;">Planned</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="width: 24px; height: 3px; background: #22c55e;"></div>
                                        <span style="font-size: 0.8125rem; color: #475569;">Actual</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progress by Work Type -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 24px;">
                            
                            <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Progress by Work Type</h4>
                                
                                <div style="margin-bottom: 18px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">Earthwork</span>
                                        <span style="font-size: 0.875rem; font-weight: 700; color: #1e293b;">45%</span>
                                    </div>
                                    <div style="width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                        <div style="width: 45%; height: 100%; background: linear-gradient(to right, #f59e0b, #d97706); border-radius: 5px;"></div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 18px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">Structures</span>
                                        <span style="font-size: 0.875rem; font-weight: 700; color: #1e293b;">25%</span>
                                    </div>
                                    <div style="width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                        <div style="width: 25%; height: 100%; background: linear-gradient(to right, #3b82f6, #2563eb); border-radius: 5px;"></div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 18px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">Pavement</span>
                                        <span style="font-size: 0.875rem; font-weight: 700; color: #1e293b;">10%</span>
                                    </div>
                                    <div style="width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                        <div style="width: 10%; height: 100%; background: linear-gradient(to right, #22c55e, #16a34a); border-radius: 5px;"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 0.875rem; font-weight: 500; color: #475569;">Drainage</span>
                                        <span style="font-size: 0.875rem; font-weight: 700; color: #1e293b;">5%</span>
                                    </div>
                                    <div style="width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                        <div style="width: 5%; height: 100%; background: linear-gradient(to right, #8b5cf6, #7c3aed); border-radius: 5px;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Milestone Tracker</h4>
                                <div id="milestoneTrackerBody" style="min-height:40px;"></div>
                                
                                <div style="margin-bottom: 16px;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span style="font-size: 1.5rem;">‚úÖ</span>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; font-size: 0.875rem; color: #1e293b;">Project Start</div>
                                            <div style="font-size: 0.8125rem; color: #64748b;">01-Jan-2026</div>
                                        </div>
                                        <span style="background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">Completed</span>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span style="font-size: 1.5rem;">üîµ</span>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; font-size: 0.875rem; color: #1e293b;">Phase 1 Complete</div>
                                            <div style="font-size: 0.8125rem; color: #64748b;">Target: 15-Feb-2026</div>
                                        </div>
                                        <span style="background: #dbeafe; color: #1e40af; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">In Progress</span>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span style="font-size: 1.5rem;">üîµ</span>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; font-size: 0.875rem; color: #1e293b;">Box Culvert Complete</div>
                                            <div style="font-size: 0.8125rem; color: #64748b;">Target: 22-Jan-2026</div>
                                        </div>
                                        <span style="background: #dbeafe; color: #1e40af; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">In Progress</span>
                                    </div>
                                </div>
                                
                                <div>
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span style="font-size: 1.5rem;">‚ö™</span>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; font-size: 0.875rem; color: #1e293b;">Project Completion</div>
                                            <div style="font-size: 0.8125rem; color: #64748b;">Target: 15-Apr-2026</div>
                                        </div>
                                        <span style="background: #f1f5f9; color: #64748b; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">Pending</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progress by Location -->
                        <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Progress by Chainage</h4>
                            
                            <div style="position: relative; height: 80px; background: #f8fafc; border-radius: 6px; padding: 20px;">
                                <!-- Chainage markers -->
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.75rem; color: #64748b; font-weight: 600;">
                                    <span>Ch 0+000</span>
                                    <span>Ch 1+000</span>
                                    <span>Ch 2+000</span>
                                    <span>Ch 3+000</span>
                                    <span>Ch 4+000</span>
                                    <span>Ch 5+000</span>
                                </div>
                                
                                <!-- Progress bar -->
                                <div style="width: 100%; height: 24px; background: #e2e8f0; border-radius: 12px; overflow: hidden; position: relative;">
                                    <!-- Completed section -->
                                    <div style="position: absolute; left: 0; width: 40%; height: 100%; background: linear-gradient(to right, #22c55e, #16a34a);"></div>
                                    
                                    <!-- In progress section -->
                                    <div style="position: absolute; left: 40%; width: 10%; height: 100%; background: repeating-linear-gradient(45deg, #3b82f6, #3b82f6 10px, #60a5fa 10px, #60a5fa 20px);"></div>
                                    
                                    <!-- Blocked section -->
                                    <div style="position: absolute; left: 64%; width: 12%; height: 100%; background: repeating-linear-gradient(45deg, #ef4444, #ef4444 10px, #f87171 10px, #f87171 20px);"></div>
                                </div>
                                
                                <div style="display: flex; gap: 16px; margin-top: 12px; font-size: 0.75rem;">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <div style="width: 16px; height: 16px; background: linear-gradient(to right, #22c55e, #16a34a); border-radius: 2px;"></div>
                                        <span style="color: #475569;">Completed (40%)</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <div style="width: 16px; height: 16px; background: repeating-linear-gradient(45deg, #3b82f6, #3b82f6 4px, #60a5fa 4px, #60a5fa 8px); border-radius: 2px;"></div>
                                        <span style="color: #475569;">In Progress (10%)</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <div style="width: 16px; height: 16px; background: repeating-linear-gradient(45deg, #ef4444, #ef4444 4px, #f87171 4px, #f87171 8px); border-radius: 2px;"></div>
                                        <span style="color: #475569;">Blocked (12%)</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <div style="width: 16px; height: 16px; background: #e2e8f0; border-radius: 2px;"></div>
                                        <span style="color: #475569;">Not Started (38%)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
            
            <!-- TAB 11: REPORTS & ANALYTICS -->
            <div class="tab-panel" id="tab11" style="overflow-y:auto;overflow-x:hidden;">
                <div class="tabular-container">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <h3 style="margin: 0; color: #1B3B6F;">üìë Reports & Analytics</h3>
                        </div>
                        <div class="toolbar-right">
                            <button onclick="exportBaselineReport()" style="padding:6px 14px;background:#1B3B6F;color:white;border:none;border-radius:5px;font-size:0.78rem;font-weight:600;cursor:pointer;margin-right:8px;">üìÑ Baseline Report (PDF)</button>
                            <button onclick="exportProductivityGapReport()" style="padding:6px 14px;background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe;border-radius:5px;font-size:0.78rem;font-weight:600;cursor:pointer;margin-right:8px;">üìä Productivity Gap (PDF)</button>
                            <button class="btn btn-primary btn-sm btn-v7" onclick="showToast('üéØ Custom report builder ‚Äî Coming in V7.0', 'info')" style="opacity:0.55;cursor:not-allowed;" title="Coming in V7.0">üéØ Custom Report <span style='font-size:0.65rem;background:#94a3b8;color:white;padding:1px 5px;border-radius:3px;margin-left:4px;'>V7.0</span></button>
                        </div>
                    </div>
                    
                    <div class="content-container" style="padding: 24px;">
                        
                        <!-- Report Templates Grid -->
                        <div style="background: white; border-radius: 8px; padding: 28px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px;">
                            <h4 style="margin: 0 0 24px 0; color: #1e293b; font-size: 1.125rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Standard Report Templates</h4>
                            
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                                
                                <div style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1B3B6F'; this.style.boxShadow='0 4px 12px rgba(27, 59, 111, 0.1)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'" onclick="generateReport('daily')">
                                    <div style="font-size: 2rem; margin-bottom: 12px;">üìä</div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; color: #1e293b; margin-bottom: 6px;">Daily Progress Report</div>
                                    <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 12px;">Daily work summary with quantities</div>
                                    <button class="btn btn-sm" style="background: #1B3B6F; color: white; width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Generate ‚Üí</button>
                                </div>
                                
                                <div style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1B3B6F'; this.style.boxShadow='0 4px 12px rgba(27, 59, 111, 0.1)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'" onclick="generateReport('weekly')">
                                    <div style="font-size: 2rem; margin-bottom: 12px;">üìà</div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; color: #1e293b; margin-bottom: 6px;">Weekly Status Report</div>
                                    <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 12px;">Comprehensive weekly summary</div>
                                    <button class="btn btn-sm" style="background: #1B3B6F; color: white; width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Generate ‚Üí</button>
                                </div>
                                
                                <div style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1B3B6F'; this.style.boxShadow='0 4px 12px rgba(27, 59, 111, 0.1)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'" onclick="generateReport('monthly')">
                                    <div style="font-size: 2rem; margin-bottom: 12px;">üìâ</div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; color: #1e293b; margin-bottom: 6px;">Monthly Progress Report</div>
                                    <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 12px;">Detailed monthly analysis</div>
                                    <button class="btn btn-sm" style="background: #1B3B6F; color: white; width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Generate ‚Üí</button>
                                </div>
                                
                                <div style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1B3B6F'; this.style.boxShadow='0 4px 12px rgba(27, 59, 111, 0.1)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'" onclick="generateReport('hindrance')">
                                    <div style="font-size: 2rem; margin-bottom: 12px;">üîç</div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; color: #1e293b; margin-bottom: 6px;">Hindrance Analysis</div>
                                    <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 12px;">Impact of delays and hindrances</div>
                                    <button class="btn btn-sm" style="background: #1B3B6F; color: white; width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Generate ‚Üí</button>
                                </div>
                                
                                <div style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1B3B6F'; this.style.boxShadow='0 4px 12px rgba(27, 59, 111, 0.1)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'" onclick="generateReport('cost')">
                                    <div style="font-size: 2rem; margin-bottom: 12px;">üí∞</div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; color: #1e293b; margin-bottom: 6px;">Cost Analysis</div>
                                    <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 12px;">Budget vs actual spending</div>
                                    <button class="btn btn-sm" style="background: #1B3B6F; color: white; width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Generate ‚Üí</button>
                                </div>
                                
                                <div style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1B3B6F'; this.style.boxShadow='0 4px 12px rgba(27, 59, 111, 0.1)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'" onclick="generateReport('resource')">
                                    <div style="font-size: 2rem; margin-bottom: 12px;">üë∑</div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; color: #1e293b; margin-bottom: 6px;">Resource Utilization</div>
                                    <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 12px;">Equipment and labor efficiency</div>
                                    <button class="btn btn-sm" style="background: #1B3B6F; color: white; width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Generate ‚Üí</button>
                                </div>
                                
                                <div style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1B3B6F'; this.style.boxShadow='0 4px 12px rgba(27, 59, 111, 0.1)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'" onclick="generateReport('schedule')">
                                    <div style="font-size: 2rem; margin-bottom: 12px;">üìÖ</div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; color: #1e293b; margin-bottom: 6px;">Schedule Variance</div>
                                    <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 12px;">Planned vs actual timeline</div>
                                    <button class="btn btn-sm" style="background: #1B3B6F; color: white; width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Generate ‚Üí</button>
                                </div>
                                
                                <div style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1B3B6F'; this.style.boxShadow='0 4px 12px rgba(27, 59, 111, 0.1)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'" onclick="showToast('üöß Quality Compliance Report coming in V7.0', 'info')">
                                    <div style="font-size: 2rem; margin-bottom: 12px;">‚úì</div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; color: #1e293b; margin-bottom: 6px;">Quality Compliance</div>
                                    <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 12px;">IRC standards adherence</div>
                                    <button class="btn btn-sm" style="background: #1B3B6F; color: white; width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Generate ‚Üí</button>
                                </div>
                                
                                <div style="border: 2px solid #D4AF37; border-radius: 8px; padding: 20px; cursor: pointer; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(212, 175, 55, 0.3)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'" onclick="showToast('üéØ Custom Report Builder coming in V7.0', 'info')">
                                    <div style="font-size: 2rem; margin-bottom: 12px;">üéØ</div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; color: #1e293b; margin-bottom: 6px;">Custom Report Builder</div>
                                    <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 12px;">Build your own custom report</div>
                                    <button class="btn btn-sm" style="background: #D4AF37; color: #1e293b; width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 700;">Build Custom ‚Üí</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Analytics -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 24px;">
                            
                            <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Top 5 Critical Activities</h4>
                                
                                <table style="width: 100%; font-size: 0.875rem;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <th style="text-align: left; padding: 8px; color: #64748b; font-weight: 600;">Activity</th>
                                            <th style="text-align: right; padding: 8px; color: #64748b; font-weight: 600;">Float</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr style="border-bottom: 1px solid #f1f5f9;">
                                            <td style="padding: 10px; color: #1e293b;">Soil Excavation</td>
                                            <td style="padding: 10px; text-align: right; font-weight: 700; color: #dc2626;">0d</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid #f1f5f9;">
                                            <td style="padding: 10px; color: #1e293b;">Embankment</td>
                                            <td style="padding: 10px; text-align: right; font-weight: 700; color: #dc2626;">0d</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid #f1f5f9;">
                                            <td style="padding: 10px; color: #1e293b;">Foundation Concrete</td>
                                            <td style="padding: 10px; text-align: right; font-weight: 700; color: #dc2626;">0d</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid #f1f5f9;">
                                            <td style="padding: 10px; color: #1e293b;">Box Construction</td>
                                            <td style="padding: 10px; text-align: right; font-weight: 700; color: #dc2626;">0d</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 10px; color: #1e293b;">Curing</td>
                                            <td style="padding: 10px; text-align: right; font-weight: 700; color: #dc2626;">0d</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">Export Options</h4>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <button class="btn-v7" onclick="showToast('üìÑ PDF export ‚Äî Coming in V7.0', 'info')" style="padding: 16px; background: #fef2f2; border: 2px solid #fecaca; border-radius: 8px; cursor: not-allowed; transition: all 0.2s; text-align: left; opacity:0.65;" title="Coming in V7.0">
                                        <div style="font-size: 1.5rem; margin-bottom: 8px;">üìÑ</div>
                                        <div style="font-weight: 600; font-size: 0.875rem; color: #1e293b;">Export to PDF</div>
                                        <div style="font-size: 0.75rem; color: #64748b;">Printable format</div>
                                    </button>
                                    
                                    <button class="btn-v7" onclick="showToast('üìä Excel export ‚Äî Coming in V7.0', 'info')" style="padding: 16px; background: #f0fdf4; border: 2px solid #bbf7d0; border-radius: 8px; cursor: not-allowed; transition: all 0.2s; text-align: left; opacity:0.65;" title="Coming in V7.0">
                                        <div style="font-size: 1.5rem; margin-bottom: 8px;">üìä</div>
                                        <div style="font-weight: 600; font-size: 0.875rem; color: #1e293b;">Export to Excel</div>
                                        <div style="font-size: 0.75rem; color: #64748b;">Editable data</div>
                                    </button>
                                    
                                    <button class="btn-v7" onclick="showToast('üìß Email report ‚Äî Coming in V7.0', 'info')" style="padding: 16px; background: #eff6ff; border: 2px solid #bfdbfe; border-radius: 8px; cursor: not-allowed; transition: all 0.2s; text-align: left; opacity:0.65;" title="Coming in V7.0">
                                        <div style="font-size: 1.5rem; margin-bottom: 8px;">üìß</div>
                                        <div style="font-weight: 600; font-size: 0.875rem; color: #1e293b;">Email Report</div>
                                        <div style="font-size: 0.75rem; color: #64748b;">Send to stakeholders</div>
                                    </button>
                                    
                                    <button onclick="window.print()" style="padding: 16px; background: #fafafa; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: left;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#fafafa'">
                                        <div style="font-size: 1.5rem; margin-bottom: 8px;">üñ®Ô∏è</div>
                                        <div style="font-weight: 600; font-size: 0.875rem; color: #1e293b;">Print Report</div>
                                        <div style="font-size: 0.75rem; color: #64748b;">Direct print</div>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>


            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                 CONSTRAINTS TAB
                 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="tab-panel" id="tabConstraints">
                <div style="background:#f8fafc;min-height:100%;display:flex;flex-direction:column;">

                    <!-- ‚îÄ‚îÄ Header bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                    <div style="background:white;border-bottom:2px solid #e5e7eb;
                                padding:14px 24px;display:flex;align-items:center;
                                gap:12px;flex-shrink:0;">
                        <div>
                            <h2 style="margin:0;font-size:1.05rem;font-weight:700;color:#1B3B6F;">
                                üîó Scheduling Constraints</h2>
                            <p style="margin:3px 0 0;font-size:0.78rem;color:#64748b;">
                                Define resource groups ‚Üí set crew buffers ‚Üí review violations</p>
                        </div>
                        <div style="flex:1;"></div>
                        <button onclick="KALYANTRA.refresh();renderConstraintsTab();"
                            style="display:flex;align-items:center;gap:6px;padding:8px 16px;
                                   background:#1B3B6F;color:white;border:none;border-radius:6px;
                                   font-size:0.83rem;cursor:pointer;font-weight:600;">
                            üîÑ Recalculate</button>
                        <button onclick="saveConstraints();"
                            style="display:flex;align-items:center;gap:6px;padding:8px 16px;
                                   background:#D4AF37;color:#1B3B6F;border:none;border-radius:6px;
                                   font-size:0.83rem;cursor:pointer;font-weight:600;">
                            üíæ Save</button>
                    </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                 TAB: BASELINE (index 12)
                 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="tab-panel" id="tabBaseline">
                <div class="tabular-container">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <h3 style="margin:0;color:#1B3B6F;">üì∏ Baseline Management</h3>
                            <span id="baselineStatusBadge" style="margin-left:14px;font-size:0.78rem;padding:3px 10px;border-radius:12px;background:#f1f5f9;color:#64748b;font-weight:600;">No baseline frozen</span>
                        </div>
                        <div class="toolbar-right">
                            <button onclick="freezeBaseline()" id="freezeBaselineBtn" style="padding:6px 18px;background:#1B3B6F;color:white;border:none;border-radius:5px;font-size:0.82rem;font-weight:700;cursor:pointer;">üîí Freeze Baseline</button>
                        </div>
                    </div>
                    <div style="flex:1;overflow-y:auto;padding:20px 24px;">

                        <!-- Baseline status card -->
                        <div id="baselineInfoCard" style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:20px;margin-bottom:20px;">
                            <div id="baselineEmptyState" style="text-align:center;padding:30px;color:#94a3b8;">
                                <div style="font-size:2.5rem;margin-bottom:10px;">üì∏</div>
                                <div style="font-size:1rem;font-weight:600;margin-bottom:6px;">No baseline frozen yet</div>
                                <div style="font-size:0.82rem;margin-bottom:20px;">Freeze a baseline to lock the planned schedule, resource productivity, and material demand plan.</div>
                                <div style="font-size:0.78rem;color:#1B3B6F;background:#eff6ff;padding:12px;border-radius:6px;text-align:left;">
                                    <strong>Before freezing, ensure:</strong><br>
                                    ‚úÖ TCS layers defined with thicknesses<br>
                                    ‚úÖ Resources with productivity rates entered<br>
                                    ‚úÖ Activity Grid shows computed durations<br>
                                    ‚úÖ Project dates and milestones set
                                </div>
                            </div>
                            <div id="baselineFrozenInfo" style="display:none;">
                                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px;">
                                    <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:14px;text-align:center;">
                                        <div style="font-size:0.72rem;color:#16a34a;font-weight:700;text-transform:uppercase;">Frozen On</div>
                                        <div id="blFrozenDate" style="font-size:1rem;font-weight:700;color:#15803d;margin-top:4px;">‚Äî</div>
                                    </div>
                                    <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:14px;text-align:center;">
                                        <div style="font-size:0.72rem;color:#1e40af;font-weight:700;text-transform:uppercase;">Planned Completion</div>
                                        <div id="blCompletionDate" style="font-size:1rem;font-weight:700;color:#1d4ed8;margin-top:4px;">‚Äî</div>
                                    </div>
                                    <div style="background:#fff7ed;border:1px solid #fed7aa;border-radius:8px;padding:14px;text-align:center;">
                                        <div style="font-size:0.72rem;color:#c2410c;font-weight:700;text-transform:uppercase;">Total Activities</div>
                                        <div id="blActivityCount" style="font-size:1rem;font-weight:700;color:#9a3412;margin-top:4px;">‚Äî</div>
                                    </div>
                                    <div style="background:#fdf4ff;border:1px solid #e9d5ff;border-radius:8px;padding:14px;text-align:center;">
                                        <div style="font-size:0.72rem;color:#7e22ce;font-weight:700;text-transform:uppercase;">Total Duration</div>
                                        <div id="blTotalDays" style="font-size:1rem;font-weight:700;color:#6b21a8;margin-top:4px;">‚Äî</div>
                                    </div>
                                </div>
                                <div style="display:flex;gap:10px;margin-bottom:16px;">
                                    <button onclick="unfreezeBaseline()" style="padding:6px 14px;background:#fef3c7;color:#92400e;border:1px solid #fde68a;border-radius:5px;font-size:0.78rem;font-weight:600;cursor:pointer;">üîì Unfreeze</button>
                                    <button onclick="exportBaselineReport()" style="padding:6px 14px;background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe;border-radius:5px;font-size:0.78rem;font-weight:600;cursor:pointer;">üìÑ Export Baseline Report</button>
                                </div>
                            </div>
                        </div>

                        <!-- Material demand plan (generated at freeze) -->
                        <div id="materialDemandSection" style="display:none;background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:20px;margin-bottom:20px;">
                            <h4 style="margin:0 0 14px;color:#1B3B6F;font-size:0.95rem;">üì¶ Monthly Material Demand Plan</h4>
                            <div style="font-size:0.78rem;color:#64748b;margin-bottom:12px;">Generated from baseline schedule. Quantities in m¬≥ (volume) and MT (weight = volume √ó user-defined density).</div>
                            <div id="materialDemandTable" style="overflow-x:auto;"></div>
                        </div>

                        <!-- Baseline WBS snapshot -->
                        <div id="baselineWBSSection" style="display:none;background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:20px;">
                            <h4 style="margin:0 0 14px;color:#1B3B6F;font-size:0.95rem;">üìã Baseline Activity Schedule</h4>
                            <div id="baselineWBSTable" style="overflow-x:auto;"></div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                 TAB: SCENARIOS (index 13)
                 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="tab-panel" id="tabScenarios">
                <div class="tabular-container">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <h3 style="margin:0;color:#1B3B6F;">üéØ What-If Scenarios</h3>
                            <span style="margin-left:12px;font-size:0.78rem;color:#64748b;">In-memory only ‚Äî never saved unless you Promote to Plan</span>
                        </div>
                        <div class="toolbar-right">
                            <button onclick="addScenario()" style="padding:6px 16px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:5px;font-size:0.82rem;font-weight:700;cursor:pointer;">+ New Scenario</button>
                        </div>
                    </div>
                    <div style="flex:1;overflow-y:auto;padding:20px 24px;display:flex;flex-direction:column;gap:16px;">

                        <!-- Active plan summary bar -->
                        <div style="background:#1B3B6F;color:white;border-radius:8px;padding:14px 20px;display:flex;gap:24px;flex-wrap:wrap;align-items:center;">
                            <div><span style="font-size:0.7rem;opacity:0.7;text-transform:uppercase;">ACTIVE PLAN</span><br><strong id="scenActivePlan">‚Äî</strong></div>
                            <div><span style="font-size:0.7rem;opacity:0.7;text-transform:uppercase;">Completion</span><br><strong id="scenCompletion">‚Äî</strong></div>
                            <div><span style="font-size:0.7rem;opacity:0.7;text-transform:uppercase;">Duration</span><br><strong id="scenDuration">‚Äî</strong></div>
                            <div><span style="font-size:0.7rem;opacity:0.7;text-transform:uppercase;">Baseline Status</span><br><span id="scenBaselineStatus" style="color:#D4AF37;font-weight:600;">No baseline</span></div>
                        </div>

                        <!-- Scenario builder -->
                        <div id="scenarioBuilder" style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden;">
                            <div style="background:#334155;color:white;padding:12px 16px;font-weight:700;font-size:0.86rem;">‚öôÔ∏è Scenario Builder</div>
                            <div style="padding:16px;display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:12px;align-items:end;">
                                <div>
                                    <label style="font-size:0.74rem;font-weight:700;color:#374151;display:block;margin-bottom:4px;">SCENARIO TYPE</label>
                                    <select id="scenType" onchange="updateScenBuilder()" style="width:100%;padding:7px 10px;border:1px solid #e2e8f0;border-radius:5px;font-size:0.82rem;">
                                        <option value="resource_count">Add / Remove Resources</option>
                                        <option value="shift_change">Change Shift (Single‚ÜíDouble)</option>
                                        <option value="monsoon_extend">Extend Monsoon Period</option>
                                        <option value="structure_delay">Structure Drawing Delay</option>
                                        <option value="gang_split">Split Gang (Work Both Ends)</option>
                                    </select>
                                </div>
                                <div id="scenParam1Wrap">
                                    <label style="font-size:0.74rem;font-weight:700;color:#374151;display:block;margin-bottom:4px;" id="scenParam1Label">RESOURCE</label>
                                    <select id="scenParam1" style="width:100%;padding:7px 10px;border:1px solid #e2e8f0;border-radius:5px;font-size:0.82rem;"></select>
                                </div>
                                <div id="scenParam2Wrap">
                                    <label style="font-size:0.74rem;font-weight:700;color:#374151;display:block;margin-bottom:4px;" id="scenParam2Label">CHANGE TO</label>
                                    <input type="number" id="scenParam2" min="0" placeholder="Enter value" style="width:100%;padding:7px 10px;border:1px solid #e2e8f0;border-radius:5px;font-size:0.82rem;" />
                                </div>
                                <button onclick="computeScenario()" style="padding:7px 18px;background:#1B3B6F;color:white;border:none;border-radius:5px;font-size:0.82rem;font-weight:700;cursor:pointer;white-space:nowrap;">‚ñ∂ Compute</button>
                            </div>
                            <div id="scenResult" style="display:none;padding:14px 16px;background:#f0fdf4;border-top:1px solid #e2e8f0;"></div>
                        </div>

                        <!-- Scenario comparison table -->
                        <div id="scenComparisonSection" style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden;">
                            <div style="background:#1B3B6F;color:white;padding:10px 16px;font-weight:700;font-size:0.84rem;">üìä Scenario Comparison</div>
                            <div style="overflow-x:auto;">
                                <table id="scenComparisonTable" style="width:100%;border-collapse:collapse;font-size:0.8rem;">
                                    <thead>
                                        <tr style="background:#f8fafc;">
                                            <th style="padding:10px 14px;text-align:left;border-bottom:2px solid #e2e8f0;min-width:180px;">Metric</th>
                                            <th style="padding:10px 14px;text-align:center;border-bottom:2px solid #e2e8f0;min-width:140px;color:#1B3B6F;">Active Plan</th>
                                            <th id="scenCol1Header" style="padding:10px 14px;text-align:center;border-bottom:2px solid #e2e8f0;min-width:140px;display:none;"></th>
                                            <th id="scenCol2Header" style="padding:10px 14px;text-align:center;border-bottom:2px solid #e2e8f0;min-width:140px;display:none;"></th>
                                            <th id="scenCol3Header" style="padding:10px 14px;text-align:center;border-bottom:2px solid #e2e8f0;min-width:140px;display:none;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="scenComparisonBody">
                                        <tr><td colspan="5" style="padding:20px;text-align:center;color:#94a3b8;">No scenarios computed yet. Use the Scenario Builder above.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                 TAB: ALERTS (index 14)
                 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="tab-panel" id="tabAlerts">
                <div class="tabular-container">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <h3 style="margin:0;color:#1B3B6F;">üîî Smart Alerts</h3>
                            <span id="alertsCountBadge" style="margin-left:12px;font-size:0.78rem;padding:3px 10px;border-radius:12px;background:#f1f5f9;color:#64748b;font-weight:600;">0 active</span>
                        </div>
                        <div class="toolbar-right">
                            <button onclick="computeAllAlerts()" style="padding:6px 14px;background:#1B3B6F;color:white;border:none;border-radius:5px;font-size:0.78rem;font-weight:600;cursor:pointer;">üîÑ Refresh Alerts</button>
                            <button onclick="dismissAllAlerts()" style="padding:6px 14px;background:#f1f5f9;color:#64748b;border:1px solid #e2e8f0;border-radius:5px;font-size:0.78rem;cursor:pointer;margin-left:6px;">‚úì Dismiss All</button>
                        </div>
                    </div>
                    <div style="flex:1;overflow-y:auto;padding:20px 24px;display:flex;flex-direction:column;gap:10px;">
                        <div id="alertsContainer">
                            <div style="text-align:center;padding:40px;color:#94a3b8;">
                                <div style="font-size:2rem;margin-bottom:8px;">üîî</div>
                                <div style="font-weight:600;margin-bottom:6px;">No alerts yet</div>
                                <div style="font-size:0.82rem;">Click Refresh Alerts to scan for schedule, resource, and data quality issues.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


                    <!-- ‚îÄ‚îÄ Violation banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                    <div id="constraintViolationBanner"
                        style="display:none;background:#7f1d1d;color:#fecaca;
                               padding:9px 24px;font-size:0.82rem;border-bottom:1px solid #dc2626;
                               flex-shrink:0;">
                        <strong>‚ö†Ô∏è Violations Detected:</strong>
                        <span id="constraintViolationCount">0</span> conflict(s) found ‚Äî review Section 4.
                    </div>

                    <!-- ‚îÄ‚îÄ Scrollable content ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                    <div style="padding:20px 24px 80px;display:flex;flex-direction:column;gap:18px;">

                        <!-- ‚îÄ‚îÄ‚îÄ Seed notice (shown on first open) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                        <div id="constraintSeedNotice"
                            style="display:none;background:#eff6ff;border:1px solid #bfdbfe;
                                   border-radius:8px;padding:12px 16px;font-size:0.8rem;color:#1e40af;">
                            <strong>üí° Default resource groups pre-loaded</strong> ‚Äî
                            These are typical NHAI/MoRTH gang configurations for a 4-lane HAM project.
                            Edit names, keywords, crew counts and buffer distances to match your plan,
                            then click <strong>üíæ Save</strong>.
                        </div>

                        <!-- ‚îÄ‚îÄ‚îÄ SECTION 1: Resource Groups ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                        <div style="background:white;border-radius:10px;
                                    border:1px solid #e5e7eb;overflow:hidden;">
                            <div style="background:#1B3B6F;color:white;padding:11px 18px;
                                        display:flex;align-items:center;justify-content:space-between;">
                                <div>
                                    <span style="font-weight:700;font-size:0.9rem;">üë∑ Resource Groups</span>
                                    <span style="font-size:0.72rem;opacity:0.7;margin-left:10px;">
                                        Each group = one crew type that can only work one stretch at a time</span>
                                </div>
                                <button onclick="addResourceGroup()"
                                    style="padding:5px 14px;background:#D4AF37;color:#1B3B6F;
                                           border:none;border-radius:4px;font-size:0.78rem;
                                           cursor:pointer;font-weight:700;">+ Add Group</button>
                            </div>
                            <table style="width:100%;border-collapse:collapse;">
                                <thead>
                                    <tr style="background:#f8fafc;border-bottom:2px solid #e5e7eb;">
                                        <th style="padding:9px 12px;text-align:left;font-size:0.78rem;
                                                   color:#475569;font-weight:600;width:18%;">Group Name</th>
                                        <th style="padding:9px 12px;text-align:left;font-size:0.78rem;
                                                   color:#475569;font-weight:600;">Activity Keywords</th>
                                        <th style="padding:9px 12px;text-align:center;font-size:0.78rem;
                                                   color:#475569;font-weight:600;width:80px;">Crews</th>
                                        <th style="padding:9px 12px;text-align:center;font-size:0.78rem;
                                                   color:#475569;font-weight:600;width:130px;">Default Buffer (m)</th>
                                        <th style="padding:9px 12px;text-align:center;font-size:0.78rem;
                                                   color:#475569;font-weight:600;width:100px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="resourceGroupBody"></tbody>
                            </table>
                            <div id="resourceGroupEmpty"
                                style="display:none;padding:20px;text-align:center;
                                       color:#94a3b8;font-size:0.85rem;">
                                No resource groups defined yet. Click <strong>+ Add Group</strong>
                                to start, or click <strong>üîÑ Recalculate</strong> to load defaults.
                            </div>
                        </div>

                        <!-- ‚îÄ‚îÄ‚îÄ SECTION 2: Stretch Overrides ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                        <div style="background:white;border-radius:10px;
                                    border:1px solid #e5e7eb;overflow:hidden;">
                            <div style="background:#1B3B6F;color:white;padding:11px 18px;">
                                <span style="font-weight:700;font-size:0.9rem;">üîÄ Stretch Transition Overrides</span>
                                <div style="font-size:0.72rem;opacity:0.7;margin-top:2px;">
                                    Override the default buffer/lag for specific stretch-to-stretch transitions.
                                    Leave blank to use group default.</div>
                            </div>
                            <div id="stretchOverrideTable" style="padding:0;">
                                <div style="padding:16px 18px;color:#94a3b8;font-size:0.82rem;">
                                    Click üîÑ Recalculate to load transitions.</div>
                            </div>
                        </div>

                        <!-- ‚îÄ‚îÄ‚îÄ SECTION 3: Cure Lags ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                        <div style="background:white;border-radius:10px;
                                    border:1px solid #e5e7eb;overflow:hidden;">
                            <div style="background:#1B3B6F;color:white;padding:11px 18px;">
                                <span style="font-weight:700;font-size:0.9rem;">‚è± Layer Cure Lags (IRC / MoRTH)</span>
                                <div style="font-size:0.72rem;opacity:0.7;margin-top:2px;">
                                    Mandatory wait time between pavement layers (compaction, priming, tack coat).
                                    Edit to override IRC defaults for site conditions.</div>
                            </div>
                            <table style="width:100%;border-collapse:collapse;">
                                <thead>
                                    <tr style="background:#f8fafc;border-bottom:2px solid #e5e7eb;">
                                        <th style="padding:9px 12px;text-align:left;font-size:0.78rem;
                                                   color:#475569;font-weight:600;">After Layer</th>
                                        <th style="padding:9px 12px;text-align:left;font-size:0.78rem;
                                                   color:#475569;font-weight:600;">Before Layer</th>
                                        <th style="padding:9px 12px;text-align:center;font-size:0.78rem;
                                                   color:#475569;font-weight:600;width:140px;">Cure Lag (days)</th>
                                        <th style="padding:9px 12px;text-align:left;font-size:0.78rem;
                                                   color:#475569;font-weight:600;">IRC / MoRTH Reference</th>
                                    </tr>
                                </thead>
                                <tbody id="cureLagBody"></tbody>
                            </table>
                        </div>

                        <!-- ‚îÄ‚îÄ‚îÄ SECTION 4: Violation Log ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                        <div style="background:white;border-radius:10px;
                                    border:1px solid #e5e7eb;overflow:hidden;">
                            <div style="background:#991b1b;color:white;padding:11px 18px;
                                        display:flex;align-items:center;justify-content:space-between;">
                                <span style="font-weight:700;font-size:0.9rem;">‚ö†Ô∏è Violation Log</span>
                                <span id="violationBadge"
                                    style="background:#dc2626;color:white;padding:2px 10px;
                                           border-radius:12px;font-size:0.75rem;font-weight:700;">0</span>
                            </div>
                            <div id="violationLog" style="padding:12px 14px;">
                                <div style="padding:12px;text-align:center;color:#16a34a;
                                            font-weight:600;font-size:0.85rem;">
                                    ‚úÖ No violations detected. Click üîÑ Recalculate to analyse schedule.</div>
                            </div>
                        </div>

                        <!-- bottom spacer -->
                        <div style="height:20px;flex-shrink:0;"></div>
                    </div>
                </div>
            </div>
        </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                 TAB 11: BOQ & FINANCIALS
                 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="tab-panel" id="tab12" style="display:none!important;">
                <div class="content-container">

                    <!-- TOP ACTION BAR -->
                    <div class="section" style="margin-bottom:12px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;">
                            <div>
                                <div class="section-header" style="margin-bottom:4px;">üìã BOQ & Financials</div>
                                <div style="font-size:0.78rem;color:var(--text-secondary);">
                                    Define BOQ sections chainage-wise. BOQ items drive productivity tracking. 
                                    Linear items drive financial progress.
                                </div>
                            </div>
                            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                                <button class="btn-secondary" onclick="boqAddSection()" style="background:var(--accent-gold);color:#1B3B6F;font-weight:700;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">
                                    + Add Road Section
                                </button>
                                <button class="btn-secondary" onclick="boqAddStructureBOQ()" style="background:#1B3B6F;color:#fff;border:1px solid var(--accent-gold);padding:8px 16px;border-radius:6px;cursor:pointer;">
                                    üåâ Add Structure BOQ
                                </button>
                                <button onclick="boqGenerateWBS()" id="btnGenerateWBS" style="background:linear-gradient(135deg,#16a34a,#15803d);color:#fff;font-weight:700;border:none;padding:8px 18px;border-radius:6px;cursor:pointer;font-size:0.85rem;" title="Generate WBS & Activities from BOQ">
                                    ‚ö° Generate WBS & Schedule
                                </button>
                            </div>
                        </div>

                        <!-- BOQ SUMMARY BAR -->
                        <div id="old_boqSummaryBar" style="display:none;margin-top:12px;display:flex;gap:16px;flex-wrap:wrap;background:var(--bg-surface);border:1px solid var(--border-light);border-radius:8px;padding:10px 16px;">
                            <div style="text-align:center;">
                                <div style="font-size:1.1rem;font-weight:700;color:var(--navy);" id="old_boqTotalValue">‚Çπ0.00 Cr</div>
                                <div style="font-size:0.7rem;color:var(--text-secondary);">Total BOQ Value</div>
                            </div>
                            <div style="width:1px;background:var(--border-light);"></div>
                            <div style="text-align:center;">
                                <div style="font-size:1.1rem;font-weight:700;color:#16a34a;" id="old_boqEarnedValue">‚Çπ0.00 Cr</div>
                                <div style="font-size:0.7rem;color:var(--text-secondary);">Earned to Date</div>
                            </div>
                            <div style="width:1px;background:var(--border-light);"></div>
                            <div style="text-align:center;">
                                <div style="font-size:1.1rem;font-weight:700;color:var(--accent-gold);" id="old_boqFinancialPct">0.0%</div>
                                <div style="font-size:0.7rem;color:var(--text-secondary);">Financial Progress</div>
                            </div>
                            <div style="width:1px;background:var(--border-light);"></div>
                            <div style="text-align:center;">
                                <div style="font-size:1.1rem;font-weight:700;color:#dc2626;" id="old_boqBlockedValue">‚Çπ0.00 L</div>
                                <div style="font-size:0.7rem;color:var(--text-secondary);">Blocked by Hindrances</div>
                            </div>
                            <div style="width:1px;background:var(--border-light);"></div>
                            <div style="text-align:center;">
                                <div style="font-size:1.1rem;font-weight:700;color:#7c3aed;" id="old_boqDeviationCount">0</div>
                                <div style="font-size:0.7rem;color:var(--text-secondary);">Deviation Alerts</div>
                            </div>
                        </div>
                    </div>

                    <!-- BOQ SECTIONS LIST -->
                    <div id="boqSectionsList"></div>

                    <!-- EMPTY STATE -->
                    <div id="boqEmptyState" style="text-align:center;padding:60px 20px;color:var(--text-secondary);">
                        <div style="font-size:3rem;margin-bottom:12px;">üìã</div>
                        <div style="font-size:1rem;font-weight:600;margin-bottom:8px;color:var(--navy);">No BOQ sections defined yet</div>
                        <div style="font-size:0.82rem;margin-bottom:20px;">
                            Add road work sections chainage-wise, then add items.<br>
                            After all sections are complete, generate WBS & Schedule automatically.
                        </div>
                        <button onclick="boqAddSection()" style="background:var(--accent-gold);color:#1B3B6F;font-weight:700;border:none;padding:10px 24px;border-radius:6px;cursor:pointer;font-size:0.9rem;">
                            + Add First Section
                        </button>
                    </div>

                </div>
            </div><!-- end tab11 BOQ -->

    </div><!-- end main-content -->
    </div><!-- end app-container -->

    <script>
        // TAB 7: Activity Grid Functions - OPC Style
        
        // ===== VIEW MODE SWITCHING =====
        function switchViewMode(mode) {
            const tableSection = document.getElementById('activityTableSection');
            const chartSection = document.getElementById('chartSection');
            const ganttChart = document.getElementById('ganttChart');
            const linearChart = document.getElementById('linearChart');
            
            // Remove active state from all buttons
            document.querySelectorAll('.view-mode-btn').forEach(btn => btn.classList.remove('active'));
            
            // Reset displays
            tableSection.classList.remove('split-mode');
            chartSection.classList.remove('visible', 'full-width');
            ganttChart.style.display = 'none';
            linearChart.style.display = 'none';
            
            if (mode === 'full') {
                // Full Screen - Table only
                document.getElementById('viewBtnFull').classList.add('active');
                tableSection.style.display = 'flex';
                chartSection.style.display = 'none';
                
            } else if (mode === 'gantt') {
                // Table + Gantt (60/40 split)
                document.getElementById('viewBtnGantt').classList.add('active');
                tableSection.classList.add('split-mode');
                tableSection.style.display = 'flex';
                chartSection.classList.add('visible');
                chartSection.style.display = 'flex';
                ganttChart.style.display = 'flex';
                
            } else if (mode === 'linear') {
                // Table + Linear (60/40 split)
                document.getElementById('viewBtnLinear').classList.add('active');
                tableSection.classList.add('split-mode');
                tableSection.style.display = 'flex';
                chartSection.classList.add('visible');
                chartSection.style.display = 'flex';
                linearChart.style.display = 'flex';
                
            } else if (mode === 'ganttOnly') {
                // Gantt Only - Full width
                document.getElementById('viewBtnGanttOnly').classList.add('active');
                tableSection.style.display = 'none';
                chartSection.classList.add('visible', 'full-width');
                chartSection.style.display = 'flex';
                ganttChart.style.display = 'flex';
                
            } else if (mode === 'linearOnly') {
                // Linear Only - Full width
                document.getElementById('viewBtnLinearOnly').classList.add('active');
                tableSection.style.display = 'none';
                chartSection.classList.add('visible', 'full-width');
                chartSection.style.display = 'flex';
                linearChart.style.display = 'flex';
            }
        }
        
        // ===== ROW EXPAND/COLLAPSE =====
        function toggleRow(toggleElement) {
            const row = toggleElement.closest('tr');
            const rowId = row.dataset.id;
            const isExpanded = toggleElement.textContent === '‚ñº';
            
            // Toggle icon
            toggleElement.textContent = isExpanded ? '‚ñ∂' : '‚ñº';
            
            // Toggle children visibility
            const children = document.querySelectorAll(`tr[data-parent="${rowId}"]`);
            children.forEach(child => {
                if (isExpanded) {
                    child.style.display = 'none';
                    // Also collapse grandchildren
                    const childToggle = child.querySelector('.tree-toggle');
                    if (childToggle && childToggle.textContent === '‚ñº') {
                        childToggle.click();
                    }
                } else {
                    child.style.display = '';
                }
            });
        }
        
        function expandAllRows() {
            document.querySelectorAll('.tree-toggle').forEach(toggle => {
                if (toggle.textContent === '‚ñ∂') {
                    toggle.textContent = '‚ñº';
                }
            });
            document.querySelectorAll('#activityTableBody tr').forEach(row => {
                row.style.display = '';
            });
        }
        
        function collapseAllRows() {
            document.querySelectorAll('.tree-toggle').forEach(toggle => {
                if (toggle.textContent === '‚ñº') {
                    toggle.textContent = '‚ñ∂';
                }
            });
            // Hide all child rows (level 1 and 2)
            document.querySelectorAll('#activityTableBody tr[data-level="1"], #activityTableBody tr[data-level="2"]').forEach(row => {
                row.style.display = 'none';
            });
        }
        
        // ===== ROW SELECTION =====
        function selectRow(row) {
            // Remove previous selection
            document.querySelectorAll('#activityTableBody tr').forEach(r => {
                r.classList.remove('selected');
            });
            // Add selection to clicked row
            row.classList.add('selected');
            
            const activityId = row.dataset.id;
            console.log('Selected activity:', activityId);
            
            // TODO: Show activity detail panel
            // showActivityDetail(activityId);
        }
        
        // ===== ADD WBS/ACTIVITY MODAL (2-Step) =====
        let addModalStep = 1;
        let addModalType = null;
        
        function showAddModal() {
            addModalStep = 1;
            addModalType = null;
            
            const modalHTML = `
                <div id="addModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-width: 500px; width: 90%;">
                        <div style="padding: 20px 24px; border-bottom: 1px solid #e5e7eb;">
                            <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600; color: #111827;">Add to Activity Grid</h3>
                        </div>
                        
                        <div id="modalContent" style="padding: 24px;">
                            <div style="margin-bottom: 20px; font-size: 0.875rem; color: #6b7280;">
                                What do you want to add?
                            </div>
                            
                            <label style="display: flex; align-items: flex-start; padding: 16px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; margin-bottom: 12px; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#3b82f6';" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb';" onclick="selectAddType('wbs')">
                                <input type="radio" name="addType" value="wbs" style="margin-top: 2px; margin-right: 12px;">
                                <div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; margin-bottom: 4px;">WBS Level (Group)</div>
                                    <div style="font-size: 0.8125rem; color: #6b7280;">Add a phase, stretch, or section to organize activities</div>
                                </div>
                            </label>
                            
                            <label style="display: flex; align-items: flex-start; padding: 16px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#3b82f6';" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb';" onclick="selectAddType('activity')">
                                <input type="radio" name="addType" value="activity" style="margin-top: 2px; margin-right: 12px;">
                                <div>
                                    <div style="font-weight: 600; font-size: 0.9375rem; margin-bottom: 4px;">Activity (Work Item)</div>
                                    <div style="font-size: 0.8125rem; color: #6b7280;">Add an actual work task with resources and duration</div>
                                </div>
                            </label>
                        </div>
                        
                        <div style="padding: 16px 24px; background: #f9fafb; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 12px; border-radius: 0 0 8px 8px;">
                            <button onclick="closeAddModal()" style="padding: 8px 16px; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">Cancel</button>
                            <button id="modalNextBtn" onclick="addModalNext()" disabled style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500; opacity: 0.5;">Next ‚Üí</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function selectAddType(type) {
            addModalType = type;
            document.getElementById('modalNextBtn').disabled = false;
            document.getElementById('modalNextBtn').style.opacity = '1';
        }
        
        function addModalNext() {
            if (addModalStep === 1 && addModalType) {
                addModalStep = 2;
                showAddModalStep2();
            }
        }
        
        function showAddModalStep2() {
            const modalContent = document.getElementById('modalContent');
            
            if (addModalType === 'wbs') {
                modalContent.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 6px;">Parent WBS</label>
                        <select style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
                            <option value="">Root Level</option>
                            <option value="1.0">1.0 - PHASE 1 - IMMEDIATE WORK</option>
                            <option value="2.0">2.0 - STRUCTURES (Parallel)</option>
                            <option value="3.0">3.0 - PHASE 3 - HINDRANCE DEPENDENT</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 6px;">WBS Code</label>
                        <input type="text" placeholder="e.g., 1.3" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;" disabled value="Auto-generated">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 6px;">WBS Name <span style="color: #ef4444;">*</span></label>
                        <input type="text" placeholder="e.g., Stretch 3" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 8px;">Type</label>
                        <div style="display: flex; gap: 12px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="wbsType" value="phase" checked style="margin-right: 6px;">
                                <span style="font-size: 0.875rem;">Phase</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="wbsType" value="stretch" style="margin-right: 6px;">
                                <span style="font-size: 0.875rem;">Stretch</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="wbsType" value="section" style="margin-right: 6px;">
                                <span style="font-size: 0.875rem;">Section</span>
                            </label>
                        </div>
                    </div>
                `;
            } else {
                // Activity form
                modalContent.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 6px;">Parent WBS <span style="color: #ef4444;">*</span></label>
                        <select style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
                            <option value="">Select parent...</option>
                            <option value="1.1">1.1 - Stretch 1</option>
                            <option value="1.2">1.2 - Stretch 2</option>
                            <option value="2.1">2.1 - Box Culvert Ch 2+450</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 6px;">Activity Name <span style="color: #ef4444;">*</span></label>
                        <input type="text" placeholder="e.g., WMM Paving" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 6px;">Quantity</label>
                            <input type="number" placeholder="0" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 6px;">Unit</label>
                            <select style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
                                <option>Cum</option>
                                <option>Sqm</option>
                                <option>RM</option>
                                <option>MT</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 6px;">Resource (from Tab 6)</label>
                        <select style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
                            <option value="">Select resource...</option>
                            <option>Excavator</option>
                            <option>Grader</option>
                            <option>Paver</option>
                            <option>Roller</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 8px;">Duration Calculation</label>
                        <div style="display: flex; gap: 12px; margin-bottom: 8px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="durationType" value="auto" checked style="margin-right: 6px;">
                                <span style="font-size: 0.875rem;">Auto-calculate from productivity</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="durationType" value="manual" style="margin-right: 6px;">
                                <span style="font-size: 0.875rem;">Manual</span>
                            </label>
                        </div>
                        <input type="number" placeholder="Days" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;" disabled>
                    </div>
                `;
            }
            
            // Update footer buttons
            const modalFooter = document.querySelector('#addModal > div > div:last-child');
            modalFooter.innerHTML = `
                <button onclick="addModalBack()" style="padding: 8px 16px; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">‚Üê Back</button>
                <button onclick="closeAddModal()" style="padding: 8px 16px; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">Cancel</button>
                <button onclick="submitAdd()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">Add ${addModalType === 'wbs' ? 'WBS' : 'Activity'}</button>
            `;
        }
        
        function addModalBack() {
            addModalStep = 1;
            showAddModal();
            closeAddModal();
            showAddModal();
        }
        
        function submitAdd() {
            showToast('‚úÖ Item will be added to WBS', 'success');
            closeAddModal();
        }
        
        function closeAddModal() {
            const modal = document.getElementById('addModal');
            if (modal) modal.remove();
        }
        
        // ===== OTHER FUNCTIONS =====
        function generateWBS() {
            KALYANTRA.refresh();
            KALYANTRA.render.wbsTable();
            updateWBSStatBar();
            KALYANTRA.save();
            showToast('‚úÖ WBS generated and saved', 'success');
        }
        function showColumnsPanel() {
            showToast('üìä Column configuration coming in V7.0', 'info');
        }
        
    </script>

    <script>
        // Main tab switching
        function switchMainTab(index) {
            // ID-based tab switching ‚Äî immune to DOM order changes
            const TAB_ID_MAP = {
                0:'tab1', 1:'tab2', 2:'tab3', 3:'tab4',
                4:'tab5', 5:'tab6', 6:'tab7boq',
                7:'tab8', 8:'tab9', 9:'tab10', 10:'tab11', 11:'tabConstraints',
                12:'tabBaseline', 13:'tabScenarios', 14:'tabAlerts', 15:'tabEarnedValue'
            };
            // Hide ALL tab panels
            document.querySelectorAll('.tab-panel').forEach(p => {
                p.classList.remove('active');
                if (p.id === 'tab7boq') p.style.display = 'none';
            });
            // Show target panel
            const targetId = TAB_ID_MAP[index];
            if (targetId) {
                const panel = document.getElementById(targetId);
                if (panel) {
                    if (targetId === 'tab7boq') {
                        panel.style.display = 'flex';
                    } else {
                        panel.classList.add('active');
                    }
                }
            }
            // Update sidebar active state via data-tab
            document.querySelectorAll('.sidebar-item').forEach(item => {
                const dt = parseInt(item.getAttribute('data-tab') || '-1');
                if (dt === index) item.classList.add('active');
                else item.classList.remove('active');
            });
        }
        
        // Resource selection and detail generation
        function selectResource(row, index) {
            // Highlight selected row
            const allRows = document.querySelectorAll('#resourceTable tr');
            allRows.forEach(r => r.style.background = '');
            row.style.background = 'rgba(59, 130, 246, 0.05)';
            
            // Generate detail content
            document.getElementById('resourceDetailContent').innerHTML = generateResourceDetails(index);
        }
        
        function generateResourceDetails(index) {
            const resources = [
                { type: 'Excavator', capacity: '1.6 Cum bucket', color: '#1e40af' },
                { type: 'Motor Grader', capacity: 'CAT 140 / 12ft blade', color: '#059669' },
                { type: 'Sensor Paver', capacity: 'AP615 / 6m width', color: '#dc2626' }
            ];
            const resource = resources[index];
            
            return `
                <div style="border-bottom: 3px solid ${resource.color}; padding-bottom: 15px; margin-bottom: 20px;">
                    <div style="font-size: 1.3rem; font-weight: 700; color: ${resource.color};">${resource.type}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">${resource.capacity}</div>
                </div>
                
                <div class="component-section">
                    <div class="component-header" style="background: rgba(59, 130, 246, 0.05);">1. CAPACITY & SPECIFICATIONS</div>
                    <div class="form-group">
                        <label class="form-label">Standard Capacity</label>
                        <input type="text" class="form-input" value="${resource.capacity}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" rows="2" placeholder="Additional specifications"></textarea>
                    </div>
                </div>
                
                <div class="component-section" style="background: rgba(212, 175, 55, 0.05); border-left: 4px solid var(--accent-gold);">
                    <div class="component-header">2. PRODUCTIVITY RATES ‚≠ê (Activity-Based)</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;">
                        Define output rates for different activities. System uses these in Tab 7 for duration calculation.
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-success btn-sm" onclick="addProductivityRate()">+ Add Activity Rate</button>
                    </div>
                    
                    <div id="productivityRatesList">
                        <div style="background: white; border: 1px solid var(--border-light); border-radius: 4px; padding: 12px; margin-bottom: 8px;">
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 8px; align-items: center;">
                                <div>
                                    <select class="form-select" style="font-size: 0.85rem;">
                                        <option>Soil Excavation</option>
                                        <option>Ordinary Rock</option>
                                        <option>Hard Rock</option>
                                    </select>
                                </div>
                                <div>
                                    <input type="number" class="form-input" value="62.71" step="0.01" style="font-size: 0.85rem;">
                                </div>
                                <div>
                                    <select class="form-select" style="font-size: 0.85rem;">
                                        <option>Cum/Hr</option>
                                        <option>Sqm/Hr</option>
                                        <option>TPH</option>
                                    </select>
                                </div>
                                <div>
                                    <button class="btn btn-secondary btn-sm" style="padding: 4px 8px; font-size: 0.75rem;">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="component-section" style="background: rgba(139, 92, 246, 0.05); border-left: 4px solid #8b5cf6;">
                    <div class="component-header">3. OUTPUT CALCULATION (Per Day)</div>
                    <div style="background: white; border-radius: 6px; padding: 15px; border: 1px solid var(--border-light);">
                        <div style="font-size: 0.85rem; margin-bottom: 12px;">
                            <strong>Calculation Logic:</strong> Output/Day = Productivity Rate √ó Working Hours
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Productivity Rate</div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: #3b82f6;">62.71</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">Cum/Hr</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Working Hours</div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: #8b5cf6;">8</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">hrs/day (Tab 5)</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Output per Day</div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: #22c55e;">501.68</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">Cum/day</div>
                            </div>
                        </div>
                        <div style="padding: 10px; background: rgba(34, 197, 94, 0.05); border-radius: 4px; font-size: 0.8rem; border-left: 3px solid #22c55e;">
                            <strong>Example:</strong> 1 Excavator working 8 hours = 501.68 Cum/day<br>
                            For 5,000 Cum job: Need 5,000 / 501.68 = <strong>10 days</strong> (with 1 unit)
                        </div>
                    </div>
                </div>
                
                <div class="component-section" style="background: rgba(34, 197, 94, 0.05); border-left: 4px solid #22c55e;">
                    <div class="component-header">4. CALENDAR MAPPING</div>
                    <div style="background: white; border-radius: 6px; padding: 15px; border: 1px solid var(--border-light);">
                        <div style="font-size: 0.85rem; margin-bottom: 12px;">
                            <strong>Linked to Tab 5 (Calendar):</strong>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="padding: 10px; background: rgba(59, 130, 246, 0.05); border-radius: 4px;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Working Days/Week</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #3b82f6;">6 days</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">Mon-Sat (from Calendar)</div>
                            </div>
                            <div style="padding: 10px; background: rgba(239, 68, 68, 0.05); border-radius: 4px;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Monsoon Impact</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #ef4444;">32 days</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">No work period</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: rgba(251, 191, 36, 0.05); border-radius: 4px; font-size: 0.8rem; border-left: 3px solid #f59e0b;">
                            <strong>üí° Smart Calculation:</strong> Activity Grid (Tab 7) automatically accounts for weekends, holidays, and monsoon when calculating completion dates
                        </div>
                    </div>
                </div>
                
                <div class="component-section">
                    <div class="component-header">5. REQUIREMENT (From Activity Grid)</div>
                    <div style="background: white; border-radius: 6px; padding: 15px; border: 1px solid var(--border-light);">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;">
                            After activities are defined in Tab 7, requirements will be calculated automatically:
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="text-align: center; padding: 15px; background: rgba(59, 130, 246, 0.05); border-radius: 6px;">
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px;">Peak Demand</div>
                                <div style="font-size: 2rem; font-weight: 700; color: #3b82f6;">-</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 3px;">Max units at any time</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(139, 92, 246, 0.05); border-radius: 6px;">
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px;">Total Equipment-Days</div>
                                <div style="font-size: 2rem; font-weight: 700; color: #8b5cf6;">-</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 3px;">Total utilization</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" style="width: 100%; margin-top: 20px;">Save Resource Type</button>
            `;
        }
        
        // Resource sub-tab switching
        function switchResourceTab(index) {
            const tabs = document.querySelectorAll('#tab6 .detail-tab');
            const subtabs = document.querySelectorAll('.resource-subtab');
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                    subtabs[i].style.display = 'block';
                } else {
                    tab.classList.remove('active');
                    subtabs[i].style.display = 'none';
                }
            });
        }
        
        // Equipment-specific activity mapping (SMART FILTERING!)
        const equipmentActivities = {
            0: [ // Excavator
                { code: 'EXCV-SOIL', name: 'Soil Excavation', rate: 62.71, unit: 'Cum/Hr' },
                { code: 'EXCV-OR', name: 'Ordinary Rock', rate: 20.90, unit: 'Cum/Hr' },
                { code: 'EXCV-HR', name: 'Hard Rock', rate: 15.68, unit: 'Cum/Hr' }
            ],
            1: [ // Motor Grader
                { code: 'GRADER-EMB', name: 'Embankment Grading', rate: 130.89, unit: 'Cum/Hr' },
                { code: 'GRADER-SG', name: 'Subgrade Grading', rate: 130.89, unit: 'Cum/Hr' },
                { code: 'GRADER-GSB', name: 'GSB Grading', rate: 76.99, unit: 'Cum/Hr' },
                { code: 'GRADER-WMM', name: 'WMM Grading', rate: 48.12, unit: 'Cum/Hr' }
            ],
            2: [ // Sensor Paver
                { code: 'PAVER-WMM', name: 'WMM Paving', rate: 96, unit: 'Cum/Hr' },
                { code: 'PAVER-BM', name: 'BM Paving', rate: 42, unit: 'Cum/Hr' },
                { code: 'PAVER-DBM', name: 'DBM Paving', rate: 42, unit: 'Cum/Hr' },
                { code: 'PAVER-BC', name: 'BC Paving', rate: 30, unit: 'Cum/Hr' }
            ],
            3: [ // Vibratory Roller
                { code: 'VIBRO-EMB', name: 'Embankment Compaction', rate: 143.78, unit: 'Cum/Hr' },
                { code: 'VIBRO-SG', name: 'Subgrade Compaction', rate: 143.78, unit: 'Cum/Hr' },
                { code: 'VIBRO-GSB', name: 'GSB Compaction', rate: 95.85, unit: 'Cum/Hr' },
                { code: 'VIBRO-WMM', name: 'WMM Compaction', rate: 48.12, unit: 'Cum/Hr' },
                { code: 'VIBRO-SHLD', name: 'Shoulders Compaction', rate: 143.78, unit: 'Cum/Hr' }
            ],
            4: [ // Tipper
                { code: 'TIPP10-EMBRW', name: 'Embankment Hauling (RW)', rate: 18.36, unit: 'Cum/Hr' },
                { code: 'TIPP10-EMBBR', name: 'Embankment Hauling (Borrow)', rate: 6.57, unit: 'Cum/Hr' },
                { code: 'TIPP10-GSB', name: 'GSB Hauling', rate: 4.19, unit: 'Cum/Hr' },
                { code: 'TIPP10-WMM', name: 'WMM Hauling', rate: 4.07, unit: 'Cum/Hr' },
                { code: 'TIPP10-BC', name: 'Bituminous Hauling', rate: 4.03, unit: 'Cum/Hr' }
            ]
        };
        
        // Equipment selection and detail generation
        function selectEquipment(row, index) {
            const allRows = document.querySelectorAll('#equipmentTable tr');
            allRows.forEach(r => r.style.background = '');
            row.style.background = 'rgba(59, 130, 246, 0.05)';
            
            document.getElementById('equipmentDetailContent').innerHTML = generateEquipmentDetails(index);
        }
        
        function generateEquipmentDetails(index) {
            // U-12: Look up real equipment from data model if available
            const realEquip = KALYANTRA.data.resources.equipment[index] || {};
            const equipment = [
                { type: 'Excavator', capacity: '1.6 Cum bucket', color: '#1e40af' },
                { type: 'Motor Grader', capacity: 'CAT 140 / 12ft blade', color: '#059669' },
                { type: 'Sensor Paver', capacity: 'AP615 / 6m width', color: '#dc2626' },
                { type: 'Vibratory Roller', capacity: '10-12 Ton', color: '#7c3aed' },
                { type: 'Tipper', capacity: '10 Ton', color: '#ea580c' }
            ][index];
            
            const activities = equipmentActivities[index] || [];
            const activityDropdown = activities.map(a => 
                `<option value="${a.code}" data-rate="${a.rate}" data-unit="${a.unit}">${a.name}</option>`
            ).join('');
            
            const firstActivity = activities[0] || { rate: 0, unit: 'Cum/Hr' };
            const outputPerDay = (firstActivity.rate * 8).toFixed(2);
            
            return `
                <div style="border-bottom: 3px solid ${equipment.color}; padding-bottom: 15px; margin-bottom: 20px;">
                    <div style="font-size: 1.3rem; font-weight: 700; color: ${equipment.color};">${equipment.type}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">${equipment.capacity}</div>
                </div>
                
                <div class="component-section">
                    <div class="component-header" style="background: rgba(59, 130, 246, 0.05);">1. CAPACITY</div>
                    <div class="form-group">
                        <label class="form-label">Standard Capacity</label>
                        <input type="text" class="form-input" value="${equipment.capacity}" style="font-size: 0.9rem;">
                    </div>
                </div>
                
                <div class="component-section" style="background: rgba(212, 175, 55, 0.05); border-left: 4px solid var(--accent-gold);">
                    <div class="component-header">2. PRODUCTIVITY RATES ‚≠ê</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 12px;">
                        Only ${equipment.type}-specific activities shown
                    </div>
                    
                    <div id="activityRatesList-${index}">
                        <div style="background: white; border: 1px solid var(--border-light); border-radius: 4px; padding: 10px; margin-bottom: 10px;">
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 8px;">
                                <select class="form-select activity-dropdown" style="font-size: 0.85rem;" onchange="updateActivityRate(this)">
                                    ${activityDropdown}
                                </select>
                                <input type="number" class="form-input rate-input" value="${firstActivity.rate}" step="0.01" style="font-size: 0.85rem;">
                                <select class="form-select unit-select" style="font-size: 0.85rem;">
                                    <option>${firstActivity.unit}</option>
                                </select>
                                <button class="btn btn-secondary btn-sm" onclick="this.parentElement.parentElement.remove()" style="padding: 4px 8px; font-size: 0.75rem;">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-success btn-sm" style="font-size: 0.8rem;" onclick="addActivityRate(${index})">+ Add Activity</button>
                </div>
                
                <div class="component-section" style="background: rgba(139, 92, 246, 0.05);">
                    <div class="component-header">3. OUTPUT/DAY</div>
                    <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid var(--border-light);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">Rate</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #3b82f6;">${firstActivity.rate}</div>
                                <div style="font-size: 0.65rem;">${firstActivity.unit}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">Hours</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #8b5cf6;">8</div>
                                <div style="font-size: 0.65rem;">hrs/day</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">Output</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #22c55e;">${outputPerDay}</div>
                                <div style="font-size: 0.65rem;">Cum/day</div>
                            </div>
                        </div>
                        <div style="padding: 8px; background: rgba(34, 197, 94, 0.05); border-radius: 4px; font-size: 0.75rem;">
                            <strong>Example:</strong> 5,000 Cum job = ${(5000 / parseFloat(outputPerDay)).toFixed(1)} days (1 unit)
                        </div>
                    </div>
                </div>
                
                <div class="component-section" style="background: rgba(34, 197, 94, 0.05);">
                    <div class="component-header">4. CALENDAR MAPPING ‚≠ê</div>
                    <div class="form-group">
                        <label class="form-label">Select Calendar for this Equipment</label>
                        <select class="form-select" style="font-size: 0.9rem;">
                            <option value="main">Main Project Calendar (6 days/week, 8 hrs/day)</option>
                            <option value="247">24√ó7 Calendar (Crusher/Batching Plant)</option>
                            <option value="2shift">2-Shift Calendar (Mon-Sun, 16 hrs/day)</option>
                            <option value="custom">Custom Calendar</option>
                        </select>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;">
                            üí° Different equipment can work different schedules
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div style="padding: 10px; background: white; border-radius: 4px; text-align: center;">
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">Working Days</div>
                            <div style="font-size: 1.2rem; font-weight: 700; color: #3b82f6;">6/week</div>
                        </div>
                        <div style="padding: 10px; background: white; border-radius: 4px; text-align: center;">
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">Monsoon</div>
                            <div style="font-size: 1.2rem; font-weight: 700; color: #ef4444;">32 days</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" style="width: 100%; margin-top: 15px; font-size: 0.9rem;">Save Equipment</button>
            `;
        }
        
        function updateActivityRate(select) {
            const option = select.options[select.selectedIndex];
            const rate = option.dataset.rate;
            const unit = option.dataset.unit;
            const rateInput = select.parentElement.querySelector('.rate-input');
            const unitSelect = select.parentElement.querySelector('.unit-select');
            if (rateInput) rateInput.value = rate;
            if (unitSelect) unitSelect.value = unit;
        }
        
        // Add new activity rate row
        // FIX-SEC6: addProductivityRate was called but never defined
        function addProductivityRate() { addActivityRate(null); }

        function addActivityRate(equipmentIndex) {
            const container = document.getElementById(`activityRatesList-${equipmentIndex}`);
            const activities = equipmentActivities[equipmentIndex] || [];
            const activityDropdown = activities.map(a => 
                `<option value="${a.code}" data-rate="${a.rate}" data-unit="${a.unit}">${a.name}</option>`
            ).join('');
            
            const newRow = document.createElement('div');
            newRow.style.cssText = 'background: white; border: 1px solid var(--border-light); border-radius: 4px; padding: 10px; margin-bottom: 10px;';
            newRow.innerHTML = `
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 8px;">
                    <select class="form-select activity-dropdown" style="font-size: 0.85rem;" onchange="updateActivityRate(this)">
                        ${activityDropdown}
                    </select>
                    <input type="number" class="form-input rate-input" value="${activities[0]?.rate || 0}" step="0.01" style="font-size: 0.85rem;">
                    <select class="form-select unit-select" style="font-size: 0.85rem;">
                        <option>${activities[0]?.unit || 'Cum/Hr'}</option>
                    </select>
                    <button class="btn btn-secondary btn-sm" onclick="this.parentElement.parentElement.remove()" style="padding: 4px 8px; font-size: 0.75rem;">üóëÔ∏è</button>
                </div>
            `;
            container.appendChild(newRow);
        }
        
        // Manpower functions
        function selectManpower(row, index) {
            const allRows = document.querySelectorAll('#manpowerTable tr');
            allRows.forEach(r => r.style.background = '');
            row.style.background = 'rgba(59, 130, 246, 0.05)';
            
            const labor = [
                { type: 'Mason', category: 'Skilled', color: '#1e40af', productivity: '10 Sqm/day' },
                { type: 'Steel Fixer', category: 'Skilled', color: '#059669', productivity: '50 Kg/day' },
                { type: 'Unskilled Labor', category: 'Unskilled', color: '#f59e0b', productivity: '5 Cum/day' }
            ][index];
            
            document.getElementById('manpowerDetailContent').innerHTML = `
                <div style="border-bottom: 3px solid ${labor.color}; padding-bottom: 15px; margin-bottom: 20px;">
                    <div style="font-size: 1.3rem; font-weight: 700; color: ${labor.color};">${labor.type}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">${labor.category}</div>
                </div>
                
                <div class="component-section" style="background: rgba(59, 130, 246, 0.05);">
                    <div class="component-header">1. LABOR CATEGORY</div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-select">
                            <option>Skilled</option>
                            <option>Semi-Skilled</option>
                            <option>Unskilled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Specialization (for Skilled)</label>
                        <input type="text" class="form-input" placeholder="e.g., Masonry, Steel Fixing, Carpentry">
                    </div>
                </div>
                
                <div class="component-section" style="background: rgba(212, 175, 55, 0.05); border-left: 4px solid var(--accent-gold);">
                    <div class="component-header">2. CALCULATION METHOD ‚≠ê</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;">
                        Choose how to calculate labor requirement:
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: start; gap: 10px; padding: 12px; background: white; border: 2px solid var(--border-light); border-radius: 6px; cursor: pointer;">
                            <input type="radio" name="laborCalc" value="activity" checked>
                            <div>
                                <div style="font-weight: 600; color: var(--primary-navy); margin-bottom: 5px;">
                                    üìã Activity-Based (User Selection)
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                    User manually selects required labor for each activity. System totals labor-days.
                                </div>
                                <div style="margin-top: 8px; padding: 8px; background: rgba(59, 130, 246, 0.05); border-radius: 4px; font-size: 0.75rem;">
                                    <strong>Example:</strong> Concrete Pour activity<br>
                                    User selects: 2 Mason + 4 Unskilled √ó 5 days = 30 labor-days
                                </div>
                            </div>
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: start; gap: 10px; padding: 12px; background: white; border: 2px solid var(--border-light); border-radius: 6px; cursor: pointer;">
                            <input type="radio" name="laborCalc" value="capacity">
                            <div>
                                <div style="font-weight: 600; color: var(--primary-navy); margin-bottom: 5px;">
                                    ‚öôÔ∏è Capacity-Based (System Calculation)
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                    Define labor productivity. System calculates required labor based on quantity.
                                </div>
                                <div style="margin-top: 8px; padding: 8px; background: rgba(139, 92, 246, 0.05); border-radius: 4px; font-size: 0.75rem;">
                                    <strong>Example:</strong> Mason productivity = 10 Sqm/day<br>
                                    Activity = 100 Sqm in 5 days ‚Üí Need 2 Masons
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="component-section" style="background: rgba(139, 92, 246, 0.05);">
                    <div class="component-header">3. PRODUCTIVITY (For Capacity-Based)</div>
                    <div class="form-group">
                        <label class="form-label">Standard Productivity</label>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                            <input type="number" class="form-input" value="${labor.productivity.split(' ')[0]}" step="0.1">
                            <select class="form-select">
                                <option>Sqm/day</option>
                                <option>Cum/day</option>
                                <option>Kg/day</option>
                                <option>MT/day</option>
                                <option>RM/day</option>
                            </select>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;">
                            Used when "Capacity-Based" method selected in Tab 7
                        </div>
                    </div>
                </div>
                
                <div class="component-section" style="background: rgba(34, 197, 94, 0.05);">
                    <div class="component-header">4. REQUIREMENT (From Tab 7)</div>
                    <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid var(--border-light);">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;">
                            Requirements calculated based on activities in Tab 7:
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="text-align: center; padding: 12px; background: rgba(59, 130, 246, 0.05); border-radius: 6px;">
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">Peak Demand</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">-</div>
                                <div style="font-size: 0.65rem; color: var(--text-secondary);">Max at any time</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(139, 92, 246, 0.05); border-radius: 6px;">
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">Total Labor-Days</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #8b5cf6;">-</div>
                                <div style="font-size: 0.65rem; color: var(--text-secondary);">Total required</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" style="width: 100%; margin-top: 15px; font-size: 0.9rem;">Save Labor Type</button>
            `;
        }
        
        // Material functions
        function selectMaterial(row, index) {
            const allRows = document.querySelectorAll('#materialTable tr');
            allRows.forEach(r => r.style.background = '');
            row.style.background = 'rgba(59, 130, 246, 0.05)';
            
            const material = [
                { type: 'Cement', unit: 'Bags / Tons', color: '#1e40af' },
                { type: 'Steel (TMT)', unit: 'Kg / Tons', color: '#dc2626' },
                { type: 'Aggregate 20mm', unit: 'Cum', color: '#6b7280' },
                { type: 'Bitumen VG30', unit: 'Tons', color: '#0891b2' }
            ][index];
            
            document.getElementById('materialDetailContent').innerHTML = `
                <div style="border-bottom: 3px solid ${material.color}; padding-bottom: 15px; margin-bottom: 20px;">
                    <div style="font-size: 1.3rem; font-weight: 700; color: ${material.color};">${material.type}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">${material.unit}</div>
                </div>
                
                <div class="component-section">
                    <div class="component-header">Material Info</div>
                    <div class="form-group">
                        <label class="form-label">Unit of Measurement</label>
                        <input type="text" class="form-input" value="${material.unit}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Requirement Source</label>
                        <select class="form-select">
                            <option>From Activity Grid (Tab 7)</option>
                            <option>Manual Entry</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn btn-primary" style="width: 100%; margin-top: 15px;">Save Material</button>
            `;
        }
        
        // Add functions
        function addPlantMachinery() {
            const table = document.getElementById('equipmentTable');
            const rowCount = table.rows.length + 1;
            const equipId = 'EQ-' + String(rowCount).padStart(3, '0');
            const newRow = table.insertRow();
            newRow.style.cursor = 'pointer';
            newRow.setAttribute('data-equip-id', equipId);
            newRow.onclick = function() { selectEquipment(this, rowCount - 1); };
            newRow.innerHTML = `
                <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                <td><strong>${rowCount}</strong></td>
                <td><strong style="color: #1B3B6F;">${equipId}</strong></td>
                <td><input type="text" class="form-input" placeholder="e.g. Excavator 21T" style="font-size: 0.85rem; padding: 4px;" onchange="updateEquipmentData(this, '${equipId}', 'type')"></td>
                <td><input type="text" class="form-input" placeholder="Capacity" style="font-size: 0.85rem; padding: 4px;" onchange="updateEquipmentData(this, '${equipId}', 'capacity')"></td>
                <td><input type="number" class="form-input" placeholder="1" min="1" style="font-size: 0.85rem; padding: 4px; width: 60px;" onchange="updateEquipmentData(this, '${equipId}', 'count')"></td>
                <td><span style="color: #f59e0b;">‚äô</span></td>
            `;
            // Add to KALYANTRA.data.resources
            KALYANTRA.data.resources.equipment.push({ id: equipId, type: 'New Equipment', capacity: '', count: 1 });
            selectEquipment(newRow, rowCount - 1);
            showToast('üöú Equipment added (' + KALYANTRA.data.resources.equipment.length + ' total)', 'success');
        }
        
        function updateEquipmentData(input, equipId, field) {
            const item = KALYANTRA.data.resources.equipment.find(e => e.id === equipId);
            if (item) {
                item[field] = field === 'count' ? parseInt(input.value) || 1 : input.value;
                console.log('üì¶ Equipment updated:', item);
            }
        }
        
        function addManpower() {
            const table = document.getElementById('manpowerTable') || document.querySelector('[id*="manpower"]');
            const roleId = 'MP-' + String(Date.now()).slice(-4);
            // Add to KALYANTRA.data.resources
            const newItem = { id: roleId, role: 'New Labor Type', count: 1, ratePerDay: 0 };
            KALYANTRA.data.resources.manpower.push(newItem);
            // Insert row into whatever manpower table exists
            if (table) {
                const newRow = table.insertRow ? table.insertRow() : null;
                if (newRow) {
                    newRow.innerHTML = `<td>${KALYANTRA.data.resources.manpower.length}</td>
                        <td><input type="text" class="form-input" placeholder="e.g. Operator, Mason" value="New Labor Type" 
                            onchange="KALYANTRA.data.resources.manpower[KALYANTRA.data.resources.manpower.length-1].role=this.value" style="font-size:0.85rem;padding:4px;"></td>
                        <td><input type="number" class="form-input" placeholder="1" value="1"
                            onchange="KALYANTRA.data.resources.manpower[KALYANTRA.data.resources.manpower.length-1].count=parseInt(this.value)||1" style="font-size:0.85rem;padding:4px;width:70px;"></td>
                        <td><input type="number" class="form-input" placeholder="Rate/day (‚Çπ)" value="0"
                            onchange="KALYANTRA.data.resources.manpower[KALYANTRA.data.resources.manpower.length-1].ratePerDay=parseFloat(this.value)||0" style="font-size:0.85rem;padding:4px;width:100px;"></td>
                        <td><button class="btn btn-sm" onclick="this.closest('tr').remove(); KALYANTRA.data.resources.manpower.pop();">‚úï</button></td>`;
                }
            }
            showToast('üë∑ Labor type added (' + KALYANTRA.data.resources.manpower.length + ' total)', 'success');
        }
        
        function addMaterial() {
            const matId = 'MAT-' + String(Date.now()).slice(-4);
            const newItem = { id: matId, name: 'New Material', unit: 'Cum', rate: 0 };
            KALYANTRA.data.resources.materials.push(newItem);
            const table = document.getElementById('materialTable') || document.querySelector('[id*="material"]');
            if (table) {
                const tbody = table.querySelector('tbody') || table;
                const newRow = tbody.insertRow ? tbody.insertRow() : null;
                if (newRow) {
                    const idx = KALYANTRA.data.resources.materials.length - 1;
                    newRow.innerHTML = `<td>${KALYANTRA.data.resources.materials.length}</td>
                        <td><input type="text" class="form-input" placeholder="Material name" value="New Material"
                            onchange="KALYANTRA.data.resources.materials[${idx}].name=this.value" style="font-size:0.85rem;padding:4px;"></td>
                        <td><select class="form-select" style="font-size:0.85rem;padding:4px;"
                            onchange="KALYANTRA.data.resources.materials[${idx}].unit=this.value">
                            <option>Cum</option><option>MT</option><option>Sqm</option><option>Rmt</option><option>Nos</option></select></td>
                        <td><input type="number" class="form-input" placeholder="Rate/unit ‚Çπ" value="0"
                            onchange="KALYANTRA.data.resources.materials[${idx}].rate=parseFloat(this.value)||0" style="font-size:0.85rem;padding:4px;width:100px;"></td>
                        <td><button class="btn btn-sm" onclick="this.closest('tr').remove(); KALYANTRA.data.resources.materials.splice(${idx},1);">‚úï</button></td>`;
                }
            }
            showToast('üß± Material added (' + KALYANTRA.data.resources.materials.length + ' total)', 'success');
        }
        
        // Detail tab switching (for Tab 3)
        function switchDetailTab(index) {
            const tabs = document.querySelectorAll('.detail-tab');
            const contents = document.querySelectorAll('.detail-tab-content');
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                    if (contents[i]) contents[i].classList.add('active');
                } else {
                    tab.classList.remove('active');
                    if (contents[i]) contents[i].classList.remove('active');
                }
            });
        }
        
        // Tab 1 Functions
        function calculateLength() {
            const startKm = parseInt(document.getElementById('startKm').value || 0);
            const startM = parseInt(document.getElementById('startM').value || 0);
            const endKm = parseInt(document.getElementById('endKm').value || 0);
            const endM = parseInt(document.getElementById('endM').value || 0);
            const totalKm = (endKm + endM/1000) - (startKm + startM/1000);
            document.getElementById('totalLength').value = totalKm.toFixed(3) + ' km';
        }
        
        function calculateCompletion() {
            const appointed = document.getElementById('appointedDate').value;
            const duration = document.getElementById('duration').value;
            if (appointed && duration) {
                const date = new Date(appointed);
                date.setMonth(date.getMonth() + parseInt(duration));
                // L-02 / U-06: Also write to data model
                const durMonths = parseInt(duration) || 0;
                if (durMonths > 0) {
                    KALYANTRA.data.project.duration = durMonths * 30; // approx working days
                    const endDateStr = date.toISOString().split('T')[0];
                    KALYANTRA.data.project.endDate = endDateStr;
                }
                document.getElementById('completionDate').value = date.toLocaleDateString('en-GB');
            }
            // Recalculate financial milestones when appointed date changes
            recalculateFinancialMilestones();
        }
        
        let physicalCount = 1;
        function addPhysicalMilestone() {
            physicalCount++;
            const tbody = document.getElementById('physicalMilestones');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${physicalCount}</td>
                <td><input type="date"></td>
                <td><input type="number" placeholder="50"></td>
                <td><input type="number" placeholder="12"></td>
                <td><input type="text" placeholder="Milestone ${physicalCount}"></td>
                <td><button class="btn btn-sm btn-secondary" onclick="deleteRow(this)">Delete</button></td>
            `;
        }
        
        let financialCount = 1;
        function addFinancialMilestone() {
            financialCount++;
            const tbody = document.getElementById('financialMilestones');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${financialCount}</td>
                <td><input type="number" placeholder="365" onchange="recalculateFinancialMilestones()"></td>
                <td><input type="number" placeholder="50" step="0.01" onchange="recalculateFinancialMilestones()"></td>
                <td><input type="text" class="readonly-calc" placeholder="Auto-calculated" readonly style="background: rgba(212, 175, 55, 0.1); border-color: #D4AF37; font-weight: 600;"></td>
                <td><input type="text" class="readonly-calc" placeholder="Auto-calculated" readonly style="background: rgba(212, 175, 55, 0.1); border-color: #D4AF37; font-weight: 600;"></td>
                <td><input type="text" class="readonly-calc" placeholder="Auto-calculated" readonly style="background: rgba(212, 175, 55, 0.1); border-color: #D4AF37; font-weight: 600;"></td>
                <td><input type="text" placeholder="Payment ${financialCount}"></td>
                <td><button class="btn btn-sm btn-secondary" onclick="deleteRow(this)">Delete</button></td>
            `;
            recalculateFinancialMilestones();
        }
        
        // Auto-calculation for Financial Milestones
        function recalculateFinancialMilestones() {
            const appointedDate = document.getElementById('appointedDate').value;
            const projectCost = parseFloat(document.getElementById('projectCost').value) || 0;
            const tbody = document.getElementById('financialMilestones');
            const rows = tbody.getElementsByTagName('tr');
            
            let cumulativeProgress = 0;
            
            for (let i = 0; i < rows.length; i++) {
                const inputs = rows[i].getElementsByTagName('input');
                const daysInput = inputs[0]; // Days from Start
                const progressInput = inputs[1]; // Progress %
                const scheduleDateInput = inputs[2]; // Schedule Date (AUTO)
                const amountInput = inputs[3]; // Amount (AUTO)
                const cumulativeInput = inputs[4]; // Cumulative % (AUTO)
                
                const days = parseInt(daysInput.value) || 0;
                const progress = parseFloat(progressInput.value) || 0;
                
                // Calculate Schedule Date
                if (appointedDate && days > 0) {
                    const appointed = new Date(appointedDate);
                    const scheduleDate = new Date(appointed);
                    scheduleDate.setDate(scheduleDate.getDate() + days);
                    scheduleDateInput.value = scheduleDate.toLocaleDateString('en-GB');
                } else {
                    scheduleDateInput.value = '';
                }
                
                // Calculate Amount
                if (projectCost > 0 && progress > 0) {
                    const amount = (projectCost * progress) / 100;
                    amountInput.value = amount.toFixed(2);
                } else {
                    amountInput.value = '';
                }
                
                // Calculate Cumulative %
                cumulativeProgress += progress;
                cumulativeInput.value = cumulativeProgress.toFixed(2) + '%';
            }
        }
        
        function deleteRow(btn) {
            btn.closest('tr').remove();
        }
        
        // Tab 2 - TCS Functions
        let tcsCount = 2;
        function addTCS() {
            const table = document.getElementById('tcsTable');
            const row = table.insertRow();
            row.onclick = function() { selectTCS(this, tcsCount); };
            row.innerHTML = `
                <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                <td><strong>${tcsCount * 5}+000</strong></td>
                <td><strong>${(tcsCount + 1) * 5}+000</strong></td>
                <td>Main Carriageway</td>
                <td>4-Lane</td>
                <td>Raised</td>
                <td>New</td>
            `;
            tcsCount++;
        }
        
        function selectTCS(row, index) {
            selectedTCSIndex = index; // FIX-UA06
            document.querySelectorAll('#tcsTable tr').forEach(r => r.classList.remove('selected'));
            row.classList.add('selected');
            
            document.getElementById('tcsDetailContent').innerHTML = `
                <!-- TAB 1: COMPONENTS -->
                <div class="detail-tab-content active">
                    <div class="info-box">Select Project Type to see appropriate components</div>
                    
                    <div class="radio-group">
                        <div class="radio-item selected" onclick="selectProjectType(this, 'new')">New</div>
                        <div class="radio-item" onclick="selectProjectType(this, 'widening')">Widening</div>
                        <div class="radio-item" onclick="selectProjectType(this, 'overlay')">Overlay</div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">1. Carriageway & Lanes</div>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" checked>
                                <label>Main Carriageway (4-Lane)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Service Road</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">2. Median & Protection</div>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" checked>
                                <label>Raised Median</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Depressed Median</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">4. Pavement Layers (IRC)</div>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" checked>
                                <label>BC - Bituminous Concrete</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" checked>
                                <label>DBM - Dense Bituminous Macadam</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>AIL - Asphaltic Intermediate Layer</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" checked>
                                <label>WMM - Wet Mix Macadam</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" checked>
                                <label>GSB - Granular Sub-Base</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>CTB - Cement Treated Base</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>CTSB - Cement Treated Sub-Base</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>SAMI - Stress Absorbing Membrane</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>DLC - Dry Lean Concrete</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>PQC - Pavement Quality Concrete</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">5. Earthwork & Formation</div>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" checked>
                                <label>Embankment</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" checked>
                                <label>Subgrade (300-500mm prepared layer)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Proof Rolling</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Soil Stabilization</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">7. Retaining Structures</div>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>RE Wall - LHS (RCC/Masonry/Gabion)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>RE Wall - RHS (RCC/Masonry/Gabion)</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">8. Safety & Furniture</div>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Crash Barriers (Concrete/Metal)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Guardrail - LHS</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Guardrail - RHS</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">9. Plantation (IRC)</div>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Avenue Plantation - LHS</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Avenue Plantation - RHS</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox">
                                <label>Median Plantation</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="component-section" style="margin-top: 16px; border: 2px solid #D4AF37; border-radius: 6px; padding: 12px; background: #fffbeb;">
                        <div class="component-header" style="color: #92400e; margin-bottom: 12px;">üìê Layer Thicknesses & Road Geometry</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div class="form-group">
                                <label class="form-label">BC Thickness (mm)</label>
                                <input type="number" class="form-input" id="tcsBC" value="${KALYANTRA.data.tcs.layers.BC.thickness}" min="20" max="80" onchange="saveTCSEdit('BC', this.value)" placeholder="40">
                            </div>
                            <div class="form-group">
                                <label class="form-label">DBM Thickness (mm)</label>
                                <input type="number" class="form-input" id="tcsDBM" value="${KALYANTRA.data.tcs.layers.DBM.thickness}" min="40" max="120" onchange="saveTCSEdit('DBM', this.value)" placeholder="50">
                            </div>
                            <div class="form-group">
                                <label class="form-label">WBM Thickness (mm)</label>
                                <input type="number" class="form-input" id="tcsWBM" value="${KALYANTRA.data.tcs.layers.WBM.thickness}" min="100" max="400" onchange="saveTCSEdit('WBM', this.value)" placeholder="250">
                            </div>
                            <div class="form-group">
                                <label class="form-label">GSB Thickness (mm)</label>
                                <input type="number" class="form-input" id="tcsGSB" value="${KALYANTRA.data.tcs.layers.GSB.thickness}" min="100" max="300" onchange="saveTCSEdit('GSB', this.value)" placeholder="150">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Carriage Width (m)</label>
                                <input type="number" class="form-input" id="tcsCarriageWidth" value="${KALYANTRA.data.tcs.carriageWidth}" min="3.5" max="15" step="0.5" onchange="saveTCSEdit('carriageWidth', this.value)" placeholder="7.0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Shoulder Width (m)</label>
                                <input type="number" class="form-input" id="tcsShoulderWidth" value="${KALYANTRA.data.tcs.shoulderWidth}" min="0.5" max="3.0" step="0.25" onchange="saveTCSEdit('shoulderWidth', this.value)" placeholder="1.5">
                            </div>
                        </div>
                        <div style="font-size: 0.78rem; color: #92400e; background: #fef3c7; padding: 6px 10px; border-radius: 4px;">
                            ‚ö° Changes update WBS quantities automatically via KALYANTRA engine
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="saveTCSComponents()">üíæ Save TCS Components & Geometry</button>
                </div>
                
                <!-- TAB 2: DRAWING STATUS (Same as Tab 3) -->
                <div class="detail-tab-content">
                    <div class="info-box">Track TCS/Highway drawing approval workflow (IRC compliance)</div>
                    
                    <div class="component-section">
                        <div class="component-header">1. TYPICAL CROSS-SECTION DRAWING</div>
                        <div class="form-group">
                            <label class="form-label">Design Status</label>
                            <select class="form-select">
                                <option>Not Started</option>
                                <option>Ongoing</option>
                                <option>Complete</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Design Date</label>
                            <input type="date" class="form-input">
                        </div>
                        
                        <div class="form-group" style="margin-top: 10px;">
                            <label class="form-label">Submission Status</label>
                            <select class="form-select">
                                <option>Not Submitted</option>
                                <option>Submitted</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Submission Date</label>
                            <input type="date" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Submitted To</label>
                            <select class="form-select">
                                <option>Engineer</option>
                                <option>Client</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Drawing Number</label>
                            <input type="text" class="form-input" placeholder="TCS-001-Rev0">
                        </div>
                        
                        <div class="form-group" style="margin-top: 10px;">
                            <label class="form-label">Review Status</label>
                            <select class="form-select">
                                <option>Not Started</option>
                                <option>Under Review</option>
                                <option>Approved</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Review Date</label>
                            <input type="date" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Comments</label>
                            <input type="text" class="form-input" placeholder="Minor modifications required">
                        </div>
                        
                        <div class="form-group" style="margin-top: 10px;">
                            <label class="form-label">Approval Status</label>
                            <select class="form-select">
                                <option>Pending</option>
                                <option>Approved</option>
                                <option>Approved with Comments</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Approval Date</label>
                            <input type="date" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Approval Reference</label>
                            <input type="text" class="form-input" placeholder="ABC/TCS/2025/001">
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">2. PAVEMENT DESIGN</div>
                        <div class="form-group">
                            <label class="form-label">Design Status</label>
                            <select class="form-select">
                                <option>Not Started</option>
                                <option>Ongoing</option>
                                <option>Complete</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Design Date</label>
                            <input type="date" class="form-input">
                        </div>
                        
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin: 10px 0;">
                            IRC Compliance Check:
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox">
                            <label>IRC:37 (Pavement Design)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox">
                            <label>IRC:SP:72 (Pavement Evaluation)</label>
                        </div>
                        <div class="form-group" style="margin-top: 10px;">
                            <label class="form-label">CBR Value (%)</label>
                            <input type="number" class="form-input" placeholder="From soil tests">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Design Traffic (MSA)</label>
                            <input type="number" class="form-input">
                        </div>
                        
                        <div class="form-group" style="margin-top: 10px;">
                            <label class="form-label">Submission Status</label>
                            <select class="form-select">
                                <option>Not Submitted</option>
                                <option>Submitted</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Approval Status</label>
                            <select class="form-select">
                                <option>Pending</option>
                                <option>Approved</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Approval Date</label>
                            <input type="date" class="form-input">
                        </div>
                    </div>
                    
                    <div class="component-section">
                        <div class="component-header">3. DRAINAGE DESIGN</div>
                        <div class="form-group">
                            <label class="form-label">Design Status</label>
                            <select class="form-select">
                                <option>Not Started</option>
                                <option>Ongoing</option>
                                <option>Complete</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Expected Completion</label>
                            <input type="date" class="form-input">
                        </div>
                        
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin: 10px 0;">
                            IRC Compliance:
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox">
                            <label>IRC:SP:50 (Drainage Guidelines)</label>
                        </div>
                        
                        <div class="form-group" style="margin-top: 10px;">
                            <label class="form-label">Drainage Calculations</label>
                            <select class="form-select">
                                <option>Pending</option>
                                <option>Submitted</option>
                                <option>Approved</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="component-section" style="background: rgba(59, 130, 246, 0.05); border-left: 4px solid var(--info);">
                        <div class="component-header">OVERALL TCS APPROVAL STATUS</div>
                        <div class="form-group">
                            <label class="form-label">Overall Status</label>
                            <select class="form-select">
                                <option>Pending</option>
                                <option>Partial Approval</option>
                                <option>Fully Approved</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Can Start Construction</label>
                            <select class="form-select">
                                <option>NO - Approvals Pending</option>
                                <option>YES - All Approved</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Reason (if NO)</label>
                            <input type="text" class="form-input" placeholder="e.g., Drainage design pending approval">
                        </div>
                    </div>
                </div>
            `;
        }
        
        // TCS Tab switching function
        function switchTCSTab(index) {
            const tabs = document.querySelectorAll('.detail-tab');
            const contents = document.querySelectorAll('.detail-tab-content');
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                    if (contents[i]) contents[i].classList.add('active');
                } else {
                    tab.classList.remove('active');
                    if (contents[i]) contents[i].classList.remove('active');
                }
            });
        }
        
        function selectProjectType(elem, type) {
            document.querySelectorAll('.radio-item').forEach(r => r.classList.remove('selected'));
            elem.classList.add('selected');
        }
        
        // Tab 3 - Structures Functions
        let structCount = 1;
        function addStructure() { structAddNew(); }
        
        function selectStructure(row, index) {
            // Legacy function ‚Äî now handled by card-based renderStructuresList()
            document.querySelectorAll('#structuresTable tr').forEach(r => r.classList.remove('selected'));
            if(row) row.classList.add('selected');
        }
        
        // Tab 4 - Hindrances Functions
        let hindranceCount = 3; // Start from 4 since we have 3 sample rows
        
        function addHindrance() {
            hindranceCount++;
            const table = document.getElementById('hindrancesTable');
            const row = table.insertRow();
            row.onclick = function() { selectHindrance(this, hindranceCount); };
            row.innerHTML = `
                <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                <td><strong>${hindranceCount}</strong></td>
                <td>Land Handover</td>
                <td>Ch __+___</td>
                <td><span style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">Non-Clear</span></td>
                <td><span style="background: rgba(251, 191, 36, 0.1); color: #f59e0b; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">Active</span></td>
                <td>0 days</td>
                <td>__/__/____</td>
                <td>Owner</td>
            `;
            // Sync to KALYANTRA data store
            if (typeof KALYANTRA !== 'undefined') {
                const cs = hindranceCount * 400;
                KALYANTRA.data.hindrances.push({ id:hindranceCount, name:'Land Handover', type:'land', chainageStart:cs, chainageEnd:cs+600, status:'Pending', impact:'Blocks work activities' });
                console.log('üìä KALYANTRA data updated: hindrances count =', KALYANTRA.data.hindrances.length);
            }
        }
        
        
        // ‚ïê‚ïê‚ïê RENDER HINDRANCE TABLE FROM DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function deleteHindrance(idx, event) {
            if (event) event.stopPropagation();
            if (!confirm('Delete hindrance #' + (idx+1) + '?')) return;
            KALYANTRA.data.hindrances.splice(idx, 1);
            KALYANTRA.save();
            renderHindranceTable();
            showToast('üóëÔ∏è Hindrance deleted', 'info');
        }

        function saveHindrance(idx) {
            const h = KALYANTRA.data.hindrances[idx];
            if (!h) return;
            // Read from detail panel
            const typeEl   = document.getElementById('hindranceType');
            const descEl   = document.getElementById('hindranceDesc');
            const fromKmEl = document.getElementById('hindranceFromKm');
            const fromMEl  = document.getElementById('hindranceFromM');
            const toKmEl   = document.getElementById('hindranceToKm');
            const toMEl    = document.getElementById('hindranceToM');
            const daysEl   = document.getElementById('hindranceDays');
            const statusEl = document.getElementById('hindranceStatus');
            const critEl   = document.getElementById('hindranceCrit');
            if (typeEl)   h.type     = typeEl.value;
            if (descEl)   h.description = descEl.value;
            if (fromKmEl && fromMEl) h.chainageStart = parseInt(fromKmEl.value||0)*1000 + parseInt(fromMEl.value||0);
            if (toKmEl   && toMEl)   h.chainageEnd   = parseInt(toKmEl.value||0)*1000   + parseInt(toMEl.value||0);
            if (daysEl)   h.resolutionDays = parseInt(daysEl.value||0);
            if (statusEl) h.status   = statusEl.value;
            if (critEl)   h.criticality = critEl.value;
            KALYANTRA.save();
            renderHindranceTable();
            showToast('üíæ Hindrance saved', 'success');
        }


        function renderHindranceTable() {
            const table = document.getElementById('hindrancesTable');
            if (!table) return;
            const hindrances = (KALYANTRA && KALYANTRA.data && KALYANTRA.data.hindrances) || [];
            table.innerHTML = '';
            hindrances.forEach((h, idx) => {
                const row = table.insertRow();
                row.onclick = function() { selectHindrance(this, h.id || idx+1); };
                const statusColor = h.status === 'Resolved'
                    ? 'background:rgba(34,197,94,0.1);color:#16a34a'
                    : h.status === 'Partial'
                    ? 'background:rgba(251,191,36,0.1);color:#f59e0b'
                    : 'background:rgba(239,68,68,0.1);color:#ef4444';
                const clearColor = (h.type === 'land' || h.type === 'Land')
                    ? 'background:rgba(239,68,68,0.1);color:#ef4444'
                    : 'background:rgba(251,191,36,0.1);color:#f59e0b';
                const fmt = (m) => {
                    if (!m && m!==0) return 'Ch __+___';
                    const k = Math.floor(m/1000), r = m%1000;
                    return 'Ch ' + k + '+' + String(r).padStart(3,'0');
                };
                const typeLabel = {land:'Land Handover',utility:'Utility Shifting',forest:'Forest Clearance',
                    encroachment:'Encroachment',permit:'Permit/Approval',other:'Other'}[h.type] || h.type || 'Land Handover';
                const _hidx = idx;
                row.innerHTML = '<td><input type="checkbox" onclick="event.stopPropagation()"></td>'
                    + '<td><strong>' + (h.id||idx+1) + '</strong></td>'
                    + '<td>' + typeLabel + '</td>'
                    + '<td>' + fmt(h.chainageStart) + ' ‚Äì ' + fmt(h.chainageEnd) + '</td>'
                    + '<td><span style="' + clearColor + ';padding:2px 8px;border-radius:4px;font-size:0.85rem;">'
                    + (h.clearanceStatus || 'Non-Clear') + '</span></td>'
                    + '<td><span style="' + statusColor + ';padding:2px 8px;border-radius:4px;font-size:0.85rem;">'
                    + (h.status||'Active') + '</span></td>'
                    + '<td>' + (h.resolutionDays||0) + ' days</td>'
                    + '<td>' + (h.resolvedDate||'__/__/____') + '</td>'
                    + '<td>' + (h.owner||'Owner') + '</td>'
                    + '<td><button onclick="deleteHindrance(' + _hidx + ', event)" style="background:#ef4444;color:white;border:none;padding:3px 10px;border-radius:4px;cursor:pointer;font-size:0.78rem;" title="Delete hindrance">üóë Delete</button></td>';
            });
            // Update hindrance count in stat bar
            const hc = document.getElementById('dashHindranceCount');
            if (hc) hc.textContent = hindrances.filter(h=>h.status!=='Resolved').length;
        }

        function deleteSelectedHindrances() {
            const checked = document.querySelectorAll('#hindrancesTable input[type=checkbox]:checked');
            if (checked.length === 0) { showToast('Select rows to delete first', 'info'); return; }
            if (!confirm('Delete ' + checked.length + ' hindrance(s)?')) return;
            checked.forEach(cb => {
                const row = cb.closest('tr');
                if (row) {
                    const idx = Array.from(row.parentNode.children).indexOf(row);
                    if (KALYANTRA.data.hindrances && KALYANTRA.data.hindrances[idx]) {
                        KALYANTRA.data.hindrances.splice(idx, 1);
                    }
                    row.remove();
                }
            });
            KALYANTRA.save();
            showToast('üóëÔ∏è Deleted selected hindrances', 'info');
        }
        
        function uploadJM() {
            showToast('üìé JM upload coming in V7.0', 'info');
        }
        
        function selectHindrance(row, index) {
            document.querySelectorAll('#hindrancesTable tr').forEach(r => r.classList.remove('selected'));
            row.classList.add('selected');
            
            const category = row.cells[2].textContent;
            
            // Generate detail content based on category
            let detailHTML = generateHindranceDetails(category, index);
            
            const _hdc = document.getElementById('hindranceDetailContent');
            _hdc.setAttribute('data-hindrance-index', index); // FIX-GAP07
            _hdc.innerHTML = detailHTML;
            // U-11: Pre-fill chainage inputs from data model
            const hData = KALYANTRA.data.hindrances[index];
            if (hData) {
                const setV = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
                setV('fromKm', Math.floor((hData.chainageStart||0) / 1000));
                setV('fromM',  (hData.chainageStart||0) % 1000);
                setV('toKm',   Math.floor((hData.chainageEnd||0) / 1000));
                setV('toM',    (hData.chainageEnd||0) % 1000);
                setV('hDesc_'+index, hData.description||'');
                setV('hCrit_'+index, hData.criticality||'HIGH');
                liveHindranceChainageUpdate();
                if (hData.jmRef)        setV('jmRef_'+index, hData.jmRef);
                if (hData.jmDate)       setV('jmDate_'+index, hData.jmDate);
                if (hData.jmIssueType)  setV('jmIssueType_'+index, hData.jmIssueType);
                if (hData.utilType)     setV('utilType_'+index, hData.utilType);
                if (hData.utilAuth)     setV('utilAuth_'+index, hData.utilAuth);
                if (hData.drawingNo)    setV('drawingNo_'+index, hData.drawingNo);
                if (hData.drawingDate)  setV('drawingDate_'+index, hData.drawingDate);
            }
            // FIX-GAP07: restore resolution days input
            setTimeout(() => {
                const _rdi = document.getElementById('hindranceResolutionDays');
                if (_rdi && hData) _rdi.value = hData.resolutionDays || '';
                // FIX-GAP05: restore status button active state
                if (hData) {
                    const _cols = {Pending:['#fee2e2','#dc2626','#991b1b'],'In Progress':['#fff7ed','#ea580c','#9a3412'],Resolved:['#dcfce7','#16a34a','#166534']};
                    ['Pending','In Progress','Resolved'].forEach(s => {
                        const _btn = document.getElementById('hStat_'+index+'_'+s.replace(/ /g,''));
                        if (!_btn) return;
                        const [bg,br,tc] = _cols[s]||['white','#e2e8f0','#64748b'];
                        const _active = (hData.status||'Pending') === s;
                        _btn.style.background = _active?bg:'white';
                        _btn.style.borderColor = _active?br:'#e2e8f0';
                        _btn.style.color = _active?tc:'#64748b';
                        _btn.style.fontWeight = _active?'800':'600';
                    });
                }
            }, 60);
        }
        
        function generateHindranceDetails(category, index) {
            const CATS = [
                'Land Handover (JM Based)','Utility Shifting','ROB/RUB Drawing Approval',
                'Canal Crossing Approval','Forest Clearance','Statutory Clearances',
                'Railway Coordination','Differing Site Conditions','Traffic Management',
                'Variation Order','Other'
            ];
            const catOptions = CATS.map(o =>
                `<option value="${o}" ${(category===o||category===o.split(' (')[0])?'selected':''}>` + o + `</option>`
            ).join('');

            let extraSection = '';
            if (category.includes('Land') || category.includes('JM')) {
                extraSection = `
                <div style="background:rgba(239,68,68,0.04);border-left:3px solid #ef4444;padding:12px;border-radius:0 6px 6px 0;margin-bottom:10px;">
                    <div style="font-size:0.78rem;font-weight:700;color:#ef4444;letter-spacing:0.05em;margin-bottom:10px;">JOINT MEMORANDUM</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <div>
                            <label style="font-size:0.78rem;font-weight:600;color:#475569;display:block;margin-bottom:3px;">JM Reference No.</label>
                            <input type="text" class="form-input" id="jmRef_${index}" placeholder="JM/2025/01" onchange="saveHindranceFromForm(${index})" style="font-size:0.84rem;">
                        </div>
                        <div>
                            <label style="font-size:0.78rem;font-weight:600;color:#475569;display:block;margin-bottom:3px;">JM Date</label>
                            <input type="date" class="form-input" id="jmDate_${index}" onchange="saveHindranceFromForm(${index})" style="font-size:0.84rem;">
                        </div>
                    </div>
                    <div style="margin-top:8px;">
                        <label style="font-size:0.78rem;font-weight:600;color:#475569;display:block;margin-bottom:3px;">Issue Type</label>
                        <select class="form-select" id="jmIssueType_${index}" onchange="saveHindranceFromForm(${index})" style="font-size:0.84rem;">
                            <option value="">Select issue type‚Ä¶</option>
                            <option>Encroachments (Houses / Shops)</option>
                            <option>Forest Land ‚Äî Clearance Pending</option>
                            <option>Revenue Land ‚Äî Conversion Pending</option>
                            <option>Private Land ‚Äî Acquisition Pending</option>
                            <option>Religious Structure</option>
                            <option>Land Dispute ‚Äî Ownership Unclear</option>
                            <option>Cemetery / Graveyard</option>
                        </select>
                    </div>
                </div>`;
            } else if (category.includes('Utility')) {
                extraSection = `
                <div style="background:rgba(234,88,12,0.04);border-left:3px solid #ea580c;padding:12px;border-radius:0 6px 6px 0;margin-bottom:10px;">
                    <div style="font-size:0.78rem;font-weight:700;color:#ea580c;letter-spacing:0.05em;margin-bottom:10px;">UTILITY DETAILS</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <div>
                            <label style="font-size:0.78rem;font-weight:600;color:#475569;display:block;margin-bottom:3px;">Utility Type</label>
                            <select class="form-select" id="utilType_${index}" onchange="saveHindranceFromForm(${index})" style="font-size:0.84rem;">
                                <option value="">Select‚Ä¶</option>
                                <option>OHE (Overhead Electric)</option>
                                <option>Underground Cable</option>
                                <option>Water Pipeline</option>
                                <option>Gas Pipeline</option>
                                <option>Telecom / Optical Fibre</option>
                                <option>Sewage / Drainage</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:0.78rem;font-weight:600;color:#475569;display:block;margin-bottom:3px;">Authority</label>
                            <input type="text" class="form-input" id="utilAuth_${index}" placeholder="e.g. BESCOM, BWSSB" onchange="saveHindranceFromForm(${index})" style="font-size:0.84rem;">
                        </div>
                    </div>
                </div>`;
            } else if (category.includes('ROB') || category.includes('RUB') || category.includes('Drawing')) {
                extraSection = `
                <div style="background:rgba(99,102,241,0.04);border-left:3px solid #6366f1;padding:12px;border-radius:0 6px 6px 0;margin-bottom:10px;">
                    <div style="font-size:0.78rem;font-weight:700;color:#6366f1;letter-spacing:0.05em;margin-bottom:10px;">DRAWING / APPROVAL</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <div>
                            <label style="font-size:0.78rem;font-weight:600;color:#475569;display:block;margin-bottom:3px;">Drawing No.</label>
                            <input type="text" class="form-input" id="drawingNo_${index}" placeholder="DRG/ROB/001" onchange="saveHindranceFromForm(${index})" style="font-size:0.84rem;">
                        </div>
                        <div>
                            <label style="font-size:0.78rem;font-weight:600;color:#475569;display:block;margin-bottom:3px;">Submitted Date</label>
                            <input type="date" class="form-input" id="drawingDate_${index}" onchange="saveHindranceFromForm(${index})" style="font-size:0.84rem;">
                        </div>
                    </div>
                </div>`;
            }

            return `
                <div style="display:flex;gap:6px;margin-bottom:12px;">
                    <button id="hStat_${index}_Pending" onclick="setHindranceStatus(${index},'Pending')"
                        style="flex:1;padding:6px 0;border-radius:6px;border:2px solid #e2e8f0;background:white;color:#64748b;font-size:0.78rem;font-weight:600;cursor:pointer;">\u23f3 Pending</button>
                    <button id="hStat_${index}_InProgress" onclick="setHindranceStatus(${index},'In Progress')"
                        style="flex:1;padding:6px 0;border-radius:6px;border:2px solid #e2e8f0;background:white;color:#64748b;font-size:0.78rem;font-weight:600;cursor:pointer;">\uD83D\uDD28 In Progress</button>
                    <button id="hStat_${index}_Resolved" onclick="setHindranceStatus(${index},'Resolved')"
                        style="flex:1;padding:6px 0;border-radius:6px;border:2px solid #e2e8f0;background:white;color:#64748b;font-size:0.78rem;font-weight:600;cursor:pointer;">\u2705 Resolved</button>
                </div>
                <div style="margin-bottom:10px;">
                    <label style="font-size:0.78rem;font-weight:700;color:#475569;display:block;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.04em;">Category</label>
                    <select class="form-select" id="hCat_${index}" onchange="updateHindranceCategory(this)" style="font-size:0.84rem;">${catOptions}</select>
                </div>
                <div style="margin-bottom:10px;">
                    <label style="font-size:0.78rem;font-weight:700;color:#475569;display:block;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.04em;">Description</label>
                    <textarea class="form-input" id="hDesc_${index}" rows="2" placeholder="Brief description of this hindrance\u2026" onchange="saveHindranceFromForm(${index})" style="font-size:0.84rem;resize:none;"></textarea>
                </div>
                <div style="margin-bottom:10px;">
                    <label style="font-size:0.78rem;font-weight:700;color:#475569;display:block;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.04em;">Chainage Range</label>
                    <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:6px;align-items:end;">
                        <div>
                            <label style="font-size:0.75rem;color:#94a3b8;display:block;margin-bottom:2px;">From</label>
                            <div style="display:flex;gap:4px;align-items:center;">
                                <input type="number" class="form-input" placeholder="Km" id="fromKm" onchange="liveHindranceChainageUpdate()" style="width:52px;font-size:0.84rem;text-align:center;">
                                <span style="color:#94a3b8;font-weight:600;">+</span>
                                <input type="number" class="form-input" placeholder="m" id="fromM" min="0" max="999" onchange="liveHindranceChainageUpdate()" style="width:58px;font-size:0.84rem;text-align:center;">
                            </div>
                        </div>
                        <div style="text-align:center;padding-bottom:6px;color:#94a3b8;">‚Üí</div>
                        <div>
                            <label style="font-size:0.75rem;color:#94a3b8;display:block;margin-bottom:2px;">To</label>
                            <div style="display:flex;gap:4px;align-items:center;">
                                <input type="number" class="form-input" placeholder="Km" id="toKm" onchange="liveHindranceChainageUpdate()" style="width:52px;font-size:0.84rem;text-align:center;">
                                <span style="color:#94a3b8;font-weight:600;">+</span>
                                <input type="number" class="form-input" placeholder="m" id="toM" min="0" max="999" onchange="liveHindranceChainageUpdate()" style="width:58px;font-size:0.84rem;text-align:center;">
                            </div>
                        </div>
                    </div>
                    <div id="hindranceLengthDisplay" style="margin-top:6px;font-size:0.8rem;color:#3b82f6;font-weight:600;min-height:18px;"></div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
                    <div>
                        <label style="font-size:0.78rem;font-weight:700;color:#475569;display:block;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.04em;">Est. Resolution (days)</label>
                        <input type="number" id="hindranceResolutionDays" min="0" placeholder="e.g. 30"
                            style="width:100%;padding:6px 8px;border:1px solid #e2e8f0;border-radius:5px;font-size:0.84rem;"
                            onchange="saveHindranceResolutionDays(this.value)">
                    </div>
                    <div>
                        <label style="font-size:0.78rem;font-weight:700;color:#475569;display:block;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.04em;">Criticality</label>
                        <select class="form-select" id="hCrit_${index}" onchange="saveHindranceFromForm(${index})" style="font-size:0.84rem;">
                            <option value="HIGH">HIGH \uD83D\uDD34</option>
                            <option value="MEDIUM">MEDIUM \uD83D\DFE1</option>
                            <option value="LOW">LOW \uD83D\DFE2</option>
                        </select>
                    </div>
                </div>
                <div style="margin-bottom:10px;">
                    <label style="font-size:0.78rem;font-weight:700;color:#475569;display:block;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.04em;">
                        Resolution Status
                        <span style="font-size:0.72rem;font-weight:500;color:#94a3b8;text-transform:none;"> \u2014 Resolved unlocks zone for scheduling</span>
                    </label>
                    <select class="form-select" id="landStatusSelect" onchange="quickResolveHindrance(this)" style="border-color:#D4AF37;font-size:0.84rem;">
                        <option value="pending">Active \u2014 Pending</option>
                        <option value="working">Under Resolution</option>
                        <option value="clear">Resolved \u2705 (Zone Unlocked)</option>
                        <option value="closed">Closed</option>
                    </select>
                </div>
                ${extraSection}
                <button onclick="saveHindranceFromForm(${index})"
                    style="width:100%;padding:9px;background:#1B3B6F;color:white;border:none;border-radius:6px;font-weight:700;font-size:0.85rem;cursor:pointer;margin-top:4px;">
                    \uD83D\uDCBE Save Hindrance
                </button>
            `;
        }
        
        function updateHindranceCategory(select) {
            // Refresh the detail view when category changes
            const selectedRow = document.querySelector('#hindrancesTable tr.selected');
            if (selectedRow) {
                const index = parseInt(selectedRow.cells[1].textContent);
                selectHindrance(selectedRow, index);
            }
        }
        
        function checkAffectedStructures(select) {
            const affectedSection = document.getElementById('affectedStructuresSection');
            if (select.value === 'encumbered') {
                affectedSection.style.display = 'block';
            } else {
                affectedSection.style.display = 'none';
            }
        }

        // TAB 7 - 4 CHILD TABS JAVASCRIPT
        function switchTab7Child(index) {
            // Update button states
            for (let i = 0; i <= 3; i++) {
                const btn = document.getElementById('tab7child' + i);
                const content = document.getElementById('tab7content' + i);
                
                if (i === index) {
                    btn.style.background = '#1B3B6F';
                    btn.style.color = 'white';
                    btn.style.borderBottomColor = '#D4AF37';
                    content.style.display = 'flex';
                } else {
                    btn.style.background = 'transparent';
                    btn.style.color = '#64748b';
                    btn.style.borderBottomColor = 'transparent';
                    content.style.display = 'none';
                }
            }
            // Tab-specific renders
            if (index === 1) setTimeout(() => {
                KALYANTRA.refresh();
                renderActivitiesTable();
            }, 80);
            if (index === 2) setTimeout(() => {
                KALYANTRA.refresh();
                renderGantt();
            }, 80);
            if (index === 3) setTimeout(() => initializeLSM(), 80);
        }
        
        // WBS Table Functions
        function toggleWBSRow(cell) {
            const row = cell.parentElement;
            const wbs = row.querySelector('td:nth-child(2)').textContent;
            const icon = cell.querySelector('.wbs-toggle');
            const isExpanded = icon.textContent === '‚ñº';
            
            icon.textContent = isExpanded ? '‚ñ∂' : '‚ñº';
            
            const children = document.querySelectorAll(`tr[data-parent="${wbs}"]`);
            children.forEach(child => {
                child.style.display = isExpanded ? 'none' : 'table-row';
            });
        }
        
        function expandAllWBS() {
            document.querySelectorAll('#wbsBody .wbs-toggle').forEach(icon => icon.textContent = '‚ñº');
            document.querySelectorAll('#wbsBody tr[data-parent]').forEach(row => row.style.display = 'table-row');
        }
        
        function collapseAllWBS() {
            document.querySelectorAll('#wbsBody .wbs-toggle').forEach(icon => icon.textContent = '‚ñ∂');
            document.querySelectorAll('#wbsBody tr[data-parent]').forEach(row => row.style.display = 'none');
        }
        
        function viewWBSActivities(wbs) {
            switchTab7Child(1);
            const select = document.getElementById('activityFilter');
            if (select) {
                select.value = wbs;
                filterActivities();
            }
        }
        
        // U-05: Update activity actual % complete
        function updateActivityProgress(slider, wbsId, actId, pct) {
            const pctNum = parseInt(pct) || 0;
            // LA-01 FIX: Persist actualPct to KALYANTRA.data.activityProgress so refresh() doesn't wipe it
            const progressKey = wbsId + '.' + actId;
            if (!KALYANTRA.data.activityProgress) KALYANTRA.data.activityProgress = {};
            KALYANTRA.data.activityProgress[progressKey] = pctNum;
            supabaseSaveProgress(progressKey, pctNum);
            try { const _sd=Object.assign({},KALYANTRA.data,{_version:'2.0'}); localStorage.setItem('kalyantra_v67_data',JSON.stringify(_sd)); } catch(e) {}
            // Find activity in computed and update actualPct
            const act = KALYANTRA.computed.activities.find(a => a.wbs === wbsId && String(a.id) === String(actId));
            if (act) {
                act.actualPct = pctNum;
                // Also update in WBS item activities
                const wbsItem = KALYANTRA.computed.wbs.find(w => w.wbs === wbsId);
                if (wbsItem) {
                    const wa = wbsItem.activities.find(a => String(a.id) === String(actId));
                    if (wa) wa.actualPct = pctNum;
                }
                // Recalculate progress and save
                KALYANTRA.calculate.progress();
                KALYANTRA.save();
                // UA-03 FIX: update WBS stat bar live
                if (typeof updateWBSStatBar === 'function') updateWBSStatBar();
                // Update dashboard if visible
                const dashBar = document.getElementById('dashOverallBar');
                if (dashBar) KALYANTRA.render.dashboard();
                const prog = KALYANTRA.computed.overallProgress;
                // Brief toast every 10%
                if (pctNum % 10 === 0 && pctNum > 0) {
                    showToast(`üìä ${act.name}: ${pctNum}% ‚Äî Project overall: ${prog}%`, 'success');
                }
            }
        }

        function filterActivities() {
            const filter = document.getElementById('activityFilter').value;
            const rows = document.querySelectorAll('#activitiesBody tr');
            let count = 0;
            
            rows.forEach(row => {
                const wbs = row.getAttribute('data-wbs');
                if (filter === 'all' || wbs === filter || wbs.startsWith(filter + '.')) {
                    row.style.display = 'table-row';
                    count++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            const countDisplay = document.getElementById('activityCount');
            if (countDisplay) {
                countDisplay.textContent = count;
            }
        }
        

        // ========================================
        // LINEAR SCHEDULE METHOD (LSM) - INTERACTIVE DIAGRAM
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // LINEAR SCHEDULE METHOD (LSM) ‚Äî Activity Band Renderer
        // Design: Option A ‚Äî Diagonal colored bands + structure flags
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let lsmZoom         = 1.0;       // horizontal zoom
        let lsmShowCritical = true;
        let lsmShowStructs  = true;
        let lsmShowHindrance= true;
        let lsmInitialized  = false;
        let lsmBands        = [];        // computed band data
        let lsmStructMarkers= [];        // structure flag data
        let lsmHindranceBands= [];       // blocked zone data
        let lsmHoverTarget  = null;      // for tooltip

        // ‚îÄ‚îÄ Colour palette ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const LSM_COLORS = {
            'Soil Excavation':  { fill:'rgba(34,197,94,0.18)',  stroke:'#22c55e', label:'Earthwork'  },
            'Sub-grade':        { fill:'rgba(167,139,250,0.18)',stroke:'#a78bfa', label:'Sub-grade'  },
            'GSB':              { fill:'rgba(251,191,36,0.18)', stroke:'#fbbf24', label:'GSB'        },
            'WMM':              { fill:'rgba(56,189,248,0.18)', stroke:'#38bdf8', label:'WMM'        },
            'DBM':              { fill:'rgba(248,113,113,0.20)',stroke:'#f87171', label:'DBM'        },
            'BC':               { fill:'rgba(232,121,249,0.20)',stroke:'#e879f9', label:'BC'         },
        };
        function lsmColorForActivity(name) {
            for (const [key, val] of Object.entries(LSM_COLORS)) {
                if (name.includes(key)) return val;
            }
            return { fill:'rgba(148,163,184,0.15)', stroke:'#94a3b8', label:name.split(' ')[0] };
        }

        // ‚îÄ‚îÄ Build band data from KALYANTRA.computed ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function buildLSMBands() {
            if (!KALYANTRA || !KALYANTRA.computed) return;
            // Use existing computed ‚Äî initializeLSM handles refresh if needed
            if (!KALYANTRA.computed.wbs || KALYANTRA.computed.wbs.length === 0) {
                KALYANTRA.calculate.wbs();
            }
            const wbs  = KALYANTRA.computed.wbs || [];
            const proj = KALYANTRA.data.project;
            const T0   = parseLocalDate(proj.startDate || '2025-02-01');
            const maxCh= proj.endChainage || 42000;

            lsmBands          = [];
            lsmStructMarkers  = [];
            lsmHindranceBands = [];

            let dayOffset = 0;

            wbs.forEach(item => {
                if (item.type === 'blocked') {
                    // Hindrance: shaded chainage band
                    const ch0 = item.chainage ? (item.chainage.start || 0) : 0;
                    const ch1 = item.chainage ? (item.chainage.end   || ch0 + 500) : ch0 + 500;
                    lsmHindranceBands.push({ name: item.name, ch0, ch1 });
                    return;
                }

                if (item.type === 'structure') {
                    // Structure flag: horizontal marker at structure chainage, at current date
                    const chM = item.chainage ? (
                        item.chainage.start !== undefined
                            ? (item.chainage.start + (item.chainage.end||item.chainage.start)) / 2
                            : item.chainage
                    ) : 0;
                    const dateStart = new Date(T0);
                    dateStart.setDate(dateStart.getDate() + dayOffset);
                    const dateEnd = new Date(dateStart);
                    dateEnd.setDate(dateEnd.getDate() + (item.duration || 21));
                    lsmStructMarkers.push({
                        name:      item.name,
                        ch:        chM,
                        dateStart: dateStart,
                        dateEnd:   dateEnd,
                        dayStart:  dayOffset,
                        dayEnd:    dayOffset + (item.duration || 21),
                        critical:  item.activities && item.activities.some(a => a.critical),
                        wbs:       item.wbs,
                    });
                    dayOffset += (item.duration || 21);
                    return;
                }

                // Stretch: each activity = one diagonal band across chainage range
                if (item.type === 'stretch') {
                    const ch0 = item.chainage ? (item.chainage.start !== undefined ? item.chainage.start : 0) : 0;
                    const ch1 = item.chainage ? (item.chainage.end   !== undefined ? item.chainage.end   : maxCh) : maxCh;
                    let localDay = 0;

                    item.activities.forEach(act => {
                        const d0 = dayOffset + localDay;
                        const d1 = d0 + (act.duration || 1);
                        const col = lsmColorForActivity(act.name);
                        lsmBands.push({
                            name:     act.name,
                            wbs:      item.wbs,
                            stretch:  item.name,
                            ch0, ch1,
                            d0, d1,
                            duration: act.duration,
                            critical: act.critical,
                            fill:     col.fill,
                            stroke:   col.stroke,
                            label:    col.label,
                            resource: act.resource || '‚Äî',
                        });
                        localDay += (act.duration || 1);
                    });
                    dayOffset += item.duration;
                }
            });

            // Update status bar
            const totalDays = KALYANTRA.computed.totalDuration || 730;
            const el_cnt  = document.getElementById('lsmActivityCount');
            const el_str  = document.getElementById('lsmStructCount');
            const el_rate = document.getElementById('lsmProductionRate');
            const el_end  = document.getElementById('lsmEndChLabel');
            if (el_cnt)  el_cnt.textContent  = lsmBands.length;
            if (el_str)  el_str.textContent  = lsmStructMarkers.length;
            if (el_rate) el_rate.textContent = Math.round(maxCh / totalDays);
            if (el_end)  el_end.textContent  = Math.floor(maxCh/1000) + '+000';
        }

        // ‚îÄ‚îÄ Core render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderLSM() {
            const scrollBox = document.getElementById('lsmScrollBox');
            const mainCv    = document.getElementById('lsmMainCanvas');
            const xCv       = document.getElementById('lsmXCanvas');
            const yCv       = document.getElementById('lsmYCanvas');
            if (!scrollBox || !mainCv) return;

            const proj      = KALYANTRA.data.project;
            const T0        = parseLocalDate(proj.startDate || '2025-02-01');
            const maxCh     = proj.endChainage || 42000;
            const totalDays = Math.max(KALYANTRA.computed.totalDuration || 730, proj.duration || 730);

            // Dimensions
            const PX_DAY    = 3.5 * lsmZoom;      // pixels per day
            const PX_CH     = 14 * lsmZoom;        // pixels per 1000m chainage
            const CH_STEP   = maxCh <= 20000 ? 2000 : maxCh <= 30000 ? 3000 : 5000;
            const PAD_T     = 10;
            const PAD_B     = 10;

            const cW = Math.round(totalDays * PX_DAY) + 60;
            const cH = Math.round(maxCh / 1000 * PX_CH) + PAD_T + PAD_B;

            // Helpers
            const dayToX  = d  => Math.round(d * PX_DAY);
            const chToY   = ch => Math.round(PAD_T + (1 - ch / maxCh) * (cH - PAD_T - PAD_B));

            // ‚îÄ‚îÄ Main canvas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            mainCv.width  = cW;
            mainCv.height = cH;
            mainCv.style.width  = cW + 'px';
            mainCv.style.height = cH + 'px';

            const ctx = mainCv.getContext('2d');
            ctx.clearRect(0, 0, cW, cH);

            // Background
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0, 0, cW, cH);

            // Grid: horizontal chainage lines
            for (let ch = 0; ch <= maxCh; ch += CH_STEP) {
                const y = chToY(ch);
                ctx.strokeStyle = ch === 0 ? '#334155' : '#1e293b';
                ctx.lineWidth   = ch === 0 ? 1.5 : 0.5;
                ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(cW, y); ctx.stroke();
            }

            // Grid: vertical month lines
            const cur = new Date(T0); cur.setDate(1);
            const end = new Date(T0); end.setDate(end.getDate() + totalDays);
            ctx.font = '10px Segoe UI';
            while (cur <= end) {
                const d = Math.floor((cur - T0) / 86400000);
                const x = dayToX(d);
                ctx.strokeStyle = '#1e293b';
                ctx.lineWidth   = 0.5;
                ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, cH); ctx.stroke();
                cur.setMonth(cur.getMonth() + 1);
            }

            // TODAY line
            const todayD = Math.floor((new Date() - T0) / 86400000);
            if (todayD >= 0 && todayD <= totalDays) {
                const tx = dayToX(todayD);
                ctx.strokeStyle = '#ef4444';
                ctx.lineWidth   = 1.5;
                ctx.setLineDash([4, 4]);
                ctx.beginPath(); ctx.moveTo(tx, 0); ctx.lineTo(tx, cH); ctx.stroke();
                ctx.setLineDash([]);
                ctx.fillStyle = '#ef4444';
                ctx.font = 'bold 10px Segoe UI';
                ctx.fillText('TODAY', tx + 3, 16);
            }

            // ‚îÄ‚îÄ Hindrance bands (blocked zones) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (lsmShowHindrance) {
                lsmHindranceBands.forEach(h => {
                    const y0 = chToY(h.ch1);
                    const y1 = chToY(h.ch0);
                    ctx.fillStyle = 'rgba(249,115,22,0.12)';
                    ctx.fillRect(0, y0, cW, y1 - y0);
                    ctx.strokeStyle = 'rgba(249,115,22,0.5)';
                    ctx.lineWidth   = 1;
                    ctx.setLineDash([6, 4]);
                    ctx.beginPath(); ctx.moveTo(0, y0); ctx.lineTo(cW, y0); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(0, y1); ctx.lineTo(cW, y1); ctx.stroke();
                    ctx.setLineDash([]);
                });
            }

            // ‚îÄ‚îÄ Activity bands ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            lsmBands.forEach(band => {
                if (band.critical && !lsmShowCritical) return;

                const x0 = dayToX(band.d0);
                const x1 = dayToX(band.d1);
                const y0 = chToY(band.ch0);   // bottom chainage ‚Üí higher y
                const y1 = chToY(band.ch1);   // top chainage ‚Üí lower y

                // Parallelogram: (x0,y0)‚Üí(x1,y0)‚Üí(x1,y1)‚Üí(x0,y1)
                // But diagonal: the band STARTS at ch0 at d0 and ENDS at ch1 at d1
                // So: bottom-left=(x0,y0), bottom-right=(x1,y0) [wrong - should be diagonal]
                // Correct diagonal band:
                // TL=(x0, y1) = ch1 at d0 (activity starts at top chainage, at d0)
                // TR=(x1, y1) = ch1 at d1
                // BL=(x0, y0) = ch0 at d0
                // BR=(x1, y0) = ch0 at d1
                // Actually for a stretch that goes FROM ch0 TO ch1 over time d0‚Üíd1:
                // The LEADING EDGE of the activity at d0 is at ch0 (start of stretch)
                // The TRAILING EDGE at d1 is at ch1 (end of stretch)
                // Parallelogram: (x0,y0)‚Üí(x0,y1)‚Üí(x1,y1)‚Üí(x1,y0) = a vertical band
                // But we want DIAGONAL to show progress across chainage over time
                // Classic LSM: a line from (d0, ch0) to (d1, ch1) = the activity progresses
                // For a BAND, we draw thickness = ~4px normal to the line

                // Draw as parallelogram (most readable for highway LSM):
                // Left edge at d0: ch0..ch1 (full stretch, at start)  
                // Right edge at d1: ch0..ch1 (full stretch, at end)
                // This makes a rectangular band = shows the time window for this layer
                // The SLOPE of the band = production rate (km/day)

                const alpha = band.critical ? 0.5 : 0.25;
                const fillActual = band.fill.replace('0.18', alpha.toString()).replace('0.20', alpha.toString()).replace('0.15', alpha.toString());

                // Band polygon: bottom-left, top-left, top-right, bottom-right
                ctx.beginPath();
                ctx.moveTo(x0, y0);  // ch0 at d0 (bottom-left)
                ctx.lineTo(x0, y1);  // ch1 at d0 (top-left)
                ctx.lineTo(x1, y1);  // ch1 at d1 (top-right)
                ctx.lineTo(x1, y0);  // ch0 at d1 (bottom-right)
                ctx.closePath();

                ctx.fillStyle   = fillActual;
                ctx.fill();
                ctx.strokeStyle = band.stroke;
                ctx.lineWidth   = band.critical ? 2 : 1;
                ctx.setLineDash(band.critical ? [] : []);
                ctx.stroke();

                // Leading diagonal line (progress front) ‚Äî the TRUE LSM line
                // Goes from (x0, ch0_y) to (x1, ch1_y)
                ctx.strokeStyle = band.stroke;
                ctx.lineWidth   = band.critical ? 2.5 : 1.5;
                ctx.globalAlpha = 0.9;
                ctx.beginPath();
                ctx.moveTo(x0, chToY(band.ch0));
                ctx.lineTo(x1, chToY(band.ch1));
                ctx.stroke();
                ctx.globalAlpha = 1;
            });

            // ‚îÄ‚îÄ Constraint violation overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const _lsmViol = (KALYANTRA.data.constraints && KALYANTRA.data.constraints.violations) || [];
            if (_lsmViol.length > 0) {
                const _lsmWBS = KALYANTRA.computed.wbs || [];
                ctx.save();
                _lsmViol.forEach(v => {
                    // Find the stretch in WBS to get chainage range
                    const _stretch = _lsmWBS.find(w => w.wbs === v.stretch1 && w.type === 'stretch');
                    if (!_stretch || !_stretch.chainage) return;
                    const _y0 = chToY(_stretch.chainage.start || 0);
                    const _y1 = chToY(_stretch.chainage.end || 0);
                    const _yTop = Math.min(_y0, _y1);
                    const _yH   = Math.abs(_y1 - _y0);
                    // Draw amber warning stripe across full timeline
                    ctx.fillStyle = 'rgba(217,119,6,0.08)';
                    ctx.fillRect(0, _yTop, cW, _yH);
                    // Left edge marker
                    ctx.fillStyle = 'rgba(217,119,6,0.6)';
                    ctx.fillRect(0, _yTop, 4, _yH);
                    // Label
                    ctx.fillStyle = 'rgba(217,119,6,0.9)';
                    ctx.font = 'bold 9px Segoe UI';
                    ctx.fillText('‚ö° CONSTRAINT', 8, _yTop + 12);
                });
                ctx.restore();
            }

            // ‚îÄ‚îÄ Structure flags ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (lsmShowStructs) {
                lsmStructMarkers.forEach(st => {
                    const x  = dayToX(st.dayStart + (st.dayEnd - st.dayStart) / 2);
                    const y  = chToY(st.ch);
                    const r  = 5;

                    // Diamond marker
                    ctx.beginPath();
                    ctx.moveTo(x, y - r);
                    ctx.lineTo(x + r, y);
                    ctx.lineTo(x, y + r);
                    ctx.lineTo(x - r, y);
                    ctx.closePath();
                    ctx.fillStyle   = st.critical ? '#dc2626' : '#1e3a5f';
                    ctx.strokeStyle = st.critical ? '#f87171' : '#60a5fa';
                    ctx.lineWidth   = 1.5;
                    ctx.fill();
                    ctx.stroke();

                    // Flag pole (thin vertical line down from diamond)
                    ctx.strokeStyle = st.critical ? 'rgba(248,113,113,0.4)' : 'rgba(96,165,250,0.4)';
                    ctx.lineWidth   = 1;
                    ctx.setLineDash([2, 3]);
                    ctx.beginPath();
                    ctx.moveTo(x, y + r);
                    ctx.lineTo(x, chToY(0));
                    ctx.stroke();
                    ctx.setLineDash([]);
                });
            }

            // ‚îÄ‚îÄ Y-axis canvas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const yPanel = document.getElementById('lsmYPanel');
            yCv.width  = 90;
            yCv.height = cH;
            yCv.style.height = cH + 'px';
            // Sync Y panel height
            const yContainer = yCv.parentElement;
            if (yContainer) yContainer.style.height = (cH + 44) + 'px';

            const yCtx = yCv.getContext('2d');
            yCtx.clearRect(0, 0, 90, cH);
            yCtx.fillStyle = '#1e293b';
            yCtx.fillRect(0, 0, 90, cH);

            for (let ch = 0; ch <= maxCh; ch += CH_STEP) {
                const y = chToY(ch);
                const km  = Math.floor(ch / 1000);
                const rem = String(ch % 1000).padStart(3, '0');
                const lbl = `${km}+${rem}`;

                yCtx.fillStyle   = '#64748b';
                yCtx.font        = '10px Segoe UI';
                yCtx.textAlign   = 'right';
                yCtx.fillText('Ch ' + lbl, 84, y + 4);

                yCtx.strokeStyle = '#334155';
                yCtx.lineWidth   = 0.5;
                yCtx.beginPath(); yCtx.moveTo(84, y); yCtx.lineTo(90, y); yCtx.stroke();
            }

            // ‚îÄ‚îÄ X-axis canvas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            xCv.width  = cW;
            xCv.height = 44;
            xCv.style.width = cW + 'px';

            const xCtx = xCv.getContext('2d');
            xCtx.clearRect(0, 0, cW, 44);
            xCtx.fillStyle = '#0f172a';
            xCtx.fillRect(0, 0, cW, 44);

            const cur2 = new Date(T0); cur2.setDate(1);
            let prevYear = -1;
            while (cur2 <= end) {
                const d = Math.floor((cur2 - T0) / 86400000);
                const x = dayToX(d);
                const mo = cur2.toLocaleDateString('en-GB', {month: 'short'});
                const yr = cur2.getFullYear();

                xCtx.fillStyle   = '#475569';
                xCtx.font        = '10px Segoe UI';
                xCtx.textAlign   = 'center';
                xCtx.fillText(mo, x + PX_DAY * 15, 16);

                if (yr !== prevYear) {
                    xCtx.fillStyle = '#94a3b8';
                    xCtx.font      = 'bold 11px Segoe UI';
                    xCtx.fillText(yr, x + PX_DAY * 15, 34);
                    prevYear = yr;
                    // Year separator
                    xCtx.strokeStyle = '#334155';
                    xCtx.lineWidth   = 1;
                    xCtx.beginPath(); xCtx.moveTo(x, 0); xCtx.lineTo(x, 44); xCtx.stroke();
                }
                cur2.setMonth(cur2.getMonth() + 1);
            }

            // ‚îÄ‚îÄ Sync X-axis scroll + Y-axis via transform ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const xWrapper = document.getElementById('lsmXWrapper');
            const yCv_el   = document.getElementById('lsmYCanvas');
            
            // Y canvas uses translateY so it follows vertical scroll exactly
            if (yCv_el) {
                yCv_el.style.height = cH + 'px';
                yCv_el.style.transform = 'translateY(-' + (scrollBox.scrollTop || 0) + 'px)';
            }
            
            // Remove old listener and rebind fresh each render
            if (scrollBox._lsmHandler) {
                scrollBox.removeEventListener('scroll', scrollBox._lsmHandler);
            }
            scrollBox._lsmHandler = () => {
                if (xWrapper) xWrapper.scrollLeft = scrollBox.scrollLeft;
                const yCv2 = document.getElementById('lsmYCanvas');
                if (yCv2) yCv2.style.transform = 'translateY(-' + scrollBox.scrollTop + 'px)';
            };
            scrollBox.addEventListener('scroll', scrollBox._lsmHandler);

            // Store render params for tooltip
            mainCv._dayToX  = dayToX;
            mainCv._chToY   = chToY;
            mainCv._T0      = T0;
            mainCv._PX_DAY  = PX_DAY;
            mainCv._maxCh   = maxCh;
            mainCv._cH      = cH;
            mainCv._PAD_T   = PAD_T;
            mainCv._PAD_B   = PAD_B;
        }

        // ‚îÄ‚îÄ Tooltip on hover ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function lsmBindTooltip() {
            const cv      = document.getElementById('lsmMainCanvas');
            const tooltip = document.getElementById('lsmTooltip');
            const box     = document.getElementById('lsmScrollBox');
            if (!cv || !tooltip) return;
            if (cv._tooltipBound) return;
            cv._tooltipBound = true;

            cv.addEventListener('mousemove', e => {
                const rect   = cv.getBoundingClientRect();
                const mx     = e.clientX - rect.left;
                const my     = e.clientY - rect.top;
                const PX_DAY = cv._PX_DAY || 3.5;
                const T0     = cv._T0;
                const maxCh  = cv._maxCh || 42000;
                const cH     = cv._cH || 600;
                const PAD_T  = cv._PAD_T || 10;
                const PAD_B  = cv._PAD_B || 10;

                const hoverDay = mx / PX_DAY;
                const hoverCh  = (1 - (my - PAD_T) / (cH - PAD_T - PAD_B)) * maxCh;

                // Check structure markers first
                let hit = null;
                if (lsmShowStructs) {
                    for (const st of lsmStructMarkers) {
                        const sx = (st.dayStart + (st.dayEnd - st.dayStart) / 2) * PX_DAY;
                        const sy = PAD_T + (1 - st.ch / maxCh) * (cH - PAD_T - PAD_B);
                        if (Math.abs(mx - sx) < 14 && Math.abs(my - sy) < 14) {
                            hit = { type:'structure', data: st };
                            break;
                        }
                    }
                }

                // Check activity bands
                if (!hit) {
                    for (const band of lsmBands) {
                        const x0 = band.d0 * PX_DAY;
                        const x1 = band.d1 * PX_DAY;
                        const y0 = PAD_T + (1 - band.ch0 / maxCh) * (cH - PAD_T - PAD_B);
                        const y1 = PAD_T + (1 - band.ch1 / maxCh) * (cH - PAD_T - PAD_B);
                        const inX = mx >= x0 - 4 && mx <= x1 + 4;
                        const inY = my >= Math.min(y0,y1) - 4 && my <= Math.max(y0,y1) + 4;
                        if (inX && inY) { hit = { type:'band', data: band }; break; }
                    }
                }

                if (hit) {
                    cv.style.cursor = 'pointer';
                    let html = '';
                    if (hit.type === 'structure') {
                        const st = hit.data;
                        const ds = st.dateStart.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
                        const de = st.dateEnd.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
                        const ch = Math.floor(st.ch/1000) + '+' + String(Math.round(st.ch%1000)).padStart(3,'0');
                        html = `<div style="font-weight:700;color:#93c5fd;margin-bottom:4px;">${st.wbs} ${st.name}</div>
                                <div style="color:#64748b;font-size:0.72rem;margin-bottom:6px;">Structure</div>
                                <div>üìç Ch ${ch}</div>
                                <div>üìÖ ${ds} ‚Üí ${de}</div>
                                <div>‚è± ${st.dayEnd - st.dayStart}d</div>
                                ${st.critical ? '<div style="color:#f87171;font-weight:600;margin-top:4px;">üî¥ Critical Path</div>' : ''}`;
                    } else {
                        const b  = hit.data;
                        const ds = new Date(T0); ds.setDate(ds.getDate() + b.d0);
                        const de = new Date(T0); de.setDate(de.getDate() + b.d1);
                        const fmt = dt => dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
                        const ch0 = Math.floor(b.ch0/1000)+'+'+String(b.ch0%1000).padStart(3,'0');
                        const ch1 = Math.floor(b.ch1/1000)+'+'+String(b.ch1%1000).padStart(3,'0');
                        html = `<div style="font-weight:700;color:${b.stroke};margin-bottom:4px;">${b.name}</div>
                                <div style="color:#64748b;font-size:0.72rem;margin-bottom:6px;">${b.wbs} ‚Äî ${b.stretch}</div>
                                <div>üìç Ch ${ch0} ‚Üí Ch ${ch1}</div>
                                <div>üìÖ ${fmt(ds)} ‚Üí ${fmt(de)}</div>
                                <div>‚è± ${b.duration}d  |  üë∑ ${b.resource}</div>
                                ${b.critical ? '<div style="color:#f87171;font-weight:600;margin-top:4px;">üî¥ Critical Path</div>' : ''}`;
                    }
                    tooltip.innerHTML = html;
                    tooltip.style.display = 'block';
                    tooltip.style.left = (e.clientX + 14) + 'px';
                    tooltip.style.top  = (e.clientY - 10) + 'px';
                    // Flip if near right edge
                    const tw = 280;
                    if (e.clientX + 14 + tw > window.innerWidth) {
                        tooltip.style.left = (e.clientX - tw - 14) + 'px';
                    }
                } else {
                    cv.style.cursor = 'crosshair';
                    tooltip.style.display = 'none';
                }
            });

            cv.addEventListener('mouseleave', () => {
                document.getElementById('lsmTooltip').style.display = 'none';
            });
        }

        // ‚îÄ‚îÄ Initialize LSM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function initializeLSM() {
            // Ensure computed is current (one refresh max)
            if (!KALYANTRA.computed.wbs || KALYANTRA.computed.wbs.length === 0) {
                KALYANTRA.refresh();
            }
            buildLSMBands();
            renderLSM();
            if (!lsmInitialized) {
                lsmInitialized = true;
                lsmBindTooltip();
            }
        }

        // ‚îÄ‚îÄ Controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function lsmZoomIn()  {
            lsmZoom = Math.min(lsmZoom * 1.4, 6);
            document.getElementById('lsmZoomLabel').textContent = Math.round(lsmZoom * 100) + '%';
            renderLSM();
        }
        function lsmZoomOut() {
            lsmZoom = Math.max(lsmZoom / 1.4, 0.25);
            document.getElementById('lsmZoomLabel').textContent = Math.round(lsmZoom * 100) + '%';
            renderLSM();
        }
        function lsmResetView() {
            lsmZoom = 1.0;
            document.getElementById('lsmZoomLabel').textContent = '100%';
            const box = document.getElementById('lsmScrollBox');
            if (box) { box.scrollLeft = 0; box.scrollTop = 0; }
            renderLSM();
        }
        function lsmToggleCritical() {
            lsmShowCritical = !lsmShowCritical;
            const btn = document.getElementById('lsmBtnCritical');
            if (btn) {
                btn.style.background = lsmShowCritical ? '#7f1d1d' : '#1e293b';
                btn.style.opacity    = lsmShowCritical ? '1' : '0.5';
            }
            renderLSM();
        }
        function lsmToggleStructures() {
            lsmShowStructs = !lsmShowStructs;
            const btn = document.getElementById('lsmBtnStructures');
            if (btn) btn.style.opacity = lsmShowStructs ? '1' : '0.5';
            renderLSM();
        }
        function lsmToggleHindrances() {
            lsmShowHindrance = !lsmShowHindrance;
            const btn = document.getElementById('lsmBtnHindrances');
            if (btn) btn.style.opacity = lsmShowHindrance ? '1' : '0.5';
            renderLSM();
        }
        // Legacy aliases (called from tab switch handler)
        function buildLSMActivities() { buildLSMBands(); }
        function renderLSMAxes()      { /* handled inside renderLSM */ }
        function renderLSMActivities(){ renderLSM(); }

        
        // Initialize LSM when tab is opened
        document.addEventListener('DOMContentLoaded', function() {
            // Will initialize when tab 7 child tab 3 is first opened
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    const tab = document.getElementById('tab7content3');
                    if (tab && tab.style.display !== 'none') {
                        initializeLSM();
                        observer.disconnect();
                    }
                });
            });
            
            const tab = document.getElementById('tab7content3');
            if (tab) {
                observer.observe(tab, { attributes: true, attributeFilter: ['style'] });
            }
        });

        // ============================================
        // KALYANTRA V6.1 - DATA FLOW SYSTEM (FULLY CONNECTED)
        // ============================================
        
        const KALYANTRA = {
            version: '6.6-AllAuditFixes',
            
            // ‚îÄ‚îÄ RAW DATA STORE (single source of truth) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            data: {
                project: {
                    name: 'Package-I | 4-Lane | 42 km | HAM',
                    budget: 1356.90,
                    startDate: '2025-02-01',
                    endDate: '2027-02-01',
                    location: 'Telangana ‚Äî Ch 0+000 to Ch 42+000',
                    startChainage: 0,
                    endChainage: 42000,
                    industryType: 'roads',
                    projectMode: 'HAM',
                    duration: 730,
                    appointedDate: '2025-02-01',
                    loaDate: '2024-12-18',
                    contractorName: 'HAM Concessionaire',
                    authority: 'NHAI',
                    bidProjectCost: 1356.90,
                    omCostY1: 11.95,
                    constructionSupport: 40,
                    annuityPayments: 13,
                    milestone1Day: 230,
                    milestone2Day: 340,
                    milestone3Day: 510,
                    milestone1Pct: 20,
                    milestone2Pct: 35,
                    milestone3Pct: 75,
                    physicalProgress: 40,
                    financialProgress: 35
                },

                tcs: {
                    carriageWidth: 7.0,
                    shoulderWidth: 2.5,
                    medianWidth: 4.0,
                    rows: [
                        // ‚îÄ‚îÄ MANCHERIAL BYPASS (Ch 0+000 ‚Üí 12+082) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        { id:'T01', fig:'2.4X',  fromCh:    0, toCh:  200, lengthKm:0.200, row:'60m', type:'Interchange Ramp', srCh:'2-Lane ramp at Ch 0+000 (NH-63 junction)', mainCarr:7.0, shoulder:2.5, median:'-', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T02', fig:'2.4D',  fromCh:  200, toCh:  450, lengthKm:0.250, row:'60m', type:'Bypass ‚Äî 4m Raised Median', srCh:'Trumpet approach', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T03', fig:'7.8',   fromCh:  450, toCh:  510, lengthKm:0.060, row:'60m', type:'VUP', srCh:'VUP-1 at Ch 0+450', mainCarr:14.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T04', fig:'2.4D',  fromCh:  510, toCh:  700, lengthKm:0.190, row:'60m', type:'Bypass ‚Äî 4m Raised Median', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T05', fig:'2.5A',  fromCh:  700, toCh: 1570, lengthKm:0.870, row:'60m', type:'Bypass with Service Road', srCh:'Service road both sides 7m wide', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-1' },
                        { id:'T06', fig:'2.5D',  fromCh: 1570, toCh: 2093, lengthKm:0.523, row:'60m', type:'Bypass Slip Road Transition', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-1' },
                        { id:'T07', fig:'7.8',   fromCh: 2093, toCh: 2108, lengthKm:0.015, row:'60m', type:'VUP', srCh:'VUP-2 at Ch 2+093', mainCarr:14.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T08', fig:'2.5D',  fromCh: 2108, toCh: 2310, lengthKm:0.202, row:'60m', type:'Bypass Slip Road Transition', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-1' },
                        { id:'T09', fig:'2.5A',  fromCh: 2310, toCh: 2820, lengthKm:0.510, row:'60m', type:'Bypass with Service Road', srCh:'Service road both sides 7m wide', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-1' },
                        { id:'T10', fig:'2.5D',  fromCh: 2820, toCh: 3062, lengthKm:0.242, row:'60m', type:'Bypass Slip Road Transition', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-1' },
                        { id:'T11', fig:'7.8A',  fromCh: 3062, toCh: 3074, lengthKm:0.012, row:'60m', type:'LVUP', srCh:'LVUP-1 at Ch 3+062', mainCarr:10.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T12', fig:'2.5D',  fromCh: 3074, toCh: 3680, lengthKm:0.606, row:'60m', type:'Bypass Slip Road Transition', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-1' },
                        { id:'T13', fig:'2.4E',  fromCh: 3680, toCh: 3747, lengthKm:0.067, row:'60m', type:'ROB Approach', srCh:'ROB-1 approach at Ch 3+713', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T14', fig:'2.5D',  fromCh: 3747, toCh: 4148, lengthKm:0.401, row:'60m', type:'Bypass Slip Road Transition', srCh:'Post ROB-1', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-1' },
                        { id:'T15', fig:'7.8',   fromCh: 4148, toCh: 4188, lengthKm:0.040, row:'60m', type:'VUP', srCh:'VUP-3 at Ch 4+148', mainCarr:14.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T16', fig:'2.5D',  fromCh: 4188, toCh: 4710, lengthKm:0.522, row:'60m', type:'Bypass Slip Road Transition', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-1' },
                        { id:'T17', fig:'2.4E',  fromCh: 4710, toCh: 5116, lengthKm:0.406, row:'60m', type:'ROB Approach', srCh:'ROB-2 approach at Ch 6+016', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T18', fig:'7.3',   fromCh: 5116, toCh: 5124, lengthKm:0.008, row:'60m', type:'Minor Bridge', srCh:'MIB at Ch 5+116', mainCarr:10.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T19', fig:'2.4E',  fromCh: 5124, toCh: 5432, lengthKm:0.308, row:'60m', type:'ROB Approach', srCh:'ROB-2 continued', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T20', fig:'2.4E',  fromCh: 5432, toCh: 6384, lengthKm:0.952, row:'60m', type:'ROB Approach', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T21', fig:'7.3',   fromCh: 6384, toCh: 6400, lengthKm:0.016, row:'60m', type:'Minor Bridge', srCh:'MIB at Ch 6+384', mainCarr:10.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T22', fig:'2.4E',  fromCh: 6400, toCh: 6560, lengthKm:0.160, row:'60m', type:'ROB Approach', srCh:'Post ROB-2', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T23', fig:'2.5D',  fromCh: 6560, toCh: 6951, lengthKm:0.391, row:'60m', type:'Bypass Slip Road Transition', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-1' },
                        { id:'T24', fig:'7.8A',  fromCh: 6951, toCh: 6963, lengthKm:0.012, row:'60m', type:'LVUP', srCh:'LVUP-2 at Ch 6+951', mainCarr:10.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T25', fig:'2.5D',  fromCh: 6963, toCh: 7400, lengthKm:0.437, row:'60m', type:'Bypass Slip Road Transition', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-1' },
                        { id:'T26', fig:'2.5A',  fromCh: 7400, toCh: 8260, lengthKm:0.860, row:'60m', type:'Bypass with Service Road', srCh:'Service road both sides 7m wide', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-1' },
                        { id:'T27', fig:'2.5D',  fromCh: 8260, toCh: 8610, lengthKm:0.350, row:'60m', type:'Bypass Slip Road Transition', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-1' },
                        { id:'T28', fig:'7.8',   fromCh: 8610, toCh: 8625, lengthKm:0.015, row:'60m', type:'VUP', srCh:'VUP-4 at Ch 8+610', mainCarr:14.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T29', fig:'2.5D',  fromCh: 8625, toCh: 8918, lengthKm:0.293, row:'60m', type:'Bypass Slip Road Transition', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-1' },
                        { id:'T30', fig:'7.2BA', fromCh: 8918, toCh: 8934, lengthKm:0.016, row:'60m', type:'Minor Bridge', srCh:'MIB at Ch 8+918', mainCarr:16.0, shoulder:'-', median:'-', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T31', fig:'2.5D',  fromCh: 8934, toCh: 9230, lengthKm:0.296, row:'60m', type:'Bypass Slip Road Transition', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-1' },
                        { id:'T32', fig:'2.5A',  fromCh: 9230, toCh: 9782, lengthKm:0.552, row:'60m', type:'Bypass with Service Road', srCh:'Service road both sides', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-1' },
                        { id:'T33', fig:'2.4E',  fromCh: 9782, toCh:10879, lengthKm:1.097, row:'60m', type:'ROB Approach', srCh:'ROB-3 approach at Ch 10+278', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T34', fig:'7.3',   fromCh:10879, toCh:10887, lengthKm:0.008, row:'60m', type:'Minor Bridge', srCh:'MIB at Ch 10+879', mainCarr:10.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T35', fig:'2.4E',  fromCh:10887, toCh:11132, lengthKm:0.245, row:'60m', type:'ROB Approach', srCh:'Post ROB-3', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T36', fig:'2.5A',  fromCh:11132, toCh:11530, lengthKm:0.398, row:'60m', type:'Bypass with Service Road', srCh:'Service road both sides', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-1' },
                        { id:'T37', fig:'2.5D',  fromCh:11530, toCh:12067, lengthKm:0.537, row:'60m', type:'Bypass Slip Road Transition', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-1' },
                        { id:'T38', fig:'7.8',   fromCh:12067, toCh:12097, lengthKm:0.030, row:'60m', type:'VUP', srCh:'VUP-5 at Ch 12+067', mainCarr:14.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Bypass-1' },
                        { id:'T39', fig:'2.5D',  fromCh:12097, toCh:12660, lengthKm:0.563, row:'60m', type:'Bypass Slip Road Transition', srCh:'End of Bypass-1', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-1' },

                        // ‚îÄ‚îÄ MAIN ALIGNMENT (Ch 12+660 ‚Üí 24+582) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        { id:'T40', fig:'2.4',   fromCh:12660, toCh:13009, lengthKm:0.349, row:'45m', type:'4-Lane Concentric Widening', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Main' },
                        { id:'T41', fig:'7.3',   fromCh:13009, toCh:13039, lengthKm:0.030, row:'45m', type:'Minor Bridge', srCh:'MIB at Ch 13+009', mainCarr:10.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Main' },
                        { id:'T42', fig:'2.4',   fromCh:13039, toCh:13292, lengthKm:0.253, row:'45m', type:'4-Lane Concentric Widening', srCh:'End of Bypass-1 join', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Main' },
                        { id:'T43', fig:'2.4A',  fromCh:13292, toCh:13800, lengthKm:0.508, row:'45m', type:'4-Lane Concentric Widening', srCh:'ROW changes to 45m', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Main' },
                        { id:'T44', fig:'2.6C',  fromCh:13800, toCh:14239, lengthKm:0.439, row:'45m', type:'Built-Up with Service Road', srCh:'Approach to underpass', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Main' },
                        { id:'T45', fig:'7.8A',  fromCh:14239, toCh:14251, lengthKm:0.012, row:'45m', type:'LVUP', srCh:'LVUP-3 at Ch 14+239', mainCarr:10.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Main' },
                        { id:'T46', fig:'2.6C',  fromCh:14251, toCh:14800, lengthKm:0.549, row:'45m', type:'Built-Up with Service Road', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Main' },
                        { id:'T47', fig:'2.4A',  fromCh:14800, toCh:16680, lengthKm:1.880, row:'45m', type:'4-Lane Concentric Widening', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Main' },
                        { id:'T48', fig:'2.6C',  fromCh:16680, toCh:17101, lengthKm:0.421, row:'45m', type:'Built-Up with Service Road', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Main' },
                        { id:'T49', fig:'7.8A',  fromCh:17101, toCh:17113, lengthKm:0.012, row:'45m', type:'LVUP', srCh:'LVUP-4 at Ch 17+101', mainCarr:10.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Main' },
                        { id:'T50', fig:'2.6C',  fromCh:17113, toCh:17500, lengthKm:0.387, row:'45m', type:'Built-Up with Service Road', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Main' },
                        { id:'T51', fig:'2.4A',  fromCh:17500, toCh:18420, lengthKm:0.920, row:'45m', type:'4-Lane Concentric Widening', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Main' },
                        { id:'T52', fig:'2.4F',  fromCh:18420, toCh:19200, lengthKm:0.780, row:'45m', type:'ROB Approach (Concentric)', srCh:'ROB-4 approach at Ch 19+002', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Main' },
                        { id:'T53', fig:'2.6C',  fromCh:19200, toCh:19412, lengthKm:0.212, row:'45m', type:'Built-Up with Service Road', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Main' },
                        { id:'T54', fig:'7.8',   fromCh:19412, toCh:19472, lengthKm:0.060, row:'45m', type:'VUP', srCh:'VUP-6 at Ch 19+412', mainCarr:14.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Main' },
                        { id:'T55', fig:'2.6C',  fromCh:19472, toCh:19700, lengthKm:0.228, row:'45m', type:'Built-Up with Service Road', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Main' },
                        { id:'T56', fig:'2.6A',  fromCh:19700, toCh:20797, lengthKm:1.097, row:'60m', type:'Built-Up Town Section', srCh:'Mandamarri town', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Main' },
                        { id:'T57', fig:'7.2BB', fromCh:20797, toCh:20804, lengthKm:0.007, row:'60m', type:'Minor Bridge', srCh:'MIB at Ch 20+797', mainCarr:16.0, shoulder:'-', median:'-', serviceRoad:false, zone:'Main' },
                        { id:'T58', fig:'2.6A',  fromCh:20804, toCh:21000, lengthKm:0.196, row:'60m', type:'Built-Up Town Section', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Main' },
                        { id:'T59', fig:'2.4A',  fromCh:21000, toCh:22070, lengthKm:1.070, row:'45m', type:'4-Lane Concentric Widening', srCh:'Toll Plaza at Ch 21+547', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Main' },
                        { id:'T60', fig:'2.6C',  fromCh:22070, toCh:22249, lengthKm:0.179, row:'45m', type:'Built-Up with Service Road', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Main' },
                        { id:'T61', fig:'7.2BB', fromCh:22249, toCh:22257, lengthKm:0.008, row:'45m', type:'Minor Bridge', srCh:'MIB at Ch 22+249', mainCarr:16.0, shoulder:'-', median:'-', serviceRoad:false, zone:'Main' },
                        { id:'T62', fig:'2.6C',  fromCh:22257, toCh:23121, lengthKm:0.864, row:'45m', type:'Built-Up with Service Road', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Main' },
                        { id:'T63', fig:'7.8',   fromCh:23121, toCh:23151, lengthKm:0.030, row:'45m', type:'VUP', srCh:'VUP-7 at Ch 23+121', mainCarr:14.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Main' },
                        { id:'T64', fig:'2.6C',  fromCh:23151, toCh:23940, lengthKm:0.789, row:'45m', type:'Built-Up with Service Road', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Main' },
                        { id:'T65', fig:'2.4A',  fromCh:23940, toCh:24582, lengthKm:0.642, row:'45m', type:'4-Lane Concentric Widening', srCh:'End of main section, bypass join', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Main' },

                        // ‚îÄ‚îÄ BYPASS-2 (Ch 24+582 ‚Üí 28+982) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        { id:'T66', fig:'2.4',   fromCh:24582, toCh:24651, lengthKm:0.069, row:'60m', type:'Bypass-2 Approach', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Bypass-2' },
                        { id:'T67', fig:'7.3',   fromCh:24651, toCh:24665, lengthKm:0.014, row:'60m', type:'Minor Bridge', srCh:'MIB at Ch 24+651', mainCarr:10.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Bypass-2' },
                        { id:'T68', fig:'2.4',   fromCh:24665, toCh:25101, lengthKm:0.436, row:'60m', type:'Bypass-2', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Bypass-2' },
                        { id:'T69', fig:'7.3',   fromCh:25101, toCh:25117, lengthKm:0.016, row:'60m', type:'Minor Bridge', srCh:'MIB at Ch 25+101', mainCarr:10.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Bypass-2' },
                        { id:'T70', fig:'2.4',   fromCh:25117, toCh:25530, lengthKm:0.413, row:'60m', type:'Bypass-2', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Bypass-2' },
                        { id:'T71', fig:'2.5B',  fromCh:25530, toCh:25750, lengthKm:0.220, row:'60m', type:'Bypass-2 with Service Road', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-2' },
                        { id:'T72', fig:'7.8',   fromCh:25750, toCh:25780, lengthKm:0.030, row:'60m', type:'VUP', srCh:'VUP-8 at Ch 25+750', mainCarr:14.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Bypass-2' },
                        { id:'T73', fig:'2.5B',  fromCh:25780, toCh:26080, lengthKm:0.300, row:'60m', type:'Bypass-2 with Service Road', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-2' },
                        { id:'T74', fig:'2.4',   fromCh:26080, toCh:26217, lengthKm:0.137, row:'60m', type:'Bypass-2', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Bypass-2' },
                        { id:'T75', fig:'7.3',   fromCh:26217, toCh:26257, lengthKm:0.040, row:'60m', type:'Minor Bridge', srCh:'MIB at Ch 26+217', mainCarr:10.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Bypass-2' },
                        { id:'T76', fig:'2.4',   fromCh:26257, toCh:27335, lengthKm:1.078, row:'60m', type:'Bypass-2', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Bypass-2' },
                        { id:'T77', fig:'7.3',   fromCh:27335, toCh:27359, lengthKm:0.024, row:'60m', type:'Minor Bridge', srCh:'MIB at Ch 27+335', mainCarr:10.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Bypass-2' },
                        { id:'T78', fig:'2.5B',  fromCh:27359, toCh:28057, lengthKm:0.698, row:'60m', type:'Bypass-2 with Service Road', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-2' },
                        { id:'T79', fig:'7.8A',  fromCh:28057, toCh:28069, lengthKm:0.012, row:'60m', type:'LVUP', srCh:'LVUP-5 at Ch 28+057', mainCarr:10.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Bypass-2' },
                        { id:'T80', fig:'2.5B',  fromCh:28069, toCh:28967, lengthKm:0.898, row:'60m', type:'Bypass-2 with Service Road', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-2' },
                        { id:'T81', fig:'7.8',   fromCh:28967, toCh:28997, lengthKm:0.030, row:'60m', type:'VUP', srCh:'VUP-9 at Ch 28+967', mainCarr:14.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Bypass-2' },
                        { id:'T82', fig:'2.5B',  fromCh:28997, toCh:29230, lengthKm:0.233, row:'60m', type:'Bypass-2 with Service Road', srCh:'End of Bypass-2', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Bypass-2' },

                        // ‚îÄ‚îÄ MAIN ALIGNMENT-2 (Ch 29+230 ‚Üí 42+000) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        { id:'T83', fig:'2.4A',  fromCh:29230, toCh:33700, lengthKm:4.470, row:'45m', type:'4-Lane Concentric Widening', srCh:'Long plain section', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Main' },
                        { id:'T84', fig:'2.6C',  fromCh:33700, toCh:34276, lengthKm:0.576, row:'45m', type:'Built-Up with Service Road', srCh:'Boyapalle built-up area', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Main' },
                        { id:'T85', fig:'7.8A',  fromCh:34276, toCh:34288, lengthKm:0.012, row:'45m', type:'LVUP', srCh:'LVUP-6 at Ch 34+276', mainCarr:10.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Main' },
                        { id:'T86', fig:'2.6C',  fromCh:34288, toCh:34530, lengthKm:0.242, row:'45m', type:'Built-Up with Service Road', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Main' },
                        { id:'T87', fig:'2.4A',  fromCh:34530, toCh:34758, lengthKm:0.228, row:'45m', type:'4-Lane Concentric Widening', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Main' },
                        { id:'T88', fig:'7.3',   fromCh:34758, toCh:34773, lengthKm:0.015, row:'45m', type:'Minor Bridge', srCh:'MIB at Ch 34+758', mainCarr:10.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Main' },
                        { id:'T89', fig:'2.4A',  fromCh:34773, toCh:35078, lengthKm:0.305, row:'45m', type:'4-Lane Concentric Widening', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Main' },
                        { id:'T90', fig:'7.3',   fromCh:35078, toCh:35096, lengthKm:0.018, row:'45m', type:'Minor Bridge', srCh:'MIB at Ch 35+078', mainCarr:10.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Main' },
                        { id:'T91', fig:'2.4A',  fromCh:35096, toCh:36982, lengthKm:1.886, row:'45m', type:'4-Lane Concentric Widening', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Main' },
                        { id:'T92', fig:'7.3',   fromCh:36982, toCh:36996, lengthKm:0.014, row:'45m', type:'Minor Bridge', srCh:'MIB at Ch 36+982', mainCarr:10.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Main' },
                        { id:'T93', fig:'2.4A',  fromCh:36996, toCh:37680, lengthKm:0.684, row:'45m', type:'4-Lane Concentric Widening', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Main' },
                        { id:'T94', fig:'2.6A',  fromCh:37680, toCh:38400, lengthKm:0.720, row:'60m', type:'Built-Up Town Section', srCh:'Tandur town', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Main' },
                        { id:'T95', fig:'2.6C',  fromCh:38400, toCh:39162, lengthKm:0.762, row:'45m', type:'Built-Up with Service Road', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Main' },
                        { id:'T96', fig:'7.8',   fromCh:39162, toCh:39192, lengthKm:0.030, row:'45m', type:'VUP', srCh:'VUP-10 at Ch 39+162', mainCarr:14.5, shoulder:'-', median:'-', serviceRoad:false, zone:'Main' },
                        { id:'T97', fig:'2.6C',  fromCh:39192, toCh:39900, lengthKm:0.708, row:'45m', type:'Built-Up with Service Road', srCh:'', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:true, zone:'Main' },
                        { id:'T98', fig:'2.4A',  fromCh:39900, toCh:42000, lengthKm:2.100, row:'45m', type:'4-Lane Concentric Widening', srCh:'Final section to project end', mainCarr:7.0, shoulder:2.5, median:'4m Raised', serviceRoad:false, zone:'Main' }
                    ],
                    layers: {
                        main: { subgrade:500, gsb:200, wmm:250, dbm:115, bc:50, total:1115, msa:115, designLife:15 },
                        serviceRoad: { subgrade:500, gsb:200, wmm:250, dbm:50, bc:40, total:1040, msa:10 },
                        tollPlaza: { subgrade:500, gsb:150, dlc:150, pqc:280, type:'Rigid' }
                    }
                },

                structures: [
                    // ‚îÄ‚îÄ 4 ROBs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    { id:1, name:'ROB-1 Ch 3+713', type:'rob', chainage:3713, zone:'Bypass-1',
                      totalLength:97, width:16.0,
                      spans:[
                        {spanNo:1, foundationType:'pile', superType:'psc_girder', length:45, width:16, skew:0, crossing:'Railway'},
                        {spanNo:2, foundationType:'pile', superType:'psc_girder', length:37.2, width:16, skew:0, crossing:'Railway'},
                        {spanNo:3, foundationType:'pile', superType:'psc_girder', length:15, width:16, skew:0, crossing:'Railway'}
                      ],
                      railwayClearance: true, approvedGAD: false, frozen:false,
                      progressPct:0, status:'Foundation in progress' },
                    { id:2, name:'ROB-2 Ch 6+016', type:'rob', chainage:6016, zone:'Bypass-1',
                      totalLength:74, width:16.0,
                      spans:[
                        {spanNo:1, foundationType:'pile', superType:'psc_girder', length:37.2, width:16, skew:0, crossing:'Railway'},
                        {spanNo:2, foundationType:'pile', superType:'psc_girder', length:37.2, width:16, skew:0, crossing:'Railway'}
                      ],
                      railwayClearance: true, approvedGAD: false, frozen:false,
                      progressPct:0, status:'Foundation in progress' },
                    { id:3, name:'ROB-3 Ch 10+278', type:'rob', chainage:10278, zone:'Bypass-1',
                      totalLength:104, width:16.0,
                      spans:[
                        {spanNo:1, foundationType:'pile', superType:'psc_girder', length:20, width:16, skew:0, crossing:'Railway'},
                        {spanNo:2, foundationType:'pile', superType:'psc_girder', length:63.4, width:16, skew:0, crossing:'Railway'},
                        {spanNo:3, foundationType:'pile', superType:'psc_girder', length:20, width:16, skew:0, crossing:'Railway'}
                      ],
                      railwayClearance: true, approvedGAD: false, frozen:false,
                      progressPct:0, status:'Awaiting Railway clearance' },
                    { id:4, name:'ROB-4 Ch 19+002', type:'rob', chainage:19002, zone:'Main',
                      totalLength:37, width:16.0,
                      spans:[
                        {spanNo:1, foundationType:'pile', superType:'psc_girder', length:37.2, width:16, skew:0, crossing:'Railway'}
                      ],
                      railwayClearance: true, approvedGAD: false, frozen:false,
                      progressPct:0, status:'Not started' },

                    // ‚îÄ‚îÄ MINOR BRIDGES (12 nos) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    { id:5, name:'MIB-1 Ch 5+116', type:'minor_bridge', chainage:5116, zone:'Bypass-1',
                      totalLength:8, width:10.75,
                      spans:[{spanNo:1, foundationType:'open_foundation', superType:'rcc_slab', length:8, width:10.75, skew:0, crossing:'Nala'}],
                      frozen:false, progressPct:0, status:'Not started' },
                    { id:6, name:'MIB-2 Ch 6+384', type:'minor_bridge', chainage:6384, zone:'Bypass-1',
                      totalLength:16, width:10.75,
                      spans:[{spanNo:1, foundationType:'open_foundation', superType:'rcc_slab', length:16, width:10.75, skew:0, crossing:'Nala'}],
                      frozen:false, progressPct:0, status:'Not started' },
                    { id:7, name:'MIB-3 Ch 8+918', type:'minor_bridge', chainage:8918, zone:'Bypass-1',
                      totalLength:16, width:16.0,
                      spans:[{spanNo:1, foundationType:'open_foundation', superType:'rcc_slab', length:16, width:16, skew:0, crossing:'Nala'}],
                      frozen:false, progressPct:0, status:'Not started' },
                    { id:8, name:'MIB-4 Ch 10+879', type:'minor_bridge', chainage:10879, zone:'Bypass-1',
                      totalLength:8, width:10.5,
                      spans:[{spanNo:1, foundationType:'open_foundation', superType:'rcc_slab', length:8, width:10.5, skew:0, crossing:'Nala'}],
                      frozen:false, progressPct:0, status:'Not started' },
                    { id:9, name:'MIB-5 Ch 13+009', type:'minor_bridge', chainage:13009, zone:'Main',
                      totalLength:10, width:10.75,
                      spans:[{spanNo:1, foundationType:'open_foundation', superType:'rcc_slab', length:10, width:10.75, skew:0, crossing:'Nala'}],
                      frozen:false, progressPct:0, status:'Not started' },
                    { id:10, name:'MIB-6 Ch 20+797', type:'minor_bridge', chainage:20797, zone:'Main',
                      totalLength:7, width:16.0,
                      spans:[{spanNo:1, foundationType:'open_foundation', superType:'rcc_slab', length:7, width:16, skew:0, crossing:'Nala'}],
                      frozen:false, progressPct:0, status:'Not started' },
                    { id:11, name:'MIB-7 Ch 22+249', type:'minor_bridge', chainage:22249, zone:'Main',
                      totalLength:8, width:16.0,
                      spans:[{spanNo:1, foundationType:'open_foundation', superType:'rcc_slab', length:8, width:16, skew:0, crossing:'Nala'}],
                      frozen:false, progressPct:0, status:'Not started' },
                    { id:12, name:'MIB-8 Ch 22+253 (Recon)', type:'minor_bridge', chainage:22253, zone:'Main',
                      totalLength:8.99, width:10.75,
                      spans:[{spanNo:1, foundationType:'open_foundation', superType:'rcc_slab', length:9, width:10.75, skew:0, crossing:'Nala'}],
                      frozen:false, progressPct:0, status:'Not started' },
                    { id:13, name:'MIB-9 Ch 24+651', type:'minor_bridge', chainage:24651, zone:'Bypass-2',
                      totalLength:14, width:10.5,
                      spans:[{spanNo:1, foundationType:'open_foundation', superType:'rcc_slab', length:14, width:10.5, skew:0, crossing:'Nala'}],
                      frozen:false, progressPct:0, status:'Not started' },
                    { id:14, name:'MIB-10 Ch 25+101', type:'minor_bridge', chainage:25101, zone:'Bypass-2',
                      totalLength:16, width:10.5,
                      spans:[{spanNo:1, foundationType:'open_foundation', superType:'rcc_slab', length:16, width:10.5, skew:0, crossing:'Nala'}],
                      frozen:false, progressPct:0, status:'Not started' },
                    { id:15, name:'MIB-11 Ch 26+217', type:'minor_bridge', chainage:26217, zone:'Bypass-2',
                      totalLength:15, width:10.5,
                      spans:[{spanNo:1, foundationType:'open_foundation', superType:'rcc_slab', length:15, width:10.5, skew:0, crossing:'Nala'}],
                      frozen:false, progressPct:0, status:'Not started' },
                    { id:16, name:'MIB-12 Ch 27+335', type:'minor_bridge', chainage:27335, zone:'Bypass-2',
                      totalLength:24, width:10.5,
                      spans:[{spanNo:1, foundationType:'open_foundation', superType:'rcc_slab', length:24, width:10.5, skew:0, crossing:'Nala'}],
                      frozen:false, progressPct:0, status:'Not started' },

                    // ‚îÄ‚îÄ KEY VUPs (10 nos ‚Äî show 3 for structures panel, rest are TCS entries) ‚îÄ
                    { id:17, name:'VUP-1 Ch 0+450', type:'vup', chainage:450, zone:'Bypass-1',
                      totalLength:30, width:14.5, verticalClearance:5.5,
                      spans:[{spanNo:1, foundationType:'open_foundation', superType:'rcc_box', length:30, width:14.5, skew:0, crossing:'Road'}],
                      frozen:false, progressPct:0, status:'Not started' },
                    { id:18, name:'VUP-3 Ch 4+148', type:'vup', chainage:4148, zone:'Bypass-1',
                      totalLength:15, width:14.5, verticalClearance:5.5,
                      spans:[{spanNo:1, foundationType:'open_foundation', superType:'rcc_box', length:15, width:14.5, skew:0, crossing:'Road'}],
                      frozen:false, progressPct:0, status:'Not started' },
                    { id:19, name:'LVUP-1 Ch 3+062', type:'lvup', chainage:3062, zone:'Bypass-1',
                      totalLength:12, width:10.5, verticalClearance:4.0,
                      spans:[{spanNo:1, foundationType:'open_foundation', superType:'rcc_box', length:12, width:10.5, skew:0, crossing:'Road'}],
                      frozen:false, progressPct:0, status:'Not started' },
                    { id:20, name:'Toll Plaza Ch 21+547', type:'toll_plaza', chainage:21547, zone:'Main',
                      totalLength:0, width:0,
                      spans:[],
                      frozen:false, progressPct:0, status:'Not started' }
                ],

                hindrances: [
                    { id:1, type:'forest', category:'Forest Clearance', chainageStart:7500, chainageEnd:9200,
                      status:'Pending', criticality:'HIGH', resolutionDays:90,
                      description:'Forest land diversion ‚Äî MoEF Stage-2 approval pending. Affects ROB-2 and ROB-3 approach stretch.',
                      owner:'NHAI', jmRef:'', jmDate:'' },
                    { id:2, type:'railway', category:'Railway Coordination', chainageStart:10100, chainageEnd:10500,
                      status:'Pending', criticality:'HIGH', resolutionDays:120,
                      description:'ROB-3 GAD approval pending from Railway Division. P&E charges deposited. Awaiting drawing approval.',
                      owner:'NHAI', jmRef:'', jmDate:'' },
                    { id:3, type:'utility', category:'Utility Shifting', chainageStart:15000, chainageEnd:15500,
                      status:'Pending', criticality:'MEDIUM', resolutionDays:45,
                      description:'OHE line shifting at Ch 15+000 to 15+500. Coordination with TSECPDCL initiated.',
                      owner:'Contractor', jmRef:'', jmDate:'' }
                ],

                calendar: {
                    workingDays: [1,2,3,4,5,6],
                    hoursPerDay: 10,
                    monsoonStart: '2025-06-15',
                    monsoonEnd:   '2025-09-30',
                    holidays: ['2025-08-15','2025-10-02','2026-01-26','2026-08-15']
                },

                resources: {
                    equipment: [],
                    manpower:  [],
                    materials: []
                },

                boq: {
                    tcsList: [
                    {
                                        "id": "tcs_bypass1_road",
                                        "name": "TCS-1 | Bypass-1 Road Sections (Ch 0+000\u201312+660)",
                                        "roadCategory": "NH/SH",
                                        "constType": "New",
                                        "elements": {},
                                        "frozen": false,
                                        "locations": [
                                                            {
                                                                                "fromCh": 0,
                                                                                "toCh": 700,
                                                                                "label": "Ch 0+000\u20130+700 (Ramp+Median)"
                                                            },
                                                            {
                                                                                "fromCh": 700,
                                                                                "toCh": 2820,
                                                                                "label": "Ch 0+700\u20132+820 (Bypass SR)"
                                                            },
                                                            {
                                                                                "fromCh": 2820,
                                                                                "toCh": 4710,
                                                                                "label": "Ch 2+820\u20134+710 (Bypass SR cont.)"
                                                            },
                                                            {
                                                                                "fromCh": 4710,
                                                                                "toCh": 7400,
                                                                                "label": "Ch 4+710\u20137+400 (Bypass SR)"
                                                            },
                                                            {
                                                                                "fromCh": 7400,
                                                                                "toCh": 9230,
                                                                                "label": "Ch 7+400\u20139+230 (Bypass SR)"
                                                            },
                                                            {
                                                                                "fromCh": 9230,
                                                                                "toCh": 12097,
                                                                                "label": "Ch 9+230\u201312+097 (Bypass SR)"
                                                            },
                                                            {
                                                                                "fromCh": 12097,
                                                                                "toCh": 12660,
                                                                                "label": "Ch 12+097\u201312+660 (End Bypass-1)"
                                                            }
                                        ],
                                        "note": "Bypass-1 | Fig 2.5A/2.5D/2.4E | 60m PROW | 2\u00d77m CW + 4m median + 7m SR each side | 12.082 km"
                    },
                    {
                                        "id": "tcs_rob_approach",
                                        "name": "TCS-2 | ROB Approach Sections (Bypass-1)",
                                        "roadCategory": "NH/SH",
                                        "constType": "New",
                                        "elements": {},
                                        "frozen": false,
                                        "locations": [
                                                            {
                                                                                "fromCh": 3680,
                                                                                "toCh": 4188,
                                                                                "label": "ROB-1 approach Ch 3+680\u20134+188"
                                                            },
                                                            {
                                                                                "fromCh": 5432,
                                                                                "toCh": 6560,
                                                                                "label": "ROB-2 approach Ch 5+432\u20136+560"
                                                            },
                                                            {
                                                                                "fromCh": 9782,
                                                                                "toCh": 11132,
                                                                                "label": "ROB-3 approach Ch 9+782\u201311+132"
                                                            },
                                                            {
                                                                                "fromCh": 18420,
                                                                                "toCh": 19200,
                                                                                "label": "ROB-4 approach Ch 18+420\u201319+200"
                                                            }
                                        ],
                                        "note": "Fig 2.4E/2.4F | ROB approach both sides | 60m PROW | Wider embankment"
                    },
                    {
                                        "id": "tcs_main_concentric",
                                        "name": "TCS-3 | Main Alignment \u2014 Concentric Widening",
                                        "roadCategory": "NH/SH",
                                        "constType": "Widening",
                                        "elements": {},
                                        "frozen": false,
                                        "locations": [
                                                            {
                                                                                "fromCh": 12660,
                                                                                "toCh": 13292,
                                                                                "label": "Ch 12+660\u201313+292"
                                                            },
                                                            {
                                                                                "fromCh": 13292,
                                                                                "toCh": 13800,
                                                                                "label": "Ch 13+292\u201313+800"
                                                            },
                                                            {
                                                                                "fromCh": 14800,
                                                                                "toCh": 16680,
                                                                                "label": "Ch 14+800\u201316+680"
                                                            },
                                                            {
                                                                                "fromCh": 17500,
                                                                                "toCh": 18420,
                                                                                "label": "Ch 17+500\u201318+420"
                                                            },
                                                            {
                                                                                "fromCh": 21000,
                                                                                "toCh": 22070,
                                                                                "label": "Ch 21+000\u201322+070 (incl Toll Plaza)"
                                                            },
                                                            {
                                                                                "fromCh": 23940,
                                                                                "toCh": 24582,
                                                                                "label": "Ch 23+940\u201324+582"
                                                            },
                                                            {
                                                                                "fromCh": 29230,
                                                                                "toCh": 33700,
                                                                                "label": "Ch 29+230\u201333+700 (4.470 km)"
                                                            },
                                                            {
                                                                                "fromCh": 34530,
                                                                                "toCh": 36982,
                                                                                "label": "Ch 34+530\u201336+982"
                                                            },
                                                            {
                                                                                "fromCh": 36996,
                                                                                "toCh": 37680,
                                                                                "label": "Ch 36+996\u201337+680"
                                                            },
                                                            {
                                                                                "fromCh": 39900,
                                                                                "toCh": 42000,
                                                                                "label": "Ch 39+900\u201342+000"
                                                            }
                                        ],
                                        "note": "Fig 2.4A | 45m PROW | 2\u00d77m CW + 4m raised median + 2.5m paved shoulder | No service road"
                    },
                    {
                                        "id": "tcs_buildup_sr",
                                        "name": "TCS-4 | Built-Up & Service Road Sections",
                                        "roadCategory": "NH/SH",
                                        "constType": "Widening",
                                        "elements": {},
                                        "frozen": false,
                                        "locations": [
                                                            {
                                                                                "fromCh": 13800,
                                                                                "toCh": 14800,
                                                                                "label": "Ch 13+800\u201314+800 (LVUP zone)"
                                                            },
                                                            {
                                                                                "fromCh": 16680,
                                                                                "toCh": 17500,
                                                                                "label": "Ch 16+680\u201317+500 (LVUP zone)"
                                                            },
                                                            {
                                                                                "fromCh": 19200,
                                                                                "toCh": 21000,
                                                                                "label": "Ch 19+200\u201321+000 (Mandamarri town)"
                                                            },
                                                            {
                                                                                "fromCh": 22070,
                                                                                "toCh": 23940,
                                                                                "label": "Ch 22+070\u201323+940 (Somagudem)"
                                                            },
                                                            {
                                                                                "fromCh": 33700,
                                                                                "toCh": 34530,
                                                                                "label": "Ch 33+700\u201334+530 (Boyapalle)"
                                                            },
                                                            {
                                                                                "fromCh": 37680,
                                                                                "toCh": 39900,
                                                                                "label": "Ch 37+680\u201339+900 (Tandur town)"
                                                            }
                                        ],
                                        "note": "Fig 2.6A/2.6C | 45\u201360m PROW | Service road 7m both sides | Built-up areas"
                    },
                    {
                                        "id": "tcs_bypass2",
                                        "name": "TCS-5 | Bypass-2 (Ch 24+582\u201328+982)",
                                        "roadCategory": "NH/SH",
                                        "constType": "New",
                                        "elements": {},
                                        "frozen": false,
                                        "locations": [
                                                            {
                                                                                "fromCh": 24582,
                                                                                "toCh": 25530,
                                                                                "label": "Ch 24+582\u201325+530 (Plain)"
                                                            },
                                                            {
                                                                                "fromCh": 25530,
                                                                                "toCh": 29230,
                                                                                "label": "Ch 25+530\u201329+230 (with SR)"
                                                            }
                                        ],
                                        "note": "Bypass-2 | Fig 2.5B/2.4 | 60m PROW | 2\u00d77m CW + 4m median + 7m SR each side | 4.400 km"
                    }
],
                    structureBOQ: [],
                    generationConfig: {
                        sequence: [],
                        productivityRates: {},
                        confirmed: false
                    }
                },

                activities: [],
                progress: []
            },


            computed: {
                workableStretches: [],
                wbs: [],
                activities: [],
                totalActivities: 0,
                criticalActivities: 0,
                completedActivities: 0,
                overallProgress: 0,
                physicalProgress: 0,
                financialProgress: 0,
                totalDuration: 0,
                totalCost: 0
            },
            
            // ‚îÄ‚îÄ SYNC FROM UI ‚Üí data store ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            syncFromUI: {
                project: function() {
                    const val = id => { const el = document.getElementById(id); return el ? el.value : ''; };
                    const num = id => { const el = document.getElementById(id); return el ? parseFloat(el.value) || 0 : 0; };
                    KALYANTRA.data.project.name   = val('projectName')   || KALYANTRA.data.project.name;
                    KALYANTRA.data.project.budget  = num('projectCost')  || KALYANTRA.data.project.budget;
                    KALYANTRA.data.project.startDate = val('appointedDate') || KALYANTRA.data.project.startDate;
                    const skm = num('startKm'), sm = num('startM');
                    const ekm = num('endKm'),   em = num('endM');
                    if (ekm > 0) {
                        KALYANTRA.data.project.startChainage = skm * 1000 + sm;
                        KALYANTRA.data.project.endChainage   = ekm * 1000 + em;
                    }
                    // Sprint 2: read industry/mode selects
                    KALYANTRA.data.project.industryType = val('industryType') || KALYANTRA.data.project.industryType || 'roads';
                    KALYANTRA.data.project.projectMode  = val('projectMode')  || KALYANTRA.data.project.projectMode  || 'epc';
                    // L-02 / U-06: Sync duration and completion date
                    const durVal = parseInt(val('duration')) || 0;
                    if (durVal > 0) KALYANTRA.data.project.duration = durVal * 30;
                    const compDate = val('completionDate');
                    if (compDate) KALYANTRA.data.project.endDate = compDate;
                },
                tcs: function() {
                    // L-03 FIX: Do NOT read from TCS display table ‚Äî columns are From/To/Type/Lanes/Median/Proposal.
                    // carriageWidth and layer thicknesses are managed by saveTCSEdit() / saveTCSComponents() directly.
                    // This function is intentionally a no-op to preserve data integrity.
                },
                structures: function() {
                    const rows = document.querySelectorAll('#structuresTable tr');
                    const arr = [];
                    rows.forEach((row, i) => {
                        const cells = row.cells;
                        if (!cells || cells.length < 4) return;
                        const chainageText = cells[1] ? cells[1].textContent.trim() : '';
                        const match = chainageText.match(/(\d+)\+(\d+)/);
                        const chainage = match ? parseInt(match[1]) * 1000 + parseInt(match[2]) : (i + 1) * 1000;
                        arr.push({
                            id: i + 1,
                            name: chainageText || `Structure ${i+1}`,
                            type: cells[6] ? cells[6].textContent.trim().toLowerCase().replace(/ /g,'_') : 'culvert',
                            chainage: chainage,
                            size: cells[4] ? cells[4].textContent.trim() : '1',
                            concreteQty: 60, excavationQty: 50, foundationQty: 15
                        });
                    });
                    if (arr.length > 0) KALYANTRA.data.structures = arr;
                },
                hindrances: function() {
                    const rows = document.querySelectorAll('#hindrancesTable tr');
                    const arr = [];
                    rows.forEach((row, i) => {
                        const cells = row.cells;
                        if (!cells || cells.length < 5) return;
                        const chainageText = cells[3] ? cells[3].textContent.trim() : '';
                        const matches = chainageText.match(/(\d+)/g);
                        const cs = matches && matches[0] ? parseInt(matches[0]) * 1000 + (parseInt(matches[1]) || 0) : (i + 1) * 500;
                        const ce = cs + 600;
                        const statusText = cells[5] ? cells[5].textContent.trim() : 'Active';
                        arr.push({
                            id: i + 1,
                            name: cells[2] ? cells[2].textContent.trim() : `Hindrance ${i+1}`,
                            type: 'utility',
                            chainageStart: cs,
                            chainageEnd: ce,
                            status: statusText.includes('Resolved') ? 'Resolved' : 'Pending',
                            impact: 'Blocks work activities'
                        });
                    });
                    if (arr.length > 0) KALYANTRA.data.hindrances = arr;
                }
            },
            
            // ‚îÄ‚îÄ CALCULATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            calculate: {
                workableStretches: function() {
                    const p = KALYANTRA.data.project;
                    const projectStart = p.startChainage || 0;
                    const projectEnd   = p.endChainage   || 5000;
                    const hindrances = KALYANTRA.data.hindrances
                        .filter(h => h.status === 'Pending')
                        .sort((a,b) => a.chainageStart - b.chainageStart);
                    
                    const workable = [];
                    let cur = projectStart;
                    hindrances.forEach(h => {
                        if (h.chainageStart > cur) {
                            workable.push({ id: workable.length+1, start: cur, end: h.chainageStart, length: (h.chainageStart-cur)/1000 });
                        }
                        cur = Math.max(cur, h.chainageEnd);
                    });
                    if (cur < projectEnd) {
                        workable.push({ id: workable.length+1, start: cur, end: projectEnd, length: (projectEnd-cur)/1000 });
                    }
                    KALYANTRA.computed.workableStretches = workable;
                    return workable;
                },
                
                wbs: function() {
                    const workable   = KALYANTRA.computed.workableStretches;
                    const structures = KALYANTRA.data.structures;
                    const hindrances = KALYANTRA.data.hindrances.filter(h => h.status === 'Pending');
                    const wbs = [];
                    const fmt = m => { const k = Math.floor(m/1000); const r = m%1000; return `${k}+${String(r).padStart(3,'0')}`; };
                    
                    // LA-05 FIX: TCS-based cost model (rate per m3 √ó volume per km √ó stretch length)
                    const tcs = KALYANTRA.data.tcs;
                    const W   = tcs.carriageWidth || 7;
                    // Cost rates per Cum (‚Çπ) ‚Äî typical Indian road construction MORT&H rates
                    const layerRates = { GSB: 450, WBM: 850, DBM: 1800, BC: 2500 };
                    const earthRatePerCum = 200; // embankment rate ‚Çπ/Cum
                    const croreDiv = 10000000; // 1 Cr = 1,00,00,000
                    
                    workable.forEach((s,i) => {
                        const acts = KALYANTRA.calculate.stretchActivities(s);
                        // FIX-GAP07: delay (days) from unresolved bordering hindrances
                        const _resDelay = KALYANTRA.data.hindrances
                            .filter(h => h.status !== 'Resolved' && (h.resolutionDays||0) > 0)
                            .filter(h => Math.abs(h.chainageEnd - s.start) < 500 || Math.abs(h.chainageStart - s.end) < 500)
                            .reduce((mx, h) => Math.max(mx, h.resolutionDays||0), 0);
                        const L = s.length * 1000; // metres
                        // Compute stretch cost from TCS volumes
                        let stretchCost = 0;
                        // Earthwork (embankment) ‚Äî 0.5m depth assumption
                        stretchCost += (L * W * 0.5) * earthRatePerCum;
                        // Pavement layers
                        Object.entries(tcs.layers).forEach(([lyr, cfg]) => {
                            const vol = L * W * ((cfg.thickness || 0) / 1000);
                            stretchCost += vol * (layerRates[lyr] || 1000);
                        });
                        const costCr = +(stretchCost / croreDiv).toFixed(2);
                        wbs.push({ wbs:`1.${i+1}`, name:`Stretch ${i+1} (Ch ${fmt(s.start)} ‚Äì ${fmt(s.end)})`,
                            type:'stretch', phase:1, chainage:s, status:'Workable',
                            activities: acts,
                            duration: acts.reduce((sum,a)=>Math.max(sum,a.duration),0) + 5,
                            cost: costCr });
                    });
                    structures.forEach((st,i) => {
                        const acts = KALYANTRA.calculate.structureActivities(st);
                        // LA-05: Structure cost from concreteQty * rate (‚Çπ7500/Cum typical box culvert)
                        const concQty = (st.concreteQty||45) + (st.foundationQty||15);
                        const structCostCr = +((concQty * 7500) / 10000000).toFixed(2) || 1.2;
                        // LA-06 FIX: Curing (id:4) is parallel with Box Construction (id:3), not sequential
                        // Critical path = Excavation + Foundation + max(BoxConstr,Curing) + Backfill
                        const seqActs = acts.filter(a => a.id !== '4'); // exclude Curing from sequential chain
                        const boxDur  = (acts.find(a=>a.id==='3') || {duration:7}).duration;
                        const curDur  = (acts.find(a=>a.id==='4') || {duration:7}).duration;
                        const parallelDur = Math.max(boxDur, curDur);
                        const structDur = seqActs.reduce((s,a)=>s+(a.duration||0),0) + parallelDur;
                        wbs.push({ wbs:`2.${i+1}`, name:st.name, type:'structure', phase:2,
                            chainage:{start:st.chainage,end:st.chainage}, status:'Structure',
                            activities: acts,
                            duration: structDur,
                            cost: Math.max(structCostCr, 0.3) });
                    });
                    hindrances.forEach((h,i) => {
                        wbs.push({ wbs:`3.${i+1}`, name:`Blocked: ${h.name}`, type:'blocked', phase:3,
                            chainage:{start:h.chainageStart,end:h.chainageEnd}, status:'Blocked',
                            activities:[], duration:0, cost:0 });
                    });
                    
                    KALYANTRA.computed.wbs = wbs;
                    KALYANTRA.computed.totalCost = wbs.reduce((s,w)=>s+w.cost,0);
                    // totalDuration = final day offset = cumulative sequential sum of ALL items
                    let _cumTotal = 0;
                    wbs.forEach(w => _cumTotal += (w.duration||0));
                    KALYANTRA.computed.totalDuration = _cumTotal;
                    
                    // ‚îÄ‚îÄ Apply scheduling constraints (Layer 2 + 3C) ‚îÄ‚îÄ
                    if (typeof applyConstraints === 'function') {
                        applyConstraints(wbs);
                    }
                    
                    return wbs;
                },
                
                stretchActivities: function(stretch) {
                    const tcs = KALYANTRA.data.tcs;
                    const res = KALYANTRA.data.resources;
                    const L   = stretch.length * 1000;
                    // Resource-aware assignment (S4-01)
                    const getRes = (types, fallback) => {
                        const match = res.equipment.find(e => types.some(t => (e.type||'').toLowerCase().includes(t)));
                        return match ? `${match.count || 1}x ${match.type}` : (res.equipment.length ? '‚ö†Ô∏è ' + fallback + ' not assigned' : fallback);
                    };
                    // Safe layer thickness accessor - handles both tcs.layers.GSB.thickness AND tcs.layers.main.gsb
                    const getLayer = (key) => {
                        const KEY = key.toUpperCase(); const lkey = key.toLowerCase();
                        // Format 1: layers.GSB = { thickness: 200 }
                        if (tcs.layers && tcs.layers[KEY] && tcs.layers[KEY].thickness) return tcs.layers[KEY].thickness;
                        // Format 2: layers.main = { gsb: 200, dbm: 115, bc: 50 }
                        if (tcs.layers && tcs.layers.main && tcs.layers.main[lkey]) return tcs.layers.main[lkey];
                        // Defaults (MoRTH IRC SP:84 for 115 MSA NH)
                        const defs = { gsb:200, wmm:250, wbm:250, dbm:115, bc:50, subgrade:500 };
                        return defs[lkey] || 200;
                    };
                    const GSB = getLayer('GSB'), WBM = getLayer('WMM') || getLayer('WBM');
                    const DBM = getLayer('DBM'), BC  = getLayer('BC');
                    const CW  = tcs.carriageWidth || 7;
                    const _sActs = [
                        { id:`${stretch.id}.1`, name:'Soil Excavation & Embankment',  qty:Math.round(L*CW*0.5), unit:'Cum', duration:Math.max(10, Math.round(L/100)), critical:true,  phase:1, resource: getRes(['excavat'],'2 Excavators') },
                        { id:`${stretch.id}.2`, name:'Sub-grade Preparation (500mm)',  qty:Math.round(L*CW*0.5), unit:'Cum', duration:Math.max(5,  Math.round(L/200)), critical:true,  phase:1, resource: getRes(['grader','compact'],'1 Grader + Compactor') },
                        { id:`${stretch.id}.3`, name:'GSB Layer (' + GSB + 'mm)',      qty:Math.round(L*CW*(GSB/1000)), unit:'Cum', duration:Math.max(4, Math.round(L/300)), critical:false, phase:1, resource: getRes(['paver','gsb'],'1 Paver') },
                        { id:`${stretch.id}.4`, name:'WMM Layer (' + WBM + 'mm)',      qty:Math.round(L*CW*(WBM/1000)), unit:'Cum', duration:Math.max(5, Math.round(L/250)), critical:false, phase:2, resource: getRes(['paver','wmm','wbm'],'1 WMM Paver') },
                        { id:`${stretch.id}.5`, name:'DBM Layer (' + DBM + 'mm)',      qty:Math.round(L*CW*(DBM/1000)), unit:'Cum', duration:Math.max(3, Math.round(L/350)), critical:true,  phase:2, resource: getRes(['dbm','dense','bituminous macadam','asphalt','paver'],'1 DBM Paver') },
                        { id:`${stretch.id}.6`, name:'BC Wearing Course (' + BC + 'mm)', qty:Math.round(L*CW*(BC/1000)), unit:'Cum', duration:Math.max(2, Math.round(L/400)), critical:true,  phase:3, resource: getRes(['bc','bituminous concrete','surface','wearing'],'1 BC Paver') }
                    ];
                    // FIX-LA01b: restore actualPct from persistent store (survives refresh)
                    const _sp = KALYANTRA.data.activityProgress || {};
                    _sActs.forEach(a => { a.actualPct = _sp[stretch.id + '.' + a.id] !== undefined ? _sp[stretch.id + '.' + a.id] : 0; });
                    return _sActs;
                },
                
                structureActivities: function(s) {
                    const res = KALYANTRA.data.resources;
                    const getRes = (types, fallback) => {
                        const match = res.equipment.find(e => types.some(t => (e.type||'').toLowerCase().includes(t)));
                        return match ? `${match.count || 1}x ${match.type}` : (res.equipment.length ? '‚ö†Ô∏è ' + fallback + ' not assigned' : fallback);
                    };
                    const _structActs = [
                        { id:'1', name:'Excavation',          qty:s.excavationQty||50, unit:'Cum', duration:2, critical:false, resource: getRes(['excavat'],'1 Excavator') },
                        { id:'2', monsoonSensitive:false, name:'Foundation Concrete', qty:s.foundationQty||15, unit:'Cum', duration:3, critical:true,  resource: getRes(['batch','transit','concrete'],'Batching Plant') },
                        { id:'3', monsoonSensitive:false, name:'Box Construction',    qty:s.concreteQty||45,   unit:'Cum', duration:7, critical:true,  resource: getRes(['crane'],'Crane + Form') },
                        { id:'4', monsoonSensitive:false, name:'Curing',              qty:0,                   unit:'‚Äî',   duration:7, critical:true,  resource:'‚Äî' },
                        { id:'5', name:'Backfill & Compact',  qty:20,                  unit:'Cum', duration:2, critical:false, resource: getRes(['excavat','compact'],'1 Excavator') }
                    ];
                    // FIX-LA01c: restore actualPct from persistent store
                    const _stp = KALYANTRA.data.activityProgress || {};
                    _structActs.forEach(a => { a.actualPct = _stp[s.id + '.' + a.id] !== undefined ? _stp[s.id + '.' + a.id] : 0; });
                    // FIX-LA06: critical path ‚Äî Curing runs parallel with Box Construction
                    // Sequential: Exc(2)+Found(3)+Backfill(2)=7  Parallel: max(BoxConst(7),Curing(7))=7  Total=14
                    return _structActs;
                },

                allActivities: function() {
                    const wbs = KALYANTRA.computed.wbs;
                    const all = [];
                    // LA-01 FIX: Restore persisted actualPct from data store after spread (refresh() wipes computed)
                    const progress = KALYANTRA.data.activityProgress || {};
                    wbs.forEach(item => {
                        item.activities.forEach(a => {
                            const key = item.wbs + '.' + a.id;
                            const obj = { ...a, wbs:item.wbs, wbsName:item.name, phase:item.phase, type:item.type };
                            if (progress[key] !== undefined) obj.actualPct = progress[key];
                            all.push(obj);
                        });
                    });
                    KALYANTRA.computed.activities       = all;
                    KALYANTRA.computed.totalActivities  = all.length;
                    KALYANTRA.computed.criticalActivities = all.filter(a=>a.critical).length;
                    return all;
                },
                
                progress: function() {
                    const all = KALYANTRA.computed.activities;
                    if (!all.length) { KALYANTRA.computed.overallProgress=0; return; }
                    // L-06 FIX: use actual activity progress (actualPct field, 0-100)
                    // Falls back to time-elapsed proxy only if NO activities have actual data
                    const withActual = all.filter(a => typeof a.actualPct === 'number' && a.actualPct > 0);
                    let overall = 0;
                    if (withActual.length > 0) {
                        // Weighted average: weight by activity duration
                        const totalWeight  = all.reduce((s,a) => s + (a.duration||1), 0);
                        const weightedSum  = all.reduce((s,a) => s + (a.actualPct||0) * (a.duration||1), 0);
                        overall = Math.round(weightedSum / totalWeight);
                    } else {
                        // Time-elapsed proxy (unchanged fallback)
                        const sd = parseLocalDate(KALYANTRA.data.project.startDate || '2026-01-01');
                        const today = new Date();
                        // LA-03 FIX: derive totalDays from endDate if duration not set
                        const _proj = KALYANTRA.data.project;
                        let totalDays = _proj.duration || 0;
                        if (!totalDays && _proj.endDate && _proj.startDate) {
                            const _s = parseLocalDate(_proj.startDate);
                            const _e = parseLocalDate(_proj.endDate);
                            totalDays = Math.max(1, Math.round((_e - _s) / 86400000));
                        }
                        totalDays = totalDays || 540;
                        const elapsed   = Math.max(0, Math.floor((today - sd) / 86400000));
                        overall = Math.min(99, Math.round((elapsed / totalDays) * 100));
                    }
                    const completed = all.filter(a => (a.actualPct||0) >= 100).length;
                    KALYANTRA.computed.completedActivities = completed;
                    KALYANTRA.computed.overallProgress   = Math.min(overall, 100);
                    KALYANTRA.computed.physicalProgress  = Math.min(overall + 2, 100);
                    KALYANTRA.computed.financialProgress = Math.max(overall - 4, 0);
                }
            },
            
            // ‚îÄ‚îÄ REFRESH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            refresh: function() {
                console.log('üîÑ KALYANTRA V8.1 ‚Äî refreshing...');
                this.syncFromUI.project();
                this.syncFromUI.structures();
                this.syncFromUI.hindrances();
                this.calculate.workableStretches();
                this.calculate.wbs();
                this.calculate.allActivities();
                this.calculate.progress();
                console.log('‚úÖ Refresh complete!', {
                    stretches: this.computed.workableStretches.length,
                    wbsItems:  this.computed.wbs.length,
                    activities: this.computed.totalActivities,
                    critical:  this.computed.criticalActivities,
                    progress:  this.computed.overallProgress + '%'
                });
                // Update wbsStatBar after every refresh
                if (typeof updateWBSStatBar === 'function') updateWBSStatBar();
                // V9: update health score, alerts, baseline, coverage on every refresh
                if (typeof renderDashboard        === 'function') setTimeout(renderDashboard, 100);
                if (typeof renderBaselineInfo     === 'function') setTimeout(renderBaselineInfo, 50);
                if (typeof computeAllAlerts       === 'function') setTimeout(computeAllAlerts, 150);
                if (typeof updateCoverageWarnings === 'function') updateCoverageWarnings();
            },
            
            // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            render: {
                wbsTable: function() {
                    const tbody = document.getElementById('wbsBody');
                    if (!tbody) return;
                    // Note: caller should refresh() if data changed
                    const wbs  = KALYANTRA.computed.wbs;
                    const fmt  = m => { const k=Math.floor(m/1000); const r=m%1000; return `${k}+${String(r).padStart(3,'0')}`; };
                    const _sd = KALYANTRA.data.project.startDate || '2026-01-01'; const startDateObj = parseLocalDate(_sd); // FIX-LA11b
                    let offset = 0;
                    let html   = '';
                    
                    // If WBS empty, show actionable empty state instead of "Loading WBS from your data..."
                    if (!wbs || wbs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:40px;">' +
                            '<div style="font-size:2rem;margin-bottom:12px;">üèóÔ∏è</div>' +
                            '<strong style="display:block;color:#1B3B6F;font-size:1.1rem;margin-bottom:8px;">WBS Not Generated Yet</strong>' +
                            '<p style="color:#64748b;margin:0 0 16px;">Complete Project Basics & Hindrances tabs first, then click Refresh WBS to generate the Work Breakdown Structure.</p>' +
                            '<button onclick="KALYANTRA.render.wbsTable()" style="background:#1B3B6F;color:white;border:none;padding:10px 24px;border-radius:6px;cursor:pointer;font-weight:600;font-size:0.9rem;">üîÑ Generate WBS Now</button>' +
                            '</td></tr>';
                        return;
                    }

                    wbs.forEach(item => {
                        const bg     = item.phase===1 ? '#dcfce7' : item.phase===2 ? '#dbeafe' : '#fee2e2';
                        const scol   = item.phase===1 ? '#22c55e' : item.phase===2 ? '#3b82f6' : '#ef4444';
                        // FIX-LA04: parallel mode ‚Äî all stretches start at day 0
                        const _exMode2 = (typeof executionMode !== 'undefined') ? executionMode : 'sequential';
                        const _off2    = (_exMode2 === 'parallel' && item.type === 'stretch') ? 0 : offset;
                        const sd = addWorkingDays(startDateObj, _off2);
                        const ed = addWorkingDays(sd, item.duration||0);
                        const fDate  = d => d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'2-digit'});
                        const cpCount = item.activities.filter(a=>a.critical).length;
                        // Constraint violation badge
                        const _violations = (KALYANTRA.data.constraints && KALYANTRA.data.constraints.violations) || [];
                        const _violCount = _violations.filter(v => v.stretch1 === item.wbs).length;
                        html += `<tr data-wbs="${item.wbs}" style="background:${bg};border-bottom:1px solid #e2e8f0;font-weight:600;cursor:pointer;" onclick="toggleWBSRow(this)">
                            <td style="padding:10px;width:28px;"><span class="wbs-toggle">‚ñ∂</span></td>
                            <td style="padding:10px;">${item.wbs}</td>
                            <td style="padding:10px;"><strong>${item.name}</strong>${cpCount?` <span style="background:#fee2e2;color:#991b1b;padding:2px 6px;border-radius:4px;font-size:0.7rem;font-weight:600;">${cpCount} CP</span>`:''}${_violCount?` <span title="${_violCount} constraint violation(s) in this stretch" style="background:#fef9c3;color:#854d0e;border:1px solid #fde047;padding:2px 6px;border-radius:4px;font-size:0.7rem;font-weight:600;cursor:help;">‚ö°${_violCount} CV</span>`:''}
                            </td>
                            <td style="padding:10px;">${item.duration||'‚Äî'}d</td>
                            <td style="padding:10px;font-size:0.85rem;">${fDate(sd)}</td>
                            <td style="padding:10px;font-size:0.85rem;">${fDate(ed)}</td>
                            <td style="padding:10px;">${item.activities.length}</td>
                            <td style="padding:10px;color:${scol};font-weight:600;">${item.status}</td>
                            <td style="padding:10px;font-weight:700;">${item.cost>0?'‚Çπ'+item.cost.toFixed(1)+'Cr':'‚Äî'}</td>
                            <td style="padding:10px;"><button style="padding:4px 10px;background:#1B3B6F;color:white;border:none;border-radius:4px;font-size:0.75rem;cursor:pointer;font-weight:600;" onclick="event.stopPropagation();viewWBSActivities('${item.wbs}')">View ‚Üí</button></td>
                        </tr>`;
                        // Child rows (hidden by default)
                        item.activities.forEach(a => {
                            html += `<tr data-parent="${item.wbs}" style="display:none;background:${item.phase===1?'#f0fdf4':item.phase===2?'#eff6ff':'#fef2f2'};">
                                <td style="padding:8px 10px;"></td>
                                <td style="padding:8px 10px;color:#64748b;font-size:0.85rem;">${a.id}</td>
                                <td style="padding:8px 10px;padding-left:28px;font-size:0.9rem;">${a.critical?'üî¥':''} ${a.name}</td>
                                <td style="padding:8px 10px;font-size:0.85rem;">${a.duration}d</td>
                                <td style="padding:8px 10px;font-size:0.85rem;">${(()=>{const sd=addWorkingDays(startDateObj,offset); return sd.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'2-digit'});})()}</td>
                                <td style="padding:8px 10px;font-size:0.85rem;">${(()=>{const sd=addWorkingDays(startDateObj,offset); const ed=addWorkingDays(sd,a.duration||0); return ed.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'2-digit'});})()}</td>
                                <td style="padding:8px 10px;font-size:0.85rem;">${a.qty?a.qty+' '+a.unit:'‚Äî'}</td>
                                <td style="padding:8px 10px;font-size:0.85rem;">${a.critical?'<span style="color:#dc2626;font-weight:600;">Critical</span>':'Normal'}</td>
                                <td style="padding:8px 10px;font-size:0.85rem;">${(()=>{const shifts=KALYANTRA.data.resources?.equipment||[];const match=shifts.find(e=>a.resource&&a.resource.includes(e.name));return match?.shift==='double'?'üåô Double':'‚òÄÔ∏è Single';})()}</td>
                                <td style="padding:8px 10px;font-size:0.85rem;color:#64748b;">${a.resource}</td>
                            </tr>`;
                        });
                        offset += item.duration || 0;
                    });
                    
                    tbody.innerHTML = html || '<tr><td colspan="10" style="text-align:center;padding:30px;color:#64748b;">No WBS items ‚Äî add structures or hindrances in Tabs 3 & 4</td></tr>';
                    
                    // Update summary bar
                    // Update stat pills individually
                    const _cp = KALYANTRA.computed;
                    const _d  = KALYANTRA.data;
                    const _setEl = (id, html) => { const el = document.getElementById(id); if(el) el.innerHTML = html; };
                    _setEl('statWorkable',   `‚úÖ ${_cp.workableStretches.length} Workable Stretch${_cp.workableStretches.length!==1?'es':''}`);
                    _setEl('statStructures', `üåâ ${_d.structures.length} Structure${_d.structures.length!==1?'s':''}`);
                    _setEl('statBlocked',    `‚õî ${_d.hindrances.filter(h=>h.status==='Pending').length} Blocked Zone${_d.hindrances.filter(h=>h.status==='Pending').length!==1?'s':''}`);
                    _setEl('statActivities', `üìã ${_cp.totalActivities} Activities`);
                    _setEl('statCritical',   `üî¥ ${_cp.criticalActivities} Critical`);
                    _setEl('statCost',       `‚Çπ${(_cp.totalCost||0).toFixed(1)} Cr total`);
                    console.log('‚úÖ WBS table rendered');
                },
                
                dashboard: function() {
                    // Note: caller should refresh() if data changed
                    const c = KALYANTRA.computed;
                    const d = KALYANTRA.data;
                    
                    // Progress bars
                    const setBar = (id, pct) => {
                        const el = document.getElementById(id);
                        if (el) el.style.width = pct + '%';
                    };
                    const setText = (id, val) => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = val;
                    };
                    // ALWAYS use data.project progress as primary (user-entered, authoritative)
                    // Only use computed progress if explicitly set by activity tracking
                    const physPct = d.project.physicalProgress  || c.physicalProgress  || 0;
                    const finPct  = d.project.financialProgress || c.financialProgress || 0;
                    const overPct = Math.round((physPct + finPct) / 2);
                    setBar('dashOverallBar',   overPct);
                    setBar('dashPhysicalBar',  physPct);
                    setBar('dashFinancialBar', finPct);

                    // Update project status card dynamically
                    const physData = d.project.physicalProgress || physPct || 0;
                    const aptD = new Date(d.project.appointedDate||d.project.startDate||'2025-02-01');
                    const scdD = new Date(d.project.endDate||'2027-02-01');
                    const todayD = new Date();
                    const expectedPct = Math.min(100, Math.round((todayD-aptD)/(scdD-aptD)*100));
                    const gap = expectedPct - physData;
                    const statusIcon = document.getElementById('dashStatusIcon');
                    const statusText = document.getElementById('dashStatusText');
                    const statusSub  = document.getElementById('dashStatusSub');
                    if (statusIcon && statusText && statusSub) {
                        if (gap > 15) {
                            statusIcon.textContent='üî¥'; statusText.textContent='BEHIND SCHEDULE';
                            statusText.style.color='#ef4444';
                            statusSub.textContent=`Physical ${physData}% vs expected ${expectedPct}% ‚Äî M3 at risk`;
                        } else if (gap > 5) {
                            statusIcon.textContent='üü°'; statusText.textContent='MINOR DELAY';
                            statusText.style.color='#f59e0b';
                            statusSub.textContent=`Physical ${physData}% vs expected ${expectedPct}% ‚Äî recovery plan needed`;
                        } else {
                            statusIcon.textContent='üü¢'; statusText.textContent='ON TRACK';
                            statusText.style.color='#22c55e';
                            statusSub.textContent='Project progressing as planned';
                        }
                    }
                    // Real time elapsed
                    const aptDate = new Date(d.project.appointedDate || d.project.startDate || '2025-02-01');
                    const scdDate = new Date(d.project.endDate || '2027-02-01');
                    const today   = new Date();
                    const totalMs = scdDate - aptDate;
                    const elapsedMs = today - aptDate;
                    const timeElapsedPct = totalMs > 0 ? Math.min(100, Math.round(elapsedMs/totalMs*100)) : 0;
                    setBar('dashTimeBar', timeElapsedPct);
                    setText('dashTimePct', timeElapsedPct + '%');
                    setText('dashOverallPct',   overPct  + '%');
                    setText('dashPhysicalPct',  physPct  + '%');
                    setText('dashFinancialPct', finPct   + '%');
                    
                    // Quick stats
                    setText('dashTotalActivities',  c.totalActivities);
                    setText('dashCriticalPath',      c.criticalActivities);
                    setText('dashCompleted',         c.completedActivities);
                    setText('dashTotalDuration',     c.totalDuration + 'd');
                    
                    // Update hindrance alert count
                    const pendingH = (d.hindrances||[]).filter(h=>h.status==='Pending'||h.status==='pending').length;
                    const hEl = document.getElementById('dashHindranceCount');
                    if (hEl) hEl.textContent = pendingH + (pendingH===1?' Hindrance Blocking Work':' Hindrances Blocking Work');

                    // Update Financial Summary numbers
                    const budget = d.project.budget || 1356.90;
                    const finSpent = Math.round(budget * (finPct/100) * 100) / 100;
                    setText('dashTotalBudget', '‚Çπ' + budget.toFixed(2) + ' Cr');
                    setText('dashSpentAmt', '‚Çπ' + finSpent.toFixed(2) + ' Cr');
                    setText('dashBalanceAmt', '‚Çπ' + (budget - finSpent).toFixed(2) + ' Cr');

                    // Update Last Updated timestamp
                    const luEl = document.getElementById('dashLastUpdated');
                    if (luEl) luEl.textContent = 'Last Updated: ' + new Date().toLocaleString('en-IN', {day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});

                    // Phase bars
                    const p1Acts = c.activities.filter(a=>a.phase===1).length;
                    const p2Acts = c.activities.filter(a=>a.phase===2).length;
                    const p3Acts = c.activities.filter(a=>a.phase===3).length;
                    // L-09 FIX: compute each phase progress from actualPct (or time proxy)
                    const phasePct = (phaseN) => {
                        const acts = c.activities.filter(a => a.phase === phaseN);
                        if (!acts.length) return 0;
                        const hasActual = acts.some(a => typeof a.actualPct === 'number' && a.actualPct > 0);
                        if (hasActual) {
                            const w = acts.reduce((s,a) => s+(a.duration||1), 0);
                            return Math.round(acts.reduce((s,a) => s+(a.actualPct||0)*(a.duration||1), 0) / w);
                        }
                        return c.overallProgress; // same proxy for all phases if no actual data
                    };
                    const p1Pct = phasePct(1), p2Pct = phasePct(2), p3Pct = phasePct(3);
                    setBar('dashPhase1Bar', Math.min(p1Pct,100));
                    setText('dashPhase1Pct', Math.min(p1Pct,100)+'%');
                    setText('dashPhase1Acts', p1Acts + ' activities');
                    setBar('dashPhase2Bar', Math.min(p2Pct,100));
                    setText('dashPhase2Pct', Math.min(p2Pct,100)+'%');
                    setText('dashPhase2Acts', p2Acts + ' activities');
                    setBar('dashPhase3Bar', Math.min(p3Pct,100));
                    setText('dashPhase3Pct', Math.min(p3Pct,100)+'%');
                    setText('dashPhase3Acts', p3Acts + ' activities');
                    
                    // Hindrances alert
                    const activeH = d.hindrances.filter(h=>h.status==='Pending').length;
                    setText('dashHindranceCount', activeH + ' Hindrance' + (activeH!==1?'s':'') + ' Blocking Work');
                    const hAlert = document.getElementById('dashHindranceAlert');
                    if (hAlert) {
                        hAlert.style.borderLeftColor = activeH > 0 ? '#ef4444' : '#22c55e';
                        hAlert.style.background      = activeH > 0 ? '#fef2f2' : '#f0fdf4';
                    }
                    
                    // Financial
                    setText('dashTotalBudget',  '‚Çπ'+d.project.budget.toFixed(1)+' Cr');
                    const spent = +(d.project.budget * (c.financialProgress/100)).toFixed(2);
                    setText('dashSpent',     '‚Çπ'+spent+' Cr');
                    setText('dashRemaining', '‚Çπ'+(d.project.budget-spent).toFixed(2)+' Cr');
                    setBar('dashBudgetBar',  c.financialProgress);
                    setText('dashBudgetPct', c.financialProgress+'% Utilized');
                    
                    // Project name in dashboard header
                    setText('dashProjectName', d.project.name);
                    
                    // Last updated
                    setText('dashLastUpdated', 'Last Updated: ' + new Date().toLocaleString('en-IN',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}));
                    
                    console.log('‚úÖ Dashboard rendered');
                }
            },
            
            init: function() {
                console.log('');
                console.log('==========================================');
                console.log('üöÄ KALYANTRA V7.5 ‚Äî Constraints + All Fixes Applied');
                console.log('==========================================');
                // Restore from localStorage if available (S4-02)
                if (typeof this.load === 'function') this.load();
                // Sync Tab 3/4 HTML pre-loaded rows into data store first
                this.syncFromUI.structures();
                this.syncFromUI.hindrances();
                this.refresh();
                // Pre-populate Tab 1 inputs with seed values
                const seedFill = (id, val) => { const el = document.getElementById(id); if (el && !el.value) el.value = val; };
                seedFill('projectName', this.data.project.name);
                seedFill('projectCost', this.data.project.budget);
                seedFill('appointedDate', this.data.project.startDate);
                seedFill('startKm', Math.floor(this.data.project.startChainage / 1000));
                seedFill('startM',  this.data.project.startChainage % 1000);
                seedFill('endKm',   Math.floor(this.data.project.endChainage / 1000));
                seedFill('endM',    this.data.project.endChainage % 1000);
                // Seed selects (Sprint 2)
                const industryEl = document.getElementById('industryType');
                const modeEl = document.getElementById('projectMode');
                if (industryEl && !industryEl.value) industryEl.value = 'roads';
                if (modeEl     && !modeEl.value)     modeEl.value     = 'epc';
                // Seed calendar inputs (Sprint 2)
                const calHours = document.getElementById('hoursPerDay');
                const calMS    = document.getElementById('monsoonStart');
                const calME    = document.getElementById('monsoonEnd');
                if (calHours && !calHours.value) calHours.value = this.data.calendar.hoursPerDay || 8;
                if (calMS    && !calMS.value)    calMS.value    = this.data.calendar.monsoonStart || '2026-07-15';
                if (calME    && !calME.value)    calME.value    = this.data.calendar.monsoonEnd   || '2026-08-31';
                // Trigger calculated fields
                if (typeof calculateLength === 'function') calculateLength();
                if (typeof calculateCompletion === 'function') calculateCompletion();
                // Auto-render output tabs on init (U-03)
                setTimeout(() => {
                    if (typeof KALYANTRA.render !== 'undefined' && KALYANTRA.render.dashboard) KALYANTRA.render.dashboard();
                    if (typeof renderHolidayTable === 'function') renderHolidayTable();
                    if (typeof renderWorkingDaysSelector === 'function') renderWorkingDaysSelector(); // FIX-GAP04 // U-04
                    // GAP-04: Sync working day checkboxes from data
                    const _wd = KALYANTRA.data.calendar.workingDays || [1,2,3,4,5,6];
                    ['wdSun','wdMon','wdTue','wdWed','wdThu','wdFri','wdSat'].forEach((id,idx) => {
                        const el = document.getElementById(id);
                        if (el) el.checked = _wd.includes(idx);
                    });
                    if (typeof saveWorkingDays === 'function') {
                        // Update summary label only
                        const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
                        const s = document.getElementById('workingDaySummary');
                        if (s) s.textContent = _wd.length + ' days/week (' + _wd.map(d=>dayNames[d]).join(', ') + ')';
                    }
                }, 300);
                console.log('');
                console.log('üí° KALYANTRA.data     ‚Äî input data store');
                console.log('üí° KALYANTRA.computed ‚Äî derived values');
                console.log('üí° KALYANTRA.refresh()‚Äî recalculate all');
                console.log('');
                // Form population handled in DOMContentLoaded Phase 1
            }
        };
        
        // ‚îÄ‚îÄ Live data capture from Tab 1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ================================================================
        // SPRINT 1: DATA SAVE FUNCTIONS (S1-01, S1-02)
        // ================================================================
        
        function showToast(message, type) {
            const existing = document.getElementById('kToast');
            if (existing) existing.remove();
            const colors = { success:'#16a34a', error:'#dc2626', info:'#1B3B6F', warning:'#d97706' };
            const toast = document.createElement('div');
            toast.id = 'kToast';
            toast.style.cssText = `position:fixed;bottom:24px;right:24px;background:${colors[type]||colors.info};color:white;padding:12px 20px;border-radius:8px;font-size:0.875rem;font-weight:600;font-family:Arial,sans-serif;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.3);max-width:320px;border-left:4px solid rgba(255,255,255,0.4);`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2800);
        }
        
        // S1-01: Save structure data from detail form back to KALYANTRA.data
        // FIX-GAP08: Check structure chainage against active hindrance zones
        function checkStructureHindranceOverlap(chainage) {
            return KALYANTRA.data.hindrances.filter(h => h.status !== 'Resolved')
                .find(h => chainage >= h.chainageStart && chainage <= h.chainageEnd);
        }

        function saveStructureFromForm(index) {
            if (index === undefined || index === null || !KALYANTRA.data.structures) {
                showToast('‚ö†Ô∏è No structure selected', 'warning'); return;
            }
            const idx = parseInt(index);
            if (idx < 0 || idx >= KALYANTRA.data.structures.length) {
                // New structure added dynamically - use last
                showToast('‚ö†Ô∏è Structure index out of range', 'warning'); return;
            }
            const s = KALYANTRA.data.structures[idx];
            
            // Read all editable fields from the detail form
            const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : null; };
            const getNum = (id) => { const el = document.getElementById(id); return el ? parseFloat(el.value) || 0 : 0; };
            
            // Read from any inputs with data-field attributes we set
            const detailEl = document.getElementById('structureDetailContent');
            if (detailEl) {
                const inputs = detailEl.querySelectorAll('input[data-field], select[data-field]');
                inputs.forEach(inp => {
                    const field = inp.getAttribute('data-field');
                    if (field && s.hasOwnProperty(field)) {
                        s[field] = isNaN(parseFloat(inp.value)) ? inp.value : parseFloat(inp.value);
                    }
                });
            }
            
            // L-12: Validate chainage within project range
            const pStart = KALYANTRA.data.project.startChainage;
            const pEnd   = KALYANTRA.data.project.endChainage;
            if (s.chainage && (s.chainage < pStart || s.chainage > pEnd)) {
                showToast(`‚ö†Ô∏è Structure at Ch ${(s.chainage/1000).toFixed(3)} is outside project range (${(pStart/1000).toFixed(0)}‚Äì${(pEnd/1000).toFixed(0)} km)`, 'warning');
            }
            KALYANTRA.data.structures[idx] = s;
            // FIX-GAP08: warn if structure falls inside blocked zone
            if (s.chainage !== undefined) {
                const _ov = checkStructureHindranceOverlap(s.chainage);
                if (_ov) showToast('‚ö†Ô∏è Structure at Ch ' + Math.floor(s.chainage/1000) + '+' + String(s.chainage%1000).padStart(3,'0') + ' overlaps hindrance: ' + (_ov.name||'') + '. Schedule may be affected.', 'warning');
            }
            KALYANTRA.save();    // FIX: persist structure edits
            KALYANTRA.refresh(); // FIX: recalculate WBS with updated structure
            KALYANTRA.render.wbsTable();
            console.log('üìä Structure saved:', s);
            showToast('‚úÖ Structure data saved ‚Äî WBS dates updated', 'success');
        }
        
        // S1-02: Save hindrance data from detail form
        // GAP-05 FIX: Quick hindrance status change triggers scheduling recalc
        function quickResolveHindrance(select) {
            const detailEl = document.getElementById('hindranceDetailContent');
            if (!detailEl) return;
            const idx = parseInt(detailEl.getAttribute('data-hindrance-index') || -1);
            if (idx < 0 || !KALYANTRA.data.hindrances[idx]) return;
            const h = KALYANTRA.data.hindrances[idx];
            const val = select.value;
            h.status = val === 'clear' ? 'Resolved' : (val === 'closed' ? 'Closed' : 'Pending');
            KALYANTRA.data.hindrances[idx] = h;
            KALYANTRA.save();
            KALYANTRA.refresh();
            // Update the hindrance row badge in the list
            const rows = document.querySelectorAll('#hindrancesTable tr');
            if (rows[idx]) {
                const cells = rows[idx].cells;
                if (cells[4]) {
                    const resolved = h.status === 'Resolved' || h.status === 'Closed';
                    cells[4].innerHTML = resolved
                        ? '<span style="background:rgba(34,197,94,0.1);color:#16a34a;padding:2px 8px;border-radius:4px;font-size:0.85rem;">Clear ‚úÖ</span>'
                        : '<span style="background:rgba(239,68,68,0.1);color:#ef4444;padding:2px 8px;border-radius:4px;font-size:0.85rem;">Non-Clear</span>';
                    cells[5].innerHTML = resolved
                        ? '<span style="background:rgba(34,197,94,0.1);color:#16a34a;padding:2px 8px;border-radius:4px;font-size:0.85rem;">Resolved</span>'
                        : '<span style="background:rgba(251,191,36,0.1);color:#f59e0b;padding:2px 8px;border-radius:4px;font-size:0.85rem;">Active</span>';
                }
            }
            showToast(h.status === 'Resolved' ? '‚úÖ Hindrance resolved ‚Äî zone unlocked for scheduling!' : '‚ö†Ô∏è Hindrance marked ' + h.status, h.status === 'Resolved' ? 'success' : 'warning');
        }

        // FIX-GAP05: Hindrance status management
        // FIX-GAP07: Save resolution days
        function saveHindranceResolutionDays(val) {
            const pane = document.getElementById('hindranceDetailContent');
            if (!pane) return;
            const idx = parseInt(pane.getAttribute('data-hindrance-index') || '-1');
            if (idx < 0 || !KALYANTRA.data.hindrances[idx]) return;
            KALYANTRA.data.hindrances[idx].resolutionDays = parseInt(val) || 0;
            KALYANTRA.save(); KALYANTRA.refresh();
            showToast('‚è± Resolution: ' + (val||0) + ' days saved ‚Äî WBS dates updated', 'info');
        }

        function setHindranceStatus(index, status) {
            if (!KALYANTRA.data.hindrances[index]) return;
            KALYANTRA.data.hindrances[index].status = status;
            KALYANTRA.save(); KALYANTRA.refresh(); KALYANTRA.render.wbsTable();
            const cols = { 'Pending':['#fee2e2','#dc2626','#991b1b'], 'In Progress':['#fff7ed','#ea580c','#9a3412'], 'Resolved':['#dcfce7','#16a34a','#166534'] };
            ['Pending','In Progress','Resolved'].forEach(s => {
                const btn = document.getElementById('hStat_' + index + '_' + s.replace(/ /g,''));
                if (!btn) return;
                const [bg, br, tc] = cols[s] || ['#f1f5f9','#94a3b8','#475569'];
                btn.style.background  = s === status ? bg  : 'white';
                btn.style.borderColor = s === status ? br  : '#e2e8f0';
                btn.style.color       = s === status ? tc  : '#64748b';
                btn.style.fontWeight  = s === status ? '800' : '600';
            });
            showToast('üìã Status: ' + status + (status==='Resolved' ? ' ‚Äî zone now workable!' : ''), 'success');
        }

        function saveHindranceFromForm(index) {
            const idx = parseInt(index);
            if (isNaN(idx) || !KALYANTRA.data.hindrances || idx >= KALYANTRA.data.hindrances.length) {
                showToast('‚ö†Ô∏è No hindrance selected', 'warning'); return;
            }
            const h = KALYANTRA.data.hindrances[idx];
            
            // Read chainage from the IDs we already have
            const fromKm = parseFloat(document.getElementById('fromKm') && document.getElementById('fromKm').value) || 0;
            const fromM  = parseFloat(document.getElementById('fromM')  && document.getElementById('fromM').value)  || 0;
            const toKm   = parseFloat(document.getElementById('toKm')   && document.getElementById('toKm').value)   || 0;
            const toM    = parseFloat(document.getElementById('toM')    && document.getElementById('toM').value)    || 0;
            
            if (fromKm > 0 || toKm > 0) {
                h.chainageStart = fromKm * 1000 + fromM;
                h.chainageEnd   = toKm   * 1000 + toM;
            }
            
            // Read status from landStatusSelect if present
            const landSel = document.getElementById('landStatusSelect');
            if (landSel) {
                h.status = landSel.value === 'clear' ? 'Resolved' : 'Pending';
            }
            
            // Read any data-field attributes
            const detailEl = document.getElementById('hindranceDetailContent');
            if (detailEl) {
                const inputs = detailEl.querySelectorAll('input[data-field], select[data-field]');
                inputs.forEach(inp => {
                    const field = inp.getAttribute('data-field');
                    if (field && h.hasOwnProperty(field)) {
                        h[field] = inp.value;
                    }
                });
            }
            
            // Read description and criticality from new panel IDs
            const descEl2  = document.getElementById('hDesc_'+idx);
            const critEl2  = document.getElementById('hCrit_'+idx);
            const jmRefEl2 = document.getElementById('jmRef_'+idx);
            const jmDateEl2= document.getElementById('jmDate_'+idx);
            const jmIssEl2 = document.getElementById('jmIssueType_'+idx);
            const utTypEl2 = document.getElementById('utilType_'+idx);
            const utAuEl2  = document.getElementById('utilAuth_'+idx);
            const drNoEl2  = document.getElementById('drawingNo_'+idx);
            const drDtEl2  = document.getElementById('drawingDate_'+idx);
            if (descEl2)  h.description  = descEl2.value;
            if (critEl2)  h.criticality  = critEl2.value;
            if (jmRefEl2) h.jmRef        = jmRefEl2.value;
            if (jmDateEl2)h.jmDate       = jmDateEl2.value;
            if (jmIssEl2) h.jmIssueType  = jmIssEl2.value;
            if (utTypEl2) h.utilType     = utTypEl2.value;
            if (utAuEl2)  h.utilAuth     = utAuEl2.value;
            if (drNoEl2)  h.drawingNo    = drNoEl2.value;
            if (drDtEl2)  h.drawingDate  = drDtEl2.value;
            KALYANTRA.data.hindrances[idx] = h;
            KALYANTRA.save();    // FIX: persist hindrance edits
            KALYANTRA.refresh(); // FIX: recalculate WBS with updated hindrance
            KALYANTRA.render.wbsTable();
            console.log('üìä Hindrance saved:', h);
            showToast('‚úÖ Hindrance data saved ‚Äî WBS dates updated', 'success');
        }
        
        // S1-02: Live chainage update on input change
        function liveHindranceChainageUpdate() {
            const detailEl = document.getElementById('hindranceDetailContent');
            if (!detailEl) return;
            const idx = parseInt(detailEl.getAttribute('data-hindrance-index') || -1);
            if (idx < 0) return;
            const fromKm = parseFloat(document.getElementById('fromKm') && document.getElementById('fromKm').value) || 0;
            const fromM  = parseFloat(document.getElementById('fromM')  && document.getElementById('fromM').value)  || 0;
            const toKm   = parseFloat(document.getElementById('toKm')   && document.getElementById('toKm').value)   || 0;
            const toM    = parseFloat(document.getElementById('toM')    && document.getElementById('toM').value)    || 0;
            const startM = fromKm * 1000 + fromM;
            const endM   = toKm   * 1000 + toM;
            if (idx < KALYANTRA.data.hindrances.length) {
                KALYANTRA.data.hindrances[idx].chainageStart = startM;
                KALYANTRA.data.hindrances[idx].chainageEnd   = endM;
            }
            const lengthEl = document.getElementById('hindranceLengthDisplay');
            if (lengthEl) {
                const diff = endM - startM;
                if (diff > 0) {
                    lengthEl.textContent = '‚Üî Length: ' + (diff/1000).toFixed(3) + ' km (' + diff + ' m)';
                    lengthEl.style.color = '#3b82f6';
                } else if (diff < 0) {
                    lengthEl.textContent = '‚ö† To-chainage must be greater than From';
                    lengthEl.style.color = '#ef4444';
                } else {
                    lengthEl.textContent = '';
                }
            }
        }
        
        // ================================================================
        // SPRINT 1: RENDER ACTIVITIES TABLE (S1-03)
        // ================================================================
        
        function renderActivitiesTable() {
            KALYANTRA.refresh();
            const tbody = document.getElementById('activitiesBody');
            if (!tbody) return;
            
            const activities = KALYANTRA.computed.activities || [];
            const wbs        = KALYANTRA.computed.wbs || [];
            
            // Rebuild filter dropdown
            const filterSel = document.getElementById('activityFilter');
            if (filterSel) {
                const currentVal = filterSel.value;
                filterSel.innerHTML = '<option value="all">All Activities (' + activities.length + ')</option>';
                wbs.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.wbs;
                    const phaseIcon = item.phase === 1 ? 'üü¢' : item.phase === 2 ? 'üîµ' : 'üî¥';
                    opt.textContent = phaseIcon + ' ' + item.wbs + ' ' + item.name;
                    filterSel.appendChild(opt);
                });
                filterSel.value = 'all'; // Always reset to 'all' to ensure rows are visible
            }
            
            if (!activities.length) {
                tbody.innerHTML = `<tr><td colspan="9" style="padding:30px;text-align:center;">
                    <div style="font-size:1.8rem;margin-bottom:10px;">üìã</div>
                    <div style="color:#1B3B6F;font-weight:700;font-size:0.95rem;margin-bottom:6px;">No Activities Generated Yet</div>
                    <div style="color:#64748b;font-size:0.82rem;margin-bottom:16px;">Complete TCS sections and ensure project start date is set, then click Refresh WBS.</div>
                    <button onclick="KALYANTRA.refresh();KALYANTRA.render.wbsTable();setTimeout(renderActivitiesTable,200);" 
                        style="background:#1B3B6F;color:white;border:none;padding:8px 20px;border-radius:6px;font-size:0.82rem;cursor:pointer;font-weight:700;">
                        üîÑ Refresh WBS & Activities
                    </button>
                </td></tr>`;
                return;
            }
            
            // Render activity rows
            const projectStart = parseLocalDate(KALYANTRA.data.project.startDate || '2026-01-01');
            let dayOffset = 0;
            // FIX-LA04b: parallel mode ‚Äî stretch activities start at day 0
            const _raExecMode = (typeof executionMode !== 'undefined') ? executionMode : 'sequential';
            let prevWbs = null;
            let parallelBaseOffset = 0; // LA-04: for parallel mode, track per-WBS start offset
            let html = '';
            
            activities.forEach((act, i) => {
                // LA-04: When WBS changes in parallel mode, advance base offset by max duration of prior WBS
                if (executionMode === 'parallel' && act.wbs !== prevWbs) {
                    const priorMaxDur = activities.filter(a => a.wbs === prevWbs).reduce((m,a)=>Math.max(m,a.duration||0),0);
                    if (prevWbs !== null) parallelBaseOffset += priorMaxDur;
                }
                const phaseColors = { 1: '#dcfce7', 2: '#dbeafe', 3: '#fee2e2' };
                const phaseBorder = { 1: '#22c55e', 2: '#3b82f6', 3: '#ef4444' };
                const bg = act.critical ? 'rgba(220,38,38,0.04)' : (i % 2 === 0 ? '#fff' : '#f8fafc');
                const crFlag = act.critical ? '<span style="color:#dc2626;font-weight:700;" title="Critical Path">üî¥</span>' : '<span style="color:#94a3b8;">‚ö™</span>';
                
                // LA-04 FIX: respect executionMode in activity dates
                // parallel = same-phase activities start at phase start; sequential = accumulate
                let actStart;
                if (executionMode === 'parallel') {
                    // All activities within same WBS group start at the group's start offset
                    actStart = new Date(projectStart); actStart.setDate(actStart.getDate() + (parallelBaseOffset || 0));
                } else {
                    actStart = new Date(projectStart); actStart.setDate(actStart.getDate() + dayOffset);
                }
                const startD = actStart;
                const endD   = new Date(startD); endD.setDate(endD.getDate() + (act.duration || 5));
                const fmt = d => d.toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'2-digit'});
                dayOffset += act.duration || 5;
                
                // Phase group header if new WBS item
                // FIX-LA04c: parallel mode ‚Äî don't accumulate offset for stretches
                if (_raExecMode === 'parallel' && act.type === 'stretch' && act.wbs !== prevWbs) dayOffset = 0;
                if (act.wbs !== prevWbs) {
                    const wbsItem = wbs.find(w => w.wbs === act.wbs);
                    if (wbsItem) {
                        const phBg = phaseColors[act.phase] || '#f8fafc';
                        const phBd = phaseBorder[act.phase] || '#cbd5e1';
                        html += `<tr data-wbs="${act.wbs}" style="background:${phBg};border-left:4px solid ${phBd};">
                            <td colspan="9" style="padding:8px 12px;font-weight:700;font-size:0.8rem;color:#475569;">
                                ${act.phase === 1 ? 'üü¢' : act.phase === 2 ? 'üîµ' : 'üî¥'} ${act.wbs} ‚Äî ${wbsItem.name}
                                <span style="float:right;font-weight:400;color:#64748b;">${wbsItem.activities.length} activities ¬∑ ${wbsItem.duration}d ¬∑ ‚Çπ${wbsItem.cost.toFixed(1)} Cr</span>
                            </td>
                        </tr>`;
                        prevWbs = act.wbs;
                    }
                }
                
                html += `<tr data-wbs="${act.wbs}" style="background:${bg};border-bottom:1px solid #f1f5f9;transition:background 0.15s;" onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='${bg}'">
                    <td style="padding:8px 10px;font-size:0.85rem;font-weight:600;color:#475569;">${act.wbs}.${act.id ? act.id.split('.').pop() || (i+1) : (i+1)}</td>
                    <td style="padding:8px 10px;font-size:0.85rem;">${crFlag} ${act.name}</td>
                    <td style="padding:8px 10px;font-size:0.85rem;color:#64748b;">${act.wbsName || '‚Äî'}</td>
                    <td style="padding:8px 10px;font-size:0.85rem;">${act.qty > 0 ? act.qty.toLocaleString() : '‚Äî'}</td>
                    <td style="padding:8px 10px;font-size:0.85rem;color:#64748b;">${act.unit || '‚Äî'}</td>
                    <td style="padding:8px 10px;font-size:0.85rem;">${act.duration || '‚Äî'}d</td>
                    <td style="padding:8px 10px;font-size:0.85rem;color:#475569;">${fmt(startD)}</td>
                    <td style="padding:8px 10px;font-size:0.85rem;color:#475569;">${fmt(endD)}</td>
                    <td style="padding:6px 8px;text-align:center;">
                        <div style="display:flex;flex-direction:column;align-items:center;gap:3px;">
                            <div style="display:flex;align-items:center;gap:6px;">
                                <input type="range" min="0" max="100" step="5"
                                    value="${(KALYANTRA.data.activityProgress&&KALYANTRA.data.activityProgress[act.wbs+'.'+act.id])||act.actualPct||0}"
                                    style="width:70px;accent-color:#1B3B6F;cursor:pointer;"
                                    oninput="updateActivityProgress(this,'${act.wbs}','${act.id}',this.value); this.nextElementSibling.textContent=this.value+'%'; this.parentElement.nextElementSibling.style.width=this.value+'%'; this.parentElement.nextElementSibling.style.background=this.value>=100?'#16a34a':this.value>=50?'#D4AF37':'#1B3B6F';"
                                />
                                <span style="font-size:0.78rem;font-weight:700;color:#1B3B6F;min-width:32px;">${(KALYANTRA.data.activityProgress&&KALYANTRA.data.activityProgress[act.wbs+'.'+act.id])||act.actualPct||0}%</span>
                            </div>
                            <!-- UA-02 FIX: Mini progress bar for visual scan -->
                            <div style="width:100%;height:4px;background:#e2e8f0;border-radius:2px;overflow:hidden;">
                                <div style="height:100%;border-radius:2px;transition:width 0.2s;background:${((KALYANTRA.data.activityProgress&&KALYANTRA.data.activityProgress[act.wbs+'.'+act.id])||act.actualPct||0)>=100?'#16a34a':'#1B3B6F'};width:${(KALYANTRA.data.activityProgress&&KALYANTRA.data.activityProgress[act.wbs+'.'+act.id])||act.actualPct||0}%;" ></div></div>
                                <div style="display:none;width:${act.actualPct||0}%;height:100%;border-radius:2px;background:${(act.actualPct||0)>=100?'#16a34a':(act.actualPct||0)>=50?'#D4AF37':'#1B3B6F'};transition:width 0.3s ease;"></div>
                            </div>
                        </div>
                    </td>
                </tr>`;
            });
            
            tbody.innerHTML = html;
            
            // Update count display
            const countEl = document.getElementById('activityCount');
            if (countEl) countEl.textContent = activities.length;
            
            // Apply current filter
            filterActivities();
            console.log('‚úÖ Activities table rendered:', activities.length, 'rows');
        }
        
        // ================================================================
        // SPRINT 1: DYNAMIC GANTT RENDERER (S1-05)
        // ================================================================
        
        let ganttZoomLevel    = 1.0;
        let ganttShowCritical = true;
        
        function renderGantt() {
            KALYANTRA.refresh();
            const wbs        = KALYANTRA.computed.wbs;
            const activities = KALYANTRA.computed.activities;
            const listEl     = document.getElementById('ganttActivityList');
            const timelineEl = document.getElementById('ganttTimeline');
            if (!listEl || !timelineEl) return;
            
            if (!wbs.length) {
                listEl.innerHTML = `<div style="padding:24px 16px;text-align:center;">
                    <div style="font-size:1.8rem;margin-bottom:8px;">üìä</div>
                    <div style="color:#1B3B6F;font-weight:700;margin-bottom:6px;">No Schedule Data</div>
                    <div style="color:#64748b;font-size:0.82rem;margin-bottom:14px;">Configure TCS sections and click Refresh WBS to generate the Gantt chart.</div>
                    <button onclick="KALYANTRA.refresh();KALYANTRA.render.wbsTable();setTimeout(renderGantt,200);"
                        style="background:#1B3B6F;color:white;border:none;padding:7px 18px;border-radius:6px;font-size:0.82rem;cursor:pointer;font-weight:700;">
                        üîÑ Refresh WBS
                    </button>
                </div>`;
                timelineEl.innerHTML = '';
                return;
            }
            
            // Calculate project date range
            const projectStart = parseLocalDate(KALYANTRA.data.project.startDate || '2026-01-01');
            // Use sequential total, with project duration as minimum
            const _projDur = KALYANTRA.data.project.duration || 730;
            const totalDays = Math.max(KALYANTRA.computed.totalDuration || _projDur, _projDur);
            const projectEnd   = new Date(projectStart);
            projectEnd.setDate(projectEnd.getDate() + totalDays);
            
            // Build rows: WBS header + activity rows
            const rows = [];
            let globalDayOffset = 0;
            
            wbs.forEach(item => {
                // L-10: parallel mode = all stretches start at day 0
                const itemStart = (executionMode === 'parallel' && item.type === 'stretch')
                    ? 0 : globalDayOffset;
                rows.push({ type: 'header', item, startDay: itemStart, endDay: itemStart + item.duration });
                let localOffset = 0;
                item.activities.forEach(act => {
                    rows.push({ type: 'activity', act, item, startDay: itemStart + localOffset, endDay: itemStart + localOffset + act.duration });
                    localOffset += act.duration;
                });
                if (item.type === 'stretch') globalDayOffset += item.duration;
            });
            
            // Timeline column widths
            const dayWidth = Math.max(14 * ganttZoomLevel, 6);
            const timelineWidth = totalDays * dayWidth + 40;
            const rowH = 32;
            
            // Build month headers
            let monthHeaders = '<div style="display:flex;background:#f1f5f9;border-bottom:2px solid #cbd5e1;position:sticky;top:0;z-index:10;">';
            const today = new Date();
            let curDate = new Date(projectStart);
            let prevMonth = -1;
            const monthSpans = {};
            
            for (let d = 0; d < totalDays; d++) {
                const m = curDate.getMonth();
                const mKey = curDate.getFullYear() * 12 + m;  // unique key across years
                if (!monthSpans[mKey]) monthSpans[mKey] = { label: curDate.toLocaleDateString('en-GB',{month:'short',year:'numeric'}), days: 0, start: d };
                monthSpans[mKey].days++;
                curDate.setDate(curDate.getDate() + 1);
            }
            Object.values(monthSpans).sort((a,b)=>a.start-b.start).forEach(ms => {
                monthHeaders += `<div style="width:${ms.days * dayWidth}px;min-width:${ms.days * dayWidth}px;padding:6px 8px;font-size:0.75rem;font-weight:700;color:#475569;border-right:1px solid #cbd5e1;white-space:nowrap;overflow:hidden;text-transform:uppercase;">${ms.label}</div>`;
            });
            monthHeaders += '</div>';
            
            // Today line position
            const todayDay = Math.floor((today - projectStart) / 86400000);
            const todayX   = todayDay * dayWidth + 20;
            
            // Build rows HTML
            let listHTML = `<div style="height:34px;background:#f1f5f9;border-bottom:2px solid #cbd5e1;font-size:0.75rem;font-weight:700;color:#475569;text-transform:uppercase;position:sticky;top:0;z-index:10;display:flex;align-items:center;padding:0 12px;">ACTIVITIES</div>`
            const GANTT_HEADER_H = 34; // month header height in pixels
            timelineHTML = monthHeaders + `<div style="position:relative;min-width:${timelineWidth}px;height:${rows.length * rowH + GANTT_HEADER_H + 4}px;">`; 
            
            // Today line
            if (todayDay >= 0 && todayDay <= totalDays) {
                timelineHTML += `<div style="position:absolute;left:${todayX}px;top:0;bottom:0;width:2px;background:rgba(220,38,38,0.6);z-index:5;pointer-events:none;">
                    <div style="position:absolute;top:0;left:-18px;background:#dc2626;color:white;font-size:10px;padding:1px 4px;border-radius:3px;white-space:nowrap;">TODAY</div>
                </div>`;
            }
            
            rows.forEach((row, ri) => {
                const top = ri * rowH;
                
                if (row.type === 'header') {
                    const phColors = { 1:['#ecfdf5','#166534','#22c55e'], 2:['#eff6ff','#1e40af','#3b82f6'], 3:['#fef2f2','#991b1b','#ef4444'] };
                    const [bg,tc,bc] = phColors[row.item.phase] || ['#f8fafc','#475569','#94a3b8'];
                    const _gViolations = (KALYANTRA.data.constraints && KALYANTRA.data.constraints.violations) || [];
                    const _gVC = _gViolations.filter(v => v.stretch1 === row.item.wbs).length;
                    const _gVBadge = _gVC ? ` <span style="background:#fef9c3;color:#854d0e;border:1px solid #fde047;padding:1px 5px;border-radius:3px;font-size:0.65rem;font-weight:700;">‚ö°${_gVC}CV</span>` : '';
                    listHTML += `<div style="padding:6px 12px;background:${bg};border-bottom:2px solid ${bc};border-left:4px solid ${_gVC?'#d97706':bc};font-weight:700;font-size:0.75rem;color:${tc};">${row.item.phase===1?'üü¢':row.item.phase===2?'üîµ':'üî¥'} ${row.item.wbs} ${row.item.name.length > 28 ? row.item.name.substring(0,28)+'‚Ä¶' : row.item.name}${_gVBadge}</div>`;
                    const barW = Math.max((row.endDay - row.startDay) * dayWidth, 8);
                    const barX = row.startDay * dayWidth + 20;
                    timelineHTML += `<div style="position:absolute;top:${top + GANTT_HEADER_H + 4}px;left:${barX}px;width:${barW}px;height:24px;background:${bc};opacity:0.25;border-radius:4px;" title="${row.item.name}"></div>`;
                } else {
                    const act    = row.act;
                    const isCrit = act.critical && ganttShowCritical;
                    // Constraint violation check ‚Äî amber if activity is in a violated stretch
                    const _ganttViol = (KALYANTRA.data.constraints && KALYANTRA.data.constraints.violations) || [];
                    const _isViolated = _ganttViol.some(v => v.stretch1 === row.item.wbs);
                    barColor = isCrit ? '#dc2626' : (_isViolated ? '#d97706' : (row.item.phase === 2 ? '#3b82f6' : '#1B3B6F'));
                    const barW   = Math.max((row.endDay - row.startDay) * dayWidth - 2, 6);
                    const barX   = row.startDay * dayWidth + 20;
                    const rowBg  = ri % 2 === 0 ? '#ffffff' : '#f8fafc';
                    
                    listHTML += `<div style="padding:5px 12px 5px 28px;border-bottom:1px solid #f1f5f9;background:${rowBg};font-size:0.78rem;color:${isCrit?'#dc2626':'#334155'};font-weight:${isCrit?'600':'400'};white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${act.name}">${isCrit?'üî¥ ':''}${act.name} (${act.duration}d)</div>`;
                    timelineHTML += `<div style="position:absolute;top:${top + GANTT_HEADER_H + 6}px;left:${barX}px;width:${barW}px;height:20px;background:${barColor};border-radius:3px;cursor:pointer;display:flex;align-items:center;padding:0 4px;overflow:hidden;" title="${act.name} | ${act.duration}d | ${act.resource||'‚Äî'}">
                        <span style="color:white;font-size:10px;font-weight:600;white-space:nowrap;overflow:hidden;">${act.name.split(' ')[0]}</span>
                    </div>`;
                    // Row background stripe
                    timelineHTML += `<div style="position:absolute;top:${top + GANTT_HEADER_H}px;left:0;right:0;height:${rowH}px;background:${rowBg};z-index:-1;"></div>`;
                }
            });
            
            timelineHTML += '</div>';
            
            listEl.innerHTML     = listHTML;
            timelineEl.innerHTML = timelineHTML;
            timelineEl.style.minWidth = timelineWidth + 'px';
            
            // ‚îÄ‚îÄ Sync vertical scroll: left list ‚Üî right timeline ‚îÄ‚îÄ
            const _tWrapper = timelineEl.parentElement;
            if (_tWrapper) {
                // Remove stale listeners and rebind fresh
                if (_tWrapper._ganttScrollHandler) {
                    _tWrapper.removeEventListener('scroll', _tWrapper._ganttScrollHandler);
                }
                if (listEl._ganttScrollHandler) {
                    listEl.removeEventListener('scroll', listEl._ganttScrollHandler);
                }
                let _syncingT = false;
                _tWrapper._ganttScrollHandler = () => {
                    if (_syncingT) return; _syncingT = true;
                    listEl.scrollTop = _tWrapper.scrollTop;
                    _syncingT = false;
                };
                listEl._ganttScrollHandler = () => {
                    if (_syncingT) return; _syncingT = true;
                    _tWrapper.scrollTop = listEl.scrollTop;
                    _syncingT = false;
                };
                _tWrapper.addEventListener('scroll', _tWrapper._ganttScrollHandler);
                listEl.addEventListener('scroll', listEl._ganttScrollHandler);
            }
            
            console.log('‚úÖ Gantt rendered:', rows.length, 'rows,', Math.round(ganttZoomLevel*100) + '% zoom');
        }
        
        function ganttZoomIn()  { ganttZoomLevel = Math.min(ganttZoomLevel * 1.3, 4); document.getElementById('ganttZoomLabel').textContent = Math.round(ganttZoomLevel*100)+'%'; renderGantt(); }
        function ganttZoomOut() { ganttZoomLevel = Math.max(ganttZoomLevel / 1.3, 0.3); document.getElementById('ganttZoomLabel').textContent = Math.round(ganttZoomLevel*100)+'%'; renderGantt(); }
        function ganttFit()     { ganttZoomLevel = 1.0; document.getElementById('ganttZoomLabel').textContent = '100%'; renderGantt(); }
        function ganttToggleCritical() {
            ganttShowCritical = !ganttShowCritical;
            const btn = document.getElementById('ganttCriticalBtn');
            if (btn) { btn.style.background = ganttShowCritical ? '#fee2e2' : 'white'; btn.style.color = ganttShowCritical ? '#991b1b' : '#64748b'; }
            renderGantt();
        }

        // L-10: Sequential vs Parallel execution model toggle
        let selectedTCSIndex = 0;     // FIX-UA06: remember last TCS row
        let executionMode = 'sequential'; // 'sequential' | 'parallel'
        function toggleExecutionMode() {
            executionMode = executionMode === 'sequential' ? 'parallel' : 'sequential';
            const btn = document.getElementById('execModeBtn');
            if (btn) {
                btn.textContent = executionMode === 'parallel' ? '‚ö° Parallel' : '‚ö° Sequential';
                btn.style.background = executionMode === 'parallel' ? '#FBF6E3' : '#EBF0FA';
                btn.style.borderColor = executionMode === 'parallel' ? '#D4AF37' : '#1B3B6F';
                btn.style.color       = executionMode === 'parallel' ? '#92700A' : '#1B3B6F';
            }
            renderGantt();
            showToast(executionMode === 'parallel'
                ? '‚ö° Parallel mode: all stretches start on day 1'
                : '‚ö° Sequential mode: stretches execute one after another', 'info');
        }
        
        // ================================================================
        // SPRINT 1: RENDER FUNCTIONS WIRED TO KALYANTRA + WBS STAT BAR
        // ================================================================
        
        // Update wbsStatBar after wbsTable render
        function updateWBSStatBar() {
            const c = KALYANTRA.computed;
            const el = document.getElementById('wbsStatBar');
            if (!el) return;
            const phases  = [...new Set(c.wbs.map(w => w.phase))].length;
            el.innerHTML  = `<strong>${phases}</strong> Phases &nbsp;‚Ä¢&nbsp; <strong>${c.totalActivities}</strong> Activities &nbsp;‚Ä¢&nbsp; <strong style="color:#dc2626;">${c.criticalActivities}</strong> Critical`;
        }
        
        // ================================================================
        // SPRINT 3 S3-04: addWorkingDays() ‚Äî calendar-aware scheduling
        // ================================================================
        // FIX: parseLocalDate prevents UTC‚ÜíIST 1-day shift on all date math
        function parseLocalDate(str) {
            if (!str) return new Date();
            if (str instanceof Date) return new Date(str); // already a Date
            const s = String(str);
            const p = s.split('-');
            if (p.length === 3) return new Date(+p[0], +p[1]-1, +p[2]);
            return new Date(s);
        }

        function addWorkingDays(startDate, days, monsoonSensitive) {
            const d = parseLocalDate(startDate);
            if (!days || days <= 0) return d;
            const cal = KALYANTRA.data.calendar;
            const mStart = cal.monsoonStart ? new Date(cal.monsoonStart) : null;
            const mEnd   = cal.monsoonEnd   ? new Date(cal.monsoonEnd)   : null;
            const holidays = (cal.holidays || []).map(h => new Date(h).toDateString());
            const workDays = (cal.workingDays && cal.workingDays.length) ? cal.workingDays : [1,2,3,4,5,6];
            let added = 0;
            while (added < days) {
                d.setDate(d.getDate() + 1);
                const day = d.getDay(); // 0=Sun
                if (!workDays.includes(day)) continue; // L-08: use workingDays array
                // Skip monsoon
                // FIX-LA07: monsoonSensitive:false = structure activities skip monsoon check
                if ((monsoonSensitive !== false) && mStart && mEnd && d >= mStart && d <= mEnd) continue;
                // Skip holidays
                if (holidays.includes(d.toDateString())) continue;
                added++;
            }
            return d;
        }

        // ================================================================
        // SPRINT 3 S3-01: renderProgressTab() ‚Äî dynamic Tab 9
        // ================================================================
        // FIX-GAP06: Dynamic milestone tracker from KALYANTRA.data.milestones
        function renderMilestoneTracker() {
            const el = document.getElementById('milestoneTrackerBody');
            if (!el) return;
            const mils = KALYANTRA.data.milestones || [];
            const today = new Date();
            const overall = KALYANTRA.computed.overallProgress || 0;
            const rows = [{ icon:'‚úÖ', label:'Project Start', date: KALYANTRA.data.project.startDate || '2026-01-01', pct:0, bg:'#dcfce7', col:'#166534', badge:'Achieved' }];
            mils.forEach((m, i) => {
                const td = m.targetDate ? new Date(m.targetDate) : null;
                const isPast = td && td < today;
                const isDue  = td && !isPast && (td - today) < 30 * 86400000;
                const isAch  = overall >= (m.completion || 0);
                const badge  = isAch ? 'Achieved' : (isPast ? 'Delayed' : isDue ? 'Due Soon' : 'Upcoming');
                const st = { Achieved:['#dcfce7','#166534'], Delayed:['#fee2e2','#991b1b'], 'Due Soon':['#fff7ed','#9a3412'], Upcoming:['#dbeafe','#1e40af'] }[badge] || ['#f1f5f9','#475569'];
                rows.push({ icon: isAch?'‚úÖ':isPast?'üî¥':isDue?'üü°':'üîµ', label: m.description || ('Milestone '+(i+1)), date: m.targetDate || '‚Äî', pct: m.completion||0, bg:st[0], col:st[1], badge });
            });
            el.innerHTML = rows.map(r => `<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;padding:8px;border-radius:6px;background:${r.bg}22;">
                <span style="font-size:1.2rem;">${r.icon}</span>
                <div style="flex:1;"><div style="font-weight:600;font-size:0.85rem;color:#1e293b;">${r.label}</div>
                <div style="font-size:0.78rem;color:#64748b;">Target: ${r.date}${r.pct?' ¬∑ '+r.pct+'% complete':''}</div></div>
                <span style="background:${r.bg};color:${r.col};padding:2px 8px;border-radius:10px;font-size:0.73rem;font-weight:700;">${r.badge}</span></div>`).join('');
        }

        function renderProgressTab() {
            try {
                KALYANTRA.refresh();
                // FIX-UA10: show empty state if no activities generated yet
                if (!KALYANTRA.computed.activities || KALYANTRA.computed.activities.length === 0) {
                    const _c9 = document.querySelector('#tab10 .content-container') || document.getElementById('tab10');
                    if (_c9 && !_c9.querySelector('.ua10-empty')) {
                        const _e = document.createElement('div'); _e.className = 'ua10-empty';
                        _e.style.cssText = 'padding:40px;text-align:center;color:#64748b;background:#f8fafc;border-radius:10px;margin:20px;';
                        _e.innerHTML = '<div style="font-size:2rem;margin-bottom:12px;">üìä</div><strong>No schedule yet.</strong><br><br>Open <strong>Tab 7 ‚Äî Activity Grid</strong> to generate the schedule first, then return here.';
                        _c9.prepend(_e);
                    }
                    return;
                }
                document.querySelectorAll('.ua10-empty').forEach(el => el.remove());
                if (typeof renderMilestoneTracker === 'function') renderMilestoneTracker();
            // V9 new tab inits at load
            if (typeof initResourcesTab === 'function')  initResourcesTab();
            if (typeof initShiftConfig  === 'function')  initShiftConfig();
            if (typeof renderBaselineInfo === 'function') renderBaselineInfo();
            if (typeof computeAllAlerts  === 'function')  computeAllAlerts();
            if (typeof renderAlertsTab   === 'function')  renderAlertsTab();
            if (typeof renderEarnedValueTab === 'function') renderEarnedValueTab(); // FIX-GAP06
                const c = KALYANTRA.computed;
                const d = KALYANTRA.data;
                const proj = d.project;

                // U-09: Read period selector
                const periodEl = document.getElementById('progressPeriodSelect');
                const period   = periodEl ? periodEl.value : 'project';

                // Compute overall progress from WBS phases
                const totalActs = c.activities.length || 1;
                const phases = [...new Set(c.wbs.map(w => w.phase))];
                const phaseCount = phases.length || 1;

                // Use real progress if available, otherwise time-elapsed proxy
                // FIX: parseLocalDate prevents UTC‚ÜíIST 1-day shift; endDate drives totalDays
                const startDate = parseLocalDate(proj.startDate || '2026-01-01');
                const today     = new Date();
                let totalDays   = proj.duration || 0;
                if (!totalDays && proj.endDate && proj.startDate) {
                    const _e2rpt = parseLocalDate(proj.endDate);
                    totalDays = Math.max(1, Math.floor((_e2rpt - startDate) / 86400000));
                }
                totalDays = totalDays || 540;
                const elapsedDays = Math.max(0, Math.floor((today - startDate) / 86400000));
                let periodDays = elapsedDays;
                if (period === '30')  periodDays = Math.min(elapsedDays, 30);
                else if (period === '60') periodDays = Math.min(elapsedDays, 60);
                else if (period === '90') periodDays = Math.min(elapsedDays, 90);
                const overallPct = c.overallProgress > 0
                    ? c.overallProgress
                    : Math.min(99, Math.round((periodDays / totalDays) * 100));

                // FIX-GAP10: SPI = actual progress / planned progress
                const plannedPct    = Math.min(100, Math.round((elapsedDays / Math.max(1, totalDays)) * 100));
                const SPI           = plannedPct > 0 ? +(overallPct / plannedPct).toFixed(2) : 1.0;
                const SPIColor      = SPI >= 1 ? '#16a34a' : SPI >= 0.9 ? '#d97706' : '#dc2626';
                const SPILabel      = SPI >= 1 ? 'On Track' : SPI >= 0.9 ? 'Slight Delay' : 'Behind Schedule';

                // Phase-wise breakdown (simple proportional)
                const phase1Pct = Math.min(100, Math.round(overallPct * 1.4));
                const phase2Pct = Math.min(100, Math.round(overallPct * 0.9));
                const phase3Pct = Math.min(100, Math.round(overallPct * 0.5));

                // Work-type breakdown
                const earthPct  = Math.min(100, Math.round(phase1Pct * 0.9));
                const structPct = Math.min(100, Math.round(overallPct * 0.6));
                const pavePct   = Math.min(100, Math.round(phase2Pct * 0.7));
                const drainPct  = Math.min(100, Math.round(phase3Pct * 0.8));

                // Hindrance impact
                const pendingH  = d.hindrances.filter(h => h.status !== 'Resolved').length;
                const blockedPct = Math.min(30, pendingH * 8);

                // Update progress-by-work-type bars
                const bars = {
                    'Earthwork':   { pct: earthPct,  color: 'linear-gradient(to right,#f59e0b,#d97706)' },
                    'Structures':  { pct: structPct, color: 'linear-gradient(to right,#3b82f6,#2563eb)' },
                    'Pavement':    { pct: pavePct,   color: 'linear-gradient(to right,#22c55e,#16a34a)' },
                    'Drainage':    { pct: drainPct,  color: 'linear-gradient(to right,#8b5cf6,#7c3aed)' },
                };

                // Build progress-by-work-type HTML
                let workTypeHTML = Object.entries(bars).map(([name, info]) => `
                    <div style="margin-bottom:18px;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                            <span style="font-size:0.875rem;font-weight:500;color:#475569;">${name}</span>
                            <span style="font-size:0.875rem;font-weight:700;color:#1e293b;">${info.pct}%</span>
                        </div>
                        <div style="width:100%;height:10px;background:#e2e8f0;border-radius:5px;overflow:hidden;">
                            <div style="width:${info.pct}%;height:100%;background:${info.color};border-radius:5px;transition:width 0.6s ease;"></div>
                        </div>
                    </div>`).join('');

                // Build milestone tracker from KALYANTRA.data.milestones
                let milestoneHTML = '';
                if (d.milestones && d.milestones.length > 0) {
                    milestoneHTML = d.milestones.map(m => {
                        const mDate = new Date(m.targetDate || '');
                        const isPast = mDate < today;
                        const icon  = isPast ? '‚úÖ' : (m.completion > 0 ? 'üîµ' : '‚ö™');
                        const badge = isPast ? 'background:#dcfce7;color:#166534' : (m.completion > 0 ? 'background:#dbeafe;color:#1e40af' : 'background:#f1f5f9;color:#64748b');
                        const label = isPast ? 'Completed' : (m.completion > 0 ? 'In Progress' : 'Pending');
                        const dStr  = mDate.toLocaleDateString ? mDate.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}) : m.targetDate;
                        return `<div style="margin-bottom:16px;">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <span style="font-size:1.5rem;">${icon}</span>
                                <div style="flex:1;">
                                    <div style="font-weight:600;font-size:0.875rem;color:#1e293b;">${m.description}</div>
                                    <div style="font-size:0.8125rem;color:#64748b;">Target: ${dStr} ¬∑ ${m.completion}%</div>
                                </div>
                                <span style="padding:4px 10px;border-radius:12px;font-size:0.75rem;font-weight:600;${badge}">${label}</span>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    // Default milestones from project data
                    const pStart = parseLocalDate(proj.startDate || '2026-01-01');
                    const _pDur = proj.duration || (proj.endDate && proj.startDate ? Math.max(1, Math.round((parseLocalDate(proj.endDate) - parseLocalDate(proj.startDate)) / 86400000)) : 540);
                    const pEnd   = addWorkingDays(pStart, _pDur);
                    milestoneHTML = `
                        <div style="margin-bottom:16px;">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <span style="font-size:1.5rem;">${parseLocalDate(proj.startDate) < today ? '‚úÖ' : '‚ö™'}</span>
                                <div style="flex:1;"><div style="font-weight:600;font-size:0.875rem;color:#1e293b;">Project Start</div>
                                <div style="font-size:0.8125rem;color:#64748b;">${pStart.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})}</div></div>
                                <span style="background:#dcfce7;color:#166534;padding:4px 10px;border-radius:12px;font-size:0.75rem;font-weight:600;">Completed</span>
                            </div>
                        </div>
                        <div style="margin-bottom:16px;">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <span style="font-size:1.5rem;">üîµ</span>
                                <div style="flex:1;"><div style="font-weight:600;font-size:0.875rem;color:#1e293b;">Phase 1 Completion</div>
                                <div style="font-size:0.8125rem;color:#64748b;">Target: ${addWorkingDays(pStart,180).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})}</div></div>
                                <span style="background:#dbeafe;color:#1e40af;padding:4px 10px;border-radius:12px;font-size:0.75rem;font-weight:600;">In Progress</span>
                            </div>
                        </div>
                        <div>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <span style="font-size:1.5rem;">‚ö™</span>
                                <div style="flex:1;"><div style="font-weight:600;font-size:0.875rem;color:#1e293b;">Project Completion</div>
                                <div style="font-size:0.8125rem;color:#64748b;">Target: ${pEnd.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})}</div></div>
                                <span style="background:#f1f5f9;color:#64748b;padding:4px 10px;border-radius:12px;font-size:0.75rem;font-weight:600;">Pending</span>
                            </div>
                        </div>`;
                }

                // Chainage progress bar
                const totalLen = (proj.endChainage - proj.startChainage) / 1000;
                const wsLen    = c.workableStretches.reduce((s,w) => s + w.length, 0);
                const blkLen   = totalLen - wsLen;
                const compPct  = Math.round((wsLen * overallPct/100) / (totalLen || 1) * 100);
                const blkPctBar= Math.round((blkLen / (totalLen || 1)) * 100);
                const ch = km => `Ch ${Math.floor(km)}+${String(Math.round((km%1)*1000)).padStart(3,'0')}`;

                // Build chain labels
                const chainLabels = [];
                const step = Math.round(totalLen / 5) || 1;
                for (let k = 0; k <= 5; k++) {
                    chainLabels.push(ch((proj.startChainage/1000) + k * step));
                }

                // Build full Tab 9 HTML
                const tab9Content = document.querySelector('#tab10 .content-container');
                if (!tab9Content) return;
                // UA-10 FIX: Guard for empty activities array - show placeholder instead of broken zeros
                if (!d.activities || (KALYANTRA.computed.activities.length === 0 && !KALYANTRA.data.tcs)) {
                    tab9Content.innerHTML = '<div style="padding:40px;text-align:center;color:#94a3b8;"><p style="font-size:1.1rem;">üìä No project data yet.</p><p style="margin-top:8px;">Complete Tabs 1‚Äì7 first to generate progress data.</p></div>';
                    return;
                }

                tab9Content.innerHTML = `
                    <!-- S-Curve + overall progress -->
                    <div style="background:white;border-radius:8px;padding:28px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:24px;">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;">
                            <h4 style="margin:0;color:#1e293b;font-size:1.125rem;font-weight:600;">Progress S-Curve (Planned vs Actual)</h4>
                            <div style="text-align:right;">
                                <div style="font-size:2rem;font-weight:700;color:#1B3B6F;">${overallPct}%</div>
                                <div style="font-size:0.8rem;color:#64748b;">Overall Progress ¬∑ Day ${elapsedDays}/${totalDays}</div>
                                <div style="margin-top:6px;display:flex;gap:8px;align-items:center;justify-content:flex-end;">
                                    <span style="font-size:0.8rem;color:#64748b;">SPI:</span>
                                    <span style="font-size:1.1rem;font-weight:800;color:${SPIColor};">${SPI}</span>
                                    <span style="font-size:0.72rem;padding:2px 7px;border-radius:10px;background:${SPIColor}22;color:${SPIColor};font-weight:700;">${SPILabel}</span>
                                </div>
                                <div style="font-size:0.72rem;color:#94a3b8;margin-top:2px;">Planned: ${plannedPct}% ¬∑ Actual: ${overallPct}%</div>
                            </div>
                        </div>
                        <div id="prog9ScurveContainer" style="position:relative;height:280px;background:#fafbfc;border:1px solid #e2e8f0;border-radius:6px;overflow:hidden;">
                            <!-- SVG injected by renderSCurve() -->
                        </div>
                    </div>

                    <!-- Progress by Work Type + Milestone Tracker -->
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:24px;">
                        <div style="background:white;border-radius:8px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                            <h4 style="margin:0 0 20px 0;color:#1e293b;font-size:1rem;font-weight:600;border-bottom:2px solid #e5e7eb;padding-bottom:12px;">
                                Progress by Work Type
                                <span style="font-size:0.75rem;font-weight:500;color:#64748b;margin-left:8px;">${pendingH} active hindrance${pendingH!==1?'s':''}</span>
                            </h4>
                            ${workTypeHTML}
                        </div>
                        <div style="background:white;border-radius:8px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                            <h4 style="margin:0 0 20px 0;color:#1e293b;font-size:1rem;font-weight:600;border-bottom:2px solid #e5e7eb;padding-bottom:12px;">Milestone Tracker</h4>
                            ${milestoneHTML}
                        </div>
                    </div>

                    <!-- Phase breakdown bars -->
                    <div style="background:white;border-radius:8px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:24px;">
                        <h4 style="margin:0 0 20px 0;color:#1e293b;font-size:1rem;font-weight:600;border-bottom:2px solid #e5e7eb;padding-bottom:12px;">Phase Progress</h4>
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;">
                            ${[['Phase 1 ‚Äî Earthwork & Drainage','#22c55e',phase1Pct],
                               ['Phase 2 ‚Äî Structures','#3b82f6',phase2Pct],
                               ['Phase 3 ‚Äî Pavement','#D4AF37',phase3Pct]].map(([lbl,col,pct])=>`
                            <div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                    <span style="font-size:0.875rem;font-weight:600;color:#1e293b;">${lbl}</span>
                                    <span style="font-size:0.875rem;font-weight:700;color:${col};">${pct}%</span>
                                </div>
                                <div style="height:12px;background:#e2e8f0;border-radius:6px;overflow:hidden;">
                                    <div style="width:${pct}%;height:100%;background:${col};border-radius:6px;transition:width 0.6s ease;"></div>
                                </div>
                            </div>`).join('')}
                        </div>
                    </div>

                    <!-- Progress by Chainage -->
                    <div style="background:white;border-radius:8px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                        <h4 style="margin:0 0 20px 0;color:#1e293b;font-size:1rem;font-weight:600;border-bottom:2px solid #e5e7eb;padding-bottom:12px;">Progress by Chainage</h4>
                        <div style="position:relative;padding:0 0 20px;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:0.72rem;color:#64748b;font-weight:600;">
                                ${chainLabels.map(l=>`<span>${l}</span>`).join('')}
                            </div>
                            <div style="width:100%;height:28px;background:#e2e8f0;border-radius:14px;overflow:hidden;position:relative;">
                                <div style="position:absolute;left:0;width:${compPct}%;height:100%;background:linear-gradient(to right,#22c55e,#16a34a);"></div>
                                <div style="position:absolute;left:${compPct}%;width:8%;height:100%;background:repeating-linear-gradient(45deg,#3b82f6,#3b82f6 8px,#60a5fa 8px,#60a5fa 16px);"></div>
                                <div style="position:absolute;left:${Math.max(0,100-blkPctBar)}%;width:${blkPctBar}%;height:100%;background:repeating-linear-gradient(45deg,#ef4444,#ef4444 8px,#f87171 8px,#f87171 16px);"></div>
                            </div>
                            <div style="display:flex;gap:16px;margin-top:10px;font-size:0.75rem;flex-wrap:wrap;">
                                <span style="display:flex;align-items:center;gap:5px;"><span style="width:14px;height:14px;background:linear-gradient(to right,#22c55e,#16a34a);border-radius:2px;display:inline-block;"></span>Completed (${compPct}%)</span>
                                <span style="display:flex;align-items:center;gap:5px;"><span style="width:14px;height:14px;background:repeating-linear-gradient(45deg,#3b82f6,#3b82f6 4px,#60a5fa 4px,#60a5fa 8px);border-radius:2px;display:inline-block;"></span>In Progress</span>
                                <span style="display:flex;align-items:center;gap:5px;"><span style="width:14px;height:14px;background:repeating-linear-gradient(45deg,#ef4444,#ef4444 4px,#f87171 4px,#f87171 8px);border-radius:2px;display:inline-block;"></span>Blocked (${blkPctBar}%)</span>
                                <span style="display:flex;align-items:center;gap:5px;"><span style="width:14px;height:14px;background:#e2e8f0;border-radius:2px;display:inline-block;"></span>Not Started</span>
                            </div>
                        </div>
                    </div>
                `;

                // Now render S-curve into the container
                renderSCurve(overallPct, totalDays, elapsedDays, proj);

            } catch(e) {
                console.error('renderProgressTab error:', e);
            }
        }

        // ================================================================
        // SPRINT 3 S3-02: renderSCurve() ‚Äî real SVG S-curve
        // ================================================================
        function renderSCurve(actualPct, totalDays, elapsedDays, proj) {
            const container = document.getElementById('prog9ScurveContainer');
            if (!container) return;

            const W = container.offsetWidth || 800;
            const H = 280;
            const padL = 50, padR = 20, padT = 20, padB = 40;
            const plotW = W - padL - padR;
            const plotH = H - padT - padB;

            // Generate planned S-curve points (logistic growth)
            const planPoints = [];
            for (let d = 0; d <= totalDays; d += Math.max(1, Math.floor(totalDays/20))) {
                const t = d / totalDays;
                const logistic = 100 / (1 + Math.exp(-8 * (t - 0.5)));
                const x = padL + (d / totalDays) * plotW;
                const y = padT + plotH - (logistic / 100) * plotH;
                planPoints.push(`${x.toFixed(1)},${y.toFixed(1)}`);
            }

            // Actual progress points (linear from start to today)
            const actualPoints = [];
            for (let d = 0; d <= elapsedDays; d += Math.max(1, Math.floor(elapsedDays/10 || 1))) {
                const t = d / totalDays;
                const x = padL + t * plotW;
                const aVal = Math.min(actualPct, (d / Math.max(1,elapsedDays)) * actualPct);
                const y = padT + plotH - (aVal / 100) * plotH;
                actualPoints.push(`${x.toFixed(1)},${y.toFixed(1)}`);
            }
            // Ensure last actual point is at today's x
            const todayX = padL + (elapsedDays / totalDays) * plotW;
            const todayY = padT + plotH - (actualPct / 100) * plotH;
            actualPoints.push(`${todayX.toFixed(1)},${todayY.toFixed(1)}`);

            // Start/end dates
            const sd = parseLocalDate(proj.startDate || '2026-01-01');
            const ed = addWorkingDays(sd, totalDays);
            const fmtDate = d => d.toLocaleDateString('en-GB',{month:'short',year:'2-digit'});
            const monthStep = Math.max(1, Math.round(totalDays / 6));
            const xLabels = [];
            for (let i = 0; i <= 6; i++) {
                const d2 = new Date(sd); d2.setDate(d2.getDate() + i * monthStep);
                const x = padL + (i * monthStep / totalDays) * plotW;
                xLabels.push({ x: Math.min(x, padL + plotW), label: fmtDate(d2) });
            }

            // Grid lines
            const gridLines = [0, 25, 50, 75, 100].map(pct => {
                const y = padT + plotH - (pct / 100) * plotH;
                return `<line x1="${padL}" y1="${y.toFixed(1)}" x2="${padL+plotW}" y2="${y.toFixed(1)}" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="4,4"/>
                        <text x="${padL-6}" y="${(y+4).toFixed(1)}" text-anchor="end" font-size="11" fill="#94a3b8">${pct}%</text>`;
            }).join('');

            // X axis labels
            const xAxisLabels = xLabels.map(({x,label}) =>
                `<text x="${x.toFixed(1)}" y="${(H-8).toFixed(1)}" text-anchor="middle" font-size="10" fill="#94a3b8">${label}</text>`
            ).join('');

            // Variance area (between planned and actual up to today)
            const planAtToday = 100 / (1 + Math.exp(-8 * (elapsedDays/totalDays - 0.5)));
            const isAhead = actualPct >= planAtToday;
            const varColor = isAhead ? 'rgba(34,197,94,0.12)' : 'rgba(239,68,68,0.1)';

            // Today marker
            const todayLineX = todayX.toFixed(1);

            const svg = `<svg width="${W}" height="${H}" style="position:absolute;top:0;left:0;">
                <!-- Grid -->
                ${gridLines}
                <line x1="${padL}" y1="${padT}" x2="${padL}" y2="${padT+plotH}" stroke="#cbd5e1" stroke-width="1.5"/>
                <line x1="${padL}" y1="${padT+plotH}" x2="${padL+plotW}" y2="${padT+plotH}" stroke="#cbd5e1" stroke-width="1.5"/>
                ${xAxisLabels}
                <!-- Planned S-curve -->
                <polyline points="${planPoints.join(' ')}" fill="none" stroke="#1B3B6F" stroke-width="2.5" stroke-dasharray="7,4" opacity="0.7"/>
                <!-- Actual progress -->
                <polyline points="${actualPoints.join(' ')}" fill="none" stroke="#D4AF37" stroke-width="3"/>
                <!-- Today marker -->
                <line x1="${todayLineX}" y1="${padT}" x2="${todayLineX}" y2="${padT+plotH}" stroke="#dc2626" stroke-width="1.5" stroke-dasharray="4,3"/>
                <text x="${todayLineX}" y="${padT-4}" text-anchor="middle" font-size="10" fill="#dc2626" font-weight="600">TODAY</text>
                <!-- Actual point -->
                <circle cx="${todayX.toFixed(1)}" cy="${todayY.toFixed(1)}" r="5" fill="#D4AF37" stroke="white" stroke-width="2"/>
                <!-- Legend -->
                <rect x="${W-160}" y="${padT+8}" width="140" height="52" rx="4" fill="white" stroke="#e2e8f0" stroke-width="1"/>
                <line x1="${W-148}" y1="${padT+22}" x2="${W-128}" y2="${padT+22}" stroke="#1B3B6F" stroke-width="2.5" stroke-dasharray="6,3"/>
                <text x="${W-122}" y="${padT+26}" font-size="11" fill="#475569">Planned</text>
                <line x1="${W-148}" y1="${padT+40}" x2="${W-128}" y2="${padT+40}" stroke="#D4AF37" stroke-width="2.5"/>
                <circle cx="${W-138}" cy="${padT+40}" r="3.5" fill="#D4AF37"/>
                <text x="${W-122}" y="${padT+44}" font-size="11" fill="#475569">Actual (${actualPct}%)</text>
            </svg>`;

            container.innerHTML = svg;
            console.log('üìà S-curve rendered: actual=' + actualPct + '%, planned=' + planAtToday.toFixed(1) + '%, ' + (isAhead ? 'AHEAD' : 'BEHIND'));
        }

        // ================================================================
        // SPRINT 3 S3-03: generateReport() ‚Äî real printable reports
        // ================================================================
        function generateReport(type) {
            KALYANTRA.refresh();
            const c = KALYANTRA.computed;
            const d = KALYANTRA.data;
            const proj = d.project;
            const today = new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});

            let title = '', body = '';

            if (type === 'daily') {
                title = 'Daily Progress Report ‚Äî ' + today;
                body = `
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;">Project Overview</h3>
                    <table style="width:100%;border-collapse:collapse;margin-bottom:20px;">
                        <tr><td style="padding:6px 12px;background:#f8fafc;font-weight:600;width:200px;">Project</td><td style="padding:6px 12px;">${proj.name}</td></tr>
                        <tr><td style="padding:6px 12px;background:#f8fafc;font-weight:600;">Start Date</td><td style="padding:6px 12px;">${proj.startDate}</td></tr>
                        <tr><td style="padding:6px 12px;background:#f8fafc;font-weight:600;">Chainage</td><td style="padding:6px 12px;">${proj.startChainage/1000}+000 ‚Üí ${proj.endChainage/1000}+000</td></tr>
                        <tr><td style="padding:6px 12px;background:#f8fafc;font-weight:600;">Total Length</td><td style="padding:6px 12px;">${((proj.endChainage-proj.startChainage)/1000).toFixed(2)} km</td></tr>
                        <tr><td style="padding:6px 12px;background:#f8fafc;font-weight:600;">Contract Value</td><td style="padding:6px 12px;">‚Çπ ${(parseFloat(proj.budget)||1356.90).toFixed(2)} Cr</td></tr>
                    </table>
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;">Today's Active Activities</h3>
                    <table style="width:100%;border-collapse:collapse;font-size:0.875rem;">
                        <thead><tr style="background:#1B3B6F;color:white;">
                            <th style="padding:8px 12px;text-align:left;">Activity</th>
                            <th style="padding:8px 12px;text-align:right;">Qty</th>
                            <th style="padding:8px 12px;text-align:left;">Unit</th>
                            <th style="padding:8px 12px;text-align:left;">Resource</th>
                            <th style="padding:8px 12px;text-align:center;">Critical</th>
                        </tr></thead>
                        <tbody>
                        ${c.activities.slice(0,10).map((a,i)=>`
                            <tr style="background:${i%2?'#f8fafc':'white'};">
                                <td style="padding:7px 12px;">${a.name}</td>
                                <td style="padding:7px 12px;text-align:right;">${a.qty.toLocaleString()}</td>
                                <td style="padding:7px 12px;">${a.unit}</td>
                                <td style="padding:7px 12px;">${a.resource||'‚Äî'}</td>
                                <td style="padding:7px 12px;text-align:center;">${a.critical?'<span style="color:#dc2626;font-weight:700;">‚óè</span>':'‚óã'}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                    ${c.activities.length > 10 ? `<p style="color:#64748b;font-size:0.85rem;margin-top:8px;">+ ${c.activities.length-10} more activities</p>` : ''}
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;margin-top:20px;">Active Hindrances</h3>
                    ${d.hindrances.filter(h=>h.status!=='Resolved').length > 0
                        ? `<table style="width:100%;border-collapse:collapse;font-size:0.875rem;">
                            <thead><tr style="background:#1B3B6F;color:white;">
                                <th style="padding:8px 12px;text-align:left;">Hindrance</th>
                                <th style="padding:8px 12px;text-align:left;">Chainage</th>
                                <th style="padding:8px 12px;text-align:left;">Type</th>
                                <th style="padding:8px 12px;text-align:left;">Impact</th>
                            </tr></thead><tbody>
                            ${d.hindrances.filter(h=>h.status!=='Resolved').map((h,i)=>`
                                <tr style="background:${i%2?'#fff5f5':'white'};">
                                    <td style="padding:7px 12px;">${h.name||'Hindrance '+h.id}</td>
                                    <td style="padding:7px 12px;">${(h.chainageStart/1000).toFixed(3)} ‚Äì ${(h.chainageEnd/1000).toFixed(3)}</td>
                                    <td style="padding:7px 12px;">${h.type||'‚Äî'}</td>
                                    <td style="padding:7px 12px;">${h.impact||'‚Äî'}</td>
                                </tr>`).join('')}
                            </tbody></table>`
                        : '<p style="color:#16a34a;font-weight:600;">‚úÖ No active hindrances today</p>'}`;

            } else if (type === 'hindrance') {
                title = 'Hindrance Analysis Report ‚Äî ' + today;
                body = `
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;">All Hindrances Summary</h3>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">
                        <div style="background:#fef2f2;border:1px solid #fca5a5;border-radius:6px;padding:12px;text-align:center;">
                            <div style="font-size:1.8rem;font-weight:700;color:#dc2626;">${d.hindrances.filter(h=>h.status!=='Resolved').length}</div>
                            <div style="font-size:0.8rem;color:#64748b;">Active</div>
                        </div>
                        <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:6px;padding:12px;text-align:center;">
                            <div style="font-size:1.8rem;font-weight:700;color:#16a34a;">${d.hindrances.filter(h=>h.status==='Resolved').length}</div>
                            <div style="font-size:0.8rem;color:#64748b;">Resolved</div>
                        </div>
                        <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:12px;text-align:center;">
                            <div style="font-size:1.8rem;font-weight:700;color:#1B3B6F;">${d.hindrances.length}</div>
                            <div style="font-size:0.8rem;color:#64748b;">Total</div>
                        </div>
                    </div>
                    <table style="width:100%;border-collapse:collapse;font-size:0.875rem;">
                        <thead><tr style="background:#1B3B6F;color:white;">
                            <th style="padding:8px 12px;text-align:left;">#</th>
                            <th style="padding:8px 12px;text-align:left;">Hindrance</th>
                            <th style="padding:8px 12px;text-align:left;">From Ch</th>
                            <th style="padding:8px 12px;text-align:left;">To Ch</th>
                            <th style="padding:8px 12px;text-align:left;">Type</th>
                            <th style="padding:8px 12px;text-align:left;">Status</th>
                            <th style="padding:8px 12px;text-align:right;">Length (km)</th>
                            <th style="padding:8px 12px;text-align:left;">Impact</th>
                        </tr></thead><tbody>
                        ${d.hindrances.map((h,i)=>`
                            <tr style="background:${h.status==='Resolved'?'#f0fdf4':i%2?'#fff5f5':'white'};">
                                <td style="padding:7px 12px;">${h.id}</td>
                                <td style="padding:7px 12px;font-weight:500;">${h.name||'Hindrance '+h.id}</td>
                                <td style="padding:7px 12px;">${(h.chainageStart/1000).toFixed(3)}</td>
                                <td style="padding:7px 12px;">${(h.chainageEnd/1000).toFixed(3)}</td>
                                <td style="padding:7px 12px;">${h.type||'‚Äî'}</td>
                                <td style="padding:7px 12px;"><span style="padding:3px 8px;border-radius:10px;font-size:0.75rem;font-weight:600;${h.status==='Resolved'?'background:#dcfce7;color:#166534':'background:#fee2e2;color:#991b1b'}">${h.status}</span></td>
                                <td style="padding:7px 12px;text-align:right;">${((h.chainageEnd-h.chainageStart)/1000).toFixed(3)}</td>
                                <td style="padding:7px 12px;">${h.impact||'‚Äî'}</td>
                            </tr>`).join('')}
                        </tbody></table>
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;margin-top:20px;">Workable Stretches (Hindrance-Free)</h3>
                    <table style="width:100%;border-collapse:collapse;font-size:0.875rem;">
                        <thead><tr style="background:#1B3B6F;color:white;">
                            <th style="padding:8px 12px;text-align:left;">Stretch</th>
                            <th style="padding:8px 12px;text-align:left;">From Ch</th>
                            <th style="padding:8px 12px;text-align:left;">To Ch</th>
                            <th style="padding:8px 12px;text-align:right;">Length (km)</th>
                        </tr></thead><tbody>
                        ${c.workableStretches.map((w,i)=>`
                            <tr style="background:${i%2?'#f8fafc':'white'};">
                                <td style="padding:7px 12px;">${w.id}</td>
                                <td style="padding:7px 12px;">${(w.start/1000).toFixed(3)}</td>
                                <td style="padding:7px 12px;">${(w.end/1000).toFixed(3)}</td>
                                <td style="padding:7px 12px;text-align:right;font-weight:600;">${w.length.toFixed(3)}</td>
                            </tr>`).join('')}
                        </tbody></table>`;

            } else if (type === 'schedule') {
                title = 'Schedule Variance Report ‚Äî ' + today;
                body = `
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;">WBS Schedule Analysis</h3>
                    <table style="width:100%;border-collapse:collapse;font-size:0.875rem;">
                        <thead><tr style="background:#1B3B6F;color:white;">
                            <th style="padding:8px 12px;text-align:left;">WBS</th>
                            <th style="padding:8px 12px;text-align:left;">Description</th>
                            <th style="padding:8px 12px;text-align:right;">Planned Days</th>
                            <th style="padding:8px 12px;text-align:right;">Activities</th>
                            <th style="padding:8px 12px;text-align:right;">Critical</th>
                            <th style="padding:8px 12px;text-align:left;">Phase</th>
                            <th style="padding:8px 12px;text-align:left;">Status</th>
                        </tr></thead><tbody>
                        ${c.wbs.map((w,i)=>`
                            <tr style="background:${i%2?'#f8fafc':'white'};">
                                <td style="padding:7px 12px;font-family:monospace;font-size:0.8rem;color:#1B3B6F;">${w.wbs}</td>
                                <td style="padding:7px 12px;">${w.description}</td>
                                <td style="padding:7px 12px;text-align:right;">${w.duration}</td>
                                <td style="padding:7px 12px;text-align:right;">${w.activities?w.activities.length:0}</td>
                                <td style="padding:7px 12px;text-align:right;${w.activities&&w.activities.filter(a=>a.critical).length>0?'color:#dc2626;font-weight:700;':'color:#64748b;'}">${w.activities?w.activities.filter(a=>a.critical).length:0}</td>
                                <td style="padding:7px 12px;"><span style="padding:3px 8px;border-radius:10px;font-size:0.75rem;font-weight:600;${w.phase===1?'background:#dcfce7;color:#166534':w.phase===2?'background:#dbeafe;color:#1e40af':'background:#fef3c7;color:#92400e'}">Phase ${w.phase}</span></td>
                                <td style="padding:7px 12px;"><span style="padding:3px 8px;border-radius:10px;font-size:0.75rem;font-weight:600;background:#dbeafe;color:#1e40af">Scheduled</span></td>
                            </tr>`).join('')}
                        </tbody></table>`;

            } else if (type === 'weekly') {
                title = 'Weekly Status Report ‚Äî ' + today;
                const wHind = d.hindrances.filter(h => h.status === 'Pending');
                const critA = c.activities.filter(a => a.critical);
                const fmtC  = m => { const k=Math.floor(m/1000),r=m%1000; return k+'+'+String(r).padStart(3,'0'); };
                body = `
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;">Weekly Overview ‚Äî ${proj.name}</h3>
                    <table style="width:100%;border-collapse:collapse;margin-bottom:16px;font-size:0.875rem;">
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;width:38%;">Contract Value</td><td style="padding:6px 10px;">‚Çπ ${(parseFloat(proj.budget)||1356.90).toFixed(2)} Cr</td></tr>
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;">Project Length</td><td style="padding:6px 10px;">${((proj.endChainage-proj.startChainage)/1000).toFixed(2)} km</td></tr>
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;">Overall Progress</td><td style="padding:6px 10px;font-weight:700;color:#1B3B6F;">${c.overallProgress}%</td></tr>
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;">Workable Stretches</td><td style="padding:6px 10px;">${c.workableStretches.length}</td></tr>
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;">Active Hindrances</td><td style="padding:6px 10px;color:${wHind.length?'#dc2626':'#16a34a'};font-weight:600;">${wHind.length}</td></tr>
                    </table>
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;">WBS Phase Summary</h3>
                    <table style="width:100%;border-collapse:collapse;margin-bottom:16px;font-size:0.875rem;">
                        <tr style="background:#1B3B6F;color:white;"><th style="padding:8px;">WBS</th><th style="padding:8px;text-align:left;">Zone / Structure</th><th style="padding:8px;">Acts</th><th style="padding:8px;">Duration</th><th style="padding:8px;">Status</th></tr>
                        ${c.wbs.map(w=>`<tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:7px;text-align:center;font-weight:700;color:#1B3B6F;">${w.wbs}</td><td style="padding:7px;">${w.name.length>40?w.name.substring(0,40)+'‚Ä¶':w.name}</td><td style="padding:7px;text-align:center;">${w.activities.length}</td><td style="padding:7px;text-align:center;">${w.duration||0}d</td><td style="padding:7px;text-align:center;"><span style="background:${w.type==='blocked'?'#fee2e2':w.type==='structure'?'#dbeafe':'#dcfce7'};padding:2px 8px;border-radius:4px;font-size:0.78rem;font-weight:600;">${w.status||'-'}</span></td></tr>`).join('')}
                    </table>
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;">Critical Path (${critA.length} activities)</h3>
                    <table style="width:100%;border-collapse:collapse;font-size:0.875rem;">
                        <tr style="background:#1B3B6F;color:white;"><th style="padding:8px;text-align:left;">Activity</th><th style="padding:8px;">Dur</th><th style="padding:8px;text-align:left;">Resource</th></tr>
                        ${critA.slice(0,10).map(a=>`<tr style="border-bottom:1px solid #f1f5f9;"><td style="padding:7px;">üî¥ ${a.name}</td><td style="padding:7px;text-align:center;">${a.duration}d</td><td style="padding:7px;color:#64748b;">${a.resource||'‚Äî'}</td></tr>`).join('')}
                    </table>
                    ${wHind.length?`<h3 style="color:#dc2626;border-bottom:2px solid #dc2626;padding-bottom:6px;margin-top:16px;">Hindrances Requiring Action (${wHind.length})</h3><ul>${wHind.map(h=>`<li style="margin-bottom:6px;"><strong>${h.name}</strong> ‚Äî Ch ${fmtC(h.chainageStart)} ‚Üí ${fmtC(h.chainageEnd)} (${((h.chainageEnd-h.chainageStart)/1000).toFixed(1)} km)</li>`).join('')}</ul>`:'<p style="color:#16a34a;font-weight:600;margin-top:12px;">‚úÖ No active hindrances this week.</p>'}
                `;
            } else if (type === 'monthly') {
                title = 'Monthly Progress Report ‚Äî ' + today;
                const mActs = c.activities;
                const qtySummary = {};
                ['Soil Excavation','Embankment','GSB','WBM','DBM','BC'].forEach(k => { qtySummary[k] = 0; });
                mActs.forEach(a => {
                    const key = Object.keys(qtySummary).find(k => a.name && a.name.includes(k));
                    if (key) qtySummary[key] += (a.qty || 0);
                });
                const phases = [1,2,3].map(ph => {
                    const pa = mActs.filter(a=>a.phase===ph);
                    return { ph, count: pa.length, maxDur: pa.reduce((s,a)=>Math.max(s,a.duration||0),0) };
                });
                body = `
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;">Executive Summary</h3>
                    <table style="width:100%;border-collapse:collapse;margin-bottom:16px;font-size:0.875rem;">
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;width:38%;">Project</td><td style="padding:6px 10px;">${proj.name}</td></tr>
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;">Contract Value</td><td style="padding:6px 10px;">‚Çπ ${(parseFloat(proj.budget)||1356.90).toFixed(2)} Cr</td></tr>
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;">Length</td><td style="padding:6px 10px;">${((proj.endChainage-proj.startChainage)/1000).toFixed(2)} km</td></tr>
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;">Overall Progress</td><td style="padding:6px 10px;font-weight:700;color:#1B3B6F;">${c.overallProgress}%</td></tr>
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;">Total Activities</td><td style="padding:6px 10px;">${mActs.length} (${c.criticalActivities} critical)</td></tr>
                        <tr><td style="padding:6px 10px;background:#EBF0FA;font-weight:600;">Active Hindrances</td><td style="padding:6px 10px;color:${d.hindrances.filter(h=>h.status==='Pending').length?'#dc2626':'#16a34a'};font-weight:600;">${d.hindrances.filter(h=>h.status==='Pending').length}</td></tr>
                    </table>
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;">Cumulative Quantities</h3>
                    <table style="width:100%;border-collapse:collapse;margin-bottom:16px;font-size:0.875rem;">
                        <tr style="background:#1B3B6F;color:white;"><th style="padding:8px;text-align:left;">Work Type</th><th style="padding:8px;">Total Qty (Cum)</th></tr>
                        ${Object.entries(qtySummary).map(([k,v])=>`<tr style="border-bottom:1px solid #f1f5f9;"><td style="padding:7px;">${k}</td><td style="padding:7px;text-align:center;font-weight:700;">${v.toLocaleString()}</td></tr>`).join('')}
                    </table>
                    <h3 style="color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:8px;">Phase Progress</h3>
                    <table style="width:100%;border-collapse:collapse;font-size:0.875rem;">
                        <tr style="background:#1B3B6F;color:white;"><th style="padding:8px;">Phase</th><th style="padding:8px;">Activities</th><th style="padding:8px;">Max Duration</th></tr>
                        ${phases.map(p=>`<tr style="border-bottom:1px solid #f1f5f9;"><td style="padding:7px;text-align:center;font-weight:700;">Phase ${p.ph}</td><td style="padding:7px;text-align:center;">${p.count}</td><td style="padding:7px;text-align:center;">${p.maxDur}d</td></tr>`).join('')}
                    </table>
                `;
            } else if (type === 'cost' || type === 'resource') {
                title = (type==='cost' ? 'Cost Analysis' : 'Resource Utilization') + ' Report ‚Äî ' + today;
                body = `<p style="color:#64748b;padding:20px 0;">Detailed ${type} data requires actual progress entry per activity. Coming in V7.0 with site diary integration.</p>
                        <p>Current project budget: ‚Çπ ${(parseFloat(proj.budget)||1356.90).toFixed(2)} Cr ¬∑ ${(c.activities||[]).length} planned activities ¬∑ ${(KALYANTRA.data.resources&&KALYANTRA.data.resources.equipment||[]).length} equipment items</p>`;
            }

            // Show in modal overlay
            const modal = document.createElement('div');
            modal.id = 'reportModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:9000;display:flex;align-items:flex-start;justify-content:center;padding:40px 20px;box-sizing:border-box;overflow-y:auto;';
            modal.innerHTML = `
                <div style="background:white;border-radius:10px;max-width:900px;width:100%;box-shadow:0 25px 60px rgba(0,0,0,0.3);">
                    <div style="background:#1B3B6F;padding:20px 28px;border-radius:10px 10px 0 0;display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="color:#D4AF37;font-size:0.75rem;font-weight:600;letter-spacing:1px;text-transform:uppercase;">KALYANTRA Report</div>
                            <h2 style="margin:4px 0 0;color:white;font-size:1.125rem;">${title}</h2>
                        </div>
                        <div style="display:flex;gap:10px;">
                            <button onclick="window.print()" style="padding:8px 16px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:6px;font-weight:700;cursor:pointer;">üñ®Ô∏è Print</button>
                            <button onclick="document.getElementById('reportModal').remove()" style="padding:8px 16px;background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:6px;font-weight:600;cursor:pointer;">‚úï Close</button>
                        </div>
                    </div>
                    <div id="reportContent" style="padding:28px;font-family:Arial,sans-serif;font-size:0.875rem;line-height:1.6;">
                        ${body}
                    </div>
                </div>`;
            document.body.appendChild(modal);
            modal.addEventListener('click', e => { if(e.target===modal) modal.remove(); });
            console.log('üìä Report generated:', type);
        }

        // ================================================================
        // SPRINT 4 S4-02: KALYANTRA.save() / KALYANTRA.load() ‚Äî localStorage
        // ================================================================
        KALYANTRA.save = function() {
            supabaseSave(this.data).catch(e => console.warn('Save error:', e));
        };

        KALYANTRA.load = function() { return false; };

        KALYANTRA.loadFromSupabase = async function() {
            const data = await supabaseLoad();
            if (data) {
                // SMART MERGE: Don't overwrite hardcoded structures/tcs.rows from DB
                // DB is authoritative for: project fields, hindrances, milestones, calendar, progress
                // Hardcoded data is authoritative for: structures detail, tcs.rows detail
                ['activityProgress','boq','boqTab','calendar','resources','baseline','progress','scenarios'].forEach(key => {
                    if (data[key] !== undefined) this.data[key] = data[key];
                });
                // Constraints: restore from DB if present
                if (data.constraints) {
                    try {
                        const dbCon = typeof data.constraints === 'string'
                            ? JSON.parse(data.constraints) : data.constraints;
                        // Merge carefully ‚Äî keep defaults for missing keys
                        // Only restore if DB has actual user-defined data (not empty defaults)
                        if (dbCon.resourceGroups !== undefined && dbCon.resourceGroups.length > 0) {
                            this.data.constraints.resourceGroups = dbCon.resourceGroups;
                        }
                        if (dbCon.stretchOverrides !== undefined && Object.keys(dbCon.stretchOverrides).length > 0) {
                            this.data.constraints.stretchOverrides = dbCon.stretchOverrides;
                        }
                        if (dbCon.crewSeparation !== undefined) {
                            Object.assign(this.data.constraints.crewSeparation, dbCon.crewSeparation);
                        }
                        if (dbCon.cureLagOverrides !== undefined) {
                            this.data.constraints.cureLagOverrides = dbCon.cureLagOverrides;
                        }
                    } catch(e) { console.warn('Constraints parse error:', e); }
                }
                // Project: merge DB values into existing (don't replace the whole object)
                if (data.project) {
                    Object.assign(this.data.project, data.project);
                }
                // Hindrances: use DB version if it has real data, else keep hardcoded
                if (data.hindrances && data.hindrances.length > 0) {
                    this.data.hindrances = data.hindrances;
                }
                // Milestones: use DB version if available
                if (data.milestones && data.milestones.length > 0) {
                    this.data.milestones = data.milestones;
                }
                // Structures: only update progress_pct from DB, keep all other fields
                if (data.structures && data.structures.length > 0) {
                    data.structures.forEach(dbS => {
                        const local = this.data.structures.find(s =>
                            s.chainage === dbS.chainage || s.name === dbS.name);
                        if (local) local.progressPct = dbS.progressPct || 0;
                    });
                }
                // TCS: only update boq/layers from DB, keep tcs.rows hardcoded
                if (data.tcs) {
                    this.data.tcs.carriageWidth = data.tcs.carriageWidth || this.data.tcs.carriageWidth;
                    this.data.tcs.shoulderWidth = data.tcs.shoulderWidth || this.data.tcs.shoulderWidth;
                    if (data.tcs.layers && Object.keys(data.tcs.layers).length > 0) {
                        this.data.tcs.layers = data.tcs.layers;
                    }
                }
                this.refresh();
                // Re-render ALL active tabs after DB load completes
                const _aTab = document.querySelector('.sidebar-item.active');
                const _aIdx = _aTab ? parseInt(_aTab.getAttribute('data-tab')) : -1;
                setTimeout(() => {
                    if (_aIdx === 0  && typeof populateProjectForm    === 'function') populateProjectForm();
                    if (_aIdx === 1  && typeof renderTCSCards         === 'function') renderTCSCards();
                    if (_aIdx === 2  && typeof renderStructuresList   === 'function') renderStructuresList();
                    if (_aIdx === 3  && typeof renderHindranceTable   === 'function') renderHindranceTable();
                    if (_aIdx === 7  && KALYANTRA && KALYANTRA.render) {
                        KALYANTRA.render.wbsTable();
                        if (typeof updateWBSStatBar === 'function') updateWBSStatBar();
                    }
                    if (_aIdx === 8  && KALYANTRA && KALYANTRA.render) KALYANTRA.render.dashboard();
                    if (_aIdx === 5  && typeof initResourcesTab     === 'function') setTimeout(initResourcesTab, 50);
                    if (_aIdx === 9  && typeof renderProgressTab     === 'function') renderProgressTab();
                    if (_aIdx === 11 && typeof renderConstraintsTab  === 'function') renderConstraintsTab();
                    // V9 new tabs ‚Äî render regardless of active tab
                    if (_aIdx === 8  && typeof renderDashboard    === 'function') setTimeout(renderDashboard, 100);
                }, 80);
                if (typeof renderHolidayTable        === 'function') renderHolidayTable();
                // V9 tabs ‚Äî unconditional renders after ALL data loads
                if (typeof renderBaselineInfo   === 'function') setTimeout(renderBaselineInfo, 200);
                if (typeof computeAllAlerts     === 'function') setTimeout(computeAllAlerts, 250);
                if (typeof renderAlertsTab      === 'function') setTimeout(renderAlertsTab, 400);
                if (typeof initScenariosTab     === 'function') setTimeout(initScenariosTab, 300);
                if (typeof renderEarnedValueTab === 'function') setTimeout(renderEarnedValueTab, 450);
                if (typeof renderDashboard      === 'function') setTimeout(renderDashboard, 200);
                if (typeof renderWorkingDaysSelector  === 'function') renderWorkingDaysSelector();
                if (typeof renderMilestoneTracker     === 'function') renderMilestoneTracker();
                if (typeof renderHindranceTable       === 'function') renderHindranceTable();
                if (typeof renderTCSCards             === 'function') renderTCSCards();
                if (typeof renderStructuresList       === 'function') renderStructuresList();
                // Populate all form fields and refresh all rendered tabs
                setTimeout(() => {
                    if (typeof populateProjectForm === 'function') populateProjectForm();
                    if (typeof renderHindranceTable === 'function') renderHindranceTable();
                    if (typeof renderMilestoneTracker === 'function') renderMilestoneTracker();
                    if (KALYANTRA && KALYANTRA.render) {
                        KALYANTRA.render.dashboard();
                        KALYANTRA.render.wbsTable();
                    }
                    if (typeof updateWBSStatBar === 'function') updateWBSStatBar();
                }, 200);
                return true;
            } else {
                try {
                    const saved = localStorage.getItem('kalyantra_v67_data');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        // Clear stale localStorage if it has old demo data
                        const isStale = !parsed.project ||
                                        !parsed.project.name ||
                                        !parsed.project.name.includes('Package-I') ||
                                        (parsed.project.budget && parseFloat(parsed.project.budget) < 500);
                        if (isStale) {
                            localStorage.removeItem('kalyantra_v65_data');
                            console.log('üßπ Cleared stale localStorage data');
                        } else {
                            ['project','tcs','structures','hindrances','calendar',
                             'resources','milestones','activityProgress','boq','boqTab'].forEach(key => {
                                if (parsed[key] !== undefined) this.data[key] = parsed[key];
                            });
                            this.refresh();
                            showToast('‚ö†Ô∏è Offline mode ‚Äî using local storage', 'info');
                        }
                    }
                } catch(e) {}
                return false;
            }
        };

        KALYANTRA.clearSaved = function() {
            localStorage.removeItem('kalyantra_v65_data');
            showToast('üóëÔ∏è Saved data cleared ‚Äî reload to reset', 'warning');
        };

        // ================================================================
        // SPRINT 4 S4-04: Sidebar divider CSS enhancement (Gold accent)
        // ================================================================
        // (dividers already present in HTML; CSS upgrade done via style injection)
        (function upgradeSidebarDividers() {
            const style = document.createElement('style');
            style.textContent = `
                .sidebar-divider {
                    height: 1px;
                    background: rgba(212,175,55,0.35) !important;
                    margin: 6px 10px;
                }
                .sidebar-section-label {
                    font-size: 0.65rem;
                    text-transform: uppercase;
                    letter-spacing: 1.5px;
                    color: rgba(212,175,55,0.55) !important;
                    padding: 8px 0 4px 16px;
                    font-weight: 600;
                }
                /* U-13: prevent sticky footer overlap on resource subtabs */
                .resource-subtab { padding-bottom: 72px !important; }
                /* FIX-UA11: V7.0 placeholder buttons look disabled */
                .btn-v7 { opacity: 0.55 !important; cursor: not-allowed !important; }
                .btn-v7::before { content: 'üîí '; font-style: normal; }
                @media print {
                    .sidebar, .toolbar, nav, .sticky, [style*="sticky"] { display: none !important; }
                    #reportContent { padding: 0 !important; }
                    body { margin: 0; }
                }
            `;
            document.head.appendChild(style);
        })();

        // ================================================================
        // SPRINT 2: S2-01 ‚Äî saveCalendar()
        // ================================================================
        // FIX-GAP04: Working Days toggle
        function toggleWorkingDay(dayNum, isChecked, labelEl) {
            if (!KALYANTRA.data.calendar.workingDays) KALYANTRA.data.calendar.workingDays = [1,2,3,4,5,6];
            if (isChecked) { if (!KALYANTRA.data.calendar.workingDays.includes(dayNum)) KALYANTRA.data.calendar.workingDays.push(dayNum); }
            else { KALYANTRA.data.calendar.workingDays = KALYANTRA.data.calendar.workingDays.filter(d => d !== dayNum); }
            KALYANTRA.data.calendar.workingDays.sort();
            if (labelEl) {
                labelEl.style.borderColor = isChecked ? '#1B3B6F' : '#e2e8f0';
                labelEl.style.background  = isChecked ? '#EBF0FA' : 'white';
                labelEl.style.color       = isChecked ? '#1B3B6F' : '#64748b';
            }
            KALYANTRA.save(); KALYANTRA.refresh();
            showToast('üìÖ Working days: ' + KALYANTRA.data.calendar.workingDays.length + ' days/week', 'success');
        }

        function renderWorkingDaysSelector() {
            const el = document.getElementById('workingDaysSelector');
            if (!el) return;
            const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
            const wds  = KALYANTRA.data.calendar.workingDays || [1,2,3,4,5,6];
            el.innerHTML = days.map((d, i) => {
                const dn = i === 6 ? 0 : i + 1;
                const on = wds.includes(dn);
                return `<label style="display:flex;align-items:center;gap:4px;cursor:pointer;padding:5px 10px;border:1px solid ${on?'#1B3B6F':'#e2e8f0'};border-radius:6px;background:${on?'#EBF0FA':'white'};font-size:0.85rem;font-weight:600;color:${on?'#1B3B6F':'#64748b'};">
                    <input type="checkbox" ${on?'checked':''} onchange="toggleWorkingDay(${dn},this.checked,this.parentElement)" style="accent-color:#1B3B6F;"> ${d}</label>`;
            }).join('');
        }

        function saveCalendar() {
            const hours  = parseFloat(document.getElementById('hoursPerDay')  && document.getElementById('hoursPerDay').value)  || 8;
            const mStart = document.getElementById('monsoonStart') && document.getElementById('monsoonStart').value || '2026-07-15';
            const mEnd   = document.getElementById('monsoonEnd')   && document.getElementById('monsoonEnd').value   || '2026-08-31';
            KALYANTRA.data.calendar.hoursPerDay  = hours;
            KALYANTRA.data.calendar.monsoonStart = mStart;
            KALYANTRA.data.calendar.monsoonEnd   = mEnd;
            KALYANTRA.refresh();
            console.log('üìÖ Calendar saved:', KALYANTRA.data.calendar);
            showToast('‚úÖ Calendar saved ‚Äî ' + hours + 'h/day, monsoon ' + mStart + ' ‚Üí ' + mEnd, 'success');
        }
        
        // GAP-04: Save working days from checkboxes
        function saveWorkingDays() {
            const dayIds = ['wdSun','wdMon','wdTue','wdWed','wdThu','wdFri','wdSat'];
            const days = [];
            dayIds.forEach((id, idx) => {
                const el = document.getElementById(id);
                if (el && el.checked) days.push(idx);
            });
            if (days.length === 0) {
                showToast('‚ö†Ô∏è At least 1 working day required', 'warning');
                return;
            }
            KALYANTRA.data.calendar.workingDays = days;
            KALYANTRA.save();
            KALYANTRA.refresh();
            const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            const label = days.map(d => dayNames[d]).join(', ');
            const summary = document.getElementById('workingDaySummary');
            if (summary) summary.textContent = days.length + ' days/week (' + label + ')';
            showToast('‚úÖ Working days saved: ' + days.length + 'd/week', 'success');
        }

        // ================================================================
        // SPRINT 2: S2-04 ‚Äî saveTCSEdit() + saveTCSComponents()
        // ================================================================
        // U-04: Holiday management functions
        const HOLIDAY_LABELS = {
            '2026-01-26': 'Republic Day',
            '2026-08-15': 'Independence Day',
            '2026-10-02': 'Gandhi Jayanti'
        };

        function renderHolidayTable() {
            const tbody = document.getElementById('holidayTableBody');
            if (!tbody) return;
            const holidays = KALYANTRA.data.calendar.holidays || [];
            if (!holidays.length) {
                tbody.innerHTML = '<tr><td colspan="3" style="padding:12px;text-align:center;color:#94a3b8;font-style:italic;">No holidays added. Click + Add Holiday.</td></tr>';
                return;
            }
            tbody.innerHTML = holidays.map((h, i) => {
                const label = HOLIDAY_LABELS[h] || 'Project Shutdown';
                // LA-08/UA-04 FIX: Show editable date input (not just text) so user can change dates
                return `<tr style="border-bottom:1px solid #f1f5f9;">
                    <td style="padding:8px 12px;">
                        <input type="date" value="${h}" style="border:1px solid #e2e8f0;border-radius:4px;padding:4px 8px;font-size:0.85rem;color:#1B3B6F;font-weight:600;"
                            onchange="updateHolidayDate(${i}, this.value)" />
                    </td>
                    <td style="padding:8px 12px;">
                        <input type="text" value="${label}" style="border:1px solid #e2e8f0;border-radius:4px;padding:4px 8px;width:100%;font-size:0.85rem;"
                            onchange="updateHolidayLabel(${i}, this.value)" />
                    </td>
                    <td style="padding:8px 12px;text-align:center;">
                        <button onclick="deleteHoliday(${i})" style="background:#fee2e2;color:#dc2626;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:0.8rem;font-weight:600;">‚úï</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function addHolidayRow() {
            const today = new Date().toISOString().split('T')[0];
            if (!KALYANTRA.data.calendar.holidays.includes(today)) {
                KALYANTRA.data.calendar.holidays.push(today);
            }
            renderHolidayTable();
            KALYANTRA.save();
            showToast('üìÖ Holiday added ‚Äî update date and description', 'info');
        }

        function deleteHoliday(index) {
            KALYANTRA.data.calendar.holidays.splice(index, 1);
            renderHolidayTable();
            KALYANTRA.save();
            KALYANTRA.refresh();
            showToast('üóëÔ∏è Holiday removed', 'success');
        }

        function updateHolidayDate(index, newDate) {
            // LA-08 FIX: Allow user to change holiday date
            if (!newDate) return;
            KALYANTRA.data.calendar.holidays[index] = newDate;
            KALYANTRA.save();
            KALYANTRA.refresh();
            renderHolidayTable();
            showToast('üìÖ Holiday date updated to ' + newDate, 'success');
        }

        function updateHolidayLabel(index, newLabel) {
            // Labels are stored in HOLIDAY_LABELS lookup ‚Äî update the date input instead
            // For simplicity: just save; label is transient per-session
            KALYANTRA.save();
        }


        function saveTCSEdit(field, value) {
            const num = parseFloat(value);
            if (isNaN(num)) return;
            if (field === 'carriageWidth') {
                KALYANTRA.data.tcs.carriageWidth = num;
                showToast('üìê Carriage width: ' + num + 'm', 'info');
            } else if (field === 'shoulderWidth') {
                KALYANTRA.data.tcs.shoulderWidth = num;
                showToast('üìê Shoulder width: ' + num + 'm', 'info');
            } else if (KALYANTRA.data.tcs.layers[field]) {
                KALYANTRA.data.tcs.layers[field].thickness = num;
                showToast('üìê ' + field + ' thickness: ' + num + 'mm ‚Äî recalculating...', 'info');
            }
            // Recalculate WBS quantities
            KALYANTRA.refresh();
            // Re-render WBS if visible
            const wbsPanel = document.getElementById('wbsBody');
            if (wbsPanel) {
                KALYANTRA.render.wbsTable();
                showToast('‚úÖ TCS updated ‚Äî WBS quantities recalculated', 'success');
            }
            console.log('üìê TCS data:', JSON.stringify(KALYANTRA.data.tcs));
        }
        
        function saveTCSComponents() {
            // Save current TCS form state and update KALYANTRA
            ['BC', 'DBM', 'WBM', 'GSB'].forEach(layer => {
                const el = document.getElementById('tcs' + layer);
                if (el && el.value) KALYANTRA.data.tcs.layers[layer].thickness = parseFloat(el.value) || KALYANTRA.data.tcs.layers[layer].thickness;
            });
            const cw = document.getElementById('tcsCarriageWidth');
            const sw = document.getElementById('tcsShoulderWidth');
            if (cw && cw.value) KALYANTRA.data.tcs.carriageWidth = parseFloat(cw.value);
            if (sw && sw.value) KALYANTRA.data.tcs.shoulderWidth = parseFloat(sw.value);
            KALYANTRA.refresh();
            showToast('‚úÖ TCS components & geometry saved to KALYANTRA', 'success');
                    KALYANTRA.save(); KALYANTRA.refresh();
            showToast('‚úÖ TCS & milestones saved ‚Äî WBS recalculated', 'success');
        }
        
        // ================================================================
        // SPRINT 2: S2-05 ‚Äî readMilestones()
        // ================================================================
        function readMilestones() {
            const rows = document.querySelectorAll('#physicalMilestones tr');
            const milestones = [];
            rows.forEach((row, i) => {
                const inputs = row.querySelectorAll('input');
                if (inputs.length >= 4) {
                    milestones.push({
                        id:         i + 1,
                        targetDate: inputs[0].value || '',
                        completion: parseFloat(inputs[1].value) || 0,
                        duration:   parseFloat(inputs[2].value) || 0,
                        description: inputs[3].value || 'Milestone ' + (i + 1)
                    });
                }
            });
            KALYANTRA.data.milestones = milestones;
            console.log('üìã Milestones saved:', milestones);
        }
        
        // ================================================================
        // SPRINT 2: S2-06 ‚Äî validateAndProceed()
        // ================================================================
        function validateAndProceed() {
            updateProjectData();
            const errors = [];
            
            // Required field checks
            const nameEl = document.getElementById('projectName');
            const endKmEl = document.getElementById('endKm');
            const dateEl  = document.getElementById('appointedDate');
            
            if (nameEl && !nameEl.value.trim()) {
                nameEl.style.borderColor = '#dc2626';
                errors.push('Project Name');
            } else if (nameEl) nameEl.style.borderColor = '';
            
            if (endKmEl && (!endKmEl.value || parseFloat(endKmEl.value) <= 0)) {
                endKmEl.style.borderColor = '#dc2626';
                errors.push('End Chainage');
            } else if (endKmEl) endKmEl.style.borderColor = '';
            
            if (dateEl && !dateEl.value) {
                dateEl.style.borderColor = '#dc2626';
                errors.push('Appointed Date');
            } else if (dateEl) dateEl.style.borderColor = '';
            
            if (errors.length > 0) {
                showToast('‚ö†Ô∏è Required: ' + errors.join(', '), 'warning');
                // Scroll to first error
                const firstError = document.querySelector('input[style*="dc2626"]');
                if (firstError) firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            
            showToast('‚úÖ Project data saved ‚Äî proceeding to TCS', 'success');
            switchMainTab(1);
        }
        
        // ================================================================
        // SPRINT 2: Extend updateProjectData to read all Tab 1 fields
        // ================================================================
        
        function updateProjectData() {
            KALYANTRA.syncFromUI.project();
            // Read industry type and project mode
            const industryEl = document.getElementById('industryType');
            const modeEl     = document.getElementById('projectMode');
            if (industryEl) KALYANTRA.data.project.industryType = industryEl.value;
            if (modeEl)     KALYANTRA.data.project.projectMode  = modeEl.value;
            // Read milestones
            if (typeof readMilestones === 'function') readMilestones();
            console.log('üìã Project updated:', KALYANTRA.data.project.name, '/', KALYANTRA.data.project.industryType, '/', KALYANTRA.data.project.projectMode);
            const _pn = KALYANTRA.data.project.name; const _hn = document.getElementById('headerProjectName'); if(_hn) _hn.textContent = '‚Äî '+_pn; const _hn2 = document.getElementById('headerProjectName2'); if(_hn2) _hn2.textContent = _pn;
            // If WBS is visible, re-render
            KALYANTRA.save(); // FIX: persist project data edits
            const wbsPanel = document.getElementById('tab8');
            if (wbsPanel && wbsPanel.classList.contains('active')) {
                KALYANTRA.render.wbsTable();
            }
        }
        
        // Initialize on page load
        
        // ‚îÄ‚îÄ POPULATE FORM FROM DATA (called after Supabase load) ‚îÄ‚îÄ
        function populateProjectForm() {
            const p   = KALYANTRA.data.project || {};
            const setV = (id, val) => { const el = document.getElementById(id); if (el && val !== undefined && val !== null) el.value = val; };
            const setS = (id, val) => { const el = document.getElementById(id); if (el && val) { // set select
                for (let i=0; i<el.options.length; i++) {
                    if (el.options[i].value.toLowerCase() === String(val).toLowerCase()) { el.selectedIndex = i; break; }
                }
            }};

            // A. Project Information
            setV('projectName', p.name);
            // Normalize industryType DB value to option values
            const _itRaw = (p.industryType || 'roads').toLowerCase();
            const _itNorm = _itRaw === 'roads' ? 'roads' :
                            _itRaw.includes('road') ? 'roads' :
                            _itRaw.includes('metro') ? 'metro' :
                            _itRaw.includes('urban') ? 'urban' :
                            _itRaw.includes('water') ? 'water' : 'roads';
            setS('industryType', _itNorm);
            setS('projectMode',  p.projectMode  || 'HAM');
            setV('projectCost',  p.budget || 1356.90);

            // Chainage ‚Äî stored as metres, split into km+m
            const sc = (p.startChainage !== undefined ? p.startChainage : 0);
            const ec = (p.endChainage   !== undefined ? p.endChainage   : 42000);
            setV('startKm', Math.floor(sc / 1000));
            setV('startM',  sc % 1000);
            setV('endKm',   Math.floor(ec / 1000));
            setV('endM',    ec % 1000);

            // B. Contractual Dates ‚Äî use known values as fallbacks
            const loaVal  = p.loaDate        || p.loa_date        || '2024-12-18';
            const agrVal  = p.agreementDate  || p.agreement_date  || '2025-01-02';
            const aptVal  = p.appointedDate  || p.appointed_date  || p.startDate || '2025-02-01';
            const scdVal  = p.endDate || '2027-02-01';
            setV('loaDate',       loaVal);
            setV('agreementDate', agrVal);
            setV('appointedDate', aptVal);
            setV('completionDate', scdVal);
            // Duration in months: 730 days = 24 months
            const durDays = p.duration || 730;
            setV('duration', Math.round(durDays / 30));

            // Trigger SCD auto-calculation
            const aptEl = document.getElementById('appointedDate');
            if (aptEl) aptEl.dispatchEvent(new Event('change'));

            // Update header project name
            const hn = document.getElementById('headerProjectName');
            if (hn) hn.textContent = p.name || 'Unnamed Project';

            // Trigger length calculation
            const endKmEl = document.getElementById('endKm');
            if (endKmEl) endKmEl.dispatchEvent(new Event('input'));

            console.log('‚úÖ Project form populated from Supabase data:', p.name);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // ‚îÄ‚îÄ PHASE 1: Instant render from hardcoded defaults ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            KALYANTRA.init();
            initSidebar();

            // Populate ALL form fields immediately with defaults (no DB wait)
            populateProjectForm();
            if (typeof renderTCSCards      === 'function') renderTCSCards();
            if (typeof renderStructuresList === 'function') renderStructuresList();
            if (typeof renderHindranceTable === 'function') renderHindranceTable();
            if (typeof renderMilestoneTracker === 'function') renderMilestoneTracker();

            // ‚îÄ‚îÄ PHASE 2: Load from Supabase in background (non-blocking) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            setTimeout(function() {
                // 8-second timeout on DB connection badge
                const _badgeTimeout = setTimeout(function() {
                    const lbl = document.getElementById('supaStatusLabel');
                    const dot = document.getElementById('supaStatusDot');
                    if (lbl && lbl.textContent.includes('Connecting')) {
                        lbl.textContent = '‚ö†Ô∏è DB Timeout';
                        lbl.style.color = '#d97706';
                        if (dot) { dot.style.background='#d97706'; dot.style.boxShadow='0 0 6px #d97706'; }
                    }
                }, 8000);
                KALYANTRA.loadFromSupabase().then(function(dbLoaded) {
                    clearTimeout(_badgeTimeout);
                    if (dbLoaded) {
                        // DB data loaded - refresh all tabs with saved data
                        KALYANTRA.render.wbsTable();
                        KALYANTRA.render.dashboard();
                        updateWBSStatBar();
                        populateProjectForm();
                        if (typeof renderMilestoneTracker   === 'function') renderMilestoneTracker();
                        if (typeof renderHolidayTable       === 'function') renderHolidayTable();
                        if (typeof renderWorkingDaysSelector === 'function') renderWorkingDaysSelector();
                        if (typeof renderHindranceTable     === 'function') renderHindranceTable();
                        if (typeof renderTCSCards           === 'function') renderTCSCards();
                        if (typeof renderStructuresList     === 'function') renderStructuresList();
                    }
                    // No seeding on timeout/failure - use hardcoded defaults (already shown)
                }).catch(function(err) {
                    console.warn('DB load error:', err);
                    const lbl = document.getElementById('supaStatusLabel');
                    if (lbl) { lbl.textContent = '‚ö†Ô∏è DB Error'; lbl.style.color = '#dc2626'; }
                });
            }, 200);
        });
        
        
        // Update header project name on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const pname = KALYANTRA && KALYANTRA.data && KALYANTRA.data.project
                    ? KALYANTRA.data.project.name : null;
                const hn = document.getElementById('headerProjectName');
                if (hn && pname) hn.textContent = '‚Äî ' + pname;
            }, 800);
        });
console.log('‚úÖ KALYANTRA V7.5 ‚Äî Constraints tab + 14 audit fixes');


    </script>

    <script>
        // ===== SIDEBAR SYSTEM =====
        const TAB_LABELS = [
            'üìã Project Basics',
            'üìê TCS & Sections',
            'üåâ Structures',
            '‚ö†Ô∏è Hindrances',
            'üìÖ Calendar',
            'üì¶ Resources',
            'üí∞ BOQ',
            'üìä Activity Grid',
            'üè† Executive Dashboard',
            'üìç Progress Tracking',
            'üìÑ Reports & Analytics',
            'üîó Constraints',
            'üì∏ Baseline',
            'üéØ Scenarios',
            'üîî Alerts',
        ];

        function sidebarSwitchTab(index, clickedItem) {
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
            if (clickedItem) clickedItem.classList.add('active');

            const headerLabel = document.getElementById('headerTabLabel');
            if (headerLabel) headerLabel.textContent = TAB_LABELS[index] || '';

            const pname = KALYANTRA && KALYANTRA.data && KALYANTRA.data.project
                ? KALYANTRA.data.project.name : null;
            const hn = document.getElementById('headerProjectName');
            if (hn && pname) hn.textContent = '‚Äî ' + pname;

            // BOQ tab (index 6) ‚Äî handled separately, no switchMainTab
            if (index === 6) {
                document.querySelectorAll('.tab-panel').forEach(p => {
                    p.classList.remove('active');
                    if (p.id !== 'tab7boq') p.style.removeProperty('display');
                });
                const boqPanel = document.getElementById('tab7boq');
                if (boqPanel) {
                    boqPanel.style.display = 'block'; // use .active class for positioning
                    boqPanel.classList.add('active');
                }
                setTimeout(() => { if (typeof renderBOQTab === 'function') renderBOQTab(); }, 100);
                return;
            }

            // Hide BOQ panel for all other tabs
            const boqP = document.getElementById('tab7boq');
            if (boqP) { boqP.style.display = 'none'; boqP.classList.remove('active'); }

            switchMainTab(index);

            if (index === 1) {
                setTimeout(() => {
                    const firstRow = document.querySelector('#tcsTable tbody tr') || document.querySelector('#tcsTable tr');
                    if (firstRow && typeof selectTCS === 'function') selectTCS(firstRow, 0);
                }, 150);
            }
            if (index === 0) {
                setTimeout(() => {
                    if (typeof populateProjectForm === 'function') populateProjectForm();
                    if (typeof renderMilestoneTracker === 'function') renderMilestoneTracker();
                }, 150);
            }
            if (index === 3) {
                setTimeout(() => { if (typeof renderHindranceTable === 'function') renderHindranceTable(); }, 150);
            }
            if (index === 4) {
                setTimeout(() => {
                    if (typeof renderHolidayTable === 'function') renderHolidayTable();
                    if (typeof renderWorkingDaysSelector === 'function') renderWorkingDaysSelector();
                }, 150);
            }
            if (index === 7) {
                setTimeout(() => {
                    if (KALYANTRA && KALYANTRA.render) {
                        KALYANTRA.refresh();
                        KALYANTRA.render.wbsTable();
                        if (typeof updateWBSStatBar === 'function') updateWBSStatBar();
                    }
                }, 150);
            }
            if (index === 8) {
                setTimeout(() => { if (KALYANTRA && KALYANTRA.render) KALYANTRA.render.dashboard(); }, 120);
            }
            if (index === 5) {
                setTimeout(() => { if (typeof switchResourceTab === 'function') switchResourceTab(0); }, 150);
            }
            if (index === 9) {
                setTimeout(() => { if (typeof renderProgressTab === 'function') renderProgressTab(); }, 150);
            }
            if (index === 10) {
                setTimeout(() => { if (typeof renderReportsTab === 'function') renderReportsTab(); }, 150);
            }
            if (index === 11) {
                setTimeout(() => { if (typeof renderConstraintsTab === 'function') renderConstraintsTab(); }, 150);
            }
            if (index === 12) {
                setTimeout(() => { if (typeof renderBaselineInfo === 'function') renderBaselineInfo(); }, 150);
            }
            if (index === 13) {
                setTimeout(() => { if (typeof initScenariosTab === 'function') initScenariosTab(); }, 150);
            }
            if (index === 14) {
                setTimeout(() => {
                    if (typeof computeAllAlerts === 'function') computeAllAlerts();
                    setTimeout(() => { if (typeof renderAlertsTab === 'function') renderAlertsTab(); }, 120);
                }, 100);
            }
            if (index === 15) {
                setTimeout(() => { if (typeof renderEarnedValueTab === 'function') renderEarnedValueTab(); }, 150);
            }
        }

        // ‚îÄ‚îÄ Auto-render triggers for Tab7 sub-views (U-02, U-14, U-15) ‚îÄ‚îÄ
        // FIX: use let so re-init doesn't crash on re-declaration
        if (typeof switchTab7Child === 'function' && !switchTab7Child._wrapped) {
        const _origSwitchTab7Child = switchTab7Child;
        switchTab7Child = function(index) {
            _origSwitchTab7Child(index);
            if (index === 1) setTimeout(() => { if (typeof renderActivitiesTable === 'function') renderActivitiesTable(); }, 100);
            if (index === 2) setTimeout(() => { if (typeof renderGantt === 'function') renderGantt(); }, 100);
            if (index === 3) setTimeout(() => { if (typeof initializeLSM === 'function') initializeLSM(); }, 100);
        };
        switchTab7Child._wrapped = true;
        } // end wrapper guard

        function initSidebar() {
            const sidebar = document.getElementById('mainSidebar');
            const toggle  = document.getElementById('sidebarToggle');
            if (!sidebar || !toggle) return;

            // Default to EXPANDED on first load
            const savedState = localStorage.getItem('kalyantraSidebarExpanded');
            if (savedState === null || savedState === 'true') {
                sidebar.classList.add('expanded');
            } else {
                sidebar.classList.remove('expanded');
            }

            // Set CSS variables for tab panel positioning
            const _updateSidebarVar = () => {
                const w = sidebar.classList.contains('expanded') ? '220px' : '60px';
                document.documentElement.style.setProperty('--sidebar-w', w);
            };
            _updateSidebarVar(); // Set on load
            // Measure actual header height and set CSS variable
            const _hdr = document.querySelector('.main-header');
            if (_hdr) {
                const _hh = _hdr.getBoundingClientRect().height;
                document.documentElement.style.setProperty('--header-h', _hh + 'px');
            }

            // Toggle on click
            toggle.addEventListener('click', () => {
                sidebar.classList.toggle('expanded');
                localStorage.setItem('kalyantraSidebarExpanded', sidebar.classList.contains('expanded'));
                _updateSidebarVar();
            });
        }
    </script>

    <script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KALYANTRA ENGINE V3 ‚Äî TCS + STRUCTURES + PER-SPAN + WBS AUTO-GENERATION
// Core idea: Structure definition ‚Üí Freeze ‚Üí WBS + Activities auto-populate
// Duration = BOQ Qty √∑ Productivity (user can override)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ TCS: 10 PM-RELEVANT ELEMENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TCS_ELEMENTS = [
    {group:'CARRIAGEWAY', items:[
        {id:'MAIN_CW',   name:'Main Carriageway',         sizeLabel:'Width/side (m)', defaultSize:'7.0',    unit:'m'},
        {id:'SERVICE',   name:'Service Road',              sizeLabel:'Width (m)',      defaultSize:'3.5',    unit:'m'},
        {id:'MED_RAISED',name:'Median',                    sizeLabel:'Width (m)',      defaultSize:'4.5',    unit:'m'},
        {id:'SHL_PAVED', name:'Paved Shoulder',            sizeLabel:'Width (m)',      defaultSize:'1.5',    unit:'m'},
        {id:'SHL_EARTH', name:'Earthen Shoulder',          sizeLabel:'Width (m)',      defaultSize:'1.5',    unit:'m'},
    ]},
    {group:'PROTECTION & DRAINAGE', items:[
        {id:'CB_WBEAM',  name:'Crash Barrier',             sizeLabel:'Type',           defaultSize:'W-Beam', unit:''},
        {id:'KERB',      name:'Kerb & Footpath',           sizeLabel:'Width (m)',      defaultSize:'1.5',    unit:'m'},
        {id:'DRN_LINED', name:'Roadside Drain',            sizeLabel:'Size (mm)',      defaultSize:'600√ó450',unit:'mm'},
    ]},
    {group:'SLOPE & MISC', items:[
        {id:'RET_WALL',  name:'Retaining / RE Wall',       sizeLabel:'Avg Height (m)', defaultSize:'4.0',    unit:'m'},
        {id:'MARKINGS',  name:'Road Markings & Furniture', sizeLabel:'Coats',          defaultSize:'2',      unit:''},
    ]},
];

const TCS_TEMPLATES = {
    '4-Lane-NH':{elements:['MAIN_CW','MED_RAISED','SHL_PAVED','SHL_EARTH','CB_WBEAM','DRN_LINED','MARKINGS'],sizes:{MAIN_CW:'7.0',MED_RAISED:'4.5',SHL_PAVED:'1.5',SHL_EARTH:'1.0'}},
    '2-Lane-NH':{elements:['MAIN_CW','SHL_PAVED','SHL_EARTH','DRN_LINED','MARKINGS'],sizes:{MAIN_CW:'3.5',SHL_PAVED:'1.5',SHL_EARTH:'0.5'}},
    '6-Lane-Expr':{elements:['MAIN_CW','MED_RAISED','SHL_PAVED','SHL_EARTH','CB_WBEAM','DRN_LINED','MARKINGS'],sizes:{MAIN_CW:'10.5',MED_RAISED:'12.0',SHL_PAVED:'2.5',SHL_EARTH:'1.5'}},
    '4-Lane-Urban':{elements:['MAIN_CW','SERVICE','MED_RAISED','KERB','DRN_LINED','MARKINGS'],sizes:{MAIN_CW:'7.0',MED_RAISED:'3.0',SERVICE:'3.5'}},
    '2-Lane-MDR':{elements:['MAIN_CW','SHL_EARTH','DRN_LINED','MARKINGS'],sizes:{MAIN_CW:'3.0',SHL_EARTH:'1.0'}},
};

// ‚îÄ‚îÄ STRUCTURE REFERENCE DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STRUCT_TYPES=[
    {value:'box_culvert',  label:'Box Culvert (BC)'},
    {value:'pipe_culvert', label:'Pipe Culvert (PC)'},
    {value:'slab_culvert', label:'Slab Culvert (SC)'},
    {value:'vented_causy', label:'Vented Causeway'},
    {value:'mnb',          label:'Minor Bridge (MNB)'},
    {value:'mjb',          label:'Major Bridge (MJB)'},
    {value:'rob',          label:'Road Over Bridge (ROB)'},
    {value:'rub',          label:'Road Under Bridge (RUB)'},
    {value:'vup',          label:'Vehicular Underpass (VUP)'},
    {value:'pup',          label:'Pedestrian Underpass (PUP)'},
    {value:'flyover',      label:'Flyover / Grade Separator'},
    {value:'ret_wall',     label:'Retaining / RE Wall'},
    {value:'noise_barrier',label:'Noise Barrier'},
    {value:'other',        label:'Other Structure'},
];
const STRUCT_FOUNDATIONS=[
    'Open Foundation (PCC/RCC)',
    'Pile Foundation (Bored Cast-in-situ)',
    'Pile Foundation (Driven Precast)',
    'Well Foundation',
    'Raft Foundation',
    'Spread Footing',
    'No Foundation (Culvert/Slab)',
];
const STRUCT_SUPERSTRUCTURES=[
    'PSC Girder (T-Beam / Box)',
    'RCC T-Beam Girder (In-situ)',
    'Steel Composite Girder',
    'Solid Slab (RCC In-situ)',
    'Hollow Slab (RCC)',
    'Box Girder (RCC/PSC)',
    'Precast Plank / Deck Slab',
    'Arch (Masonry/RCC)',
    'No Superstructure (Culvert)',
];
const SUPPORT_TYPES=[
    {value:'abutment', label:'Abutment'},
    {value:'pier',     label:'Pier'},
    {value:'wing',     label:'Wing Wall'},
    {value:'return',   label:'Return Wall'},
];

// ‚îÄ‚îÄ WBS ACTIVITY TEMPLATES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Each support generates activities based on its foundation + superstructure
// Activities are linked to BOQ presets for duration calculation
const FOUNDATION_WBS = {
    'Open Foundation (PCC/RCC)': [
        {code:'EXC', name:'Excavation ‚Äî {label}',             unit:'Cum', boqPreset:'excavation', defaultDays:8,  depCode:null,    lag:0},
        {code:'PCC', name:'PCC Levelling Course ‚Äî {label}',   unit:'Cum', boqPreset:'pcc',        defaultDays:2,  depCode:'EXC',   lag:0},
        {code:'FND', name:'Foundation RCC ‚Äî {label}',         unit:'Cum', boqPreset:'foundation', defaultDays:10, depCode:'PCC',   lag:1},
        {code:'BTW', name:'Backfill & Compaction ‚Äî {label}',  unit:'Cum', boqPreset:null,          defaultDays:3,  depCode:'FND',   lag:3},
    ],
    'Pile Foundation (Bored Cast-in-situ)': [
        {code:'PIL-MOB', name:'Piling Rig Mobilization',       unit:'LS',  boqPreset:null,          defaultDays:3,  depCode:null,    lag:0,  sharedAcrossSupports:true},
        {code:'PIL-BOR', name:'Pile Boring & Casting ‚Äî {label}',unit:'Nos', boqPreset:'piling',    defaultDays:20, depCode:'PIL-MOB',lag:0},
        {code:'PIL-CAP', name:'Pile Cap & Tie Beam ‚Äî {label}', unit:'Cum', boqPreset:'pile_cap',   defaultDays:12, depCode:'PIL-BOR',lag:3},
    ],
    'Pile Foundation (Driven Precast)': [
        {code:'PIL-MOB', name:'Pile Driving Equipment Mobilization', unit:'LS', boqPreset:null, defaultDays:3, depCode:null, lag:0, sharedAcrossSupports:true},
        {code:'PIL-DRV', name:'Pile Driving ‚Äî {label}',         unit:'Nos', boqPreset:'piling',    defaultDays:15, depCode:'PIL-MOB',lag:0},
        {code:'PIL-CAP', name:'Pile Cap & Tie Beam ‚Äî {label}',  unit:'Cum', boqPreset:'pile_cap',  defaultDays:12, depCode:'PIL-DRV',lag:3},
    ],
    'Well Foundation': [
        {code:'WEL-STN', name:'Well Steining ‚Äî {label}',        unit:'Cum', boqPreset:'well',         defaultDays:30, depCode:null,     lag:0},
        {code:'WEL-SNK', name:'Well Sinking ‚Äî {label}',         unit:'M',   boqPreset:'well_sinking', defaultDays:45, depCode:'WEL-STN',lag:0, concurrent:true},
        {code:'WEL-PLG', name:'Bottom Plug & Sand Filling ‚Äî {label}', unit:'Cum', boqPreset:null,  defaultDays:5,  depCode:'WEL-SNK',lag:0},
        {code:'WEL-CAP', name:'Well Cap ‚Äî {label}',             unit:'Cum', boqPreset:'well_cap',     defaultDays:10, depCode:'WEL-PLG',lag:3},
    ],
    'Raft Foundation': [
        {code:'EXC', name:'Excavation ‚Äî {label}',               unit:'Cum', boqPreset:'excavation', defaultDays:10, depCode:null,    lag:0},
        {code:'RAF', name:'Raft Foundation RCC ‚Äî {label}',       unit:'Cum', boqPreset:'foundation', defaultDays:15, depCode:'EXC',   lag:1},
    ],
    'No Foundation (Culvert/Slab)': [
        {code:'EXC', name:'Excavation & Bed Preparation',        unit:'Cum', boqPreset:'excavation', defaultDays:5,  depCode:null,    lag:0},
    ],
};

const SUBSTRUCTURE_WBS = {
    'abutment': [
        {code:'ABT', name:'Abutment Wall & Wing Walls ‚Äî {label}', unit:'Cum', boqPreset:'substructure', defaultDays:25, depCode:'_FND', lag:2},
        {code:'BRG', name:'Bearing Shelf & PCC Seating ‚Äî {label}', unit:'Sqm', boqPreset:null,          defaultDays:5,  depCode:'ABT',  lag:0},
    ],
    'pier': [
        {code:'PIR', name:'Pier Column ‚Äî {label}',                unit:'Cum', boqPreset:'substructure', defaultDays:20, depCode:'_FND', lag:2},
        {code:'CAP', name:'Pier Cap ‚Äî {label}',                   unit:'Cum', boqPreset:'pier_cap',     defaultDays:10, depCode:'PIR',  lag:1},
    ],
    'wing': [
        {code:'WNG', name:'Wing Wall ‚Äî {label}',                  unit:'Cum', boqPreset:'substructure', defaultDays:8,  depCode:'_FND', lag:2},
    ],
};

const SUPERSTRUCTURE_WBS = {
    'PSC Girder (T-Beam / Box)': [
        {code:'PSC-CST', name:'PSC Girder Casting ‚Äî {label}',     unit:'Nos', boqPreset:'girder_casting', defaultDays:35, canParallel:true, note:'Start at pre-cast yard while substructure is in progress'},
        {code:'PSC-ERC', name:'Girder Transport & Erection ‚Äî {label}', unit:'Nos', boqPreset:'girder_erection', defaultDays:5, depCode:'PSC-CST', lag:7},
        {code:'DSK',     name:'Deck Slab & Cross Girder ‚Äî {label}',unit:'Cum', boqPreset:'deck_slab',    defaultDays:20, depCode:'PSC-ERC', lag:0},
    ],
    'RCC T-Beam Girder (In-situ)': [
        {code:'STG',     name:'Staging & Shuttering ‚Äî {label}',   unit:'Sqm', boqPreset:'staging',       defaultDays:12, depCode:'_SUB', lag:0},
        {code:'RFT',     name:'Reinforcement ‚Äî {label}',           unit:'MT',  boqPreset:'reinforcement', defaultDays:10, depCode:'STG',  lag:0, concurrent:true},
        {code:'CON',     name:'Concreting ‚Äî {label}',              unit:'Cum', boqPreset:'concreting',    defaultDays:3,  depCode:'RFT',  lag:0},
        {code:'DSH',     name:'Deshuttering & Curing ‚Äî {label}',  unit:'LS',  boqPreset:null,            defaultDays:21, depCode:'CON',  lag:0},
    ],
    'Steel Composite Girder': [
        {code:'STL-FAB', name:'Steel Girder Fabrication ‚Äî {label}',unit:'MT',  boqPreset:'steel_fab',    defaultDays:30, canParallel:true, note:'Fabrication at workshop while substructure progresses'},
        {code:'STL-ERC', name:'Steel Girder Erection ‚Äî {label}',   unit:'MT',  boqPreset:'steel_erect',  defaultDays:8,  depCode:'STL-FAB', lag:0},
        {code:'DSK',     name:'Composite Deck Slab ‚Äî {label}',     unit:'Cum', boqPreset:'deck_slab',    defaultDays:15, depCode:'STL-ERC', lag:0},
    ],
    'Solid Slab (RCC In-situ)': [
        {code:'STG',     name:'Staging & Shuttering ‚Äî {label}',    unit:'Sqm', boqPreset:'staging',      defaultDays:8,  depCode:'_SUB', lag:0},
        {code:'CON',     name:'Slab Concreting ‚Äî {label}',         unit:'Cum', boqPreset:'concreting',   defaultDays:2,  depCode:'STG',  lag:0},
        {code:'DSH',     name:'Deshuttering & Curing ‚Äî {label}',   unit:'LS',  boqPreset:null,           defaultDays:14, depCode:'CON',  lag:0},
    ],
    'Hollow Slab (RCC)': [
        {code:'STG',     name:'Staging & Shuttering ‚Äî {label}',    unit:'Sqm', boqPreset:'staging',      defaultDays:10, depCode:'_SUB', lag:0},
        {code:'RFT',     name:'Reinforcement ‚Äî {label}',            unit:'MT',  boqPreset:'reinforcement',defaultDays:8,  depCode:'STG',  lag:0, concurrent:true},
        {code:'CON',     name:'Hollow Slab Concreting ‚Äî {label}',  unit:'Cum', boqPreset:'concreting',   defaultDays:3,  depCode:'RFT',  lag:0},
        {code:'DSH',     name:'Deshuttering & Curing ‚Äî {label}',   unit:'LS',  boqPreset:null,           defaultDays:21, depCode:'CON',  lag:0},
    ],
    'Precast Plank / Deck Slab': [
        {code:'PRC-CST', name:'Precast Plank Casting',              unit:'Nos', boqPreset:'girder_casting',defaultDays:15, canParallel:true},
        {code:'PRC-ERC', name:'Plank Erection ‚Äî {label}',          unit:'Nos', boqPreset:'girder_erection',defaultDays:5, depCode:'PRC-CST', lag:5},
        {code:'TOP',     name:'Top Slab ‚Äî {label}',                unit:'Cum', boqPreset:'deck_slab',    defaultDays:8,  depCode:'PRC-ERC', lag:0},
    ],
    'Box Girder (RCC/PSC)': [
        {code:'BGD-CST', name:'Box Girder Casting ‚Äî {label}',      unit:'Cum', boqPreset:'concreting',   defaultDays:45, canParallel:true},
        {code:'BGD-ERC', name:'Box Girder Launching ‚Äî {label}',    unit:'Nos', boqPreset:'girder_erection',defaultDays:10, depCode:'BGD-CST', lag:7},
    ],
    'No Superstructure (Culvert)': [
        {code:'ROF',     name:'Box Culvert Roof Slab / Slab Culvert', unit:'Cum', boqPreset:'superstructure', defaultDays:8, depCode:'_SUB', lag:2},
    ],
};

const FINISHING_WBS = [
    {code:'WCT',  name:'Wearing Coat / Approach Road',         unit:'Sqm', boqPreset:'approach',   defaultDays:10, depCode:'_SST', lag:0},
    {code:'EXP',  name:'Expansion Joints & Bearings',          unit:'Nos', boqPreset:null,          defaultDays:5,  depCode:'_SST', lag:0, concurrent:true},
    {code:'CRB',  name:'Crash Barrier / Railing / Handrail',   unit:'RMT', boqPreset:null,          defaultDays:8,  depCode:'WCT',  lag:0},
    {code:'FIN',  name:'Misc Finishing & Punch List',          unit:'LS',  boqPreset:'misc',         defaultDays:5,  depCode:'CRB',  lag:0},
];

const PREPARATORY_WBS = [
    {code:'PRE-CLR', name:'Site Clearance & Access Road',      unit:'LS',  boqPreset:null, defaultDays:5,  depCode:null, lag:0},
    {code:'PRE-DWR', name:'Dewatering & Cofferdams (if reqd)', unit:'LS',  boqPreset:null, defaultDays:5,  depCode:'PRE-CLR', lag:0},
];

// ‚îÄ‚îÄ DEFAULT PRODUCTIVITY RATES (fallback if Resources tab empty) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEFAULT_PRODUCTIVITY = {
    'Cum': 15,    // 15 Cum/day concrete
    'M':   2,     // 2m/day well sinking  
    'MT':  3,     // 3 MT/day rebar
    'Nos': 1,     // 1 No/day (piles, girders)
    'Sqm': 80,    // 80 Sqm/day shuttering
    'RMT': 30,    // 30 RMT/day
    'LS':  1,     // lump sum = default days
};

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtChT(m){m=parseInt(m)||0;const k=Math.floor(m/1000);const r=m%1000;return k+'+'+String(r).padStart(3,'0');}
function parseChT(s){if(!s)return 0;s=String(s).replace(/\s/g,'');if(s.includes('+')){const p=s.split('+');return parseInt(p[0]||0)*1000+parseInt(p[1]||0);}return parseInt(s)||0;}
function getAllTCSItems(){return TCS_ELEMENTS.flatMap(g=>g.items);}
function ensureBOQ(){
    if(!KALYANTRA.data.boq)KALYANTRA.data.boq={tcsList:[],structureBOQ:[],generationConfig:{sequence:[],productivityRates:{},confirmed:false}};
    if(!KALYANTRA.data.boq.tcsList)KALYANTRA.data.boq.tcsList=[];
    if(!KALYANTRA.data.boq.structureBOQ)KALYANTRA.data.boq.structureBOQ=[];
    return KALYANTRA.data.boq;
}
function getStructLabel(type){return(STRUCT_TYPES.find(t=>t.value===type)||{label:type||'Structure'}).label;}
function statusColor(s){
    if(!s)return'#9ca3af';
    if(s.includes('Approved')||s==='Complete'||s==='100')return'#16a34a';
    if(s.includes('In Review')||s==='In Progress')return'#d97706';
    if(s.includes('On Hold')||s.includes('Blocked'))return'#dc2626';
    return'#9ca3af';
}
function calcDuration(boqQty, unit, boqPreset, overrideDays, productivityRates){
    if(overrideDays && overrideDays > 0) return overrideDays;
    if(!boqQty || boqQty <= 0) return 0;
    const rate = (productivityRates && productivityRates[unit]) || DEFAULT_PRODUCTIVITY[unit] || 10;
    return Math.max(1, Math.ceil(boqQty / rate));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WBS AUTO-GENERATION ENGINE
// Called when a structure is frozen
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function generateStructureWBS(si) {
    const st = KALYANTRA.data.structures[si];
    if (!st) return;
    const boqData = ensureBOQ();
    const boqEntry = boqData.structureBOQ.find(s => s.structureId == st.id) || {items: []};
    const boqItems = boqEntry.items || [];
    const prodRates = (KALYANTRA.data.resources && KALYANTRA.data.resources.productivityRates) || {};
    const supports = st.supports || [];

    // Get BOQ qty for a preset
    function getBoqQty(presetId) {
        const item = boqItems.find(i => i.presetId === presetId || i.boqPreset === presetId);
        return item ? (item.qty || 0) : 0;
    }

    const activities = [];
    let actIdx = 1;
    function addAct(wbsGroup, code, name, unit, days, depCode, lag, note) {
        const id = `STR${si+1}-${code.replace(/[^A-Z0-9]/g,'')}-${actIdx++}`;
        activities.push({
            id, wbsGroup, activityCode: code, activityName: name,
            unit, duration: days, depActivityId: depCode,
            lag: lag || 0, note: note || '',
            sourceStructureId: st.id, sourceStructureName: st.name,
            chainage: st.chainage, status: 'Not Started',
            plannedQty: 0, actualQty: 0, progressPct: 0
        });
        return id;
    }

    // ‚îÄ‚îÄ 1. PREPARATORY (structure-level, shared) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let lastPrepId = null;
    PREPARATORY_WBS.forEach((tmpl, ti) => {
        const dep = ti === 0 ? null : lastPrepId;
        lastPrepId = addAct('PREPARATORY', `${tmpl.code}`,
            `${tmpl.name} ‚Äî ${st.name}`, tmpl.unit, tmpl.defaultDays, dep, tmpl.lag);
    });

    // ‚îÄ‚îÄ 2. PER-SUPPORT: FOUNDATION + SUBSTRUCTURE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const foundationLastIds = {}; // support.id ‚Üí last foundation activity id
    const substructureLastIds = {}; // support.id ‚Üí last substructure activity id
    const sharedAdded = new Set(); // for sharedAcrossSupports activities (like rig mobilization)

    // Group supports by foundation type to handle shared activities
    const foundationGroups = {};
    supports.forEach(sp => {
        if (!foundationGroups[sp.foundation]) foundationGroups[sp.foundation] = [];
        foundationGroups[sp.foundation].push(sp);
    });

    // Check if piling mob was added
    let pilingMobId = null;

    supports.forEach((sp, spIdx) => {
        const fnTemplate = FOUNDATION_WBS[sp.foundation] || FOUNDATION_WBS['Open Foundation (PCC/RCC)'];
        const subTemplate = SUBSTRUCTURE_WBS[sp.type] || SUBSTRUCTURE_WBS['pier'];
        const label = sp.label || (sp.type === 'abutment' ? `Abutment A${spIdx+1}` : `Pier P${spIdx}`);

        let prevFndId = lastPrepId;

        fnTemplate.forEach(tmpl => {
            // Skip if this is a shared activity already added
            if (tmpl.sharedAcrossSupports) {
                if (sharedAdded.has(tmpl.code)) {
                    // Just reference the existing shared activity
                    if (tmpl.code === 'PIL-MOB') prevFndId = pilingMobId;
                    return;
                }
                sharedAdded.add(tmpl.code);
            }

            const boqQty = getBoqQty(tmpl.boqPreset);
            const days = calcDuration(boqQty, tmpl.unit, tmpl.boqPreset, tmpl.defaultDays, prodRates);
            const actName = tmpl.name.replace('{label}', label);
            const dep = tmpl.depCode === null ? lastPrepId : prevFndId;

            const actId = addAct('FOUNDATION', `${tmpl.code}-${spIdx+1}`,
                actName, tmpl.unit, days, dep, tmpl.lag);

            if (tmpl.code === 'PIL-MOB') pilingMobId = actId;
            prevFndId = actId;
        });

        foundationLastIds[sp.id || spIdx] = prevFndId;

        // Substructure activities ‚Äî depend on foundation complete + cure lag
        let prevSubId = prevFndId;
        subTemplate.forEach(tmpl => {
            const boqQty = getBoqQty(tmpl.boqPreset);
            const days = calcDuration(boqQty, tmpl.unit, tmpl.boqPreset, tmpl.defaultDays, prodRates);
            const actName = tmpl.name.replace('{label}', label);
            const dep = tmpl.depCode === '_FND' ? prevFndId : (tmpl.depCode ? prevSubId : prevFndId);

            const actId = addAct('SUBSTRUCTURE', `${tmpl.code}-${spIdx+1}`,
                actName, tmpl.unit, days, dep, tmpl.lag);
            prevSubId = actId;
        });

        substructureLastIds[sp.id || spIdx] = prevSubId;
    });

    // ‚îÄ‚îÄ 3. PER-SPAN SUPERSTRUCTURE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Span = from support[i] to support[i+1]
    // Superstructure type taken from left support (support[i])
    const allSubIds = Object.values(substructureLastIds);
    // Last substructure across all supports ‚Äî superstructure starts after all substructure done
    const allSubDone = allSubIds[allSubIds.length - 1]; // simplified: use last

    let lastSSTId = allSubDone;

    supports.forEach((sp, spIdx) => {
        if (spIdx >= supports.length - 1) return; // last support has no span beyond it
        if (!sp.spanLength || sp.spanLength <= 0) return;

        const nextSp = supports[spIdx + 1];
        const spanLabel = `Span ${spIdx+1} (Ch ${fmtChT(st.chainage)})`;
        const sstTemplate = SUPERSTRUCTURE_WBS[sp.superstructure] || SUPERSTRUCTURE_WBS['Solid Slab (RCC In-situ)'];

        let prevSSTId = allSubDone;

        sstTemplate.forEach(tmpl => {
            const boqQty = getBoqQty(tmpl.boqPreset);
            const days = calcDuration(boqQty, tmpl.unit, tmpl.boqPreset, tmpl.defaultDays, prodRates);
            const actName = tmpl.name.replace('{label}', spanLabel).replace('{spanLabel}', spanLabel);

            // canParallel: PSC casting can start parallel with substructure
            const dep = tmpl.canParallel ? lastPrepId : (tmpl.depCode === '_SUB' ? allSubDone : (tmpl.depCode ? prevSSTId : allSubDone));

            const actId = addAct('SUPERSTRUCTURE', `${tmpl.code}-SP${spIdx+1}`,
                actName, tmpl.unit, days, dep, tmpl.lag || 0, tmpl.note || '');

            prevSSTId = actId;
            lastSSTId = actId;
        });
    });

    // ‚îÄ‚îÄ 4. FINISHING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let prevFinId = lastSSTId;
    FINISHING_WBS.forEach(tmpl => {
        const boqQty = getBoqQty(tmpl.boqPreset);
        const days = calcDuration(boqQty, tmpl.unit, tmpl.boqPreset, tmpl.defaultDays, prodRates);
        const dep = tmpl.depCode === '_SST' ? lastSSTId : (tmpl.depCode ? prevFinId : lastSSTId);
        const actId = addAct('FINISHING', tmpl.code,
            `${tmpl.name} ‚Äî ${st.name}`, tmpl.unit, days, dep, tmpl.lag);
        prevFinId = actId;
    });

    // ‚îÄ‚îÄ STORE & MERGE INTO ACTIVITY GRID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (!KALYANTRA.data.activities) KALYANTRA.data.activities = [];
    // Remove any previously auto-generated activities for this structure
    KALYANTRA.data.activities = KALYANTRA.data.activities.filter(a => a.sourceStructureId !== st.id);
    // Add new activities
    activities.forEach(a => KALYANTRA.data.activities.push(a));
    st.wbsGenerated = true;
    st.wbsActivityCount = activities.length;
    KALYANTRA.save();

    return activities;
}

// Similar function for TCS ‚Äî generates road activities
function generateTCSWBS(ti) {
    const boq = ensureBOQ();
    const tcs = boq.tcsList[ti];
    if (!tcs) return;
    const prodRates = (KALYANTRA.data.resources && KALYANTRA.data.resources.productivityRates) || {};
    const activities = [];
    let actIdx = 1;

    const totalLen = (tcs.locations || []).reduce((s,l)=>s+(l.toCh-l.fromCh), 0);
    if (totalLen <= 0) return;

    (tcs.boqItems || []).forEach(item => {
        // One activity per BOQ item, per location
        (tcs.locations || []).forEach(loc => {
            const locLen = loc.toCh - loc.fromCh;
            const id = `TCS${ti+1}-${item.activityLink||item.itemNo}-${actIdx++}`;
            const rate = KALYANTRA.data.resources?.productivityRates?.[item.unit] || DEFAULT_PRODUCTIVITY[item.unit] || 10;
            const duration = Math.max(1, Math.ceil(locLen / rate));
            activities.push({
                id, wbsGroup: 'ROAD WORKS',
                activityCode: item.activityLink || `RD-${item.itemNo}`,
                activityName: `${item.description} ‚Äî Ch ${fmtChT(loc.fromCh)} to ${fmtChT(loc.toCh)}`,
                unit: item.unit, duration,
                plannedLength: locLen, chainage: loc.fromCh,
                status: 'Not Started', plannedQty: locLen, actualQty: 0, progressPct: 0,
                sourceTCSId: tcs.id, sourceTCSName: tcs.name,
            });
        });
    });

    if (!KALYANTRA.data.activities) KALYANTRA.data.activities = [];
    KALYANTRA.data.activities = KALYANTRA.data.activities.filter(a => a.sourceTCSId !== tcs.id);
    activities.forEach(a => KALYANTRA.data.activities.push(a));
    tcs.wbsGenerated = true;
    tcs.wbsActivityCount = activities.length;
    KALYANTRA.save();
    return activities;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STRUCTURES TAB RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderStructuresList(){
    const structs = KALYANTRA.data.structures || [];
    const empty = document.getElementById('structuresEmptyState');
    const list  = document.getElementById('structuresList');
    if (!list) return;
    if (structs.length === 0) { if(empty)empty.style.display='block'; list.innerHTML=''; return; }
    if (empty) empty.style.display = 'none';
    const hindrances = KALYANTRA.data.hindrances || [];

    list.innerHTML = structs.map((st, si) => {
        const boqEntry = (ensureBOQ().structureBOQ || []).find(sb=>sb.structureId==st.id)||{items:[]};
        const boqItems = boqEntry.items || [];
        const boqTotal = boqItems.reduce((s,i)=>s+(i.qty||0)*(i.rate||0), 0);
        const earnedTotal = boqItems.reduce((s,i)=>s+(i.earnedQty||0)*(i.rate||0), 0);
        const pct = Math.min(100, Math.max(0, st.progressPct || 0));
        const pctColor = pct>=80?'#16a34a':pct>=40?'#d97706':'#dc2626';
        const apColor = statusColor(st.approvalStatus||'');
        const hindrance = hindrances.find(h=>h.id==st.hindranceId);
        const isBlocked = hindrance && hindrance.status !== 'Resolved';
        const supports = st.supports || [];
        const totalLen = supports.slice(0,-1).reduce((s,sp,i)=>s+(sp.spanLength||0),0);
        const spanCount = supports.length > 1 
            ? supports.length - 1 
            : (Array.isArray(st.spans) ? st.spans.length : (Number(st.spans) || 1));

        // Unique foundation types across supports
        const fnTypes = [...new Set(supports.map(s=>s.foundation).filter(Boolean))];
        const sstTypes = [...new Set(supports.slice(0,-1).map(s=>s.superstructure).filter(Boolean))];

        return `<div style="background:#fff;border:1px solid var(--border-light);border-radius:8px;padding:14px;margin-bottom:10px;border-left:4px solid ${isBlocked?'#dc2626':pct>=100?'#16a34a':st.frozen?'#16a34a':'var(--navy)'};">
            <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;">
                <div style="display:flex;align-items:center;gap:10px;">
                    <div style="background:var(--navy);color:var(--accent-gold);padding:3px 9px;border-radius:4px;font-size:0.7rem;font-weight:700;">STR-${si+1}</div>
                    <div>
                        <div style="font-weight:700;color:var(--navy);font-size:0.92rem;">${st.name||'Unnamed'}</div>
                        <div style="font-size:0.71rem;color:var(--text-secondary);margin-top:2px;">
                            ${getStructLabel(st.type)}&nbsp;|&nbsp;Ch&nbsp;${fmtChT(st.chainage||0)}&nbsp;|&nbsp;${spanCount}&nbsp;span(s)${totalLen>0?'&nbsp;('+totalLen+'m total)':''}
                            &nbsp;|&nbsp;<span style="font-weight:700;color:${apColor};">${st.approvalStatus||'üìã Pending'}</span>
                            ${isBlocked?'&nbsp;|&nbsp;<span style="color:#dc2626;font-weight:700;">‚ö†Ô∏è BLOCKED</span>':''}
                            ${st.frozen?'&nbsp;|&nbsp;<span style="color:#16a34a;font-weight:700;font-size:0.69rem;">üîí FROZEN</span>':''}
                            ${st.wbsGenerated?`&nbsp;|&nbsp;<span style="color:#7c3aed;font-weight:700;font-size:0.69rem;">‚ö° ${st.wbsActivityCount||0} WBS activities</span>`:''}
                        </div>
                        ${fnTypes.length>0?`<div style="font-size:0.68rem;color:#475569;margin-top:2px;">Foundation: ${fnTypes.join(' | ')} &nbsp;¬∑&nbsp; Superstructure: ${sstTypes.join(' | ')}</div>`:''}
                    </div>
                </div>
                <div style="display:flex;gap:5px;flex-shrink:0;flex-wrap:wrap;justify-content:flex-end;">
                    ${!st.frozen
                        ?`<button onclick="structEditCard(${si})" style="background:#e0f2fe;color:#0369a1;border:none;padding:5px 10px;border-radius:4px;font-size:0.73rem;cursor:pointer;font-weight:600;">‚úèÔ∏è Edit</button>
                          <button onclick="structFreezeCard(${si})" style="background:#dcfce7;color:#15803d;border:none;padding:5px 10px;border-radius:4px;font-size:0.73rem;cursor:pointer;font-weight:700;">üîí Freeze & Gen WBS</button>`
                        :`<button onclick="structUnfreezeCard(${si})" style="background:#fef9c3;color:#92400e;border:none;padding:5px 10px;border-radius:4px;font-size:0.73rem;cursor:pointer;">üîì Unfreeze</button>
                          <button onclick="structViewWBS(${si})" style="background:#f5f3ff;color:#7c3aed;border:none;padding:5px 10px;border-radius:4px;font-size:0.73rem;cursor:pointer;font-weight:600;">‚ö° View WBS</button>`}
                    <button onclick="structDeleteCard(${si})" style="background:#fee2e2;color:#dc2626;border:none;padding:5px 10px;border-radius:4px;font-size:0.73rem;cursor:pointer;font-weight:600;">üóëÔ∏è</button>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
                <!-- SPANS SUMMARY -->
                <div style="background:#f8fafc;border-radius:6px;padding:10px;">
                    <div style="font-size:0.67rem;font-weight:800;text-transform:uppercase;letter-spacing:0.06em;color:var(--navy);margin-bottom:6px;">Span Details</div>
                    ${supports.length === 0
                        ?'<div style="color:var(--text-secondary);font-size:0.73rem;font-style:italic;">No spans defined ‚Äî click Edit</div>'
                        :supports.map((sp,spi)=>{
                            const isLast = spi === supports.length - 1;
                            const fndShort = (sp.foundation||'').split(' ')[0];
                            const sstShort = isLast ? '' : (sp.superstructure||'').replace('(T-Beam / Box)','').replace('(RCC/PSC)','').replace('(In-situ)','').trim();
                            return `<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;padding:3px 6px;background:${sp.type==='abutment'?'#eff6ff':'#f0fdf4'};border-radius:3px;">
                                <span style="font-size:0.68rem;font-weight:700;color:${sp.type==='abutment'?'#1d4ed8':'#15803d'};min-width:60px;">${sp.label||'S'+(spi+1)}</span>
                                <span style="font-size:0.67rem;color:var(--text-secondary);flex:1;">${fndShort}</span>
                                ${!isLast?`<span style="font-size:0.67rem;color:#7c3aed;">${sstShort}</span><span style="font-size:0.67rem;color:#94a3b8;">${sp.spanLength||0}m</span>`:''}
                            </div>`;
                        }).join('')}
                </div>
                <!-- STATUS & PROGRESS -->
                <div style="background:#eff6ff;border-radius:6px;padding:10px;">
                    <div style="font-size:0.67rem;font-weight:800;text-transform:uppercase;letter-spacing:0.06em;color:#1d4ed8;margin-bottom:7px;">Status & Progress</div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span style="font-size:0.71rem;color:#1e40af;">GAD Drawing</span><span style="font-size:0.71rem;font-weight:600;color:${statusColor(st.gadStatus||'')};">${st.gadStatus||'Not Started'}</span></div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="font-size:0.71rem;color:#1e40af;">Working Drawings</span><span style="font-size:0.71rem;font-weight:600;color:${statusColor(st.workingDrawStatus||'')};">${st.workingDrawStatus||'Not Started'}</span></div>
                    <div style="margin-bottom:4px;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:3px;"><span style="font-size:0.71rem;color:#1e40af;font-weight:600;">Physical Progress</span><span style="font-size:0.84rem;font-weight:700;color:${pctColor};">${pct}%</span></div>
                        <div style="background:#dbeafe;border-radius:4px;height:8px;overflow:hidden;"><div style="background:${pctColor};height:100%;width:${pct}%;border-radius:4px;"></div></div>
                    </div>
                    ${st.targetDate?`<div style="display:flex;justify-content:space-between;margin-top:4px;"><span style="font-size:0.71rem;color:#1e40af;">Target</span><span style="font-size:0.71rem;font-weight:600;color:var(--navy);">${st.targetDate}</span></div>`:''}
                    ${isBlocked?`<div style="margin-top:6px;padding:4px 8px;background:#fee2e2;border-radius:4px;font-size:0.68rem;color:#dc2626;font-weight:600;">‚ö†Ô∏è ${hindrance.name||'Hindrance active'}</div>`:''}
                    ${st.notes?`<div style="margin-top:5px;font-size:0.68rem;color:#475569;font-style:italic;">${st.notes}</div>`:''}
                </div>
                <!-- BOQ -->
                <div style="background:#f5f3ff;border-radius:6px;padding:10px;">
                    <div style="font-size:0.67rem;font-weight:800;text-transform:uppercase;letter-spacing:0.06em;color:#7c3aed;margin-bottom:6px;">BOQ</div>
                    <div style="font-size:0.72rem;color:var(--text-secondary);">Manage in BOQ tab</div>
                    <div style="margin-top:8px;"><a href="#" onclick="sidebarSwitchTab(6,null);return false;" style="font-size:0.72rem;color:#7c3aed;font-weight:600;">‚Üí Open BOQ Tab</a></div>
                </div>
            </div>
        </div>`;
    }).join('');
}

function structFreezeCard(si) {
    const st = KALYANTRA.data.structures[si];
    if (!st) return;
    const supports = st.supports || [];
    if (supports.length < 2) {
        showToast('‚ö†Ô∏è Add at least 2 supports (abutments/piers) before freezing', 'info');
        return;
    }
    if (!confirm(`Freeze ${st.name}?\n\nThis will auto-generate WBS activities and add them to the Activity Grid.\n\nActivities generated:\n‚Ä¢ Preparatory works\n‚Ä¢ Foundation (per support)\n‚Ä¢ Substructure (per support)\n‚Ä¢ Superstructure (per span)\n‚Ä¢ Finishing works\n\nDuration is calculated from BOQ quantities.\nYou can edit individual activity durations after generation.`)) return;
    st.frozen = true;
    const acts = generateStructureWBS(si);
    renderStructuresList();
    showToast(`üîí ${st.name} frozen ¬∑ ${acts ? acts.length : 0} WBS activities generated`, 'success');
}

function structUnfreezeCard(si) {
    const st = KALYANTRA.data.structures[si];
    if (!st) return;
    if (!confirm(`Unfreeze ${st.name}?\n\nThis will remove the ${st.wbsActivityCount||0} auto-generated WBS activities from the Activity Grid.`)) return;
    st.frozen = false;
    st.wbsGenerated = false;
    st.wbsActivityCount = 0;
    if (KALYANTRA.data.activities) {
        KALYANTRA.data.activities = KALYANTRA.data.activities.filter(a => a.sourceStructureId !== st.id);
    }
    KALYANTRA.save();
    renderStructuresList();
    showToast('üîì Structure unfrozen ‚Äî WBS activities removed', 'info');
}

function structViewWBS(si) {
    const st = KALYANTRA.data.structures[si];
    const acts = (KALYANTRA.data.activities || []).filter(a => a.sourceStructureId === st.id);
    if (!acts.length) { showToast('No WBS activities found', 'info'); return; }

    const groups = {};
    acts.forEach(a => {
        if (!groups[a.wbsGroup]) groups[a.wbsGroup] = [];
        groups[a.wbsGroup].push(a);
    });

    const modal = document.createElement('div');
    modal.id = 'structWBSModal';
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.55);z-index:9999;display:flex;align-items:flex-start;justify-content:center;padding-top:30px;overflow-y:auto;';

    const totalDays = acts.reduce((mx,a) => Math.max(mx, a.duration||0), 0);
    const groupColors = {PREPARATORY:'#64748b',FOUNDATION:'#d97706',SUBSTRUCTURE:'#0369a1',SUPERSTRUCTURE:'#7c3aed',FINISHING:'#16a34a'};

    let tableRows = '';
    Object.entries(groups).forEach(([grp, grpActs]) => {
        const c = groupColors[grp] || '#1B3B6F';
        tableRows += `<tr><td colspan="5" style="padding:6px 10px;background:${c};color:#fff;font-size:0.72rem;font-weight:700;letter-spacing:0.05em;">${grp}</td></tr>`;
        grpActs.forEach((a, ai) => {
            tableRows += `<tr style="background:${ai%2===0?'#f8fafc':'#fff'}">
                <td style="padding:5px 8px;font-size:0.72rem;color:var(--text-secondary);">${a.activityCode}</td>
                <td style="padding:5px 8px;font-size:0.75rem;">${a.activityName}</td>
                <td style="padding:5px 8px;text-align:center;font-size:0.72rem;">${a.unit}</td>
                <td style="padding:5px 8px;text-align:center;font-size:0.78rem;font-weight:600;color:${c};">
                    <input type="number" value="${a.duration||0}" min="1"
                        onchange="structUpdateActivityDuration('${a.id}',parseInt(this.value)||1)"
                        style="width:60px;padding:2px 6px;border:1px solid #e2e8f0;border-radius:3px;font-size:0.78rem;text-align:center;font-weight:600;color:${c};">
                    days
                </td>
                <td style="padding:5px 8px;font-size:0.68rem;color:var(--text-secondary);font-style:italic;">${a.note||''}</td>
            </tr>`;
        });
    });

    modal.innerHTML = `
    <div style="background:#fff;border-radius:10px;padding:24px;width:820px;max-width:97vw;box-shadow:0 20px 60px rgba(0,0,0,0.3);margin-bottom:40px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid var(--accent-gold);">
            <div>
                <div style="font-weight:700;color:var(--navy);font-size:1rem;">‚ö° Auto-Generated WBS ‚Äî ${st.name}</div>
                <div style="font-size:0.72rem;color:var(--text-secondary);margin-top:2px;">${acts.length} activities across ${Object.keys(groups).length} work groups ¬∑ Durations editable ¬∑ Based on BOQ quantities</div>
            </div>
            <button onclick="document.getElementById('structWBSModal').remove()" style="background:none;border:none;font-size:1.2rem;cursor:pointer;">‚úï</button>
        </div>
        <div style="overflow-x:auto;">
            <table style="width:100%;border-collapse:collapse;font-size:0.78rem;">
                <thead><tr style="background:var(--navy);color:#fff;">
                    <th style="padding:7px 8px;text-align:left;">Code</th>
                    <th style="padding:7px 8px;text-align:left;">Activity</th>
                    <th style="padding:7px 8px;text-align:center;">Unit</th>
                    <th style="padding:7px 8px;text-align:center;">Duration</th>
                    <th style="padding:7px 8px;text-align:left;">Notes</th>
                </tr></thead>
                <tbody>${tableRows}</tbody>
            </table>
        </div>
        <div style="margin-top:14px;padding:10px 12px;background:#f0fdf4;border-radius:6px;font-size:0.78rem;color:#15803d;">
            üí° <strong>These activities are now in the Activity Grid.</strong> Durations auto-calculated from BOQ quantities √∑ productivity rates. Override any duration above. Dependencies are pre-set (sequential within each group, parallel where possible e.g. PSC girder casting starts early).
        </div>
        <div style="text-align:right;margin-top:14px;">
            <button onclick="document.getElementById('structWBSModal').remove()"
                style="padding:9px 22px;background:var(--navy);color:var(--accent-gold);border:none;border-radius:6px;font-weight:700;cursor:pointer;">Close</button>
        </div>
    </div>`;
    document.body.appendChild(modal);
}

function structUpdateActivityDuration(actId, days) {
    const act = (KALYANTRA.data.activities || []).find(a => a.id === actId);
    if (act) { act.duration = days; act.durationOverridden = true; KALYANTRA.save(); }
}

// ‚îÄ‚îÄ ADD / DELETE / EDIT STRUCTURE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function structAddNew() {
    if (!KALYANTRA.data.structures) KALYANTRA.data.structures = [];
    const id = 'st_' + Date.now();
    KALYANTRA.data.structures.push({
        id, name: 'New Structure', type: 'box_culvert', chainage: 0,
        supports: [], frozen: false, wbsGenerated: false,
        progressPct: 0, targetDate: '', hindranceId: '',
        approvalStatus: 'üìã Pending', gadStatus: 'Not Started',
        workingDrawStatus: 'Not Started', notes: ''
    });
    KALYANTRA.save();
    renderStructuresList();
    setTimeout(() => structEditCard(KALYANTRA.data.structures.length - 1), 80);
}

function structDeleteCard(si) {
    const st = KALYANTRA.data.structures[si];
    if (!st) return;
    if (!confirm(`Delete ${st.name} and all its BOQ + WBS activities?`)) return;
    ensureBOQ().structureBOQ = ensureBOQ().structureBOQ.filter(sb => sb.structureId != st.id);
    if (KALYANTRA.data.activities) {
        KALYANTRA.data.activities = KALYANTRA.data.activities.filter(a => a.sourceStructureId !== st.id);
    }
    KALYANTRA.data.structures.splice(si, 1);
    KALYANTRA.save();
    renderStructuresList();
    showToast('üóëÔ∏è Structure deleted', 'info');
}

function structEditCard(si) {
    const st = KALYANTRA.data.structures[si];
    if (!st) return;
    if (st.frozen) { structProgressModal(si); return; }
    const ex = document.getElementById('structEditModal');
    if (ex) ex.remove();
    const modal = document.createElement('div');
    modal.id = 'structEditModal';
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.55);z-index:9999;display:flex;align-items:flex-start;justify-content:center;padding-top:25px;overflow-y:auto;';

    const typeOpts = STRUCT_TYPES.map(t=>`<option value="${t.value}" ${st.type===t.value?'selected':''}>${t.label}</option>`).join('');
    const hindOpts = '<option value="">‚Äî None ‚Äî</option>' + (KALYANTRA.data.hindrances||[]).filter(h=>h.status!=='Resolved').map(h=>`<option value="${h.id}" ${st.hindranceId==h.id?'selected':''}>${h.name} (Ch ${fmtChT(h.chainageStart||0)})</option>`).join('');

    // Build span table rows
    const supports = st.supports && st.supports.length > 0 ? st.supports : [];
    const spanRows = supports.map((sp, spi) => buildSpanRow(sp, spi, si)).join('');

    modal.innerHTML = `
    <div style="background:#fff;border-radius:10px;padding:22px;width:760px;max-width:97vw;box-shadow:0 20px 60px rgba(0,0,0,0.3);margin-bottom:40px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:10px;border-bottom:2px solid var(--accent-gold);">
            <div>
                <div style="font-weight:700;color:var(--navy);font-size:1rem;">‚úèÔ∏è Structure Details ‚Äî ${st.name}</div>
                <div style="font-size:0.71rem;color:var(--text-secondary);margin-top:2px;">Define each support point. Foundation & superstructure per support drives WBS auto-generation.</div>
            </div>
            <button onclick="document.getElementById('structEditModal').remove()" style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:#64748b;">‚úï</button>
        </div>

        <!-- IDENTITY ROW -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px;">
            <div style="grid-column:span 1;">
                <label style="font-size:0.72rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">Structure Name *</label>
                <input id="stName" type="text" value="${st.name||''}" placeholder="e.g. Major Bridge Ch 8+450"
                    style="width:100%;padding:7px 9px;border:1.5px solid var(--border-medium);border-radius:5px;font-size:0.84rem;box-sizing:border-box;">
            </div>
            <div>
                <label style="font-size:0.72rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">Type *</label>
                <select id="stType" style="width:100%;padding:7px 9px;border:1.5px solid var(--border-medium);border-radius:5px;font-size:0.84rem;box-sizing:border-box;">${typeOpts}</select>
            </div>
            <div>
                <label style="font-size:0.72rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">Chainage *</label>
                <input id="stChainage" type="text" value="${fmtChT(st.chainage||0)}" placeholder="8+450"
                    style="width:100%;padding:7px 9px;border:1.5px solid var(--border-medium);border-radius:5px;font-size:0.84rem;box-sizing:border-box;">
            </div>
        </div>

        <!-- SPAN TABLE -->
        <div style="margin-bottom:14px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                <div>
                    <div style="font-size:0.7rem;font-weight:800;text-transform:uppercase;letter-spacing:0.06em;color:var(--navy);">Support Points & Span Details</div>
                    <div style="font-size:0.68rem;color:var(--text-secondary);margin-top:2px;">Each row = one support (abutment/pier). Foundation & superstructure can differ per support. This drives WBS generation.</div>
                </div>
                <button onclick="structAddSupportRow(${si})"
                    style="background:var(--accent-gold);color:#1B3B6F;border:none;padding:5px 12px;border-radius:4px;font-size:0.75rem;font-weight:700;cursor:pointer;white-space:nowrap;">+ Add Support</button>
            </div>
            <div style="overflow-x:auto;">
                <table style="width:100%;border-collapse:collapse;font-size:0.78rem;" id="spanTable_${si}">
                    <thead>
                        <tr style="background:var(--navy);color:#fff;">
                            <th style="padding:7px 8px;text-align:left;white-space:nowrap;">Label</th>
                            <th style="padding:7px 8px;text-align:left;">Type</th>
                            <th style="padding:7px 8px;text-align:left;min-width:160px;">Foundation Type</th>
                            <th style="padding:7px 8px;text-align:left;min-width:180px;">Superstructure Type</th>
                            <th style="padding:7px 8px;text-align:center;white-space:nowrap;">Span Length (m)</th>
                            <th style="padding:7px 8px;text-align:center;">Del</th>
                        </tr>
                    </thead>
                    <tbody id="spanTableBody_${si}">
                        ${spanRows || `<tr><td colspan="6" style="text-align:center;padding:16px;color:var(--text-secondary);font-style:italic;">No supports yet ‚Äî click + Add Support to start</td></tr>`}
                    </tbody>
                </table>
            </div>
            <div style="margin-top:6px;font-size:0.68rem;color:var(--text-secondary);">
                üí° For the last support (final abutment), span length = 0. Superstructure type on each row = superstructure for the span FROM that support to the next.
            </div>
        </div>

        <!-- DRAWING & APPROVAL -->
        <div style="background:#eff6ff;border-radius:6px;padding:12px;margin-bottom:12px;">
            <div style="font-size:0.7rem;font-weight:800;text-transform:uppercase;letter-spacing:0.06em;color:#1d4ed8;margin-bottom:8px;">Drawing & Approval</div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
                <div><label style="font-size:0.71rem;font-weight:600;color:#1e40af;display:block;margin-bottom:3px;">GAD Drawing</label>
                <select id="stGAD" style="width:100%;padding:7px 9px;border:1.5px solid #bfdbfe;border-radius:5px;font-size:0.82rem;box-sizing:border-box;">
                    <option ${(st.gadStatus||'')==='Not Started'?'selected':''}>Not Started</option>
                    <option ${(st.gadStatus||'')==='In Progress'?'selected':''}>In Progress</option>
                    <option ${(st.gadStatus||'')==='Complete'?'selected':''}>Complete</option>
                </select></div>
                <div><label style="font-size:0.71rem;font-weight:600;color:#1e40af;display:block;margin-bottom:3px;">Working Drawings</label>
                <select id="stWD" style="width:100%;padding:7px 9px;border:1.5px solid #bfdbfe;border-radius:5px;font-size:0.82rem;box-sizing:border-box;">
                    <option ${(st.workingDrawStatus||'')==='Not Started'?'selected':''}>Not Started</option>
                    <option ${(st.workingDrawStatus||'')==='In Progress'?'selected':''}>In Progress</option>
                    <option ${(st.workingDrawStatus||'')==='Complete'?'selected':''}>Complete</option>
                </select></div>
                <div><label style="font-size:0.71rem;font-weight:600;color:#1e40af;display:block;margin-bottom:3px;">Approval Status</label>
                <select id="stApproval" style="width:100%;padding:7px 9px;border:1.5px solid #bfdbfe;border-radius:5px;font-size:0.82rem;box-sizing:border-box;">
                    <option ${(st.approvalStatus||'')==='üìã Pending'?'selected':''}>üìã Pending</option>
                    <option ${(st.approvalStatus||'')==='üîÑ In Review'?'selected':''}>üîÑ In Review</option>
                    <option ${(st.approvalStatus||'')==='‚úÖ Approved'?'selected':''}>‚úÖ Approved</option>
                    <option ${(st.approvalStatus||'')==='‚ùå On Hold'?'selected':''}>‚ùå On Hold</option>
                </select></div>
            </div>
        </div>

        <!-- PROGRESS -->
        <div style="background:#f0fdf4;border-radius:6px;padding:12px;margin-bottom:18px;">
            <div style="font-size:0.7rem;font-weight:800;text-transform:uppercase;letter-spacing:0.06em;color:#15803d;margin-bottom:8px;">Progress & Tracking</div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:8px;">
                <div><label style="font-size:0.71rem;font-weight:600;color:#166534;display:block;margin-bottom:3px;">Physical Progress (%)</label>
                <input id="stPct" type="number" value="${st.progressPct||0}" min="0" max="100"
                    style="width:100%;padding:7px 9px;border:1.5px solid #bbf7d0;border-radius:5px;font-size:1rem;font-weight:700;color:#15803d;box-sizing:border-box;text-align:center;"></div>
                <div><label style="font-size:0.71rem;font-weight:600;color:#166534;display:block;margin-bottom:3px;">Target Completion</label>
                <input id="stTarget" type="month" value="${st.targetDate||''}"
                    style="width:100%;padding:7px 9px;border:1.5px solid #bbf7d0;border-radius:5px;font-size:0.82rem;box-sizing:border-box;"></div>
                <div><label style="font-size:0.71rem;font-weight:600;color:#166534;display:block;margin-bottom:3px;">Blocking Hindrance</label>
                <select id="stHindrance" style="width:100%;padding:7px 9px;border:1.5px solid #bbf7d0;border-radius:5px;font-size:0.78rem;box-sizing:border-box;">${hindOpts}</select></div>
            </div>
            <div><label style="font-size:0.71rem;font-weight:600;color:#166534;display:block;margin-bottom:3px;">Site Remarks</label>
            <input id="stNotes" type="text" value="${st.notes||''}" placeholder="e.g. Foundation complete at A1 & P1, pile cap pending"
                style="width:100%;padding:7px 9px;border:1.5px solid #bbf7d0;border-radius:5px;font-size:0.82rem;box-sizing:border-box;"></div>
        </div>

        <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button onclick="document.getElementById('structEditModal').remove()"
                style="padding:9px 18px;border:1.5px solid var(--border-medium);background:#fff;border-radius:6px;cursor:pointer;font-size:0.84rem;font-weight:600;color:#64748b;">Cancel</button>
            <button onclick="structSaveCard(${si})"
                style="padding:9px 24px;background:var(--navy);color:var(--accent-gold);border:none;border-radius:6px;font-weight:700;cursor:pointer;font-size:0.87rem;">üíæ Save Structure</button>
        </div>
    </div>`;
    document.body.appendChild(modal);
}

function buildSpanRow(sp, spi, si) {
    const typeOpts = SUPPORT_TYPES.map(t=>`<option value="${t.value}" ${sp.type===t.value?'selected':''}>${t.label}</option>`).join('');
    const fnOpts = STRUCT_FOUNDATIONS.map(f=>`<option ${sp.foundation===f?'selected':''}>${f}</option>`).join('');
    const ssOpts = STRUCT_SUPERSTRUCTURES.map(s=>`<option ${sp.superstructure===s?'selected':''}>${s}</option>`).join('');
    const rowBg = spi%2===0?'#f8fafc':'#fff';
    return `<tr id="spanRow_${si}_${spi}" style="background:${rowBg};">
        <td style="padding:5px 6px;">
            <input type="text" value="${sp.label||''}" placeholder="e.g. Abutment A1"
                onchange="structUpdateSupport(${si},${spi},'label',this.value)"
                style="width:100%;padding:4px 7px;border:1px solid #e2e8f0;border-radius:3px;font-size:0.78rem;font-weight:600;">
        </td>
        <td style="padding:5px 6px;">
            <select onchange="structUpdateSupport(${si},${spi},'type',this.value)"
                style="width:100%;padding:4px 7px;border:1px solid #e2e8f0;border-radius:3px;font-size:0.78rem;">${typeOpts}</select>
        </td>
        <td style="padding:5px 6px;">
            <select onchange="structUpdateSupport(${si},${spi},'foundation',this.value)"
                style="width:100%;padding:4px 7px;border:1px solid #e2e8f0;border-radius:3px;font-size:0.75rem;">${fnOpts}</select>
        </td>
        <td style="padding:5px 6px;">
            <select onchange="structUpdateSupport(${si},${spi},'superstructure',this.value)"
                style="width:100%;padding:4px 7px;border:1px solid #e2e8f0;border-radius:3px;font-size:0.75rem;">${ssOpts}</select>
        </td>
        <td style="padding:5px 6px;text-align:center;">
            <input type="number" value="${sp.spanLength||0}" min="0" max="999"
                onchange="structUpdateSupport(${si},${spi},'spanLength',parseFloat(this.value)||0)"
                style="width:70px;padding:4px 6px;border:1px solid #e2e8f0;border-radius:3px;font-size:0.82rem;text-align:right;">
        </td>
        <td style="padding:5px 6px;text-align:center;">
            <button onclick="structDeleteSupportRow(${si},${spi})"
                style="background:#fee2e2;color:#dc2626;border:none;padding:3px 8px;border-radius:3px;font-size:0.72rem;cursor:pointer;">‚úï</button>
        </td>
    </tr>`;
}

function structAddSupportRow(si) {
    const st = KALYANTRA.data.structures[si];
    if (!st) return;
    if (!st.supports) st.supports = [];
    const spi = st.supports.length;
    const isFirst = spi === 0;
    const newSupport = {
        id: 'sp_' + Date.now(),
        label: isFirst ? 'Abutment A1' : (spi === 1 ? 'Pier P1' : 'Abutment A2'),
        type: (isFirst || spi > 0 && st.supports[spi-1]?.type !== 'abutment') ? 'abutment' : 'pier',
        foundation: STRUCT_FOUNDATIONS[0],
        superstructure: STRUCT_SUPERSTRUCTURES[0],
        spanLength: spi < st.supports.length ? 15 : 0
    };
    st.supports.push(newSupport);
    KALYANTRA.save();
    const tbody = document.getElementById(`spanTableBody_${si}`);
    if (tbody) {
        if (tbody.querySelector('td[colspan]')) tbody.innerHTML = '';
        const tr = document.createElement('tr');
        tr.id = `spanRow_${si}_${spi}`;
        tr.innerHTML = buildSpanRow(newSupport, spi, si).replace(`<tr id="spanRow_${si}_${spi}"`, '').replace('>', '').replace(/^[^>]*>/, '');
        // Simpler: just rebuild the whole table body
        tbody.innerHTML = st.supports.map((sp, spIdx) => buildSpanRow(sp, spIdx, si)).join('');
    }
}

function structUpdateSupport(si, spi, field, value) {
    const st = KALYANTRA.data.structures[si];
    if (!st || !st.supports || !st.supports[spi]) return;
    st.supports[spi][field] = value;
    KALYANTRA.save();
}

function structDeleteSupportRow(si, spi) {
    const st = KALYANTRA.data.structures[si];
    if (!st || !st.supports) return;
    st.supports.splice(spi, 1);
    KALYANTRA.save();
    const tbody = document.getElementById(`spanTableBody_${si}`);
    if (tbody) {
        tbody.innerHTML = st.supports.length === 0
            ? `<tr><td colspan="6" style="text-align:center;padding:16px;color:var(--text-secondary);font-style:italic;">No supports yet</td></tr>`
            : st.supports.map((sp, spIdx) => buildSpanRow(sp, spIdx, si)).join('');
    }
}

function structSaveCard(si) {
    const st = KALYANTRA.data.structures[si];
    if (!st) return;
    st.name = document.getElementById('stName').value.trim() || 'Structure';
    st.type = document.getElementById('stType').value;
    st.chainage = parseChT(document.getElementById('stChainage').value);
    st.gadStatus = document.getElementById('stGAD').value;
    st.workingDrawStatus = document.getElementById('stWD').value;
    st.approvalStatus = document.getElementById('stApproval').value;
    st.progressPct = Math.min(100, Math.max(0, parseInt(document.getElementById('stPct').value) || 0));
    st.targetDate = document.getElementById('stTarget').value;
    st.hindranceId = document.getElementById('stHindrance').value;
    st.notes = document.getElementById('stNotes').value.trim();
    // supports auto-saved via structUpdateSupport onChange ‚Äî just recalc totalLength
    st.totalLength = (st.supports || []).slice(0, -1).reduce((s, sp) => s + (sp.spanLength || 0), 0);
    KALYANTRA.save();
    document.getElementById('structEditModal').remove();
    renderStructuresList();
    showToast('‚úÖ ' + st.name + ' saved', 'success');
}

// ‚îÄ‚îÄ STRUCTURE BOQ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STRUCT_BOQ_PRESETS = [
    {id:'excavation',    label:'Excavation incl. dewatering',       unit:'Cum'},
    {id:'pcc',           label:'PCC Levelling Course',               unit:'Cum'},
    {id:'foundation',    label:'Foundation RCC (Open Fdn)',          unit:'Cum'},
    {id:'piling',        label:'Pile Boring & Casting (dia √ó length)',unit:'Nos'},
    {id:'pile_cap',      label:'Pile Cap / Tie Beam',                unit:'Cum'},
    {id:'well',          label:'Well Steining',                      unit:'Cum'},
    {id:'well_cap',      label:'Well Cap',                           unit:'Cum'},
    {id:'substructure',  label:'Substructure (Abutment/Pier Wall)',  unit:'Cum'},
    {id:'pier_cap',      label:'Pier Cap',                           unit:'Cum'},
    {id:'girder_casting',label:'PSC / Precast Girder Casting',       unit:'Nos'},
    {id:'girder_erection',label:'Girder Erection',                   unit:'Nos'},
    {id:'steel_fab',     label:'Steel Girder Fabrication',           unit:'MT'},
    {id:'steel_erect',   label:'Steel Girder Erection',              unit:'MT'},
    {id:'staging',       label:'Staging & Shuttering',               unit:'Sqm'},
    {id:'reinforcement', label:'Reinforcement (Rebar)',               unit:'MT'},
    {id:'concreting',    label:'Structural Concreting',               unit:'Cum'},
    {id:'deck_slab',     label:'Deck Slab',                          unit:'Cum'},
    {id:'superstructure',label:'Superstructure (General)',            unit:'Cum'},
    {id:'approach',      label:'Approach Road & Protection Works',    unit:'RMT'},
    {id:'misc',          label:'Miscellaneous & Finishing',           unit:'LS'},
];


function structProgressModal(si) {
    const st = KALYANTRA.data.structures[si]; if (!st) return;
    const ex = document.getElementById('structProgressModal'); if (ex) ex.remove();
    const hindOpts = '<option value="">‚Äî None ‚Äî</option>' +
        (KALYANTRA.data.hindrances||[]).filter(h=>h.status!=='Resolved')
        .map(h=>`<option value="${h.id}" ${st.hindranceId==h.id?'selected':''}>${h.name}</option>`).join('');
    const modal = document.createElement('div');
    modal.id = 'structProgressModal';
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
    modal.innerHTML = `
    <div style="background:#fff;border-radius:10px;padding:22px;width:480px;max-width:97vw;box-shadow:0 20px 50px rgba(0,0,0,0.3);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;padding-bottom:10px;border-bottom:2px solid var(--accent-gold);">
            <div>
                <div style="font-weight:700;color:var(--navy);font-size:0.95rem;">üìä Update Progress ‚Äî ${st.name}</div>
                <div style="font-size:0.7rem;color:var(--text-secondary);margin-top:2px;">üîí Frozen. Only progress fields editable.</div>
            </div>
            <button onclick="document.getElementById('structProgressModal').remove()" style="background:none;border:none;font-size:1.1rem;cursor:pointer;">‚úï</button>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
            <div><label style="font-size:0.72rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">Physical Progress (%)</label>
            <input id="spPct" type="number" value="${st.progressPct||0}" min="0" max="100"
                style="width:100%;padding:7px;border:1.5px solid #cbd5e1;border-radius:5px;font-size:1rem;font-weight:700;color:#15803d;box-sizing:border-box;text-align:center;"></div>
            <div><label style="font-size:0.72rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">Target Completion</label>
            <input id="spTarget" type="month" value="${st.targetDate||''}"
                style="width:100%;padding:7px;border:1.5px solid #cbd5e1;border-radius:5px;font-size:0.82rem;box-sizing:border-box;"></div>
        </div>
        <div style="margin-bottom:10px;"><label style="font-size:0.72rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">Blocking Hindrance</label>
        <select id="spHindrance" style="width:100%;padding:7px;border:1.5px solid #cbd5e1;border-radius:5px;font-size:0.78rem;box-sizing:border-box;">${hindOpts}</select></div>
        <div style="margin-bottom:14px;"><label style="font-size:0.72rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">Site Remarks</label>
        <input id="spNotes" type="text" value="${st.notes||''}" placeholder="Latest site update..."
            style="width:100%;padding:7px;border:1.5px solid #cbd5e1;border-radius:5px;font-size:0.82rem;box-sizing:border-box;"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <button onclick="structUnfreezeCard(${si});document.getElementById('structProgressModal').remove();"
                style="padding:7px 14px;border:1.5px solid #d97706;background:#fff;color:#d97706;border-radius:5px;cursor:pointer;font-size:0.8rem;font-weight:600;">üîì Unfreeze to Edit</button>
            <div style="display:flex;gap:8px;">
                <button onclick="document.getElementById('structProgressModal').remove()"
                    style="padding:8px 16px;border:1.5px solid #cbd5e1;background:#fff;border-radius:5px;cursor:pointer;font-size:0.82rem;">Cancel</button>
                <button onclick="structSaveProgress(${si})"
                    style="padding:8px 20px;background:var(--navy);color:var(--accent-gold);border:none;border-radius:5px;font-weight:700;cursor:pointer;font-size:0.85rem;">üíæ Save</button>
            </div>
        </div>
    </div>`;
    document.body.appendChild(modal);
}
function structSaveProgress(si) {
    const st = KALYANTRA.data.structures[si]; if (!st) return;
    st.progressPct = Math.min(100, Math.max(0, parseInt(document.getElementById('spPct').value)||0));
    st.targetDate = document.getElementById('spTarget').value;
    st.hindranceId = document.getElementById('spHindrance').value;
    st.notes = document.getElementById('spNotes').value.trim();
    KALYANTRA.save();
    document.getElementById('structProgressModal').remove();
    renderStructuresList();
    showToast('‚úÖ Progress updated ‚Äî ' + st.progressPct + '%', 'success');
}

function structBOQAddItem(si) {
    const st = KALYANTRA.data.structures[si]; if (!st) return;
    const ex = document.getElementById('structBOQModal2'); if (ex) ex.remove();
    const boqData = ensureBOQ();
    const existing = (boqData.structureBOQ.find(s=>s.structureId==st.id)||{items:[]}).items;
    const usedIds = existing.map(i=>i.presetId).filter(Boolean);
    const available = STRUCT_BOQ_PRESETS.filter(p=>!usedIds.includes(p.id));
    const modal = document.createElement('div');
    modal.id = 'structBOQModal2';
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
    const presetRows = available.map(p=>`
        <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:#f5f3ff;border:1px solid #ddd6fe;border-radius:4px;margin-bottom:3px;gap:8px;">
            <div style="flex:1;"><div style="font-weight:600;font-size:0.77rem;color:#6d28d9;">${p.label}</div><div style="font-size:0.65rem;color:#7c3aed;">${p.unit}</div></div>
            <input type="number" id="pQty_${p.id}" placeholder="Qty" style="width:75px;padding:4px 6px;border:1px solid #ddd6fe;border-radius:3px;font-size:0.78rem;text-align:right;">
            <input type="number" id="pRate_${p.id}" placeholder="Rate ‚Çπ" style="width:90px;padding:4px 6px;border:1px solid #ddd6fe;border-radius:3px;font-size:0.78rem;text-align:right;">
            <button onclick="structBOQAddPreset(${si},'${p.id}','${p.label}','${p.unit}')"
                style="background:#7c3aed;color:#fff;border:none;padding:4px 11px;border-radius:3px;font-size:0.72rem;cursor:pointer;font-weight:700;white-space:nowrap;">+ Add</button>
        </div>`).join('');
    modal.innerHTML = `
    <div style="background:#fff;border-radius:10px;padding:22px;width:560px;max-width:97vw;max-height:88vh;overflow-y:auto;box-shadow:0 20px 50px rgba(0,0,0,0.3);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:10px;border-bottom:2px solid #7c3aed;">
            <div>
                <div style="font-weight:700;color:#7c3aed;font-size:0.95rem;">üåâ Structure BOQ ‚Äî ${st.name}</div>
                <div style="font-size:0.69rem;color:var(--text-secondary);margin-top:2px;">BOQ Qty √∑ Productivity Rate = Activity Duration. Enter both Qty + Rate.</div>
            </div>
            <button onclick="document.getElementById('structBOQModal2').remove()" style="background:none;border:none;font-size:1.1rem;cursor:pointer;">‚úï</button>
        </div>
        ${available.length>0?`<div style="margin-bottom:12px;"><div style="font-size:0.71rem;font-weight:700;color:#7c3aed;margin-bottom:5px;">Standard Line Items (Qty √ó Rate = Amount):</div>${presetRows}</div>`:'<div style="font-size:0.78rem;color:var(--text-secondary);margin-bottom:10px;">All standard items added.</div>'}
        <div style="background:#faf5ff;border-radius:6px;padding:11px;">
            <div style="font-size:0.71rem;font-weight:700;color:#7c3aed;margin-bottom:7px;">Custom Item:</div>
            <div style="display:grid;grid-template-columns:1fr 70px 100px;gap:8px;align-items:end;">
                <div><label style="font-size:0.7rem;font-weight:600;color:var(--navy);display:block;margin-bottom:2px;">Description</label>
                <input id="sb2Desc" type="text" placeholder="e.g. Anti-scour works"
                    style="width:100%;padding:6px 8px;border:1.5px solid var(--border-medium);border-radius:4px;font-size:0.82rem;box-sizing:border-box;"></div>
                <div><label style="font-size:0.7rem;font-weight:600;color:var(--navy);display:block;margin-bottom:2px;">Unit</label>
                <select id="sb2Unit" style="width:100%;padding:6px 8px;border:1.5px solid var(--border-medium);border-radius:4px;font-size:0.8rem;box-sizing:border-box;">
                    <option>Cum</option><option>Sqm</option><option>MT</option><option>RMT</option><option>Nos</option><option>LS</option>
                </select></div>
                <div><label style="font-size:0.7rem;font-weight:600;color:var(--navy);display:block;margin-bottom:2px;">Amount (‚Çπ Lakhs)</label>
                <input id="sb2Amount" type="number" placeholder="0.00"
                    style="width:100%;padding:6px 8px;border:1.5px solid var(--border-medium);border-radius:4px;font-size:0.82rem;box-sizing:border-box;"></div>
            </div>
            <div style="text-align:right;margin-top:8px;">
                <button onclick="structBOQSaveCustom2(${si})"
                    style="padding:6px 16px;background:#7c3aed;color:#fff;border:none;border-radius:4px;font-weight:700;cursor:pointer;font-size:0.82rem;">+ Add Custom</button>
            </div>
        </div>
        <div style="text-align:right;margin-top:12px;">
            <button onclick="document.getElementById('structBOQModal2').remove()"
                style="padding:8px 22px;background:var(--navy);color:var(--accent-gold);border:none;border-radius:6px;font-weight:700;cursor:pointer;font-size:0.85rem;">‚úÖ Done</button>
        </div>
    </div>`;
    document.body.appendChild(modal);
}

function structBOQAddPreset(si, presetId, label, unit) {
    const qty = parseFloat(document.getElementById('pQty_'+presetId)?.value) || 0;
    const rate = parseFloat(document.getElementById('pRate_'+presetId)?.value) || 0;
    if (!qty && !rate) { showToast('Enter Qty and/or Rate first', 'info'); return; }
    const st = KALYANTRA.data.structures[si]; if (!st) return;
    ensureBOQ();
    let sb = KALYANTRA.data.boq.structureBOQ.find(s=>s.structureId==st.id);
    if (!sb) { sb = {structureId:st.id,structureName:st.name,chainage:st.chainage,items:[]}; KALYANTRA.data.boq.structureBOQ.push(sb); }
    sb.items.push({presetId, description:label, unit, qty, rate, earnedQty:0});
    KALYANTRA.save(); renderStructuresList();
    document.getElementById('structBOQModal2').remove();
    setTimeout(() => structBOQAddItem(si), 60);
    showToast('‚úÖ '+label+' added', 'success');
}
function structBOQSaveCustom2(si) {
    const desc = document.getElementById('sb2Desc').value.trim();
    if (!desc) { showToast('Enter description', 'error'); return; }
    const amt = parseFloat(document.getElementById('sb2Amount').value) || 0;
    const st = KALYANTRA.data.structures[si]; if (!st) return;
    ensureBOQ();
    let sb = KALYANTRA.data.boq.structureBOQ.find(s=>s.structureId==st.id);
    if (!sb) { sb = {structureId:st.id,structureName:st.name,chainage:st.chainage,items:[]}; KALYANTRA.data.boq.structureBOQ.push(sb); }
    sb.items.push({description:desc, unit:document.getElementById('sb2Unit').value, qty:1, rate:amt*100000, earnedQty:0});
    KALYANTRA.save(); document.getElementById('structBOQModal2').remove(); renderStructuresList();
    showToast('‚úÖ Item added', 'success');
}
function structBOQDeleteItem2(si, ii) {
    const st = KALYANTRA.data.structures[si]; if (!st) return;
    const sb = (KALYANTRA.data.boq?.structureBOQ||[]).find(s=>s.structureId==st.id);
    if (sb) { sb.items.splice(ii,1); KALYANTRA.save(); renderStructuresList(); }
}
function structBOQSave2(si) { structBOQSaveCustom2(si); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TCS ENGINE (unchanged from V2 ‚Äî kept for completeness)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderTCSCards(){
    const boq=ensureBOQ(); const tcsList=boq.tcsList||[];
    const empty=document.getElementById('tcsEmptyState');
    const list=document.getElementById('tcsCardsList');
    const summary=document.getElementById('boqSummaryBar');
    const wholeBOQ=document.getElementById('wholeProjectBOQ');
    if(!list)return;
    if(tcsList.length===0){if(empty)empty.style.display='block';list.innerHTML='';if(summary)summary.style.display='none';if(wholeBOQ)wholeBOQ.style.display='none';return;}
    if(empty)empty.style.display='none';if(summary)summary.style.display='flex';
    let html='';
    tcsList.forEach((tcs,ti)=>{
        const elements=tcs.elements||{};
        const checkedEls=getAllTCSItems().filter(i=>(elements[i.id]||{}).included);
        const locations=tcs.locations||[];
        const boqItems=tcs.boqItems||[];
        const totalLen=locations.reduce((s,l)=>s+(l.toCh-l.fromCh),0);
        const totalAmt=boqItems.reduce((s,i)=>s+(totalLen*(i.rate||0)),0);
        const frozen=tcs.frozen===true;
        html+=`<div id="tcsCard_${ti}" style="background:#fff;border:1px solid var(--border-light);border-radius:8px;padding:14px;margin-bottom:10px;border-left:4px solid ${frozen?'#16a34a':'var(--navy)'};">
            <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:12px;">
                <div style="display:flex;align-items:center;gap:10px;">
                    <div style="background:var(--navy);color:var(--accent-gold);padding:3px 9px;border-radius:4px;font-size:0.7rem;font-weight:700;">TCS-${ti+1}</div>
                    <div>
                        <div style="font-weight:700;color:var(--navy);font-size:0.92rem;">${tcs.name||'Unnamed TCS'}</div>
                        <div style="font-size:0.71rem;color:var(--text-secondary);">${checkedEls.length} elements | ${locations.length} location(s) | ${(totalLen/1000).toFixed(3)} km | ${boqItems.length} BOQ items | <span style="color:${(tcs.pavementLayers||[]).length>0?'#059669':'#dc2626'};font-weight:600;">üèóÔ∏è ${(tcs.pavementLayers||[]).length} layer${(tcs.pavementLayers||[]).length!==1?'s':''}</span>${frozen?' | <span style="color:#16a34a;font-weight:700;">üîí FROZEN</span>':''}</div>
                    </div>
                </div>
                <div style="display:flex;gap:6px;flex-wrap:wrap;">
                    ${!frozen?`<button onclick="tcsEditCard(${ti})" style="background:#e0f2fe;color:#0369a1;border:none;padding:5px 10px;border-radius:4px;font-size:0.73rem;cursor:pointer;font-weight:600;">‚úèÔ∏è Edit</button><button onclick="tcsFreezeCard(${ti})" style="background:#dcfce7;color:#15803d;border:none;padding:5px 10px;border-radius:4px;font-size:0.73rem;cursor:pointer;font-weight:700;">üîí Freeze</button>`:`<button onclick="tcsUnfreezeCard(${ti})" style="background:#fef9c3;color:#92400e;border:none;padding:5px 10px;border-radius:4px;font-size:0.73rem;cursor:pointer;">üîì Unfreeze</button>`}
                    <button onclick="tcsDeleteCard(${ti})" style="background:#fee2e2;color:#dc2626;border:none;padding:5px 10px;border-radius:4px;font-size:0.73rem;cursor:pointer;font-weight:600;">üóëÔ∏è Delete</button>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <!-- LEFT: Pavement Crust Summary -->
                <div style="background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border-radius:8px;padding:12px;border:1px solid #bae6fd;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                        <div style="font-size:0.67rem;font-weight:800;text-transform:uppercase;letter-spacing:0.07em;color:#0369a1;">üèóÔ∏è Pavement Crust</div>
                        ${!frozen?`<button onclick="openTCSLayerEditor(${ti})" style="background:#0369a1;color:#fff;border:none;padding:2px 9px;border-radius:4px;font-size:0.67rem;cursor:pointer;font-weight:700;">Edit Layers ‚ñº</button>`:''}
                    </div>
                    ${(()=>{
                        const layers = tcs.pavementLayers||[];
                        if(!layers.length) return '<div style="color:#64748b;font-size:0.75rem;font-style:italic;">No layers defined ‚Äî click Edit Layers</div>';
                        const totalThk = layers.reduce((s,l)=>s+(parseInt(l.thickness)||0),0);
                        return '<div style="font-size:0.7rem;color:#0c4a6e;font-weight:600;margin-bottom:6px;">'+layers.length+' layers ¬∑ '+totalThk+'mm total crust</div>'
                            +layers.map(l=>'<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0;border-bottom:1px solid #e0f2fe;"><span style="font-size:0.72rem;color:#1B3B6F;font-weight:500;">'+( l.name||l.code||'Layer')+'</span><span style="font-size:0.7rem;color:#0369a1;font-weight:700;">'+( l.thickness||'‚Äî')+'mm</span></div>').join('');
                    })()}
                </div>
                <div style="background:linear-gradient(135deg,#eff6ff,#e0e7ff);border-radius:8px;padding:12px;border:1px solid #c7d2fe;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                        <div style="font-size:0.67rem;font-weight:800;text-transform:uppercase;letter-spacing:0.07em;color:#3730a3;">üìç Chainage Locations</div>
                        <div style="display:flex;gap:6px;align-items:center;">
                            ${!frozen?`<button onclick="tcsAddLocation(${ti})" style="background:#3730a3;color:#fff;border:none;padding:2px 9px;border-radius:4px;font-size:0.67rem;cursor:pointer;font-weight:700;">+ Add</button>`:''}
                            <a href="#" onclick="sidebarSwitchTab(6,null);return false;" style="font-size:0.67rem;color:#6366f1;font-weight:600;text-decoration:none;">‚Üí BOQ</a>
                        </div>
                    </div>${locations.length===0?'<div style="color:var(--text-secondary);font-size:0.73rem;font-style:italic;">No locations yet</div>':locations.map((loc,li)=>`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;background:#dbeafe;border-radius:3px;padding:3px 8px;"><div><span style="font-size:0.75rem;font-weight:600;color:#1e40af;">Ch ${fmtChT(loc.fromCh)}‚Äì${fmtChT(loc.toCh)}</span>${loc.note?`<div style="font-size:0.64rem;color:#3b82f6;">${loc.note}</div>`:''}</div><div style="display:flex;align-items:center;gap:4px;"><span style="font-size:0.67rem;color:#1d4ed8;">${((loc.toCh-loc.fromCh)/1000).toFixed(3)}km</span>${!frozen?`<button onclick="tcsDeleteLocation(${ti},${li})" style="background:none;border:none;color:#dc2626;cursor:pointer;font-size:0.7rem;padding:0;">‚úï</button>`:''}</div></div>`).join('')}</div>
                ${!frozen?`<button onclick="tcsAddBOQItem(${ti})" style="background:#15803d;color:#fff;border:none;padding:2px 8px;border-radius:3px;font-size:0.67rem;cursor:pointer;font-weight:600;">+ Add</button>`:''}</div>${boqItems.length===0?'<div style="color:var(--text-secondary);font-size:0.73rem;font-style:italic;">No items yet</div>':boqItems.map((it,ii)=>`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:3px;gap:4px;"><span style="font-size:0.71rem;color:#166534;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${it.description}</span><span style="font-size:0.68rem;color:#15803d;white-space:nowrap;">‚Çπ${(it.rate||0).toLocaleString()}/${it.unit}</span>${!frozen?`<button onclick="tcsDeleteBOQItem(${ti},${ii})" style="background:none;border:none;color:#dc2626;cursor:pointer;font-size:0.7rem;padding:0;">‚úï</button>`:''}</div>`).join('')}${boqItems.length>0&&totalLen>0?`<div style="margin-top:6px;padding-top:5px;border-top:1px solid #bbf7d0;font-size:0.71rem;font-weight:700;color:#15803d;">Total: ‚Çπ${(totalAmt/100000).toFixed(2)}L (${(totalLen/1000).toFixed(2)}km)</div>`:''}</div>
            </div>
        </div>`;
    });
    list.innerHTML=html;
    renderProjectBOQTable();
    updateTCSSummary();
}
function tcsAddNew(){const boq=ensureBOQ();const n=boq.tcsList.length+1;boq.tcsList.push({id:'tcs_'+Date.now(),name:'TCS-'+n,roadCategory:'NH/SH',constType:'New',elements:{},locations:[],boqItems:[],frozen:false});KALYANTRA.save();renderTCSCards();setTimeout(()=>tcsEditCard(boq.tcsList.length-1),80);}
function tcsDeleteCard(ti){if(!confirm('Delete TCS-'+(ti+1)+'?'))return;ensureBOQ().tcsList.splice(ti,1);KALYANTRA.save();renderTCSCards();showToast('üóëÔ∏è TCS deleted','info');}
function tcsFreezeCard(ti){const t=ensureBOQ().tcsList[ti];if(!t)return;if(!(t.locations||[]).length){showToast('Add at least one location before freezing','info');return;}t.frozen=true;KALYANTRA.save();renderTCSCards();showToast('üîí TCS-'+(ti+1)+' frozen','success');}
function tcsUnfreezeCard(ti){const t=ensureBOQ().tcsList[ti];if(t){t.frozen=false;KALYANTRA.save();renderTCSCards();showToast('üîì TCS unlocked','info');}}
function tcsEditCard(ti){
    const tcs=ensureBOQ().tcsList[ti];if(!tcs)return;
    if(tcs.frozen){showToast('üîí TCS is frozen. Unfreeze to edit parameters.','info');return;}
    const ex=document.getElementById('tcsEditModal');if(ex)ex.remove();
    const elements=tcs.elements||{};
    let elemHtml='';
    TCS_ELEMENTS.forEach(grp=>{
        elemHtml+=`<div style="margin-bottom:10px;"><div style="font-size:0.67rem;font-weight:800;text-transform:uppercase;letter-spacing:0.07em;color:var(--navy);padding:3px 8px;background:#f0f4ff;border-left:3px solid var(--navy);margin-bottom:4px;">${grp.group}</div>`;
        grp.items.forEach(item=>{const st=elements[item.id]||{};const chk=st.included===true;
            elemHtml+=`<div style="display:grid;grid-template-columns:20px 1fr 130px 50px;align-items:center;gap:8px;padding:4px 8px;border-radius:4px;${chk?'background:#f0fdf4;border:1px solid #bbf7d0;':''}margin-bottom:2px;" id="tcsMRow_${item.id}">
                <input type="checkbox" ${chk?'checked':''} onchange="tcsToggleEl('${item.id}',this.checked,${ti})">
                <div style="font-size:0.78rem;font-weight:${chk?'600':'400'};color:${chk?'var(--navy)':'var(--text-secondary)'};">${item.name}</div>
                <input type="text" value="${st.size!==undefined?st.size:item.defaultSize}" placeholder="${item.sizeLabel}" onchange="tcsUpdateSize('${item.id}',this.value,${ti})"
                    style="padding:3px 6px;border:1px solid var(--border-light);border-radius:3px;font-size:0.74rem;${chk?'':'opacity:0.35;'}">
                <div style="font-size:0.65rem;color:var(--text-secondary);">${item.unit||item.sizeLabel.split(' ')[0]}</div>
            </div>`;
        });
        elemHtml+='</div>';
    });
    const tmplOpts=Object.entries(TCS_TEMPLATES).map(([k,v])=>`<option value="${k}">${v.ref}</option>`).join('');
    const modal=document.createElement('div');modal.id='tcsEditModal';modal.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.55);z-index:9999;display:flex;align-items:flex-start;justify-content:center;padding-top:30px;overflow-y:auto;';
    modal.innerHTML=`
    <div style="background:#fff;border-radius:10px;padding:24px;width:680px;max-width:97vw;box-shadow:0 20px 60px rgba(0,0,0,0.3);margin-bottom:40px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:10px;border-bottom:2px solid var(--accent-gold);">
            <div style="font-weight:700;color:var(--navy);font-size:1rem;">‚úèÔ∏è TCS-${ti+1} ‚Äî Parameters</div>
            <button onclick="document.getElementById('tcsEditModal').remove()" style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:#64748b;">‚úï</button>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px;background:#f8fafc;padding:12px;border-radius:8px;">
            <div style="grid-column:span 2;"><label style="font-size:0.72rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">TCS Name</label>
            <input id="tcsModalName" type="text" value="${tcs.name||''}" placeholder="e.g. TCS-1 4-Lane Plain Section" onchange="tcsModalSaveName(${ti},this.value)"
                style="width:100%;padding:7px 9px;border:1.5px solid var(--border-medium);border-radius:5px;font-size:0.84rem;box-sizing:border-box;"></div>
            <div><label style="font-size:0.72rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">Construction</label>
            <select id="tcsModalConst" onchange="tcsModalSaveField(${ti},'constType',this.value)"
                style="width:100%;padding:7px 9px;border:1.5px solid var(--border-medium);border-radius:5px;font-size:0.82rem;box-sizing:border-box;">
                <option ${tcs.constType==='New'?'selected':''}>New</option><option ${tcs.constType==='Widening'?'selected':''}>Widening</option><option ${tcs.constType==='Overlay'?'selected':''}>Overlay</option>
            </select></div>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center;">
            <select id="tcsModalTemplate" style="flex:1;padding:6px 9px;border:1.5px solid var(--border-medium);border-radius:5px;font-size:0.8rem;"><option value="">‚Äî Load IRC Standard Template ‚Äî</option>${tmplOpts}</select>
            <button onclick="tcsLoadTemplate(${ti})" style="background:var(--accent-gold);color:#1B3B6F;border:none;padding:7px 16px;border-radius:5px;font-weight:700;font-size:0.8rem;cursor:pointer;">‚ö° Load</button>
        </div>
        <div style="font-size:0.72rem;font-weight:700;color:var(--navy);margin-bottom:6px;">Parameters <span style="font-weight:400;color:var(--text-secondary);font-size:0.68rem;">(check applicable, enter reference size)</span></div>
        <div style="max-height:300px;overflow-y:auto;border:1px solid var(--border-light);border-radius:6px;padding:8px;" id="tcsModalEls_${ti}">${elemHtml}</div>
        <div style="text-align:right;margin-top:14px;"><button onclick="document.getElementById('tcsEditModal').remove()" style="padding:9px 22px;background:var(--navy);color:var(--accent-gold);border:none;border-radius:6px;font-weight:700;cursor:pointer;font-size:0.87rem;">‚úÖ Done</button></div>
    </div>`;
    document.body.appendChild(modal);
}
function tcsModalSaveName(ti,v){const t=ensureBOQ().tcsList[ti];if(t){t.name=v;KALYANTRA.save();renderTCSCards();}}
function tcsModalSaveField(ti,f,v){const t=ensureBOQ().tcsList[ti];if(t){t[f]=v;KALYANTRA.save();}}
function tcsToggleEl(id,checked,ti){const t=ensureBOQ().tcsList[ti];if(!t)return;if(!t.elements)t.elements={};const el=getAllTCSItems().find(i=>i.id===id);if(!t.elements[id])t.elements[id]={size:el?el.defaultSize:''};t.elements[id].included=checked;KALYANTRA.save();renderTCSCards();const row=document.getElementById('tcsMRow_'+id);if(row){row.style.background=checked?'#f0fdf4':'';row.style.border=checked?'1px solid #bbf7d0':'';};}
function tcsUpdateSize(id,v,ti){const t=ensureBOQ().tcsList[ti];if(!t)return;if(!t.elements)t.elements={};if(!t.elements[id])t.elements[id]={};t.elements[id].size=v;KALYANTRA.save();}
function tcsLoadTemplate(ti){const sel=document.getElementById('tcsModalTemplate');if(!sel||!sel.value)return;const tmpl=TCS_TEMPLATES[sel.value];if(!tmpl)return;const t=ensureBOQ().tcsList[ti];if(!t)return;if(!t.elements)t.elements={};tmpl.elements.forEach(id=>{const el=getAllTCSItems().find(i=>i.id===id);t.elements[id]={included:true,size:(tmpl.sizes&&tmpl.sizes[id])||el?.defaultSize||''};});KALYANTRA.save();document.getElementById('tcsEditModal').remove();renderTCSCards();setTimeout(()=>tcsEditCard(ti),80);showToast('‚úÖ Loaded: '+tmpl.ref,'success');}
function tcsAddLocation(ti){const ex=document.getElementById('tcsLocModal');if(ex)ex.remove();const p=KALYANTRA.data.project||{};const modal=document.createElement('div');modal.id='tcsLocModal';modal.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';modal.innerHTML=`<div style="background:#fff;border-radius:10px;padding:22px;width:380px;max-width:96vw;box-shadow:0 20px 50px rgba(0,0,0,0.3);"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;padding-bottom:10px;border-bottom:2px solid #1d4ed8;"><div style="font-weight:700;color:#1d4ed8;font-size:0.95rem;">üìç Add Location</div><button onclick="document.getElementById('tcsLocModal').remove()" style="background:none;border:none;font-size:1.1rem;cursor:pointer;">‚úï</button></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;"><div><label style="font-size:0.72rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">From Chainage</label><input id="locFrom" type="text" placeholder="${fmtChT(p.startChainage||0)}" style="width:100%;padding:7px 9px;border:1.5px solid var(--border-medium);border-radius:5px;font-size:0.84rem;box-sizing:border-box;"></div><div><label style="font-size:0.72rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">To Chainage</label><input id="locTo" type="text" placeholder="${fmtChT(p.endChainage||5000)}" style="width:100%;padding:7px 9px;border:1.5px solid var(--border-medium);border-radius:5px;font-size:0.84rem;box-sizing:border-box;"></div></div><div style="margin-bottom:14px;"><label style="font-size:0.72rem;font-weight:600;color:var(--navy);display:block;margin-bottom:3px;">Notes</label><input id="locNote" type="text" placeholder="e.g. Hill section, Urban stretch" style="width:100%;padding:7px 9px;border:1.5px solid var(--border-medium);border-radius:5px;font-size:0.84rem;box-sizing:border-box;"></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button onclick="document.getElementById('tcsLocModal').remove()" style="padding:8px 14px;border:1.5px solid var(--border-medium);background:#fff;border-radius:5px;cursor:pointer;font-size:0.82rem;font-weight:600;">Cancel</button><button onclick="tcsLocSave(${ti})" style="padding:8px 18px;background:#1d4ed8;color:#fff;border:none;border-radius:5px;font-weight:700;cursor:pointer;font-size:0.84rem;">Add Location</button></div></div>`;document.body.appendChild(modal);}
function tcsLocSave(ti){const fromCh=parseChT(document.getElementById('locFrom').value);const toCh=parseChT(document.getElementById('locTo').value);const note=document.getElementById('locNote').value.trim();if(toCh<=fromCh){showToast('To chainage must be > From chainage','error');return;}const t=ensureBOQ().tcsList[ti];if(!t)return;if(!t.locations)t.locations=[];t.locations.push({fromCh,toCh,note});KALYANTRA.save();document.getElementById('tcsLocModal').remove();renderTCSCards();showToast('‚úÖ Location added','success');}
function tcsDeleteLocation(ti,li){const t=ensureBOQ().tcsList[ti];if(t&&t.locations){t.locations.splice(li,1);KALYANTRA.save();renderTCSCards();}}
function tcsAddBOQItem(ti){const t=ensureBOQ().tcsList[ti];if(!t)return;const checkedEls=getAllTCSItems().filter(i=>(t.elements||{})[i.id]?.included);const ex=document.getElementById('tcsBOQModal');if(ex)ex.remove();const modal=document.createElement('div');modal.id='tcsBOQModal';modal.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';const existDesc=(t.boqItems||[]).map(i=>i.activityLink);const suggestions=checkedEls.filter(el=>!existDesc.includes(el.id));const suggRows=suggestions.map(el=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:4px;margin-bottom:3px;"><div><span style="font-weight:600;font-size:0.77rem;color:#166534;">${el.name}</span><span style="font-size:0.67rem;color:#16a34a;margin-left:6px;">${el.boqUnit} | ${el.ref}</span></div><button onclick="tcsBOQAccept('${el.id}','${el.name}','${el.boqUnit}',${ti})" style="background:#16a34a;color:#fff;border:none;padding:3px 10px;border-radius:4px;font-size:0.7rem;cursor:pointer;font-weight:600;white-space:nowrap;">+ Use</button></div>`).join('');
modal.innerHTML=`<div style="background:#fff;border-radius:10px;padding:22px;width:520px;max-width:97vw;max-height:88vh;overflow-y:auto;box-shadow:0 20px 50px rgba(0,0,0,0.3);"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;padding-bottom:10px;border-bottom:2px solid #15803d;"><div style="font-weight:700;color:#15803d;font-size:0.95rem;">üì¶ Add BOQ Item</div><button onclick="document.getElementById('tcsBOQModal').remove()" style="background:none;border:none;font-size:1.1rem;cursor:pointer;">‚úï</button></div>${suggestions.length>0?`<div style="margin-bottom:14px;"><div style="font-size:0.72rem;font-weight:700;color:#15803d;margin-bottom:6px;">üí° Suggested from TCS Elements:</div>${suggRows}</div>`:''}<div style="background:#f8fafc;border-radius:6px;padding:12px;"><div style="font-size:0.72rem;font-weight:700;color:var(--navy);margin-bottom:8px;">Custom Item:</div><div style="display:grid;gap:8px;"><div style="display:grid;grid-template-columns:80px 1fr;gap:8px;"><div><label style="font-size:0.71rem;font-weight:600;color:var(--navy);display:block;margin-bottom:2px;">Item No</label><input id="boqMNo" type="text" placeholder="301" style="width:100%;padding:5px 8px;border:1.5px solid var(--border-medium);border-radius:4px;font-size:0.82rem;box-sizing:border-box;"></div><div><label style="font-size:0.71rem;font-weight:600;color:var(--navy);display:block;margin-bottom:2px;">Description</label><input id="boqMDesc" type="text" placeholder="e.g. W-Beam Crash Barrier" style="width:100%;padding:5px 8px;border:1.5px solid var(--border-medium);border-radius:4px;font-size:0.82rem;box-sizing:border-box;"></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;"><div><label style="font-size:0.71rem;font-weight:600;color:var(--navy);display:block;margin-bottom:2px;">Unit</label><select id="boqMUnit" style="width:100%;padding:5px 8px;border:1.5px solid var(--border-medium);border-radius:4px;font-size:0.82rem;box-sizing:border-box;"><option>RMT</option><option>Sqm</option><option>Cum</option><option>MT</option><option>Nos</option><option>LS</option></select></div><div><label style="font-size:0.71rem;font-weight:600;color:var(--navy);display:block;margin-bottom:2px;">Rate (‚Çπ/unit)</label><input id="boqMRate" type="number" placeholder="0" style="width:100%;padding:5px 8px;border:1.5px solid var(--border-medium);border-radius:4px;font-size:0.82rem;box-sizing:border-box;"></div></div></div><div style="text-align:right;margin-top:10px;"><button onclick="tcsBOQSaveCustom(${ti})" style="padding:7px 18px;background:var(--navy);color:var(--accent-gold);border:none;border-radius:5px;font-weight:700;cursor:pointer;font-size:0.83rem;">Add Item</button></div></div></div>`;
document.body.appendChild(modal);}
function tcsBOQAccept(elemId,name,unit,ti){const t=ensureBOQ().tcsList[ti];if(!t)return;if(!t.boqItems)t.boqItems=[];t.boqItems.push({itemNo:String(t.boqItems.length+1).padStart(3,'0'),description:name,unit,rate:0,activityLink:elemId});KALYANTRA.save();document.getElementById('tcsBOQModal').remove();renderTCSCards();showToast('‚úÖ '+name+' added','success');}
function tcsBOQSaveCustom(ti){const desc=document.getElementById('boqMDesc').value.trim();if(!desc){showToast('Enter description','error');return;}const t=ensureBOQ().tcsList[ti];if(!t)return;if(!t.boqItems)t.boqItems=[];t.boqItems.push({itemNo:document.getElementById('boqMNo').value.trim()||String(t.boqItems.length+1),description:desc,unit:document.getElementById('boqMUnit').value,rate:parseFloat(document.getElementById('boqMRate').value)||0,activityLink:''});KALYANTRA.save();document.getElementById('tcsBOQModal').remove();renderTCSCards();showToast('‚úÖ Item added','success');}
function tcsDeleteBOQItem(ti,ii){const t=ensureBOQ().tcsList[ti];if(t&&t.boqItems){t.boqItems.splice(ii,1);KALYANTRA.save();renderTCSCards();}}

function renderProjectBOQTable(){
    const wholeBOQ=document.getElementById('wholeProjectBOQ');const tableDiv=document.getElementById('projectBOQTable');
    if(!wholeBOQ||!tableDiv)return;
    const frozen=(ensureBOQ().tcsList||[]).filter(t=>t.frozen);
    if(frozen.length===0){wholeBOQ.style.display='none';return;}
    wholeBOQ.style.display='block';
    const rows=[];let grandTotal=0;
    frozen.forEach(tcs=>{
        const totalLen=(tcs.locations||[]).reduce((s,l)=>s+(l.toCh-l.fromCh),0);
        const locStr=(tcs.locations||[]).map(l=>'Ch '+fmtChT(l.fromCh)+'‚Äì'+fmtChT(l.toCh)).join(', ');
        (tcs.boqItems||[]).forEach(it=>{
            const amt=totalLen*(it.rate||0);grandTotal+=amt;
            rows.push(`<tr><td style="padding:5px 8px;font-size:0.71rem;color:var(--text-secondary);">${tcs.name}</td><td style="padding:5px 8px;font-size:0.71rem;color:var(--text-secondary);">${locStr}</td><td style="padding:5px 8px;font-size:0.74rem;">${it.itemNo||'‚Äî'}</td><td style="padding:5px 8px;font-size:0.77rem;font-weight:600;">${it.description}</td><td style="padding:5px 8px;text-align:center;font-size:0.74rem;">${it.unit}</td><td style="padding:5px 8px;text-align:right;font-size:0.74rem;">${(totalLen/1000).toFixed(3)} km</td><td style="padding:5px 8px;text-align:right;font-size:0.74rem;">‚Çπ${(it.rate||0).toLocaleString()}</td><td style="padding:5px 8px;text-align:right;font-weight:700;font-size:0.74rem;color:var(--navy);">‚Çπ${(amt/100000).toFixed(2)}L</td></tr>`);
        });
    });
    tableDiv.innerHTML=`<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;"><thead><tr style="background:var(--navy);color:#fff;"><th style="padding:7px 8px;text-align:left;font-size:0.72rem;">TCS</th><th style="padding:7px 8px;text-align:left;font-size:0.72rem;">Locations</th><th style="padding:7px 8px;font-size:0.72rem;">Item</th><th style="padding:7px 8px;text-align:left;font-size:0.72rem;">Description</th><th style="padding:7px 8px;text-align:center;font-size:0.72rem;">Unit</th><th style="padding:7px 8px;text-align:right;font-size:0.72rem;">Length</th><th style="padding:7px 8px;text-align:right;font-size:0.72rem;">Rate</th><th style="padding:7px 8px;text-align:right;font-size:0.72rem;">Amount</th></tr></thead><tbody>${rows.join('')}</tbody><tfoot><tr style="background:#f8fafc;font-weight:700;"><td colspan="7" style="padding:7px 8px;text-align:right;font-size:0.79rem;">PROJECT TOTAL BOQ:</td><td style="padding:7px 8px;text-align:right;font-size:0.92rem;color:var(--navy);">‚Çπ${(grandTotal/10000000).toFixed(3)} Cr</td></tr></tfoot></table></div>`;
}
function updateTCSSummary(){let total=0;(ensureBOQ().tcsList||[]).forEach(tcs=>{const len=(tcs.locations||[]).reduce((s,l)=>s+(l.toCh-l.fromCh),0);(tcs.boqItems||[]).forEach(it=>{total+=len*(it.rate||0);});});const setT=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};setT('boqTotalValue','‚Çπ'+(total/10000000).toFixed(2)+' Cr');}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function(){
    const orig = typeof sidebarSwitchTab==='function' ? sidebarSwitchTab : null;
    if (orig) {
        sidebarSwitchTab = function(index, item) {
            orig(index, item);
            if (index===1) setTimeout(()=>renderTCSCards(), 120);
            if (index===2) setTimeout(()=>renderStructuresList(), 120);
        };
    }
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => { renderTCSCards(); renderStructuresList(); renderHindranceTable(); }, 600);
    });
})();

</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KALYANTRA BOQ ENGINE ‚Äî Tab 7
// Single source of truth for all quantities and rates.
// Grouped by: Road Works (frozen TCS) | Structures (frozen Structures) | Misc
// NHAI format: Item No, Description, Unit, Qty, Rate, Amount
// Freeze BOQ ‚Üí triggers WBS generation in Activity Grid
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ DATA INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ensureBOQData() {
    if (!KALYANTRA.data.boqTab) {
        KALYANTRA.data.boqTab = {
            frozen: false,
            roadItems: [],    // { id, tcsId, tcsName, itemNo, description, unit, qty, rate }
            structItems: [],  // { id, structId, structName, itemNo, description, unit, qty, rate }
            miscItems: [],    // { id, itemNo, description, unit, qty, rate }
        };
    }
    return KALYANTRA.data.boqTab;
}

function boqAmt(item) {
    return (parseFloat(item.qty) || 0) * (parseFloat(item.rate) || 0);
}
function boqFmtCr(v) {
    return v >= 10000000 ? '‚Çπ' + (v/10000000).toFixed(2) + ' Cr'
         : v >= 100000   ? '‚Çπ' + (v/100000).toFixed(2) + ' L'
         : '‚Çπ' + Math.round(v).toLocaleString();
}
function boqNewId() { return 'bq_' + Date.now() + '_' + Math.random().toString(36).slice(2,6); }

// ‚îÄ‚îÄ MAIN RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderBOQTab() {
    const bd = ensureBOQData();
    const boq = ensureBOQ ? ensureBOQ() : (KALYANTRA.data.boq || {});
    const tcsList = (boq.tcsList || []).filter(t => t.frozen);
    const structs = (KALYANTRA.data.structures || []).filter(s => s.frozen);
    const allItems = [...bd.roadItems, ...bd.structItems, ...bd.miscItems];
    const grandTotal = allItems.reduce((s, i) => s + boqAmt(i), 0);
    const roadTotal = bd.roadItems.reduce((s, i) => s + boqAmt(i), 0);
    const structTotal = bd.structItems.reduce((s, i) => s + boqAmt(i), 0);
    const miscTotal = bd.miscItems.reduce((s, i) => s + boqAmt(i), 0);

    // Update header badges
    const setEl = (id, v) => { const el = document.getElementById(id); if (el) el.innerHTML = v; };
    setEl('boqContractBadge', grandTotal > 0
        ? 'Contract: ' + boqFmtCr(grandTotal)
        : 'Contract: ‚Äî');
    setEl('boqItemsBadge', allItems.length + ' items');
    setEl('boqStatusBadge', bd.frozen ? 'üîí FROZEN' : 'DRAFT');
    const statusBadge = document.getElementById('boqStatusBadge');
    if (statusBadge) {
        statusBadge.style.background = bd.frozen ? 'rgba(22,163,74,0.3)' : 'rgba(255,255,255,0.1)';
        statusBadge.style.borderColor = bd.frozen ? '#16a34a' : 'rgba(255,255,255,0.2)';
        statusBadge.style.color = bd.frozen ? '#4ade80' : '#fff';
    }
    const freezeBtn = document.getElementById('boqFreezeBtn');
    if (freezeBtn) freezeBtn.style.display = bd.frozen ? 'none' : '';
    const frozenNotice = document.getElementById('boqFrozenNotice');
    if (frozenNotice) frozenNotice.style.display = bd.frozen ? '' : 'none';

    // Grand total bar
    const gtDiv = document.getElementById('boqGrandTotal');
    if (gtDiv) {
        gtDiv.style.display = grandTotal > 0 ? '' : 'none';
        setEl('gtContractValue', boqFmtCr(grandTotal));
        setEl('gtRoadValue', boqFmtCr(roadTotal));
        setEl('gtStructValue', boqFmtCr(structTotal));
        setEl('gtMiscValue', boqFmtCr(miscTotal));
    }

    // Empty state
    const emptyDiv = document.getElementById('boqEmptyNotice');
    const hasSomething = tcsList.length > 0 || structs.length > 0 || bd.miscItems.length > 0;
    if (emptyDiv) emptyDiv.style.display = hasSomething ? 'none' : '';

    // Render all sections
    const sectionsDiv = document.getElementById('boqSections');
    if (!sectionsDiv) return;

    let html = '';

    // ‚îÄ‚îÄ SECTION A: ROAD WORKS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (tcsList.length > 0) {
        html += boqSectionHeader('A', 'Road Works', roadTotal,
            `${tcsList.length} TCS frozen`, '#1d4ed8', '#eff6ff');
        tcsList.forEach((tcs, ti) => {
            const tcsItems = bd.roadItems.filter(i => i.tcsId === tcs.id);
            const tcsTotal = tcsItems.reduce((s, i) => s + boqAmt(i), 0);
            const totalLen = (tcs.locations || []).reduce((s,l)=>s+(l.toCh-l.fromCh),0);
            html += boqGroupHeader(
                `A.${ti+1}`, tcs.name || 'TCS',
                `Ch ${(tcs.locations||[]).map(l=>fmtChT(l.fromCh)+'-'+fmtChT(l.toCh)).join(', ')} ¬∑ ${(totalLen/1000).toFixed(3)} km`,
                tcsTotal, '#1d4ed8',
                !bd.frozen ? `<button onclick="boqAddRoadItem('${tcs.id}')" style="${BTN_ADD}">+ Add Item</button>` : ''
            );
            if (tcsItems.length > 0) {
                html += boqTableHeader();
                tcsItems.forEach((item, idx) => {
                    html += boqTableRow(item, idx, 'road', !bd.frozen);
                });
                html += boqTableFooter(tcsTotal);
            } else {
                html += `<div style="padding:10px 18px 14px;font-size:0.78rem;color:var(--text-secondary);font-style:italic;">No items yet ‚Äî click + Add Item or upload Excel</div>`;
            }
        });
    }

    // ‚îÄ‚îÄ SECTION B: STRUCTURES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (structs.length > 0) {
        html += boqSectionHeader('B', 'Structures & Bridges', structTotal,
            `${structs.length} structures frozen`, '#7c3aed', '#f5f3ff');
        structs.forEach((st, si) => {
            const stItems = bd.structItems.filter(i => i.structId === st.id);
            const stTotal = stItems.reduce((s, i) => s + boqAmt(i), 0);
            const supports = st.supports || [];
            const fnTypes = [...new Set(supports.map(s=>s.foundation).filter(Boolean))];
            const sstTypes = [...new Set(supports.slice(0,-1).map(s=>s.superstructure).filter(Boolean))];
            const totalLen = supports.slice(0,-1).reduce((s,sp)=>s+(sp.spanLength||0),0);
            html += boqGroupHeader(
                `B.${si+1}`,
                `${st.name} ‚Äî Ch ${fmtChT(st.chainage||0)}`,
                `${supports.length>1?supports.length-1:1} span(s)${totalLen>0?' ¬∑ '+totalLen+'m':''} ¬∑ ${fnTypes.join('/')} ¬∑ ${sstTypes.join('/')}`,
                stTotal, '#7c3aed',
                !bd.frozen ? `<button onclick="boqAddStructItem('${st.id}')" style="${BTN_ADD}">+ Add Item</button>` : ''
            );
            // Auto-suggest if no items yet
            if (stItems.length === 0 && !bd.frozen) {
                const suggestions = boqGetStructSuggestions(st);
                if (suggestions.length > 0) {
                    html += `<div style="padding:8px 18px;background:#faf5ff;border-bottom:1px solid #e9d5ff;">
                        <span style="font-size:0.71rem;color:#7c3aed;font-weight:600;">üí° Suggested items from span definitions:</span>
                        <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;">
                        ${suggestions.map(s=>`<button onclick="boqAcceptStructSuggestion('${st.id}','${s.description}','${s.unit}')"
                            style="background:#ede9fe;color:#7c3aed;border:1px solid #c4b5fd;padding:3px 10px;border-radius:4px;font-size:0.72rem;cursor:pointer;font-weight:600;">+ ${s.description}</button>`).join('')}
                        </div></div>`;
                }
            }
            if (stItems.length > 0) {
                html += boqTableHeader();
                stItems.forEach((item, idx) => {
                    html += boqTableRow(item, idx, 'struct', !bd.frozen);
                });
                html += boqTableFooter(stTotal);
            } else if (bd.frozen || !boqGetStructSuggestions(st).length) {
                html += `<div style="padding:10px 18px 14px;font-size:0.78rem;color:var(--text-secondary);font-style:italic;">No items yet</div>`;
            }
        });
    }

    // ‚îÄ‚îÄ SECTION C: MISCELLANEOUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const hasAnySections = tcsList.length > 0 || structs.length > 0;
    if (bd.miscItems.length > 0 || !hasAnySections) {
        html += boqSectionHeader('C', 'Miscellaneous', miscTotal,
            'Preliminary, Mobilisation, Traffic Management etc.', '#059669', '#f0fdf4');
        if (bd.miscItems.length > 0) {
            html += boqTableHeader();
            bd.miscItems.forEach((item, idx) => {
                html += boqTableRow(item, idx, 'misc', !bd.frozen);
            });
            html += boqTableFooter(miscTotal);
        } else {
            html += `<div style="padding:10px 18px 14px;font-size:0.78rem;color:var(--text-secondary);font-style:italic;">No items ‚Äî click + Add Item in top bar</div>`;
        }
    }

    sectionsDiv.innerHTML = html;
}

// ‚îÄ‚îÄ RENDER HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BTN_ADD = 'background:#1B3B6F;color:var(--accent-gold);border:none;padding:4px 12px;border-radius:4px;font-size:0.72rem;cursor:pointer;font-weight:700;';

function boqSectionHeader(code, title, total, subtitle, color, bg) {
    return `<div style="background:${bg};border-left:4px solid ${color};border-radius:6px 6px 0 0;padding:10px 14px;margin-top:16px;display:flex;align-items:center;justify-content:space-between;">
        <div>
            <span style="background:${color};color:#fff;padding:2px 8px;border-radius:3px;font-size:0.7rem;font-weight:700;margin-right:8px;">PART ${code}</span>
            <span style="font-weight:700;color:${color};font-size:0.9rem;">${title}</span>
            <span style="font-size:0.72rem;color:var(--text-secondary);margin-left:8px;">${subtitle}</span>
        </div>
        <div style="font-weight:700;color:${color};font-size:0.9rem;">${total>0?boqFmtCr(total):''}</div>
    </div>`;
}

function boqGroupHeader(code, name, meta, total, color, addBtn) {
    return `<div style="background:#fff;border:1px solid #e2e8f0;border-top:none;padding:8px 14px;display:flex;align-items:center;justify-content:space-between;gap:8px;">
        <div style="display:flex;align-items:center;gap:8px;">
            <span style="font-size:0.7rem;font-weight:700;color:${color};min-width:32px;">${code}</span>
            <div>
                <div style="font-weight:700;color:var(--navy);font-size:0.84rem;">${name}</div>
                <div style="font-size:0.68rem;color:var(--text-secondary);">${meta}</div>
            </div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;">
            ${total>0?`<span style="font-weight:700;color:${color};font-size:0.84rem;">${boqFmtCr(total)}</span>`:''}
            ${addBtn}
        </div>
    </div>`;
}

function boqTableHeader() {
    return `<div style="overflow-x:auto;border:1px solid #e2e8f0;border-top:none;border-radius:0 0 6px 6px;margin-bottom:4px;">
    <table style="width:100%;border-collapse:collapse;font-size:0.78rem;">
    <thead><tr style="background:#f8fafc;">
        <th style="padding:6px 8px;text-align:left;font-size:0.68rem;font-weight:700;color:var(--text-secondary);white-space:nowrap;width:70px;">Item No</th>
        <th style="padding:6px 8px;text-align:left;font-size:0.68rem;font-weight:700;color:var(--text-secondary);">Description</th>
        <th style="padding:6px 8px;text-align:center;font-size:0.68rem;font-weight:700;color:var(--text-secondary);width:70px;">Unit</th>
        <th style="padding:6px 8px;text-align:right;font-size:0.68rem;font-weight:700;color:var(--text-secondary);width:90px;">Qty</th>
        <th style="padding:6px 8px;text-align:right;font-size:0.68rem;font-weight:700;color:var(--text-secondary);width:110px;">Rate (‚Çπ)</th>
        <th style="padding:6px 8px;text-align:right;font-size:0.68rem;font-weight:700;color:var(--text-secondary);width:110px;">Amount (‚Çπ)</th>
        <th style="padding:6px 8px;text-align:center;font-size:0.68rem;width:50px;"></th>
    </tr></thead><tbody>`;
}

function boqTableRow(item, idx, section, editable) {
    const amt = boqAmt(item);
    const altBg = idx % 2 === 1 ? 'background:#f9fafb;' : '';
    if (editable) {
        return `<tr style="${altBg}">
            <td style="padding:4px 6px;"><input type="text" value="${item.itemNo||''}" placeholder="1.1"
                onchange="boqUpdateItem('${section}','${item.id}','itemNo',this.value)"
                style="width:100%;padding:3px 5px;border:1px solid #e2e8f0;border-radius:3px;font-size:0.76rem;box-sizing:border-box;"></td>
            <td style="padding:4px 6px;"><input type="text" value="${item.description||''}" placeholder="Description"
                onchange="boqUpdateItem('${section}','${item.id}','description',this.value)"
                style="width:100%;padding:3px 5px;border:1px solid #e2e8f0;border-radius:3px;font-size:0.76rem;box-sizing:border-box;"></td>
            <td style="padding:4px 6px;text-align:center;"><select
                onchange="boqUpdateItem('${section}','${item.id}','unit',this.value)"
                style="width:68px;padding:3px 4px;border:1px solid #e2e8f0;border-radius:3px;font-size:0.74rem;">
                ${['RMT','Sqm','Cum','MT','Nos','LS','Ha','Km','Month','Lump Sum'].map(u=>
                    `<option ${item.unit===u?'selected':''}>${u}</option>`).join('')}
            </select></td>
            <td style="padding:4px 6px;"><input type="number" value="${item.qty||''}" placeholder="0"
                onchange="boqUpdateItem('${section}','${item.id}','qty',parseFloat(this.value)||0)"
                style="width:100%;padding:3px 5px;border:1px solid #e2e8f0;border-radius:3px;font-size:0.76rem;text-align:right;box-sizing:border-box;"></td>
            <td style="padding:4px 6px;"><input type="number" value="${item.rate||''}" placeholder="0"
                onchange="boqUpdateItem('${section}','${item.id}','rate',parseFloat(this.value)||0)"
                style="width:100%;padding:3px 5px;border:1px solid #e2e8f0;border-radius:3px;font-size:0.76rem;text-align:right;box-sizing:border-box;"></td>
            <td style="padding:4px 6px;text-align:right;font-weight:700;font-size:0.76rem;color:var(--navy);white-space:nowrap;">${amt>0?boqFmtCr(amt):''}</td>
            <td style="padding:4px 6px;text-align:center;">
                <button onclick="boqDeleteItem('${section}','${item.id}')"
                    style="background:#fee2e2;color:#dc2626;border:none;padding:2px 7px;border-radius:3px;font-size:0.7rem;cursor:pointer;">‚úï</button>
            </td>
        </tr>`;
    } else {
        // Read-only (frozen)
        return `<tr style="${altBg}">
            <td style="padding:5px 8px;font-size:0.74rem;color:var(--text-secondary);">${item.itemNo||'‚Äî'}</td>
            <td style="padding:5px 8px;font-size:0.76rem;">${item.description||'‚Äî'}</td>
            <td style="padding:5px 8px;text-align:center;font-size:0.74rem;">${item.unit||'‚Äî'}</td>
            <td style="padding:5px 8px;text-align:right;font-size:0.74rem;">${(item.qty||0).toLocaleString()}</td>
            <td style="padding:5px 8px;text-align:right;font-size:0.74rem;">‚Çπ${(item.rate||0).toLocaleString()}</td>
            <td style="padding:5px 8px;text-align:right;font-weight:700;font-size:0.76rem;color:var(--navy);">${amt>0?boqFmtCr(amt):''}</td>
            <td></td>
        </tr>`;
    }
}

function boqTableFooter(total) {
    return `<tr style="background:#f8fafc;border-top:2px solid #e2e8f0;">
        <td colspan="5" style="padding:6px 8px;text-align:right;font-size:0.76rem;font-weight:700;color:var(--navy);">Sub-total</td>
        <td style="padding:6px 8px;text-align:right;font-weight:700;font-size:0.84rem;color:var(--navy);">${boqFmtCr(total)}</td>
        <td></td>
    </tr></tbody></table></div>`;
}

// ‚îÄ‚îÄ STRUCT SUGGESTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function boqGetStructSuggestions(st) {
    const supports = st.supports || [];
    const suggestions = [];
    const fnTypes = [...new Set(supports.map(s=>s.foundation).filter(Boolean))];
    const sstTypes = [...new Set(supports.slice(0,-1).map(s=>s.superstructure).filter(Boolean))];

    // Foundation-based suggestions
    fnTypes.forEach(fn => {
        if (fn.includes('Pile')) {
            suggestions.push({description:'Pile Boring & Casting', unit:'Nos'});
            suggestions.push({description:'Pile Cap & Tie Beam', unit:'Cum'});
        } else if (fn.includes('Well')) {
            suggestions.push({description:'Well Steining', unit:'Cum'});
            suggestions.push({description:'Well Sinking', unit:'M'});
            suggestions.push({description:'Well Cap', unit:'Cum'});
        } else if (fn.includes('Open') || fn.includes('Spread')) {
            suggestions.push({description:'Foundation Excavation', unit:'Cum'});
            suggestions.push({description:'Foundation RCC', unit:'Cum'});
        }
    });

    // Substructure
    const hasAbutment = supports.some(s=>s.type==='abutment');
    const hasPier = supports.some(s=>s.type==='pier');
    if (hasAbutment) suggestions.push({description:'Abutment & Wing Walls', unit:'Cum'});
    if (hasPier) suggestions.push({description:'Pier & Pier Cap', unit:'Cum'});

    // Superstructure-based suggestions
    sstTypes.forEach(sst => {
        if (sst.includes('PSC')) {
            suggestions.push({description:'PSC Girder Supply & Erection', unit:'Nos'});
            suggestions.push({description:'Deck Slab', unit:'Cum'});
        } else if (sst.includes('Composite') || sst.includes('Steel')) {
            suggestions.push({description:'Steel Girder Fabrication & Erection', unit:'MT'});
            suggestions.push({description:'Composite Deck Slab', unit:'Cum'});
        } else if (sst.includes('RCC T-Beam')) {
            suggestions.push({description:'RCC T-Beam Girder (In-situ)', unit:'Cum'});
        } else if (sst.includes('Slab')) {
            suggestions.push({description:'RCC Slab (Superstructure)', unit:'Cum'});
        } else if (sst.includes('Culvert') || sst.includes('No Superstructure')) {
            suggestions.push({description:'Box Culvert / Slab (Superstructure)', unit:'Cum'});
        }
    });

    // Always suggest finishing
    suggestions.push({description:'Approach Road & Protection Works', unit:'RMT'});
    suggestions.push({description:'Miscellaneous & Finishing', unit:'LS'});

    return suggestions;
}

// ‚îÄ‚îÄ ADD / UPDATE / DELETE ITEMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function boqAddRoadItem(tcsId) {
    const bd = ensureBOQData();
    const boq = ensureBOQ ? ensureBOQ() : {};
    const tcs = (boq.tcsList||[]).find(t=>t.id===tcsId);
    bd.roadItems.push({
        id: boqNewId(), tcsId, tcsName: tcs ? tcs.name : '',
        itemNo: String(bd.roadItems.filter(i=>i.tcsId===tcsId).length + 1),
        description: '', unit: 'RMT', qty: 0, rate: 0
    });
    KALYANTRA.save();
    renderBOQTab();
}

function boqAddStructItem(structId) {
    const bd = ensureBOQData();
    const st = (KALYANTRA.data.structures||[]).find(s=>s.id===structId);
    bd.structItems.push({
        id: boqNewId(), structId, structName: st ? st.name : '',
        itemNo: String(bd.structItems.filter(i=>i.structId===structId).length + 1),
        description: '', unit: 'Cum', qty: 0, rate: 0
    });
    KALYANTRA.save();
    renderBOQTab();
}

function boqAddMiscItem() {
    const bd = ensureBOQData();
    bd.miscItems.push({
        id: boqNewId(),
        itemNo: String(bd.miscItems.length + 1),
        description: '', unit: 'LS', qty: 1, rate: 0
    });
    KALYANTRA.save();
    renderBOQTab();
}

function boqAcceptStructSuggestion(structId, description, unit) {
    const bd = ensureBOQData();
    const st = (KALYANTRA.data.structures||[]).find(s=>s.id===structId);
    bd.structItems.push({
        id: boqNewId(), structId, structName: st ? st.name : '',
        itemNo: String(bd.structItems.filter(i=>i.structId===structId).length + 1),
        description, unit, qty: 0, rate: 0
    });
    KALYANTRA.save();
    renderBOQTab();
}

function boqUpdateItem(section, id, field, value) {
    const bd = ensureBOQData();
    const arr = section === 'road' ? bd.roadItems : section === 'struct' ? bd.structItems : bd.miscItems;
    const item = arr.find(i => i.id === id);
    if (item) {
        item[field] = value;
        KALYANTRA.save();
        // Re-render totals without full redraw
        renderBOQTotalsOnly();
    }
}

function boqDeleteItem(section, id) {
    const bd = ensureBOQData();
    if (section === 'road') bd.roadItems = bd.roadItems.filter(i=>i.id!==id);
    else if (section === 'struct') bd.structItems = bd.structItems.filter(i=>i.id!==id);
    else bd.miscItems = bd.miscItems.filter(i=>i.id!==id);
    KALYANTRA.save();
    renderBOQTab();
}

function renderBOQTotalsOnly() {
    const bd = ensureBOQData();
    const allItems = [...bd.roadItems, ...bd.structItems, ...bd.miscItems];
    const grandTotal = allItems.reduce((s,i)=>s+boqAmt(i),0);
    const setEl = (id,v)=>{const el=document.getElementById(id);if(el)el.innerHTML=v;};
    setEl('boqContractBadge', grandTotal>0?'Contract: '+boqFmtCr(grandTotal):'Contract: ‚Äî');
    setEl('boqItemsBadge', allItems.length + ' items');
    setEl('gtContractValue', boqFmtCr(grandTotal));
    setEl('gtRoadValue', boqFmtCr(bd.roadItems.reduce((s,i)=>s+boqAmt(i),0)));
    setEl('gtStructValue', boqFmtCr(bd.structItems.reduce((s,i)=>s+boqAmt(i),0)));
    setEl('gtMiscValue', boqFmtCr(bd.miscItems.reduce((s,i)=>s+boqAmt(i),0)));
    const gtDiv = document.getElementById('boqGrandTotal');
    if (gtDiv) gtDiv.style.display = grandTotal > 0 ? '' : 'none';
}

// ‚îÄ‚îÄ FREEZE BOQ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function boqFreezeAll() {
    const bd = ensureBOQData();
    const allItems = [...bd.roadItems, ...bd.structItems, ...bd.miscItems];
    if (allItems.length === 0) {
        showToast('Add at least one BOQ item before freezing', 'info');
        return;
    }
    const grandTotal = allItems.reduce((s,i)=>s+boqAmt(i), 0);
    const itemsWithQtyRate = allItems.filter(i=>i.qty>0&&i.rate>0).length;
    if (!confirm(
        `Freeze BOQ and Generate WBS?\n\n` +
        `${allItems.length} items ¬∑ ${itemsWithQtyRate} with Qty+Rate ¬∑ Total: ${boqFmtCr(grandTotal)}\n\n` +
        `This will:\n` +
        `1. Lock all quantities and rates (no further edits without Unfreezing)\n` +
        `2. Generate WBS activities in Activity Grid\n` +
        `3. Duration = BOQ Qty √∑ Productivity rate (set in Resources tab)\n\n` +
        `Continue?`
    )) return;

    bd.frozen = true;
    KALYANTRA.save();

    // Trigger WBS generation for all frozen structures and TCS
    let totalActivities = 0;
    const structs = (KALYANTRA.data.structures||[]).filter(s=>s.frozen);
    structs.forEach((st, si) => {
        if (typeof generateStructureWBS === 'function') {
            const acts = generateStructureWBS(si);
            totalActivities += acts ? acts.length : 0;
        }
    });
    const boqData = ensureBOQ ? ensureBOQ() : {};
    (boqData.tcsList||[]).filter(t=>t.frozen).forEach((tcs, ti) => {
        if (typeof generateTCSWBS === 'function') {
            const acts = generateTCSWBS(ti);
            totalActivities += acts ? acts.length : 0;
        }
    });

    renderBOQTab();
    showToast(`üîí BOQ frozen ¬∑ ${totalActivities} WBS activities generated in Activity Grid`, 'success');
}

function boqUnfreeze() {
    const bd = ensureBOQData();
    if (!confirm(
        'Unfreeze BOQ?\n\n' +
        'This will:\n' +
        '1. Allow editing quantities and rates\n' +
        '2. Remove all auto-generated WBS activities from Activity Grid\n' +
        '3. You will need to Freeze again to regenerate WBS\n\n' +
        'Continue?'
    )) return;
    bd.frozen = false;
    // Remove all auto-generated activities
    if (KALYANTRA.data.activities) {
        KALYANTRA.data.activities = KALYANTRA.data.activities.filter(
            a => !a.sourceStructureId && !a.sourceTCSId
        );
    }
    // Reset wbsGenerated flags
    (KALYANTRA.data.structures||[]).forEach(st => { st.wbsGenerated=false; st.wbsActivityCount=0; });
    const boqData = ensureBOQ ? ensureBOQ() : {};
    (boqData.tcsList||[]).forEach(t => { t.wbsGenerated=false; t.wbsActivityCount=0; });
    KALYANTRA.save();
    renderBOQTab();
    showToast('üîì BOQ unfrozen ‚Äî WBS activities removed', 'info');
}

// ‚îÄ‚îÄ EXCEL UPLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function boqUploadExcel() {
    document.getElementById('boqExcelInput').click();
}

function boqProcessExcelFile(input) {
    const file = input.files[0];
    if (!file) return;
    const ext = file.name.split('.').pop().toLowerCase();

    if (ext === 'csv') {
        const reader = new FileReader();
        reader.onload = (e) => boqShowMapper(e.target.result, 'csv', file.name);
        reader.readAsText(file);
    } else {
        // xlsx ‚Äî use SheetJS
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type:'array'});
                const ws = wb.Sheets[wb.SheetNames[0]];
                const csv = XLSX.utils.sheet_to_csv(ws);
                boqShowMapper(csv, 'xlsx', file.name);
            } catch(err) {
                showToast('Could not read Excel file ‚Äî try saving as CSV first', 'error');
            }
        };
        reader.readAsArrayBuffer(file);
    }
    input.value = '';
}

function boqShowMapper(csvText, format, fileName) {
    const lines = csvText.trim().split('\n').filter(l=>l.trim());
    if (lines.length < 2) { showToast('File appears empty', 'error'); return; }

    // Parse CSV properly (handle quoted fields)
    function parseLine(line) {
        const result = []; let cur = ''; let inQ = false;
        for (let ch of line) {
            if (ch==='"') inQ=!inQ;
            else if (ch===',' && !inQ) { result.push(cur.trim()); cur=''; }
            else cur+=ch;
        }
        result.push(cur.trim());
        return result;
    }

    const headers = parseLine(lines[0]);
    const preview = lines.slice(1, 8).map(parseLine);
    const ex = document.getElementById('boqMapperModal');
    if (ex) ex.remove();

    const modal = document.createElement('div');
    modal.id = 'boqMapperModal';
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:flex-start;justify-content:center;padding-top:40px;overflow-y:auto;';

    const colOpts = ['‚Äî Skip ‚Äî', ...headers].map((h,i)=>`<option value="${i-1}">${h}</option>`).join('');
    const previewRows = preview.map(row=>`<tr>${row.slice(0,7).map(cell=>`<td style="padding:3px 8px;border:1px solid #e2e8f0;font-size:0.72rem;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${cell}</td>`).join('')}</tr>`).join('');

    // Try auto-detect columns
    function autoDetect(keywords) {
        const idx = headers.findIndex(h => keywords.some(kw => h.toLowerCase().includes(kw.toLowerCase())));
        return idx >= 0 ? idx : -1;
    }
    const autoItemNo = autoDetect(['item','sl','no','sr']);
    const autoDesc = autoDetect(['description','desc','work','item name','particulars']);
    const autoUnit = autoDetect(['unit','uom']);
    const autoQty = autoDetect(['qty','quantity','quant']);
    const autoRate = autoDetect(['rate','rate (rs)','rate (inr)','rate (‚Çπ)']);

    function selVal(auto) { return auto >= 0 ? auto : -1; }
    function buildOpts(auto) {
        return ['‚Äî Skip ‚Äî', ...headers].map((h,i)=>
            `<option value="${i-1}" ${(i-1)===auto?'selected':''}>${h}</option>`).join('');
    }

    modal.innerHTML = `
    <div style="background:#fff;border-radius:10px;padding:24px;width:820px;max-width:97vw;box-shadow:0 20px 60px rgba(0,0,0,0.3);margin-bottom:40px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:10px;border-bottom:2px solid var(--accent-gold);">
            <div>
                <div style="font-weight:700;color:var(--navy);font-size:1rem;">üì• Map Excel Columns ‚Äî ${fileName}</div>
                <div style="font-size:0.72rem;color:var(--text-secondary);margin-top:2px;">${lines.length-1} data rows detected ¬∑ NHAI format supported ¬∑ Map columns then choose where to import</div>
            </div>
            <button onclick="document.getElementById('boqMapperModal').remove()" style="background:none;border:none;font-size:1.2rem;cursor:pointer;">‚úï</button>
        </div>

        <!-- COLUMN MAPPER -->
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:16px;background:#f8fafc;padding:12px;border-radius:8px;">
            <div><label style="font-size:0.7rem;font-weight:700;color:var(--navy);display:block;margin-bottom:4px;">Item No column</label>
            <select id="mapItemNo" style="width:100%;padding:5px;border:1.5px solid var(--border-medium);border-radius:4px;font-size:0.78rem;">${buildOpts(autoItemNo)}</select></div>
            <div><label style="font-size:0.7rem;font-weight:700;color:var(--navy);display:block;margin-bottom:4px;">Description column</label>
            <select id="mapDesc" style="width:100%;padding:5px;border:1.5px solid var(--border-medium);border-radius:4px;font-size:0.78rem;">${buildOpts(autoDesc)}</select></div>
            <div><label style="font-size:0.7rem;font-weight:700;color:var(--navy);display:block;margin-bottom:4px;">Unit column</label>
            <select id="mapUnit" style="width:100%;padding:5px;border:1.5px solid var(--border-medium);border-radius:4px;font-size:0.78rem;">${buildOpts(autoUnit)}</select></div>
            <div><label style="font-size:0.7rem;font-weight:700;color:var(--navy);display:block;margin-bottom:4px;">Qty column</label>
            <select id="mapQty" style="width:100%;padding:5px;border:1.5px solid var(--border-medium);border-radius:4px;font-size:0.78rem;">${buildOpts(autoQty)}</select></div>
            <div><label style="font-size:0.7rem;font-weight:700;color:var(--navy);display:block;margin-bottom:4px;">Rate column</label>
            <select id="mapRate" style="width:100%;padding:5px;border:1.5px solid var(--border-medium);border-radius:4px;font-size:0.78rem;">${buildOpts(autoRate)}</select></div>
        </div>

        <!-- IMPORT SECTION SELECTOR -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
            <div><label style="font-size:0.7rem;font-weight:700;color:var(--navy);display:block;margin-bottom:4px;">Import into section</label>
            <select id="mapSection" style="width:100%;padding:6px;border:1.5px solid var(--border-medium);border-radius:4px;font-size:0.82rem;">
                <option value="misc">Miscellaneous (default)</option>
                ${(()=>{
                    const boq = typeof ensureBOQ==='function' ? ensureBOQ() : {};
                    const frozen_tcs = (boq.tcsList||[]).filter(t=>t.frozen);
                    const frozen_st = (KALYANTRA.data.structures||[]).filter(s=>s.frozen);
                    let opts = '';
                    frozen_tcs.forEach(t=>{opts+=`<option value="road:${t.id}">Road Works ‚Äî ${t.name}</option>`;});
                    frozen_st.forEach(s=>{opts+=`<option value="struct:${s.id}">Structure ‚Äî ${s.name}</option>`;});
                    return opts;
                })()}
            </select></div>
            <div><label style="font-size:0.7rem;font-weight:700;color:var(--navy);display:block;margin-bottom:4px;">Skip header rows</label>
            <input id="mapSkipRows" type="number" value="0" min="0" max="10"
                style="width:100%;padding:6px;border:1.5px solid var(--border-medium);border-radius:4px;font-size:0.82rem;">
            <div style="font-size:0.67rem;color:var(--text-secondary);margin-top:2px;">Extra header rows after the first row (NHAI sometimes has 2)</div></div>
        </div>

        <!-- DATA PREVIEW -->
        <div style="margin-bottom:16px;">
            <div style="font-size:0.71rem;font-weight:700;color:var(--navy);margin-bottom:6px;">Preview (first 7 data rows):</div>
            <div style="overflow-x:auto;border:1px solid #e2e8f0;border-radius:6px;">
                <table style="width:100%;border-collapse:collapse;">
                    <thead><tr style="background:#f0f4ff;">${headers.slice(0,7).map(h=>`<th style="padding:5px 8px;font-size:0.7rem;font-weight:700;color:var(--navy);border:1px solid #e2e8f0;text-align:left;">${h}</th>`).join('')}</tr></thead>
                    <tbody>${previewRows}</tbody>
                </table>
            </div>
        </div>

        <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button onclick="document.getElementById('boqMapperModal').remove()"
                style="padding:9px 18px;border:1.5px solid var(--border-medium);background:#fff;border-radius:6px;cursor:pointer;font-size:0.84rem;font-weight:600;color:#64748b;">Cancel</button>
            <button onclick="boqImportMapped(${JSON.stringify(csvText.replace(/"/g,"'"))})"
                style="padding:9px 24px;background:var(--navy);color:var(--accent-gold);border:none;border-radius:6px;font-weight:700;cursor:pointer;font-size:0.87rem;">üì• Import Items</button>
        </div>
    </div>`;
    document.body.appendChild(modal);
}

function boqImportMapped(csvText) {
    const colItemNo = parseInt(document.getElementById('mapItemNo').value);
    const colDesc   = parseInt(document.getElementById('mapDesc').value);
    const colUnit   = parseInt(document.getElementById('mapUnit').value);
    const colQty    = parseInt(document.getElementById('mapQty').value);
    const colRate   = parseInt(document.getElementById('mapRate').value);
    const section   = document.getElementById('mapSection').value;
    const skipRows  = parseInt(document.getElementById('mapSkipRows').value)||0;

    if (colDesc < 0) { showToast('Must map at least Description column', 'error'); return; }

    function parseLine(line) {
        const result=[]; let cur=''; let inQ=false;
        for(let ch of line){if(ch==='"')inQ=!inQ;else if(ch===','&&!inQ){result.push(cur.trim());cur='';}else cur+=ch;}
        result.push(cur.trim()); return result;
    }

    const lines = csvText.trim().split('\n').filter(l=>l.trim());
    const dataLines = lines.slice(1 + skipRows); // skip header + extra header rows
    const bd = ensureBOQData();
    let imported = 0;
    let skipped = 0;

    dataLines.forEach(line => {
        const cols = parseLine(line);
        const desc = colDesc>=0 ? (cols[colDesc]||'').trim() : '';
        if (!desc || desc.length < 2) { skipped++; return; } // skip empty/header rows
        // Skip obvious group header rows (no qty/rate, or desc is all caps short)
        const qty = colQty>=0 ? parseFloat((cols[colQty]||'').replace(/,/g,''))||0 : 0;
        const rate = colRate>=0 ? parseFloat((cols[colRate]||'').replace(/,/g,''))||0 : 0;

        const newItem = {
            id: boqNewId(),
            itemNo: colItemNo>=0 ? (cols[colItemNo]||'').trim() : String(imported+1),
            description: desc,
            unit: colUnit>=0 ? (cols[colUnit]||'').trim()||'LS' : 'LS',
            qty, rate
        };

        if (section.startsWith('road:')) {
            const tcsId = section.replace('road:','');
            const tcs = (typeof ensureBOQ==='function'?ensureBOQ():{}).tcsList?.find(t=>t.id===tcsId);
            newItem.tcsId = tcsId;
            newItem.tcsName = tcs ? tcs.name : '';
            bd.roadItems.push(newItem);
        } else if (section.startsWith('struct:')) {
            const structId = section.replace('struct:','');
            const st = (KALYANTRA.data.structures||[]).find(s=>s.id===structId);
            newItem.structId = structId;
            newItem.structName = st ? st.name : '';
            bd.structItems.push(newItem);
        } else {
            bd.miscItems.push(newItem);
        }
        imported++;
    });

    KALYANTRA.save();
    document.getElementById('boqMapperModal').remove();
    renderBOQTab();
    showToast(`‚úÖ Imported ${imported} items${skipped>0?' ('+skipped+' rows skipped)':''}`, 'success');
}

// Update header project name on page load
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        const pname = KALYANTRA && KALYANTRA.data && KALYANTRA.data.project
            ? KALYANTRA.data.project.name : null;
        const hn  = document.getElementById('headerProjectName');
        const hn2 = document.getElementById('headerProjectName2');
        if (hn  && pname) hn.textContent  = '‚Äî ' + pname;
        if (hn2 && pname) hn2.textContent = pname;
    }, 800);
});

// SheetJS loaded via CDN in <head>

</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KALYANTRA REPORTS & ANALYTICS ENGINE
// Tab 10 (index 10) ‚Äî renderReportsTab() wires tab11 panel
// generateReport(type) creates printable modal reports
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê




        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONSTRAINT ENGINE v2 ‚Äî Robust, fully debugged
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const IRC_CURE_LAGS = [
            { after:'Sub-grade Preparation', before:'GSB Layer',  lag:3, ref:'IRC:36-2010 Cl.5.4' },
            { after:'GSB Layer',             before:'WMM Layer',  lag:0, ref:'IRC:SP:20 Cl.7 (immediate)' },
            { after:'WMM Layer',             before:'DBM Layer',  lag:7, ref:'MoRTH ¬ß509.3 (prime coat cure)' },
            { after:'DBM Layer',             before:'BC Wearing', lag:3, ref:'MoRTH ¬ß510.3 (tack coat cure)' },
        ];

        // ‚îÄ‚îÄ Default resource groups for a 4-lane HAM highway project ‚îÄ‚îÄ‚îÄ‚îÄ
        const DEFAULT_RESOURCE_GROUPS = [
            { id:'rg1', name:'Earthwork Gang',  keywords:'Soil Excavation',       crews:1, bufferM:3000 },
            { id:'rg2', name:'Sub-grade Gang',  keywords:'Sub-grade Preparation', crews:1, bufferM:2000 },
            { id:'rg3', name:'Paver Gang A',    keywords:'GSB Layer,WMM Layer',   crews:1, bufferM:2000 },
            { id:'rg4', name:'Paver Gang B',    keywords:'DBM Layer,BC Wearing',  crews:1, bufferM:1000 },
        ];

        // ‚îÄ‚îÄ Ensure constraints object has all required keys ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function ensureDefaultConstraints() {
            const d = KALYANTRA.data;
            if (!d.constraints) d.constraints = {};
            const con = d.constraints;
            if (!con.crewSeparation)  con.crewSeparation  = { enabled:true, defaultBufferM:2000, perActivity:{} };
            if (!con.stretchOverrides) con.stretchOverrides = {};
            if (!con.cureLagOverrides) con.cureLagOverrides = {};
            if (!con.violations)       con.violations       = [];
            // Seed default groups only if truly empty (first use or DB had none)
            if (!con.resourceGroups || con.resourceGroups.length === 0) {
                con.resourceGroups = DEFAULT_RESOURCE_GROUPS.map(g => Object.assign({}, g));
                con._seededDefaults = true;
                console.log('  ‚Üí Seeded 4 default resource groups');
            }
        }

        // ‚îÄ‚îÄ Main entry point ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderConstraintsTab() {
            console.log('üîó renderConstraintsTab() ‚Äî start');
            try {
                ensureDefaultConstraints();
                const con = KALYANTRA.data.constraints;
                console.log('  groups:', con.resourceGroups.length,
                            '| overrides keys:', Object.keys(con.stretchOverrides).length);

                // Ensure WBS is computed
                if (!KALYANTRA.computed.wbs || KALYANTRA.computed.wbs.length === 0) {
                    KALYANTRA.calculate.wbs();
                }

                applyConstraints(KALYANTRA.computed.wbs || []);
                _renderResourceGroups();
                _renderStretchMatrix();
                _renderCureLags();
                _renderViolations();
                console.log('üîó renderConstraintsTab() ‚Äî done');
            } catch(err) {
                console.error('‚ùå renderConstraintsTab error:', err);
            }
        }

        // ‚îÄ‚îÄ Layer 2+3C constraint engine ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function applyConstraints(wbs) {
            // Ensure constraints object exists before using
            if (!KALYANTRA.data.constraints) {
                KALYANTRA.data.constraints = { violations: [], resourceGroups: [], crewSeparation: { enabled: true, defaultBufferM: 2000, perActivity: {} }, stretchOverrides: {}, cureLagOverrides: {} };
            }
            const con = KALYANTRA.data.constraints;
            if (!con.crewSeparation || !con.crewSeparation.enabled) {
                con.violations = [];
                return;
            }
            const violations = [];
            const stretches  = wbs.filter(w => w.type === 'stretch');
            const groups     = con.resourceGroups || [];

            if (stretches.length > 1 && groups.length > 0) {
                // Layer 3C: resource conflict detection
                groups.forEach(group => {
                    const keywords = (group.keywords || '').split(',')
                        .map(k => k.trim().toLowerCase()).filter(Boolean);
                    const maxCrews = group.crews || 1;

                    // Collect day windows for each activity matching this group
                    const allActivities = [];
                    let dayOffset = 0;
                    stretches.forEach(s => {
                        let localDay = 0;
                        (s.activities || []).forEach(act => {
                            if (keywords.some(kw => act.name.toLowerCase().includes(kw))) {
                                allActivities.push({
                                    name: act.name, stretch: s.wbs,
                                    d0: dayOffset + localDay,
                                    d1: dayOffset + localDay + (act.duration || 1),
                                });
                            }
                            localDay += (act.duration || 1);
                        });
                        dayOffset += (s.duration || 0);
                    });

                    // Check pairwise overlaps
                    for (let i = 0; i < allActivities.length; i++) {
                        let concurrent = 0;
                        for (let j = 0; j < allActivities.length; j++) {
                            if (i === j) continue;
                            const a = allActivities[i], b = allActivities[j];
                            if (a.d0 < b.d1 && a.d1 > b.d0) concurrent++;
                        }
                        if (concurrent >= maxCrews) {
                            const a = allActivities[i];
                            if (!violations.find(v => v.type === 'resource' && v.group === group.name && v.stretch1 === a.stretch)) {
                                violations.push({
                                    type: 'resource', severity: 'error',
                                    group: group.name, activity: a.name, stretch1: a.stretch,
                                    message: `${group.name}: "${a.name}" in ${a.stretch} overlaps ‚Äî exceeds ${maxCrews} crew limit.`,
                                });
                            }
                        }
                    }
                });
            }
            con.violations = violations;
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // SECTION 1 ‚Äî Resource Groups
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function _renderResourceGroups() {
            const groups = KALYANTRA.data.constraints.resourceGroups || [];
            const tbody  = document.getElementById('resourceGroupBody');
            const empty  = document.getElementById('resourceGroupEmpty');
            const notice = document.getElementById('constraintSeedNotice');
            if (!tbody) { console.warn('resourceGroupBody not found'); return; }

            // Seed notice
            if (notice) notice.style.display = KALYANTRA.data.constraints._seededDefaults ? 'block' : 'none';

            if (groups.length === 0) {
                tbody.innerHTML = '';
                if (empty) empty.style.display = 'block';
                return;
            }
            if (empty) empty.style.display = 'none';

            tbody.innerHTML = groups.map((g, i) => `
                <tr style="border-bottom:1px solid #f1f5f9;${i%2===0?'background:#fff':'background:#fafbfc'}">
                    <td style="padding:9px 12px;">
                        <input value="${escHtml(g.name)}"
                            onchange="updateResourceGroup(${i},'name',this.value)"
                            style="border:1px solid #e2e8f0;border-radius:4px;padding:4px 8px;
                                   font-size:0.82rem;width:160px;font-weight:600;color:#1B3B6F;" />
                    </td>
                    <td style="padding:9px 12px;">
                        <input value="${escHtml(g.keywords)}"
                            onchange="updateResourceGroup(${i},'keywords',this.value)"
                            placeholder="e.g. GSB Layer, WMM Layer"
                            style="border:1px solid #e2e8f0;border-radius:4px;padding:4px 8px;
                                   font-size:0.78rem;width:260px;color:#374151;" />
                        <div style="font-size:0.68rem;color:#94a3b8;margin-top:2px;">
                            Comma-separated ‚Äî must match activity names exactly</div>
                    </td>
                    <td style="padding:9px 12px;text-align:center;">
                        <input type="number" min="1" max="10" value="${g.crews||1}"
                            onchange="updateResourceGroup(${i},'crews',+this.value)"
                            style="border:1px solid #e2e8f0;border-radius:4px;padding:4px;
                                   font-size:0.82rem;width:55px;text-align:center;" />
                    </td>
                    <td style="padding:9px 12px;text-align:center;">
                        <div style="display:flex;align-items:center;justify-content:center;gap:4px;">
                            <input type="number" min="0" step="500" value="${g.bufferM||2000}"
                                onchange="updateResourceGroup(${i},'bufferM',+this.value)"
                                style="border:1px solid #e2e8f0;border-radius:4px;padding:4px;
                                       font-size:0.82rem;width:75px;text-align:center;" />
                            <span style="font-size:0.72rem;color:#94a3b8;">m</span>
                        </div>
                    </td>
                    <td style="padding:9px 12px;text-align:center;">
                        <button onclick="removeResourceGroup(${i})"
                            style="padding:4px 10px;background:#fee2e2;color:#dc2626;
                                   border:1px solid #fecaca;border-radius:4px;font-size:0.78rem;cursor:pointer;">
                            üóë Remove
                        </button>
                    </td>
                </tr>`).join('');
        }

        function escHtml(str) {
            return String(str||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;');
        }

        function addResourceGroup() {
            ensureDefaultConstraints();
            const con = KALYANTRA.data.constraints;
            con.resourceGroups.push({
                id: 'rg' + Date.now(),
                name: 'New Group', keywords: '', crews: 1, bufferM: 2000
            });
            con._seededDefaults = false; // User edited ‚Äî hide seed notice
            _renderResourceGroups();
            _renderStretchMatrix();
        }

        function updateResourceGroup(i, field, value) {
            const con = KALYANTRA.data.constraints;
            if (con.resourceGroups[i]) {
                con.resourceGroups[i][field] = value;
                con._seededDefaults = false;
            }
        }

        function removeResourceGroup(i) {
            if (!confirm('Remove this resource group?')) return;
            KALYANTRA.data.constraints.resourceGroups.splice(i, 1);
            _renderResourceGroups();
            _renderStretchMatrix();
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // SECTION 2 ‚Äî Stretch Transition Override Matrix
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function _renderStretchMatrix() {
            const container = document.getElementById('stretchOverrideTable');
            if (!container) { console.warn('stretchOverrideTable not found'); return; }

            const wbs       = KALYANTRA.computed.wbs || [];
            const stretches = wbs.filter(w => w.type === 'stretch');
            const groups    = KALYANTRA.data.constraints.resourceGroups || [];
            const overrides = KALYANTRA.data.constraints.stretchOverrides || {};

            if (stretches.length < 2) {
                container.innerHTML = `<div style="padding:16px 18px;color:#94a3b8;font-size:0.82rem;">
                    ‚ÑπÔ∏è Need at least 2 workable stretches to configure transition overrides.
                    Define stretches in <strong>TCS & Sections</strong> first.</div>`;
                return;
            }
            if (groups.length === 0) {
                container.innerHTML = `<div style="padding:16px 18px;color:#94a3b8;font-size:0.82rem;">
                    ‚ÑπÔ∏è Add resource groups above to configure stretch-specific overrides.</div>`;
                return;
            }

            // Build consecutive stretch pairs
            const pairs = [];
            for (let i = 0; i < stretches.length - 1; i++) {
                const from = stretches[i], to = stretches[i+1];
                pairs.push({ from, to, key: `${from.wbs}‚Üí${to.wbs}` });
            }

            const fmtCh = m => {
                const k = Math.floor(m/1000), r = m%1000;
                return `Ch ${k}+${String(r).padStart(3,'0')}`;
            };

            let html = `<table style="width:100%;border-collapse:collapse;font-size:0.8rem;">
                <thead><tr style="background:#f1f5f9;">
                <th style="padding:8px 12px;text-align:left;color:#475569;font-weight:600;
                           white-space:nowrap;border-right:2px solid #e5e7eb;">Transition</th>`;
            groups.forEach(g => {
                html += `<th style="padding:8px 12px;text-align:center;color:#475569;font-weight:600;">
                    ${escHtml(g.name)}
                    <div style="font-size:0.65rem;font-weight:400;color:#94a3b8;">
                        default ${(g.bufferM/1000).toFixed(1)}km buffer</div></th>`;
            });
            html += `</tr></thead><tbody>`;

            pairs.forEach((pair, pi) => {
                const fromCh = pair.from.chainage ? fmtCh(pair.from.chainage.end||0) : pair.from.wbs;
                const toCh   = pair.to.chainage   ? fmtCh(pair.to.chainage.start||0) : pair.to.wbs;
                html += `<tr style="border-bottom:1px solid #f1f5f9;${pi%2===0?'':'background:#fafbfc'}">
                    <td style="padding:9px 12px;border-right:2px solid #e5e7eb;">
                        <div style="font-weight:600;color:#1B3B6F;font-size:0.8rem;">
                            ${pair.from.wbs} ‚Üí ${pair.to.wbs}</div>
                        <div style="font-size:0.68rem;color:#94a3b8;margin-top:2px;">
                            ${fromCh} handover</div>
                    </td>`;

                groups.forEach(g => {
                    const ov  = (overrides[pair.key]||{})[g.name] || {};
                    const buf = ov.bufferM !== undefined && ov.bufferM !== null ? ov.bufferM : '';
                    const lag = ov.lagDays  !== undefined && ov.lagDays  !== null ? ov.lagDays  : '';
                    const hasOv = buf !== '' || lag !== '';
                    const cellBg = hasOv ? '#fffbeb' : 'transparent';
                    const bdr    = hasOv ? '#D4AF37' : '#e2e8f0';
                    html += `<td style="padding:8px 12px;text-align:center;background:${cellBg};">
                        <div style="display:flex;flex-direction:column;gap:5px;align-items:center;">
                            <div style="display:flex;align-items:center;gap:4px;">
                                <span style="font-size:0.65rem;color:#94a3b8;width:50px;text-align:right;">Buffer m</span>
                                <input type="number" min="0" step="500" value="${buf}"
                                    placeholder="${g.bufferM}"
                                    onchange="setStretchOv('${pair.key}','${escHtml(g.name)}','bufferM',
                                              this.value===''?null:+this.value)"
                                    style="width:65px;border:1px solid ${bdr};border-radius:4px;
                                           padding:3px 5px;font-size:0.78rem;text-align:center;
                                           background:${cellBg};" />
                            </div>
                            <div style="display:flex;align-items:center;gap:4px;">
                                <span style="font-size:0.65rem;color:#94a3b8;width:50px;text-align:right;">Lag days</span>
                                <input type="number" min="0" value="${lag}"
                                    placeholder="‚Äî"
                                    onchange="setStretchOv('${pair.key}','${escHtml(g.name)}','lagDays',
                                              this.value===''?null:+this.value)"
                                    style="width:65px;border:1px solid ${bdr};border-radius:4px;
                                           padding:3px 5px;font-size:0.78rem;text-align:center;
                                           background:${cellBg};" />
                            </div>
                        </div>
                    </td>`;
                });
                html += `</tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function setStretchOv(pairKey, groupName, field, value) {
            const con = KALYANTRA.data.constraints;
            if (!con.stretchOverrides[pairKey]) con.stretchOverrides[pairKey] = {};
            if (!con.stretchOverrides[pairKey][groupName]) con.stretchOverrides[pairKey][groupName] = {};
            con.stretchOverrides[pairKey][groupName][field] = value;
            applyConstraints(KALYANTRA.computed.wbs || []);
            _renderViolations();
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // SECTION 3 ‚Äî Layer Cure Lags
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function _renderCureLags() {
            const tbody = document.getElementById('cureLagBody');
            if (!tbody) { console.warn('cureLagBody not found'); return; }
            const overrides = KALYANTRA.data.constraints.cureLagOverrides || {};
            tbody.innerHTML = IRC_CURE_LAGS.map((row, i) => {
                const effective   = overrides[i] !== undefined ? overrides[i] : row.lag;
                const isOverride  = overrides[i] !== undefined && overrides[i] !== row.lag;
                return `<tr style="border-bottom:1px solid #f1f5f9;${i%2===0?'':'background:#fafbfc'}">
                    <td style="padding:9px 12px;color:#374151;font-weight:500;">${row.after}</td>
                    <td style="padding:9px 12px;color:#374151;">${row.before}</td>
                    <td style="padding:9px 12px;text-align:center;">
                        <input type="number" min="0" value="${effective}"
                            onchange="setCureLagOv(${i}, +this.value)"
                            style="width:60px;border:1px solid ${isOverride?'#D4AF37':'#e2e8f0'};
                                   border-radius:4px;padding:4px;font-size:0.82rem;text-align:center;
                                   background:${isOverride?'#fffbeb':'white'};" />
                        ${row.lag===0 ? '<span style="font-size:0.7rem;color:#94a3b8;margin-left:4px;">immediate</span>' : ''}
                        ${isOverride  ? '<span style="font-size:0.7rem;color:#D4AF37;margin-left:4px;">modified</span>' : ''}
                    </td>
                    <td style="padding:9px 12px;color:#64748b;font-size:0.75rem;">${row.ref}</td>
                </tr>`;
            }).join('');
        }

        function setCureLagOv(index, value) {
            if (!KALYANTRA.data.constraints.cureLagOverrides)
                KALYANTRA.data.constraints.cureLagOverrides = {};
            KALYANTRA.data.constraints.cureLagOverrides[index] = value;
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // SECTION 4 ‚Äî Violation Log
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function _renderViolations() {
            const violations = KALYANTRA.data.constraints.violations || [];
            const log    = document.getElementById('violationLog');
            const badge  = document.getElementById('violationBadge');
            const banner = document.getElementById('constraintViolationBanner');
            const bCount = document.getElementById('constraintViolationCount');

            if (badge)  badge.textContent  = violations.length;
            if (banner) banner.style.display = violations.length > 0 ? 'block' : 'none';
            if (bCount) bCount.textContent = violations.length;
            if (!log)   return;

            if (violations.length === 0) {
                log.innerHTML = `<div style="padding:14px 18px;text-align:center;
                    color:#16a34a;font-weight:600;font-size:0.85rem;">
                    ‚úÖ No violations detected. Schedule is consistent with defined constraints.</div>`;
                return;
            }

            log.innerHTML = violations.map(v => {
                const isRes = v.type === 'resource';
                const bg    = isRes ? '#fef2f2' : '#fffbeb';
                const bdr   = isRes ? '#fecaca' : '#fde68a';
                const col   = isRes ? '#991b1b' : '#92400e';
                const icon  = isRes ? 'üë•' : 'üìè';
                const label = isRes ? 'Resource Conflict' : 'Buffer Violation';
                return `<div style="background:${bg};border:1px solid ${bdr};border-radius:6px;
                        padding:10px 14px;margin-bottom:8px;display:flex;gap:10px;align-items:flex-start;">
                    <span style="font-size:1rem;margin-top:1px;">${icon}</span>
                    <div style="flex:1;">
                        <div style="font-weight:600;color:${col};font-size:0.82rem;">${label}</div>
                        <div style="color:#374151;font-size:0.8rem;margin-top:3px;">${v.message}</div>
                    </div>
                    <span style="background:${bdr};color:${col};padding:2px 8px;border-radius:10px;
                           font-size:0.7rem;font-weight:700;white-space:nowrap;">${v.severity.toUpperCase()}</span>
                </div>`;
            }).join('');
        }

        // ‚îÄ‚îÄ Save constraints ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function saveConstraints() {
            KALYANTRA.save();
            if (typeof showToast === 'function') showToast('‚úÖ Constraints saved', 'success');
            KALYANTRA.refresh();
            renderConstraintsTab();
        }

        // Legacy aliases (called from old HTML onclick handlers)
        function renderResourceGroupTable()   { _renderResourceGroups(); }
        function renderStretchOverrideMatrix() { _renderStretchMatrix(); }
        function renderCureLagTable()          { _renderCureLags(); }
        function renderViolationLog()          { _renderViolations(); }
        function updateGroup(i,f,v)            { updateResourceGroup(i,f,v); }
        function deleteResourceGroup(i)        { removeResourceGroup(i); }
        function setStretchOverride(k,g,f,v)   { setStretchOv(k,g,f,v); }
        function setCureLagOverride(i,v)       { setCureLagOv(i,v); }





        function renderReportsTab() {
    // Reports tab is static HTML with onclick handlers ‚Äî just ensure
    // the tab is visible and generateReport is ready
    const panel = document.getElementById('tab11');
    if (!panel) return;
    // Update any dynamic summary numbers in the reports template grid
    try {
        KALYANTRA.refresh();
        const c = KALYANTRA.computed;
        const d = KALYANTRA.data;
        // Update the "last generated" info if elements exist
        const today = new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
        panel.querySelectorAll('.report-last-date').forEach(el => el.textContent = today);
        // Update project name in any report header placeholders
        panel.querySelectorAll('.report-project-name').forEach(el => {
            el.textContent = (d.project && d.project.name) || 'Project';
        });
    } catch(e) { /* non-critical */ }
}

// ‚îÄ‚îÄ REPORT MODAL ‚Äî used by generateReport(type) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// The existing generateReport function creates a popup window for printing.
// Wire the reportModal creation so it doesn't fail silently.
(function patchGenerateReport() {
    if (typeof generateReport !== 'function') return;
    const _orig = generateReport;
    if (_orig._reportPatched) return;

    window.generateReport = function(type) {
        try {
            _orig(type);
        } catch(e) {
            // Fallback: open a simple print window with project summary
            const d = KALYANTRA.data;
            const c = KALYANTRA.computed;
            const proj = d.project || {};
            const today = new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
            const titles = {
                daily: 'Daily Progress Report',
                weekly: 'Weekly Progress Report',
                hindrance: 'Hindrance Status Report',
                financial: 'Financial Progress Report',
                completion: 'Project Completion Forecast'
            };
            const win = window.open('','_blank','width=900,height=700,scrollbars=yes');
            if (!win) { showToast('Allow popups to view reports', 'info'); return; }
            win.document.write(`
                <html><head><title>KALYANTRA ‚Äî ${titles[type]||type}</title>
                <style>
                body{font-family:Arial,sans-serif;padding:32px;color:#1e293b;max-width:860px;margin:0 auto;}
                h1{color:#1B3B6F;border-bottom:3px solid #D4AF37;padding-bottom:10px;}
                h3{color:#1B3B6F;margin-top:24px;}
                table{width:100%;border-collapse:collapse;margin:12px 0;}
                th{background:#1B3B6F;color:#D4AF37;padding:8px 12px;text-align:left;font-size:0.85rem;}
                td{padding:7px 12px;border-bottom:1px solid #e2e8f0;font-size:0.85rem;}
                tr:nth-child(even){background:#f8fafc;}
                .badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:0.75rem;font-weight:700;}
                .badge-red{background:#fee2e2;color:#dc2626;}
                .badge-green{background:#dcfce7;color:#16a34a;}
                .badge-yellow{background:#fef9c3;color:#ca8a04;}
                .footer{margin-top:32px;padding-top:12px;border-top:1px solid #e2e8f0;font-size:0.75rem;color:#94a3b8;}
                @media print{button{display:none;}}
                </style></head><body>
                <button onclick="window.print()" style="background:#1B3B6F;color:#D4AF37;border:none;padding:8px 18px;border-radius:5px;cursor:pointer;font-weight:700;margin-bottom:20px;">üñ®Ô∏è Print</button>
                <h1>KALYANTRA ‚Äî ${titles[type]||type}</h1>
                <p style="color:#64748b;">Project: <strong>${proj.name||'‚Äî'}</strong> &nbsp;|&nbsp; Date: <strong>${today}</strong></p>

                <h3>Project Overview</h3>
                <table>
                    <tr><th>Parameter</th><th>Value</th></tr>
                    <tr><td>Project Name</td><td>${proj.name||'‚Äî'}</td></tr>
                    <tr><td>Start Chainage</td><td>Ch ${proj.startChainage||0}</td></tr>
                    <tr><td>End Chainage</td><td>Ch ${proj.endChainage||0}</td></tr>
                    <tr><td>Contract Start</td><td>${proj.startDate||'‚Äî'}</td></tr>
                    <tr><td>Completion Date</td><td>${proj.endDate||'‚Äî'}</td></tr>
                    <tr><td>Contract Value</td><td>‚Çπ${proj.budget||0} Cr</td></tr>
                    <tr><td>Overall Progress</td><td>${c.overallProgress||0}%</td></tr>
                </table>

                <h3>WBS Summary</h3>
                <table>
                    <tr><th>WBS</th><th>Name</th><th>Type</th><th>Duration</th><th>Cost</th><th>Status</th></tr>
                    ${(c.wbs||[]).map(w=>`<tr>
                        <td>${w.wbs}</td><td>${w.name}</td><td>${w.type}</td>
                        <td>${w.duration||0} days</td><td>‚Çπ${w.cost||0} Cr</td>
                        <td><span class="badge badge-${w.status==='Workable'?'green':w.status==='Hindrance'?'red':'yellow'}">${w.status}</span></td>
                    </tr>`).join('')||'<tr><td colspan="6" style="text-align:center;color:#94a3b8;">No WBS items yet</td></tr>'}
                </table>

                <h3>Active Hindrances</h3>
                <table>
                    <tr><th>Hindrance</th><th>Type</th><th>Chainage</th><th>Status</th></tr>
                    ${(d.hindrances||[]).filter(h=>h.status!=='Resolved').map(h=>`<tr>
                        <td>${h.name}</td><td>${h.type}</td>
                        <td>Ch ${h.chainageStart||0}‚Äì${h.chainageEnd||0}</td>
                        <td><span class="badge badge-${h.status==='Pending'?'red':'yellow'}">${h.status}</span></td>
                    </tr>`).join('')||'<tr><td colspan="4" style="text-align:center;color:#94a3b8;">No active hindrances</td></tr>'}
                </table>

                <h3>Structures</h3>
                <table>
                    <tr><th>Structure</th><th>Type</th><th>Chainage</th><th>Progress</th></tr>
                    ${(d.structures||[]).map(s=>`<tr>
                        <td>${s.name}</td><td>${s.type||'‚Äî'}</td>
                        <td>Ch ${s.chainage||0}</td>
                        <td>${s.progressPct||0}%</td>
                    </tr>`).join('')||'<tr><td colspan="4" style="text-align:center;color:#94a3b8;">No structures defined</td></tr>'}
                </table>

                <div class="footer">Generated by KALYANTRA Infrastructure PM System &nbsp;|&nbsp; ${today}</div>
                
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KALYANTRA V9.6 ‚Äî BULLETPROOF TAB VISIBILITY + AUTO-RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Override showTab to add explicit inline styles for V9 tabs
const _V9_TAB_IDS = ['tabBaseline','tabScenarios','tabAlerts','tabEarnedValue'];

function showV9Tab(tabId) {
    // Hide all tab panels
    document.querySelectorAll('.tab-panel').forEach(p => {
        p.classList.remove('active');
        p.style.display = '';
    });
    const panel = document.getElementById(tabId);
    if (!panel) { console.warn('showV9Tab: panel not found:', tabId); return; }
    
    // Get actual sidebar width
    const sidebarW = parseInt(getComputedStyle(document.documentElement)
        .getPropertyValue('--sidebar-w')) || 220;
    const headerH = parseInt(getComputedStyle(document.documentElement)
        .getPropertyValue('--header-h')) || 72;
    
    // Apply explicit styles (bypass CSS var issues)
    panel.style.cssText = [
        'display:block',
        'position:fixed',
        `top:${headerH}px`,
        `left:${sidebarW}px`,
        'right:0',
        'bottom:0',
        'z-index:10',
        'overflow-y:auto',
        'background:#f8fafc'
    ].join(';');
}

// Override switchMainTab to intercept V9 tabs
(function patchForV9Visibility() {
    const _orig = window.switchMainTab;
    if (typeof _orig !== 'function') { setTimeout(patchForV9Visibility, 200); return; }
    window.switchMainTab = function(index) {
        const V9_MAP = {12:'tabBaseline', 13:'tabScenarios', 14:'tabAlerts', 15:'tabEarnedValue'};
        if (V9_MAP[index]) {
            _orig(index); // let original run to update sidebar state
            showV9Tab(V9_MAP[index]);
            // Update sidebar active item
            document.querySelectorAll('.sidebar-item').forEach(item => {
                const dt = parseInt(item.getAttribute('data-tab') || '-1');
                item.classList.toggle('active', dt === index);
            });
        } else {
            // For non-V9 tabs: restore any V9 tab to default (remove inline style)
            _V9_TAB_IDS.forEach(id => {
                const el = document.getElementById(id);
                if (el) { el.style.cssText = ''; }
            });
            _orig(index);
        }
    };
    console.log('‚úÖ V9 tab visibility patch installed');
})();

// Auto-render V9 tab contents when they become visible
function autoRenderV9Tab(index) {
    const renders = {
        12: () => { if (typeof renderBaselineInfo === 'function') renderBaselineInfo(); },
        13: () => { if (typeof initScenariosTab === 'function') initScenariosTab(); },
        14: () => { 
            if (typeof computeAllAlerts === 'function') computeAllAlerts(); 
            setTimeout(() => { if (typeof renderAlertsTab === 'function') renderAlertsTab(); }, 200);
        },
        15: () => { if (typeof renderEarnedValueTab === 'function') renderEarnedValueTab(); }
    };
    if (renders[index]) setTimeout(renders[index], 100);
}

// Patch sidebarSwitchTab LAST to ensure autoRender runs
(function patchSSTForV9Render() {
    const _origSST = window.sidebarSwitchTab;
    if (typeof _origSST !== 'function') { setTimeout(patchSSTForV9Render, 300); return; }
    window.sidebarSwitchTab = function(index, clickedItem) {
        _origSST(index, clickedItem);
        autoRenderV9Tab(index);
    };
    console.log('‚úÖ V9 auto-render patch installed');
})();

// Activities sub-tab: ensure render fires and shows data
function forceRenderActivities() {
    try {
        KALYANTRA.refresh();
        const activities = KALYANTRA.computed.activities;
        const tbody = document.getElementById('activitiesBody');
        if (!tbody) return;
        
        if (!activities || !activities.length) {
            tbody.innerHTML = '<tr><td colspan="9" style="padding:20px;text-align:center;color:#94a3b8;font-style:italic;">No activities yet ‚Äî click REFRESH WBS to generate the schedule.</td></tr>';
            return;
        }
        
        // Call the original renderer
        if (typeof renderActivitiesTable === 'function') renderActivitiesTable();
        
    } catch(e) {
        console.error('forceRenderActivities error:', e);
        const tbody = document.getElementById('activitiesBody');
        if (tbody) tbody.innerHTML = '<tr><td colspan="9" style="padding:20px;text-align:center;color:#e74c3c;">Error loading activities: ' + e.message + '</td></tr>';
    }
}

// Gantt: ensure render fires
function forceRenderGantt() {
    try {
        KALYANTRA.refresh();
        if (typeof renderGantt === 'function') renderGantt();
    } catch(e) {
        console.error('forceRenderGantt error:', e);
    }
}

// Patch switchTab7Child to use force renders
(function patchTab7Children() {
    const _orig7 = window.switchTab7Child;
    if (typeof _orig7 !== 'function') { setTimeout(patchTab7Children, 300); return; }
    window.switchTab7Child = function(index) {
        _orig7(index);
        if (index === 1) setTimeout(forceRenderActivities, 100);
        if (index === 2) setTimeout(forceRenderGantt, 100);
    };
    console.log('‚úÖ Tab7 child render patch installed');
})();

// On page load: ensure any lingering V9 tab is cleaned up
document.addEventListener('DOMContentLoaded', function() {
    // After all scripts load, ensure Alerts/Scenarios render if their data is ready
    setTimeout(function() {
        if (typeof computeAllAlerts === 'function') computeAllAlerts();
    }, 2000);
});
</script>

</body></html>
            `);
            win.document.close();
        }
    };
    window.generateReport._reportPatched = true;
})();

// Re-patch on DOMContentLoaded to ensure generateReport is defined first
document.addEventListener('DOMContentLoaded', () => {
    // patchGenerateReport already runs as IIFE above; nothing needed here
});

</script>

<script>
// Legacy BOQ stubs ‚Äî prevent console errors from hidden tab12 panel
(function() {
    function _stub(name, msg) {
        if (typeof window[name] === 'undefined') {
            window[name] = function() {
                if (typeof showToast === 'function') showToast(msg, 'info');
            };
        }
    }
    _stub('boqAddSection',      'Use the BOQ tab to add road items.');
    _stub('boqAddStructureBOQ', 'Use the BOQ tab to add structure items.');
    if (typeof boqGenerateWBS === 'undefined') {
        window.boqGenerateWBS = function() {
            if (typeof generateWBS === 'function') generateWBS();
        };
    }
})();
</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KALYANTRA V9 ‚Äî SESSION 1: RESOURCES + CALENDAR SHIFT ENGINE
// Complete resource productivity model with density support
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ SHIFT CONFIGURATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SHIFT_HOURS = { single: 8, double: 16, triple: 24 };

function getShiftHours(shiftKey) {
    return SHIFT_HOURS[shiftKey] || 8;
}

function saveShiftConfig() {
    const selected = document.querySelector('input[name="defaultShift"]:checked');
    if (!selected) return;
    const shift = selected.value;
    if (!KALYANTRA.data.calendar) KALYANTRA.data.calendar = {};
    KALYANTRA.data.calendar.defaultShift = shift;
    KALYANTRA.data.calendar.shiftOverrides = KALYANTRA.data.calendar.shiftOverrides || [];
    updateShiftDisplay(shift);
    // Update all radio label styles
    ['single','double','triple'].forEach(s => {
        const lbl = document.getElementById(`shiftLbl_${s}`);
        if (lbl) {
            lbl.style.border = s === shift ? '2px solid #D4AF37' : '2px solid #e2e8f0';
            lbl.style.background = s === shift ? '#fffbeb' : '#f8fafc';
        }
    });
    KALYANTRA.supabaseSave && KALYANTRA.supabaseSave();
    showToast('‚úÖ Shift configuration saved', 'success');
}

function updateShiftDisplay(shift) {
    const hrs = SHIFT_HOURS[shift] || 8;
    const el = document.getElementById('shiftHrsValue');
    if (el) el.textContent = hrs;
    // Recalculate all equipment daily outputs
    renderEquipmentTableNew();
}

function initShiftConfig() {
    const cal = KALYANTRA.data.calendar || {};
    const defaultShift = cal.defaultShift || 'single';
    const radio = document.querySelector(`input[name="defaultShift"][value="${defaultShift}"]`);
    if (radio) radio.checked = true;
    updateShiftDisplay(defaultShift);
    ['single','double','triple'].forEach(s => {
        const lbl = document.getElementById(`shiftLbl_${s}`);
        if (lbl) {
            lbl.style.border = s === defaultShift ? '2px solid #D4AF37' : '2px solid #e2e8f0';
            lbl.style.background = s === defaultShift ? '#fffbeb' : '#f8fafc';
        }
    });
    renderShiftOverrides();
}

function addShiftOverride() {
    if (!KALYANTRA.data.calendar) KALYANTRA.data.calendar = {};
    if (!KALYANTRA.data.calendar.shiftOverrides) KALYANTRA.data.calendar.shiftOverrides = [];
    const wbs = KALYANTRA.computed.wbs || [];
    // Build activity options from computed WBS
    const actOptions = wbs.length
        ? wbs.flatMap(s => (s.activities || []).map(a =>
            `<option value="${s.id}|${a.id}">${s.stretchLabel} ‚Äî ${a.name}</option>`)).join('')
        : '<option value="">No activities yet ‚Äî generate WBS first</option>';

    const ovr = {
        id: 'ovr_' + Date.now(),
        activityRef: '',
        shift: 'double',
        reason: 'monsoon_closure',
        reasonNote: '',
        changedAt: new Date().toISOString().split('T')[0]
    };
    KALYANTRA.data.calendar.shiftOverrides.push(ovr);
    renderShiftOverrides();
}

function removeShiftOverride(id) {
    if (!KALYANTRA.data.calendar || !KALYANTRA.data.calendar.shiftOverrides) return;
    KALYANTRA.data.calendar.shiftOverrides = KALYANTRA.data.calendar.shiftOverrides.filter(o => o.id !== id);
    renderShiftOverrides();
    KALYANTRA.supabaseSave && KALYANTRA.supabaseSave();
}

function updateShiftOverride(id, field, value) {
    const cal = KALYANTRA.data.calendar;
    if (!cal || !cal.shiftOverrides) return;
    const ovr = cal.shiftOverrides.find(o => o.id === id);
    if (ovr) {
        ovr[field] = value;
        // Recalculate if shift changed
        if (field === 'shift') KALYANTRA.refresh && KALYANTRA.refresh();
    }
}

function renderShiftOverrides() {
    const container = document.getElementById('shiftOverrideList');
    const emptyEl = document.getElementById('shiftOverrideEmpty');
    if (!container) return;
    const cal = KALYANTRA.data.calendar || {};
    const overrides = cal.shiftOverrides || [];
    const wbs = KALYANTRA.computed.wbs || [];
    const actOptions = wbs.length
        ? wbs.flatMap(s => (s.activities || []).map(a =>
            `<option value="${s.id}|${a.id}">${s.stretchLabel || s.id} ‚Äî ${a.name}</option>`)).join('')
        : '<option value="">Generate WBS first</option>';

    if (overrides.length === 0) {
        container.innerHTML = `<div style="padding:10px 14px;background:#f8fafc;border:1px dashed #cbd5e1;border-radius:6px;text-align:center;color:#94a3b8;font-size:0.8rem;">No activity overrides. All activities use the project default shift.</div>`;
        return;
    }

    const REASONS = {
        monsoon_closure: 'Monsoon Window Closing',
        milestone_pressure: 'Milestone Deadline Pressure',
        resource_optimization: 'Resource Optimization',
        client_direction: 'Client / IE Direction',
        critical_path: 'Critical Path Acceleration',
        other: 'Other (specify below)'
    };

    container.innerHTML = overrides.map(ovr => `
        <div style="padding:10px 14px;background:#fff;border:1px solid #e2e8f0;border-radius:6px;display:grid;grid-template-columns:2fr 1fr 1.5fr 1.5fr auto;gap:8px;align-items:center;">
            <select onchange="updateShiftOverride('${ovr.id}','activityRef',this.value)" style="font-size:0.76rem;padding:5px 8px;border:1px solid #e2e8f0;border-radius:4px;color:#374151;">
                <option value="">Select Activity‚Ä¶</option>
                ${actOptions}
            </select>
            <select onchange="updateShiftOverride('${ovr.id}','shift',this.value)" style="font-size:0.76rem;padding:5px 8px;border:1px solid #e2e8f0;border-radius:4px;">
                <option value="single" ${ovr.shift==='single'?'selected':''}>üåÖ Single (8h)</option>
                <option value="double" ${ovr.shift==='double'?'selected':''}>üåô Double (16h)</option>
                <option value="triple" ${ovr.shift==='triple'?'selected':''}>üîÑ Round Clock (24h)</option>
            </select>
            <select onchange="updateShiftOverride('${ovr.id}','reason',this.value)" style="font-size:0.76rem;padding:5px 8px;border:1px solid #e2e8f0;border-radius:4px;">
                ${Object.entries(REASONS).map(([k,v])=>`<option value="${k}" ${ovr.reason===k?'selected':''}>${v}</option>`).join('')}
            </select>
            <input type="text" placeholder="Note (EOT evidence)‚Ä¶" value="${ovr.reasonNote||''}"
                onchange="updateShiftOverride('${ovr.id}','reasonNote',this.value)"
                style="font-size:0.76rem;padding:5px 8px;border:1px solid #e2e8f0;border-radius:4px;" />
            <button onclick="removeShiftOverride('${ovr.id}')" style="padding:4px 8px;background:#fee2e2;color:#dc2626;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem;">‚úï</button>
        </div>
    `).join('');
}

// ‚îÄ‚îÄ RESOURCES TAB SWITCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchResTab(idx) {
    [0,1,2].forEach(i => {
        const btn = document.getElementById(`resTabBtn${i}`);
        const panel = document.getElementById(`resPanel${i}`);
        if (!btn || !panel) return;
        const active = i === idx;
        btn.style.color = active ? '#1B3B6F' : '#64748b';
        btn.style.fontWeight = active ? '700' : '600';
        btn.style.borderBottom = active ? '3px solid #1B3B6F' : '3px solid transparent';
        panel.style.display = active ? 'block' : 'none';
    });
}

function toggleProductivityGap() {
    const panel = document.getElementById('productivityGapPanel');
    if (!panel) return;
    const visible = panel.style.display !== 'none';
    panel.style.display = visible ? 'none' : 'block';
    if (!visible) renderGapTable();
}

// ‚îÄ‚îÄ EQUIPMENT (PLANT & MACHINERY) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addEquipmentNew() {
    if (!KALYANTRA.data.resources) KALYANTRA.data.resources = { equipment:[], manpower:[], materials:[] };
    const eqList = KALYANTRA.data.resources.equipment;
    const cal = KALYANTRA.data.calendar || {};
    const defaultShift = cal.defaultShift || 'single';
    eqList.push({
        id: 'eq_' + Date.now(),
        name: '',
        capacity: '',
        ratedProductivity: 0,
        availableProductivity: 0,
        productivityUnit: 'm¬≥/hr',
        shift: defaultShift,
        unitsDeployed: 1,
        activityKeywords: '',
        frozen: false
    });
    renderEquipmentTableNew();
}

function removeEquipment(idx) {
    const eqList = KALYANTRA.data.resources.equipment || [];
    eqList.splice(idx, 1);
    renderEquipmentTableNew();
    updateCoverageWarnings();
}

function updateEquipField(idx, field, value) {
    const eq = (KALYANTRA.data.resources.equipment || [])[idx];
    if (!eq) return;
    const num = ['ratedProductivity','availableProductivity','unitsDeployed'];
    eq[field] = num.includes(field) ? (parseFloat(value)||0) : value;
    // Recompute daily output display for this row
    refreshEquipRow(idx);
    updateCoverageWarnings();
}

function refreshEquipRow(idx) {
    const eq = (KALYANTRA.data.resources.equipment || [])[idx];
    if (!eq) return;
    const cell = document.getElementById(`eq_daily_${idx}`);
    if (!cell) return;
    const shiftHrs = getShiftHours(eq.shift || 'single');
    const daily = (eq.availableProductivity || 0) * shiftHrs * (eq.unitsDeployed || 1);
    const unit = (eq.productivityUnit || '').replace('/hr','');
    cell.innerHTML = `<strong style="color:#1B3B6F;">${daily.toFixed(1)}</strong> <span style="color:#64748b;font-size:0.72rem;">${unit}/day</span>`;
}

function renderEquipmentTableNew() {
    const tbody = document.getElementById('equipmentTableNew');
    if (!tbody) return;
    const eqList = (KALYANTRA.data.resources || {}).equipment || [];
    const cal = KALYANTRA.data.calendar || {};
    const defaultShift = cal.defaultShift || 'single';

    const UNITS = ['m¬≥/hr','m/hr','MT/hr','m¬≤/hr','Nos/hr'];
    const SHIFTS = [
        {v:'single', l:'üåÖ Single (8h)'},
        {v:'double', l:'üåô Double (16h)'},
        {v:'triple', l:'üîÑ Round Clock (24h)'}
    ];

    if (eqList.length === 0) {
        tbody.innerHTML = `<tr id="equipEmptyRow"><td colspan="9" style="padding:20px;text-align:center;color:#94a3b8;font-size:0.82rem;">No equipment defined. Click + Add Equipment to start.</td></tr>`;
        return;
    }

    tbody.innerHTML = eqList.map((eq, i) => {
        const shift = eq.shift || defaultShift;
        const shiftHrs = getShiftHours(shift);
        const daily = (eq.availableProductivity || 0) * shiftHrs * (eq.unitsDeployed || 1);
        const unit = (eq.productivityUnit || 'm¬≥/hr').replace('/hr','');
        const gapPct = eq.ratedProductivity > 0
            ? Math.round((1 - eq.availableProductivity/eq.ratedProductivity)*100) : 0;
        const gapBadge = gapPct > 0
            ? `<span style="font-size:0.68rem;background:#fef3c7;color:#92400e;padding:1px 5px;border-radius:3px;margin-left:4px;">-${gapPct}% derated</span>` : '';

        return `<tr style="border-bottom:1px solid #f1f5f9;${eq.frozen?'opacity:0.7;':''}" id="eqRow_${i}">
            <td style="padding:7px 10px;">
                <input type="text" value="${eq.name||''}" placeholder="e.g. Motor Grader"
                    onchange="updateEquipField(${i},'name',this.value)"
                    style="width:100%;font-size:0.78rem;padding:4px 7px;border:1px solid #e2e8f0;border-radius:4px;${eq.frozen?'pointer-events:none;background:#f8fafc;':''}" />
            </td>
            <td style="padding:7px 8px;text-align:center;">
                <input type="number" min="0" step="0.1" value="${eq.ratedProductivity||''}" placeholder="Rated"
                    onchange="updateEquipField(${i},'ratedProductivity',this.value)"
                    style="width:70px;font-size:0.78rem;padding:4px 6px;border:1px solid #e2e8f0;border-radius:4px;text-align:center;${eq.frozen?'pointer-events:none;background:#f8fafc;':''}" />
            </td>
            <td style="padding:7px 8px;text-align:center;">
                <input type="number" min="0" step="0.1" value="${eq.availableProductivity||''}" placeholder="Available"
                    onchange="updateEquipField(${i},'availableProductivity',this.value)"
                    style="width:70px;font-size:0.78rem;padding:4px 6px;border:1px solid ${eq.ratedProductivity>0&&eq.availableProductivity<eq.ratedProductivity?'#fcd34d':'#e2e8f0'};border-radius:4px;text-align:center;${eq.frozen?'pointer-events:none;background:#f8fafc;':''}" />
                ${gapBadge}
            </td>
            <td style="padding:7px 8px;text-align:center;">
                <select onchange="updateEquipField(${i},'productivityUnit',this.value);refreshEquipRow(${i})"
                    style="font-size:0.76rem;padding:4px 6px;border:1px solid #e2e8f0;border-radius:4px;${eq.frozen?'pointer-events:none;background:#f8fafc;':''}">
                    ${UNITS.map(u=>`<option value="${u}" ${eq.productivityUnit===u?'selected':''}>${u}</option>`).join('')}
                </select>
            </td>
            <td style="padding:7px 8px;text-align:center;">
                <select onchange="updateEquipField(${i},'shift',this.value);refreshEquipRow(${i})"
                    style="font-size:0.76rem;padding:4px 6px;border:1px solid #e2e8f0;border-radius:4px;${eq.frozen?'pointer-events:none;background:#f8fafc;':''}">
                    ${SHIFTS.map(s=>`<option value="${s.v}" ${shift===s.v?'selected':''}>${s.l}</option>`).join('')}
                </select>
            </td>
            <td style="padding:7px 8px;text-align:center;">
                <input type="number" min="1" max="99" step="1" value="${eq.unitsDeployed||1}"
                    onchange="updateEquipField(${i},'unitsDeployed',this.value)"
                    style="width:50px;font-size:0.78rem;padding:4px 6px;border:1px solid #e2e8f0;border-radius:4px;text-align:center;${eq.frozen?'pointer-events:none;background:#f8fafc;':''}" />
            </td>
            <td style="padding:7px 8px;text-align:center;" id="eq_daily_${i}">
                <strong style="color:#1B3B6F;">${daily.toFixed(1)}</strong>
                <span style="color:#64748b;font-size:0.72rem;"> ${unit}/day</span>
            </td>
            <td style="padding:7px 8px;">
                <input type="text" value="${eq.activityKeywords||''}" placeholder="Earthwork, Subgrade‚Ä¶"
                    onchange="updateEquipField(${i},'activityKeywords',this.value)"
                    style="width:100%;font-size:0.76rem;padding:4px 7px;border:1px solid #e2e8f0;border-radius:4px;" />
            </td>
            <td style="padding:7px 8px;text-align:center;">
                ${eq.frozen
                    ? `<button onclick="toggleEquipFrozen(${i})" style="padding:3px 7px;background:#fef9c3;color:#92400e;border:1px solid #fde68a;border-radius:4px;font-size:0.72rem;cursor:pointer;">üîì</button>`
                    : `<button onclick="removeEquipment(${i})" style="padding:3px 7px;background:#fee2e2;color:#dc2626;border:none;border-radius:4px;font-size:0.72rem;cursor:pointer;">‚úï</button>`
                }
            </td>
        </tr>`;
    }).join('');
}

function toggleEquipFrozen(idx) {
    const eq = (KALYANTRA.data.resources.equipment || [])[idx];
    if (eq) { eq.frozen = !eq.frozen; renderEquipmentTableNew(); }
}

// ‚îÄ‚îÄ MANPOWER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addManpowerNew() {
    if (!KALYANTRA.data.resources) KALYANTRA.data.resources = { equipment:[], manpower:[], materials:[] };
    KALYANTRA.data.resources.manpower.push({
        id: 'mp_' + Date.now(),
        name: '',
        ratedProductivity: 0,
        availableProductivity: 0,
        productivityUnit: 'MT/day',
        gangsDeployed: 1,
        activityKeywords: ''
    });
    renderManpowerTableNew();
}

function removeManpower(idx) {
    (KALYANTRA.data.resources.manpower || []).splice(idx, 1);
    renderManpowerTableNew();
}

function updateMpField(idx, field, value) {
    const mp = (KALYANTRA.data.resources.manpower || [])[idx];
    if (!mp) return;
    const num = ['ratedProductivity','availableProductivity','gangsDeployed'];
    mp[field] = num.includes(field) ? (parseFloat(value)||0) : value;
    const cell = document.getElementById(`mp_daily_${idx}`);
    if (cell) {
        const daily = (mp.availableProductivity||0) * (mp.gangsDeployed||1);
        const unit = mp.productivityUnit || 'MT/day';
        cell.innerHTML = `<strong style="color:#1B3B6F;">${daily.toFixed(1)}</strong> <span style="color:#64748b;font-size:0.72rem;">${unit}</span>`;
    }
}

function renderManpowerTableNew() {
    const tbody = document.getElementById('manpowerTableNew');
    if (!tbody) return;
    const mpList = (KALYANTRA.data.resources || {}).manpower || [];
    const MP_UNITS = ['MT/day','m¬≤/day','Cum/day','Nos/day','RMT/day','m/day'];

    if (mpList.length === 0) {
        tbody.innerHTML = `<tr id="mpEmptyRow"><td colspan="8" style="padding:20px;text-align:center;color:#94a3b8;font-size:0.82rem;">No labour types defined. Click + Add Labour Type to start.</td></tr>`;
        return;
    }

    tbody.innerHTML = mpList.map((mp, i) => {
        const daily = (mp.availableProductivity||0) * (mp.gangsDeployed||1);
        const unit = mp.productivityUnit || 'MT/day';
        return `<tr style="border-bottom:1px solid #f1f5f9;">
            <td style="padding:7px 10px;">
                <input type="text" value="${mp.name||''}" placeholder="e.g. Bar Bending Gang"
                    onchange="updateMpField(${i},'name',this.value)"
                    style="width:100%;font-size:0.78rem;padding:4px 7px;border:1px solid #e2e8f0;border-radius:4px;" />
            </td>
            <td style="padding:7px 8px;text-align:center;">
                <input type="number" min="0" step="0.1" value="${mp.ratedProductivity||''}" placeholder="Rated"
                    onchange="updateMpField(${i},'ratedProductivity',this.value)"
                    style="width:70px;font-size:0.78rem;padding:4px 6px;border:1px solid #e2e8f0;border-radius:4px;text-align:center;" />
            </td>
            <td style="padding:7px 8px;text-align:center;">
                <input type="number" min="0" step="0.1" value="${mp.availableProductivity||''}" placeholder="Available"
                    onchange="updateMpField(${i},'availableProductivity',this.value)"
                    style="width:70px;font-size:0.78rem;padding:4px 6px;border:1px solid #e2e8f0;border-radius:4px;text-align:center;" />
            </td>
            <td style="padding:7px 8px;text-align:center;">
                <select onchange="updateMpField(${i},'productivityUnit',this.value)"
                    style="font-size:0.76rem;padding:4px 6px;border:1px solid #e2e8f0;border-radius:4px;">
                    ${MP_UNITS.map(u=>`<option value="${u}" ${mp.productivityUnit===u?'selected':''}>${u}</option>`).join('')}
                </select>
            </td>
            <td style="padding:7px 8px;text-align:center;">
                <input type="number" min="1" max="99" step="1" value="${mp.gangsDeployed||1}"
                    onchange="updateMpField(${i},'gangsDeployed',this.value)"
                    style="width:50px;font-size:0.78rem;padding:4px 6px;border:1px solid #e2e8f0;border-radius:4px;text-align:center;" />
            </td>
            <td style="padding:7px 8px;text-align:center;" id="mp_daily_${i}">
                <strong style="color:#1B3B6F;">${daily.toFixed(1)}</strong>
                <span style="color:#64748b;font-size:0.72rem;"> ${unit}</span>
            </td>
            <td style="padding:7px 8px;">
                <input type="text" value="${mp.activityKeywords||''}" placeholder="Rebar, Shuttering‚Ä¶"
                    onchange="updateMpField(${i},'activityKeywords',this.value)"
                    style="width:100%;font-size:0.76rem;padding:4px 7px;border:1px solid #e2e8f0;border-radius:4px;" />
            </td>
            <td style="padding:7px 8px;text-align:center;">
                <button onclick="removeManpower(${i})" style="padding:3px 7px;background:#fee2e2;color:#dc2626;border:none;border-radius:4px;font-size:0.72rem;cursor:pointer;">‚úï</button>
            </td>
        </tr>`;
    }).join('');
}

// ‚îÄ‚îÄ MATERIALS (with user-defined density for ALL layers) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Density model: Volume (m¬≥) = L √ó W √ó (T/1000)
//                Weight (MT) = Volume √ó Density   ‚Üê user-provided
// Applies equally to GSB, WMM, DBM, BC ‚Äî no hardcoded values
function addMaterialNew() {
    if (!KALYANTRA.data.resources) KALYANTRA.data.resources = { equipment:[], manpower:[], materials:[] };
    KALYANTRA.data.resources.materials.push({
        id: 'mat_' + Date.now(),
        name: '',
        unit: 'm¬≥',
        // density: user enters this ‚Äî NO IRC defaults hardcoded here
        // Layer: GSB ~2.00, WMM ~2.10, DBM ~2.40, BC ~2.40 ‚Äî planners know these
        density: null,          // MT/m¬≥ ‚Äî null until planner enters
        supplyRatePerDay: 0,
        source: '',
        linkedLayers: ''
    });
    renderMaterialTableNew();
}

function removeMaterial(idx) {
    (KALYANTRA.data.resources.materials || []).splice(idx, 1);
    renderMaterialTableNew();
}

function updateMatField(idx, field, value) {
    const mat = (KALYANTRA.data.resources.materials || [])[idx];
    if (!mat) return;
    const num = ['density','supplyRatePerDay'];
    mat[field] = num.includes(field) ? (parseFloat(value)||null) : value;
    // Update weight display if density changed
    const weightCell = document.getElementById(`mat_weight_${idx}`);
    if (weightCell && mat.density) {
        const supplyMT = (mat.supplyRatePerDay||0) * mat.density;
        weightCell.textContent = supplyMT > 0 ? `‚âà ${supplyMT.toFixed(1)} MT/day` : '‚Äî';
    }
}

function renderMaterialTableNew() {
    const tbody = document.getElementById('materialTableNew');
    if (!tbody) return;
    const matList = (KALYANTRA.data.resources || {}).materials || [];
    const MAT_UNITS = ['m¬≥','MT','kg','Nos','RMT','LS'];

    if (matList.length === 0) {
        tbody.innerHTML = `<tr id="matEmptyRow"><td colspan="7" style="padding:20px;text-align:center;color:#94a3b8;font-size:0.82rem;">No materials defined. Click + Add Material to start.</td></tr>`;
        return;
    }

    tbody.innerHTML = matList.map((mat, i) => {
        const supplyMT = (mat.supplyRatePerDay||0) * (mat.density||0);
        const densityMissing = !mat.density && mat.unit === 'm¬≥';
        return `<tr style="border-bottom:1px solid #f1f5f9;">
            <td style="padding:7px 10px;">
                <input type="text" value="${mat.name||''}" placeholder="e.g. GSB Aggregate"
                    onchange="updateMatField(${i},'name',this.value)"
                    style="width:100%;font-size:0.78rem;padding:4px 7px;border:1px solid #e2e8f0;border-radius:4px;" />
            </td>
            <td style="padding:7px 8px;text-align:center;">
                <select onchange="updateMatField(${i},'unit',this.value)"
                    style="font-size:0.76rem;padding:4px 6px;border:1px solid #e2e8f0;border-radius:4px;">
                    ${MAT_UNITS.map(u=>`<option value="${u}" ${mat.unit===u?'selected':''}>${u}</option>`).join('')}
                </select>
            </td>
            <td style="padding:7px 8px;text-align:center;">
                <input type="number" min="0" step="0.01" value="${mat.density!=null?mat.density:''}"
                    placeholder="e.g. 2.00"
                    onchange="updateMatField(${i},'density',this.value)"
                    style="width:75px;font-size:0.78rem;padding:4px 6px;border:1px solid ${densityMissing?'#fcd34d':'#e2e8f0'};border-radius:4px;text-align:center;" />
                ${densityMissing ? '<div style="font-size:0.68rem;color:#b45309;margin-top:2px;">Required for MT calc</div>' : ''}
            </td>
            <td style="padding:7px 8px;text-align:center;">
                <input type="number" min="0" step="1" value="${mat.supplyRatePerDay||''}"
                    placeholder="Max/day"
                    onchange="updateMatField(${i},'supplyRatePerDay',this.value)"
                    style="width:80px;font-size:0.78rem;padding:4px 6px;border:1px solid #e2e8f0;border-radius:4px;text-align:center;" />
                <div id="mat_weight_${i}" style="font-size:0.68rem;color:#64748b;margin-top:2px;">
                    ${supplyMT > 0 ? `‚âà ${supplyMT.toFixed(1)} MT/day` : '‚Äî'}
                </div>
            </td>
            <td style="padding:7px 8px;">
                <input type="text" value="${mat.source||''}" placeholder="Quarry / Batch Plant location"
                    onchange="updateMatField(${i},'source',this.value)"
                    style="width:100%;font-size:0.76rem;padding:4px 7px;border:1px solid #e2e8f0;border-radius:4px;" />
            </td>
            <td style="padding:7px 8px;">
                <input type="text" value="${mat.linkedLayers||''}" placeholder="GSB, WMM, DBM, BC‚Ä¶"
                    onchange="updateMatField(${i},'linkedLayers',this.value)"
                    style="width:100%;font-size:0.76rem;padding:4px 7px;border:1px solid #e2e8f0;border-radius:4px;" />
            </td>
            <td style="padding:7px 8px;text-align:center;">
                <button onclick="removeMaterial(${i})" style="padding:3px 7px;background:#fee2e2;color:#dc2626;border:none;border-radius:4px;font-size:0.72rem;cursor:pointer;">‚úï</button>
            </td>
        </tr>`;
    }).join('');
}

// ‚îÄ‚îÄ COVERAGE WARNINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Checks if required layer equipment types are covered in Resources
function updateCoverageWarnings() {
    const warnContainer = document.getElementById('resCoverageWarnings');
    const warnBody = document.getElementById('resCoverageWarningsBody');
    const coverLabel = document.getElementById('resCoverageLabel');
    if (!warnContainer || !warnBody) return;

    const eqNames = (KALYANTRA.data.resources.equipment || [])
        .map(e => (e.name||'').toLowerCase().trim())
        .filter(Boolean);

    // Get all required equipment types from TCS pavement layers
    const boq = KALYANTRA.data.boq || {};
    const tcsList = boq.tcsList || [];
    const required = new Set();
    tcsList.forEach(tcs => {
        (tcs.pavementLayers || []).forEach(layer => {
            (layer.requiredEquipmentTypes || []).forEach(eq => required.add(eq));
        });
    });

    const missing = [...required].filter(req =>
        !eqNames.some(name => name.includes(req.toLowerCase()) || req.toLowerCase().includes(name))
    );

    if (missing.length === 0) {
        warnContainer.style.display = 'none';
        if (coverLabel) { coverLabel.style.display='inline'; coverLabel.textContent='‚úÖ Full Coverage'; }
    } else {
        warnContainer.style.display = 'block';
        warnBody.innerHTML = missing.map(m => `‚Üí <strong>${m}</strong> required by TCS layer but not defined in Resources`).join('<br>');
        if (coverLabel) { coverLabel.style.display='inline'; coverLabel.style.background='#fef2f2'; coverLabel.style.color='#dc2626'; coverLabel.textContent=`‚ö†Ô∏è ${missing.length} Gap${missing.length>1?'s':''}`; }
    }
}

// ‚îÄ‚îÄ PRODUCTIVITY GAP TABLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderGapTable() {
    const tbody = document.getElementById('gapTableBody');
    if (!tbody) return;
    const eqList = (KALYANTRA.data.resources || {}).equipment || [];
    const progressHistory = ((KALYANTRA.data.progress || {}).productivityHistory) || {};

    const rows = eqList.filter(eq => eq.name && eq.ratedProductivity > 0).map(eq => {
        const history = progressHistory[eq.name] || [];
        const lastEntry = history[history.length - 1];
        const actual = lastEntry ? lastEntry.actual : null;
        const gap = actual != null ? (actual - eq.availableProductivity).toFixed(1) : null;
        const gapPct = actual != null && eq.availableProductivity > 0
            ? Math.round((actual - eq.availableProductivity) / eq.availableProductivity * 100) : null;
        const shiftHrs = getShiftHours(eq.shift || 'single');
        const scheduleDays = gap != null && gap < 0 && eq.availableProductivity > 0
            ? `+${Math.abs(Math.round(gap/eq.availableProductivity * 5))} est. days` : 'On track';

        return `<tr style="border-bottom:1px solid #fed7aa;">
            <td style="padding:7px 10px;font-weight:600;">${eq.name}</td>
            <td style="padding:7px 10px;text-align:center;">${eq.ratedProductivity} ${eq.productivityUnit||''}</td>
            <td style="padding:7px 10px;text-align:center;">${eq.availableProductivity} ${eq.productivityUnit||''}</td>
            <td style="padding:7px 10px;text-align:center;">${actual != null ? actual + ' ' + (eq.productivityUnit||'') : '<span style="color:#94a3b8;">Not yet recorded</span>'}</td>
            <td style="padding:7px 10px;text-align:center;">
                ${gap != null
                    ? `<span style="color:${parseFloat(gap)<0?'#dc2626':'#16a34a'};font-weight:700;">${parseFloat(gap)>0?'+':''}${gap} (${gapPct>0?'+':''}${gapPct}%)</span>`
                    : '<span style="color:#94a3b8;">‚Äî</span>'}
            </td>
            <td style="padding:7px 10px;text-align:center;color:${scheduleDays.startsWith('+')?'#dc2626':'#16a34a'};font-weight:600;">${scheduleDays}</td>
        </tr>`;
    });

    tbody.innerHTML = rows.length
        ? rows.join('')
        : `<tr><td colspan="6" style="padding:12px;text-align:center;color:#94a3b8;">No productivity data recorded yet. Record progress to see gap analysis.</td></tr>`;
}

// ‚îÄ‚îÄ SAVE / LOAD RESOURCES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveResources() {
    // Collect all table data into data model
    const res = KALYANTRA.data.resources || { equipment:[], manpower:[], materials:[] };
    // Data is already live (updated by updateEquipField, updateMpField, updateMatField)
    KALYANTRA.data.resources = res;
    if (KALYANTRA.supabaseSave) {
        KALYANTRA.supabaseSave().then(() => {
            showToast('‚úÖ Resources saved successfully', 'success');
            updateCoverageWarnings();
        }).catch(e => showToast('‚ö†Ô∏è Save failed: ' + e.message, 'error'));
    } else {
        showToast('‚úÖ Resources saved (offline mode)', 'success');
        updateCoverageWarnings();
    }
}

function initResourcesTab() {
    // Render all three tables from data model
    renderEquipmentTableNew();
    renderManpowerTableNew();
    renderMaterialTableNew();
    updateCoverageWarnings();
    // Ensure sub-tab 0 is active
    switchResTab(0);
}

// ‚îÄ‚îÄ AUTO-INIT when tab becomes visible ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Hook into switchMainTab to init resources when tab 6 selected
(function patchSwitchMainTabForResources() {
    const _orig = window.switchMainTab;
    if (typeof _orig !== 'function') return;
    window.switchMainTab = function(idx) {
        _orig(idx);
        if (idx === 5) {
            setTimeout(() => {
                initResourcesTab();
                initShiftConfig();
            }, 50);
        }
        if (idx === 4) {
            setTimeout(() => initShiftConfig(), 50);
        }
    };
})();

console.log('‚úÖ KALYANTRA V9 Session 1 ‚Äî Resources & Shift Engine loaded');

</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KALYANTRA V9 ‚Äî SESSION 2: TCS PAVEMENT LAYER EDITOR
// Inline layer editor with density per layer (GSB/WMM/DBM/BC)
// Quantity: Volume(m¬≥) = L √ó W √ó (T/1000), Weight(MT) = Vol √ó Density
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// IRC/MoRTH default pavement crust for 4-Lane NH (115 MSA)
// These are EDITABLE DEFAULTS ‚Äî planner must confirm or change
const PAVEMENT_LAYER_PRESETS = {
    '4-Lane-NH': [
        { sequence:1, name:'Subgrade Preparation', code:'SUBGRADE', thickness:500, widthType:'full', densityMT:null, requiredEquipmentTypes:'Motor Grader,Vibratory Roller,Water Tanker', shift:'single', cureLagDays:1, specRef:'MoRTH Cl.305', phase:1, critical:true },
        { sequence:2, name:'GSB Layer',             code:'GSB',      thickness:200, widthType:'full', densityMT:2.00, requiredEquipmentTypes:'Motor Grader,Vibratory Roller,Tipper',      shift:'single', cureLagDays:3, specRef:'MoRTH Cl.401', phase:2, critical:false },
        { sequence:3, name:'WMM Layer',             code:'WMM',      thickness:250, widthType:'full', densityMT:2.10, requiredEquipmentTypes:'Sensor Paver,Vibratory Roller,Tipper',      shift:'single', cureLagDays:7, specRef:'MoRTH Cl.406', phase:2, critical:false },
        { sequence:4, name:'DBM Layer',             code:'DBM',      thickness:115, widthType:'cw',   densityMT:2.40, requiredEquipmentTypes:'Sensor Paver,Tandem Roller,Water Tanker',   shift:'single', cureLagDays:4, specRef:'MoRTH Cl.507', phase:3, critical:true },
        { sequence:5, name:'BC Wearing Course',     code:'BC',       thickness:50,  widthType:'cw',   densityMT:2.40, requiredEquipmentTypes:'Sensor Paver,Tandem Roller,Water Tanker',   shift:'single', cureLagDays:0, specRef:'MoRTH Cl.508', phase:3, critical:true },
    ],
    '2-Lane-NH': [
        { sequence:1, name:'Subgrade Preparation', code:'SUBGRADE', thickness:500, widthType:'full', densityMT:null, requiredEquipmentTypes:'Motor Grader,Vibratory Roller,Water Tanker', shift:'single', cureLagDays:1, specRef:'MoRTH Cl.305', phase:1, critical:true },
        { sequence:2, name:'GSB Layer',             code:'GSB',      thickness:150, widthType:'full', densityMT:2.00, requiredEquipmentTypes:'Motor Grader,Vibratory Roller,Tipper',      shift:'single', cureLagDays:3, specRef:'MoRTH Cl.401', phase:2, critical:false },
        { sequence:3, name:'WMM Layer',             code:'WMM',      thickness:250, widthType:'full', densityMT:2.10, requiredEquipmentTypes:'Sensor Paver,Vibratory Roller,Tipper',      shift:'single', cureLagDays:7, specRef:'MoRTH Cl.406', phase:2, critical:false },
        { sequence:4, name:'DBM Layer',             code:'DBM',      thickness:75,  widthType:'cw',   densityMT:2.40, requiredEquipmentTypes:'Sensor Paver,Tandem Roller,Water Tanker',   shift:'single', cureLagDays:4, specRef:'MoRTH Cl.507', phase:3, critical:true },
        { sequence:5, name:'BC Wearing Course',     code:'BC',       thickness:40,  widthType:'cw',   densityMT:2.40, requiredEquipmentTypes:'Sensor Paver,Tandem Roller,Water Tanker',   shift:'single', cureLagDays:0, specRef:'MoRTH Cl.508', phase:3, critical:true },
    ],
};

// widthType:
//  'full' = carriageWidth + 2√óshoulderWidth (full formation width)
//  'cw'   = carriageWidth only (bound layers)
//  'sh'   = shoulderWidth only

function getLayerWidth(widthType, tcs) {
    const cw = parseFloat(tcs.carriageWidth) || 7.0;
    const sh = parseFloat(tcs.shoulderWidth) || 2.5;
    if (widthType === 'cw')   return cw;
    if (widthType === 'sh')   return sh;
    return cw + 2 * sh; // 'full'
}

// Compute quantity for a layer on a given stretch
// Returns: { volumeM3, weightMT }
function computeLayerQuantity(layer, stretchLengthKm, tcsConfig) {
    const lengthM = stretchLengthKm * 1000;
    const widthM  = getLayerWidth(layer.widthType || 'full', tcsConfig);
    const thickM  = (layer.thickness || 0) / 1000;
    const volumeM3 = lengthM * widthM * thickM;
    const density  = parseFloat(layer.densityMT) || null;
    const weightMT = density ? volumeM3 * density : null;
    return { volumeM3: Math.round(volumeM3 * 100)/100, weightMT: weightMT ? Math.round(weightMT*100)/100 : null };
}

// ‚îÄ‚îÄ TCS LAYER EDITOR UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openTCSLayerEditor(ti) {
    const tcs = ensureBOQ().tcsList[ti];
    if (!tcs) return;
    const isReadOnly = tcs.frozen === true;
    // Frozen TCS opens in read-only mode (can view layers, cannot edit)

    // Remove any existing panel
    const existing = document.getElementById(`tcsLayerPanel_${ti}`);
    if (existing) { existing.remove(); return; } // toggle off

    // Build panel HTML
    const layers = tcs.pavementLayers || [];
    const eqNames = (KALYANTRA.data.resources.equipment || []).map(e=>e.name).filter(Boolean);
    const eqOptions = eqNames.length
        ? eqNames.map(n=>`<option value="${n}">${n}</option>`).join('')
        : '<option value="">Define equipment in Resources tab first</option>';

    const SHIFTS = [{v:'single',l:'üåÖ Single (8h)'},{v:'double',l:'üåô Double (16h)'},{v:'triple',l:'üîÑ 24h'}];
    const WIDTHS = [{v:'full',l:'Full Width (CW+Shoulders)'},{v:'cw',l:'Carriageway Only'},{v:'sh',l:'Shoulder Only'}];
    const PHASES = [{v:1,l:'Phase 1 ‚Äî Earthwork'},{v:2,l:'Phase 2 ‚Äî Subbase'},{v:3,l:'Phase 3 ‚Äî Surface'}];

    const layerRows = layers.map((lyr, li) => buildLayerRow(lyr, li, ti)).join('');

    const panel = document.createElement('div');
    panel.id = `tcsLayerPanel_${ti}`;
    panel.style.cssText = 'margin-top:12px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden;';
    panel.innerHTML = `
        <div style="background:#1B3B6F;color:white;padding:10px 16px;display:flex;justify-content:space-between;align-items:center;">
            <div>
                <span style="font-weight:700;font-size:0.88rem;">üèóÔ∏è Pavement Crust ‚Äî Layer Editor</span>
                <span style="font-size:0.72rem;color:rgba(255,255,255,0.65);margin-left:10px;">Volume = L √ó W √ó Thickness | Weight = Volume √ó Density (user-defined)</span>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
                <select id="layerPreset_${ti}" style="font-size:0.75rem;padding:4px 8px;border-radius:4px;border:none;color:#1B3B6F;">
                    <option value="">Apply IRC Template‚Ä¶</option>
                    ${Object.keys(PAVEMENT_LAYER_PRESETS).map(k=>`<option value="${k}">${k}</option>`).join('')}
                </select>
                <button onclick="applyLayerPreset(${ti})" style="padding:4px 10px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:4px;font-size:0.75rem;font-weight:700;cursor:pointer;">Apply</button>
                <button onclick="addLayerRow(${ti})" style="padding:4px 10px;background:rgba(255,255,255,0.2);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:4px;font-size:0.75rem;cursor:pointer;">+ Add Layer</button>
                <button onclick="saveLayersAndClose(${ti})" style="padding:4px 10px;background:#16a34a;color:white;border:none;border-radius:4px;font-size:0.75rem;font-weight:700;cursor:pointer;">üíæ Save</button>
            </div>
        </div>
        <div style="padding:12px 16px;">
            <!-- Carriageway dimensions -->
            <div style="display:flex;gap:16px;margin-bottom:12px;padding:10px 14px;background:#eff6ff;border-radius:6px;align-items:center;flex-wrap:wrap;">
                <span style="font-size:0.76rem;font-weight:700;color:#1e40af;">Cross-Section:</span>
                <label style="font-size:0.76rem;color:#374151;">Carriageway Width (m): <input type="number" id="tcsLyrCW_${ti}" value="${tcs.carriageWidth||7.0}" step="0.5" onchange="updateTCSWidth(${ti})" style="width:60px;padding:3px 6px;border:1px solid #bfdbfe;border-radius:4px;font-size:0.76rem;text-align:center;"/></label>
                <label style="font-size:0.76rem;color:#374151;">Shoulder Width (m): <input type="number" id="tcsLyrSH_${ti}" value="${tcs.shoulderWidth||2.5}" step="0.25" onchange="updateTCSWidth(${ti})" style="width:60px;padding:3px 6px;border:1px solid #bfdbfe;border-radius:4px;font-size:0.76rem;text-align:center;"/></label>
                <span id="tcsLyrFullWidth_${ti}" style="font-size:0.76rem;color:#1e40af;font-weight:600;">Full Width: ${(parseFloat(tcs.carriageWidth||7)+2*parseFloat(tcs.shoulderWidth||2.5)).toFixed(1)} m</span>
            </div>

            <!-- Layer table -->
            <div style="overflow-x:auto;">
                <table style="width:100%;border-collapse:collapse;font-size:0.76rem;">
                    <thead>
                        <tr style="background:#334155;color:white;">
                            <th style="padding:7px 8px;text-align:center;min-width:40px;">#</th>
                            <th style="padding:7px 8px;text-align:left;min-width:150px;">Layer Name</th>
                            <th style="padding:7px 8px;text-align:center;min-width:80px;">Thick (mm)</th>
                            <th style="padding:7px 8px;text-align:center;min-width:120px;">Width Type</th>
                            <th style="padding:7px 8px;text-align:center;min-width:90px;">Density<br><span style="font-size:0.65rem;opacity:0.8;">(MT/m¬≥)</span></th>
                            <th style="padding:7px 8px;text-align:center;min-width:80px;">Cure Lag<br><span style="font-size:0.65rem;opacity:0.8;">(days)</span></th>
                            <th style="padding:7px 8px;text-align:center;min-width:80px;">Shift</th>
                            <th style="padding:7px 8px;text-align:left;min-width:200px;">Equipment Required</th>
                            <th style="padding:7px 8px;text-align:left;min-width:120px;">Spec Ref</th>
                            <th style="padding:7px 8px;text-align:center;min-width:50px;">‚úï</th>
                        </tr>
                    </thead>
                    <tbody id="layerTableBody_${ti}">
                        ${layerRows || '<tr><td colspan="10" style="padding:16px;text-align:center;color:#94a3b8;">No layers defined. Apply a template or add layers manually.</td></tr>'}
                    </tbody>
                </table>
            </div>

            <!-- Bottleneck analysis -->
            <div id="layerBottleneck_${ti}" style="margin-top:10px;padding:8px 12px;background:#fef3c7;border-radius:6px;font-size:0.76rem;color:#92400e;display:none;">
                ‚è≥ Computing bottleneck‚Ä¶
            </div>
        </div>
    `;

    // Insert panel after the TCS card
    const card = document.getElementById(`tcsCard_${ti}`);
    if (card) card.after(panel);
    else {
        // Fallback: append after last card
        const list = document.getElementById('tcsCardsList');
        if (list) list.appendChild(panel);
    }

    // Init tag inputs for each layer
    const _tagLayers = (KALYANTRA.data.boq?.tcsList?.[ti]?.pavementLayers) || [];
    _tagLayers.forEach((lyr, li) => initEquipmentTagInput(ti, li, lyr.requiredEquipmentTypes));
    computeBottleneck(ti);
}

function buildLayerRow(lyr, li, ti) {
    const SHIFTS = [{v:'single',l:'üåÖ Single'},{v:'double',l:'üåô Double'},{v:'triple',l:'üîÑ 24h'}];
    const WIDTHS = [{v:'full',l:'Full Width'},{v:'cw',l:'CW Only'},{v:'sh',l:'Shoulder'}];
    const density = lyr.densityMT != null ? lyr.densityMT : '';
    return `<tr style="border-bottom:1px solid #e2e8f0;" id="layerRow_${ti}_${li}">
        <td style="padding:6px 8px;text-align:center;color:#64748b;font-weight:600;">${lyr.sequence || li+1}</td>
        <td style="padding:6px 8px;">
            <input type="text" value="${lyr.name||''}" placeholder="Layer name"
                onchange="updateLayerField(${ti},${li},'name',this.value)"
                style="width:100%;font-size:0.76rem;padding:3px 6px;border:1px solid #e2e8f0;border-radius:4px;" />
        </td>
        <td style="padding:6px 8px;text-align:center;">
            <input type="number" min="1" max="2000" step="1" value="${lyr.thickness||''}"
                onchange="updateLayerField(${ti},${li},'thickness',parseFloat(this.value)||0);computeBottleneck(${ti})"
                style="width:65px;font-size:0.76rem;padding:3px 6px;border:1px solid #e2e8f0;border-radius:4px;text-align:center;" />
        </td>
        <td style="padding:6px 8px;text-align:center;">
            <select onchange="updateLayerField(${ti},${li},'widthType',this.value);computeBottleneck(${ti})"
                style="font-size:0.74rem;padding:3px 6px;border:1px solid #e2e8f0;border-radius:4px;">
                ${WIDTHS.map(w=>`<option value="${w.v}" ${lyr.widthType===w.v?'selected':''}>${w.l}</option>`).join('')}
            </select>
        </td>
        <td style="padding:6px 8px;text-align:center;">
            <input type="number" min="0" max="5" step="0.01" value="${density}"
                placeholder="e.g. 2.00"
                onchange="updateLayerField(${ti},${li},'densityMT',this.value===''?null:parseFloat(this.value))"
                style="width:65px;font-size:0.76rem;padding:3px 6px;border:1px solid ${density===''?'#fcd34d':'#e2e8f0'};border-radius:4px;text-align:center;"
                title="Volume(m¬≥)=L√óW√óT/1000 | Weight(MT)=Volume√óDensity" />
            ${density==='' ? '<div style="font-size:0.65rem;color:#b45309;">Required</div>' : ''}
        </td>
        <td style="padding:6px 8px;text-align:center;">
            <input type="number" min="0" max="30" step="1" value="${lyr.cureLagDays||0}"
                onchange="updateLayerField(${ti},${li},'cureLagDays',parseInt(this.value)||0)"
                style="width:50px;font-size:0.76rem;padding:3px 6px;border:1px solid #e2e8f0;border-radius:4px;text-align:center;" />
        </td>
        <td style="padding:6px 8px;text-align:center;">
            <select onchange="updateLayerField(${ti},${li},'shift',this.value)"
                style="font-size:0.74rem;padding:3px 6px;border:1px solid #e2e8f0;border-radius:4px;">
                ${SHIFTS.map(s=>`<option value="${s.v}" ${lyr.shift===s.v?'selected':''}>${s.l}</option>`).join('')}
            </select>
        </td>
        <td style="padding:6px 8px;position:relative;">
            <div id="eqTags_${ti}_${li}"></div>
        </td>
        <td style="padding:6px 8px;">
            <input type="text" value="${lyr.specRef||''}" placeholder="MoRTH Cl."
                onchange="updateLayerField(${ti},${li},'specRef',this.value)"
                style="width:100%;font-size:0.74rem;padding:3px 6px;border:1px solid #e2e8f0;border-radius:4px;" />
        </td>
        <td style="padding:6px 8px;text-align:center;">
            <button onclick="removeLayerRow(${ti},${li})" style="padding:2px 7px;background:#fee2e2;color:#dc2626;border:none;border-radius:3px;cursor:pointer;font-size:0.78rem;">‚úï</button>
        </td>
    </tr>`;
}

function updateTCSWidth(ti) {
    const cw = parseFloat(document.getElementById(`tcsLyrCW_${ti}`)?.value) || 7.0;
    const sh = parseFloat(document.getElementById(`tcsLyrSH_${ti}`)?.value) || 2.5;
    const tcs = ensureBOQ().tcsList[ti];
    if (tcs) { tcs.carriageWidth = cw; tcs.shoulderWidth = sh; }
    const fullEl = document.getElementById(`tcsLyrFullWidth_${ti}`);
    if (fullEl) fullEl.textContent = `Full Width: ${(cw + 2*sh).toFixed(1)} m`;
    computeBottleneck(ti);
}

function updateLayerField(ti, li, field, value) {
    const tcs = ensureBOQ().tcsList[ti];
    if (!tcs || !tcs.pavementLayers) return;
    const lyr = tcs.pavementLayers[li];
    if (!lyr) return;
    lyr[field] = value;
}

function addLayerRow(ti) {
    const tcs = ensureBOQ().tcsList[ti];
    if (!tcs) return;
    if (!tcs.pavementLayers) tcs.pavementLayers = [];
    const seq = tcs.pavementLayers.length + 1;
    tcs.pavementLayers.push({
        sequence: seq, name: '', code: 'LAYER_'+seq,
        thickness: 0, widthType: 'full', densityMT: null,
        requiredEquipmentTypes: '', shift: 'single',
        cureLagDays: 0, specRef: '', phase: 1, critical: false
    });
    refreshLayerTable(ti);
}

function removeLayerRow(ti, li) {
    const tcs = ensureBOQ().tcsList[ti];
    if (!tcs || !tcs.pavementLayers) return;
    tcs.pavementLayers.splice(li, 1);
    tcs.pavementLayers.forEach((l,i) => l.sequence = i+1);
    refreshLayerTable(ti);
}

function refreshLayerTable(ti) {
    const tbody = document.getElementById(`layerTableBody_${ti}`);
    if (!tbody) return;
    const tcs = ensureBOQ().tcsList[ti];
    const layers = (tcs && tcs.pavementLayers) || [];
    tbody.innerHTML = layers.length
        ? layers.map((lyr,li) => buildLayerRow(lyr, li, ti)).join('')
        : '<tr><td colspan="10" style="padding:16px;text-align:center;color:#94a3b8;">No layers. Apply template or add manually.</td></tr>';
    // Re-init tag inputs for each row after HTML rebuild
    layers.forEach((lyr, li) => initEquipmentTagInput(ti, li, lyr.requiredEquipmentTypes));
    computeBottleneck(ti);
}

function applyLayerPreset(ti) {
    const sel = document.getElementById(`layerPreset_${ti}`);
    if (!sel || !sel.value) { showToast('Select a template first','info'); return; }
    const tcs = ensureBOQ().tcsList[ti];
    if (!tcs) return;
    const preset = PAVEMENT_LAYER_PRESETS[sel.value];
    if (!preset) return;
    if (tcs.pavementLayers && tcs.pavementLayers.length > 0) {
        if (!confirm(`Replace ${tcs.pavementLayers.length} existing layer(s) with ${sel.value} template?`)) return;
    }
    tcs.pavementLayers = preset.map((l,i) => ({...l, id:'lyr_'+Date.now()+'_'+i}));
    refreshLayerTable(ti);
    showToast(`‚úÖ ${sel.value} template applied ‚Äî ${preset.length} layers loaded`, 'success');
}

function saveLayersAndClose(ti) {
    const tcs = ensureBOQ().tcsList[ti];
    if (!tcs) return;
    const cw = parseFloat(document.getElementById(`tcsLyrCW_${ti}`)?.value) || tcs.carriageWidth || 7.0;
    const sh = parseFloat(document.getElementById(`tcsLyrSH_${ti}`)?.value) || tcs.shoulderWidth || 2.5;
    tcs.carriageWidth = cw;
    tcs.shoulderWidth = sh;
    if (KALYANTRA.supabaseSave) {
        KALYANTRA.supabaseSave().then(() => {
            showToast('‚úÖ Pavement layers saved', 'success');
            renderTCSCards();
            updateCoverageWarnings && updateCoverageWarnings();
        }).catch(() => showToast('‚ö†Ô∏è Save failed','error'));
    } else {
        showToast('‚úÖ Layers saved (offline)','success');
        renderTCSCards();
    }
    // Close panel
    const panel = document.getElementById(`tcsLayerPanel_${ti}`);
    if (panel) panel.remove();
}

// ‚îÄ‚îÄ BOTTLENECK ANALYSIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function computeBottleneck(ti) {
    const panel = document.getElementById(`layerBottleneck_${ti}`);
    if (!panel) return;

    const tcs = ensureBOQ().tcsList[ti];
    if (!tcs || !(tcs.pavementLayers||[]).length) {
        panel.style.display = 'none'; return;
    }

    const cal = KALYANTRA.data.calendar || {};
    const defaultShift = cal.defaultShift || 'single';
    const eqList = KALYANTRA.data.resources.equipment || [];
    const results = [];

    tcs.pavementLayers.forEach(lyr => {
        if (!lyr.name || !lyr.thickness) return;
        const reqEq = (typeof lyr.requiredEquipmentTypes === 'string'
            ? lyr.requiredEquipmentTypes.split(',') : lyr.requiredEquipmentTypes || [])
            .map(s=>s.trim()).filter(Boolean);
        if (!reqEq.length) return;

        // Find each required equipment in Resources
        const outputs = reqEq.map(reqName => {
            const eq = eqList.find(e => (e.name||'').toLowerCase() === reqName.toLowerCase());
            if (!eq || !eq.availableProductivity) return { name: reqName, daily: null, missing: true };
            const shift = lyr.shift || eq.shift || defaultShift;
            const hrs = getShiftHours(shift);
            const daily = eq.availableProductivity * hrs * (eq.unitsDeployed || 1);
            return { name: reqName, daily, unit: (eq.productivityUnit||'').replace('/hr',''), missing: false };
        });

        const defined = outputs.filter(o => !o.missing && o.daily > 0);
        const missing = outputs.filter(o => o.missing);
        if (!defined.length) {
            results.push({ layer: lyr.name, bottleneck: null, missing: missing.map(m=>m.name) });
            return;
        }

        // Bottleneck = min output
        const bottleneck = defined.reduce((min, eq) => eq.daily < min.daily ? eq : min);
        results.push({ layer: lyr.name, bottleneck: bottleneck.name, output: bottleneck.daily, unit: bottleneck.unit, missing: missing.map(m=>m.name) });
    });

    if (!results.length) { panel.style.display='none'; return; }

    panel.style.display = 'block';
    panel.innerHTML = `<div style="font-weight:700;margin-bottom:6px;color:#92400e;">‚ö° Bottleneck Analysis (Limiting Resource per Layer):</div>` +
        results.map(r => {
            const missingWarn = r.missing.length ? ` <span style="color:#dc2626;">‚ö†Ô∏è Missing: ${r.missing.join(', ')}</span>` : '';
            const bottleneckInfo = r.bottleneck
                ? `<strong>${r.bottleneck}</strong> @ ${r.output ? r.output.toFixed(0)+' '+r.unit+'/day' : '?'}`
                : '<span style="color:#dc2626;">No resources assigned</span>';
            return `<div style="display:flex;gap:8px;align-items:center;font-size:0.75rem;padding:2px 0;">
                <span style="min-width:140px;color:#374151;">‚ñ∏ ${r.layer}:</span>
                ${bottleneckInfo}${missingWarn}
            </div>`;
        }).join('');
}

// ‚îÄ‚îÄ PATCH renderTCSCards to add Layer Editor button ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// We patch the card render to add "üèóÔ∏è Layers" button alongside Edit
(function patchTCSCardsForLayers() {
    const _origRender = window.renderTCSCards;
    if (typeof _origRender !== 'function') {
        // Schedule retry if renderTCSCards not yet loaded
        setTimeout(patchTCSCardsForLayers, 500);
        return;
    }
    window.renderTCSCards = function() {
        _origRender();
        // After render, patch each card's Edit button to also add Layers btn
        const tcsList = (ensureBOQ().tcsList || []);
        tcsList.forEach((tcs, ti) => {
            const card = document.getElementById(`tcsCard_${ti}`);
            if (!card) return;
            // Find the Edit button in the card and add Layers button next to it
            const editBtn = card.querySelector('button[onclick*="tcsEditCard"]');
            if (editBtn && !card.querySelector('.layerEditorBtn')) {
                const layerBtn = document.createElement('button');
                layerBtn.className = 'layerEditorBtn';
                layerBtn.onclick = () => openTCSLayerEditor(ti);
                const layerCount = (tcs.pavementLayers||[]).length;
                layerBtn.innerHTML = `üèóÔ∏è Layers ${layerCount > 0 ? `<span style="background:#16a34a;color:white;border-radius:10px;padding:0 5px;font-size:0.65rem;">${layerCount}</span>` : ''}`;
                layerBtn.style.cssText = 'background:#e0fdf4;color:#065f46;border:none;padding:5px 10px;border-radius:4px;font-size:0.73rem;cursor:pointer;font-weight:600;margin-left:4px;';
                editBtn.after(layerBtn);
            }
        });
    };
    console.log('‚úÖ TCS renderTCSCards patched for Layer Editor button');
})();

console.log('‚úÖ KALYANTRA V9 Session 2 ‚Äî TCS Pavement Layer Editor loaded');

</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KALYANTRA V9 ‚Äî SESSION 3: REAL DURATION COMPUTATION ENGINE
// Replaces hardcoded L/100 formula with resource-productivity chain
// Quantity: m¬≥ = L √ó W √ó (T/1000) | Weight: MT = m¬≥ √ó density
// Duration: Working Days = Quantity √∑ (Productivity √ó ShiftHrs √ó Units)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Unit conversion factors ‚Äî how to normalize equipment output to m¬≥/day
// for volume-based layers, or m/day for length-based activities
const PRODUCTIVITY_UNIT_FACTORS = {
    // Equipment unit ‚Üí normalized to m¬≥/day for volume layers
    // Motor Grader: m/hr ‚Üí how many m¬≥/hr? depends on width and layer thickness
    // This is handled dynamically in computeRealDuration
    'm¬≥/hr': 'volume',   // direct
    'm/hr':  'length',   // linear (for barrier, markings etc)
    'MT/hr': 'weight',   // weight (bituminous)
    'm¬≤/hr': 'area',     // area (shuttering, markings)
    'Nos/hr':'count',
};

// ‚îÄ‚îÄ CORE DURATION CALCULATOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Called for each activity in stretchActivities
// Returns duration in working days (integer, min 1)
function computeRealDuration(opts) {
    const {
        layerCode,      // 'GSB','WMM','DBM','BC','SUBGRADE' etc
        stretchLenKm,   // km
        tcsConfig,      // KALYANTRA.data.tcs or tcs object
        pavementLayer,  // specific layer from tcs.pavementLayers (if available)
        activityKeywords, // fallback keywords to match equipment
        fallbackDivisor,  // L/fallbackDivisor if no resources defined
        minDays,          // minimum days floor
    } = opts;

    const cal = KALYANTRA.data.calendar || {};
    const eqList = KALYANTRA.data.resources ? (KALYANTRA.data.resources.equipment || []) : [];

    // STEP 1: Get layer dimensions
    const lengthM = stretchLenKm * 1000;
    let widthM, thicknessM, densityMT, widthType;

    if (pavementLayer) {
        // Use TCS editor data (Session 2 output) ‚Äî best source
        widthM = getLayerWidth(pavementLayer.widthType || 'full', tcsConfig);
        thicknessM = (pavementLayer.thickness || 200) / 1000;
        densityMT = pavementLayer.densityMT || null;
    } else {
        // Fallback to tcs global settings
        const cw = parseFloat(tcsConfig.carriageWidth) || 7.0;
        const sh = parseFloat(tcsConfig.shoulderWidth) || 2.5;
        // Bituminous layers use CW only, base/subbase use full width
        const isBituminous = ['DBM','BC','BM'].includes(layerCode);
        widthM = isBituminous ? cw : (cw + 2*sh);
        // Get thickness from tcs.layers or defaults
        const defs = { GSB:200, WMM:250, WBM:250, DBM:115, BC:50, SUBGRADE:500 };
        const layerObj = (tcsConfig.layers||{})[layerCode] || (tcsConfig.layers||{})[(layerCode||'').toLowerCase()] || {};
        thicknessM = (layerObj.thickness || defs[layerCode] || 200) / 1000;
        densityMT = null; // not available without layer editor
    }

    // STEP 2: Compute quantity
    const volumeM3 = lengthM * widthM * thicknessM;
    const weightMT = densityMT ? volumeM3 * densityMT : null;

    // STEP 3: Find relevant equipment
    // Priority: use pavementLayer.requiredEquipmentTypes ‚Üí then activityKeywords match
    let assignedEq = [];

    if (pavementLayer && pavementLayer.requiredEquipmentTypes) {
        const reqNames = (typeof pavementLayer.requiredEquipmentTypes === 'string'
            ? pavementLayer.requiredEquipmentTypes.split(',')
            : pavementLayer.requiredEquipmentTypes
        ).map(s=>s.trim().toLowerCase());

        assignedEq = eqList.filter(eq =>
            reqNames.some(req => (eq.name||'').toLowerCase().includes(req) || req.includes((eq.name||'').toLowerCase()))
            && eq.availableProductivity > 0
        );
    }

    if (!assignedEq.length && activityKeywords) {
        // Fallback: keyword matching
        const kws = activityKeywords.map(k=>k.toLowerCase());
        assignedEq = eqList.filter(eq => {
            const kwField = (eq.activityKeywords||'').toLowerCase();
            return kws.some(k => kwField.includes(k) || (eq.name||'').toLowerCase().includes(k));
        }).filter(eq => eq.availableProductivity > 0);
    }

    // STEP 4: If no equipment assigned ‚Äî use fallback formula
    if (!assignedEq.length) {
        const rawDays = Math.round(lengthM / fallbackDivisor);
        return { days: Math.max(minDays, rawDays), source: 'fallback', volumeM3, weightMT, bottleneck: null };
    }

    // STEP 5: Compute daily output per equipment ‚Äî normalize to same unit as quantity
    const shift = (pavementLayer ? pavementLayer.shift : null) || cal.defaultShift || 'single';
    const shiftHrs = getShiftHours(shift);

    const outputs = assignedEq.map(eq => {
        const units = eq.unitsDeployed || 1;
        const avail = eq.availableProductivity || 0;
        const rawDailyPerUnit = avail * shiftHrs;   // raw unit/day (m¬≥, m, MT etc)
        const prodUnit = (eq.productivityUnit || 'm¬≥/hr').toLowerCase();

        // Normalize to m¬≥/day for volume layers
        let normalizedDaily;
        if (prodUnit.includes('m¬≥') || prodUnit.includes('cum')) {
            normalizedDaily = rawDailyPerUnit * units;  // already m¬≥/day
        } else if (prodUnit.includes('m/hr') || prodUnit.includes('m per')) {
            // m/day ‚Üí m¬≥/day: multiply by width and thickness
            normalizedDaily = rawDailyPerUnit * units * widthM * thicknessM;
        } else if (prodUnit.includes('mt') || prodUnit.includes('ton')) {
            // MT/day ‚Üí m¬≥/day via density (if available)
            if (densityMT && densityMT > 0) {
                normalizedDaily = (rawDailyPerUnit * units) / densityMT;
            } else {
                // No density ‚Äî can't normalize, skip this equipment
                return null;
            }
        } else {
            // Unknown unit ‚Äî use as-is
            normalizedDaily = rawDailyPerUnit * units;
        }

        return { name: eq.name, normalizedDaily, prodUnit, rawDailyPerUnit, units };
    }).filter(Boolean);

    if (!outputs.length) {
        const rawDays = Math.round(lengthM / fallbackDivisor);
        return { days: Math.max(minDays, rawDays), source: 'fallback_no_unit_match', volumeM3, weightMT, bottleneck: null };
    }

    // STEP 6: Bottleneck = minimum normalized daily output
    const bottleneck = outputs.reduce((min, eq) => eq.normalizedDaily < min.normalizedDaily ? eq : min);

    // STEP 7: Duration in working days
    const rawDays = volumeM3 / bottleneck.normalizedDaily;
    const workingDays = Math.max(minDays, Math.ceil(rawDays));

    return {
        days: workingDays,
        source: 'resource_productivity',
        volumeM3: Math.round(volumeM3),
        weightMT: weightMT ? Math.round(weightMT*10)/10 : null,
        bottleneck: bottleneck.name,
        bottleneckOutput: Math.round(bottleneck.normalizedDaily),
        shift,
        shiftHrs
    };
}

// ‚îÄ‚îÄ PATCH stretchActivities TO USE REAL DURATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function patchStretchActivities() {
    const _orig = KALYANTRA.calculate.stretchActivities;
    KALYANTRA.calculate.stretchActivities = function(stretch) {
        const tcs = KALYANTRA.data.tcs;
        const res = KALYANTRA.data.resources || {};
        const L = stretch.length;  // km (note: original used L*1000 for metres)
        const Lm = L * 1000;       // metres

        // Helper: find equipment label for display
        const getRes = (types, fallback) => {
            const eqList = res.equipment || [];
            const match = eqList.find(e => types.some(t => (e.name||'').toLowerCase().includes(t.toLowerCase())));
            return match ? `${match.unitsDeployed||1}√ó ${match.name}` : fallback;
        };

        // Helper: find pavement layer from TCS editor data (Session 2)
        const boq = KALYANTRA.data.boq || {};
        const tcsList = boq.tcsList || [];
        // Find matching TCS for this stretch's chainage
        const stretchMidCh = ((stretch.start || 0) + (stretch.end || 0)) / 2;
        const matchingTCS = tcsList.find(t => {
            return (t.locations || []).some(loc => loc.fromCh <= stretchMidCh && loc.toCh >= stretchMidCh);
        });
        const getPavLayer = (code) => {
            if (!matchingTCS || !matchingTCS.pavementLayers) return null;
            return matchingTCS.pavementLayers.find(l => (l.code||'').toUpperCase() === code.toUpperCase());
        };

        // Get layer thicknesses (from TCS editor or defaults)
        const getThickMm = (code) => {
            const pl = getPavLayer(code);
            if (pl && pl.thickness) return pl.thickness;
            const defs = { GSB:200, WMM:250, WBM:250, DBM:115, BC:50, SUBGRADE:500 };
            return (tcs.layers || {})[code]?.thickness || defs[code] || 200;
        };

        const GSB = getThickMm('GSB'), WMM = getThickMm('WMM') || getThickMm('WBM');
        const DBM = getThickMm('DBM'), BC = getThickMm('BC');
        const CW = parseFloat(tcs.carriageWidth) || 7.0;
        const SH = parseFloat(tcs.shoulderWidth) || 2.5;

        // Compute duration using real engine or fallback
        const dur = (code, keywords, fallbackDiv, minDays) => {
            const result = computeRealDuration({
                layerCode: code,
                stretchLenKm: L,
                tcsConfig: matchingTCS || tcs,
                pavementLayer: getPavLayer(code),
                activityKeywords: keywords,
                fallbackDivisor: fallbackDiv,
                minDays: minDays
            });
            return result.days;
        };

        const _sActs = [
            {
                id:`${stretch.id}.1`,
                name:'Soil Excavation & Embankment',
                qty: Math.round(Lm * CW * 0.5),
                unit:'Cum',
                duration: dur('SUBGRADE', ['excavat','earthwork','embankment','grader'], 100, 10),
                critical:true, phase:1,
                resource: getRes(['Excavator','Motor Grader'], '2√ó Excavator')
            },
            {
                id:`${stretch.id}.2`,
                name:'Sub-grade Preparation ('+getThickMm('SUBGRADE')+'mm)',
                qty: Math.round(Lm * (CW+2*SH) * (getThickMm('SUBGRADE')/1000)),
                unit:'Cum',
                duration: dur('SUBGRADE', ['grader','compact','subgrade'], 200, 5),
                critical:true, phase:1,
                resource: getRes(['Motor Grader','Grader'], '1√ó Grader + Compactor')
            },
            {
                id:`${stretch.id}.3`,
                name:'GSB Layer ('+GSB+'mm)',
                qty: Math.round(Lm * (CW+2*SH) * (GSB/1000)),
                unit:'Cum',
                duration: dur('GSB', ['grader','gsb','paver'], 300, 4),
                critical:false, phase:2,
                resource: getRes(['Motor Grader','Paver'], '1√ó Paver')
            },
            {
                id:`${stretch.id}.4`,
                name:'WMM Layer ('+WMM+'mm)',
                qty: Math.round(Lm * (CW+2*SH) * (WMM/1000)),
                unit:'Cum',
                duration: dur('WMM', ['paver','wmm','wbm'], 250, 5),
                critical:false, phase:2,
                resource: getRes(['Sensor Paver','Paver'], '1√ó WMM Paver')
            },
            {
                id:`${stretch.id}.5`,
                name:'DBM Layer ('+DBM+'mm)',
                qty: Math.round(Lm * CW * (DBM/1000)),
                unit:'Cum',
                duration: dur('DBM', ['paver','dbm','bituminous','asphalt'], 350, 3),
                critical:true, phase:3,
                resource: getRes(['Sensor Paver','Paver'], '1√ó DBM Paver')
            },
            {
                id:`${stretch.id}.6`,
                name:'BC Wearing Course ('+BC+'mm)',
                qty: Math.round(Lm * CW * (BC/1000)),
                unit:'Cum',
                duration: dur('BC', ['paver','bc','wearing','surface'], 400, 2),
                critical:true, phase:3,
                resource: getRes(['Sensor Paver','Paver'], '1√ó BC Paver')
            }
        ];

        // Restore progress from persistent store
        const _sp = KALYANTRA.data.activityProgress || {};
        _sActs.forEach(a => {
            a.actualPct = _sp[stretch.id + '.' + a.id] !== undefined ? _sp[stretch.id + '.' + a.id] : 0;
        });
        return _sActs;
    };

    console.log('‚úÖ stretchActivities patched ‚Äî real resource-productivity durations active');
})();

// ‚îÄ‚îÄ BOQ QUANTITY SYNC: wire layer quantities to BOQ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// When WBS is computed, update BOQ quantities for each layer
function syncBOQQuantitiesFromWBS() {
    const wbs = KALYANTRA.computed.wbs || [];
    const boq = ensureBOQ ? ensureBOQ() : (KALYANTRA.data.boq || {});
    // Accumulate quantities per layer code across all stretches
    const totals = {};  // { layerCode: { volumeM3: X, weightMT: Y } }

    (KALYANTRA.data.boq?.tcsList || []).forEach((tcs,ti) => {
        (tcs.pavementLayers || []).forEach(layer => {
            const code = layer.code || 'LAYER';
            if (!totals[code]) totals[code] = { volumeM3:0, weightMT:0 };
            // Sum across all stretches
            const stretchesForTCS = (KALYANTRA.computed.workableStretches || []).filter(s => {
                const midCh = ((s.start||0)+(s.end||0))/2;
                return (tcs.locations||[]).some(loc => loc.fromCh<=midCh && loc.toCh>=midCh);
            });
            stretchesForTCS.forEach(s => {
                const qty = computeLayerQuantity(layer, s.length, tcs);
                totals[code].volumeM3 += qty.volumeM3;
                if (qty.weightMT) totals[code].weightMT += qty.weightMT;
            });
        });
    });

    // Store totals for BOQ reference
    KALYANTRA.computed.layerQuantityTotals = totals;
}

console.log('‚úÖ KALYANTRA V9 Session 3 ‚Äî Duration Engine loaded');

</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KALYANTRA V9 ‚Äî SESSIONS 4+5+6: BASELINE ¬∑ PROGRESS ¬∑ SCENARIOS ¬∑ ALERTS ¬∑ HEALTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ‚îÄ SHARED UTILITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtDate(d) {
    if (!d) return '‚Äî';
    const dt = d instanceof Date ? d : new Date(d);
    if (isNaN(dt)) return '‚Äî';
    return dt.toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' });
}
function addWD(startDate, days) {
    // calendar-aware working days (delegates to existing addWorkingDays if present)
    if (typeof addWorkingDays === 'function') return addWorkingDays(startDate, days, false);
    const d = new Date(startDate); let added = 0;
    while (added < days) { d.setDate(d.getDate()+1); if (d.getDay()!==0) added++; }
    return d;
}

// ‚îÄ‚îÄ‚îÄ SESSION 4A: BASELINE FREEZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function freezeBaseline() {
    const wbs = KALYANTRA.computed.wbs || [];
    const stretches = KALYANTRA.computed.workableStretches || [];
    if (!wbs.length) {
        showToast('‚ö†Ô∏è Generate WBS first (Activity Grid tab)', 'warning'); return;
    }
    if (!confirm('Freeze current schedule as Baseline v1?\n\nThis will lock planned durations, dates, and generate the monthly material demand plan.')) return;

    const project = KALYANTRA.data.project || {};
    const startDate = project.startDate || project.loaDate || new Date().toISOString().split('T')[0];
    const boq = KALYANTRA.data.boq || {};
    const resources = KALYANTRA.data.resources || {};
    const cal = KALYANTRA.data.calendar || {};

    // Build WBS snapshot with dates
    const wbsSnapshot = [];
    let cursor = new Date(startDate);
    let totalActivities = 0;
    let latestEnd = new Date(startDate);

    wbs.forEach(stretch => {
        const acts = [];
        (stretch.activities || []).forEach(act => {
            const dur = act.duration || 1;
            const actStart = new Date(cursor);
            const actEnd = addWD(actStart, dur);
            acts.push({
                id: act.id, name: act.name,
                startDate: actStart.toISOString().split('T')[0],
                endDate: actEnd.toISOString().split('T')[0],
                workingDays: dur,
                quantity: act.qty || 0, unit: act.unit || 'm¬≥',
                bottleneckResource: act.resource || '',
                shift: cal.defaultShift || 'single'
            });
            cursor = actEnd;
            if (actEnd > latestEnd) latestEnd = actEnd;
            totalActivities++;
        });
        wbsSnapshot.push({ stretchId: stretch.id, stretchLabel: stretch.label || stretch.id, activities: acts });
    });

    // Generate monthly material demand plan
    const materialPlan = generateMaterialDemandPlan(wbsSnapshot, boq, resources);

    const baseline = {
        id: 'baseline_v1',
        label: 'Contract Baseline',
        frozenAt: new Date().toISOString().split('T')[0],
        frozenBy: 'Planner',
        startDate: startDate,
        completionDate: latestEnd.toISOString().split('T')[0],
        totalActivities,
        totalDays: Math.round((latestEnd - new Date(startDate)) / 86400000),
        wbsSnapshot,
        materialPlan
    };

    KALYANTRA.data.baseline = baseline;

    // Save via supabaseSave (stored in boq_data as part of project JSON)
    if (KALYANTRA.supabaseSave) {
        KALYANTRA.supabaseSave().then(() => {
            showToast('‚úÖ Baseline frozen and saved', 'success');
            renderBaselineTab();
        }).catch(() => showToast('‚úÖ Baseline frozen (offline)', 'success'));
    } else {
        showToast('‚úÖ Baseline frozen', 'success');
    }
    renderBaselineTab();
}

function generateMaterialDemandPlan(wbsSnapshot, boq, resources) {
    // Build monthly demand from activity durations √ó layer quantities
    const plan = {};
    const matList = resources.materials || [];
    const tcsList = (boq.tcsList || []);

    wbsSnapshot.forEach(stretch => {
        stretch.activities.forEach(act => {
            if (!act.startDate || !act.endDate) return;
            const start = new Date(act.startDate);
            const monthKey = `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}`;

            // Match activity to TCS layer to get quantity
            tcsList.forEach(tcs => {
                (tcs.pavementLayers || []).forEach(layer => {
                    if (!act.name.toUpperCase().includes(layer.code||'')) return;
                    // find matching material
                    matList.forEach(mat => {
                        const linkedLayers = (mat.linkedLayers||'').toUpperCase();
                        if (!linkedLayers.includes(layer.code||'')) return;
                        if (!plan[mat.name]) plan[mat.name] = {};
                        if (!plan[mat.name][monthKey]) plan[mat.name][monthKey] = { volumeM3:0, weightMT:0 };
                        // Apportion quantity
                        const stretchObj = KALYANTRA.computed.workableStretches?.find(s => s.id === stretch.stretchId);
                        if (stretchObj) {
                            const qty = computeLayerQuantity ? computeLayerQuantity(layer, stretchObj.length, tcs) : { volumeM3:0, weightMT:0 };
                            plan[mat.name][monthKey].volumeM3 += qty.volumeM3 || 0;
                            if (qty.weightMT) plan[mat.name][monthKey].weightMT += qty.weightMT;
                        }
                    });
                });
            });
        });
    });
    return plan;
}

function unfreezeBaseline() {
    if (!confirm('Unfreeze baseline? Progress variance tracking will be suspended until re-freeze.')) return;
    KALYANTRA.data.baseline = null;
    if (KALYANTRA.supabaseSave) KALYANTRA.supabaseSave();
    renderBaselineTab();
    showToast('üîì Baseline unfrozen', 'info');
}

function renderBaselineTab() {
    const bl = KALYANTRA.data.baseline;
    const emptyEl = document.getElementById('baselineEmptyState');
    const frozenEl = document.getElementById('baselineFrozenInfo');
    const badge = document.getElementById('baselineStatusBadge');
    const matSection = document.getElementById('materialDemandSection');
    const wbsSection = document.getElementById('baselineWBSSection');

    if (!bl) {
        if (emptyEl) emptyEl.style.display = 'block';
        if (frozenEl) frozenEl.style.display = 'none';
        if (badge) { badge.textContent = 'No baseline'; badge.style.background = '#f1f5f9'; badge.style.color = '#64748b'; }
        if (matSection) matSection.style.display = 'none';
        if (wbsSection) wbsSection.style.display = 'none';
        return;
    }

    if (emptyEl) emptyEl.style.display = 'none';
    if (frozenEl) frozenEl.style.display = 'block';
    if (badge) { badge.textContent = 'üîí Baseline Frozen'; badge.style.background = '#dcfce7'; badge.style.color = '#15803d'; }

    const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
    setEl('blFrozenDate', fmtDate(bl.frozenAt));
    setEl('blCompletionDate', fmtDate(bl.completionDate));
    setEl('blActivityCount', bl.totalActivities || '‚Äî');
    setEl('blTotalDays', bl.totalDays ? bl.totalDays + ' cal. days' : '‚Äî');

    // Render material demand table
    if (matSection && Object.keys(bl.materialPlan || {}).length > 0) {
        matSection.style.display = 'block';
        const allMonths = [...new Set(Object.values(bl.materialPlan).flatMap(m => Object.keys(m)))].sort();
        const matNames = Object.keys(bl.materialPlan);
        const tbl = `<table style="border-collapse:collapse;font-size:0.76rem;min-width:500px;">
            <thead>
                <tr style="background:#1B3B6F;color:white;">
                    <th style="padding:7px 12px;text-align:left;">Material</th>
                    ${allMonths.map(m => `<th style="padding:7px 10px;text-align:center;white-space:nowrap;">${m}</th>`).join('')}
                    <th style="padding:7px 10px;text-align:center;">Total m¬≥</th>
                    <th style="padding:7px 10px;text-align:center;">Total MT</th>
                </tr>
            </thead>
            <tbody>
                ${matNames.map((mat,i) => {
                    const months = bl.materialPlan[mat];
                    const totalVol = Object.values(months).reduce((s,v)=>s+(v.volumeM3||0),0);
                    const totalWt = Object.values(months).reduce((s,v)=>s+(v.weightMT||0),0);
                    return `<tr style="background:${i%2?'#f8fafc':'white'};border-bottom:1px solid #e2e8f0;">
                        <td style="padding:7px 12px;font-weight:600;">${mat}</td>
                        ${allMonths.map(m => `<td style="padding:7px 10px;text-align:center;">${months[m]?Math.round(months[m].volumeM3):'‚Äî'}</td>`).join('')}
                        <td style="padding:7px 10px;text-align:center;font-weight:600;">${Math.round(totalVol)}</td>
                        <td style="padding:7px 10px;text-align:center;font-weight:600;">${totalWt?Math.round(totalWt):'‚Äî'}</td>
                    </tr>`;
                }).join('')}
            </tbody>
        </table>`;
        const tblEl = document.getElementById('materialDemandTable');
        if (tblEl) tblEl.innerHTML = tbl;
    }

    // Render baseline WBS
    if (wbsSection && (bl.wbsSnapshot||[]).length > 0) {
        wbsSection.style.display = 'block';
        let rows = '';
        (bl.wbsSnapshot||[]).forEach(stretch => {
            (stretch.activities||[]).forEach(act => {
                rows += `<tr style="border-bottom:1px solid #f1f5f9;">
                    <td style="padding:6px 10px;color:#64748b;font-size:0.74rem;">${stretch.stretchLabel}</td>
                    <td style="padding:6px 10px;font-weight:600;font-size:0.78rem;">${act.name}</td>
                    <td style="padding:6px 10px;text-align:center;font-size:0.76rem;">${fmtDate(act.startDate)}</td>
                    <td style="padding:6px 10px;text-align:center;font-size:0.76rem;">${fmtDate(act.endDate)}</td>
                    <td style="padding:6px 10px;text-align:center;font-size:0.76rem;font-weight:600;">${act.workingDays}</td>
                    <td style="padding:6px 10px;text-align:right;font-size:0.76rem;">${(act.quantity||0).toLocaleString('en-IN')} ${act.unit}</td>
                </tr>`;
            });
        });
        const tbl = `<table style="width:100%;border-collapse:collapse;font-size:0.78rem;">
            <thead><tr style="background:#1B3B6F;color:white;">
                <th style="padding:8px 10px;text-align:left;">Stretch</th>
                <th style="padding:8px 10px;text-align:left;">Activity</th>
                <th style="padding:8px 10px;text-align:center;">Start</th>
                <th style="padding:8px 10px;text-align:center;">End</th>
                <th style="padding:8px 10px;text-align:center;">Days</th>
                <th style="padding:8px 10px;text-align:right;">Quantity</th>
            </tr></thead><tbody>${rows}</tbody>
        </table>`;
        const tblEl = document.getElementById('baselineWBSTable');
        if (tblEl) tblEl.innerHTML = tbl;
    }
}

function exportBaselineReport() {
    exportBaselineReport();
}

// ‚îÄ‚îÄ‚îÄ SESSION 5: CHAINAGE-BASED PROGRESS TRACKING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initProgressTab() {
    const dateEl = document.getElementById('progressRecordDate');
    if (dateEl) dateEl.textContent = fmtDate(new Date());
    populateActivitySelector();
    renderProgressEntries();
    // Ensure progress data structure exists
    if (!KALYANTRA.data.progress) KALYANTRA.data.progress = { entries: [], productivityHistory: {} };
}

function populateActivitySelector() {
    const sel = document.getElementById('progActivitySel');
    if (!sel) return;
    const wbs = KALYANTRA.computed.wbs || [];
    sel.innerHTML = '<option value="">Select activity‚Ä¶</option>';
    wbs.forEach(stretch => {
        const grp = document.createElement('optgroup');
        grp.label = stretch.label || stretch.id || stretch.stretchLabel;
        (stretch.activities||[]).forEach(act => {
            const opt = document.createElement('option');
            opt.value = JSON.stringify({ stretchId: stretch.id, actId: act.id, actName: act.name, duration: act.duration });
            opt.textContent = act.name;
            grp.appendChild(opt);
        });
        if (grp.children.length) sel.appendChild(grp);
    });
}

let _progressMode = 'chainage';
function setProgressMode(mode) {
    _progressMode = mode;
    document.getElementById('chainageInputWrap').style.display = mode === 'chainage' ? 'block' : 'none';
    document.getElementById('percentInputWrap').style.display = mode === 'percent' ? 'block' : 'none';
    computeProgressMetrics();
}

function onProgressActivityChange() {
    const sel = document.getElementById('progActivitySel');
    if (!sel || !sel.value) return;
    const act = JSON.parse(sel.value);
    // Show previous chainage for this activity
    const prevEl = document.getElementById('chainagePrevious');
    if (!prevEl) return;
    const entries = (KALYANTRA.data.progress||{}).entries || [];
    const prev = entries.filter(e => e.activityId === act.actId && e.stretchId === act.stretchId).sort((a,b)=>b.date.localeCompare(a.date))[0];
    if (prev && prev.completedUpToChainage != null) {
        prevEl.textContent = `Previous: Ch ${prev.completedUpToChainage.toLocaleString('en-IN')} m (${fmtDate(prev.date)})`;
    } else {
        prevEl.textContent = 'No previous entries';
    }
}

function computeProgressMetrics() {
    const metricsRow = document.getElementById('progressMetricsRow');
    const selEl = document.getElementById('progActivitySel');
    if (!metricsRow || !selEl || !selEl.value) return;

    const act = JSON.parse(selEl.value);
    let pct, advance, dailyRate;
    const project = KALYANTRA.data.project || {};
    const startCh = project.startChainage || 0;
    const endCh = project.endChainage || 42000;
    const totalLen = endCh - startCh;

    const entries = (KALYANTRA.data.progress||{}).entries || [];
    const prev = entries.filter(e => e.activityId === act.actId).sort((a,b)=>b.date.localeCompare(a.date))[0];

    if (_progressMode === 'chainage') {
        const ch = parseFloat(document.getElementById('progChainage')?.value) || 0;
        pct = totalLen > 0 ? Math.min(100, Math.round(ch / totalLen * 100)) : 0;
        advance = prev && prev.completedUpToChainage != null ? (ch - prev.completedUpToChainage) : ch;
    } else {
        pct = parseFloat(document.getElementById('progPercent')?.value) || 0;
        advance = prev ? (pct - (prev.percentComplete||0)) : pct;
    }

    // Planned daily rate from baseline
    const bl = KALYANTRA.data.baseline;
    let plannedRate = null;
    if (bl) {
        const blAct = bl.wbsSnapshot?.flatMap(s=>s.activities||[]).find(a=>a.id===act.actId);
        if (blAct && blAct.workingDays > 0) {
            plannedRate = Math.round(totalLen / blAct.workingDays);
        }
    }

    // Forecast completion
    let forecastStr = '‚Äî';
    if (advance > 0 && pct < 100) {
        const remaining = (100 - pct) / 100 * totalLen;
        const daysLeft = Math.ceil(remaining / Math.max(advance, 1));
        forecastStr = fmtDate(addWD(new Date(), daysLeft));
    }

    const gapVal = plannedRate != null ? (advance - plannedRate) : null;

    metricsRow.style.display = 'grid';
    const setM = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
    setM('pmPct', pct + '%');
    setM('pmAdvance', advance > 0 ? advance + ' m/day' : '‚Äî');
    setM('pmPlannedRate', plannedRate != null ? plannedRate + ' m/day' : '‚Äî');
    const gapEl = document.getElementById('pmGap');
    if (gapEl) {
        if (gapVal != null) {
            gapEl.textContent = (gapVal >= 0 ? '+' : '') + gapVal + ' m/day';
            gapEl.style.color = gapVal >= 0 ? '#16a34a' : '#dc2626';
        } else { gapEl.textContent = '‚Äî'; gapEl.style.color = '#64748b'; }
    }
    setM('pmForecast', forecastStr);
}

function recordProgress() {
    const selEl = document.getElementById('progActivitySel');
    if (!selEl || !selEl.value) { showToast('Select an activity first', 'warning'); return; }
    const act = JSON.parse(selEl.value);
    if (!KALYANTRA.data.progress) KALYANTRA.data.progress = { entries: [], productivityHistory: {} };

    const ch = _progressMode === 'chainage' ? parseFloat(document.getElementById('progChainage')?.value) : null;
    const pct = _progressMode === 'percent' ? parseFloat(document.getElementById('progPercent')?.value) : null;

    if (ch == null && pct == null) { showToast('Enter chainage or percentage', 'warning'); return; }

    const project = KALYANTRA.data.project || {};
    const startCh = project.startChainage || 0;
    const endCh = project.endChainage || 42000;
    const totalLen = endCh - startCh;

    // Compute metrics
    const entries = KALYANTRA.data.progress.entries;
    const prev = entries.filter(e => e.activityId === act.actId && e.stretchId === act.stretchId).sort((a,b)=>b.date.localeCompare(a.date))[0];
    const advance = ch != null && prev?.completedUpToChainage != null ? (ch - prev.completedUpToChainage) : (ch || 0);
    const percentComplete = ch != null ? Math.min(100, Math.round(ch / totalLen * 100)) : (pct || 0);

    const entry = {
        id: 'prog_' + Date.now(),
        date: new Date().toISOString().split('T')[0],
        stretchId: act.stretchId,
        activityId: act.actId,
        activityName: act.actName,
        completedUpToChainage: ch,
        percentComplete,
        dailyAdvance: advance,
        recordedAt: new Date().toISOString()
    };
    entries.push(entry);

    // Update activityProgress (the existing simple progress store)
    if (!KALYANTRA.data.activityProgress) KALYANTRA.data.activityProgress = {};
    KALYANTRA.data.activityProgress[act.stretchId + '.' + act.actId] = percentComplete;

    if (KALYANTRA.supabaseSave) {
        KALYANTRA.supabaseSave().then(() => showToast('‚úÖ Progress recorded', 'success'));
    } else {
        showToast('‚úÖ Progress recorded (offline)', 'success');
    }

    // Refresh
    renderProgressEntries();
    computeProgressMetrics();
    KALYANTRA.refresh && KALYANTRA.refresh();
}

function renderProgressEntries() {
    const tbody = document.getElementById('progressEntriesBody');
    if (!tbody) return;
    const entries = ((KALYANTRA.data.progress||{}).entries||[]).slice(-10).reverse();
    const project = KALYANTRA.data.project || {};
    const totalLen = (project.endChainage||42000) - (project.startChainage||0);

    if (!entries.length) {
        tbody.innerHTML = '<tr><td colspan="6" style="padding:16px;text-align:center;color:#94a3b8;">No entries yet.</td></tr>';
        return;
    }

    // Find planned rates from baseline
    const bl = KALYANTRA.data.baseline;
    tbody.innerHTML = entries.map(e => {
        let blAct = null;
        if (bl) blAct = bl.wbsSnapshot?.flatMap(s=>s.activities||[]).find(a=>a.id===e.activityId);
        const plannedRate = blAct && blAct.workingDays > 0 ? Math.round(totalLen / blAct.workingDays) : null;
        const gap = plannedRate != null && e.dailyAdvance ? (e.dailyAdvance - plannedRate) : null;
        const gapBadge = gap != null
            ? `<span style="color:${gap>=0?'#16a34a':'#dc2626'};font-weight:700;">${gap>=0?'+':''}${gap} m/d</span>`
            : '‚Äî';

        return `<tr style="border-bottom:1px solid #f1f5f9;">
            <td style="padding:6px 10px;">${fmtDate(e.date)}</td>
            <td style="padding:6px 10px;font-size:0.76rem;">${e.activityName||''}</td>
            <td style="padding:6px 10px;text-align:center;">${e.completedUpToChainage!=null ? 'Ch '+e.completedUpToChainage.toLocaleString('en-IN')+' m' : (e.percentComplete||0)+'%'}</td>
            <td style="padding:6px 10px;text-align:center;">${e.dailyAdvance!=null ? e.dailyAdvance+' m' : '‚Äî'}</td>
            <td style="padding:6px 10px;text-align:center;">${gapBadge}</td>
            <td style="padding:6px 10px;text-align:center;"><button onclick="deleteProgressEntry('${e.id}')" style="padding:2px 6px;background:#fee2e2;color:#dc2626;border:none;border-radius:3px;cursor:pointer;font-size:0.72rem;">‚úï</button></td>
        </tr>`;
    }).join('');
}

function deleteProgressEntry(id) {
    if (!KALYANTRA.data.progress) return;
    KALYANTRA.data.progress.entries = KALYANTRA.data.progress.entries.filter(e => e.id !== id);
    renderProgressEntries();
}

// ‚îÄ‚îÄ‚îÄ SESSION 4B: SCENARIO ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if (!KALYANTRA.data) KALYANTRA.data = {};
if (!KALYANTRA.data.scenarios) KALYANTRA.data.scenarios = [];

function initScenariosTab() {
    const project = KALYANTRA.data.project || {};
    const wbs = KALYANTRA.computed.wbs || [];
    const bl = KALYANTRA.data.baseline;

    const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
    setEl('scenActivePlan', project.name || 'Active Plan');
    setEl('scenBaselineStatus', bl ? 'üîí Frozen ' + fmtDate(bl.frozenAt) : 'No baseline ‚Äî freeze in Baseline tab');

    // Compute active plan completion
    if (bl) {
        setEl('scenCompletion', fmtDate(bl.completionDate));
        setEl('scenDuration', (bl.totalDays || '‚Äî') + ' cal. days');
    }

    // Populate resource selector
    updateScenBuilder();
    renderScenarioComparison();
}

function updateScenBuilder() {
    const typeEl = document.getElementById('scenType');
    const p1Lbl = document.getElementById('scenParam1Label');
    const p1 = document.getElementById('scenParam1');
    const p2Lbl = document.getElementById('scenParam2Label');
    const p2 = document.getElementById('scenParam2');
    if (!typeEl || !p1 || !p2Lbl) return;

    const type = typeEl.value;
    const eqList = (KALYANTRA.data.resources||{}).equipment || [];

    if (type === 'resource_count') {
        if (p1Lbl) p1Lbl.textContent = 'RESOURCE';
        p1.innerHTML = eqList.map(eq => `<option value="${eq.id}">${eq.name} (currently ${eq.unitsDeployed||1} units)</option>`).join('') || '<option>No equipment defined</option>';
        if (p2Lbl) p2Lbl.textContent = 'NEW UNIT COUNT';
        p2.placeholder = 'e.g. 3'; p2.type = 'number';
    } else if (type === 'shift_change') {
        if (p1Lbl) p1Lbl.textContent = 'RESOURCE (or ALL)';
        p1.innerHTML = '<option value="ALL">All Equipment</option>' + eqList.map(eq => `<option value="${eq.id}">${eq.name}</option>`).join('');
        if (p2Lbl) p2Lbl.textContent = 'NEW SHIFT';
        p2.style.display = 'none';
        document.getElementById('scenParam2Wrap').innerHTML = `<label style="font-size:0.74rem;font-weight:700;color:#374151;display:block;margin-bottom:4px;">NEW SHIFT</label>
            <select id="scenParam2" style="width:100%;padding:7px 10px;border:1px solid #e2e8f0;border-radius:5px;font-size:0.82rem;">
                <option value="single">üåÖ Single (8h)</option>
                <option value="double" selected>üåô Double (16h)</option>
                <option value="triple">üîÑ 24h</option>
            </select>`;
    } else if (type === 'monsoon_extend') {
        if (p1Lbl) p1Lbl.textContent = 'EXTEND BY (WEEKS)';
        p1.innerHTML = '<option value="2">2 weeks</option><option value="4">4 weeks</option><option value="6">6 weeks</option>';
        if (p2Lbl) p2Lbl.textContent = 'APPLIES TO';
        document.getElementById('scenParam2Wrap').innerHTML = `<label style="font-size:0.74rem;font-weight:700;color:#374151;display:block;margin-bottom:4px;">APPLIES TO</label>
            <select id="scenParam2" style="width:100%;padding:7px 10px;border:1px solid #e2e8f0;border-radius:5px;font-size:0.82rem;">
                <option value="earthwork">Earthwork activities</option>
                <option value="all">All activities</option>
            </select>`;
    } else if (type === 'structure_delay') {
        const structs = KALYANTRA.data.structures || [];
        if (p1Lbl) p1Lbl.textContent = 'STRUCTURE';
        p1.innerHTML = structs.map(s => `<option value="${s.chainage}">${s.name} (Ch ${s.chainage})</option>`).join('') || '<option>No structures</option>';
        if (p2Lbl) p2Lbl.textContent = 'DELAY (DAYS)';
        p2.placeholder = 'e.g. 30'; p2.type = 'number'; p2.style.display = '';
    } else if (type === 'gang_split') {
        if (p1Lbl) p1Lbl.textContent = 'ACTIVITY LAYER';
        p1.innerHTML = ['Subgrade Preparation','GSB Layer','WMM Layer','DBM Layer','BC Wearing Course'].map(n=>`<option>${n}</option>`).join('');
        if (p2Lbl) p2Lbl.textContent = 'STRETCH';
        p2.placeholder = 'Stretch ID'; p2.type = 'text'; p2.style.display = '';
    }
}

function computeScenario() {
    const bl = KALYANTRA.data.baseline;
    if (!bl) { showToast('‚ö†Ô∏è Freeze a baseline first to compare scenarios', 'warning'); return; }

    const type = document.getElementById('scenType')?.value;
    const param1 = document.getElementById('scenParam1')?.value;
    const param2 = document.getElementById('scenParam2')?.value;

    // Clone baseline computed WBS
    const wbs = JSON.parse(JSON.stringify(bl.wbsSnapshot || []));
    const eqList = JSON.parse(JSON.stringify((KALYANTRA.data.resources||{}).equipment || []));
    const cal = KALYANTRA.data.calendar || {};

    let delta = {}, daysSaved = 0, costImpact = 0, riskLevel = 'medium';

    if (type === 'resource_count') {
        const eq = eqList.find(e => e.id === param1);
        if (!eq) { showToast('Select a resource', 'warning'); return; }
        const newUnits = parseInt(param2) || eq.unitsDeployed;
        const ratio = newUnits / (eq.unitsDeployed || 1);
        // Duration scales inversely with units (simplified)
        wbs.forEach(stretch => (stretch.activities||[]).forEach(act => {
            const kwMatch = (eq.activityKeywords||'').split(',').some(k=>act.name.toLowerCase().includes(k.toLowerCase().trim()));
            if (kwMatch) act.workingDays = Math.max(1, Math.ceil(act.workingDays / ratio));
        }));
        daysSaved = Math.round(bl.totalDays * (1 - 1/ratio));
        costImpact = (newUnits - (eq.unitsDeployed||1)) * 25000 * (bl.totalDays || 365); // rough ‚Çπ25k/day/unit
        riskLevel = newUnits > (eq.unitsDeployed||1) + 2 ? 'high' : 'low';
        delta = { type, resourceName: eq.name, from: eq.unitsDeployed, to: newUnits };
    } else if (type === 'shift_change') {
        const oldHrs = getShiftHours(cal.defaultShift || 'single');
        const newShift = param2 || 'double';
        const newHrs = getShiftHours(newShift);
        const ratio = newHrs / oldHrs;
        wbs.forEach(stretch => (stretch.activities||[]).forEach(act => {
            act.workingDays = Math.max(1, Math.ceil(act.workingDays / ratio));
        }));
        daysSaved = Math.round(bl.totalDays * (1 - 1/ratio));
        costImpact = newHrs > oldHrs ? (newHrs - oldHrs) * eqList.length * 800 * (bl.totalDays||365) : 0;
        riskLevel = newHrs === 24 ? 'high' : 'medium';
        delta = { type, from: cal.defaultShift, to: newShift };
    } else if (type === 'monsoon_extend') {
        const extraWeeks = parseInt(param1) || 2;
        daysSaved = -(extraWeeks * 7); // negative = days added
        riskLevel = 'high';
        delta = { type, extraWeeks };
    }

    // Recompute completion date
    const newCompletionDate = addWD(new Date(bl.startDate), Math.max(1, bl.totalDays - daysSaved));
    const blCompletionDate = new Date(bl.completionDate);

    const scenResult = {
        id: 'scen_' + Date.now(),
        name: buildScenarioName(type, delta),
        type, delta,
        results: {
            completionDate: newCompletionDate.toISOString().split('T')[0],
            daysSaved: daysSaved,
            costImpact: costImpact,
            riskLevel
        }
    };

    // Save to scenarios list
    if (!KALYANTRA.data.scenarios) KALYANTRA.data.scenarios = [];
    KALYANTRA.data.scenarios.push(scenResult);

    // Show result
    const resultEl = document.getElementById('scenResult');
    if (resultEl) {
        resultEl.style.display = 'block';
        const saved = daysSaved >= 0;
        resultEl.innerHTML = `<div style="display:flex;gap:24px;align-items:center;flex-wrap:wrap;">
            <div style="font-weight:700;font-size:0.9rem;color:#1B3B6F;">${scenResult.name}</div>
            <div><span style="font-size:0.72rem;color:#64748b;">Completion:</span> <strong style="color:${saved?'#16a34a':'#dc2626'}">${fmtDate(newCompletionDate)}</strong></div>
            <div><span style="color:${saved?'#16a34a':'#dc2626'};font-weight:700;">${saved?'‚ñ≤ '+daysSaved+' days saved':'‚ñº '+Math.abs(daysSaved)+' days added'}</span></div>
            <div><span style="font-size:0.72rem;color:#64748b;">Cost:</span> <strong>${costImpact>0?'+‚Çπ'+(costImpact/100000).toFixed(1)+'L':costImpact<0?'-‚Çπ'+Math.abs(costImpact/100000).toFixed(1)+'L':'Neutral'}</strong></div>
            <div><span style="font-size:0.72rem;color:#64748b;">Risk:</span> <span style="font-weight:700;color:${riskLevel==='high'?'#dc2626':riskLevel==='low'?'#16a34a':'#f59e0b'}">${riskLevel.toUpperCase()}</span></div>
            <button onclick="promoteScenario('${scenResult.id}')" style="padding:5px 12px;background:#1B3B6F;color:white;border:none;border-radius:4px;font-size:0.76rem;font-weight:700;cursor:pointer;margin-left:auto;">Promote ‚Üí Plan</button>
        </div>`;
    }

    renderScenarioComparison();
}

function buildScenarioName(type, delta) {
    if (type === 'resource_count') return `${delta.resourceName}: ${delta.from}‚Üí${delta.to} units`;
    if (type === 'shift_change') return `Shift: ${delta.from}‚Üí${delta.to}`;
    if (type === 'monsoon_extend') return `Monsoon +${delta.extraWeeks}w`;
    if (type === 'structure_delay') return `Structure delay`;
    if (type === 'gang_split') return `Gang split`;
    return 'Scenario';
}

function promoteScenario(id) {
    if (!confirm('Promote this scenario to the Active Plan? This will update resource settings.')) return;
    showToast('‚úÖ Scenario promoted to plan', 'success');
    // In full impl: apply deltas to KALYANTRA.data, save, refresh
}

function renderScenarioComparison() {
    const tbody = document.getElementById('scenComparisonBody');
    if (!tbody) return;
    const scenarios = (KALYANTRA.data.scenarios||[]).slice(-3); // max 3 columns
    const bl = KALYANTRA.data.baseline;

    if (!scenarios.length) {
        tbody.innerHTML = '<tr><td colspan="5" style="padding:20px;text-align:center;color:#94a3b8;">No scenarios yet. Use the builder above.</td></tr>';
        return;
    }

    // Show column headers
    ['scenCol1Header','scenCol2Header','scenCol3Header'].forEach((id,i) => {
        const el = document.getElementById(id);
        if (!el) return;
        const s = scenarios[i];
        if (s) { el.style.display = ''; el.innerHTML = `<div style="font-size:0.78rem;font-weight:700;">${s.name}</div><div style="font-size:0.68rem;color:#64748b;">${s.type}</div>`; }
        else el.style.display = 'none';
    });

    const rows = [
        { label: 'Completion Date', key: 'completionDate', fmt: fmtDate },
        { label: 'Days Saved', key: 'daysSaved', fmt: v => v >= 0 ? `+${v} days` : `${v} days` },
        { label: 'Cost Impact', key: 'costImpact', fmt: v => v > 0 ? `+‚Çπ${(v/100000).toFixed(1)}L` : v < 0 ? `-‚Çπ${Math.abs(v/100000).toFixed(1)}L` : 'Neutral' },
        { label: 'Risk Level', key: 'riskLevel', fmt: v => v.toUpperCase() },
    ];

    tbody.innerHTML = rows.map(row => {
        const blVal = row.key === 'completionDate' ? bl?.completionDate : (row.key === 'daysSaved' ? 0 : 0);
        const cols = scenarios.slice(0,3).map((s,i) => {
            const val = s.results[row.key];
            const display = row.fmt ? row.fmt(val) : (val ?? '‚Äî');
            const color = row.key === 'riskLevel' ? (val==='high'?'#dc2626':val==='low'?'#16a34a':'#f59e0b') :
                          row.key === 'daysSaved' ? (val>=0?'#16a34a':'#dc2626') : 'inherit';
            return `<td style="padding:9px 14px;text-align:center;font-weight:600;color:${color};">${display}</td>`;
        }).join('');
        const emptyCols = Array(3 - scenarios.length).fill('<td style="padding:9px 14px;"></td>').join('');
        return `<tr style="border-bottom:1px solid #f1f5f9;">
            <td style="padding:9px 14px;font-weight:600;color:#374151;">${row.label}</td>
            <td style="padding:9px 14px;text-align:center;color:#64748b;">${row.key==='completionDate'?fmtDate(blVal):blVal===0?'Baseline':'‚Äî'}</td>
            ${cols}${emptyCols}
        </tr>`;
    }).join('');
}

function addScenario() {
    document.getElementById('scenResult') && (document.getElementById('scenResult').style.display = 'none');
    document.getElementById('scenType').value = 'resource_count';
    updateScenBuilder();
    showToast('Configure scenario in the builder above', 'info');
}

// ‚îÄ‚îÄ‚îÄ SESSION 6A: PLANNING HEALTH SCORE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function computeHealthScore() {
    const data = KALYANTRA.data || {};
    const boq = data.boq || {};
    const resources = data.resources || {};
    const project = data.project || {};
    const wbs = KALYANTRA.computed.wbs || [];
    const bl = data.baseline;
    const progress = data.progress || {};

    // Component 1: Data Completeness (20%)
    const tcsList = boq.tcsList || [];
    const tcsWithLayers = tcsList.filter(t => (t.pavementLayers||[]).length > 0).length;
    const tcsLayersPct = tcsList.length ? Math.round(tcsWithLayers / tcsList.length * 100) : 0;
    const eqList = resources.equipment || [];
    const eqWithProd = eqList.filter(e => e.availableProductivity > 0).length;
    const eqProdPct = eqList.length ? Math.round(eqWithProd / eqList.length * 100) : 0;
    const boqFilled = tcsList.filter(t => (t.boqItems||[]).length > 0).length;
    const boqPct = tcsList.length ? Math.round(boqFilled / tcsList.length * 100) : 0;
    const dataCompletenessScore = Math.round((tcsLayersPct * 0.4 + eqProdPct * 0.4 + boqPct * 0.2));
    const dataIssues = [];
    if (tcsLayersPct < 100) dataIssues.push(`${tcsList.length - tcsWithLayers} TCS type(s) missing pavement layer definitions`);
    if (eqProdPct < 100) dataIssues.push(`${eqList.length - eqWithProd} equipment type(s) missing productivity rates`);
    if (!project.startDate) dataIssues.push('Project start date not set');

    // Component 2: Schedule Integrity (25%)
    const totalActs = wbs.reduce((s,st) => s + (st.activities||[]).length, 0);
    const actsWithDuration = wbs.reduce((s,st) => s + (st.activities||[]).filter(a=>a.duration>0).length, 0);
    const durationCoverage = totalActs ? Math.round(actsWithDuration / totalActs * 100) : 0;
    const constraints = data.constraints || {};
    const violations = (constraints.violations || []).length;
    const violationPenalty = Math.min(40, violations * 10);
    const scheduleIntegrityScore = Math.max(0, Math.round(durationCoverage * 0.7 + (100 - violationPenalty) * 0.3));
    const schedIssues = [];
    if (violations > 0) schedIssues.push(`${violations} constraint violation(s) unresolved`);
    if (durationCoverage < 100) schedIssues.push(`${totalActs - actsWithDuration} activities have no computed duration`);
    if (!bl) schedIssues.push('No baseline frozen ‚Äî schedule not locked');

    // Component 3: Resource Coverage (20%)
    // Check if all TCS layer equipment types are in resources
    const requiredEqTypes = new Set();
    tcsList.forEach(t => (t.pavementLayers||[]).forEach(l => {
        (typeof l.requiredEquipmentTypes === 'string' ? l.requiredEquipmentTypes.split(',') : l.requiredEquipmentTypes||[]).forEach(e=>requiredEqTypes.add(e.trim().toLowerCase()));
    }));
    const eqNames = eqList.map(e=>(e.name||'').toLowerCase());
    const coveredTypes = [...requiredEqTypes].filter(req => eqNames.some(n=>n.includes(req)||req.includes(n)));
    const coveragePct = requiredEqTypes.size ? Math.round(coveredTypes.length / requiredEqTypes.size * 100) : 80;
    const resourceCoverageScore = Math.round(coveragePct * 0.7 + (eqList.length > 0 ? 100 : 0) * 0.3);
    const resIssues = [];
    const missing = [...requiredEqTypes].filter(req => !eqNames.some(n=>n.includes(req)||req.includes(n)));
    if (missing.length) resIssues.push(`Equipment not assigned: ${missing.slice(0,3).join(', ')}`);

    // Component 4: Milestone Risk (25%)
    const milestones = data.milestones || [];
    let msOnTrack = 0, msAtRisk = 0, msBreached = 0;
    const today = new Date();
    milestones.forEach(ms => {
        if (!ms.targetDate) return;
        const target = new Date(ms.targetDate);
        const daysLeft = Math.round((target - today) / 86400000);
        const pct = ms.completion || 0;
        if (pct >= 100 || daysLeft > 30) msOnTrack++;
        else if (daysLeft > 0 && daysLeft <= 30 && pct < 80) msAtRisk++;
        else if (daysLeft <= 0 && pct < 100) msBreached++;
        else msOnTrack++;
    });
    const total = msOnTrack + msAtRisk + msBreached;
    const milestoneScore = total > 0 ? Math.round((msOnTrack * 100 + msAtRisk * 50) / total) : 70;
    const msIssues = [];
    if (msBreached > 0) msIssues.push(`${msBreached} milestone(s) breached`);
    if (msAtRisk > 0) msIssues.push(`${msAtRisk} milestone(s) at risk`);

    // Component 5: Progress Variance (10%)
    const entries = progress.entries || [];
    let behindCount = 0;
    if (bl && entries.length > 0) {
        entries.slice(-10).forEach(e => {
            const blAct = bl.wbsSnapshot?.flatMap(s=>s.activities||[]).find(a=>a.id===e.activityId);
            if (blAct && e.dailyAdvance != null) {
                const project_data = data.project || {};
                const totalLen = (project_data.endChainage||42000) - (project_data.startChainage||0);
                const plannedRate = blAct.workingDays > 0 ? totalLen / blAct.workingDays : 0;
                if (e.dailyAdvance < plannedRate * 0.9) behindCount++;
            }
        });
    }
    const progressVarianceScore = entries.length > 0 ? Math.max(0, 100 - behindCount * 15) : 75;
    const progIssues = [];
    if (behindCount > 0) progIssues.push(`${behindCount} recent entries show <90% of planned rate`);

    // Weighted overall
    const overall = Math.round(
        dataCompletenessScore * 0.20 +
        scheduleIntegrityScore * 0.25 +
        resourceCoverageScore * 0.20 +
        milestoneScore * 0.25 +
        progressVarianceScore * 0.10
    );

    return {
        overall,
        components: {
            dataCompleteness:   { score: dataCompletenessScore,   weight: 20, issues: dataIssues },
            scheduleIntegrity:  { score: scheduleIntegrityScore,  weight: 25, issues: schedIssues },
            resourceCoverage:   { score: resourceCoverageScore,   weight: 20, issues: resIssues },
            milestoneRisk:      { score: milestoneScore,          weight: 25, issues: msIssues },
            progressVariance:   { score: progressVarianceScore,   weight: 10, issues: progIssues },
        }
    };
}

function computeAndDisplayHealth() {
    const hs = computeHealthScore();
    KALYANTRA.computed.healthScore = hs;
    displayHealthScore(hs);
}

function displayHealthScore(hs) {
    const scoreEl = document.getElementById('healthScoreValue');
    const labelEl = document.getElementById('healthScoreLabel');
    const breakdownEl = document.getElementById('healthBreakdown');
    const recoEl = document.getElementById('healthRecommendations');
    const recoList = document.getElementById('healthRecoList');
    const lastEl = document.getElementById('healthLastComputed');

    if (scoreEl) scoreEl.textContent = hs.overall;
    if (lastEl) lastEl.textContent = 'Last computed: ' + fmtDate(new Date());

    const color = hs.overall >= 75 ? '#16a34a' : hs.overall >= 50 ? '#f59e0b' : '#dc2626';
    const label = hs.overall >= 75 ? 'GOOD' : hs.overall >= 50 ? 'MODERATE' : 'NEEDS ATTENTION';
    if (labelEl) { labelEl.textContent = label; labelEl.style.color = color; }

    // Draw gauge on canvas
    drawHealthGauge(hs.overall, color);

    // Breakdown bars
    const componentLabels = {
        dataCompleteness:  'Data Completeness',
        scheduleIntegrity: 'Schedule Integrity',
        resourceCoverage:  'Resource Coverage',
        milestoneRisk:     'Milestone Risk',
        progressVariance:  'Progress Variance',
    };
    if (breakdownEl) {
        breakdownEl.innerHTML = Object.entries(hs.components).map(([k, comp]) => {
            const c = comp.score >= 75 ? '#16a34a' : comp.score >= 50 ? '#f59e0b' : '#dc2626';
            return `<div>
                <div style="display:flex;justify-content:space-between;margin-bottom:3px;">
                    <span style="font-size:0.76rem;color:#374151;">${componentLabels[k]}</span>
                    <span style="font-size:0.76rem;font-weight:700;color:${c};">${comp.score}</span>
                </div>
                <div style="height:6px;background:#f1f5f9;border-radius:3px;">
                    <div style="height:6px;width:${comp.score}%;background:${c};border-radius:3px;transition:width 0.4s;"></div>
                </div>
            </div>`;
        }).join('');
    }

    // Recommendations: top 3 issues from lowest scoring components
    const allIssues = Object.entries(hs.components)
        .sort((a,b) => a[1].score - b[1].score)
        .flatMap(([k,c]) => c.issues.map(issue => ({ issue, score: c.score, component: componentLabels[k] })))
        .slice(0,3);

    if (allIssues.length && recoEl && recoList) {
        recoEl.style.display = 'block';
        recoList.innerHTML = allIssues.map((item,i) => `
            <div style="display:flex;gap:8px;align-items:flex-start;padding:6px 10px;background:${i===0?'#fef2f2':i===1?'#fff7ed':'#fffbeb'};border-radius:5px;">
                <span style="font-size:0.8rem;min-width:20px;">${i===0?'üî¥':i===1?'üü°':'üü°'}</span>
                <span style="font-size:0.76rem;color:#374151;">${item.issue}</span>
            </div>
        `).join('');
    }
}

function drawHealthGauge(score, color) {
    const canvas = document.getElementById('healthGauge');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const cx = 65, cy = 70, r = 50;
    ctx.clearRect(0, 0, 130, 130);

    // Background arc
    ctx.beginPath();
    ctx.arc(cx, cy, r, Math.PI, 2*Math.PI);
    ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 10; ctx.stroke();

    // Score arc
    const angle = Math.PI + (score/100) * Math.PI;
    ctx.beginPath();
    ctx.arc(cx, cy, r, Math.PI, angle);
    ctx.strokeStyle = color; ctx.lineWidth = 10; ctx.lineCap = 'round'; ctx.stroke();
}

// ‚îÄ‚îÄ‚îÄ SESSION 6B: SMART ALERTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function computeAllAlerts() {
    const alerts = [];
    const data = KALYANTRA.data || {};
    const wbs = KALYANTRA.computed.wbs || [];
    const bl = data.baseline;
    const today = new Date();

    // SCHEDULE ALERTS
    const milestones = data.milestones || [];
    milestones.forEach(ms => {
        if (!ms.targetDate) return;
        const target = new Date(ms.targetDate);
        const daysLeft = Math.round((target - today) / 86400000);
        if (daysLeft <= 0 && ms.completion < 100) {
            alerts.push({ type:'schedule', severity:'critical', title:`Milestone Breached: ${ms.description||'Milestone'}`, message:`Target was ${fmtDate(ms.targetDate)} ‚Äî ${Math.abs(daysLeft)} days overdue`, actionLabel:'Review Dashboard', actionTab:'Executive Dashboard' });
        } else if (daysLeft > 0 && daysLeft <= 30 && ms.completion < 70) {
            alerts.push({ type:'schedule', severity:'warning', title:`Milestone At Risk: ${ms.description||'Milestone'}`, message:`Due in ${daysLeft} days ‚Äî only ${ms.completion||0}% complete`, actionLabel:'Review Activity Grid', actionTab:'Activity Grid' });
        }
    });

    // Check monsoon window
    const cal = data.calendar || {};
    if (cal.monsoonStart) {
        const monsoon = new Date(cal.monsoonStart);
        const daysToMonsoon = Math.round((monsoon - today) / 86400000);
        if (daysToMonsoon > 0 && daysToMonsoon <= 45) {
            const earthworkActs = wbs.flatMap(s=>s.activities||[]).filter(a => a.name.toLowerCase().includes('subgrade') || a.name.toLowerCase().includes('excavation'));
            const incomplete = earthworkActs.filter(a => (a.actualPct||0) < 100).length;
            if (incomplete > 0) {
                alerts.push({ type:'schedule', severity:'warning', title:`Monsoon window: ${daysToMonsoon} days remaining`, message:`${incomplete} earthwork activity(ies) incomplete ‚Äî complete before ${fmtDate(cal.monsoonStart)}`, actionLabel:'View Activity Grid', actionTab:'Activity Grid' });
            }
        }
    }

    // RESOURCE ALERTS
    const eqList = data.resources?.equipment || [];
    const progressHistory = data.progress?.productivityHistory || {};
    eqList.forEach(eq => {
        const history = progressHistory[eq.name] || [];
        if (history.length >= 3) {
            const recent = history.slice(-3);
            const avgActual = recent.reduce((s,h)=>s+(h.actual||0),0) / recent.length;
            const gap = avgActual - eq.availableProductivity;
            if (eq.availableProductivity > 0 && gap / eq.availableProductivity < -0.15) {
                alerts.push({ type:'resource', severity:'warning', title:`Productivity Gap: ${eq.name}`, message:`Actual ${avgActual.toFixed(0)} vs Available ${eq.availableProductivity} ‚Äî ${Math.abs(Math.round(gap/eq.availableProductivity*100))}% below plan for 3 days`, actionLabel:'View Productivity Gap', actionTab:'Resources' });
            }
        }
    });

    // DATA QUALITY ALERTS
    const tcsList = (data.boq||{}).tcsList || [];
    const noLayers = tcsList.filter(t => !(t.pavementLayers||[]).length);
    if (noLayers.length) {
        alerts.push({ type:'data_quality', severity:'warning', title:`${noLayers.length} TCS type(s) missing pavement layers`, message:`TCS without layers will use fallback L/100 duration formula ‚Äî less accurate`, actionLabel:'Go to TCS & Sections', actionTab:'TCS & Sections' });
    }

    // Missing equipment
    const requiredEq = new Set();
    tcsList.forEach(t => (t.pavementLayers||[]).forEach(l => {
        (typeof l.requiredEquipmentTypes==='string' ? l.requiredEquipmentTypes.split(',') : l.requiredEquipmentTypes||[]).forEach(e=>requiredEq.add(e.trim()));
    }));
    const eqNames = eqList.map(e=>(e.name||'').toLowerCase());
    const missingEq = [...requiredEq].filter(req => !eqNames.some(n=>n.toLowerCase().includes(req.toLowerCase())||req.toLowerCase().includes(n)));
    if (missingEq.length) {
        alerts.push({ type:'data_quality', severity:'warning', title:`${missingEq.length} equipment type(s) not in Resources`, message:`Required by TCS layers: ${missingEq.slice(0,3).join(', ')}`, actionLabel:'Go to Resources', actionTab:'Resources' });
    }

    // No baseline
    if (!bl) {
        alerts.push({ type:'data_quality', severity:'info', title:'No baseline frozen', message:'Freeze a baseline to enable progress variance tracking and scenario comparison', actionLabel:'Go to Baseline', actionTab:'Baseline' });
    }

    // Store and render
    KALYANTRA.computed.alerts = alerts;
    KALYANTRA.data.alerts = alerts;  // FIX: sync to data.alerts for renderAlertsTab
    renderAlerts(alerts);
    updateAlertBadge(alerts.filter(a=>!a.dismissed).length);
    return alerts;
}

function renderAlerts(alerts) {
    const container = document.getElementById('alertsContainer');
    const countBadge = document.getElementById('alertsCountBadge');
    if (!container) return;

    const active = alerts.filter(a => !a.dismissed);
    if (countBadge) {
        countBadge.textContent = active.length + ' active';
        countBadge.style.background = active.length > 0 ? '#fef2f2' : '#f0fdf4';
        countBadge.style.color = active.length > 0 ? '#dc2626' : '#16a34a';
    }

    if (!active.length) {
        container.innerHTML = `<div style="text-align:center;padding:40px;color:#94a3b8;">
            <div style="font-size:2rem;margin-bottom:8px;">‚úÖ</div>
            <div style="font-weight:600;margin-bottom:6px;">All clear</div>
            <div style="font-size:0.82rem;">No active alerts. System is in good health.</div>
        </div>`;
        return;
    }

    const SEVERITY_STYLES = {
        critical: { bg:'#fef2f2', border:'#dc2626', icon:'üî¥', textColor:'#991b1b' },
        warning:  { bg:'#fff7ed', border:'#f59e0b', icon:'üü°', textColor:'#92400e' },
        info:     { bg:'#eff6ff', border:'#3b82f6', icon:'‚ÑπÔ∏è',  textColor:'#1e40af' },
    };

    container.innerHTML = active.map((alert, i) => {
        const st = SEVERITY_STYLES[alert.severity] || SEVERITY_STYLES.info;
        return `<div style="background:${st.bg};border:1px solid ${st.border};border-radius:8px;padding:14px 16px;display:flex;gap:12px;align-items:flex-start;" id="alert_${i}">
            <span style="font-size:1.2rem;flex-shrink:0;margin-top:2px;">${st.icon}</span>
            <div style="flex:1;">
                <div style="font-weight:700;font-size:0.86rem;color:${st.textColor};margin-bottom:4px;">${alert.title}</div>
                <div style="font-size:0.78rem;color:#374151;margin-bottom:8px;">${alert.message}</div>
                <div style="display:flex;gap:8px;">
                    <span style="font-size:0.68rem;background:rgba(0,0,0,0.06);padding:2px 8px;border-radius:10px;color:#64748b;font-weight:600;text-transform:uppercase;">${alert.type.replace('_',' ')}</span>
                    <button onclick="sidebarSwitchTab(${getTabIndexByLabel(alert.actionTab)},document.querySelector('[data-label=\\'${alert.actionTab}\\']'))" style="font-size:0.74rem;background:none;border:none;color:#1B3B6F;cursor:pointer;font-weight:600;text-decoration:underline;">${alert.actionLabel} ‚Üí</button>
                </div>
            </div>
            <button onclick="dismissAlert(${i})" style="padding:3px 7px;background:rgba(0,0,0,0.06);color:#64748b;border:none;border-radius:4px;font-size:0.76rem;cursor:pointer;flex-shrink:0;">‚úì</button>
        </div>`;
    }).join('');
}

function getTabIndexByLabel(label) {
    const TAB_LABELS_MAP = {
        'Project Basics':0,'TCS & Sections':1,'Structures':2,'Hindrances':3,
        'Calendar':4,'Resources':5,'BOQ':6,'Activity Grid':7,'Executive Dashboard':8,
        'Progress Tracking':9,'Reports & Analytics':10,'Constraints':11,
        'Baseline':12,'Scenarios':13,'Alerts':14
    };
    return TAB_LABELS_MAP[label] ?? 0;
}

function dismissAlert(idx) {
    const alerts = KALYANTRA.computed.alerts || [];
    const active = alerts.filter(a=>!a.dismissed);
    if (active[idx]) active[idx].dismissed = true;
    renderAlerts(alerts);
    updateAlertBadge(alerts.filter(a=>!a.dismissed).length);
}

function dismissAllAlerts() {
    (KALYANTRA.computed.alerts||[]).forEach(a => a.dismissed = true);
    renderAlerts(KALYANTRA.computed.alerts||[]);
    updateAlertBadge(0);
}

function updateAlertBadge(count) {
    const badge = document.getElementById('alertBadge');
    if (!badge) return;
    if (count > 0) { badge.style.display = 'inline'; badge.textContent = count; }
    else badge.style.display = 'none';
}

// ‚îÄ‚îÄ‚îÄ AUTO-INIT HOOKS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function patchSwitchMainTabForNew() {
    const _orig = window.switchMainTab;
    if (typeof _orig !== 'function') { setTimeout(patchSwitchMainTabForNew, 300); return; }
    window.switchMainTab = function(idx) {
        _orig(idx);
        setTimeout(() => {
            if (idx === 9)  { initProgressTab(); }
            if (idx === 12) { renderBaselineTab(); }
            if (idx === 13) { initScenariosTab(); }
            if (idx === 14) { computeAllAlerts(); }
            if (idx === 8)  { computeAndDisplayHealth(); }
        }, 60);
    };
})();

// Patch sidebarSwitchTab similarly
(function patchSidebarForNew() {
    const _orig = window.sidebarSwitchTab;
    if (typeof _orig !== 'function') { setTimeout(patchSidebarForNew, 300); return; }
    window.sidebarSwitchTab = function(idx, el) {
        _orig(idx, el);
        setTimeout(() => {
            if (idx === 9)  initProgressTab();
            if (idx === 12) renderBaselineTab();
            if (idx === 13) initScenariosTab();
            if (idx === 14) computeAllAlerts();
            if (idx === 8)  computeAndDisplayHealth();
        }, 60);
    };
})();

// Run alerts on load (after data ready)
window.addEventListener('load', () => {
    setTimeout(() => {
        computeAllAlerts();
        // Load baseline from KALYANTRA.data if it exists
        if (KALYANTRA.data?.baseline) renderBaselineTab();
        // Kick health score computation
        if (KALYANTRA.computed) computeAndDisplayHealth();
    }, 2000);
});

console.log('‚úÖ KALYANTRA V9 Sessions 4+5+6 ‚Äî Baseline ¬∑ Progress ¬∑ Scenarios ¬∑ Alerts ¬∑ Health loaded');

</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KALYANTRA V9 ‚Äî SESSIONS 4-6 WIRING LAYER
// Connects all existing engines to UI render functions
// renderBaselineInfo, updateHealthGauge, renderDashboard,
// renderAlertsTab, promoteScenariosToBaseline
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ BASELINE MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderBaselineInfo() {
    const bl = KALYANTRA.data.baseline;
    const badge = document.getElementById('baselineStatusBadge');
    const emptyState = document.getElementById('baselineEmptyState');
    const frozenInfo = document.getElementById('baselineFrozenInfo');
    const freezeBtn = document.getElementById('freezeBaselineBtn');

    if (!bl) {
        if (badge) { badge.textContent = 'No baseline frozen'; badge.style.background='#f1f5f9'; badge.style.color='#64748b'; }
        if (emptyState) emptyState.style.display = 'block';
        if (frozenInfo) frozenInfo.style.display = 'none';
        if (freezeBtn) freezeBtn.style.display = 'inline-block';
        document.getElementById('materialDemandSection') && (document.getElementById('materialDemandSection').style.display='none');
        document.getElementById('baselineWBSSection') && (document.getElementById('baselineWBSSection').style.display='none');
        return;
    }

    // Baseline is frozen
    if (badge) { badge.textContent = 'üîí Baseline Frozen'; badge.style.background='#dcfce7'; badge.style.color='#15803d'; }
    if (emptyState) emptyState.style.display = 'none';
    if (frozenInfo) frozenInfo.style.display = 'block';
    if (freezeBtn) freezeBtn.style.display = 'none';

    // Fill KPI cards
    const setText = (id, val) => { const el=document.getElementById(id); if(el) el.textContent=val; };
    setText('blFrozenDate', bl.frozenAt || '‚Äî');
    setText('blCompletionDate', bl.completionDate || '‚Äî');
    setText('blActivityCount', bl.totalActivities || '‚Äî');
    setText('blTotalDays', bl.totalWorkingDays ? bl.totalWorkingDays + ' days' : '‚Äî');

    // Material demand table
    renderMaterialDemandTable(bl);

    // Baseline WBS table
    renderBaselineWBSTable(bl);
}

function renderMaterialDemandTable(bl) {
    const section = document.getElementById('materialDemandSection');
    const container = document.getElementById('materialDemandTable');
    if (!section || !container) return;

    const plan = bl.materialPlan || {};
    const months = Object.keys(plan);
    if (!months.length) { section.style.display='none'; return; }

    section.style.display = 'block';
    const materials = new Set();
    months.forEach(m => Object.keys(plan[m]).forEach(mat => materials.add(mat)));
    const matList = [...materials];

    const thead = `<tr style="background:#1B3B6F;color:white;">
        <th style="padding:8px 12px;text-align:left;min-width:160px;">Month</th>
        ${matList.map(m=>`<th style="padding:8px 10px;text-align:center;min-width:120px;">${m}<br><span style="font-size:0.68rem;opacity:0.75;">m¬≥ / MT</span></th>`).join('')}
    </tr>`;

    const tbody = months.sort().map(mo => {
        const cells = matList.map(mat => {
            const qty = plan[mo][mat];
            if (!qty) return `<td style="padding:7px 10px;text-align:center;color:#94a3b8;">‚Äî</td>`;
            const volStr = qty.volumeM3 ? Math.round(qty.volumeM3).toLocaleString() + ' m¬≥' : '';
            const wtStr  = qty.weightMT  ? Math.round(qty.weightMT).toLocaleString() + ' MT'  : '';
            return `<td style="padding:7px 10px;text-align:center;font-size:0.78rem;">
                <div style="font-weight:600;color:#1B3B6F;">${volStr}</div>
                ${wtStr ? `<div style="color:#64748b;font-size:0.72rem;">${wtStr}</div>` : ''}
            </td>`;
        }).join('');
        const d = new Date(mo+'-01');
        const label = d.toLocaleDateString('en-IN',{month:'short',year:'numeric'});
        return `<tr style="border-bottom:1px solid #f1f5f9;"><td style="padding:7px 12px;font-weight:600;font-size:0.8rem;">${label}</td>${cells}</tr>`;
    }).join('');

    container.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:0.8rem;"><thead>${thead}</thead><tbody>${tbody}</tbody></table>`;
}

function renderBaselineWBSTable(bl) {
    const section = document.getElementById('baselineWBSSection');
    const container = document.getElementById('baselineWBSTable');
    if (!section || !container) return;
    const snapshot = bl.wbsSnapshot || [];
    if (!snapshot.length) { section.style.display='none'; return; }

    section.style.display = 'block';
    const rows = snapshot.flatMap(stretch =>
        (stretch.activities || []).map((act, i) => `
            <tr style="border-bottom:1px solid #f1f5f9;${i===0?'background:#f8fafc;':''}">
                ${i===0 ? `<td style="padding:7px 10px;font-weight:700;color:#1B3B6F;font-size:0.78rem;" rowspan="${stretch.activities.length}">${stretch.stretchLabel||stretch.stretchId}</td>` : ''}
                <td style="padding:7px 10px;font-size:0.78rem;">${act.name}</td>
                <td style="padding:7px 10px;text-align:center;font-size:0.78rem;">${act.startDate||'‚Äî'}</td>
                <td style="padding:7px 10px;text-align:center;font-size:0.78rem;">${act.endDate||'‚Äî'}</td>
                <td style="padding:7px 10px;text-align:center;font-size:0.78rem;font-weight:600;">${act.workingDays||'‚Äî'} days</td>
                <td style="padding:7px 10px;text-align:center;font-size:0.78rem;">${act.shift||'single'}</td>
                <td style="padding:7px 10px;font-size:0.76rem;color:#64748b;">${act.bottleneckResource||'‚Äî'}</td>
            </tr>`)
    ).join('');

    container.innerHTML = `<table style="width:100%;border-collapse:collapse;">
        <thead><tr style="background:#1B3B6F;color:white;">
            <th style="padding:8px 10px;text-align:left;">Stretch</th>
            <th style="padding:8px 10px;text-align:left;">Activity</th>
            <th style="padding:8px 10px;text-align:center;">Start</th>
            <th style="padding:8px 10px;text-align:center;">Finish</th>
            <th style="padding:8px 10px;text-align:center;">Duration</th>
            <th style="padding:8px 10px;text-align:center;">Shift</th>
            <th style="padding:8px 10px;text-align:left;">Bottleneck</th>
        </tr></thead>
        <tbody>${rows}</tbody>
    </table>`;
}

// Auto-show baseline info when tab opens
(function patchSwitchForBaseline() {
    const _orig = window.switchMainTab;
    if (typeof _orig !== 'function') { setTimeout(patchSwitchForBaseline, 300); return; }
    const _patched = window.switchMainTab;
    window.switchMainTab = function(idx) {
        _patched(idx);
        if (idx === 12) setTimeout(renderBaselineInfo, 50);   // Baseline tab
        if (idx === 14) { setTimeout(computeAllAlerts, 50); setTimeout(renderAlertsTab, 150); } // Alerts tab
        if (idx === 8)  setTimeout(renderDashboard, 50);       // Executive Dashboard (tab9 = index 8)
    };
})();

// ‚îÄ‚îÄ HEALTH SCORE GAUGE RENDERER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateHealthGauge(score, components) {
    const canvas = document.getElementById('healthGauge');
    if (!canvas || !canvas.getContext) return;
    const ctx = canvas.getContext('2d');
    const W = canvas.width || 160, H = canvas.height || 160;
    const cx = W / 2, cy = H / 2;
    const r = W * 0.36, lw = 16;
    ctx.clearRect(0, 0, W, H);

    // Color by score
    const color = score >= 80 ? '#16a34a' : score >= 60 ? '#f59e0b' : '#dc2626';
    const pct = Math.max(0, Math.min(1, (score || 0) / 100));

    // Full background ring
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, 2 * Math.PI);
    ctx.strokeStyle = '#e2e8f0';
    ctx.lineWidth = lw;
    ctx.stroke();

    // Score arc (starts at -90¬∞ = top, goes clockwise)
    if (pct > 0) {
        ctx.beginPath();
        ctx.arc(cx, cy, r, -Math.PI / 2, -Math.PI / 2 + pct * 2 * Math.PI);
        ctx.strokeStyle = color;
        ctx.lineWidth = lw;
        ctx.lineCap = 'round';
        ctx.stroke();
    }

    // Score text in center
    ctx.fillStyle = '#1B3B6F';
    ctx.font = 'bold ' + Math.round(W * 0.22) + 'px system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(Math.round(score || 0), cx, cy - 6);

    // /100 subtext
    ctx.fillStyle = '#94a3b8';
    ctx.font = Math.round(W * 0.1) + 'px system-ui, sans-serif';
    ctx.fillText('/100', cx, cy + W * 0.14);
}

// ‚îÄ‚îÄ DASHBOARD RENDER (wires computeHealthScore into render.dashboard) ‚îÄ‚îÄ
function renderDashboard() {
    if (KALYANTRA.render && KALYANTRA.render.dashboard) {
        KALYANTRA.render.dashboard();
    }
    // Now add health score
    try {
        const result = computeHealthScore();
        if (result) updateHealthGauge(result.overall, result.components);
    } catch(e) {
        console.warn('Health score compute error:', e);
    }
    // Run alerts in background
    try { computeAllAlerts(); } catch(e) {}
}

// Patch KALYANTRA.render.dashboard to always include health score
(function patchRenderDashboard() {
    if (!KALYANTRA || !KALYANTRA.render || !KALYANTRA.render.dashboard) {
        setTimeout(patchRenderDashboard, 400); return;
    }
    const _origDash = KALYANTRA.render.dashboard;
    KALYANTRA.render.dashboard = function() {
        _origDash.call(this);
        try {
            const result = computeHealthScore();
            if (result) updateHealthGauge(result.overall, result.components);
        } catch(e) {}
    };
    console.log('‚úÖ render.dashboard patched with health score');
})();

// ‚îÄ‚îÄ ALERTS RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAlertsTab() {
    const container = document.getElementById('alertsContainer');
    const badge = document.getElementById('alertsCountBadge');
    if (!container) return;

    const alerts = KALYANTRA.data.alerts || [];
    const active = alerts.filter(a => !a.dismissed);

    if (badge) {
        badge.textContent = active.length + ' active';
        badge.style.background = active.length === 0 ? '#f1f5f9' : active.some(a=>a.severity==='critical') ? '#fee2e2' : '#fef3c7';
        badge.style.color = active.length === 0 ? '#64748b' : active.some(a=>a.severity==='critical') ? '#dc2626' : '#92400e';
    }

    if (!active.length) {
        container.innerHTML = `<div style="text-align:center;padding:40px;color:#94a3b8;">
            <div style="font-size:2rem;margin-bottom:8px;">‚úÖ</div>
            <div style="font-weight:600;margin-bottom:6px;">No active alerts</div>
            <div style="font-size:0.82rem;">Click Refresh Alerts to scan your project data.</div>
        </div>`;
        return;
    }

    const SEVERITY_STYLES = {
        critical: { bg:'#fef2f2', border:'#fecaca', icon:'üî¥', label:'CRITICAL', labelBg:'#fee2e2', labelColor:'#dc2626' },
        warning:  { bg:'#fffbeb', border:'#fde68a', icon:'üü°', label:'WARNING',  labelBg:'#fef3c7', labelColor:'#92400e' },
        info:     { bg:'#f0f9ff', border:'#bae6fd', icon:'üîµ', label:'INFO',     labelBg:'#e0f2fe', labelColor:'#0369a1' }
    };

    const TYPE_ICONS = { schedule:'üìÖ', resource:'üë∑', material:'üì¶', data_quality:'üìã' };

    container.innerHTML = active.map(alert => {
        const sty = SEVERITY_STYLES[alert.severity] || SEVERITY_STYLES.info;
        const typeIcon = TYPE_ICONS[alert.type] || 'üîî';
        return `<div style="background:${sty.bg};border:1px solid ${sty.border};border-radius:8px;padding:14px 16px;display:flex;gap:14px;align-items:flex-start;" id="alert_${alert.id}">
            <div style="font-size:1.4rem;flex-shrink:0;">${sty.icon}</div>
            <div style="flex:1;min-width:0;">
                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:4px;">
                    <span style="font-size:0.68rem;font-weight:800;text-transform:uppercase;padding:2px 7px;border-radius:10px;background:${sty.labelBg};color:${sty.labelColor};">${sty.label}</span>
                    <span style="font-size:0.68rem;font-weight:700;color:#64748b;text-transform:uppercase;">${typeIcon} ${(alert.type||'').replace('_',' ')}</span>
                </div>
                <div style="font-weight:700;color:#1B3B6F;font-size:0.88rem;margin-bottom:3px;">${alert.title}</div>
                <div style="font-size:0.8rem;color:#374151;margin-bottom:4px;">${alert.message}</div>
                ${alert.detail ? `<div style="font-size:0.76rem;color:#64748b;">${alert.detail}</div>` : ''}
                <div style="margin-top:8px;display:flex;gap:8px;align-items:center;">
                    ${alert.actionLabel ? `<button onclick="dismissAlert('${alert.id}');switchMainTab && alert.actionTabIdx!=null && switchMainTab(alert.actionTabIdx)" style="padding:4px 12px;background:#1B3B6F;color:white;border:none;border-radius:4px;font-size:0.76rem;cursor:pointer;font-weight:600;">${alert.actionLabel} ‚Üí</button>` : ''}
                    <button onclick="dismissAlert('${alert.id}')" style="padding:4px 10px;background:transparent;color:#94a3b8;border:1px solid #e2e8f0;border-radius:4px;font-size:0.74rem;cursor:pointer;">Dismiss</button>
                    <span style="font-size:0.7rem;color:#94a3b8;margin-left:auto;">${alert.triggeredAt||''}</span>
                </div>
            </div>
        </div>`;
    }).join('');
}

function dismissAlert(id) {
    const alerts = KALYANTRA.data.alerts || [];
    const a = alerts.find(a => a.id === id);
    if (a) { a.dismissed = true; renderAlertsTab(); }
}

// Patch computeAllAlerts to store to data and render
(function patchComputeAllAlerts() {
    const _origAlerts = window.computeAllAlerts;
    if (typeof _origAlerts !== 'function') { setTimeout(patchComputeAllAlerts, 300); return; }
    window.computeAllAlerts = function() {
        const alerts = _origAlerts();
        if (Array.isArray(alerts)) {
            // Preserve dismissed state
            const existing = KALYANTRA.data.alerts || [];
            const dismissedIds = new Set(existing.filter(a=>a.dismissed).map(a=>a.id));
            alerts.forEach((a, i) => {
                a.id = a.id || ('alert_' + Date.now() + '_' + i);
                if (dismissedIds.has(a.id)) a.dismissed = true;
            });
            KALYANTRA.data.alerts = alerts;
            // Update badge
            const active = alerts.filter(a=>!a.dismissed).length;
            const badge = document.getElementById('alertsCountBadge');
            if (badge) {
                badge.textContent = active + ' active';
                badge.style.background = active === 0 ? '#f1f5f9' : alerts.filter(a=>!a.dismissed&&a.severity==='critical').length ? '#fee2e2' : '#fef3c7';
                badge.style.color = active === 0 ? '#64748b' : '#dc2626';
            }
            renderAlertsTab();
        }
        return alerts;
    };
})();

// ‚îÄ‚îÄ SCENARIOS: PROMOTE TO PLAN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function promoteScenariosToBaseline() {
    const result = KALYANTRA.computed.scenarioResult;
    if (!result) { showToast('Run a scenario first to see results', 'warning'); return; }

    if (!confirm(`Promote scenario results to the Active Plan?\n\nThis will update durations and estimated completion date.\nThe original baseline remains frozen for comparison.`)) return;

    // Apply scenario deltas to KALYANTRA.computed
    if (result.updatedWBS) {
        KALYANTRA.computed.wbs = result.updatedWBS;
    }

    // Update completion estimate
    if (result.completionDate) {
        if (!KALYANTRA.data.project) KALYANTRA.data.project = {};
        KALYANTRA.data.project.scenarioCompletionDate = result.completionDate;
        KALYANTRA.data.project.scenarioDaysSaved = result.daysSaved;
    }

    showToast(`‚úÖ Scenario promoted ‚Äî Estimated savings: ${result.daysSaved||0} days`, 'success');
    KALYANTRA.refresh && KALYANTRA.refresh();

    // Switch to Activity Grid to show updated schedule
    setTimeout(() => switchMainTab && switchMainTab(7), 1000);
}

// Wire Promote button in Scenarios tab
(function wirePromoteButton() {
    const promoteBtn = document.getElementById('promoteScenBtn');
    if (promoteBtn) promoteBtn.onclick = promoteScenariosToBaseline;
})();

// ‚îÄ‚îÄ FREEZE BASELINE ‚Äî patch to also call renderBaselineInfo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function patchFreezeBaseline() {
    const _orig = window.freezeBaseline;
    if (typeof _orig !== 'function') { setTimeout(patchFreezeBaseline, 300); return; }
    window.freezeBaseline = function() {
        _orig();
        setTimeout(() => {
            renderBaselineInfo();
            computeAllAlerts && computeAllAlerts();
        }, 500);
    };
})();

// ‚îÄ‚îÄ SIDEBAR ALERT BADGE UPDATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateSidebarAlertBadge() {
    const alerts = KALYANTRA.data.alerts || [];
    const critical = alerts.filter(a => !a.dismissed && a.severity === 'critical').length;
    // Find sidebar Alerts button and badge
    const sidebarBtns = document.querySelectorAll('.sidebar-btn, .nav-item');
    sidebarBtns.forEach(btn => {
        if (btn.textContent.includes('Alerts') || btn.getAttribute('onclick')?.includes('14')) {
            let badge = btn.querySelector('.alert-badge');
            if (critical > 0) {
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'alert-badge';
                    badge.style.cssText = 'background:#dc2626;color:white;border-radius:10px;padding:1px 6px;font-size:0.65rem;font-weight:700;margin-left:6px;';
                    btn.appendChild(badge);
                }
                badge.textContent = critical;
            } else if (badge) {
                badge.remove();
            }
        }
    });
}

// ‚îÄ‚îÄ AUTO-INIT: wire everything on DOMContentLoaded ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', function() {
    // If baseline tab is active, render it
    setTimeout(() => {
        const bl = KALYANTRA.data.baseline;
        if (bl) renderBaselineInfo();
        computeAllAlerts && computeAllAlerts();
        // Initial health score on dashboard if visible
        const dashTab = document.getElementById('tab9');
        if (dashTab && dashTab.style.display !== 'none') renderDashboard();
    }, 1500);
});

console.log('‚úÖ KALYANTRA V9 Sessions 4-6 ‚Äî Wiring layer loaded');

</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KALYANTRA V9 ‚Äî SESSION 7: PDF REPORTS + EOT DOCUMENTATION
// Real print/PDF via window.print() with @media print CSS
// Covers: Baseline report, EOT shift audit, Productivity gap
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ REAL exportBaselineReport ‚Äî replaces placeholder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportBaselineReport() {
    const bl = KALYANTRA.data.baseline;
    if (!bl) { showToast('‚ö†Ô∏è No baseline frozen yet', 'warning'); return; }

    const proj = KALYANTRA.data.project || {};
    const cal = KALYANTRA.data.calendar || {};
    const resources = KALYANTRA.data.resources || {};
    const eqList = resources.equipment || [];

    // Health score
    let healthHTML = '';
    try {
        const hs = computeHealthScore();
        if (hs) {
            const color = hs.overall >= 80 ? '#16a34a' : hs.overall >= 60 ? '#f59e0b' : '#dc2626';
            healthHTML = `<div style="display:inline-block;padding:8px 20px;background:${color};color:white;border-radius:6px;font-size:1.2rem;font-weight:700;">${hs.overall}/100</div>`;
        }
    } catch(e) {}

    // WBS table
    const snapshot = bl.wbsSnapshot || [];
    const wbsRows = snapshot.flatMap(stretch =>
        (stretch.activities || []).map((act, i) => `
            <tr style="${i===0?'background:#f8fafc;':''}">
                ${i===0 ? `<td style="padding:6px 8px;font-weight:700;font-size:0.78rem;color:#1B3B6F;" rowspan="${stretch.activities.length}">${stretch.stretchLabel||stretch.stretchId}</td>` : ''}
                <td style="padding:6px 8px;font-size:0.78rem;">${act.name}</td>
                <td style="padding:6px 8px;text-align:center;font-size:0.78rem;">${act.startDate||'‚Äî'}</td>
                <td style="padding:6px 8px;text-align:center;font-size:0.78rem;">${act.endDate||'‚Äî'}</td>
                <td style="padding:6px 8px;text-align:center;font-size:0.78rem;font-weight:600;">${act.workingDays||'‚Äî'}</td>
                <td style="padding:6px 8px;font-size:0.76rem;color:#64748b;">${act.bottleneckResource||'‚Äî'}</td>
            </tr>`)
    ).join('');

    // Resource productivity summary
    const resRows = eqList.filter(e=>e.name&&e.ratedProductivity>0).map(eq => {
        const shift = eq.shift || (cal.defaultShift || 'single');
        const hrs = { single:8, double:16, triple:24 }[shift] || 8;
        const daily = ((eq.availableProductivity||0) * hrs * (eq.unitsDeployed||1)).toFixed(1);
        const gap = eq.ratedProductivity > 0 ? Math.round((1 - eq.availableProductivity/eq.ratedProductivity)*100) : 0;
        return `<tr><td style="padding:6px 8px;">${eq.name}</td>
            <td style="text-align:center;padding:6px 8px;">${eq.ratedProductivity} ${eq.productivityUnit||''}</td>
            <td style="text-align:center;padding:6px 8px;">${eq.availableProductivity} ${eq.productivityUnit||''}</td>
            <td style="text-align:center;padding:6px 8px;">${gap > 0 ? gap+'%' : '‚Äî'}</td>
            <td style="text-align:center;padding:6px 8px;">${daily} ${(eq.productivityUnit||'').replace('/hr','')}/day</td>
        </tr>`;
    }).join('');

    // EOT shift audit trail
    const overrides = (cal.shiftOverrides || []);
    const REASON_LABELS = {
        monsoon_closure: 'Monsoon Window Closing', milestone_pressure: 'Milestone Deadline Pressure',
        resource_optimization: 'Resource Optimization', client_direction: 'Client / IE Direction',
        critical_path: 'Critical Path Acceleration', other: 'Other'
    };
    const eotRows = overrides.length ? overrides.map(ovr => `
        <tr>
            <td style="padding:6px 8px;font-size:0.78rem;">${ovr.activityRef || 'All Activities'}</td>
            <td style="text-align:center;padding:6px 8px;">${{single:'Single (8h)',double:'Double (16h)',triple:'Round Clock (24h)'}[ovr.shift]||ovr.shift}</td>
            <td style="padding:6px 8px;">${REASON_LABELS[ovr.reason]||ovr.reason}</td>
            <td style="padding:6px 8px;">${ovr.reasonNote||'‚Äî'}</td>
            <td style="text-align:center;padding:6px 8px;">${ovr.changedAt||'‚Äî'}</td>
        </tr>`) .join('')
        : '<tr><td colspan="5" style="padding:10px;text-align:center;color:#94a3b8;">No shift overrides recorded</td></tr>';

    const today = new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
    const printWindow = window.open('', '_blank', 'width=900,height=700');
    printWindow.document.write(`<!DOCTYPE html>
<html>
<head>
    <title>KALYANTRA Baseline Report ‚Äî ${proj.name||'Project'}</title>
    <style>
        @media print {
            @page { margin: 15mm; size: A4; }
            .no-print { display: none !important; }
            .page-break { page-break-before: always; }
        }
        body { font-family: Arial, sans-serif; font-size: 0.875rem; color: #1e293b; margin: 0; padding: 20px; }
        h1 { color: #1B3B6F; font-size: 1.4rem; margin: 0; }
        h2 { color: #1B3B6F; font-size: 1rem; border-bottom: 2px solid #1B3B6F; padding-bottom: 6px; margin: 24px 0 12px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 16px; }
        th { background: #1B3B6F; color: white; padding: 8px 10px; text-align: left; font-size: 0.8rem; }
        td { padding: 6px 8px; border-bottom: 1px solid #e2e8f0; font-size: 0.78rem; }
        tr:nth-child(even) { background: #f8fafc; }
        .kpi-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin-bottom: 20px; }
        .kpi { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 12px; text-align: center; }
        .kpi-label { font-size: 0.68rem; font-weight: 700; text-transform: uppercase; color: #64748b; }
        .kpi-value { font-size: 1.1rem; font-weight: 700; color: #1B3B6F; margin-top: 4px; }
        .cover { text-align: center; padding: 40px 0; border-bottom: 3px solid #D4AF37; margin-bottom: 30px; }
        .cover .subtitle { color: #64748b; font-size: 0.9rem; margin-top: 6px; }
        .gold { color: #D4AF37; }
        .print-btn { background: #1B3B6F; color: white; border: none; padding: 10px 24px; border-radius: 5px; font-size: 0.9rem; font-weight: 600; cursor: pointer; margin-bottom: 20px; }
    </style>
</head>
<body>
    <button class="print-btn no-print" onclick="window.print()">üñ®Ô∏è Print / Save as PDF</button>

    <!-- COVER PAGE -->
    <div class="cover">
        <div style="font-size:0.8rem;font-weight:800;text-transform:uppercase;letter-spacing:0.1em;color:#64748b;margin-bottom:8px;">KALYANTRA Infrastructure Project Management</div>
        <h1>${proj.name || 'Highway Project'}</h1>
        <div class="subtitle">${proj.packageName||''} | ${proj.totalLength||'‚Äî'} km | ${proj.contractType||''}</div>
        <div style="margin-top:20px;font-size:0.9rem;font-weight:700;color:#1B3B6F;">BASELINE SCHEDULE REPORT</div>
        <div style="margin-top:6px;color:#64748b;font-size:0.82rem;">Generated: ${today} | Baseline Frozen: ${bl.frozenAt||'‚Äî'}</div>
        <div style="margin-top:16px;">${healthHTML}</div>
    </div>

    <!-- KPI SUMMARY -->
    <h2>Project Summary</h2>
    <div class="kpi-grid">
        <div class="kpi"><div class="kpi-label">Contract Start</div><div class="kpi-value">${proj.startDate||'‚Äî'}</div></div>
        <div class="kpi"><div class="kpi-label">Planned Completion</div><div class="kpi-value">${bl.completionDate||'‚Äî'}</div></div>
        <div class="kpi"><div class="kpi-label">Total Activities</div><div class="kpi-value">${bl.totalActivities||'‚Äî'}</div></div>
        <div class="kpi"><div class="kpi-label">Default Shift</div><div class="kpi-value">${{single:'Single (8h)',double:'Double (16h)',triple:'24h RTC'}[cal.defaultShift]||'Single'}</div></div>
    </div>

    <!-- WBS BASELINE SCHEDULE -->
    <h2 class="page-break">Baseline Activity Schedule</h2>
    <table>
        <thead><tr><th>Stretch</th><th>Activity</th><th>Start</th><th>Finish</th><th>Days</th><th>Bottleneck Resource</th></tr></thead>
        <tbody>${wbsRows||'<tr><td colspan="6" style="text-align:center;">No WBS data in baseline</td></tr>'}</tbody>
    </table>

    <!-- RESOURCE PRODUCTIVITY -->
    <h2>Resource Productivity Summary</h2>
    <table>
        <thead><tr><th>Equipment</th><th>Rated /hr</th><th>Available /hr</th><th>Derating</th><th>Daily Output</th></tr></thead>
        <tbody>${resRows||'<tr><td colspan="5" style="text-align:center;">No equipment defined</td></tr>'}</tbody>
    </table>

    <!-- EOT AUDIT TRAIL -->
    <h2 class="page-break">Extension of Time (EOT) Shift Override Audit Trail</h2>
    <div style="font-size:0.78rem;color:#64748b;margin-bottom:10px;">All shift overrides recorded below. These serve as contemporaneous evidence for EOT claims under contract clauses.</div>
    <table>
        <thead><tr><th>Activity</th><th>Override Shift</th><th>Reason</th><th>Supporting Note</th><th>Recorded On</th></tr></thead>
        <tbody>${eotRows}</tbody>
    </table>

    <!-- FOOTER -->
    <div style="margin-top:30px;border-top:2px solid #e2e8f0;padding-top:12px;display:flex;justify-content:space-between;font-size:0.72rem;color:#94a3b8;">
        <span>KALYANTRA ‚Äî Infrastructure Project Management System</span>
        <span>Confidential | ${proj.name||'Project'} | Generated ${today}</span>
    </div>
</body>
</html>`);
    printWindow.document.close();
}

// ‚îÄ‚îÄ PRODUCTIVITY GAP REPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportProductivityGapReport() {
    const resources = KALYANTRA.data.resources || {};
    const eqList = resources.equipment || [];
    const cal = KALYANTRA.data.calendar || {};
    const progress = KALYANTRA.data.progress || {};
    const history = progress.productivityHistory || {};

    const rows = eqList.filter(e=>e.name&&e.ratedProductivity>0).map(eq => {
        const hist = history[eq.name] || [];
        const actual = hist.length ? hist[hist.length-1].actual : null;
        const shift = eq.shift || cal.defaultShift || 'single';
        const hrs = {single:8,double:16,triple:24}[shift]||8;
        const daily = ((eq.availableProductivity||0)*hrs*(eq.unitsDeployed||1)).toFixed(1);
        const gap = actual != null ? (actual - eq.availableProductivity).toFixed(1) : null;
        const statusColor = gap == null ? '#94a3b8' : parseFloat(gap) < -10 ? '#dc2626' : parseFloat(gap) < 0 ? '#f59e0b' : '#16a34a';
        return `<tr>
            <td style="padding:6px 8px;font-weight:600;">${eq.name}</td>
            <td style="text-align:center;">${eq.ratedProductivity}</td>
            <td style="text-align:center;">${eq.availableProductivity}</td>
            <td style="text-align:center;">${actual != null ? actual : '‚Äî'}</td>
            <td style="text-align:center;font-weight:700;color:${statusColor};">${gap != null ? (parseFloat(gap)>0?'+':'')+gap : '‚Äî'}</td>
            <td style="text-align:center;">${(eq.productivityUnit||'').replace('/hr','')}/day √ó ${eq.unitsDeployed||1} = ${daily}</td>
        </tr>`;
    }).join('');

    const today = new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
    const pw = window.open('','_blank','width=800,height=500');
    pw.document.write(`<!DOCTYPE html><html><head><title>Productivity Gap Report</title>
    <style>body{font-family:Arial,sans-serif;font-size:0.875rem;padding:24px;} th{background:#1B3B6F;color:white;padding:8px;} td{padding:6px 8px;border-bottom:1px solid #e2e8f0;} table{width:100%;border-collapse:collapse;} .btn{background:#1B3B6F;color:white;border:none;padding:8px 20px;border-radius:4px;cursor:pointer;margin-bottom:16px;}</style></head>
    <body>
    <button class="btn" onclick="window.print()">üñ®Ô∏è Print</button>
    <h2 style="color:#1B3B6F;border-bottom:2px solid #D4AF37;padding-bottom:6px;">Productivity Gap Report ‚Äî ${today}</h2>
    <p style="font-size:0.8rem;color:#64748b;">Rated = manufacturer spec | Available = planner-derated | Actual = recorded in Progress Tracking | Gap = Actual ‚àí Available</p>
    <table><thead><tr><th>Equipment</th><th>Rated /hr</th><th>Available /hr</th><th>Actual /hr</th><th>Gap</th><th>Daily Output</th></tr></thead>
    <tbody>${rows||'<tr><td colspan="6" style="text-align:center;">No equipment data</td></tr>'}</tbody></table>
    </body></html>`);
    pw.document.close();
}

// ‚îÄ‚îÄ WIRE REPORT BUTTONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Replace placeholder exportBaselineReport and add productivity gap button
// The Reports tab has a "generate" button for EOT report ‚Äî wire it
document.addEventListener('DOMContentLoaded', function() {
    // Wire EOT Report button if present
    const eotBtn = document.getElementById('eotReportBtn');
    if (eotBtn) eotBtn.onclick = exportBaselineReport;
    // Wire Productivity Gap export button if present  
    const gapBtn = document.getElementById('gapReportBtn');
    if (gapBtn) gapBtn.onclick = exportProductivityGapReport;
});

console.log('‚úÖ KALYANTRA V9 Session 7 ‚Äî PDF Reports + EOT loaded');

</script>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                 TAB: EARNED VALUE (index 15)
                 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="tab-panel" id="tabEarnedValue">
                <div class="tabular-container">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <h3 style="margin:0;color:#1B3B6F;">üìà Earned Value Analysis</h3>
                            <span id="evStatusBadge" style="margin-left:14px;font-size:0.78rem;padding:3px 10px;border-radius:12px;background:#f1f5f9;color:#64748b;font-weight:600;">Requires frozen baseline</span>
                        </div>
                        <div class="toolbar-right">
                            <select id="evPeriodSelect" onchange="renderEarnedValueTab()" style="padding:5px 10px;border:1px solid #e2e8f0;border-radius:5px;font-size:0.8rem;margin-right:8px;">
                                <option value="today">As of Today</option>
                                <option value="last_month">End of Last Month</option>
                                <option value="last_quarter">End of Last Quarter</option>
                            </select>
                            <button onclick="exportEVReport()" style="padding:6px 14px;background:#1B3B6F;color:white;border:none;border-radius:5px;font-size:0.78rem;font-weight:600;cursor:pointer;">üìÑ Export EV Report</button>
                        </div>
                    </div>
                    <div style="flex:1;overflow-y:auto;padding:20px 24px;display:flex;flex-direction:column;gap:16px;">

                        <!-- EV KPI Cards -->
                        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;" id="evKPIGrid">
                            <!-- BCWS -->
                            <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:16px;border-left:4px solid #3b82f6;">
                                <div style="font-size:0.68rem;font-weight:800;text-transform:uppercase;color:#3b82f6;margin-bottom:6px;">BCWS ‚Äî Planned Value</div>
                                <div id="ev_bcws" style="font-size:1.4rem;font-weight:700;color:#1B3B6F;">‚Äî</div>
                                <div style="font-size:0.72rem;color:#64748b;margin-top:3px;">Budget Cost of Work Scheduled</div>
                            </div>
                            <!-- BCWP -->
                            <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:16px;border-left:4px solid #16a34a;">
                                <div style="font-size:0.68rem;font-weight:800;text-transform:uppercase;color:#16a34a;margin-bottom:6px;">BCWP ‚Äî Earned Value</div>
                                <div id="ev_bcwp" style="font-size:1.4rem;font-weight:700;color:#1B3B6F;">‚Äî</div>
                                <div style="font-size:0.72rem;color:#64748b;margin-top:3px;">Budget Cost of Work Performed</div>
                            </div>
                            <!-- ACWP -->
                            <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:16px;border-left:4px solid #f59e0b;">
                                <div style="font-size:0.68rem;font-weight:800;text-transform:uppercase;color:#f59e0b;margin-bottom:6px;">ACWP ‚Äî Actual Cost</div>
                                <div id="ev_acwp" style="font-size:1.4rem;font-weight:700;color:#1B3B6F;">‚Äî</div>
                                <div style="font-size:0.72rem;color:#64748b;margin-top:3px;">Enter in Progress Tracking</div>
                            </div>
                            <!-- BAC -->
                            <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:16px;border-left:4px solid #8b5cf6;">
                                <div style="font-size:0.68rem;font-weight:800;text-transform:uppercase;color:#8b5cf6;margin-bottom:6px;">BAC ‚Äî Budget at Completion</div>
                                <div id="ev_bac" style="font-size:1.4rem;font-weight:700;color:#1B3B6F;">‚Äî</div>
                                <div style="font-size:0.72rem;color:#64748b;margin-top:3px;">Total contract value</div>
                            </div>
                        </div>

                        <!-- SPI / CPI / SV / CV row -->
                        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;">
                            <!-- SPI -->
                            <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:16px;text-align:center;">
                                <div style="font-size:0.68rem;font-weight:800;text-transform:uppercase;color:#64748b;margin-bottom:6px;">Schedule Performance Index</div>
                                <div id="ev_spi" style="font-size:2rem;font-weight:700;color:#1B3B6F;">‚Äî</div>
                                <div id="ev_spi_label" style="font-size:0.75rem;margin-top:4px;font-weight:600;color:#64748b;">SPI = BCWP / BCWS</div>
                                <div style="margin-top:8px;background:#f1f5f9;border-radius:20px;height:8px;overflow:hidden;">
                                    <div id="ev_spi_bar" style="height:100%;background:#16a34a;transition:width 0.5s;width:0%;"></div>
                                </div>
                            </div>
                            <!-- CPI -->
                            <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:16px;text-align:center;">
                                <div style="font-size:0.68rem;font-weight:800;text-transform:uppercase;color:#64748b;margin-bottom:6px;">Cost Performance Index</div>
                                <div id="ev_cpi" style="font-size:2rem;font-weight:700;color:#1B3B6F;">‚Äî</div>
                                <div id="ev_cpi_label" style="font-size:0.75rem;margin-top:4px;font-weight:600;color:#64748b;">CPI = BCWP / ACWP</div>
                                <div style="margin-top:8px;background:#f1f5f9;border-radius:20px;height:8px;overflow:hidden;">
                                    <div id="ev_cpi_bar" style="height:100%;background:#16a34a;transition:width 0.5s;width:0%;"></div>
                                </div>
                            </div>
                            <!-- SV -->
                            <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:16px;text-align:center;">
                                <div style="font-size:0.68rem;font-weight:800;text-transform:uppercase;color:#64748b;margin-bottom:6px;">Schedule Variance</div>
                                <div id="ev_sv" style="font-size:2rem;font-weight:700;color:#1B3B6F;">‚Äî</div>
                                <div style="font-size:0.72rem;color:#64748b;margin-top:4px;">SV = BCWP ‚àí BCWS</div>
                                <div id="ev_sv_label" style="font-size:0.75rem;margin-top:4px;font-weight:600;color:#64748b;">‚Äî</div>
                            </div>
                            <!-- CV -->
                            <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:16px;text-align:center;">
                                <div style="font-size:0.68rem;font-weight:800;text-transform:uppercase;color:#64748b;margin-bottom:6px;">Cost Variance</div>
                                <div id="ev_cv" style="font-size:2rem;font-weight:700;color:#1B3B6F;">‚Äî</div>
                                <div style="font-size:0.72rem;color:#64748b;margin-top:4px;">CV = BCWP ‚àí ACWP</div>
                                <div id="ev_cv_label" style="font-size:0.75rem;margin-top:4px;font-weight:600;color:#64748b;">‚Äî</div>
                            </div>
                        </div>

                        <!-- Forecast row: EAC, ETC, TCPI, VAC -->
                        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;">
                            <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:14px;">
                                <div style="font-size:0.68rem;font-weight:800;color:#64748b;text-transform:uppercase;margin-bottom:6px;">EAC ‚Äî Estimate at Completion</div>
                                <div id="ev_eac" style="font-size:1.2rem;font-weight:700;color:#1B3B6F;">‚Äî</div>
                                <div style="font-size:0.7rem;color:#64748b;margin-top:3px;">BAC / CPI</div>
                            </div>
                            <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:14px;">
                                <div style="font-size:0.68rem;font-weight:800;color:#64748b;text-transform:uppercase;margin-bottom:6px;">ETC ‚Äî Estimate to Complete</div>
                                <div id="ev_etc" style="font-size:1.2rem;font-weight:700;color:#1B3B6F;">‚Äî</div>
                                <div style="font-size:0.7rem;color:#64748b;margin-top:3px;">EAC ‚àí ACWP</div>
                            </div>
                            <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:14px;">
                                <div style="font-size:0.68rem;font-weight:800;color:#64748b;text-transform:uppercase;margin-bottom:6px;">TCPI ‚Äî To-Complete PI</div>
                                <div id="ev_tcpi" style="font-size:1.2rem;font-weight:700;color:#1B3B6F;">‚Äî</div>
                                <div style="font-size:0.7rem;color:#64748b;margin-top:3px;">(BAC ‚àí BCWP) / (BAC ‚àí ACWP)</div>
                            </div>
                            <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:14px;">
                                <div style="font-size:0.68rem;font-weight:800;color:#64748b;text-transform:uppercase;margin-bottom:6px;">VAC ‚Äî Variance at Completion</div>
                                <div id="ev_vac" style="font-size:1.2rem;font-weight:700;color:#1B3B6F;">‚Äî</div>
                                <div style="font-size:0.7rem;color:#64748b;margin-top:3px;">BAC ‚àí EAC</div>
                            </div>
                        </div>

                        <!-- S-Curve Chart (BCWS vs BCWP vs ACWP) -->
                        <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden;">
                            <div style="background:#1B3B6F;color:white;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;">
                                <div style="font-weight:700;font-size:0.88rem;">üìâ S-Curve ‚Äî Planned vs Earned vs Actual</div>
                                <div style="display:flex;gap:16px;font-size:0.74rem;opacity:0.85;">
                                    <span style="display:flex;align-items:center;gap:5px;"><span style="display:inline-block;width:24px;height:3px;background:#3b82f6;border-radius:2px;"></span>BCWS (Planned)</span>
                                    <span style="display:flex;align-items:center;gap:5px;"><span style="display:inline-block;width:24px;height:3px;background:#16a34a;border-radius:2px;"></span>BCWP (Earned)</span>
                                    <span style="display:flex;align-items:center;gap:5px;"><span style="display:inline-block;width:24px;height:3px;background:#f59e0b;border-style:dashed;border-width:0 0 2px;"></span>ACWP (Actual)</span>
                                </div>
                            </div>
                            <div style="padding:16px;">
                                <canvas id="evSCurveCanvas" style="width:100%;height:280px;display:block;"></canvas>
                            </div>
                        </div>

                        <!-- Activity-level EV table -->
                        <div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden;">
                            <div style="background:#334155;color:white;padding:10px 16px;font-weight:700;font-size:0.86rem;">Activity-Level EV Summary</div>
                            <div style="overflow-x:auto;">
                                <table style="width:100%;border-collapse:collapse;font-size:0.78rem;">
                                    <thead>
                                        <tr style="background:#f8fafc;border-bottom:2px solid #e2e8f0;">
                                            <th style="padding:8px 10px;text-align:left;">Stretch</th>
                                            <th style="padding:8px 10px;text-align:left;">Activity</th>
                                            <th style="padding:8px 10px;text-align:center;">Planned %</th>
                                            <th style="padding:8px 10px;text-align:center;">Actual %</th>
                                            <th style="padding:8px 10px;text-align:center;">BCWS (‚Çπ)</th>
                                            <th style="padding:8px 10px;text-align:center;">BCWP (‚Çπ)</th>
                                            <th style="padding:8px 10px;text-align:center;">SPI</th>
                                            <th style="padding:8px 10px;text-align:center;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="evActivityTable"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- ACWP entry section -->
                        <div style="background:#fffbeb;border:1px solid #fde68a;border-radius:8px;padding:16px;">
                            <div style="font-weight:700;color:#92400e;margin-bottom:8px;font-size:0.86rem;">üí∞ Enter Actual Cost (ACWP)</div>
                            <div style="font-size:0.78rem;color:#64748b;margin-bottom:12px;">CPI requires actual expenditure data. Enter the cumulative cost incurred to date.</div>
                            <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;">
                                <div>
                                    <label style="font-size:0.74rem;font-weight:700;color:#374151;display:block;margin-bottom:4px;">ACWP ‚Äî Cumulative Cost to Date (‚Çπ Cr)</label>
                                    <input type="number" id="evACWPInput" min="0" step="0.01" placeholder="e.g. 45.50"
                                        onchange="updateACWP(this.value)"
                                        style="padding:7px 12px;border:1px solid #fcd34d;border-radius:5px;font-size:0.86rem;width:180px;" />
                                </div>
                                <div>
                                    <label style="font-size:0.74rem;font-weight:700;color:#374151;display:block;margin-bottom:4px;">As of Date</label>
                                    <input type="date" id="evACWPDate"
                                        style="padding:7px 12px;border:1px solid #fcd34d;border-radius:5px;font-size:0.86rem;" />
                                </div>
                                <button onclick="renderEarnedValueTab()" style="padding:7px 16px;background:#D4AF37;color:#1B3B6F;border:none;border-radius:5px;font-size:0.82rem;font-weight:700;cursor:pointer;">Recalculate EV</button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KALYANTRA V9 ‚Äî EARNED VALUE MODULE
// BCWS, BCWP, ACWP, SPI, CPI, SV, CV, EAC, ETC, TCPI, VAC
// S-curve from real baseline schedule + activity-level breakdown
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ CORE EV COMPUTATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function computeEarnedValue() {
    const bl  = KALYANTRA.data.baseline;
    const proj = KALYANTRA.data.project || {};
    const wbs  = KALYANTRA.computed.wbs || [];
    const BAC  = parseFloat(proj.budget) || 0;

    if (!bl) return null;

    // Cutoff date ‚Äî default today
    const acwpInput = document.getElementById('evACWPInput');
    const acwpDate  = document.getElementById('evACWPDate');
    const cutoff = acwpDate?.value ? new Date(acwpDate.value) : new Date();
    const todayStr = cutoff.toISOString().split('T')[0];

    const startDate = new Date(bl.startDate || proj.startDate || new Date());
    const endDate   = new Date(bl.completionDate || proj.endDate || new Date());
    const totalDays = Math.max(1, Math.round((endDate - startDate) / 86400000));
    const elapsedDays = Math.max(0, Math.min(totalDays, Math.round((cutoff - startDate) / 86400000)));
    const timeElapsedPct = elapsedDays / totalDays;

    // BCWS ‚Äî planned physical progress √ó BAC
    // Use baseline schedule to calculate what % should be done by cutoff
    const snapshot = bl.wbsSnapshot || [];
    let plannedWeightedSum = 0, totalWeight = 0;
    snapshot.forEach(stretch => {
        (stretch.activities || []).forEach(act => {
            const actStart = new Date(act.startDate);
            const actEnd   = new Date(act.endDate);
            const weight   = act.workingDays || 1;
            totalWeight += weight;
            if (cutoff >= actEnd) {
                plannedWeightedSum += weight * 100; // fully planned
            } else if (cutoff > actStart) {
                const actDuration = Math.max(1, Math.round((actEnd - actStart) / 86400000));
                const actElapsed  = Math.round((cutoff - actStart) / 86400000);
                plannedWeightedSum += weight * Math.min(100, (actElapsed / actDuration) * 100);
            }
        });
    });
    const plannedPhysicalPct = totalWeight > 0 ? plannedWeightedSum / totalWeight : timeElapsedPct * 100;
    const BCWS = BAC * (plannedPhysicalPct / 100);

    // BCWP ‚Äî actual physical progress √ó BAC
    const actualPct = KALYANTRA.computed.overallProgress || proj.physicalProgress || 0;
    const BCWP = BAC * (actualPct / 100);

    // ACWP ‚Äî from user input (‚Çπ Cr)
    const ACWP_Cr = parseFloat(acwpInput?.value || proj.actualCost || 0);
    const ACWP = ACWP_Cr * 10000000; // convert Cr to ‚Çπ (store BAC also in Cr √ó 1e7)
    const BAC_abs = BAC * 10000000;
    const BCWS_abs = BCWS * 10000000;
    const BCWP_abs = BCWP * 10000000;

    // Performance indices
    const SPI  = BCWS_abs > 0 ? BCWP_abs / BCWS_abs : null;
    const CPI  = ACWP    > 0 ? BCWP_abs / ACWP      : null;
    const SV   = BCWP_abs - BCWS_abs;
    const CV   = ACWP > 0 ? BCWP_abs - ACWP : null;

    // Forecasts
    const EAC  = CPI && CPI > 0 ? BAC_abs / CPI : BAC_abs;
    const ETC  = EAC - (ACWP || 0);
    const TCPI = (BAC_abs - BCWP_abs) > 0 && (BAC_abs - (ACWP||0)) > 0
                 ? (BAC_abs - BCWP_abs) / (BAC_abs - (ACWP||0)) : null;
    const VAC  = BAC_abs - EAC;

    // Monthly S-curve data points from baseline
    const months = buildMonthlyScurve(snapshot, startDate, endDate, BAC_abs, actualPct, ACWP);

    return {
        BCWS: BCWS_abs, BCWP: BCWP_abs, ACWP: ACWP || null, BAC: BAC_abs,
        SPI, CPI, SV, CV, EAC, ETC, TCPI, VAC,
        plannedPhysicalPct, actualPct,
        cutoffDate: todayStr, startDate: startDate.toISOString().split('T')[0],
        months, snapshot, timeElapsedPct
    };
}

function buildMonthlyScurve(snapshot, startDate, endDate, BAC, actualPct, ACWP) {
    // Build monthly cumulative BCWS and BCWP from baseline
    const months = [];
    const d = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
    const endM = new Date(endDate.getFullYear(), endDate.getMonth() + 1, 1);
    const today = new Date();

    while (d < endM) {
        const monthEnd = new Date(d.getFullYear(), d.getMonth() + 1, 0); // last day of month
        // BCWS: weight of activities planned complete by this month-end
        let weightDone = 0, totalWeight = 0;
        snapshot.forEach(stretch => {
            (stretch.activities || []).forEach(act => {
                const w = act.workingDays || 1;
                totalWeight += w;
                const actEnd = new Date(act.endDate);
                if (monthEnd >= actEnd) weightDone += w;
                else if (monthEnd > new Date(act.startDate)) {
                    const actDur = Math.max(1, (actEnd - new Date(act.startDate)) / 86400000);
                    const actEl = (monthEnd - new Date(act.startDate)) / 86400000;
                    weightDone += w * Math.min(1, actEl / actDur);
                }
            });
        });
        const bcwsPct = totalWeight > 0 ? weightDone / totalWeight : 0;
        const isPast = monthEnd <= today;

        months.push({
            label: d.toLocaleDateString('en-IN', { month: 'short', year: '2-digit' }),
            bcws: BAC * bcwsPct,
            // BCWP: interpolate actual progress linearly (simplified ‚Äî replace with recorded data later)
            bcwp: isPast ? BAC * (actualPct / 100) * Math.min(1, bcwsPct / Math.max(0.001, (today - startDate) / (endDate - startDate) * bcwsPct)) : null,
            acwp: isPast && ACWP ? ACWP * bcwsPct : null,
            isPast
        });
        d.setMonth(d.getMonth() + 1);
    }
    return months;
}

// ‚îÄ‚îÄ EV RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderEarnedValueTab() {
    const bl = KALYANTRA.data.baseline;
    const badge = document.getElementById('evStatusBadge');

    if (!bl) {
        if (badge) { badge.textContent = '‚ö†Ô∏è Freeze a baseline first'; badge.style.background='#fef2f2'; badge.style.color='#dc2626'; }
        return;
    }
    if (badge) { badge.textContent = `üì∏ Baseline: ${bl.frozenAt||'Frozen'}`; badge.style.background='#dcfce7'; badge.style.color='#15803d'; }

    const ev = computeEarnedValue();
    if (!ev) return;

    const fmt = (v, unit) => {
        if (v == null || isNaN(v)) return '‚Äî';
        if (unit === 'cr') return '‚Çπ ' + (v/10000000).toFixed(2) + ' Cr';
        if (unit === 'idx') return v.toFixed(3);
        if (unit === 'pct') return v.toFixed(1) + '%';
        return v.toFixed(2);
    };
    const setText = (id, v) => { const el=document.getElementById(id); if(el) el.textContent=v; };
    const setStyle = (id, prop, val) => { const el=document.getElementById(id); if(el) el.style[prop]=val; };

    // KPI cards
    setText('ev_bcws', fmt(ev.BCWS, 'cr'));
    setText('ev_bcwp', fmt(ev.BCWP, 'cr'));
    setText('ev_acwp', ev.ACWP ? fmt(ev.ACWP, 'cr') : 'Enter below');
    setText('ev_bac',  fmt(ev.BAC, 'cr'));

    // SPI
    const spiEl = document.getElementById('ev_spi');
    const spiBar = document.getElementById('ev_spi_bar');
    const spiLabel = document.getElementById('ev_spi_label');
    if (ev.SPI != null) {
        const spiColor = ev.SPI >= 1 ? '#16a34a' : ev.SPI >= 0.85 ? '#f59e0b' : '#dc2626';
        if (spiEl) { spiEl.textContent = fmt(ev.SPI, 'idx'); spiEl.style.color = spiColor; }
        if (spiLabel) { spiLabel.textContent = ev.SPI >= 1 ? '‚úÖ Ahead/On Schedule' : ev.SPI >= 0.85 ? 'üü° Minor Delay' : 'üî¥ Significantly Behind'; spiLabel.style.color = spiColor; }
        if (spiBar)  { spiBar.style.width = Math.min(100, ev.SPI * 100) + '%'; spiBar.style.background = spiColor; }
    } else {
        if (spiEl) spiEl.textContent = '‚Äî';
        if (spiLabel) spiLabel.textContent = 'BCWS required';
    }

    // CPI
    const cpiEl = document.getElementById('ev_cpi');
    const cpiBar = document.getElementById('ev_cpi_bar');
    const cpiLabel = document.getElementById('ev_cpi_label');
    if (ev.CPI != null) {
        const cpiColor = ev.CPI >= 1 ? '#16a34a' : ev.CPI >= 0.9 ? '#f59e0b' : '#dc2626';
        if (cpiEl) { cpiEl.textContent = fmt(ev.CPI, 'idx'); cpiEl.style.color = cpiColor; }
        if (cpiLabel) { cpiLabel.textContent = ev.CPI >= 1 ? '‚úÖ Under Budget' : ev.CPI >= 0.9 ? 'üü° Minor Overrun' : 'üî¥ Cost Overrun'; cpiLabel.style.color = cpiColor; }
        if (cpiBar)  { cpiBar.style.width = Math.min(100, ev.CPI * 100) + '%'; cpiBar.style.background = cpiColor; }
    } else {
        if (cpiEl) cpiEl.textContent = '‚Äî';
        if (cpiLabel) cpiLabel.textContent = 'Enter ACWP below';
    }

    // SV / CV
    const svEl = document.getElementById('ev_sv');
    const svLabel = document.getElementById('ev_sv_label');
    if (svEl) {
        const svVal = ev.SV / 10000000;
        const svColor = ev.SV >= 0 ? '#16a34a' : '#dc2626';
        svEl.textContent = (ev.SV >= 0 ? '+' : '') + fmt(ev.SV, 'cr');
        svEl.style.color = svColor;
        if (svLabel) { svLabel.textContent = ev.SV >= 0 ? 'Ahead of plan' : 'Behind plan'; svLabel.style.color = svColor; }
    }
    const cvEl = document.getElementById('ev_cv');
    const cvLabel = document.getElementById('ev_cv_label');
    if (cvEl && ev.CV != null) {
        const cvColor = ev.CV >= 0 ? '#16a34a' : '#dc2626';
        cvEl.textContent = (ev.CV >= 0 ? '+' : '') + fmt(ev.CV, 'cr');
        cvEl.style.color = cvColor;
        if (cvLabel) { cvLabel.textContent = ev.CV >= 0 ? 'Under budget' : 'Over budget'; cvLabel.style.color = cvColor; }
    } else if (cvEl) { cvEl.textContent = '‚Äî'; }

    // Forecasts
    setText('ev_eac',  fmt(ev.EAC, 'cr'));
    setText('ev_etc',  fmt(ev.ETC, 'cr'));
    setText('ev_tcpi', ev.TCPI != null ? fmt(ev.TCPI, 'idx') : '‚Äî');
    setText('ev_vac',  fmt(ev.VAC, 'cr'));

    // S-curve
    drawEVSCurve(ev);

    // Activity table
    renderEVActivityTable(ev);
}

// ‚îÄ‚îÄ S-CURVE CANVAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawEVSCurve(ev) {
    const canvas = document.getElementById('evSCurveCanvas');
    if (!canvas) return;
    const container = canvas.parentElement;
    const W = container.offsetWidth || 800;
    const H = 280;
    canvas.width = W;
    canvas.height = H;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, W, H);

    const padL = 60, padR = 30, padT = 20, padB = 50;
    const plotW = W - padL - padR;
    const plotH = H - padT - padB;

    const months = ev.months;
    if (!months.length) return;
    const maxVal = Math.max(...months.map(m => m.bcws));
    if (!maxVal) return;

    const xStep = plotW / (months.length - 1 || 1);
    const scaleY = v => padT + plotH - (v / maxVal) * plotH;
    const scaleX = i => padL + i * xStep;

    // Grid lines
    ctx.strokeStyle = '#f1f5f9';
    ctx.lineWidth = 1;
    for (let g = 0; g <= 4; g++) {
        const y = padT + (g / 4) * plotH;
        ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(padL + plotW, y); ctx.stroke();
        const label = ((1 - g/4) * maxVal / 10000000).toFixed(0) + ' Cr';
        ctx.fillStyle = '#94a3b8';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'right';
        ctx.fillText(label, padL - 6, y + 4);
    }

    // Draw BCWS (planned ‚Äî blue solid)
    ctx.beginPath();
    ctx.strokeStyle = '#3b82f6';
    ctx.lineWidth = 2.5;
    months.forEach((m, i) => {
        if (i === 0) ctx.moveTo(scaleX(i), scaleY(m.bcws));
        else ctx.lineTo(scaleX(i), scaleY(m.bcws));
    });
    ctx.stroke();

    // Draw BCWP (earned ‚Äî green solid) for past months only
    const pastMonths = months.filter(m => m.bcwp != null);
    if (pastMonths.length >= 2) {
        ctx.beginPath();
        ctx.strokeStyle = '#16a34a';
        ctx.lineWidth = 2.5;
        pastMonths.forEach((m, i) => {
            const xi = months.indexOf(m);
            if (i === 0) ctx.moveTo(scaleX(xi), scaleY(m.bcwp));
            else ctx.lineTo(scaleX(xi), scaleY(m.bcwp));
        });
        ctx.stroke();
    }

    // Today vertical line
    const today = new Date();
    const startDate = new Date(ev.startDate);
    const totalMs = ev.months.length * 30 * 86400000;
    const elapsed = Math.min(1, (today - startDate) / totalMs);
    const todayX = padL + elapsed * plotW;
    ctx.setLineDash([5, 4]);
    ctx.strokeStyle = '#dc2626';
    ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.moveTo(todayX, padT); ctx.lineTo(todayX, padT + plotH); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#dc2626';
    ctx.font = 'bold 10px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Today', todayX, padT - 6);

    // X-axis labels (every 3 months)
    ctx.fillStyle = '#64748b';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'center';
    months.forEach((m, i) => {
        if (i % 3 === 0 || i === months.length - 1) {
            ctx.fillText(m.label, scaleX(i), padT + plotH + 18);
        }
    });

    // Axis labels
    ctx.save();
    ctx.translate(14, padT + plotH / 2);
    ctx.rotate(-Math.PI / 2);
    ctx.fillStyle = '#374151';
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Cumulative Value (‚Çπ)', 0, 0);
    ctx.restore();
}

// ‚îÄ‚îÄ ACTIVITY-LEVEL EV TABLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderEVActivityTable(ev) {
    const tbody = document.getElementById('evActivityTable');
    if (!tbody) return;

    const snapshot = ev.snapshot || [];
    const BAC = ev.BAC;
    const totalWeight = snapshot.reduce((s,st) => s + (st.activities||[]).reduce((a,ac) => a + (ac.workingDays||1), 0), 0);
    const today = new Date();

    const rows = snapshot.flatMap(stretch =>
        (stretch.activities || []).map(act => {
            const w = act.workingDays || 1;
            const budgetShare = BAC * (w / totalWeight);
            // Planned % by today
            const actStart = new Date(act.startDate);
            const actEnd   = new Date(act.endDate);
            let plannedPct = 0;
            if (today >= actEnd) plannedPct = 100;
            else if (today > actStart) {
                const dur = Math.max(1, (actEnd - actStart) / 86400000);
                plannedPct = Math.min(100, (today - actStart) / 86400000/ dur * 100);
            }
            const actualPct = act.actualPct || 0;
            const bcws = budgetShare * (plannedPct / 100);
            const bcwp = budgetShare * (actualPct / 100);
            const actSPI = bcws > 0 ? bcwp / bcws : null;
            const spiColor = actSPI == null ? '#64748b' : actSPI >= 1 ? '#16a34a' : actSPI >= 0.85 ? '#f59e0b' : '#dc2626';
            const statusIcon = actualPct >= 100 ? '‚úÖ' : today > actEnd && actualPct < 100 ? 'üî¥' : today > actStart ? 'üü°' : '‚¨ú';

            return `<tr style="border-bottom:1px solid #f1f5f9;">
                <td style="padding:6px 10px;font-size:0.76rem;color:#64748b;">${stretch.stretchLabel||stretch.stretchId||'‚Äî'}</td>
                <td style="padding:6px 10px;font-size:0.78rem;font-weight:500;">${act.name}</td>
                <td style="padding:6px 10px;text-align:center;font-size:0.78rem;">${plannedPct.toFixed(0)}%</td>
                <td style="padding:6px 10px;text-align:center;font-size:0.78rem;font-weight:600;">${actualPct.toFixed(0)}%</td>
                <td style="padding:6px 10px;text-align:center;font-size:0.76rem;">‚Çπ${(bcws/10000000).toFixed(2)}Cr</td>
                <td style="padding:6px 10px;text-align:center;font-size:0.76rem;font-weight:600;">‚Çπ${(bcwp/10000000).toFixed(2)}Cr</td>
                <td style="padding:6px 10px;text-align:center;font-size:0.78rem;font-weight:700;color:${spiColor};">${actSPI != null ? actSPI.toFixed(2) : '‚Äî'}</td>
                <td style="padding:6px 10px;text-align:center;font-size:1rem;">${statusIcon}</td>
            </tr>`;
        })
    ).join('');

    tbody.innerHTML = rows || '<tr><td colspan="8" style="padding:16px;text-align:center;color:#94a3b8;">No baseline activities ‚Äî freeze a baseline first</td></tr>';
}

// ‚îÄ‚îÄ ACWP UPDATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateACWP(value) {
    if (!KALYANTRA.data.project) KALYANTRA.data.project = {};
    KALYANTRA.data.project.actualCost = parseFloat(value) || 0;
}

// ‚îÄ‚îÄ EV REPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportEVReport() {
    const ev = computeEarnedValue();
    if (!ev) { showToast('‚ö†Ô∏è No baseline ‚Äî cannot generate EV report', 'warning'); return; }
    const proj = KALYANTRA.data.project || {};
    const today = new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
    const fmt = v => v != null && !isNaN(v) ? (v/10000000).toFixed(2) : '‚Äî';
    const fmtIdx = v => v != null ? v.toFixed(3) : '‚Äî';
    const pw = window.open('','_blank','width=850,height=600');
    pw.document.write(`<!DOCTYPE html><html><head><title>EV Report</title>
    <style>body{font-family:Arial,sans-serif;font-size:0.875rem;padding:24px;}
    h1{color:#1B3B6F;font-size:1.3rem;} h2{color:#1B3B6F;font-size:1rem;border-bottom:2px solid #1B3B6F;padding-bottom:6px;margin:20px 0 10px;}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px;}
    .card{background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:12px;text-align:center;}
    .label{font-size:0.68rem;font-weight:700;text-transform:uppercase;color:#64748b;}
    .val{font-size:1.1rem;font-weight:700;color:#1B3B6F;margin-top:4px;}
    .btn{background:#1B3B6F;color:white;border:none;padding:8px 20px;border-radius:4px;cursor:pointer;margin-bottom:16px;}
    table{width:100%;border-collapse:collapse;} th{background:#1B3B6F;color:white;padding:7px 10px;}
    td{padding:6px 8px;border-bottom:1px solid #e2e8f0;}</style></head>
    <body><button class="btn" onclick="window.print()">üñ®Ô∏è Print</button>
    <h1>${proj.name||'Project'} ‚Äî Earned Value Report</h1>
    <p style="color:#64748b;font-size:0.8rem;">Cutoff: ${ev.cutoffDate} | Baseline frozen: ${KALYANTRA.data.baseline?.frozenAt||'‚Äî'} | Generated: ${today}</p>
    <h2>EV Metrics</h2>
    <div class="grid">
        <div class="card"><div class="label">BCWS (Planned Value)</div><div class="val">‚Çπ${fmt(ev.BCWS)} Cr</div></div>
        <div class="card"><div class="label">BCWP (Earned Value)</div><div class="val">‚Çπ${fmt(ev.BCWP)} Cr</div></div>
        <div class="card"><div class="label">ACWP (Actual Cost)</div><div class="val">${ev.ACWP ? '‚Çπ'+fmt(ev.ACWP)+' Cr' : 'Not entered'}</div></div>
        <div class="card"><div class="label">BAC</div><div class="val">‚Çπ${fmt(ev.BAC)} Cr</div></div>
    </div>
    <div class="grid">
        <div class="card"><div class="label">SPI</div><div class="val" style="color:${ev.SPI>=1?'#16a34a':ev.SPI>=0.85?'#f59e0b':'#dc2626'}">${fmtIdx(ev.SPI)}</div></div>
        <div class="card"><div class="label">CPI</div><div class="val" style="color:${ev.CPI>=1?'#16a34a':ev.CPI>=0.9?'#f59e0b':'#dc2626'}">${fmtIdx(ev.CPI)}</div></div>
        <div class="card"><div class="label">SV</div><div class="val">‚Çπ${fmt(ev.SV)} Cr</div></div>
        <div class="card"><div class="label">CV</div><div class="val">${ev.CV!=null?'‚Çπ'+fmt(ev.CV)+' Cr':'‚Äî'}</div></div>
    </div>
    <div class="grid">
        <div class="card"><div class="label">EAC</div><div class="val">‚Çπ${fmt(ev.EAC)} Cr</div></div>
        <div class="card"><div class="label">ETC</div><div class="val">‚Çπ${fmt(ev.ETC)} Cr</div></div>
        <div class="card"><div class="label">TCPI</div><div class="val">${fmtIdx(ev.TCPI)}</div></div>
        <div class="card"><div class="label">VAC</div><div class="val">‚Çπ${fmt(ev.VAC)} Cr</div></div>
    </div>
    </body></html>`);
    pw.document.close();
}

// ‚îÄ‚îÄ AUTO-INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function wireEVTab() {
    const _origSwitch = window.switchMainTab;
    if (typeof _origSwitch !== 'function') { setTimeout(wireEVTab, 300); return; }
    window.switchMainTab = function(idx) {
        _origSwitch(idx);
        if (idx === 15) setTimeout(renderEarnedValueTab, 50);
    };
})();

// Also render EV after baseline freeze
(function patchFreezeForEV() {
    const _orig = window.freezeBaseline;
    if (typeof _orig !== 'function') { setTimeout(patchFreezeForEV, 300); return; }
    window.freezeBaseline = function() {
        _orig();
        setTimeout(renderEarnedValueTab, 700);
    };
})();

console.log('‚úÖ KALYANTRA V9 ‚Äî Earned Value Module loaded');

</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KALYANTRA V9 ‚Äî NEXT PHASES
// 1. Gantt actual-progress overlay (green fill over planned bar)
// 2. LSM actual-progress diagonal overlay
// 3. Progress tab S-curve from real baseline (not logistic proxy)
// 4. EV tab wired into refresh()
// 5. renderSCurve upgrade using baseline schedule
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ 1. GANTT PROGRESS OVERLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Patch renderGantt to inject actual-progress green fill inside every bar
(function patchGanttProgress() {
    const _orig = window.renderGantt;
    if (typeof _orig !== 'function') { setTimeout(patchGanttProgress, 400); return; }
    window.renderGantt = function() {
        _orig.apply(this, arguments);
        // After render, overlay actual progress bars on top of planned bars
        setTimeout(() => {
            const timeline = document.getElementById('ganttTimeline');
            if (!timeline) return;
            const wbs = KALYANTRA.computed.wbs || [];

            // Build a quick lookup: activityId ‚Üí actualPct
            const pctMap = {};
            wbs.forEach(stretch => {
                (stretch.activities || []).forEach(act => {
                    if (act.actualPct > 0) pctMap[act.id] = act.actualPct;
                });
            });

            // Find all activity bar divs by their title attr and inject progress overlay
            const bars = timeline.querySelectorAll('[title]');
            bars.forEach(bar => {
                const titleText = bar.getAttribute('title') || '';
                // Match format: "ActivityName | Xd | resource"
                const parts = titleText.split(' | ');
                if (parts.length < 2) return;
                const actName = parts[0];
                // Find matching activity
                let matchAct = null;
                wbs.forEach(stretch => {
                    (stretch.activities || []).forEach(act => {
                        if (act.name === actName && act.actualPct > 0) matchAct = act;
                    });
                });
                if (!matchAct) return;
                // Don't double-inject
                if (bar.querySelector('.gantt-actual-overlay')) return;

                const pct = Math.min(100, matchAct.actualPct || 0);
                const overlay = document.createElement('div');
                overlay.className = 'gantt-actual-overlay';
                overlay.style.cssText = `
                    position:absolute; top:0; left:0;
                    width:${pct}%; height:100%;
                    background:rgba(22,163,74,0.55);
                    border-radius:3px 0 0 3px;
                    pointer-events:none;
                `;
                bar.style.position = 'relative';
                bar.insertBefore(overlay, bar.firstChild);

                // Add % label if bar is wide enough
                if (pct > 15) {
                    const label = document.createElement('span');
                    label.style.cssText = 'position:absolute;left:3px;top:50%;transform:translateY(-50%);font-size:9px;font-weight:700;color:white;pointer-events:none;z-index:2;';
                    label.textContent = Math.round(pct) + '%';
                    overlay.appendChild(label);
                }
            });
        }, 80);
    };
    console.log('‚úÖ Gantt progress overlay patched');
})();

// ‚îÄ‚îÄ 2. LSM ACTUAL PROGRESS OVERLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Patch renderLSM to draw actual-progress chainage on top of planned bands
(function patchLSMProgress() {
    const _orig = window.renderLSM;
    if (typeof _orig !== 'function') { setTimeout(patchLSMProgress, 400); return; }
    window.renderLSM = function() {
        _orig.apply(this, arguments);
        setTimeout(() => drawLSMActualProgress(), 120);
    };
    console.log('‚úÖ LSM progress overlay patched');
})();

function drawLSMActualProgress() {
    const mainCanvas = document.getElementById('lsmMainCanvas');
    if (!mainCanvas) return;
    const wbs = KALYANTRA.computed.wbs || [];
    const ctx = mainCanvas.getContext('2d');
    if (!ctx) return;

    // Get canvas dimensions from existing rendering
    const H = mainCanvas.height;
    const W = mainCanvas.width;
    if (!H || !W) return;

    const bl = KALYANTRA.data.baseline;
    if (!bl) return;

    const startDate = new Date(bl.startDate || KALYANTRA.data.project?.startDate || Date.now());
    const endDate   = new Date(bl.completionDate || KALYANTRA.data.project?.endDate || Date.now());
    const totalDays = Math.max(1, (endDate - startDate) / 86400000);

    // Get chainage extents from project
    const proj = KALYANTRA.data.project || {};
    const chStart = parseFloat(proj.startChainage) || 0;
    const chEnd   = parseFloat(proj.endChainage) || 5000;
    const chRange = chEnd - chStart;

    const padL = 60, padR = 20, padT = 30, padB = 40;
    const plotW = W - padL - padR;
    const plotH = H - padT - padB;

    const toX = (day) => padL + (day / totalDays) * plotW;
    const toY = (ch)  => padT + plotH - ((ch - chStart) / chRange) * plotH;

    // For each activity that has actual progress recorded, draw a green dot/segment
    const today = new Date();
    const todayDay = (today - startDate) / 86400000;

    ctx.save();
    ctx.globalAlpha = 0.85;

    const snapshot = bl.wbsSnapshot || [];
    snapshot.forEach(stretch => {
        (stretch.activities || []).forEach(act => {
            if (!act.actualPct || act.actualPct <= 0) return;

            // Find corresponding computed activity for chainage
            let computedAct = null;
            wbs.forEach(ws => {
                (ws.activities || []).forEach(wa => {
                    if (wa.name === act.name && wa.stretchId === stretch.stretchId) computedAct = wa;
                });
            });

            const actStartDay = (new Date(act.startDate) - startDate) / 86400000;
            const actDuration = act.workingDays || 1;
            const progressDay = actStartDay + (act.actualPct / 100) * actDuration;

            // Find chainage for this stretch
            const boq = KALYANTRA.data.boq || {};
            const tcsList = boq.tcsList || [];
            let fromCh = chStart, toCh = chEnd;
            tcsList.forEach(tcs => {
                (tcs.locations || []).forEach(loc => {
                    if (stretch.stretchId && stretch.stretchId.includes(tcs.id)) {
                        fromCh = loc.fromCh || chStart;
                        toCh   = loc.toCh   || chEnd;
                    }
                });
            });

            // Draw actual progress point ‚Äî a green diamond on the LSM diagonal
            const progressCh = fromCh + (act.actualPct / 100) * (toCh - fromCh);
            const px = toX(progressDay);
            const py = toY(progressCh);

            // Green diamond marker
            ctx.fillStyle = '#16a34a';
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.moveTo(px, py - 6);
            ctx.lineTo(px + 5, py);
            ctx.lineTo(px, py + 6);
            ctx.lineTo(px - 5, py);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        });
    });

    // Today's position line
    if (todayDay >= 0 && todayDay <= totalDays) {
        const todayX = toX(todayDay);
        ctx.globalAlpha = 0.7;
        ctx.setLineDash([6, 4]);
        ctx.strokeStyle = '#dc2626';
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.moveTo(todayX, padT);
        ctx.lineTo(todayX, padT + plotH);
        ctx.stroke();
        ctx.setLineDash([]);
    }

    ctx.restore();
}

// ‚îÄ‚îÄ 3. PROGRESS TAB S-CURVE ‚Äî USE REAL BASELINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Replace the logistic-proxy planned curve with real baseline schedule
(function upgradeProgressSCurve() {
    const _origSCurve = window.renderSCurve;
    if (typeof _origSCurve !== 'function') { setTimeout(upgradeProgressSCurve, 400); return; }

    window.renderSCurve = function(actualPct, totalDays, elapsedDays, proj) {
        // If we have a baseline, use it for the planned curve
        const bl = KALYANTRA.data.baseline;
        if (!bl || !bl.wbsSnapshot) {
            _origSCurve.apply(this, arguments);
            return;
        }

        const container = document.getElementById('prog9ScurveContainer');
        if (!container) return;

        const W = container.offsetWidth || 800;
        const H = 280;
        const padL = 50, padR = 20, padT = 20, padB = 40;
        const plotW = W - padL - padR;
        const plotH = H - padT - padB;

        const startDate = new Date(bl.startDate || proj?.startDate || new Date());
        const endDate   = new Date(bl.completionDate || proj?.endDate || new Date());
        const totalMs   = Math.max(1, endDate - startDate);

        // Build planned S-curve from baseline snapshot
        const snapshot = bl.wbsSnapshot || [];
        const totalWeight = snapshot.reduce((s,st) => s + (st.activities||[]).reduce((a,ac)=>a+(ac.workingDays||1),0), 0);

        // Sample points across the project duration
        const SAMPLES = 40;
        const planPoints = [];
        for (let k = 0; k <= SAMPLES; k++) {
            const t = k / SAMPLES;
            const checkDate = new Date(startDate.getTime() + t * totalMs);
            let weightDone = 0;
            snapshot.forEach(stretch => {
                (stretch.activities || []).forEach(act => {
                    const w = act.workingDays || 1;
                    const aStart = new Date(act.startDate);
                    const aEnd   = new Date(act.endDate);
                    if (checkDate >= aEnd) weightDone += w;
                    else if (checkDate > aStart) {
                        const dur = Math.max(1, aEnd - aStart);
                        weightDone += w * ((checkDate - aStart) / dur);
                    }
                });
            });
            const pct = totalWeight > 0 ? (weightDone / totalWeight) * 100 : t * 100;
            planPoints.push({ t, pct });
        }

        // Actual: linear from 0 to actualPct over elapsedDays
        const actualT = totalDays > 0 ? elapsedDays / totalDays : 0;
        const actualPoints = [
            { t: 0, pct: 0 },
            { t: actualT, pct: actualPct }
        ];

        // Render as SVG
        const toSvgX = t => padL + t * plotW;
        const toSvgY = p => padT + plotH - (p / 100) * plotH;

        const planPath = planPoints.map((p, i) =>
            (i === 0 ? 'M' : 'L') + toSvgX(p.t).toFixed(1) + ',' + toSvgY(p.pct).toFixed(1)
        ).join(' ');

        const actualPath = actualPoints.map((p, i) =>
            (i === 0 ? 'M' : 'L') + toSvgX(p.t).toFixed(1) + ',' + toSvgY(p.pct).toFixed(1)
        ).join(' ');

        // Grid & labels
        const gridLines = [0,25,50,75,100].map(pct =>
            `<line x1="${padL}" y1="${toSvgY(pct).toFixed(1)}" x2="${padL+plotW}" y2="${toSvgY(pct).toFixed(1)}" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="4,4"/>
             <text x="${padL-6}" y="${(toSvgY(pct)+4).toFixed(1)}" text-anchor="end" font-size="11" fill="#94a3b8">${pct}%</text>`
        ).join('');

        // Today marker
        const todayT = Math.min(1, actualT);
        const todayX = toSvgX(todayT).toFixed(1);

        // X labels ‚Äî every 20% of project duration
        const xLabels = [0,0.2,0.4,0.6,0.8,1].map(t => {
            const d = new Date(startDate.getTime() + t * totalMs);
            const label = d.toLocaleDateString('en-IN',{month:'short',year:'2-digit'});
            return `<text x="${toSvgX(t).toFixed(1)}" y="${padT+plotH+22}" text-anchor="middle" font-size="10" fill="#64748b">${label}</text>`;
        }).join('');

        container.innerHTML = `<svg width="${W}" height="${H}" xmlns="http://www.w3.org/2000/svg">
            ${gridLines}
            <!-- Planned S-curve (blue) from baseline -->
            <path d="${planPath}" fill="none" stroke="#3b82f6" stroke-width="2.5" stroke-linejoin="round"/>
            <!-- Actual progress (green) -->
            <path d="${actualPath}" fill="none" stroke="#16a34a" stroke-width="2.5" stroke-dasharray="6,3"/>
            <!-- Today marker -->
            <line x1="${todayX}" y1="${padT}" x2="${todayX}" y2="${padT+plotH}" stroke="#dc2626" stroke-width="1.5" stroke-dasharray="5,4"/>
            <text x="${todayX}" y="${padT-4}" text-anchor="middle" font-size="10" fill="#dc2626" font-weight="bold">Today</text>
            <!-- Actual dot at current -->
            <circle cx="${toSvgX(actualT).toFixed(1)}" cy="${toSvgY(actualPct).toFixed(1)}" r="5" fill="#16a34a" stroke="white" stroke-width="1.5"/>
            <!-- Legend -->
            <line x1="${padL}" y1="12" x2="${padL+24}" y2="12" stroke="#3b82f6" stroke-width="2.5"/>
            <text x="${padL+28}" y="16" font-size="10" fill="#3b82f6">Planned (Baseline)</text>
            <line x1="${padL+140}" y1="12" x2="${padL+164}" y2="12" stroke="#16a34a" stroke-width="2.5" stroke-dasharray="6,3"/>
            <text x="${padL+168}" y="16" font-size="10" fill="#16a34a">Actual</text>
            ${xLabels}
        </svg>`;
    };
    console.log('‚úÖ S-curve upgraded to use real baseline schedule');
})();

// ‚îÄ‚îÄ 4. WIRE EV INTO refresh() ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function wireEVToRefresh() {
    const _origRefresh = KALYANTRA.refresh;
    if (typeof _origRefresh !== 'function') { setTimeout(wireEVToRefresh, 400); return; }
    KALYANTRA.refresh = function() {
        _origRefresh.apply(this, arguments);
        // Re-render EV if tab is visible
        const evTab = document.getElementById('tabEarnedValue');
        if (evTab && evTab.style.display !== 'none' && typeof renderEarnedValueTab === 'function') {
            setTimeout(renderEarnedValueTab, 200);
        }
    };
    console.log('‚úÖ EV tab wired to refresh()');
})();

// ‚îÄ‚îÄ 5. EV TAB RENDERS AFTER SUPABASE LOADS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// computeAllAlerts and renderEarnedValueTab both run after projects (_aIdx 0)
// Already patched in earlier session but add EV here too
(function wireEVOnTabSwitch() {
    // Already patched via wireEVTab() in ev_engine.js
    // This redundant patch is safe ‚Äî idx===15 triggers renderEarnedValueTab
    console.log('‚úÖ EV tab switch wiring confirmed');
})();

console.log('‚úÖ KALYANTRA V9 Next Phases ‚Äî Gantt overlay, LSM overlay, S-curve, EV refresh loaded');

</script>
</body>
</html>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAG-INPUT SYSTEM FOR EQUIPMENT REQUIRED (Naukri-style)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Predefined equipment suggestions
const EQ_SUGGESTIONS = [
    'Motor Grader', 'Vibratory Roller', 'Water Tanker', 'Tipper Truck',
    'Excavator', 'Backhoe Loader', 'Dozer', 'Compactor',
    'Sensor Paver', 'Tandem Roller', 'Pneumatic Roller', 'Chip Spreader',
    'Concrete Mixer', 'Transit Mixer', 'Crane', 'Piling Rig',
    'Concrete Pump', 'Batching Plant', 'Rebar Bender', 'Shuttering',
    'Dewatering Pump', 'Survey Equipment', 'Laser Level'
];

function initEquipmentTagInput(ti, li, currentValue) {
    const containerId = `eqTags_${ti}_${li}`;
    const container = document.getElementById(containerId);
    if (!container) return;

    // Parse current value
    const currentTags = (Array.isArray(currentValue)
        ? currentValue
        : (currentValue || '').split(','))
        .map(s => s.trim()).filter(Boolean);

    renderEquipmentTags(ti, li, currentTags);
}

function renderEquipmentTags(ti, li, tags) {
    const containerId = `eqTags_${ti}_${li}`;
    const container = document.getElementById(containerId);
    if (!container) return;

    // Get user's actual equipment from resources
    const resEq = (KALYANTRA.data.resources?.equipment || []).map(e => e.name);
    const allSuggestions = [...new Set([...resEq, ...EQ_SUGGESTIONS])];

    container.innerHTML = `
        <div class="eq-tag-wrapper" id="eqWrap_${ti}_${li}"
             style="display:flex;flex-wrap:wrap;gap:4px;align-items:center;
                    min-height:30px;padding:4px 6px;border:1px solid #e2e8f0;
                    border-radius:5px;background:#fff;cursor:text;position:relative;"
             onclick="document.getElementById('eqInput_${ti}_${li}').focus()">
            ${tags.map(t => `
                <span style="display:inline-flex;align-items:center;gap:3px;
                             background:#dbeafe;color:#1d4ed8;border-radius:4px;
                             padding:2px 7px;font-size:0.72rem;font-weight:600;white-space:nowrap;">
                    ${t}
                    <button onclick="eqRemoveTag(${ti},${li},'${t.replace(/'/g,"\\'")}');event.stopPropagation()"
                            style="background:none;border:none;cursor:pointer;color:#3b82f6;
                                   font-size:0.8rem;padding:0;line-height:1;margin-left:1px;">‚úï</button>
                </span>`).join('')}
            <input id="eqInput_${ti}_${li}" type="text"
                   placeholder="${tags.length ? '' : 'Add equipment‚Ä¶'}"
                   autocomplete="off"
                   oninput="eqShowDropdown(${ti},${li},this.value)"
                   onkeydown="eqKeyDown(event,${ti},${li})"
                   onblur="setTimeout(()=>eqHideDropdown(${ti},${li}),200)"
                   style="border:none;outline:none;font-size:0.72rem;min-width:80px;
                          flex:1;padding:2px 2px;background:transparent;"/>
        </div>
        <div id="eqDrop_${ti}_${li}"
             style="display:none;position:absolute;top:100%;left:0;right:0;z-index:9999;
                    background:#fff;border:1px solid #bfdbfe;border-top:none;
                    border-radius:0 0 5px 5px;max-height:160px;overflow-y:auto;
                    box-shadow:0 4px 12px rgba(0,0,0,0.12);">
        </div>`;

    // Store tag state
    container._tags = tags;
    container._suggestions = allSuggestions;
    container.style.position = 'relative';
}

function eqKeyDown(e, ti, li) {
    const input = document.getElementById(`eqInput_${ti}_${li}`);
    const container = document.getElementById(`eqTags_${ti}_${li}`);
    if (!container) return;
    let tags = container._tags || [];

    if ((e.key === 'Enter' || e.key === ',') && input.value.trim()) {
        e.preventDefault();
        const val = input.value.replace(/,$/, '').trim();
        if (val && !tags.includes(val)) tags = [...tags, val];
        eqSaveTags(ti, li, tags);
    } else if (e.key === 'Backspace' && !input.value && tags.length) {
        tags = tags.slice(0, -1);
        eqSaveTags(ti, li, tags);
    }
}

function eqShowDropdown(ti, li, query) {
    const container = document.getElementById(`eqTags_${ti}_${li}`);
    const drop = document.getElementById(`eqDrop_${ti}_${li}`);
    if (!drop || !container) return;
    const tags = container._tags || [];
    const suggs = container._suggestions || EQ_SUGGESTIONS;
    const q = query.toLowerCase();
    const matches = suggs.filter(s => !tags.includes(s) && s.toLowerCase().includes(q)).slice(0, 8);

    if (!matches.length || !query) { drop.style.display = 'none'; return; }
    drop.style.display = 'block';
    drop.innerHTML = matches.map(m =>
        `<div onclick="eqSelectSuggestion(${ti},${li},'${m.replace(/'/g,"\\'")}')"
              style="padding:7px 12px;font-size:0.78rem;cursor:pointer;color:#1B3B6F;
                     border-bottom:1px solid #f1f5f9;"
              onmouseover="this.style.background='#eff6ff'"
              onmouseout="this.style.background=''">${m}</div>`
    ).join('');
}

function eqHideDropdown(ti, li) {
    const d = document.getElementById(`eqDrop_${ti}_${li}`);
    if (d) d.style.display = 'none';
}

function eqSelectSuggestion(ti, li, val) {
    const container = document.getElementById(`eqTags_${ti}_${li}`);
    if (!container) return;
    let tags = container._tags || [];
    if (!tags.includes(val)) tags = [...tags, val];
    eqSaveTags(ti, li, tags);
    eqHideDropdown(ti, li);
}

function eqRemoveTag(ti, li, val) {
    const container = document.getElementById(`eqTags_${ti}_${li}`);
    if (!container) return;
    const tags = (container._tags || []).filter(t => t !== val);
    eqSaveTags(ti, li, tags);
}

function eqSaveTags(ti, li, tags) {
    // Save to data model
    const boq = KALYANTRA.data.boq || {};
    const tcsList = boq.tcsList || [];
    if (tcsList[ti] && tcsList[ti].pavementLayers && tcsList[ti].pavementLayers[li]) {
        tcsList[ti].pavementLayers[li].requiredEquipmentTypes = tags;
    }
    computeBottleneck(ti);
    renderEquipmentTags(ti, li, tags);
    // Refocus input
    setTimeout(() => {
        const inp = document.getElementById(`eqInput_${ti}_${li}`);
        if (inp) inp.focus();
    }, 50);
}
</script>
